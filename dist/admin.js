const{useState,useEffect,useRef,useMemo}=React,CLOUDINARY_CLOUD_NAME="diwxfpt92",CLOUDINARY_UPLOAD_PRESET="ktm_unsigned",API_BASE="";function LoginPage({onLogin:P,error:F}){const[B,Ne]=useState(""),[oe,J]=useState(""),[V,Ee]=useState(!1),[He,ke]=useState(!1);return React.createElement("div",{className:"login-page"},React.createElement("div",{className:"login-box"},React.createElement("div",{className:"text-center mb-4"},React.createElement("i",{className:"fas fa-tractor fa-3x text-warning mb-3"}),React.createElement("h4",{className:"text-dark"},"KTM Admin"),React.createElement("p",{className:"text-muted small"},"\u0110\u0103ng nh\u1EADp \u0111\u1EC3 qu\u1EA3n l\xFD")),F&&React.createElement("div",{className:"alert alert-danger py-2 small"},React.createElement("i",{className:"fas fa-exclamation-circle me-2"}),F),React.createElement("form",{onSubmit:async rt=>{rt.preventDefault(),Ee(!0),await P(B,oe),Ee(!1)}},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small"},"T\xEAn \u0111\u0103ng nh\u1EADp"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-user"})),React.createElement("input",{type:"text",className:"form-control",value:B,onChange:rt=>Ne(rt.target.value),placeholder:"admin",required:!0,autoFocus:!0}))),React.createElement("div",{className:"mb-4"},React.createElement("label",{className:"form-label small"},"M\u1EADt kh\u1EA9u"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-lock"})),React.createElement("input",{type:He?"text":"password",className:"form-control",value:oe,onChange:rt=>J(rt.target.value),placeholder:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",required:!0}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>ke(!He)},React.createElement("i",{className:`fas fa-eye${He?"-slash":""}`})))),React.createElement("button",{type:"submit",className:"btn btn-warning w-100",disabled:V},V?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang \u0111\u0103ng nh\u1EADp..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-sign-in-alt me-2"}),"\u0110\u0103ng nh\u1EADp"))),React.createElement("div",{className:"text-center mt-4"},React.createElement("a",{href:"/",className:"text-muted small text-decoration-none"},React.createElement("i",{className:"fas fa-arrow-left me-1"}),"V\u1EC1 trang ch\u1EE7"))))}function Toast({message:P,type:F,onClose:B,actionLabel:Ne,onAction:oe,durationMs:J}){return useEffect(()=>{const V=Number(J),Ee=Number.isFinite(V)&&V>0?V:3e3,He=setTimeout(B,Ee);return()=>clearTimeout(He)},[B,J]),React.createElement("div",{className:`toast show align-items-center text-white bg-${F} border-0`,role:"alert"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("div",{className:"toast-body"},P),Ne&&typeof oe=="function"&&React.createElement("button",{type:"button",className:"btn btn-sm btn-light toast-action",onClick:()=>{try{oe()}finally{B()}}},Ne),React.createElement("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto",onClick:B})))}function Loading({show:P}){return P?React.createElement("div",{className:"loading-overlay"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"3rem",height:"3rem"}},React.createElement("span",{className:"visually-hidden"},"\u0110ang t\u1EA3i..."))):null}function AdminDrawer({open:P,title:F,subtitle:B,onClose:Ne,footer:oe,children:J}){return useEffect(()=>{if(!P)return;const V=Ee=>{Ee.key==="Escape"&&(Ee.preventDefault(),typeof Ne=="function"&&Ne())};return document.addEventListener("keydown",V),()=>document.removeEventListener("keydown",V)},[P,Ne]),P?React.createElement("div",{className:`admin-drawer-root ${P?"open":""}`,role:"dialog","aria-modal":"true"},React.createElement("div",{className:"admin-drawer-backdrop",onClick:Ne,"aria-hidden":"true"}),React.createElement("aside",{className:"admin-drawer-panel"},React.createElement("div",{className:"admin-drawer-header"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"admin-drawer-title"},F),B?React.createElement("div",{className:"admin-drawer-subtitle"},B):null),React.createElement("button",{type:"button",className:"btn btn-sm btn-light",onClick:Ne,title:"\u0110\xF3ng","aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"admin-drawer-body"},J),oe?React.createElement("div",{className:"admin-drawer-footer"},oe):null)):null}const ADMIN_PINS_STORAGE_KEY="ktm_admin_pins_v1",ADMIN_RECENT_STORAGE_KEY="ktm_admin_recent_v1";function loadAdminMenuIdsFromStorage(P){try{const F=localStorage.getItem(P);if(!F)return[];const B=JSON.parse(F);return Array.isArray(B)?B.map(Ne=>String(Ne||"").trim()).filter(Boolean):[]}catch(F){return[]}}function saveAdminMenuIdsToStorage(P,F){try{localStorage.setItem(P,JSON.stringify(Array.isArray(F)?F:[]))}catch(B){}}function loadAdminPins(){return loadAdminMenuIdsFromStorage(ADMIN_PINS_STORAGE_KEY)}function saveAdminPins(P){return saveAdminMenuIdsToStorage(ADMIN_PINS_STORAGE_KEY,P),P}function loadAdminRecent(){return loadAdminMenuIdsFromStorage(ADMIN_RECENT_STORAGE_KEY)}function saveAdminRecent(P){return saveAdminMenuIdsToStorage(ADMIN_RECENT_STORAGE_KEY,P),P}function Sidebar({activeMenu:P,onMenuChange:F,onLogout:B,currentUser:Ne,pinnedMenus:oe,recentMenus:J,onTogglePin:V}){const Ee=[{id:"search",icon:"fa-search",label:"Tra c\u1EE9u nhanh",highlight:!0},{id:"albums",icon:"fa-images",label:"Qu\u1EA3n l\xFD Album"},{id:"videos",icon:"fa-video",label:"Qu\u1EA3n l\xFD Video"},{id:"products",icon:"fa-box",label:"S\u1EA3n ph\u1EA9m"},{id:"orders",icon:"fa-receipt",label:"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"},{id:"recon",icon:"fa-file-excel",label:"\u0110\u1ED1i so\xE1t Excel"},{id:"stats",icon:"fa-chart-column",label:"Th\u1ED1ng k\xEA"},{id:"settings",icon:"fa-cog",label:"C\xE0i \u0111\u1EB7t"}],He=(Ne==null?void 0:Ne.username)||(Ne==null?void 0:Ne.name)||(Ne==null?void 0:Ne.email)||"Admin",ke=useMemo(()=>{const Le=new Map;for(const X of Ee)Le.set(X.id,X);return Le},[]),Je=Array.isArray(oe)?oe:[],rt=Array.isArray(J)?J:[],Fe=Je.map(Le=>ke.get(Le)).filter(Boolean),Ve=rt.filter(Le=>Le!==P).map(Le=>ke.get(Le)).filter(Boolean).slice(0,2),ie=Le=>Je.includes(Le);return React.createElement("div",{className:"sidebar d-none d-md-block"},React.createElement("div",{className:"logo"},React.createElement("i",{className:"fas fa-tractor me-2"})," KTM Admin"),React.createElement("div",{className:"sidebar-user","aria-label":"T\xE0i kho\u1EA3n"},React.createElement("div",{className:"sidebar-user-avatar","aria-hidden":"true"},React.createElement("i",{className:"fas fa-user"})),React.createElement("div",{className:"sidebar-user-meta"},React.createElement("div",{className:"sidebar-user-name"},He),React.createElement("div",{className:"sidebar-user-sub"},"Qu\u1EA3n tr\u1ECB"))),React.createElement("nav",{className:"nav flex-column mt-3 sidebar-nav"},Fe.length>0&&React.createElement(React.Fragment,null,React.createElement("div",{className:"sidebar-section-title"},"Pinned"),React.createElement("div",{className:"sidebar-quicklist"},Fe.map(Le=>React.createElement("a",{key:`pin-${Le.id}`,href:"#",className:`nav-link ${P===Le.id?"active":""} sidebar-quicklink`,onClick:X=>{X.preventDefault(),F(Le.id)}},React.createElement("i",{className:`fas ${Le.icon}`})," ",Le.label,React.createElement("button",{type:"button",className:"sidebar-pin-btn pinned",onClick:X=>{X.preventDefault(),X.stopPropagation(),V&&V(Le.id)},title:"B\u1ECF ghim","aria-label":"B\u1ECF ghim"},React.createElement("i",{className:"fas fa-thumbtack"})))))),Ve.length>0&&React.createElement(React.Fragment,null,React.createElement("div",{className:"sidebar-section-title"},"Recent"),React.createElement("div",{className:"sidebar-quicklist"},Ve.map(Le=>React.createElement("a",{key:`recent-${Le.id}`,href:"#",className:`nav-link ${P===Le.id?"active":""} sidebar-quicklink`,onClick:X=>{X.preventDefault(),F(Le.id)}},React.createElement("i",{className:`fas ${Le.icon}`})," ",Le.label)))),React.createElement("div",{className:"sidebar-section-title"},"Menu"),React.createElement("div",{className:"sidebar-menu-scroll","aria-label":"Danh s\xE1ch menu"},Ee.map(Le=>React.createElement("a",{key:Le.id,href:"#",className:`nav-link ${P===Le.id?"active":""} ${Le.disabled?"opacity-50":""} ${Le.highlight?"text-warning":""}`,onClick:X=>{X.preventDefault(),Le.disabled||F(Le.id)}},React.createElement("i",{className:`fas ${Le.icon}`})," ",Le.label,Le.disabled&&React.createElement("span",{className:"badge bg-secondary ms-2"},"Soon"),Le.highlight&&React.createElement("span",{className:"badge bg-warning text-dark ms-2"},"HOT"),React.createElement("button",{type:"button",className:`sidebar-pin-btn ${ie(Le.id)?"pinned":""}`,onClick:X=>{X.preventDefault(),X.stopPropagation(),V&&V(Le.id)},title:ie(Le.id)?"B\u1ECF ghim":"Ghim","aria-label":ie(Le.id)?"B\u1ECF ghim":"Ghim"},React.createElement("i",{className:"fas fa-thumbtack"})))))),React.createElement("div",{className:"sidebar-footer w-100 p-3 border-top border-secondary"},React.createElement("div",{className:"d-flex justify-content-between align-items-center"},React.createElement("a",{href:"/",className:"text-white-50 text-decoration-none small"},React.createElement("i",{className:"fas fa-home me-1"})," Trang ch\u1EE7"),B&&React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:B,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"})))))}const ADMIN_SETTINGS_STORAGE_KEY="ktm_admin_settings_v1",DEFAULT_SHIP_PERCENT=1.64;function normalizeShipPercent(P){const F=typeof P=="number"?P:parseFloat(String(P!=null?P:"").trim());return Number.isFinite(F)?Math.max(0,Math.min(100,F)):DEFAULT_SHIP_PERCENT}function loadAdminSettings(){var P;try{const F=localStorage.getItem(ADMIN_SETTINGS_STORAGE_KEY);if(!F)return{ship_percent:DEFAULT_SHIP_PERCENT};const B=JSON.parse(F);return{ship_percent:normalizeShipPercent((P=B==null?void 0:B.ship_percent)!=null?P:B==null?void 0:B.shipPercent)}}catch(F){return{ship_percent:DEFAULT_SHIP_PERCENT}}}function saveAdminSettings(P){var F;try{const B={ship_percent:normalizeShipPercent((F=P==null?void 0:P.ship_percent)!=null?F:P==null?void 0:P.shipPercent)};return localStorage.setItem(ADMIN_SETTINGS_STORAGE_KEY,JSON.stringify(B)),B}catch(B){return{ship_percent:DEFAULT_SHIP_PERCENT}}}async function fetchAdminSettingsFromServer(){var F;const P=await window.KTM.api.getJSON(`${API_BASE}/api/settings`,"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t t\u1EEB DB");return{ship_percent:normalizeShipPercent((F=P==null?void 0:P.ship_percent)!=null?F:P==null?void 0:P.shipPercent)}}async function saveAdminSettingsToServer(P){var Ne,oe,J;const F={ship_percent:normalizeShipPercent((Ne=P==null?void 0:P.ship_percent)!=null?Ne:P==null?void 0:P.shipPercent)},B=await window.KTM.api.putJSON(`${API_BASE}/api/settings`,F,"Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t v\xE0o DB");return{ship_percent:normalizeShipPercent((J=(oe=B==null?void 0:B.ship_percent)!=null?oe:B==null?void 0:B.shipPercent)!=null?J:F.ship_percent)}}function AlbumList({albums:P,onSelect:F,onCreate:B,onEdit:Ne,onDelete:oe,loading:J,currentFolder:V,onBack:Ee,breadcrumb:He}){return React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},V&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:Ee},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),V?V.title:"Th\u01B0 vi\u1EC7n \u1EA3nh")),React.createElement("button",{className:"btn btn-warning",onClick:B},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder")),He&&He.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:ke=>{ke.preventDefault(),Ee("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),He.map((ke,Je)=>React.createElement("li",{key:ke.id,className:`breadcrumb-item ${Je===He.length-1?"active":""}`},Je===He.length-1?ke.title:React.createElement("a",{href:"#",onClick:rt=>{rt.preventDefault(),Ee(ke)},className:"text-warning"},ke.title))))),J?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):P.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},V?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder n\xE0o. H\xE3y t\u1EA1o folder \u0111\u1EA7u ti\xEAn!")):React.createElement("div",{className:"row g-3"},P.map(ke=>React.createElement("div",{key:ke.uuid||ke.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card album-card h-100",onClick:()=>F(ke)},ke.cover?React.createElement("img",{src:ke.cover,className:"album-cover",alt:ke.title}):React.createElement("div",{className:"card-body text-center py-4"},React.createElement("i",{className:"fas fa-folder fa-3x text-warning mb-2"})),React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"card-title mb-1"},ke.title),React.createElement("small",{className:"text-muted"},ke.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),ke.subfolderCount),ke.subfolderCount>0&&ke.count>0&&" \u2022 ",ke.count>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-image me-1"}),ke.count),ke.subfolderCount===0&&ke.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-2",onClick:Je=>{Je.stopPropagation(),Ne(ke)},title:"S\u1EEDa album"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:Je=>{Je.stopPropagation(),oe(ke)},title:"X\xF3a album"},React.createElement("i",{className:"fas fa-trash"}))))))))}function AlbumModal({show:P,album:F,onClose:B,onSave:Ne,parentId:oe}){const[J,V]=useState({slug:"",title:"",description:"",cover_url:"",parent_id:null}),[Ee,He]=useState(!1),[ke,Je]=useState(!1),rt=useRef(null);useEffect(()=>{V(F?{slug:F.id||"",title:F.title||"",description:F.description||"",cover_url:F.cover||"",parent_id:F.parentId||null}:{slug:"",title:"",description:"",cover_url:"",parent_id:oe||null})},[F,P,oe]);const Fe=async X=>{X.preventDefault(),He(!0),await Ne(J),He(!1)},Ve=X=>X.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),ie=async X=>{const bt=X.type==="image/heic"||X.type==="image/heif"||/\.heic$/i.test(X.name);if(X.size<=2097152&&!bt)return X;try{const _t=await createImageBitmap(X),Ge=document.createElement("canvas");let st=_t.width,Ke=_t.height;const vt=800;return(st>vt||Ke>vt)&&(st>Ke?(Ke=Math.round(Ke/st*vt),st=vt):(st=Math.round(st/Ke*vt),Ke=vt)),Ge.width=st,Ge.height=Ke,Ge.getContext("2d").drawImage(_t,0,0,st,Ke),_t.close(),new Promise((rn,tt)=>{Ge.toBlob(jt=>{jt?rn(new File([jt],X.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):tt(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(_t){throw console.error("Compress cover error:",_t),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},Le=async X=>{var _t;const pt=X.target.files[0];if(!pt)return;if(!(pt.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(pt.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}Je(!0);try{const Ge=await ie(pt),st=await window.KTM.cloudinary.uploadImage({file:Ge,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-albums/covers"});if(!st.secure_url)throw console.error("Cloudinary error:",st),new Error(((_t=st.error)==null?void 0:_t.message)||"Upload failed");V(Ke=>({...Ke,cover_url:st.secure_url}))}catch(Ge){console.error("Cover upload error:",Ge),alert("L\u1ED7i upload \u1EA3nh b\xECa: "+Ge.message)}Je(!1),X.target.value=""};return P?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},F?"S\u1EEDa":"T\u1EA1o"," Folder"),React.createElement("button",{type:"button",className:"btn-close",onClick:B})),React.createElement("form",{onSubmit:Fe},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:J.title,onChange:X=>V({...J,title:X.target.value,slug:J.slug||Ve(X.target.value)}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Slug (URL) *"),React.createElement("input",{type:"text",className:"form-control",value:J.slug,onChange:X=>V({...J,slug:X.target.value}),required:!0,disabled:!!F}),React.createElement("small",{className:"text-muted"},"VD: may-cay-kubota-l1501")),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:J.description,onChange:X=>V({...J,description:X.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex gap-2 align-items-start"},J.cover_url&&React.createElement("div",{className:"position-relative",style:{width:80,height:80}},React.createElement("img",{src:J.cover_url,alt:"Cover",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:8}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute",style:{top:-8,right:-8,padding:"2px 6px",fontSize:10},onClick:()=>V(X=>({...X,cover_url:""}))},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{ref:rt,type:"file",accept:"image/*",className:"d-none",onChange:Le}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100 mb-2",onClick:()=>{var X;return(X=rt.current)==null?void 0:X.click()},disabled:ke},ke?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh b\xECa")),React.createElement("input",{type:"url",className:"form-control form-control-sm",value:J.cover_url,onChange:X=>V({...J,cover_url:X.target.value}),placeholder:"Ho\u1EB7c d\xE1n URL \u1EA3nh..."}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:B},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:Ee||ke},Ee?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function FolderTreeItem({folder:P,allAlbums:F,currentAlbumId:B,targetAlbum:Ne,onSelect:oe,level:J=0}){const[V,Ee]=useState(!0),He=P.uuid||P.id,ke=He===B,Je=Ne===He,rt=F.filter(Ve=>Ve.parentId===He),Fe=rt.length>0;return React.createElement("div",{style:{marginLeft:J*16+"px"}},React.createElement("div",{className:`d-flex align-items-center p-2 rounded mb-1 ${Je?"bg-info text-white":ke?"bg-light text-muted":"hover-bg"}`,style:{cursor:ke?"not-allowed":"pointer",opacity:ke?.5:1,transition:"background 0.2s"},onClick:()=>!ke&&oe(He)},Fe&&React.createElement("i",{className:`fas fa-chevron-${V?"down":"right"} me-2`,style:{fontSize:"10px",width:"12px",cursor:"pointer"},onClick:Ve=>{Ve.stopPropagation(),Ee(!V)}}),!Fe&&React.createElement("span",{style:{width:"20px"}}),React.createElement("i",{className:`fas fa-folder${Je?"-open":""} me-2 ${Je?"":"text-warning"}`}),React.createElement("span",{className:"small"},P.title),ke&&React.createElement("span",{className:"ms-2 badge bg-secondary",style:{fontSize:"9px"}},"Hi\u1EC7n t\u1EA1i"),P.count>0&&!ke&&React.createElement("span",{className:"ms-auto badge bg-light text-muted",style:{fontSize:"10px"}},P.count)),V&&Fe&&React.createElement("div",null,rt.map(Ve=>React.createElement(FolderTreeItem,{key:Ve.uuid||Ve.id,folder:Ve,allAlbums:F,currentAlbumId:B,targetAlbum:Ne,onSelect:oe,level:J+1}))))}function AlbumDetail({album:P,onBack:F,onRefresh:B,showToast:Ne,onNavigateToFolder:oe,onEditSubfolder:J,parentAlbum:V}){const[Ee,He]=useState([]),[ke,Je]=useState([]),[rt,Fe]=useState(!0),[Ve,ie]=useState(!1),[Le,X]=useState(""),[pt,bt]=useState([]),[_t,Ge]=useState([]),[st,Ke]=useState({}),[vt,$t]=useState(null),[rn,tt]=useState(!1),[jt,Ht]=useState(""),[_,T]=useState(!1),z=useRef(null),ye=useRef(null),[we,ue]=useState(!1),[he,_e]=useState([]),[S,q]=useState([]),[Y,de]=useState(""),[xe,$e]=useState(!1),Qe=async(H,p=2)=>{const G=p*1024*1024,ae=H.type==="image/heic"||H.type==="image/heif"||/\.heic$/i.test(H.name);if(H.size<=G&&!ae)return H;try{const Pe=await createImageBitmap(H),je=document.createElement("canvas");let Ue=Pe.width,xt=Pe.height;const at=1200;return(Ue>at||xt>at)&&(Ue>xt?(xt=Math.round(xt/Ue*at),Ue=at):(Ue=Math.round(Ue/xt*at),xt=at)),je.width=Ue,je.height=xt,je.getContext("2d").drawImage(Pe,0,0,Ue,xt),Pe.close(),new Promise((Vt,on)=>{je.toBlob(Nn=>{Nn?Vt(new File([Nn],H.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):on(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(Pe){throw console.error("Compress error:",Pe),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh")}};useEffect(()=>{Ye(),St()},[P.id,P.uuid]);const Ye=async()=>{Fe(!0);try{const H=await window.KTM.api.getJSON(`${API_BASE}/api/albums/${P.uuid||P.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");He(H.images||[]);const p=await window.KTM.api.getJSON(`${API_BASE}/api/albums?parent_id=${P.uuid||P.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");Je(Array.isArray(p)?p:[])}catch(H){console.error(H),Ne("L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u","danger")}Fe(!1)},St=async()=>{try{const H=await window.KTM.api.getJSON(`${API_BASE}/api/albums`,"L\u1ED7i t\u1EA3i album");q(Array.isArray(H)?H:[])}catch(H){console.error("Error loading albums:",H)}},Et=H=>{_e(p=>p.includes(H)?p.filter(G=>G!==H):[...p,H])},Se=async()=>{if(!Y||he.length===0){Ne("Vui l\xF2ng ch\u1ECDn folder \u0111\xEDch","warning");return}$e(!0);let H=0;for(const p of he)try{await window.KTM.api.putJSON(`${API_BASE}/api/images/${p}`,{album_id:Y},"L\u1ED7i di chuy\u1EC3n \u1EA3nh"),H++}catch(G){console.error("Move error:",G)}$e(!1),ue(!1),_e([]),de(""),H>0?(Ne("\u0110\xE3 di chuy\u1EC3n \u1EA3nh th\xE0nh c\xF4ng!","success"),Ye(),B()):Ne("Di chuy\u1EC3n th\u1EA5t b\u1EA1i","danger")},[nt,Jt]=useState(!1),Mt=async()=>{if(he.length===0||!confirm(`X\xF3a ${he.length} \u1EA3nh \u0111\xE3 ch\u1ECDn? H\xE0nh \u0111\u1ED9ng n\xE0y kh\xF4ng th\u1EC3 ho\xE0n t\xE1c!`))return;Jt(!0);let H=0;for(const p of he)try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${p}`,"L\u1ED7i x\xF3a \u1EA3nh"),H++}catch(G){console.error("Delete error:",G)}Jt(!1),_e([]),H>0?(Ne(`\u0110\xE3 x\xF3a ${H} \u1EA3nh!`,"success"),Ye(),B()):Ne("X\xF3a th\u1EA5t b\u1EA1i","danger")},dn=()=>{he.length===Ee.length?_e([]):_e(Ee.map(H=>H.id))},Ft=async()=>{if(jt.trim()){T(!0);try{const H=jt.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");await window.KTM.api.postJSON(`${API_BASE}/api/albums`,{slug:H+"-"+Date.now(),title:jt,parent_id:P.uuid||P.id},"L\u1ED7i t\u1EA1o folder"),Ne("T\u1EA1o folder th\xE0nh c\xF4ng!","success"),Ht(""),tt(!1),Ye(),B()}catch(H){Ne(H.message,"danger")}T(!1)}},yn=async H=>{if(confirm(`X\xF3a folder "${H.title}"? T\u1EA5t c\u1EA3 n\u1ED9i dung b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${H.uuid||H.id}`,"L\u1ED7i x\xF3a folder"),Ne("\u0110\xE3 x\xF3a folder","success"),Ye(),B()}catch(p){Ne("L\u1ED7i x\xF3a folder","danger")}},vn=H=>{const p=Array.from(H).filter(G=>G.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(G.name));bt(G=>[...G,...p]),p.forEach(G=>{const ae=new FileReader;ae.onload=Pe=>{Ge(je=>[...je,{file:G,preview:Pe.target.result}])},ae.readAsDataURL(G)})},E=H=>{bt(p=>p.filter((G,ae)=>ae!==H)),Ge(p=>p.filter((G,ae)=>ae!==H))},ce=async H=>{var G;const p=await window.KTM.cloudinary.uploadImage({file:H,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:`ktm-albums/${P.id}`});if(!p.secure_url)throw console.error("Cloudinary error:",p),new Error(((G=p.error)==null?void 0:G.message)||"Upload failed");return p},Ze=async()=>{if(pt.length===0)return;ie(!0);let H=0;for(let p=0;p<pt.length;p++)try{X(`\u0110ang x\u1EED l\xFD ${p+1}/${pt.length}...`);const G=await Qe(pt[p],2);X(`\u0110ang upload ${p+1}/${pt.length}...`);const ae=await ce(G);await window.KTM.api.postJSON(`${API_BASE}/api/albums/${P.id}`,{url:ae.secure_url,caption:st[p]||pt[p].name.replace(/\.[^/.]+$/,""),sort_order:Ee.length+p},"L\u1ED7i l\u01B0u \u1EA3nh"),H++}catch(G){console.error("Upload error:",G)}ie(!1),X(""),bt([]),Ge([]),Ke({}),H>0?(Ne(`\u0110\xE3 upload ${H} \u1EA3nh th\xE0nh c\xF4ng!`,"success"),Ye(),B()):Ne("Upload th\u1EA5t b\u1EA1i","danger")},Kt=async(H,p)=>{if(confirm("X\xF3a \u1EA3nh n\xE0y?"))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${H}`,"L\u1ED7i x\xF3a \u1EA3nh"),Ne("\u0110\xE3 x\xF3a \u1EA3nh","success"),Ye(),B()}catch(G){Ne("L\u1ED7i x\xF3a \u1EA3nh","danger")}},mn=H=>{var p;H.preventDefault(),(p=ye.current)==null||p.classList.add("dragover")},Xt=()=>{var H;(H=ye.current)==null||H.classList.remove("dragover")},Ut=H=>{var p;H.preventDefault(),(p=ye.current)==null||p.classList.remove("dragover"),vn(H.dataTransfer.files)};return React.createElement("div",null,React.createElement("div",{className:"d-flex align-items-center justify-content-between mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:F},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("h4",{className:"m-0"},P.title),React.createElement("small",{className:"text-muted"},ke.length>0&&React.createElement("span",null,ke.length," folder \u2022 "),Ee.length," \u1EA3nh"))),React.createElement("button",{className:"btn btn-outline-warning btn-sm",onClick:()=>tt(!0)},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder con")),rn&&React.createElement("div",{className:"card mb-4 border-warning"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder-plus me-2 text-warning"}),"T\u1EA1o folder con"),React.createElement("div",{className:"d-flex gap-2"},React.createElement("input",{type:"text",className:"form-control",placeholder:"T\xEAn folder...",value:jt,onChange:H=>Ht(H.target.value),onKeyPress:H=>H.key==="Enter"&&Ft(),autoFocus:!0}),React.createElement("button",{className:"btn btn-warning",onClick:Ft,disabled:_||!jt.trim()},_?React.createElement("span",{className:"spinner-border spinner-border-sm"}):"T\u1EA1o"),React.createElement("button",{className:"btn btn-secondary",onClick:()=>{tt(!1),Ht("")}},"H\u1EE7y")))),ke.length>0&&React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),"Folder con"),React.createElement("div",{className:"row g-2"},ke.map(H=>React.createElement("div",{key:H.uuid||H.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-item",style:{cursor:"pointer"},onClick:()=>oe&&oe(H)},React.createElement("div",{className:"card-body text-center py-3"},React.createElement("i",{className:"fas fa-folder fa-2x text-warning mb-2"}),React.createElement("div",{className:"small fw-bold text-truncate"},H.title),React.createElement("small",{className:"text-muted"},H.subfolderCount>0&&React.createElement("span",null,H.subfolderCount," folder"),H.subfolderCount>0&&H.count>0&&" \u2022 ",H.count>0&&React.createElement("span",null,H.count," \u1EA3nh"),H.subfolderCount===0&&H.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0 text-center"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-1",onClick:p=>{p.stopPropagation(),J&&J(H)},title:"S\u1EEDa folder"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:p=>{p.stopPropagation(),yn(H)},title:"X\xF3a folder"},React.createElement("i",{className:"fas fa-trash"}))))))))),React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-cloud-upload-alt me-2"}),"Upload \u1EA3nh m\u1EDBi"),React.createElement("div",{ref:ye,className:"upload-zone",onClick:()=>{var H;return(H=z.current)==null?void 0:H.click()},onDragOver:mn,onDragLeave:Xt,onDrop:Ut},React.createElement("i",{className:"fas fa-images fa-2x text-muted mb-2"}),React.createElement("p",{className:"mb-0"},"K\xE9o th\u1EA3 \u1EA3nh v\xE0o \u0111\xE2y ho\u1EB7c click \u0111\u1EC3 ch\u1ECDn"),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3 JPG, PNG, WebP"),React.createElement("input",{ref:z,type:"file",multiple:!0,accept:"image/*",onChange:H=>vn(H.target.files)})),_t.length>0&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"upload-preview"},_t.map((H,p)=>React.createElement("div",{key:p,className:"upload-preview-item"},React.createElement("img",{src:H.preview,alt:""}),React.createElement("button",{className:"remove",onClick:()=>E(p)},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("div",{className:"mt-3"},React.createElement("button",{className:"btn btn-warning",onClick:Ze,disabled:Ve},Ve?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),Le||"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload ",pt.length," \u1EA3nh")))))),React.createElement("div",{className:"card"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("h6",{className:"m-0"},React.createElement("i",{className:"fas fa-th me-2"}),"\u1EA2nh (",Ee.length,")"),Ee.length>0&&React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:dn},he.length===Ee.length?"B\u1ECF ch\u1ECDn":"Ch\u1ECDn t\u1EA5t c\u1EA3")),he.length>0&&React.createElement("div",{className:"d-flex align-items-center gap-2 flex-wrap"},React.createElement("span",{className:"badge bg-primary"},he.length," \u0111\xE3 ch\u1ECDn"),React.createElement("button",{className:"btn btn-sm btn-info",onClick:()=>ue(!0)},React.createElement("i",{className:"fas fa-folder-open me-1"}),"Di chuy\u1EC3n"),React.createElement("button",{className:"btn btn-sm btn-danger",onClick:Mt,disabled:nt},nt?React.createElement("span",{className:"spinner-border spinner-border-sm"}):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-trash me-1"}),"X\xF3a")),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>_e([])},React.createElement("i",{className:"fas fa-times"})))),rt?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):Ee.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},React.createElement("i",{className:"fas fa-image fa-2x mb-2"}),React.createElement("p",null,"Ch\u01B0a c\xF3 \u1EA3nh n\xE0o trong album n\xE0y")):React.createElement("div",{className:"image-grid"},Ee.map((H,p)=>React.createElement("div",{key:p,className:`image-item ${he.includes(H.id)?"selected":""}`,style:{position:"relative",cursor:"pointer"},onClick:()=>Et(H.id)},React.createElement("div",{className:"select-checkbox",style:{position:"absolute",top:"6px",left:"6px",zIndex:10,width:"24px",height:"24px",borderRadius:"4px",background:he.includes(H.id)?"#0d6efd":"rgba(255,255,255,0.9)",border:he.includes(H.id)?"none":"2px solid #ccc",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"}},he.includes(H.id)&&React.createElement("i",{className:"fas fa-check",style:{color:"#fff",fontSize:"12px"}})),React.createElement("img",{src:H.src,alt:H.caption,style:{opacity:he.includes(H.id)?.7:1,border:he.includes(H.id)?"3px solid #0d6efd":"none",borderRadius:"8px"}}),React.createElement("div",{className:"actions"},React.createElement("button",{className:"btn btn-sm btn-danger",onClick:G=>{G.stopPropagation(),Kt(H.id,p)},title:"X\xF3a \u1EA3nh"},React.createElement("i",{className:"fas fa-trash"}))),H.caption&&React.createElement("div",{className:"p-2 bg-light small text-truncate"},H.caption)))))),we&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header bg-info text-white"},React.createElement("h5",{className:"modal-title"},React.createElement("i",{className:"fas fa-folder-open me-2"}),"Di chuy\u1EC3n ",he.length," \u1EA3nh"),React.createElement("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>ue(!1)})),React.createElement("div",{className:"modal-body",style:{maxHeight:"400px",overflowY:"auto"}},React.createElement("p",{className:"text-muted small mb-3"},"Ch\u1ECDn th\u01B0 m\u1EE5c \u0111\xEDch:"),React.createElement("div",{className:"folder-tree"},S.filter(H=>!H.parentId).map(H=>React.createElement(FolderTreeItem,{key:H.uuid||H.id,folder:H,allAlbums:S,currentAlbumId:P.uuid||P.id,targetAlbum:Y,onSelect:de})))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>ue(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-info",onClick:Se,disabled:!Y||xe},xe?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang chuy\u1EC3n..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-1"}),"Di chuy\u1EC3n \u0111\u1EBFn \u0111\xE2y")))))),vt&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.9)"},onClick:()=>$t(null)},React.createElement("div",{className:"modal-dialog modal-fullscreen d-flex align-items-center justify-content-center"},React.createElement("div",{className:"position-relative",style:{maxWidth:"95vw",maxHeight:"95vh"}},React.createElement("button",{className:"btn btn-light position-absolute",style:{top:"-50px",right:"0",borderRadius:"50%",width:"40px",height:"40px"},onClick:()=>$t(null)},React.createElement("i",{className:"fas fa-times"})),React.createElement("img",{src:vt.src,alt:vt.caption,style:{maxWidth:"95vw",maxHeight:"90vh",objectFit:"contain"},onClick:H=>H.stopPropagation()}),vt.caption&&React.createElement("div",{className:"text-white text-center mt-2"},vt.caption)))))}function SearchCenter({showToast:P,onNavigate:F}){const[B,Ne]=useState(""),[oe,J]=useState([]),[V,Ee]=useState([]),[He,ke]=useState([]),[Je,rt]=useState("all"),[Fe,Ve]=useState(null),[ie,Le]=useState("list"),[X,pt]=useState(!0),[bt,_t]=useState([]),[Ge,st]=useState([]),Ke=useRef(null),[vt,$t]=useState(!0),[rn,tt]=useState(!1),jt=useRef(null),Ht=useRef(null),_=useRef(null),[T,z]=useState(!1),[ye,we]=useState([]),[ue,he]=useState([]),[_e,S]=useState(""),q=useRef(null),Y=useRef(new Map),[de,xe]=useState("auto"),[$e,Qe]=useState({start:0,end:20}),[Ye,St]=useState(!1),[Et,Se]=useState([{role:"assistant",content:`Xin ch\xE0o! H\xE3y h\u1ECFi t\xF4i v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3... V\xED d\u1EE5:
\u2022 "Gi\xE1 van 2 tay?"
\u2022 "Combo r\u1EBB nh\u1EA5t?"
\u2022 "Freeship?"`,attachments:[]}]),[nt,Jt]=useState(""),[Mt,dn]=useState(!1),Ft=useRef(null),yn=useRef(null),vn=s=>s?String(s).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").trim():"",E=s=>s?String(s).replace(/\s+/g,"").replace(/[-()]/g,"").replace(/^\+84/,"0").trim():"",ce=(s,m)=>{if(!s||!m)return s;const c=new RegExp(`(${m.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return s.replace(c,'<mark style="background:#ffeb3b">$1</mark>')};useEffect(()=>{try{const s=JSON.parse(localStorage.getItem("ktm_search_history")||"[]"),m=JSON.parse(localStorage.getItem("ktm_saved_searches")||"[]");we(Array.isArray(s)?s.slice(0,10):[]),he(Array.isArray(m)?m:[])}catch(s){}},[]);const Ze=s=>{if(!s.trim())return;const m=[s,...ye.filter(c=>c!==s)].slice(0,10);we(m);try{localStorage.setItem("ktm_search_history",JSON.stringify(m))}catch(c){}},Kt=s=>{if(!s.trim())return;const m=ue.includes(s)?ue.filter(c=>c!==s):[s,...ue].slice(0,5);he(m);try{localStorage.setItem("ktm_saved_searches",JSON.stringify(m))}catch(c){}},mn="ktm_search_query_stats_v1",Xt="ktm_search_product_stats_v1",Ut=(s,m)=>{try{const c=localStorage.getItem(s);if(!c)return m;const x=JSON.parse(c);return x!=null?x:m}catch(c){return m}},H=(s,m)=>{try{localStorage.setItem(s,JSON.stringify(m))}catch(c){}},[p,G]=useState(()=>Ut(mn,{})),[ae,Pe]=useState(()=>Ut(Xt,{})),je=useRef(!1),Ue=useRef(new Map);useEffect(()=>{const s=m=>{m&&(m.key===mn&&G(Ut(mn,{})),m.key===Xt&&Pe(Ut(Xt,{})))};return window.addEventListener("storage",s),()=>window.removeEventListener("storage",s)},[]);const xt=s=>{const m=String(s||"").trim();if(!m)return;const c=Ce(m).trim();if(c.length<3||c==="sdt:"||c==="#"||c.endsWith(":"))return;const x=Date.now(),R=Ut(mn,p&&typeof p=="object"?p:{}),w={...R&&typeof R=="object"?R:{}},N=w[c]&&typeof w[c]=="object"?w[c]:{};w[c]={q:m,count:(Number(N.count)||0)+1,lastAt:x},G(w),H(mn,w)},at=(s,m)=>{if(!s||s._type!=="product")return;const c=String(s.id||"").trim();if(!c)return;const x=Date.now(),R=Ut(Xt,ae&&typeof ae=="object"?ae:{}),w={...R&&typeof R=="object"?R:{}},N=w[c]&&typeof w[c]=="object"?w[c]:{};w[c]={id:c,name:String(s.name||N.name||"").trim(),code:String(s.code||N.code||"").trim(),count:(Number(N.count)||0)+1,lastAt:x,action:String(m||N.action||"").trim()},Pe(w),H(Xt,w)},un=(s,m)=>{const c=String(s||"").trim();if(!c)return;const x=Ce(c).trim();if(x.length<3||x==="sdt:"||x==="#"||x.endsWith(":"))return;const R=Date.now(),w=Number(Ue.current.get(x)||0);if(R-w<3e4)return;const U=(Array.isArray(m)?m:[]).find(le=>le&&le._type==="product");U&&(Ue.current.set(x,R),at(U,"search"))},Vt=useMemo(()=>Object.values(p&&typeof p=="object"?p:{}).map(c=>({q:String((c==null?void 0:c.q)||"").trim(),count:Number(c==null?void 0:c.count)||0,lastAt:Number(c==null?void 0:c.lastAt)||0})).filter(c=>c.q&&c.count>0).sort((c,x)=>x.count-c.count||x.lastAt-c.lastAt).slice(0,6),[p]),on=useMemo(()=>Object.values(ae&&typeof ae=="object"?ae:{}).map(c=>({id:String((c==null?void 0:c.id)||"").trim(),name:String((c==null?void 0:c.name)||"").trim(),code:String((c==null?void 0:c.code)||"").trim(),count:Number(c==null?void 0:c.count)||0,lastAt:Number(c==null?void 0:c.lastAt)||0})).filter(c=>c.id&&c.count>0).sort((c,x)=>x.count-c.count||x.lastAt-c.lastAt).slice(0,8).map(c=>{const x=V.find(R=>R&&R._type==="product"&&String(R.id)===c.id);return x?{...c,item:x}:{...c,item:null}}),[ae,V]),Nn=(s,m={})=>{const c=String(s||"");kt(c),m.addToHistory!==!1&&Ze(c),z(!1),fn(!1),k(!1),m.focus!==!1?(je.current=!0,setTimeout(()=>{var w;const R=Ke.current;(w=R==null?void 0:R.focus)==null||w.call(R);try{if(m.caret==="end"&&R&&typeof R.setSelectionRange=="function"){const N=String(R.value||"").length;R.setSelectionRange(N,N)}}catch(N){}},0)):(je.current=!1,setTimeout(()=>{var R,w,N,U;try{(w=(R=Ke.current)==null?void 0:R.blur)==null||w.call(R),(U=(N=document.activeElement)==null?void 0:N.blur)==null||U.call(N)}catch(le){}},0))},[it,pn]=useState(null),[In,xn]=useState(!1),[mt,r]=useState(null),[l,k]=useState(!1),[h,f]=useState(!1),[L,K]=useState(null),[b,A]=useState({name:"",code:"",price:"",image:"",category:"",note:"",commission_percent:""}),D=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"],W=s=>{var m,c;s._type==="product"&&(r(s),A({name:s.name||"",code:s.code||"",price:s.price||"",image:s.image||"",category:s.category||"",note:s.note||"",commission_percent:(c=(m=s.commission_percent)!=null?m:s.commissionPercent)!=null?c:""}),xn(!0))},se=async()=>{if(mt)try{await window.KTM.api.putJSON(`${API_BASE}/api/products?id=${mt.id}`,b,"L\u1ED7i c\u1EADp nh\u1EADt"),P("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),xn(!1),r(null),We()}catch(s){P(s.message,"danger")}},ve=async s=>{const m=s._type==="product"?"s\u1EA3n ph\u1EA9m":s._type==="album"?"\u1EA3nh":"video";if(confirm(`X\xF3a ${m} "${s.name}"?`))try{let c="";s._type==="product"?c=`${API_BASE}/api/products?id=${s.id}`:s._type==="album"?c=`${API_BASE}/api/images/${s.id}`:s._type==="video"&&(c=`${API_BASE}/api/videos/${s.id}`),await window.KTM.api.deleteJSON(c,"L\u1ED7i x\xF3a"),P(`\u0110\xE3 x\xF3a ${m}`,"success"),We()}catch(c){P(c.message,"danger")}},re=async s=>{try{const m=L?`${API_BASE}/api/products?id=${L.id}`:`${API_BASE}/api/products`;L?await window.KTM.api.putJSON(m,s,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(m,s,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),P(L?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),f(!1),K(null),We()}catch(m){P(m.message,"danger")}},De="ktm_admin_data_cache_v1",Ie=1e3*60*10,We=async()=>{let s=null,m=!1;const c=window.KTM.cache.read(De,{ttlMs:Ie,validate:Array.isArray});c.hit?(s=c.value,console.log("[CACHE] Using cache, items:",s.length),Ee(s),J(s),pt(!1),m=!0):c.status==="miss"?console.log("[CACHE] No cache found"):c.status==="expired"||c.status==="invalid"?console.log("[CACHE] Cache expired or invalid"):c.status==="error"&&console.error("[CACHE] Error parsing cache"),m||pt(!0);try{const x=async(Ae,y)=>{try{const ge=await window.KTM.api.getJSON(Ae,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");return ge!=null?ge:y}catch(ge){return y}},[R,w,N]=await Promise.all([x(`${API_BASE}/api/products?fields=search`,[]),x(`${API_BASE}/api/albums`,[]),x(`${API_BASE}/api/video-folders?withVideos=true`,[])]),U=Array.isArray(R)?R.map(Ae=>({...Ae,_type:"product",_source:"database"})):[];_t(w);let le=[];Array.isArray(w)&&w.length>0&&(await Promise.all(w.map(y=>x(`${API_BASE}/api/albums/${y.id}`,{})))).forEach((y,ge)=>{const fe=w[ge];y.images&&y.images.length>0&&y.images.forEach(ot=>{le.push({id:ot.id,name:ot.caption||"\u1EA2nh t\u1EEB "+fe.title,image:ot.src,folder:fe.title,_type:"album",_source:"database"})})}),st(N);let Q=[];Array.isArray(N)&&N.forEach(Ae=>{Ae.videos&&Ae.videos.forEach(y=>{Q.push({id:y.id,name:y.title,folder:Ae.name,image:y.thumb,youtubeId:y.youtubeId,url:y.url,_type:"video",_source:"database"})})});const te=[...U,...le,...Q];(!s||JSON.stringify(te)!==JSON.stringify(s))&&(Ee(te),J(te),window.KTM.cache.write(De,te))}catch(x){console.error("Song song fetch error:",x)}pt(!1)};useEffect(()=>{We(),setTimeout(()=>{var m;return(m=Ke.current)==null?void 0:m.focus()},100);const s=m=>{var c,x;(m.ctrlKey||m.metaKey)&&m.key==="k"&&(m.preventDefault(),z(!0),setTimeout(()=>{var R;return(R=q.current)==null?void 0:R.focus()},0)),m.key==="/"&&!T&&((c=document.activeElement)==null?void 0:c.tagName)!=="INPUT"&&(m.preventDefault(),(x=Ke.current)==null||x.focus()),m.key==="Escape"&&T&&z(!1)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[T]);const Ce=s=>{try{return String(s!=null?s:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(m){return String(s!=null?s:"").toLowerCase()}},ut=s=>{const c=Ce(s).trim().split(/\s+/).filter(Boolean).map(le=>{const Q=String(le||"").trim();return Q?Q.startsWith("#")?Q.slice(1):Q.startsWith("sdt:")?Q.slice(4):Q.startsWith("phone:")?Q.slice(6):Q:""}).filter(Boolean),x=c.includes("anh"),R=c.includes("video"),w=c.filter(le=>le!=="anh"&&le!=="video"),N=w.join(" "),U=new Set(["product"]);return x&&U.add("album"),R&&U.add("video"),{allowedTypes:U,includeAlbum:x,includeVideo:R,contentTokens:w,cleanedQuery:N}},pe=(s,m,c)=>{var ge,fe,ot,ct,At;const x=Array.isArray(m)?m:[],R=Ce(c).trim();if(!x.length&&!R)return 0;const w=Ce((ge=s==null?void 0:s.name)!=null?ge:""),N=Ce((fe=s==null?void 0:s.code)!=null?fe:""),U=Ce((ot=s==null?void 0:s.category)!=null?ot:""),le=Ce((ct=s==null?void 0:s.note)!=null?ct:""),Q=Ce((At=s==null?void 0:s.folder)!=null?At:"");if(!`${w} ${N} ${U} ${le} ${Q}`.trim())return 0;const Oe=w.replace(/\s+/g,""),Ae=R.replace(/\s+/g,"");let y=0;R&&(w===R&&(y+=220),w.includes(R)&&(y+=140),w.startsWith(R)&&(y+=160),Ae&&(Oe===Ae?y+=280:Oe.startsWith(Ae)?y+=180:Oe.includes(Ae)&&(y+=110)),N&&N===R&&(y+=180),N&&N.includes(R)&&(y+=90));for(const Zt of x){if(!Zt)continue;const zt=new RegExp(`(?:^|\\s)${Zt.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}`),Wt=String(Zt).replace(/\s+/g,"");w.includes(Zt)&&(y+=35),zt.test(w)&&(y+=25),Wt&&(Oe===Wt?y+=90:Oe.startsWith(Wt)?y+=50:Oe.includes(Wt)&&(y+=28)),N&&N.includes(Zt)&&(y+=20),N&&zt.test(N)&&(y+=10),U&&U.includes(Zt)&&(y+=12),Q&&Q.includes(Zt)&&(y+=12),le&&le.includes(Zt)&&(y+=6)}return y>0&&w&&(y+=Math.max(0,10-Math.min(10,Math.floor(w.length/10)))),y},ze=(s,m,c)=>{const x=Array.isArray(s)?s:[];return x.length?x.map((w,N)=>({it:w,idx:N,score:pe(w,m,c)})).sort((w,N)=>N.score!==w.score?N.score-w.score:w.idx-N.idx).map(w=>w.it):[]},Dt=async(s,m)=>{if(!(!vt||m.length===0)){tt(!0);try{const c=m.map(R=>({id:R.id,name:R.name,price:R.price,category:R.category,note:R.note,folder:R.folder,_type:R._type})),x=await window.KTM.api.postJSON(`${API_BASE}/api/ai-search`,{query:s,products:c},"AI Search error");if(x&&x.matchedIds&&x.matchedIds.length>0){const{contentTokens:R,cleanedQuery:w}=ut(s),N=new Set(x.matchedIds),U=m.filter(le=>N.has(le.id)).sort((le,Q)=>pe(Q,R,w)-pe(le,R,w));U.length>0&&J(U)}else x&&x.matchedIds&&x.matchedIds.length===0&&J([])}catch(c){console.error("AI Search error:",c)}tt(!1)}},kt=s=>{if(Ne(s),S(s),Ht.current&&clearTimeout(Ht.current),jt.current&&clearTimeout(jt.current),_.current&&_.current.abort(),!s.trim()){Nt(Je);return}const c=`v2|${Ce(s).trim().replace(/\s+/g,"")}|${Je}`;if(Y.current.has(c)){J(Y.current.get(c));return}const{allowedTypes:x,contentTokens:R,cleanedQuery:w}=ut(s);Ht.current=setTimeout(()=>{const N=V.filter(Q=>{if(!x.has(Q==null?void 0:Q._type))return!1;if(R.length===0)return!0;const te=vn(Object.entries(Q).filter(([ge])=>!ge.startsWith("_")).map(([,ge])=>String(ge||"")).join(" ")),Oe=Q.phone?E(Q.phone):"",Ae=`${te} ${Oe}`.trim(),y=Ae.replace(/\s+/g,"");return R.every(ge=>{const fe=String(ge||"").trim();return fe?Ae.includes(fe)||y.includes(fe.replace(/\s+/g,"")):!0})});let U=N;Je!=="all"&&(U=N.filter(Q=>(Q==null?void 0:Q._type)===Je));const le=ze(U,R,w);if(xt(s),un(s,le),Y.current.size>20){const Q=Y.current.keys().next().value;Y.current.delete(Q)}Y.current.set(c,le),J(le),vt&&w.length>=3&&(jt.current=setTimeout(()=>{Dt(w,U)},500))},200)},Nt=s=>{rt(s);const{allowedTypes:m,contentTokens:c}=ut(B),{cleanedQuery:x}=ut(B);let R=V.filter(w=>m.has(w==null?void 0:w._type));s!=="all"&&(R=R.filter(w=>(w==null?void 0:w._type)===s)),B.trim()&&c.length>0&&(R=R.filter(w=>{const N=Ce(Object.entries(w).filter(([te])=>!te.startsWith("_")).map(([,te])=>String(te||"")).join(" ")),U=w.phone?E(w.phone):"",le=`${N} ${U}`.trim(),Q=le.replace(/\s+/g,"");return c.every(te=>{const Oe=String(te||"").trim();return Oe?le.includes(Oe)||Q.includes(Oe.replace(/\s+/g,"")):!0})})),J(ze(R,c,x))},Be=(s,m,c)=>{c&&c.item&&at(c.item,c.action||"copy"),window.KTM.clipboard.writeText(s).then(()=>{Ve(m),P("\u0110\xE3 copy!","success"),setTimeout(()=>Ve(null),1500)})},O=async(s,m,c)=>{try{c&&c.item&&at(c.item,c.action||"copy_image"),await window.KTM.clipboard.writeImageFromUrl(s),Ve(m+"-img"),P("\u0110\xE3 copy \u1EA3nh!","success"),setTimeout(()=>Ve(null),1500)}catch(x){Be(s,m+"-img",c)}},me=s=>{let m=s.toLowerCase();const c=[],x=V.filter(N=>N._type==="product");if(m.includes("ty")||m.includes("xy lanh")){if(m.includes("gi\u1EEFa")||m.includes("giua")){const N=x.find(U=>{var le;return(le=U.name)==null?void 0:le.toLowerCase().includes("xy lanh gi\u1EEFa")});N&&!c.find(U=>U.id===N.id)&&c.push(N)}if(m.includes("nghi\xEAng")||m.includes("nghieng")){const N=x.find(U=>{var le;return(le=U.name)==null?void 0:le.toLowerCase().includes("xy lanh nghi\xEAng")});N&&!c.find(U=>U.id===N.id)&&c.push(N)}if(m.includes("\u1EE7i")||m.includes("ui")){const N=x.find(U=>{var le;return(le=U.name)==null?void 0:le.toLowerCase().includes("xy lanh \u1EE7i")});N&&!c.find(U=>U.id===N.id)&&c.push(N)}}const R=m.match(/van\s*(\d+)\s*tay.*?(\d+)\s*ty/);if(R){const N=R[1],U=R[2],le=x.find(Q=>{var Oe;const te=((Oe=Q.name)==null?void 0:Oe.toLowerCase())||"";return te.includes("combo")&&te.includes(`${N} tay`)&&(te.includes(`${U} xy`)||te.includes(`${U} xylanh`))});if(le&&!c.find(Q=>Q.id===le.id))c.push(le);else{const Q=x.find(te=>{var Ae;const Oe=((Ae=te.name)==null?void 0:Ae.toLowerCase())||"";return Oe.includes("combo")&&Oe.includes(`${N} tay`)});Q&&!c.find(te=>te.id===Q.id)&&c.push(Q)}}if(m.includes("combo")&&!R){const N=m.match(/combo.*?(\d+)\s*tay/);if(N){const U=N[1];x.filter(Q=>{var Oe;const te=((Oe=Q.name)==null?void 0:Oe.toLowerCase())||"";return te.includes("combo")&&te.includes(`${U} tay`)}).forEach(Q=>{c.find(te=>te.id===Q.id)||c.push(Q)})}}const w=m.match(/van\s*(\d+)\s*tay/);if(w&&!m.includes("ty")&&!m.includes("combo")){const N=w[1],U=x.find(le=>{var te;const Q=((te=le.name)==null?void 0:te.toLowerCase())||"";return Q.includes(`van ${N} tay`)&&!Q.includes("combo")});U&&!c.find(le=>le.id===U.id)&&c.push(U)}return c.slice(0,4)},Xe=async s=>{if(!s.trim())return;const m={role:"user",content:s,attachments:[]};Se(x=>[...x,m]),Jt(""),dn(!0);const c=me(s);setTimeout(()=>{var x;return(x=Ft.current)==null?void 0:x.scrollIntoView({behavior:"smooth"})},100);try{const R=V.filter(te=>te._type==="product").map(te=>{let Oe=`- ${te.name}`;return te.code&&(Oe+=` (M\xE3: ${te.code})`),te.price&&(Oe+=` - Gi\xE1: ${te.price.replace(/[đ\s]/g,"")}\u0111`),te.category&&(Oe+=` [${te.category}]`),te.note&&(Oe+=` (${te.note})`),Oe}).join(`
`),N=Et.slice(-6).map(te=>`${te.role==="user"?"Kh\xE1ch":"AI"}: ${te.content}`).join(`
`),U=N?`L\u1ECACH S\u1EEC H\u1ED8I THO\u1EA0I:
${N}

DANH S\xC1CH S\u1EA2N PH\u1EA8M:
${R}`:R,Q=(await window.KTM.api.postJSON(`${API_BASE}/api/ai-chat`,{message:s,context:U,audience:"admin"},"API error")).response||"Xin l\u1ED7i, t\xF4i kh\xF4ng th\u1EC3 tr\u1EA3 l\u1EDDi l\xFAc n\xE0y.";Se(te=>[...te,{role:"assistant",content:Q,attachments:c}])}catch(x){console.error("AI Error:",x);const R=s.toLowerCase(),w=V.filter(U=>{const le=Object.values(U).join(" ").toLowerCase();return R.split(" ").some(Q=>le.includes(Q))});let N="";w.length>0?(N=`T\xECm th\u1EA5y ${w.length} s\u1EA3n ph\u1EA9m li\xEAn quan:

`,w.slice(0,5).forEach(U=>{N+=`\u2022 ${U.name}`,U.price&&(N+=` - ${U.price.replace(/[đ\s]/g,"")}\u0111`),U.note&&(N+=` (${U.note})`),N+=`
`}),w.length>5&&(N+=`
...v\xE0 ${w.length-5} s\u1EA3n ph\u1EA9m kh\xE1c`)):N='Kh\xF4ng t\xECm th\u1EA5y s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p. H\xE3y th\u1EED t\u1EEB kh\xF3a kh\xE1c nh\u01B0 "van", "combo", "xy lanh"...',Se(U=>[...U,{role:"assistant",content:N,attachments:w.slice(0,4)}])}dn(!1),setTimeout(()=>{var x,R;(x=Ft.current)==null||x.scrollIntoView({behavior:"smooth"}),(R=yn.current)==null||R.focus()},100)};function ft({show:s,product:m,categories:c,onClose:x,onSave:R}){const[w,N]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[U,le]=useState(!1),[Q,te]=useState(!1),Oe=useRef(null),Ae=Z=>window.KTM.money.formatVNDInputDigits(Z),y=Z=>{const ne=window.KTM.money.getDigits(String(Z!=null?Z:"")),be=Number(ne);return ne&&Number.isFinite(be)?Math.trunc(be):0},ge=(Z,ne)=>{if(Z==null||Z==="")return[];let be=Z;if(typeof be=="string"){const Re=be.trim();if(!Re)return[];try{be=JSON.parse(Re)}catch(Me){return[]}}if(!Array.isArray(be))return[];const qe=y(ne);return be.map(Re=>{var lt;if(!Re||typeof Re!="object")return null;const Me=String((lt=Re.name)!=null?lt:"").trim(),ht=(Array.isArray(Re.options)?Re.options:[]).map(Tt=>{var Tn,Rn,Kn,On,Gn,Bn,ka;if(!Tt||typeof Tt!="object")return null;const en=String((Tn=Tt.label)!=null?Tn:"").trim();if(!en)return null;const ln=(Gn=(On=(Kn=(Rn=Tt.price)!=null?Rn:Tt.priceValue)!=null?Kn:Tt.unit_price)!=null?On:Tt.unitPrice)!=null?Gn:null,kn=Number(ln);let Mn=Number.isFinite(kn)?Math.trunc(kn):null;if(Mn==null){const Pn=(ka=(Bn=Tt.price_delta)!=null?Bn:Tt.priceDelta)!=null?ka:null,Jn=Number(Pn);Number.isFinite(Jn)&&(Mn=qe+Math.trunc(Jn))}Mn==null&&(Mn=qe);const An=String(Math.max(0,Math.trunc(Number(Mn)||0)));return{label:en,price:Math.max(0,Math.trunc(Number(Mn)||0)),priceDigits:An}}).filter(Boolean);return{name:Me||"Bi\u1EBFn th\u1EC3",options:ht}}).filter(Boolean)},fe=Z=>{if(Z==null||Z==="")return[];let ne=Z;if(typeof ne=="string"){const be=ne.trim();if(!be)return[];try{ne=JSON.parse(be)}catch(qe){return[]}}return ne&&typeof ne=="object"&&!Array.isArray(ne)&&(ne=Object.entries(ne).map(([be,qe])=>({key:be,value:qe}))),Array.isArray(ne)?ne.map(be=>{var ht,lt,Tt,en,ln;if(!be||typeof be!="object")return null;const qe=String((Tt=(lt=(ht=be.key)!=null?ht:be.name)!=null?lt:be.label)!=null?Tt:"").trim(),Re=String((en=be.value)!=null?en:"").trim(),Me=String((ln=be.unit)!=null?ln:"").trim();return qe?{key:qe,value:Re,unit:Me}:null}).filter(Boolean):[]};useEffect(()=>{var Z,ne;if(m)if(N({name:m.name||"",code:m.code||"",price:m.price||"",image:m.image||"",category:m.category||"",note:m.note||"",sort_order:m.sort_order||0,commission_percent:(ne=(Z=m.commission_percent)!=null?Z:m.commissionPercent)!=null?ne:5,variants:ge(m.variants,m.price),attributes:fe(m.attributes)}),m.price){const be=window.KTM.money.getDigits(m.price);Wt(be),N(qe=>({...qe,price:Ae(be)}))}else Wt("");else N({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),Wt("")},[m,s]);const ot=Z=>{N(ne=>{var ht;const be=y(ne.price),qe=String(be),Re=Array.isArray(ne.variants)?[...ne.variants]:[],Me={...Re[Z]||{},options:Array.isArray((ht=Re[Z])==null?void 0:ht.options)?[...Re[Z].options]:[]};return Me.options=Me.options.map(lt=>({label:String((lt==null?void 0:lt.label)||""),price:be,priceDigits:qe})),Re[Z]=Me,{...ne,variants:Re}})},ct=()=>{N(Z=>{const ne=y(Z.price),be=String(ne),Re=(Array.isArray(Z.variants)?[...Z.variants]:[]).map(Me=>{const ht=(Array.isArray(Me==null?void 0:Me.options)?Me.options:[]).map(lt=>({label:String((lt==null?void 0:lt.label)||""),price:ne,priceDigits:be}));return{name:String((Me==null?void 0:Me.name)||"Bi\u1EBFn th\u1EC3"),options:ht}});return{...Z,variants:Re}})},[At,Zt]=React.useState(""),[zt,Wt]=React.useState(""),yt=Z=>{const ne=window.KTM.money.nextPriceInputState(Z.target.value,zt);Wt(ne.digits),N({...w,price:ne.price})},nn=async(Z,ne=2)=>{const be=ne*1024*1024;if(Z.size<=be)return Z;try{const qe=await createImageBitmap(Z),Re=document.createElement("canvas");let Me=qe.width,ht=qe.height;const lt=1200;return(Me>lt||ht>lt)&&(Me>ht?(ht=Math.round(ht/Me*lt),Me=lt):(Me=Math.round(Me/ht*lt),ht=lt)),Re.width=Me,Re.height=ht,Re.getContext("2d").drawImage(qe,0,0,Me,ht),qe.close(),new Promise((en,ln)=>{Re.toBlob(kn=>{kn?en(new File([kn],Z.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):ln(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(qe){throw console.error("Compress error:",qe),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},hn=async Z=>{var qe;const ne=Z.target.files[0];if(!ne)return;if(!(ne.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp)$/i.test(ne.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}te(!0);try{const Re=await nn(ne),Me=await window.KTM.cloudinary.uploadImage({file:Re,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-products"});if(!Me.secure_url)throw console.error("Cloudinary error:",Me),new Error(((qe=Me.error)==null?void 0:qe.message)||"Upload failed");N(ht=>({...ht,image:Me.secure_url}))}catch(Re){console.error("Upload error:",Re),alert("L\u1ED7i upload \u1EA3nh: "+Re.message)}te(!1),Z.target.value=""},cn=async Z=>{Z.preventDefault(),le(!0);const ne={...w,variants:ge(w.variants,w.price),attributes:fe(w.attributes)};await R(ne),le(!1)};return s?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-lg"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,border:"none",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark"},React.createElement("i",{className:"fas fa-box me-2"}),m?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:x})),React.createElement("form",{onSubmit:cn},React.createElement("div",{className:"modal-body",style:{maxHeight:"70vh",overflowY:"auto"}},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-8"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-tag me-1"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:w.name,onChange:Z=>N({...w,name:Z.target.value}),placeholder:"V\xED d\u1EE5: Xy lanh nghi\xEAng KTM",required:!0,style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-hashtag me-1"}),"M\xE3 s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:w.code,onChange:Z=>N({...w,code:Z.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1"}),"Gi\xE1 b\xE1n"),React.createElement("input",{type:"text",className:"form-control",value:w.price,onChange:yt,placeholder:"1.950.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3 mt-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-percent me-1"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:w.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:Z=>N({...w,commission_percent:Z.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-list me-1"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:w.category,onChange:Z=>N({...w,category:Z.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),c.map(Z=>React.createElement("option",{key:Z,value:Z},Z)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1"}),"Ghi ch\xFA"),React.createElement("textarea",{className:"form-control",rows:"2",value:w.note,onChange:Z=>N({...w,note:Z.target.value}),placeholder:"V\xED d\u1EE5: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(w.attributes)?w.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(w.attributes)?w.attributes:[]).map((Z,ne)=>React.createElement("div",{key:ne,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(Z==null?void 0:Z.key)||"",onChange:be=>{const qe=be.target.value;N(Re=>{const Me=Array.isArray(Re.attributes)?[...Re.attributes]:[];return Me[ne]={...Me[ne]||{},key:qe},{...Re,attributes:Me}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(Z==null?void 0:Z.value)||"",onChange:be=>{const qe=be.target.value;N(Re=>{const Me=Array.isArray(Re.attributes)?[...Re.attributes]:[];return Me[ne]={...Me[ne]||{},value:qe},{...Re,attributes:Me}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(Z==null?void 0:Z.unit)||"",onChange:be=>{const qe=be.target.value;N(Re=>{const Me=Array.isArray(Re.attributes)?[...Re.attributes]:[];return Me[ne]={...Me[ne]||{},unit:qe},{...Re,attributes:Me}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{N(be=>{const qe=Array.isArray(be.attributes)?[...be.attributes]:[];return qe.splice(ne,1),{...be,attributes:qe}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{N(Z=>{const ne=Array.isArray(Z.attributes)?[...Z.attributes]:[];return ne.push({key:"",value:"",unit:""}),{...Z,attributes:ne}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(w.variants)?w.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3. C\xF3 th\u1EC3 th\xEAm (v\xED d\u1EE5 Size: S/M/L)."):null,(Array.isArray(w.variants)?w.variants:[]).map((Z,ne)=>React.createElement("div",{key:ne,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(Z==null?void 0:Z.name)||"",onChange:be=>{const qe=be.target.value;N(Re=>{var ht;const Me=Array.isArray(Re.variants)?[...Re.variants]:[];return Me[ne]={...Me[ne]||{},name:qe,options:Array.isArray((ht=Me[ne])==null?void 0:ht.options)?Me[ne].options:[]},{...Re,variants:Me}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>ot(ne),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(Z==null?void 0:Z.options)||Z.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{N(be=>{const qe=Array.isArray(be.variants)?[...be.variants]:[];return qe.splice(ne,1),{...be,variants:qe}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(Z==null?void 0:Z.options)?Z.options:[]).map((be,qe)=>{var Re,Me;return React.createElement("div",{key:qe,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(be==null?void 0:be.label)||"",onChange:ht=>{const lt=ht.target.value;N(Tt=>{var An,Tn,Rn,Kn,On;const en=Array.isArray(Tt.variants)?[...Tt.variants]:[],ln={...en[ne]||{},options:Array.isArray((An=en[ne])==null?void 0:An.options)?[...en[ne].options]:[]},kn=Number((Rn=(Tn=ln.options[qe])==null?void 0:Tn.price)!=null?Rn:0)||0,Mn=String((On=(Kn=ln.options[qe])==null?void 0:Kn.priceDigits)!=null?On:Math.max(0,Math.trunc(kn)));return ln.options[qe]={...ln.options[qe]||{},label:lt,price:Math.max(0,Math.trunc(kn)),priceDigits:Mn},en[ne]=ln,{...Tt,variants:en}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:Ae(String((Me=be==null?void 0:be.priceDigits)!=null?Me:window.KTM.money.getDigits(String((Re=be==null?void 0:be.price)!=null?Re:"")))),onChange:ht=>{N(lt=>{var Rn,Kn,On,Gn,Bn;const Tt=String((Kn=be==null?void 0:be.priceDigits)!=null?Kn:window.KTM.money.getDigits(String((Rn=be==null?void 0:be.price)!=null?Rn:""))),en=window.KTM.money.nextPriceInputState(ht.target.value,Tt),ln=String((On=en.digits)!=null?On:""),kn=Number(ln),Mn=Number.isFinite(kn)?Math.max(0,Math.trunc(kn)):0,An=Array.isArray(lt.variants)?[...lt.variants]:[],Tn={...An[ne]||{},options:Array.isArray((Gn=An[ne])==null?void 0:Gn.options)?[...An[ne].options]:[]};return Tn.options[qe]={...Tn.options[qe]||{},label:String(((Bn=Tn.options[qe])==null?void 0:Bn.label)||""),price:Mn,priceDigits:ln},An[ne]=Tn,{...lt,variants:An}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{N(ht=>{var en;const lt=Array.isArray(ht.variants)?[...ht.variants]:[],Tt={...lt[ne]||{},options:Array.isArray((en=lt[ne])==null?void 0:en.options)?[...lt[ne].options]:[]};return Tt.options.splice(qe,1),lt[ne]=Tt,{...ht,variants:lt}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{N(be=>{var ht;const qe=Array.isArray(be.variants)?[...be.variants]:[],Re={...qe[ne]||{},options:Array.isArray((ht=qe[ne])==null?void 0:ht.options)?[...qe[ne].options]:[]},Me=y(be.price);return Re.options.push({label:"",price:Me,priceDigits:String(Me)}),qe[ne]=Re,{...be,variants:qe}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{N(Z=>{const ne=y(Z.price),be=Array.isArray(Z.variants)?[...Z.variants]:[],qe=String(ne);return be.push({name:"Size",options:[{label:"S",price:ne,priceDigits:qe},{label:"M",price:ne,priceDigits:qe},{label:"L",price:ne,priceDigits:qe}]}),{...Z,variants:be}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:ct,disabled:!Array.isArray(w.variants)||w.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111.")))),React.createElement("div",{className:"col-md-4"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-image me-1"}),"\u1EA2nh s\u1EA3n ph\u1EA9m"),React.createElement("div",{className:"mb-2"},w.image?React.createElement(React.Fragment,null,React.createElement("img",{src:w.image,alt:"Product",style:{width:"100%",height:150,objectFit:"cover",borderRadius:"12px",border:"2px solid #e9ecef"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger mt-2",onClick:()=>N({...w,image:""}),style:{borderRadius:"20px",fontSize:"0.75rem"}},React.createElement("i",{className:"fas fa-times me-1"}),"X\xF3a \u1EA3nh")):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:"100%",height:150,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd",cursor:"pointer"},onClick:()=>{var Z;return(Z=Oe.current)==null?void 0:Z.click()}},React.createElement("div",{className:"text-center"},React.createElement("i",{className:"fas fa-cloud-upload-alt fa-2x text-muted mb-2"}),React.createElement("div",{className:"small text-muted"},"Click \u0111\u1EC3 upload")))),React.createElement("input",{ref:Oe,type:"file",accept:"image/*",className:"d-none",onChange:hn}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100",onClick:()=>{var Z;return(Z=Oe.current)==null?void 0:Z.click()},disabled:Q,style:{borderRadius:"10px"}},Q?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh")),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"Ho\u1EB7c URL \u1EA3nh"),React.createElement("input",{type:"url",className:"form-control",value:w.image,onChange:Z=>N({...w,image:Z.target.value}),placeholder:"https://...",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"8px",fontSize:"0.875rem"}}))))),React.createElement("div",{className:"modal-footer",style:{border:"none",padding:"20px"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:x,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:U,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},U?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}const Ct=s=>window.KTM.money.formatVND(s),Yt=s=>{if(s==null||s==="")return[];let m=s;if(typeof m=="string"){const c=m.trim();if(!c)return[];try{m=JSON.parse(c)}catch(x){return[]}}return Array.isArray(m)?m:[]},wt=s=>{if(s==null||s==="")return[];let m=s;if(typeof m=="string"){const c=m.trim();if(!c)return[];try{m=JSON.parse(c)}catch(x){return[]}}return m&&typeof m=="object"&&!Array.isArray(m)&&(m=Object.entries(m).map(([c,x])=>({key:c,value:x}))),Array.isArray(m)?m:[]},Lt=(s,m={})=>{var w;const c=wt(s).map(N=>{var U,le,Q,te,Oe;return{key:String((Q=(le=(U=N==null?void 0:N.key)!=null?U:N==null?void 0:N.name)!=null?le:N==null?void 0:N.label)!=null?Q:"").trim(),value:String((te=N==null?void 0:N.value)!=null?te:"").trim(),unit:String((Oe=N==null?void 0:N.unit)!=null?Oe:"").trim()}}).filter(N=>!!N.key);if(!c.length)return null;const x=!!m.compact,R=String((w=m.className)!=null?w:"").trim();return React.createElement("div",{className:`ktm-variants-preview${x?" compact":""}${R?" "+R:""}`},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},c.map((N,U)=>{const le=N.key,Q=`${N.value||""}${N.unit?(N.value?" ":"")+N.unit:""}`.trim();return React.createElement("div",{key:`${le}-${U}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},le),Q?React.createElement("span",{className:"ktm-chip ktm-chip-option"},Q):null)})))},Qt=(s,m={})=>{var le;const c=Yt(s).map(Q=>{var te;return{name:String((te=Q==null?void 0:Q.name)!=null?te:"").trim(),options:Array.isArray(Q==null?void 0:Q.options)?Q.options:[]}}).map(Q=>({...Q,options:Q.options.map(te=>{var Oe;return{label:String((Oe=te==null?void 0:te.label)!=null?Oe:"").trim(),price:Number(te==null?void 0:te.price)}}).filter(te=>!!te.label)})).filter(Q=>Q.options.length>0);if(!c.length)return null;const x=Number.isFinite(m.maxGroups)?Math.max(1,Math.trunc(m.maxGroups)):c.length,R=Number.isFinite(m.maxOptionsPerGroup)?Math.max(1,Math.trunc(m.maxOptionsPerGroup)):3,w=!!m.compact,N=String((le=m.className)!=null?le:"").trim(),U=c.slice(0,x);return React.createElement("div",{className:`ktm-variants-preview${w?" compact":""}${N?" "+N:""}`},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},U.map((Q,te)=>{const Oe=Q.name||"Bi\u1EBFn th\u1EC3",Ae=Q.options.slice(0,R),y=Q.options.length-Ae.length;return React.createElement("div",{key:`${Oe}-${te}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},Oe),Ae.map((ge,fe)=>{const ot=ge.price,ct=Number.isFinite(ot)&&ot>=0?Ct(Math.trunc(ot)):"",At=ct?`${ge.label} \xB7 ${ct}`:ge.label;return React.createElement("span",{key:`${Oe}-${te}-${fe}`,className:"ktm-chip ktm-chip-option"},At)}),y>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",y))})))},It=(s,m)=>{const c=s._type==="product",x=s._type==="album",R=s._type==="video",w=s.note&&(s.note.toLowerCase().includes("free")||s.note.toLowerCase().includes("gi\u1EA3m")||s.note.toLowerCase().includes("sale")),N=c?Lt(s.attributes,{compact:ie==="grid",className:ie==="grid"?"meta text-muted":"text-muted"}):null,U=c?Qt(s.variants,{compact:ie==="grid",maxOptionsPerGroup:999,className:ie==="grid"?"meta text-muted":"text-muted"}):null;return ie==="grid"?React.createElement("div",{key:s.id||m,className:"grid-card"},React.createElement("div",{className:"thumb-wrap",onClick:()=>{at(s,"preview"),pn({url:s.image,name:s.name,price:s.price,note:s.note,item:s})}},s.image?React.createElement("img",{src:s.image,alt:s.name,className:"thumb",loading:"lazy"}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${R?"fa-video":"fa-image"} fa-2x text-muted`})),s.price&&React.createElement("div",{className:"price-overlay"},s.price.replace(/[đ\s]/g,""),"\u0111"),React.createElement("span",{className:`type-badge ${c?"product":x?"album":"video"}`},c?"SP":x?"\u1EA2nh":"Video"),w&&React.createElement("span",{className:"promo-badge"},"\u{1F525} \u01AFU \u0110\xC3I")),React.createElement("div",{className:"card-body"},React.createElement("div",{className:"name"},s.name),s.note&&React.createElement("div",{className:"meta text-info",style:{fontSize:10}},s.note),N&&React.createElement("div",{style:{marginTop:2}},N),U&&React.createElement("div",{style:{marginTop:2}},U),React.createElement("div",{className:"quick-copy"},React.createElement("button",{className:Fe===s.id+"-img"?"copied":"",onClick:()=>O(s.image,s.id,{item:s,action:"copy_image"})},React.createElement("i",{className:"fas fa-image"})),s.price&&React.createElement("button",{className:Fe===s.id+"-price"?"copied":"",onClick:()=>Be(s.price.replace(/[đ\s]/g,""),s.id+"-price",{item:s,action:"copy_price"})},React.createElement("i",{className:"fas fa-tag"}))))):React.createElement("div",{key:s.id||m,className:"product-card-mobile"},React.createElement("span",{className:`type-badge ${c?"product":x?"album":"video"}`},c?"S\u1EA3n ph\u1EA9m":x?"\u1EA2nh":"Video"),React.createElement("div",{className:"card-inner"},s.image?React.createElement("img",{src:s.image,alt:s.name,className:"thumb",loading:"lazy",onClick:()=>{at(s,"preview"),pn({url:s.image,name:s.name,price:s.price,note:s.note,item:s})}}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${R?"fa-video":"fa-image"} fa-2x text-muted`})),React.createElement("div",{className:"info"},React.createElement("div",null,React.createElement("div",{className:"name"},s.name),React.createElement("div",{className:"price-row"},s.price&&React.createElement("span",{className:"price"},s.price.replace(/[đ\s]/g,""),"\u0111"),w&&React.createElement("span",{className:"badge-promo"},"\u{1F525} \u01AFU \u0110\xC3I")),N&&React.createElement("div",{style:{marginTop:4}},N),U&&React.createElement("div",{style:{marginTop:4}},U)),React.createElement("div",{className:"meta"},s.code&&React.createElement("span",{className:"meta-tag"},"#",s.code),s.category&&React.createElement("span",{className:"meta-tag"},s.category),s.note&&React.createElement("span",{className:"meta-tag highlight"},s.note),s.folder&&React.createElement("span",{className:"meta-tag"},s.folder),R&&React.createElement("span",{className:"meta-tag"},React.createElement("i",{className:"fab fa-youtube text-danger"})," Video")))),React.createElement("div",{className:"quick-actions"},c&&React.createElement("button",{onClick:()=>{at(s,"create_order"),F&&F("orders","create",{productId:s.id})}},React.createElement("i",{className:"fas fa-receipt"})," T\u1EA1o \u0111\u01A1n"),s.price&&React.createElement("button",{className:Fe===s.id+"-price"?"copied":"",onClick:()=>Be(s.price.replace(/[đ\s]/g,""),s.id+"-price",{item:s,action:"copy_price"})},React.createElement("i",{className:"fas fa-tag"})," Gi\xE1"),React.createElement("button",{className:Fe===s.id+"-name"?"copied":"",onClick:()=>Be(s.name,s.id+"-name",{item:s,action:"copy_name"})},React.createElement("i",{className:"fas fa-font"})," T\xEAn"),R&&s.youtubeId&&React.createElement("button",{className:Fe===s.id+"-yt"?"copied":"",onClick:()=>Be(`https://www.youtube.com/watch?v=${s.youtubeId}`,s.id+"-yt")},React.createElement("i",{className:"fab fa-youtube"})),c&&React.createElement("button",{className:"action-edit",onClick:()=>W(s)},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"action-delete",onClick:()=>ve(s)},React.createElement("i",{className:"fas fa-trash"}))))},[tn,fn]=useState(!1);return React.createElement(React.Fragment,null,React.createElement("div",{className:"search-suggestions mobile-only"},React.createElement("div",{className:"search-suggestions-section"},React.createElement("div",{className:"search-suggestions-label"},"G\u1EE3i \xFD nhanh"),React.createElement("div",{className:"search-suggestions-row"},[{label:"van 2 tay",query:"van 2 tay"},{label:"combo r\u1EBB",query:"combo r\u1EBB"},{label:"xylanh",query:"xylanh"},{label:"sdt:\u2026",query:"sdt:",caret:"end",addToHistory:!1},{label:"#m\xE3\u2026",query:"#",caret:"end",addToHistory:!1}].map(s=>React.createElement("button",{key:s.label,type:"button",className:"suggestion-chip",onClick:()=>Nn(s.query,{caret:s.caret,addToHistory:s.addToHistory,focus:!1})},s.label)))),on.length>0&&React.createElement("div",{className:"search-suggestions-section"},React.createElement("div",{className:"search-suggestions-label"},"S\u1EA3n ph\u1EA9m hay t\xECm"),React.createElement("div",{className:"search-suggestions-row"},on.map(s=>{var R,w;const m=(((R=s.item)==null?void 0:R.name)||s.name||"").trim();if(!m)return null;const c=String(((w=s.item)==null?void 0:w.code)||s.code||"").trim(),x=c?`#${c}`:m;return React.createElement("button",{key:s.id,type:"button",className:"suggestion-chip suggestion-chip-popular",onClick:()=>{s.item&&at(s.item,"suggestion"),Nn(x,{caret:"end",focus:!1})},title:c?`#${c}`:m},m)}))),Vt.length>0&&React.createElement("div",{className:"search-suggestions-section"},React.createElement("div",{className:"search-suggestions-label"},"T\xECm g\u1EA7n \u0111\xE2y / hay d\xF9ng"),React.createElement("div",{className:"search-suggestions-row"},Vt.map(s=>React.createElement("button",{key:s.q,type:"button",className:"suggestion-chip suggestion-chip-query",onClick:()=>Nn(s.q,{caret:"end",focus:!1}),title:`${s.q} (${s.count})`},s.q))))),React.createElement("div",{className:"result-header"},React.createElement("span",null,React.createElement("strong",null,oe.length)," k\u1EBFt qu\u1EA3",vt&&B.length>=3&&React.createElement("span",{className:"ai-badge ms-2"},React.createElement("i",{className:"fas fa-robot"})," AI"),Je!=="all"&&React.createElement("span",{className:"ms-2 badge bg-warning text-dark"},Je==="product"?"S\u1EA3n ph\u1EA9m":Je==="album"?"\u1EA2nh":"Video")),React.createElement("div",{className:"d-flex gap-1 align-items-center"},React.createElement("button",{className:`btn btn-sm ${ie==="list"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>Le("list"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-list"})),React.createElement("button",{className:`btn btn-sm ${ie==="grid"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>Le("grid"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-th"})))),React.createElement("div",{className:"search-results-area"},X?React.createElement("div",null,[...Array(8)].map((s,m)=>React.createElement("div",{key:m,className:"product-card-mobile mb-2",style:{opacity:.7}},React.createElement("div",{className:"card-inner"},React.createElement("div",{className:"thumb bg-light",style:{width:80,height:80,borderRadius:8}}),React.createElement("div",{className:"info",style:{flex:1,minWidth:0}},React.createElement("div",{className:"skeleton-box mb-2",style:{height:16,width:"60%",background:"#eee",borderRadius:4}}),React.createElement("div",{className:"skeleton-box mb-1",style:{height:12,width:"40%",background:"#f3f3f3",borderRadius:4}}),React.createElement("div",{className:"skeleton-box",style:{height:10,width:"30%",background:"#f3f3f3",borderRadius:4}})))))):oe.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-search"}),React.createElement("p",null,'Kh\xF4ng t\xECm th\u1EA5y "',B,'"'),React.createElement("button",{className:"btn btn-warning",onClick:()=>{Ne(""),kt("")}},"Xem t\u1EA5t c\u1EA3")):ie==="grid"?React.createElement("div",{className:"product-grid-mobile"},oe.map((s,m)=>It(s,m))):React.createElement("div",null,oe.map((s,m)=>It(s,m)))),tn&&React.createElement("div",{className:"filter-dropdown"},React.createElement("div",{className:"filter-header"},React.createElement("strong",null,"L\u1ECDc theo lo\u1EA1i"),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>fn(!1)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"filter-chips"},React.createElement("span",{className:`filter-chip ${Je==="all"?"active":""}`,onClick:()=>{Nt("all"),fn(!1)}},"T\u1EA5t c\u1EA3"),React.createElement("span",{className:`filter-chip ${Je==="product"?"active":""}`,onClick:()=>{Nt("product"),fn(!1)}},React.createElement("i",{className:"fas fa-box me-1"}),"S\u1EA3n ph\u1EA9m"),React.createElement("span",{className:`filter-chip ${Je==="album"?"active":""}`,onClick:()=>{Nt("album"),fn(!1)}},React.createElement("i",{className:"fas fa-images me-1"}),"\u1EA2nh"),React.createElement("span",{className:`filter-chip ${Je==="video"?"active":""}`,onClick:()=>{Nt("video"),fn(!1)}},React.createElement("i",{className:"fas fa-video me-1"}),"Video")),React.createElement("div",{className:"mt-3 pt-3 border-top d-flex align-items-center justify-content-between"},React.createElement("span",null,"AI Search th\xF4ng minh"),React.createElement("div",{className:"form-check form-switch m-0"},React.createElement("input",{type:"checkbox",className:"form-check-input",checked:vt,onChange:s=>$t(s.target.checked),style:{width:40,height:20}})))),React.createElement("div",{className:"search-bar-bottom"},React.createElement("div",{className:"search-input-wrap"},React.createElement("input",{ref:Ke,type:"text",className:"search-input",placeholder:"\u{1F50D} T\xECm: van 3 tay, xylanh... (/ \u0111\u1EC3 focus, Ctrl+K palette)",value:B,onChange:s=>kt(s.target.value)}),React.createElement("button",{className:`filter-btn ${tn||Je!=="all"?"active":""}`,onClick:()=>fn(!tn)},React.createElement("i",{className:"fas fa-filter"})))),T&&React.createElement("div",{className:"search-palette-overlay",onClick:()=>z(!1)},React.createElement("div",{className:"search-palette",onClick:s=>s.stopPropagation()},React.createElement("div",{className:"palette-header"},React.createElement("input",{ref:q,type:"text",className:"palette-input",placeholder:"\u{1F50D} T\xECm ki\u1EBFm n\xE2ng cao... (filter: \u1EA3nh, video; t\u1EEB kh\xF3a...)",value:_e,onChange:s=>kt(s.target.value),onKeyDown:s=>{s.key==="Enter"&&oe.length>0?(Ze(_e),z(!1)):s.key==="Escape"&&z(!1)}}),React.createElement("button",{className:"palette-close",onClick:()=>z(!1)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"palette-body"},React.createElement("div",{className:"palette-section"},React.createElement("div",{className:"section-label"},"Lo\u1EA1i"),React.createElement("div",{className:"filter-chips-row"},["T\u1EA5t c\u1EA3","S\u1EA3n ph\u1EA9m","\u1EA2nh","Video"].map((s,m)=>React.createElement("span",{key:s,className:`filter-chip ${Je===["all","product","album","video"][m]?"active":""}`,onClick:()=>{Nt(["all","product","album","video"][m])}},s)))),ue.length>0&&!_e.trim()&&React.createElement("div",{className:"palette-section"},React.createElement("div",{className:"section-label"},React.createElement("i",{className:"fas fa-star me-1"}),"T\xECm ki\u1EBFm \u0111\xE3 l\u01B0u"),React.createElement("div",{className:"palette-items"},ue.map((s,m)=>React.createElement("div",{key:m,className:"palette-item",onClick:()=>{kt(s),Ze(s)}},React.createElement("i",{className:"fas fa-star"}),React.createElement("span",null,s),React.createElement("button",{className:"unsave-btn",onClick:c=>{c.stopPropagation(),Kt(s)}},React.createElement("i",{className:"fas fa-trash-alt"})))))),ye.length>0&&!_e.trim()&&React.createElement("div",{className:"palette-section"},React.createElement("div",{className:"section-label"},React.createElement("i",{className:"fas fa-clock me-1"}),"L\u1ECBch s\u1EED t\xECm ki\u1EBFm"),React.createElement("div",{className:"palette-items"},ye.map((s,m)=>React.createElement("div",{key:m,className:"palette-item",onClick:()=>{kt(s)}},React.createElement("i",{className:"fas fa-history"}),React.createElement("span",null,s),React.createElement("button",{className:"save-btn",onClick:c=>{c.stopPropagation(),Kt(s)}},React.createElement("i",{className:`fas fa-star${ue.includes(s)?"":"-o"}`})))))),_e.trim()&&oe.length>0&&React.createElement("div",{className:"palette-section"},React.createElement("div",{className:"section-label"},"K\u1EBFt qu\u1EA3 (",oe.length,")"),React.createElement("div",{className:"palette-items",style:{maxHeight:300,overflowY:"auto"}},oe.slice(0,8).map((s,m)=>React.createElement("div",{key:s.id||m,className:"palette-result-item",onClick:()=>{Ze(_e),z(!1)}},s.image&&React.createElement("img",{src:s.image,alt:s.name,className:"result-thumb"}),React.createElement("div",{className:"result-text"},React.createElement("div",{className:"result-name"},s.name),s.price&&React.createElement("div",{className:"result-meta"},s.price.replace(/[đ\s]/g,""),"\u0111")),React.createElement("button",{className:"save-btn",onClick:c=>{c.stopPropagation(),Kt(_e)}},React.createElement("i",{className:`fas fa-star${ue.includes(_e)?"":"-o"}`})))))),_e.trim()&&oe.length===0&&React.createElement("div",{className:"palette-empty"},React.createElement("i",{className:"fas fa-search"}),React.createElement("p",null,'Kh\xF4ng t\xECm th\u1EA5y k\u1EBFt qu\u1EA3 cho "',_e,'"'))),React.createElement("div",{className:"palette-footer"},React.createElement("span",null,React.createElement("kbd",null,"Esc")," \u0111\u1EC3 \u0111\xF3ng"),React.createElement("span",null,React.createElement("kbd",null,"Enter")," \u0111\u1EC3 l\u01B0u v\xE0o l\u1ECBch s\u1EED")))),React.createElement("button",{className:"btn btn-lg rounded-circle position-fixed shadow-lg",style:{bottom:l?320:130,right:16,width:56,height:56,zIndex:1050,transition:"bottom 0.2s ease",background:"linear-gradient(135deg, #667eea, #764ba2)",color:"#fff",border:"none",WebkitTapHighlightColor:"transparent",touchAction:"manipulation",cursor:"pointer",outline:"none"},onClick:()=>St(!0),onTouchStart:()=>St(!0)},React.createElement("i",{className:"fas fa-robot fa-lg"})),Ye&&React.createElement("div",{className:"ai-chat-mobile"},React.createElement("div",{className:"chat-header"},React.createElement("button",{className:"back-btn",onClick:()=>St(!1)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("strong",null,"KTM AI Assistant"),React.createElement("div",{style:{fontSize:11,opacity:.8}},"H\u1ECFi v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3..."))),React.createElement("div",{className:"chat-messages"},Et.map((s,m)=>React.createElement("div",{key:m,className:`mb-3 ${s.role==="user"?"d-flex justify-content-end":""}`},React.createElement("div",{className:`p-3 rounded-3 position-relative ${s.role==="user"?"text-white":"bg-white border"}`,style:{maxWidth:"85%",whiteSpace:"pre-wrap",background:s.role==="user"?"linear-gradient(135deg, #667eea, #764ba2)":void 0}},s.content,s.role==="assistant"&&React.createElement("button",{className:"btn btn-sm position-absolute",style:{top:4,right:4,padding:"2px 6px",fontSize:11,background:Fe===`chat-${m}`?"#28a745":"rgba(0,0,0,0.1)",border:"none",borderRadius:4,color:Fe===`chat-${m}`?"#fff":"#666"},onClick:()=>{window.KTM.clipboard.writeText(s.content),Ve(`chat-${m}`),setTimeout(()=>Ve(null),1500)}},React.createElement("i",{className:`fas ${Fe===`chat-${m}`?"fa-check":"fa-copy"}`})),s.attachments&&s.attachments.length>0&&React.createElement("div",{className:"mt-2 d-flex flex-wrap gap-2"},s.attachments.map((c,x)=>React.createElement("div",{key:x,style:{width:70},className:"text-center"},c.image&&React.createElement("img",{src:c.image,className:"rounded",style:{width:70,height:50,objectFit:"cover",cursor:"pointer"},onClick:()=>pn({url:c.image,name:c.name,price:c.price})}),React.createElement("div",{style:{fontSize:9},className:"text-truncate"},c.name),c.price&&React.createElement("div",{style:{fontSize:10,color:"#dc3545",fontWeight:600}},c.price.replace(/[đ\s]/g,""),"\u0111"))))))),Mt&&React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"bg-white border p-3 rounded-3 d-inline-block"},React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang suy ngh\u0129...")),React.createElement("div",{ref:Ft})),React.createElement("div",{className:"px-3 py-2 border-top d-flex gap-2 overflow-auto"},["Gi\xE1 van 2 tay?","Combo r\u1EBB nh\u1EA5t?","Freeship?","Van 3 tay?"].map(s=>React.createElement("button",{key:s,className:"btn btn-sm btn-outline-secondary flex-shrink-0",onClick:()=>Xe(s),disabled:Mt,style:{whiteSpace:"nowrap"}},s))),React.createElement("div",{className:"chat-input-area"},React.createElement("form",{onSubmit:s=>{s.preventDefault(),Xe(nt)},className:"chat-input-wrap"},React.createElement("input",{ref:yn,type:"text",className:"chat-input",placeholder:"Nh\u1EADp c\xE2u h\u1ECFi...",value:nt,onChange:s=>Jt(s.target.value),disabled:Mt}),React.createElement("button",{type:"submit",className:"send-btn",disabled:Mt||!nt.trim()},React.createElement("i",{className:"fas fa-paper-plane"}))))),it&&React.createElement("div",{className:"preview-modal",onClick:()=>pn(null)},React.createElement("div",{className:"preview-header"},React.createElement("div",null),React.createElement("button",{className:"close-btn",onClick:()=>pn(null)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"preview-body",onClick:s=>s.stopPropagation()},React.createElement("img",{src:it.url,alt:it.name})),React.createElement("div",{className:"preview-footer",onClick:s=>s.stopPropagation()},React.createElement("div",{className:"name"},it.name),it.price&&React.createElement("div",{className:"price"},it.price.replace(/[đ\s]/g,""),"\u0111"),it.note&&React.createElement("div",{className:"mb-2",style:{fontSize:14,color:"#17a2b8"}},it.note),React.createElement("div",{className:"action-btns"},React.createElement("button",{className:Fe==="preview-img"?"btn-success text-white":"btn-outline-light text-white",style:{background:Fe==="preview-img"?"#28a745":"rgba(255,255,255,0.2)"},onClick:()=>O(it.url,"preview")},React.createElement("i",{className:`fas ${Fe==="preview-img"?"fa-check":"fa-copy"}`}),"Copy \u1EA3nh"),it.price&&React.createElement("button",{className:Fe==="preview-price"?"btn-success text-white":"btn-warning",onClick:()=>Be(it.price.replace(/[đ\s]/g,""),"preview-price")},React.createElement("i",{className:`fas ${Fe==="preview-price"?"fa-check":"fa-tag"}`}),"Copy gi\xE1")))),React.createElement(ft,{show:h,product:L,categories:He,onClose:()=>{f(!1),K(null)},onSave:re}),React.createElement("div",{className:`fab-container mobile-only ${l?"open":""}`},React.createElement("div",{className:"fab-actions"},React.createElement("button",{className:"fab-action product",onClick:()=>{k(!1),f(!0),K(null)}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",{className:"tooltip"},"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("button",{className:"fab-action product",onClick:()=>{k(!1),F&&F("orders","create")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",{className:"tooltip"},"T\u1EA1o order nhanh"))),React.createElement("button",{className:`fab-main ${l?"open":""}`,onClick:()=>k(!l)},React.createElement("i",{className:"fas fa-plus"}))),In&&mt&&React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,maxHeight:"90vh"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none"}},React.createElement("h6",{className:"modal-title fw-bold"},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa nhanh"),React.createElement("button",{type:"button",className:"btn-close",onClick:()=>xn(!1)})),React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"T\xEAn s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:b.name,onChange:s=>A({...b,name:s.target.value})})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:b.code,onChange:s=>A({...b,code:s.target.value})})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:b.price,onChange:s=>A({...b,price:s.target.value})}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:b.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:s=>A({...b,commission_percent:s.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:b.category,onChange:s=>A({...b,category:s.target.value})},React.createElement("option",{value:""},"-- Ch\u1ECDn danh m\u1EE5c --"),D.map(s=>React.createElement("option",{key:s,value:s},s)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Ghi ch\xFA (\u01B0u \u0111\xE3i)"),React.createElement("input",{type:"text",className:"form-control",value:b.note,placeholder:"VD: Free ship, Gi\u1EA3m 10%...",onChange:s=>A({...b,note:s.target.value})}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>xn(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-warning",onClick:se},React.createElement("i",{className:"fas fa-save me-1"}),"L\u01B0u"))))))}function VideoList({onRefresh:P,showToast:F}){const[B,Ne]=useState([]),[oe,J]=useState([]),[V,Ee]=useState(!0),[He,ke]=useState(null),[Je,rt]=useState(!1),[Fe,Ve]=useState(null),[ie,Le]=useState(!1),[X,pt]=useState(null),[bt,_t]=useState(!1),[Ge,st]=useState(null),[Ke,vt]=useState(!1),[$t,rn]=useState(!1),[tt,jt]=useState(null),[Ht,_]=useState(!1),[T,z]=useState(null),[ye,we]=useState([]);useEffect(()=>{ue()},[]);const ue=async(E=null)=>{Ee(!0);try{const ce=E?`${API_BASE}/api/video-folders?withVideos=true&parent_id=${E}`:`${API_BASE}/api/video-folders?withVideos=true&parent_id=root`,Ze=await window.KTM.api.getJSON(ce,"L\u1ED7i t\u1EA3i danh s\xE1ch folder");Ne(Array.isArray(Ze)?Ze:[])}catch(ce){console.error(ce),F("L\u1ED7i t\u1EA3i danh s\xE1ch folder","danger")}Ee(!1)},he=async E=>{try{const ce=await window.KTM.api.getJSON(`${API_BASE}/api/videos?folderId=${E}`,"L\u1ED7i t\u1EA3i video");J(Array.isArray(ce)?ce:[])}catch(ce){console.error(ce)}},_e=async E=>{if(E===0)return;const ce=[...B];[ce[E-1],ce[E]]=[ce[E],ce[E-1]],Ne(ce),await q(ce)},S=async E=>{if(E===B.length-1)return;const ce=[...B];[ce[E],ce[E+1]]=[ce[E+1],ce[E]],Ne(ce),await q(ce)},q=async E=>{try{await Promise.all(E.map((ce,Ze)=>window.KTM.api.putJSON(`${API_BASE}/api/video-folders/${ce.id}`,{sortOrder:Ze},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),F("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(ce){F("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),ue(T==null?void 0:T.id)}},Y=async E=>{if(E===0)return;const ce=[...oe];[ce[E-1],ce[E]]=[ce[E],ce[E-1]],J(ce),await xe(ce)},de=async E=>{if(E===oe.length-1)return;const ce=[...oe];[ce[E],ce[E+1]]=[ce[E+1],ce[E]],J(ce),await xe(ce)},xe=async E=>{try{await Promise.all(E.map((ce,Ze)=>window.KTM.api.putJSON(`${API_BASE}/api/videos/${ce.id}`,{sort_order:Ze},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),F("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(ce){F("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),he(He.id)}},$e=()=>{Ve(null),rt(!0)},Qe=E=>{jt(E),rn(!0),_(!0)},Ye=async(E,ce="modal")=>{try{!Fe&&T&&(E.parent_id=T.id);const Ze=Fe?`${API_BASE}/api/video-folders/${Fe.id}`:`${API_BASE}/api/video-folders`;Fe?await window.KTM.api.putJSON(Ze,E,"L\u1ED7i l\u01B0u folder"):await window.KTM.api.postJSON(Ze,E,"L\u1ED7i l\u01B0u folder"),F(Fe?"\u0110\xE3 c\u1EADp nh\u1EADt folder!":"\u0110\xE3 t\u1EA1o folder m\u1EDBi!","success"),ce==="drawer"?(_(!1),Ve(null),ue(T==null?void 0:T.id),Fe&&tt&&jt({...tt,...E})):(rt(!1),Ve(null),ue(T==null?void 0:T.id))}catch(Ze){F(Ze.message,"danger")}},St=async E=>{const ce=E.subfolderCount>0?`X\xF3a folder "${E.name}"? T\u1EA5t c\u1EA3 subfolder v\xE0 videos b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`:`X\xF3a folder "${E.name}"? Videos trong folder s\u1EBD kh\xF4ng b\u1ECB x\xF3a.`;if(confirm(ce))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/video-folders/${E.id}`,"L\u1ED7i x\xF3a folder"),F("\u0110\xE3 x\xF3a folder","success"),ke(null),ue(T==null?void 0:T.id)}catch(Ze){F("L\u1ED7i x\xF3a folder","danger")}},Et=E=>{E.subfolderCount>0?(we(ce=>[...ce,E]),z(E),ue(E.id)):(ke(E),J(E.videos||[]))},Se=E=>{if(E==="root")we([]),z(null),ue(null);else if(E){const ce=ye.findIndex(Ze=>Ze.id===E.id);ce>=0&&(we(ye.slice(0,ce+1)),z(E),ue(E.id))}else{const ce=[...ye];ce.pop();const Ze=ce[ce.length-1]||null;we(ce),z(Ze),ue(Ze==null?void 0:Ze.id)}},nt=()=>{rn(!1),_(!1),jt(null)},Jt=()=>{_t(!1),vt(!1),st(null)},Mt=()=>{pt(null),Le(!0)},dn=E=>{st(E),_t(!0),vt(!0)},Ft=async(E,ce="modal")=>{try{E.folder_id=He==null?void 0:He.id;const Ze=X?`${API_BASE}/api/videos/${X.id}`:`${API_BASE}/api/videos`;X?await window.KTM.api.putJSON(Ze,E,"L\u1ED7i l\u01B0u video"):await window.KTM.api.postJSON(Ze,E,"L\u1ED7i l\u01B0u video"),F(X?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm video th\xE0nh c\xF4ng!","success"),ce==="drawer"?(vt(!1),pt(null),ue(),He&&he(He.id),X&&Ge&&st({...Ge,...E})):(Le(!1),pt(null),ue(),He&&he(He.id))}catch(Ze){F(Ze.message,"danger")}},yn=async E=>{if(confirm(`X\xF3a video "${E.title}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/videos/${E.id}`,"L\u1ED7i x\xF3a video"),F("\u0110\xE3 x\xF3a video","success"),ue(),He&&he(He.id)}catch(ce){F("L\u1ED7i x\xF3a video","danger")}},vn=E=>{const ce=`https://www.youtube.com/watch?v=${E.youtubeId}`;window.KTM.clipboard.writeText(ce).then(()=>{F("\u0110\xE3 copy link!","success")}).catch(()=>{F("Kh\xF4ng th\u1EC3 copy link","danger")})};return He?React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>ke(null)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:`fas fa-folder-open me-2 ${He.slug==="shorts"?"text-danger":"text-warning"}`}),He.name)),React.createElement("button",{className:"btn btn-warning",onClick:Mt},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm Video")),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1 videos"),oe.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-video fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},"Ch\u01B0a c\xF3 video trong folder n\xE0y")):React.createElement("div",{className:"row g-4"},oe.map((E,ce)=>React.createElement("div",{key:E.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>Y(ce),disabled:ce===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},ce+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>de(ce),disabled:ce===oe.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"position-relative"},React.createElement("img",{src:E.thumb,className:"card-img-top",alt:E.title,style:{height:"120px",objectFit:"cover"}}),React.createElement("a",{href:`https://www.youtube.com/watch?v=${E.youtubeId}`,target:"_blank",className:"position-absolute top-50 start-50 translate-middle"},React.createElement("i",{className:"fas fa-play-circle fa-3x text-white",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"}}))),React.createElement("div",{className:"card-body py-2"},React.createElement("h6",{className:"card-title small mb-1 text-truncate",title:E.title},E.title),React.createElement("small",{className:"text-muted"},E.youtubeId)),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-primary",onClick:()=>vn(E),title:"Copy link"},React.createElement("i",{className:"fas fa-link"})),React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>dn(E),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-outline-danger",onClick:()=>yn(E),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))))),React.createElement(VideoModal,{show:ie,video:X,onClose:()=>Le(!1),onSave:Ft}),React.createElement(AdminDrawer,{open:$t,title:tt?tt.name:"Folder",subtitle:tt?`${tt.subfolderCount||0} subfolder \u2022 ${tt.videoCount||0} videos`:"",onClose:nt,footer:Ht?React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:nt},React.createElement("i",{className:"fas fa-xmark me-2"}),"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-warning fw-semibold",onClick:()=>{tt&&Ye({name:tt.name||"",description:tt.description||"",sortOrder:tt.sortOrder||0},"drawer")}},React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u")):tt?React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{window.KTM.clipboard.writeText(tt.name),F("\u0110\xE3 copy t\xEAn folder","success")}},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy"),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>{_(!0)}},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>{confirm(`X\xF3a folder "${tt.name}"?`)&&(St(tt),nt())}},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a"))):null},Ht&&tt?React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-pen me-2 text-warning"}),"Ch\u1EC9nh s\u1EEDa"),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:tt.name||"",onChange:E=>jt({...tt,name:E.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:tt.description||"",onChange:E=>jt({...tt,description:E.target.value})}))):tt?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"Th\xF4ng tin"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"T\xEAn"),React.createElement("div",{className:"v"},tt.name),React.createElement("div",{className:"k"},"Slug"),React.createElement("div",{className:"v font-monospace"},tt.id),React.createElement("div",{className:"k"},"Subfolder"),React.createElement("div",{className:"v"},tt.subfolderCount||0),React.createElement("div",{className:"k"},"Video"),React.createElement("div",{className:"v"},tt.videoCount||0))),tt.description&&React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-note-sticky me-2 text-secondary"}),"M\xF4 t\u1EA3"),React.createElement("p",null,tt.description))):React.createElement("div",{className:"text-muted"},"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u")),React.createElement(AdminDrawer,{open:bt,title:Ge?Ge.title:"Video",subtitle:Ge?`${Ge.youtubeId}`:"",onClose:Jt,footer:Ke?React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:Jt},React.createElement("i",{className:"fas fa-xmark me-2"}),"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-warning fw-semibold",onClick:()=>{Ge&&Ft({youtube_url:`https://www.youtube.com/watch?v=${Ge.youtubeId}`,title:Ge.title||"",thumbnail_url:Ge.thumb||"",sort_order:Ge.sortOrder||0},"drawer")}},React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u")):Ge?React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{const E=`https://www.youtube.com/watch?v=${Ge.youtubeId}`;window.KTM.clipboard.writeText(E).then(()=>{F("\u0110\xE3 copy link!","success")})}},React.createElement("i",{className:"fas fa-link me-2"}),"Copy"),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>{vt(!0)}},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>{confirm(`X\xF3a video "${Ge.title}"?`)&&(yn(Ge),Jt())}},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a"))):null},Ke&&Ge?React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-pen me-2 text-warning"}),"Ch\u1EC9nh s\u1EEDa"),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ti\xEAu \u0111\u1EC1 *"),React.createElement("input",{type:"text",className:"form-control",value:Ge.title||"",onChange:E=>st({...Ge,title:E.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"YouTube ID"),React.createElement("input",{type:"text",className:"form-control",value:Ge.youtubeId||"",onChange:E=>st({...Ge,youtubeId:E.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:Ge.sortOrder||0,onChange:E=>st({...Ge,sortOrder:parseInt(E.target.value)||0})}))):Ge?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"Th\xF4ng tin"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"Ti\xEAu \u0111\u1EC1"),React.createElement("div",{className:"v"},Ge.title),React.createElement("div",{className:"k"},"YouTube ID"),React.createElement("div",{className:"v font-monospace"},Ge.youtubeId),React.createElement("div",{className:"k"},"Th\u1EE9 t\u1EF1"),React.createElement("div",{className:"v"},Ge.sortOrder||0))),Ge.thumb&&React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-image me-2 text-info"}),"Thumbnail"),React.createElement("img",{src:Ge.thumb,alt:Ge.title,className:"rounded w-100",style:{maxHeight:200,objectFit:"cover"}}))):React.createElement("div",{className:"text-muted"},"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u"))):React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},T&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>Se()},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-video me-2 text-warning"}),T?T.name:"Qu\u1EA3n l\xFD Video")),React.createElement("button",{className:"btn btn-warning",onClick:$e},React.createElement("i",{className:"fas fa-folder-plus me-2"}),"T\u1EA1o Folder")),ye.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:E=>{E.preventDefault(),Se("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),ye.map((E,ce)=>React.createElement("li",{key:E.id,className:`breadcrumb-item ${ce===ye.length-1?"active":""}`},ce===ye.length-1?E.name:React.createElement("a",{href:"#",onClick:Ze=>{Ze.preventDefault(),Se(E)},className:"text-warning"},E.name))))),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1. Click v\xE0o folder \u0111\u1EC3 v\xE0o b\xEAn trong."),V?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):B.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},T?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder video n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:$e},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o folder",T?" con":" \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"row g-3"},B.map((E,ce)=>{var Ze,Kt,mn,Xt;return React.createElement("div",{key:E.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-card"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Ut=>{Ut.stopPropagation(),_e(ce)},disabled:ce===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},ce+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Ut=>{Ut.stopPropagation(),S(ce)},disabled:ce===B.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"card-body text-center py-3",onClick:()=>Et(E),style:{cursor:"pointer"}},React.createElement("i",{className:`fas fa-folder fa-3x mb-3 ${E.slug==="shorts"?"text-danger":"text-warning"}`}),React.createElement("h5",{className:"card-title"},E.name),React.createElement("p",{className:"text-muted mb-0"},E.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),E.subfolderCount," folder"),E.subfolderCount>0&&(E.videoCount>0||((Ze=E.videos)==null?void 0:Ze.length)>0)&&" \u2022 ",(E.videoCount>0||((Kt=E.videos)==null?void 0:Kt.length)>0)&&React.createElement("span",null,React.createElement("i",{className:"fas fa-video me-1"}),E.videoCount||((mn=E.videos)==null?void 0:mn.length)||0," videos"),E.subfolderCount===0&&!E.videoCount&&!((Xt=E.videos)!=null&&Xt.length)&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:Ut=>{Ut.stopPropagation(),Qe(E)}},React.createElement("i",{className:"fas fa-edit"})," S\u1EEDa"),React.createElement("button",{className:"btn btn-outline-danger",onClick:Ut=>{Ut.stopPropagation(),St(E)}},React.createElement("i",{className:"fas fa-trash"})," X\xF3a")))))})),React.createElement(VideoFolderModal,{show:Je,folder:Fe,onClose:()=>rt(!1),onSave:Ye}))}function VideoFolderModal({show:P,folder:F,onClose:B,onSave:Ne}){const[oe,J]=useState({name:"",description:"",sortOrder:0,coverImage:""}),[V,Ee]=useState(!1),[He,ke]=useState(!1);useEffect(()=>{J(F?{name:F.name||"",description:F.description||"",sortOrder:F.sortOrder||0,coverImage:F.coverImage||""}:{name:"",description:"",sortOrder:0,coverImage:""})},[F,P]);const Je=async Fe=>{const Ve=Fe.target.files[0];if(Ve){ke(!0);try{const ie=await window.KTM.cloudinary.uploadImage({file:Ve,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});ie.secure_url&&J(Le=>({...Le,coverImage:ie.secure_url})),window.KTM.cache.remove(CACHE_KEY),showToast("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),setShowQuickEdit(!1),setEditingItem(null),loadAllData()}catch(ie){console.error("Cloudinary upload error:",ie),alert("L\u1ED7i upload \u1EA3nh: "+(ie.message||ie))}finally{ke(!1)}}},rt=async Fe=>{Fe.preventDefault(),Ee(!0);const Ve={...oe,variants:normalizeVariants(oe.variants,oe.price),attributes:normalizeAttributes(oe.attributes)};await Ne(Ve),Ee(!1)};return P?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},F?"S\u1EEDa Folder":"T\u1EA1o Folder m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:B})),React.createElement("form",{onSubmit:rt},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn folder *"),React.createElement("input",{type:"text",className:"form-control",value:oe.name,onChange:Fe=>J({...oe,name:Fe.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",value:oe.description,onChange:Fe=>J({...oe,description:Fe.target.value}),rows:"2"})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:oe.sortOrder,onChange:Fe=>J({...oe,sortOrder:parseInt(Fe.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex align-items-start gap-3"},oe.coverImage?React.createElement("div",{className:"position-relative"},React.createElement("img",{src:oe.coverImage,alt:"Cover",className:"rounded",style:{width:120,height:80,objectFit:"cover"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute top-0 end-0",onClick:()=>J({...oe,coverImage:""}),style:{transform:"translate(30%, -30%)"}},React.createElement("i",{className:"fas fa-times"}))):React.createElement("div",{className:"bg-light rounded d-flex align-items-center justify-content-center text-muted",style:{width:120,height:80}},React.createElement("i",{className:"fas fa-image fa-2x"})),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{type:"file",className:"form-control form-control-sm",accept:"image/*,image/jpeg,image/png,image/gif,image/webp",onChange:Je,disabled:He}),He&&React.createElement("div",{className:"mt-1 text-muted small"},React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang upload..."),React.createElement("div",{className:"mt-1 text-muted small"},"Ho\u1EB7c d\xE1n URL:"),React.createElement("input",{type:"url",className:"form-control form-control-sm",placeholder:"https://...",value:oe.coverImage,onChange:Fe=>J({...oe,coverImage:Fe.target.value})}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:B},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:V},V?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function ProductManager({showToast:P,settings:F}){const[B,Ne]=useState([]),[oe,J]=useState(!0),[V,Ee]=useState(!1),[He,ke]=useState(null),[Je,rt]=useState(""),[Fe,Ve]=useState(""),[ie,Le]=useState(!1),[X,pt]=useState(null),bt=normalizeShipPercent(F==null?void 0:F.ship_percent),{parseMoney:_t,formatVND:Ge}=window.KTM.money,st=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"];useEffect(()=>{Ke()},[]);const Ke=async()=>{J(!0);try{const S=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");Ne(Array.isArray(S)?S:[])}catch(S){console.error(S),P("L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m","danger")}J(!1)},vt=()=>{ke(null),Ee(!0)},$t=S=>{ke(S),Ee(!0)},rn=S=>{S&&(pt(S),Le(!0))},tt=()=>{Le(!1)},jt=async S=>{if(!(!S||!S.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:S},"L\u1ED7i x\xF3a \u1EA3nh"),window.KTM.cache.remove(CACHE_KEY),P(`\u0110\xE3 x\xF3a ${typeName}`,"success"),loadAllData(),Ke()}catch(q){P("L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m","danger")}},Ht=async S=>{try{const q=He?`${API_BASE}/api/products?id=${He.id}`:`${API_BASE}/api/products`;He?await window.KTM.api.putJSON(q,S,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(q,S,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),P(He?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Ee(!1),Ke()}catch(q){P(q.message,"danger")}},_=async S=>{if(confirm(`B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n x\xF3a s\u1EA3n ph\u1EA9m "${S.name}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/products?id=${S.id}`,"L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m"),P("X\xF3a s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Ke()}catch(q){P(q.message,"danger")}},T=B.filter(S=>{const q=!Je||S.name.toLowerCase().includes(Je.toLowerCase())||S.code&&S.code.toLowerCase().includes(Je.toLowerCase()),Y=!Fe||S.category===Fe;return q&&Y}),z=S=>{var de;const q=(de=S==null?void 0:S.commission_percent)!=null?de:S==null?void 0:S.commissionPercent,Y=q===""||q==null?NaN:Number(q);return Number.isFinite(Y)?Math.max(0,Math.min(100,Y)):5},ye=S=>{const q=z(S),Y=Number.isInteger(q)?String(q):String(Math.round(q*100)/100),de=_t(S==null?void 0:S.price);if(!Number.isFinite(de)||de<=0)return`${Y}%`;const xe=(Number(q)||0)/100,Qe=window.KTM.money.parseShipFeeFromNote(S==null?void 0:S.note)!=null?0:bt>0?de*bt/100:0,Ye=de*xe-Qe*xe,St=Math.max(0,Math.round(Ye));return`${Y}% - ${Ge(St)}`},we=S=>{if(S==null||S==="")return[];let q=S;if(typeof q=="string"){const Y=q.trim();if(!Y)return[];try{q=JSON.parse(Y)}catch(de){return[]}}return Array.isArray(q)?q:[]},ue=S=>{if(S==null||S==="")return[];let q=S;if(typeof q=="string"){const Y=q.trim();if(!Y)return[];try{q=JSON.parse(Y)}catch(de){return[]}}return q&&typeof q=="object"&&!Array.isArray(q)&&(q=Object.entries(q).map(([Y,de])=>({key:Y,value:de}))),Array.isArray(q)?q:[]},he=S=>{const q=ue(S).map(Y=>{var de,xe,$e,Qe,Ye;return{key:String(($e=(xe=(de=Y==null?void 0:Y.key)!=null?de:Y==null?void 0:Y.name)!=null?xe:Y==null?void 0:Y.label)!=null?$e:"").trim(),value:String((Qe=Y==null?void 0:Y.value)!=null?Qe:"").trim(),unit:String((Ye=Y==null?void 0:Y.unit)!=null?Ye:"").trim()}}).filter(Y=>!!Y.key);return q.length?React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},q.map((Y,de)=>{const xe=Y.key,$e=`${Y.value||""}${Y.unit?(Y.value?" ":"")+Y.unit:""}`.trim();return React.createElement("div",{key:`${xe}-${de}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},xe),$e?React.createElement("span",{className:"ktm-chip ktm-chip-option"},$e):null)}))):null},_e=(S,q={})=>{const Y=we(S).map(Qe=>{var Ye;return{name:String((Ye=Qe==null?void 0:Qe.name)!=null?Ye:"").trim(),options:Array.isArray(Qe==null?void 0:Qe.options)?Qe.options:[]}}).map(Qe=>({...Qe,options:Qe.options.map(Ye=>{var St;return{label:String((St=Ye==null?void 0:Ye.label)!=null?St:"").trim(),price:Number(Ye==null?void 0:Ye.price)}}).filter(Ye=>!!Ye.label)})).filter(Qe=>Qe.options.length>0);if(!Y.length)return null;const de=Number.isFinite(q.maxGroups)?Math.max(1,Math.trunc(q.maxGroups)):Y.length,xe=Number.isFinite(q.maxOptionsPerGroup)?Math.max(1,Math.trunc(q.maxOptionsPerGroup)):4,$e=Y.slice(0,de);return React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},$e.map((Qe,Ye)=>{const St=Qe.name||"Bi\u1EBFn th\u1EC3",Et=Qe.options.slice(0,xe),Se=Qe.options.length-Et.length;return React.createElement("div",{key:`${St}-${Ye}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},St),Et.map((nt,Jt)=>{const Mt=nt.price,dn=Number.isFinite(Mt)&&Mt>=0?Ge(Math.trunc(Mt)):"",Ft=dn?`${nt.label} \xB7 ${dn}`:nt.label;return React.createElement("span",{key:`${St}-${Ye}-${Jt}`,className:"ktm-chip ktm-chip-option"},Ft)}),Se>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",Se))})))};return React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",null,React.createElement("i",{className:"fas fa-box me-2"}),"S\u1EA3n ph\u1EA9m"),React.createElement("button",{className:"btn-add-product",onClick:vt},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"d-flex gap-2 mb-2"},React.createElement("div",{className:"flex-grow-1 position-relative"},React.createElement("input",{type:"text",className:"form-control",placeholder:"\u{1F50D} T\xECm s\u1EA3n ph\u1EA9m...",value:Je,onChange:S=>rt(S.target.value)})),React.createElement("span",{className:"product-count"},T.length)),React.createElement("select",{className:"form-select",value:Fe,onChange:S=>Ve(S.target.value)},React.createElement("option",{value:""},"\u{1F4C1} T\u1EA5t c\u1EA3 danh m\u1EE5c"),st.map(S=>React.createElement("option",{key:S,value:S},S)))),oe?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"2.5rem",height:"2.5rem"}}),React.createElement("p",{className:"text-muted mt-3 mb-0"},"\u0110ang t\u1EA3i...")):T.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-box-open"}),React.createElement("p",null,"Ch\u01B0a c\xF3 s\u1EA3n ph\u1EA9m n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:vt},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"product-list"},T.map(S=>React.createElement("div",{key:S.id,className:"product-item d-flex align-items-center gap-3",role:"button",tabIndex:0,onClick:()=>rn(S),onKeyDown:q=>{(q.key==="Enter"||q.key===" ")&&(q.preventDefault(),rn(S))},title:"Xem chi ti\u1EBFt"},S.image?React.createElement("img",{src:S.image,alt:"",className:"product-img"}):React.createElement("div",{className:"product-img-placeholder"},React.createElement("i",{className:"fas fa-image text-muted"})),React.createElement("div",{className:"flex-grow-1 min-width-0"},React.createElement("div",{className:"product-name"},S.name),React.createElement("div",{className:"d-flex flex-wrap gap-1 mb-1"},S.category&&React.createElement("span",{className:"product-badge bg-info bg-opacity-75"},S.category),S.code&&React.createElement("span",{className:"product-badge bg-secondary"},S.code),React.createElement("span",{className:"product-badge bg-warning text-dark",title:"Hoa h\u1ED3ng (%)"},React.createElement("i",{className:"fas fa-percent me-1"}),ye(S))),React.createElement("div",{className:"product-price"},S.price?S.price.replace(/[đ\s]/g,"")+"\u0111":"Li\xEAn h\u1EC7"),S.note&&React.createElement("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"}},S.note),he(S.attributes)&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},he(S.attributes)),_e(S.variants,{maxOptionsPerGroup:4})&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},_e(S.variants,{maxOptionsPerGroup:4}))),React.createElement("div",{className:"product-actions"},React.createElement("button",{className:"btn btn-edit",onClick:q=>{q.stopPropagation(),$t(S)},title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"btn btn-delete",onClick:q=>{q.stopPropagation(),_(S)},title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement(AdminDrawer,{open:ie,title:String((X==null?void 0:X.name)||"S\u1EA3n ph\u1EA9m"),subtitle:[String((X==null?void 0:X.code)||"").trim()||null,String((X==null?void 0:X.category)||"").trim()||null].filter(Boolean).join(" \u2022 "),onClose:tt,footer:React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{const S=String((X==null?void 0:X.code)||"").trim();S&&window.KTM.clipboard.writeText(S).then(()=>P("\u0110\xE3 copy m\xE3 s\u1EA3n ph\u1EA9m","success"))},disabled:!String((X==null?void 0:X.code)||"").trim(),title:"Copy m\xE3"},React.createElement("i",{className:"fas fa-barcode me-2"}),"Copy m\xE3"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{const S=String((X==null?void 0:X.price)||"").trim();S&&window.KTM.clipboard.writeText(S).then(()=>P("\u0110\xE3 copy gi\xE1","success"))},disabled:!String((X==null?void 0:X.price)||"").trim(),title:"Copy gi\xE1"},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy gi\xE1")),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>X&&$t(X),disabled:!X},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>X&&_(X),disabled:!X},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a")))},X?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"T\u1ED5ng quan"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"Gi\xE1"),React.createElement("div",{className:"v"},(()=>{const S=String((X==null?void 0:X.price)||"").trim(),q=_t(S);return Number.isFinite(q)&&q>0?Ge(Math.trunc(q)):S||"Li\xEAn h\u1EC7"})()),React.createElement("div",{className:"k"},"Hoa h\u1ED3ng"),React.createElement("div",{className:"v"},ye(X)),React.createElement("div",{className:"k"},"Danh m\u1EE5c"),React.createElement("div",{className:"v"},X.category||"\u2014"),React.createElement("div",{className:"k"},"M\xE3"),React.createElement("div",{className:"v"},React.createElement("span",{className:"font-monospace"},X.code||"\u2014")))),React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-image me-2 text-info"}),"H\xECnh \u1EA3nh"),X.image?React.createElement("img",{src:X.image,alt:"",className:"rounded",style:{width:"100%",maxHeight:260,objectFit:"cover"}}):React.createElement("div",{className:"text-muted"},"Ch\u01B0a c\xF3 \u1EA3nh")),(String(X.note||"").trim()||X.attributes||X.variants)&&React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-sliders-h me-2 text-primary"}),"Chi ti\u1EBFt"),String(X.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",String(X.note||"").trim()),he(X.attributes)?React.createElement("div",{className:"mt-2"},he(X.attributes)):null,_e(X.variants,{maxGroups:99,maxOptionsPerGroup:8})?React.createElement("div",{className:"mt-2"},_e(X.variants,{maxGroups:99,maxOptionsPerGroup:8})):null)):React.createElement("div",{className:"text-muted"},"Ch\u01B0a c\xF3 d\u1EEF li\u1EC7u")),React.createElement(ProductModal,{show:V,product:He,categories:st,onClose:()=>Ee(!1),onSave:Ht}))}function ProductModal({show:P,product:F,categories:B,onClose:Ne,onSave:oe}){const[J,V]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[Ee,He]=useState(!1),[ke,Je]=useState(!1),rt=_=>{const T=window.KTM.money.getDigits(String(_!=null?_:"")),z=Number(T);return T&&Number.isFinite(z)?Math.trunc(z):0},Fe=_=>{if(_==null||_==="")return[];let T=_;if(typeof T=="string"){const z=T.trim();if(!z)return[];try{T=JSON.parse(z)}catch(ye){return[]}}return T&&typeof T=="object"&&!Array.isArray(T)&&(T=Object.entries(T).map(([z,ye])=>({key:z,value:ye}))),Array.isArray(T)?T.map(z=>{var he,_e,S,q,Y;if(!z||typeof z!="object")return null;const ye=String((S=(_e=(he=z.key)!=null?he:z.name)!=null?_e:z.label)!=null?S:"").trim(),we=String((q=z.value)!=null?q:"").trim(),ue=String((Y=z.unit)!=null?Y:"").trim();return ye?{key:ye,value:we,unit:ue}:null}).filter(Boolean):[]},Ve=(_,T)=>{if(_==null||_==="")return[];let z=_;if(typeof z=="string"){const we=z.trim();if(!we)return[];try{z=JSON.parse(we)}catch(ue){return[]}}if(!Array.isArray(z))return[];const ye=rt(T);return z.map(we=>{var _e;if(!we||typeof we!="object")return null;const ue=String((_e=we.name)!=null?_e:"").trim(),he=(Array.isArray(we.options)?we.options:[]).map(S=>{var Qe,Ye,St,Et,Se,nt,Jt;if(!S||typeof S!="object")return null;const q=String((Qe=S.label)!=null?Qe:"").trim();if(!q)return null;const Y=(Se=(Et=(St=(Ye=S.price)!=null?Ye:S.priceValue)!=null?St:S.unit_price)!=null?Et:S.unitPrice)!=null?Se:null,de=Number(Y);let xe=Number.isFinite(de)?Math.trunc(de):null;if(xe==null){const Mt=(Jt=(nt=S.price_delta)!=null?nt:S.priceDelta)!=null?Jt:null,dn=Number(Mt);Number.isFinite(dn)&&(xe=ye+Math.trunc(dn))}xe==null&&(xe=ye);const $e=String(Math.max(0,Math.trunc(Number(xe)||0)));return{label:q,price:Math.max(0,Math.trunc(Number(xe)||0)),priceDigits:$e}}).filter(Boolean);return{name:ue||"Bi\u1EBFn th\u1EC3",options:he}}).filter(Boolean)};useEffect(()=>{var _,T;V(F?{name:F.name||"",code:F.code||"",price:F.price||"",image:F.image||"",category:F.category||"",note:F.note||"",sort_order:F.sort_order||0,commission_percent:(T=(_=F.commission_percent)!=null?_:F.commissionPercent)!=null?T:5,variants:Ve(F.variants,F.price),attributes:Fe(F.attributes)}:{name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]})},[F,P]);const ie=_=>{V(T=>{var he;const z=rt(T.price),ye=String(z),we=Array.isArray(T.variants)?[...T.variants]:[],ue={...we[_]||{},options:Array.isArray((he=we[_])==null?void 0:he.options)?[...we[_].options]:[]};return ue.options=ue.options.map(_e=>({label:String((_e==null?void 0:_e.label)||""),price:z,priceDigits:ye})),we[_]=ue,{...T,variants:we}})},Le=()=>{V(_=>{const T=rt(_.price),z=String(T),we=(Array.isArray(_.variants)?[..._.variants]:[]).map(ue=>{const he=(Array.isArray(ue==null?void 0:ue.options)?ue.options:[]).map(_e=>({label:String((_e==null?void 0:_e.label)||""),price:T,priceDigits:z}));return{name:String((ue==null?void 0:ue.name)||"Bi\u1EBFn th\u1EC3"),options:he}});return{..._,variants:we}})},[X,pt]=React.useState(""),bt=_=>window.KTM.money.formatVNDInputDigits(_),[_t,Ge]=React.useState(""),st=_=>{const T=window.KTM.money.nextPriceInputState(_.target.value,_t);Ge(T.digits),V({...J,price:T.price})},[Ke,vt]=React.useState("");React.useEffect(()=>{F!=null&&F.image&&vt(F.image)},[F]);const $t=async _=>{if(!(!_||!_.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:_},"L\u1ED7i x\xF3a \u1EA3nh")}catch(T){console.error("Delete cloudinary image error:",T)}},rn=async(_,T=2,z)=>{const ye=T*1024*1024,we=_.type==="image/heic"||_.type==="image/heif"||/\.heic$/i.test(_.name);if(_.size<=ye&&!we)return _;z==null||z("\u0110ang x\u1EED l\xFD \u1EA3nh...");try{const ue=await createImageBitmap(_);z==null||z("\u0110ang n\xE9n \u1EA3nh...");const he=document.createElement("canvas");let _e=ue.width,S=ue.height;const q=1200;return(_e>q||S>q)&&(_e>S?(S=Math.round(S/_e*q),_e=q):(_e=Math.round(_e/S*q),S=q)),he.width=_e,he.height=S,he.getContext("2d").drawImage(ue,0,0,_e,S),ue.close(),new Promise((de,xe)=>{he.toBlob($e=>{$e?(z==null||z("Ho\xE0n t\u1EA5t!"),de(new File([$e],_.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"}))):xe(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(ue){throw console.error("createImageBitmap error:",ue),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},tt=async _=>{var ye,we;const T=(ye=_.target.files)==null?void 0:ye[0];if(!T)return;if(!(T.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(T.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}Je(!0),pt("\u0110ang chu\u1EA9n b\u1ECB...");try{const ue=(T.size/1024/1024).toFixed(1);pt(`File ${ue}MB - \u0110ang n\xE9n...`);const he=await rn(T,2,q=>{pt(q)}),_e=(he.size/1024/1024).toFixed(1);pt(`\u0110\xE3 n\xE9n: ${_e}MB - \u0110ang upload...`);const S=await window.KTM.cloudinary.uploadImage({file:he,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});S.secure_url?(J.image&&J.image!==Ke&&$t(J.image),V(q=>({...q,image:S.secure_url})),pt("")):(console.error("Cloudinary error:",S),alert("Upload th\u1EA5t b\u1EA1i: "+(((we=S.error)==null?void 0:we.message)||"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh")),pt(""))}catch(ue){console.error("Upload error:",ue),alert("L\u1ED7i: "+ue.message),pt("")}Je(!1),_.target.value=""},jt=()=>{J.image&&(J.image!==Ke&&$t(J.image),V(_=>({..._,image:""})))},Ht=async _=>{_.preventDefault(),He(!0),Ke&&J.image&&Ke!==J.image&&await $t(Ke),Ke&&!J.image&&await $t(Ke),await oe(J),He(!1)};return P?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down"},React.createElement("div",{className:"modal-content",style:{borderRadius:"16px",overflow:"hidden"}},React.createElement("div",{className:"modal-header border-0 py-3",style:{background:"linear-gradient(135deg, #ffc107 0%, #ffca2c 100%)"}},React.createElement("h6",{className:"modal-title fw-bold",style:{color:"#1a1a2e"}},React.createElement("i",{className:`fas ${F?"fa-edit":"fa-plus-circle"} me-2`}),F?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:Ne})),React.createElement("form",{onSubmit:Ht},React.createElement("div",{className:"modal-body py-4",style:{maxHeight:"65vh",overflowY:"auto",background:"#f8f9fa"}},React.createElement("div",{className:"text-center mb-4"},React.createElement("div",{className:"position-relative d-inline-block"},J.image?React.createElement(React.Fragment,null,React.createElement("img",{src:J.image,alt:"",style:{width:110,height:110,objectFit:"cover",borderRadius:"12px",boxShadow:"0 4px 15px rgba(0,0,0,0.15)"}}),React.createElement("button",{type:"button",className:"btn btn-danger position-absolute",onClick:jt,style:{top:-10,right:-10,width:28,height:28,padding:0,borderRadius:"50%",boxShadow:"0 2px 8px rgba(220,53,69,0.4)"}},React.createElement("i",{className:"fas fa-times",style:{fontSize:"0.75rem"}}))):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:110,height:110,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd"}},React.createElement("i",{className:"fas fa-image fa-2x text-muted"}))),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"btn btn-warning btn-sm px-3",style:{borderRadius:"20px"}},React.createElement("i",{className:`fas ${ke?"fa-spinner fa-spin":"fa-camera"} me-1`}),ke?X||"\u0110ang x\u1EED l\xFD...":"Ch\u1ECDn \u1EA3nh",React.createElement("input",{type:"file",accept:"image/*",onChange:tt,disabled:ke,style:{position:"absolute",left:"-9999px",opacity:0,width:1,height:1}})),ke&&X&&React.createElement("div",{className:"text-center mt-1",style:{fontSize:11,color:"#6c757d"}},X))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-tag me-1 text-warning"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:J.name,onChange:_=>V({...J,name:_.target.value}),required:!0,placeholder:"VD: Combo Van 3 tay + 2 xylanh",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-barcode me-1 text-info"}),"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:J.code,onChange:_=>V({...J,code:_.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1 text-success"}),"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:J.price,onChange:st,placeholder:"1.950.000\u0111",inputMode:"numeric",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-percent me-1 text-secondary"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:J.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:_=>V({...J,commission_percent:_.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-folder me-1 text-primary"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:J.category,onChange:_=>V({...J,category:_.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),B.map(_=>React.createElement("option",{key:_,value:_},_)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1 text-secondary"}),"Ghi ch\xFA"),React.createElement("input",{type:"text",className:"form-control",value:J.note,onChange:_=>V({...J,note:_.target.value}),placeholder:"VD: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1 text-secondary"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(J.attributes)?J.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(J.attributes)?J.attributes:[]).map((_,T)=>React.createElement("div",{key:T,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(_==null?void 0:_.key)||"",onChange:z=>{const ye=z.target.value;V(we=>{const ue=Array.isArray(we.attributes)?[...we.attributes]:[];return ue[T]={...ue[T]||{},key:ye},{...we,attributes:ue}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(_==null?void 0:_.value)||"",onChange:z=>{const ye=z.target.value;V(we=>{const ue=Array.isArray(we.attributes)?[...we.attributes]:[];return ue[T]={...ue[T]||{},value:ye},{...we,attributes:ue}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(_==null?void 0:_.unit)||"",onChange:z=>{const ye=z.target.value;V(we=>{const ue=Array.isArray(we.attributes)?[...we.attributes]:[];return ue[T]={...ue[T]||{},unit:ye},{...we,attributes:ue}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{V(z=>{const ye=Array.isArray(z.attributes)?[...z.attributes]:[];return ye.splice(T,1),{...z,attributes:ye}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{V(_=>{const T=Array.isArray(_.attributes)?[..._.attributes]:[];return T.push({key:"",value:"",unit:""}),{..._,attributes:T}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1 text-secondary"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(J.variants)?J.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3."):null,(Array.isArray(J.variants)?J.variants:[]).map((_,T)=>React.createElement("div",{key:T,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(_==null?void 0:_.name)||"",onChange:z=>{const ye=z.target.value;V(we=>{var he;const ue=Array.isArray(we.variants)?[...we.variants]:[];return ue[T]={...ue[T]||{},name:ye,options:Array.isArray((he=ue[T])==null?void 0:he.options)?ue[T].options:[]},{...we,variants:ue}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>ie(T),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(_==null?void 0:_.options)||_.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{V(z=>{const ye=Array.isArray(z.variants)?[...z.variants]:[];return ye.splice(T,1),{...z,variants:ye}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(_==null?void 0:_.options)?_.options:[]).map((z,ye)=>{var we,ue;return React.createElement("div",{key:ye,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(z==null?void 0:z.label)||"",onChange:he=>{const _e=he.target.value;V(S=>{var $e,Qe,Ye,St,Et;const q=Array.isArray(S.variants)?[...S.variants]:[],Y={...q[T]||{},options:Array.isArray(($e=q[T])==null?void 0:$e.options)?[...q[T].options]:[]},de=Number((Ye=(Qe=Y.options[ye])==null?void 0:Qe.price)!=null?Ye:0)||0,xe=String((Et=(St=Y.options[ye])==null?void 0:St.priceDigits)!=null?Et:Math.max(0,Math.trunc(de)));return Y.options[ye]={...Y.options[ye]||{},label:_e,price:Math.max(0,Math.trunc(de)),priceDigits:xe},q[T]=Y,{...S,variants:q}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:bt(String((ue=z==null?void 0:z.priceDigits)!=null?ue:window.KTM.money.getDigits(String((we=z==null?void 0:z.price)!=null?we:"")))),onChange:he=>{V(_e=>{var Ye,St,Et,Se,nt;const S=String((St=z==null?void 0:z.priceDigits)!=null?St:window.KTM.money.getDigits(String((Ye=z==null?void 0:z.price)!=null?Ye:""))),q=window.KTM.money.nextPriceInputState(he.target.value,S),Y=String((Et=q.digits)!=null?Et:""),de=Number(Y),xe=Number.isFinite(de)?Math.max(0,Math.trunc(de)):0,$e=Array.isArray(_e.variants)?[..._e.variants]:[],Qe={...$e[T]||{},options:Array.isArray((Se=$e[T])==null?void 0:Se.options)?[...$e[T].options]:[]};return Qe.options[ye]={...Qe.options[ye]||{},label:String(((nt=Qe.options[ye])==null?void 0:nt.label)||""),price:xe,priceDigits:Y},$e[T]=Qe,{..._e,variants:$e}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{V(he=>{var q;const _e=Array.isArray(he.variants)?[...he.variants]:[],S={..._e[T]||{},options:Array.isArray((q=_e[T])==null?void 0:q.options)?[..._e[T].options]:[]};return S.options.splice(ye,1),_e[T]=S,{...he,variants:_e}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{V(z=>{var he;const ye=Array.isArray(z.variants)?[...z.variants]:[],we={...ye[T]||{},options:Array.isArray((he=ye[T])==null?void 0:he.options)?[...ye[T].options]:[]},ue=rt(z.price);return we.options.push({label:"",price:ue,priceDigits:String(ue)}),ye[T]=we,{...z,variants:ye}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{V(_=>{const T=rt(_.price),z=Array.isArray(_.variants)?[..._.variants]:[],ye=String(T);return z.push({name:"Size",options:[{label:"S",price:T,priceDigits:ye},{label:"M",price:T,priceDigits:ye},{label:"L",price:T,priceDigits:ye}]}),{..._,variants:z}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:Le,disabled:!Array.isArray(J.variants)||J.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111."))),React.createElement("div",{className:"mb-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"URL \u1EA3nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",placeholder:"https://...",value:J.image,onChange:_=>V({...J,image:_.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"10px",fontSize:"0.9rem"}}))),React.createElement("div",{className:"modal-footer border-0 py-3",style:{background:"#fff"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:Ne,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:Ee,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},Ee?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}function VideoModal({show:P,video:F,onClose:B,onSave:Ne}){const[oe,J]=useState({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),[V,Ee]=useState(!1),[He,ke]=useState("");useEffect(()=>{F?(J({title:F.title||"",youtube_url:`https://www.youtube.com/watch?v=${F.youtubeId}`,thumbnail_url:F.thumb||"",sort_order:F.sortOrder||0}),ke(F.thumb)):(J({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),ke(""))},[F,P]);const Je=Ve=>{const ie=Ve.match(/(?:youtube\.com\/(?:embed\/|watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return ie?ie[1]:null},rt=Ve=>{J({...oe,youtube_url:Ve});const ie=Je(Ve);ie&&ke(`https://img.youtube.com/vi/${ie}/hqdefault.jpg`)},Fe=async Ve=>{Ve.preventDefault(),Ee(!0),await Ne(oe),Ee(!1)};return P?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},F?"S\u1EEDa Video":"Th\xEAm Video m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:B})),React.createElement("form",{onSubmit:Fe},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Link YouTube *"),React.createElement("input",{type:"url",className:"form-control",value:oe.youtube_url,onChange:Ve=>rt(Ve.target.value),placeholder:"https://www.youtube.com/watch?v=... ho\u1EB7c shorts/...",required:!0}),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3: youtube.com/watch, youtu.be, youtube.com/shorts")),He&&React.createElement("div",{className:"mb-3 text-center"},React.createElement("img",{src:He,alt:"Preview",className:"img-fluid rounded",style:{maxHeight:"150px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ti\xEAu \u0111\u1EC1 *"),React.createElement("input",{type:"text",className:"form-control",value:oe.title,onChange:Ve=>J({...oe,title:Ve.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:oe.sort_order,onChange:Ve=>J({...oe,sort_order:parseInt(Ve.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Thumbnail t\xF9y ch\u1EC9nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",value:oe.thumbnail_url,onChange:Ve=>J({...oe,thumbnail_url:Ve.target.value}),placeholder:"\u0110\u1EC3 tr\u1ED1ng s\u1EBD d\xF9ng thumbnail m\u1EB7c \u0111\u1ECBnh c\u1EE7a YouTube"}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:B},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:V},V?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function getCurrentMonth(){const P=new Date,F=P.getFullYear(),B=String(P.getMonth()+1).padStart(2,"0");return`${F}-${B}`}function ReconExcelManager({showToast:P}){var mt;const F=typeof P=="function"?P:()=>{},[B,Ne]=useState(getCurrentMonth()),oe=B,J=Ne,[V,Ee]=useState(!1),[He,ke]=useState(""),[Je,rt]=useState(""),[Fe,Ve]=useState(""),[ie,Le]=useState(null),[X,pt]=useState("matches"),[bt,_t]=useState(""),[Ge,st]=useState(!0),[Ke,vt]=useState(!0),[$t,rn]=useState(!1),[tt,jt]=useState("created_at"),[Ht,_]=useState(!1),[T,z]=useState(0),[ye,we]=useState(!1),[ue,he]=useState(""),[_e,S]=useState(()=>new Set),[q,Y]=useState(!1),[de,xe]=useState(null),$e=useRef(new Map),Qe=useRef(new Map),Ye=useRef(null),[St,Et]=useState(()=>{var r;return(r=window==null?void 0:window.XLSX)!=null&&r.read?"ready":"loading"}),Se=r=>new Promise((l,k)=>{var h;try{if(!r)return l();const f=String(r),L=document.querySelector(`script[data-ktm-src="${f}"]`)||document.querySelector(`script[src="${f}"]`);if(L){if(L.getAttribute("data-ktm-loaded")==="1"||(h=window==null?void 0:window.XLSX)!=null&&h.read)return l();L.addEventListener("load",()=>l(),{once:!0}),L.addEventListener("error",()=>k(new Error(`Failed to load ${f}`)),{once:!0});return}const K=document.createElement("script");K.src=f,K.async=!0,K.defer=!0,K.setAttribute("data-ktm-src",f),K.addEventListener("load",()=>{K.setAttribute("data-ktm-loaded","1"),l()},{once:!0}),K.addEventListener("error",()=>k(new Error(`Failed to load ${f}`)),{once:!0}),document.head.appendChild(K)}catch(f){k(f)}}),nt=()=>!!(window!=null&&window.XLSX&&typeof window.XLSX.read=="function"),Jt=async()=>{if(nt())return Et("ready"),!0;if(Ye.current)return Ye.current;const r=["https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js","https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js","https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"],l=async k=>{const h=Date.now();for(;Date.now()-h<k;){if(nt())return!0;await new Promise(f=>setTimeout(f,50))}return nt()};return Et("loading"),Ye.current=(async()=>{try{for(const k of r)try{if(await Se(k),await l(1500))return Et("ready"),!0}catch(h){}return Et("failed"),!1}finally{Ye.current=null}})(),Ye.current};useEffect(()=>{if(nt()){Et("ready");return}Jt()},[]);const Mt=r=>{const l=[],k=String(r!=null?r:"").split(/\s+/g);for(const h of k){const f=String(h||"").trim();f&&l.push(f)}return l.join(" ").replace(/\s+/g," ").trim()},dn=r=>{try{return String(r!=null?r:"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,l=>l==="\u0111"?"d":"D")}catch(l){return String(r!=null?r:"").replace(/[đĐ]/g,k=>k==="\u0111"?"d":"D")}},Ft=r=>{const l=Mt(String(r!=null?r:""));return l?dn(l).toLowerCase().replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim():""},yn=r=>{const l=Ft(r);return l?l.replace(/\b(combo|set|sp|san\s*pham|sanpham|hang|ship|freeship|free\s*ship)\b/g," ").replace(/\s+/g," ").trim():""},vn=r=>{var L,K;if(r==null||r==="")return"";if(typeof r=="number"&&Number.isFinite(r)&&((K=(L=window==null?void 0:window.XLSX)==null?void 0:L.SSF)!=null&&K.parse_date_code))try{const b=window.XLSX.SSF.parse_date_code(r);return!b||!b.y||!b.m?"":`${String(b.y).padStart(4,"0")}-${String(b.m).padStart(2,"0")}`}catch(b){}const l=String(r).trim(),k=l.match(/^(\d{1,2})[\.\/\-](\d{1,2})[\.\/\-](\d{4})$/);if(k){const b=String(Number(k[2])||0).padStart(2,"0");return`${k[3]}-${b}`}const h=l.match(/^(\d{4})-(\d{2})-(\d{2})/);if(h)return`${h[1]}-${h[2]}`;const f=new Date(l);return Number.isNaN(f.getTime())?"":`${f.getFullYear()}-${String(f.getMonth()+1).padStart(2,"0")}`},E=r=>{var L,K;if(r==null||r==="")return"";if(typeof r=="number"&&Number.isFinite(r)&&((K=(L=window==null?void 0:window.XLSX)==null?void 0:L.SSF)!=null&&K.parse_date_code))try{const b=window.XLSX.SSF.parse_date_code(r);return!b||!b.y||!b.m||!b.d?"":`${String(b.y).padStart(4,"0")}-${String(b.m).padStart(2,"0")}-${String(b.d).padStart(2,"0")}`}catch(b){}const l=String(r).trim(),k=l.match(/^(\d{1,2})[\.\/\-](\d{1,2})[\.\/\-](\d{4})$/);if(k){const b=String(Number(k[1])||0).padStart(2,"0"),A=String(Number(k[2])||0).padStart(2,"0");return`${k[3]}-${A}-${b}`}const h=l.match(/^(\d{4})-(\d{2})-(\d{2})/);if(h)return`${h[1]}-${h[2]}-${h[3]}`;const f=new Date(l);return Number.isNaN(f.getTime())?"":`${f.getFullYear()}-${String(f.getMonth()+1).padStart(2,"0")}-${String(f.getDate()).padStart(2,"0")}`},ce=r=>{if(r==null||r==="")return 0;if(typeof r=="number"&&Number.isFinite(r))return Math.trunc(r);const l=String(r!=null?r:"").trim();if(!l)return 0;try{const L=window.KTM.money.parseMoney(l);if(Number.isFinite(L)&&L>0)return Math.trunc(L)}catch(L){}const h=l.toLowerCase().replace(/vnd|đ|d/g," ").replace(/\s+/g," ").trim().replace(/[^0-9]/g,"");if(!h)return 0;const f=Number(h);return Number.isFinite(f)?Math.trunc(f):0},Ze=r=>{var k,h;let l="";try{(h=(k=window==null?void 0:window.KTM)==null?void 0:k.phone)!=null&&h.normalize&&(l=window.KTM.phone.normalize(r))}catch(f){}return l||(l=String(r!=null?r:"").replace(/[^0-9]/g,"")),l=String(l||"").replace(/[^0-9]/g,""),l?(l.startsWith("840")?l=`0${l.slice(3)}`:l.startsWith("84")&&(l.length===11?l=`0${l.slice(2)}`:l.length===12&&l[2]!=="0"&&(l=`0${l.slice(2)}`)),l.length===9&&(l=`0${l}`),l):""},Kt=(r,l)=>{try{const k=Array.isArray(l)?l:[],h=A=>{const D=String(A!=null?A:"");return/[\n\r",]/.test(D)?`"${D.replace(/"/g,'""')}"`:D},f=k.map(A=>Array.isArray(A)?A.map(h).join(","):"").join(`
`),L=new Blob([`\uFEFF${f}`],{type:"text/csv;charset=utf-8"}),K=URL.createObjectURL(L),b=document.createElement("a");b.href=K,b.download=r,document.body.appendChild(b),b.click(),setTimeout(()=>{try{URL.revokeObjectURL(K)}catch(A){}try{b.remove()}catch(A){}},0)}catch(k){}},mn=r=>{const l=String(r!=null?r:"");if(!l.trim())return{phone:"",phoneNorm:"",cleanedText:String(r!=null?r:"").trim()};const k=/(?:\+?84|0)\s*[0-9\s\-.()]{8,16}/g;let h=null,f;for(;(f=k.exec(l))!=null;){const A=f[0],D=Ze(A);D&&(D.length<9||D.length>12||(h={raw:A,digits:D}))}if(!h){const A=Ze(l);if(A.length>=9){const D=A.slice(-12);D.length>=9&&(h={raw:D,digits:D})}}if(!h)return{phone:"",phoneNorm:"",cleanedText:l.trim()};const L=h.digits,K=L;let b=l;return h.raw&&l.includes(h.raw)?b=b.replace(h.raw," "):b=b.replace(new RegExp(`${h.digits}$`)," "),b=b.replace(/[\-–—•|]+\s*$/g," ").replace(/\s+[\-–—•|]+\s*/g," ").replace(/\s+/g," ").trim(),{phone:K,phoneNorm:L,cleanedText:b}},Xt=async()=>{var l;const r=$e.current;if(r&&r.size>0)return r;try{const k=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m"),h=Array.isArray(k==null?void 0:k.products)?k.products:Array.isArray(k)?k:[],f=new Map;for(const L of h){const K=String((l=L==null?void 0:L.id)!=null?l:"").trim();K&&f.set(K,L)}return $e.current=f,f}catch(k){return $e.current=new Map,$e.current}},Ut=r=>{var k;const l=String(r!=null?r:"").trim();return l&&((k=$e.current)==null?void 0:k.get(l))||null},H=async r=>{var A,D,W;if(!r)throw new Error("Ch\u01B0a ch\u1ECDn file");const l=await r.arrayBuffer(),k=Number(r.size||0)||0;if(!!!(window!=null&&window.Worker&&typeof Blob!="undefined"&&typeof URL!="undefined")||k<450*1024){if(!((A=window==null?void 0:window.XLSX)!=null&&A.read))try{await Jt()}catch(De){}if(!((D=window==null?void 0:window.XLSX)!=null&&D.read))throw new Error("Thi\u1EBFu th\u01B0 vi\u1EC7n \u0111\u1ECDc Excel (XLSX). Vui l\xF2ng t\u1EA3i l\u1EA1i trang admin.");const se=window.XLSX.read(l,{type:"array"}),ve=(W=se==null?void 0:se.SheetNames)==null?void 0:W[0],re=ve?se.Sheets[ve]:null;if(!re)throw new Error("Kh\xF4ng \u0111\u1ECDc \u0111\u01B0\u1EE3c sheet trong file");return window.XLSX.utils.sheet_to_json(re,{header:1,raw:!0,defval:""})}const f=`
					const sources = [
						'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
						'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
						'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js',
					];

					const hasXlsx = () => Boolean(self.XLSX && typeof self.XLSX.read === 'function');
					const ensureXlsx = async () => {
						if (hasXlsx()) return true;
						for (const src of sources) {
							try {
								self.importScripts(src);
								if (hasXlsx()) return true;
							} catch (e) {
								// try next
							}
						}
						return hasXlsx();
					};

					self.onmessage = async (ev) => {
						try {
							const data = ev && ev.data;
							const buf = data && data.buf;
							const ok = await ensureXlsx();
							if (!ok) throw new Error('XLSX not available');
							const wb = self.XLSX.read(buf, { type: 'array' });
							const sheetName = wb && wb.SheetNames && wb.SheetNames[0];
							const ws = sheetName ? wb.Sheets[sheetName] : null;
							if (!ws) throw new Error('No sheet');
							const grid = self.XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: '' });
							self.postMessage({ ok: true, grid });
						} catch (e) {
							self.postMessage({ ok: false, error: String((e && e.message) || e || 'worker error') });
						}
					};
				`,L=new Blob([f],{type:"application/javascript"}),K=URL.createObjectURL(L),b=new Worker(K);try{return await new Promise((ve,re)=>{const De=setTimeout(()=>{try{b.terminate()}catch(Ie){}re(new Error("Worker timeout"))},12e3);b.onmessage=Ie=>{const We=Ie&&Ie.data;We&&We.ok?(clearTimeout(De),ve(We.grid)):We&&We.ok===!1&&(clearTimeout(De),re(new Error(We.error||"Worker failed")))},b.onerror=()=>{clearTimeout(De),re(new Error("Worker error"))};try{b.postMessage({buf:l},[l])}catch(Ie){b.postMessage({buf:l})}})}finally{try{b.terminate()}catch(se){}try{URL.revokeObjectURL(K)}catch(se){}}},p=async r=>{var D,W;if(!r)throw new Error("Ch\u01B0a ch\u1ECDn file");const l=await H(r),k=Array.isArray(l)?l:[];if(!k.length)throw new Error("File r\u1ED7ng");const h={product:["ten san pham","tensanpham","san pham","t\xEAn s\u1EA3n ph\u1EA9m"],cod:["tong tien thu ho","t\u1ED5ng ti\u1EC1n thu h\u1ED9","thu ho","thu h\u1ED9","tong thu ho","t\u1ED5ng thu h\u1ED9"],date:["ngay","ng\xE0y","date"],phone:["sdt","s\u0111t","so dien thoai","s\u1ED1 \u0111i\u1EC7n tho\u1EA1i","dien thoai","\u0111i\u1EC7n tho\u1EA1i","phone"],qty:["sl","so luong","s\u1ED1 l\u01B0\u1EE3ng","qty","quantity"]},L=(()=>{const se=Math.min(30,k.length);for(let ve=0;ve<se;ve++){const De=(Array.isArray(k[ve])?k[ve]:[]).map(ut=>Ft(ut)),Ie=ut=>{for(let pe=0;pe<De.length;pe++){const ze=De[pe];if(ze&&ut.some(Dt=>ze.includes(Ft(Dt))))return pe}return-1},We=Ie(h.product),Ce=Ie(h.cod);if(Ce>=0){const ut=Ie(h.date),pe=Ie(h.phone),ze=Ie(h.qty);return{headerRow:ve,productCol:We,codCol:Ce,dateCol:ut,phoneCol:pe,qtyCol:ze}}}return null})();if(!L)throw new Error('Kh\xF4ng t\xECm th\u1EA5y header c\u1ED9t "T\u1ED5ng ti\u1EC1n thu h\u1ED9"');const K=[],b=new Set,A=se=>{const ve=String(se!=null?se:"").trim();if(!ve)return{text:"",qty:null};let re=ve.match(/^\s*x\s*(\d{1,3})\s+(.+)$/i);return re?{text:String(re[2]||"").trim(),qty:Number(re[1])}:(re=ve.match(/^\s*(\d{1,3})\s*(?:x|\*|×)?\s+(.+)$/i),re?{text:String(re[2]||"").trim(),qty:Number(re[1])}:{text:ve,qty:null})};for(let se=L.headerRow+1;se<k.length;se++){const ve=Array.isArray(k[se])?k[se]:[],re=L.productCol>=0?String((D=ve[L.productCol])!=null?D:"").trim():"",De=A(re),Ie=De.text,We=ce(ve[L.codCol]),Ce=L.qtyCol>=0?ve[L.qtyCol]:"",ut=(()=>{if(Ce!=null&&Ce!==""){if(typeof Ce=="number"&&Number.isFinite(Ce))return{qty:Math.max(1,Math.trunc(Ce)),source:"cell"};const Qt=String(Ce).trim(),It=Number(Qt.replace(/[^0-9]/g,""));if(Number.isFinite(It)&&It>0)return{qty:Math.max(1,Math.trunc(It)),source:"cell"}}const Lt=Number(De.qty);return Number.isFinite(Lt)&&Lt>1?{qty:Math.max(1,Math.trunc(Lt)),source:"text"}:{qty:1,source:"default"}})(),pe=ut.qty,ze=ut.source,Dt=ze==="cell"&&pe>1&&We>0&&pe<=50?We*pe:0,kt=Array.from(new Set([We,Dt].filter(Lt=>Number(Lt||0)>0))),Nt=We;if(!Ie&&!Nt)continue;const Be=L.phoneCol>=0?String((W=ve[L.phoneCol])!=null?W:"").trim():"",O=Ze(Be);let me=mn(Ie);if(O&&(me={...me,phone:O,phoneNorm:O}),!me.phoneNorm){const Lt=ve.map(It=>String(It!=null?It:"")).join(" | "),Qt=mn(Lt);Qt.phoneNorm&&(me={...me,phone:Qt.phone,phoneNorm:Qt.phoneNorm})}const Xe=me.cleanedText||Ie||"",ft=Ft(Xe);if(ft&&(ft.includes("tong tien")||ft.includes("tong")||ft.includes("thanh toan")||ft.includes("thanh to\xE1n")))continue;const Ct=L.dateCol>=0?ve[L.dateCol]:"",Yt=Ct?vn(Ct):"";Yt&&b.add(Yt);const wt=Ct?E(Ct):"";K.push({rowIndex:se+1,dateRaw:Ct,monthKey:Yt,dayKey:wt,product:Xe,productNorm:yn(Xe),productCompact:yn(Xe).replace(/\s+/g,""),phone:me.phone,phoneNorm:me.phoneNorm,cod:Nt,codRaw:We,qty:pe,qtySource:ze,codAlt:Dt,codCandidates:kt})}return{rows:K,monthKeys:Array.from(b.values()).sort()}},G=r=>{const l=new Map,k=(b,A)=>{const D=l.get(b)||{key:b,rows:[],phoneNorm:"",phone:"",monthKey:"",dayKey:""};D.rows.push(A),!D.phoneNorm&&A.phoneNorm&&(D.phoneNorm=A.phoneNorm,D.phone=A.phone||A.phoneNorm),!D.monthKey&&A.monthKey&&(D.monthKey=A.monthKey),!D.dayKey&&A.dayKey&&(D.dayKey=A.dayKey),l.set(b,D)};for(const b of Array.isArray(r)?r:[]){const A=String((b==null?void 0:b.phoneNorm)||"").trim(),D=String((b==null?void 0:b.dayKey)||"").trim(),W=String((b==null?void 0:b.monthKey)||"").trim();if(A){const se=D?`p:${A}:d:${D}`:W?`p:${A}:m:${W}`:`p:${A}`;k(se,b)}else k(`r:${b==null?void 0:b.rowIndex}`,b)}const h=b=>{const A=Number((b==null?void 0:b.cod)||0)||0;if(A>0)return A;const D=Number((b==null?void 0:b.codAlt)||0)||0;return D>0?D:0},f=b=>{var se;const A=((b==null?void 0:b.rows)||[]).slice().filter(Boolean);if(A.length<=1)return[{key:b.key,rows:A,phoneNorm:b.phoneNorm,phone:b.phone,monthKey:b.monthKey}];const D=A.map(h).filter(ve=>ve>0),W=Array.from(new Set(D));if(b.phoneNorm&&b.dayKey&&W.length>1&&W.length<=8){const ve=new Map;for(const De of W)ve.set(String(De),{key:`${b.key}:t:${De}`,rows:[],phoneNorm:b.phoneNorm,phone:b.phone,monthKey:b.monthKey});const re=[];for(const De of A){const Ie=h(De);Ie>0?ve.get(String(Ie)).rows.push(De):re.push(De)}if(re.length){const De=Array.from(ve.values()).map(Ie=>{const We=Ie.rows.find(Ce=>String((Ce==null?void 0:Ce.productNorm)||"").trim())||null;return{group:Ie,seedNorm:String((We==null?void 0:We.productNorm)||"")}});for(const Ie of re){const We=String((Ie==null?void 0:Ie.productNorm)||"");let Ce=null,ut=-1;for(const pe of De){const ze=je(We,pe.seedNorm);ze>ut&&(ut=ze,Ce=pe.group)}(Ce||((se=De[0])==null?void 0:se.group)).rows.push(Ie)}}return Array.from(ve.values()).filter(De=>De.rows.length>0)}return[{key:b.key,rows:A,phoneNorm:b.phoneNorm,phone:b.phone,monthKey:b.monthKey}]},L=[];for(const b of l.values())L.push(...f(b));const K=b=>{var Dt,kt,Nt;const A=b.rows.slice().filter(Boolean),D=A.map(Be=>Be.rowIndex).filter(Boolean),W=[],se=new Set;for(const Be of A){const O=String((Be==null?void 0:Be.productNorm)||"").trim();O&&(se.has(O)||(se.add(O),W.push(String((Be==null?void 0:Be.product)||"").trim())))}const ve=W.filter(Boolean).join(" + "),re=Ft(ve),De=[];for(const Be of A){const O=Array.isArray(Be==null?void 0:Be.codCandidates)?Be.codCandidates:[];for(const me of O){const Xe=Number(me||0)||0;Xe>0&&De.push(Xe)}}const Ie=Array.from(new Set(De)).sort((Be,O)=>Be-O),We=A.map(Be=>h(Be)).filter(Be=>Be>0);let Ce=0;if(!We.length)Ce=0;else{const Be=new Map;for(const me of We)Be.set(me,(Be.get(me)||0)+1);const O=Array.from(Be.keys());if(O.length===1)Ce=O[0];else{let me=null,Xe=0;for(const[ft,Ct]of Be.entries())Ct>Xe&&(Xe=Ct,me=ft);me!=null&&Xe>=2?Ce=me:Ce=We.reduce((ft,Ct)=>ft+Ct,0)}}const ut=b.monthKey||((Dt=A.find(Be=>Be==null?void 0:Be.monthKey))==null?void 0:Dt.monthKey)||"",pe=((kt=A.find(Be=>Be==null?void 0:Be.dayKey))==null?void 0:kt.dayKey)||"",ze=((Nt=A.find(Be=>Be==null?void 0:Be.dateRaw))==null?void 0:Nt.dateRaw)||"";return{key:b.key,phoneNorm:b.phoneNorm||"",phone:b.phone||b.phoneNorm||"",monthKey:ut,dayKey:pe,dateRaw:ze,rowIndices:D,rowIndexFirst:D.length?Math.min(...D):null,rowCount:A.length,productDisplay:ve,productNorm:re,productCompact:String(re||"").replace(/\s+/g,""),cod:Ce,codCandidates:Ie,rows:A}};return L.map(K)},ae=async r=>{const l=`${API_BASE}/api/orders?month=${encodeURIComponent(r)}&includeItems=1`,k=await window.KTM.api.getJSON(l,"L\u1ED7i t\u1EA3i danh s\xE1ch \u0111\u01A1n");return Array.isArray(k==null?void 0:k.orders)?k.orders:Array.isArray(k)?k:[]},Pe=async r=>{var A,D;const l=Array.isArray(r)&&r.length?r:[B],k=[],h=5*60*1e3;for(let W=0;W<l.length;W++){const se=l[W],ve=(A=Qe.current)==null?void 0:A.get(se);if(ve&&Date.now()-Number(ve.at||0)<h&&Array.isArray(ve.records)){k.push(...ve.records);continue}rt(`\u0110ang t\u1EA3i \u0111\u01A1n h\u1EC7 th\u1ED1ng th\xE1ng ${se} (${W+1}/${l.length})...`);const re=await ae(se);(D=Qe.current)==null||D.set(se,{at:Date.now(),records:re}),k.push(...re)}const f=W=>String(W||"").trim().toLowerCase(),L=k.filter(W=>{const se=f(W==null?void 0:W.status);return!(Ge&&se==="draft"||Ke&&se==="canceled"||$t&&se==="paid")}),K=W=>{var ve,re,De;return String(tt||"created_at")==="updated_at"?(re=(ve=W==null?void 0:W.updated_at)!=null?ve:W==null?void 0:W.created_at)!=null?re:null:(De=W==null?void 0:W.created_at)!=null?De:null};return L.map(W=>{var Ce,ut,pe,ze,Dt,kt;const se=window.KTM.orders.getOrderProductSummary(W,Ut),ve=window.KTM.orders.getOrderTotalMoney(W,Ut),re=yn(se),De=Ze((Ce=W==null?void 0:W.phone)!=null?Ce:""),Ie=K(W),We=(()=>{if(!Ie)return"";const Nt=new Date(Ie);return Number.isNaN(Nt.getTime())?"":`${Nt.getFullYear()}-${String(Nt.getMonth()+1).padStart(2,"0")}-${String(Nt.getDate()).padStart(2,"0")}`})();return{id:String((ut=W==null?void 0:W.id)!=null?ut:""),created_at:(pe=W==null?void 0:W.created_at)!=null?pe:null,updated_at:(ze=W==null?void 0:W.updated_at)!=null?ze:null,dayKey:We,status:String((Dt=W==null?void 0:W.status)!=null?Dt:""),phone:String((kt=W==null?void 0:W.phone)!=null?kt:""),phoneNorm:De,productSummary:se,productNorm:re,productCompact:re.replace(/\s+/g,""),cod:Number(ve||0)||0,raw:W}}).filter(W=>W.id&&W.cod>0)},je=(r,l)=>{const k=String(r||"").trim(),h=String(l||"").trim();if(!k||!h)return 0;if(k===h)return 1;const f=k.replace(/\s+/g,""),L=h.replace(/\s+/g,"");if(f&&L&&f===L)return 1;if(f&&L&&(L.includes(f)||f.includes(L)))return .92;const K=Ce=>String(Ce||"").replace(/[\+]/g," ").replace(/[()\[\]{},.;:!?]/g," ").replace(/\s+/g," ").trim().split(" ").map(ze=>ze.trim()).filter(Boolean).map(ze=>ze.replace(/[^a-z0-9]/g,"")).filter(Boolean).filter(ze=>ze.length>1),b=K(k),A=K(h);if(!b.length||!A.length)return 0;const D=new Set(A),W=(Ce,ut)=>{if(Ce===ut)return 0;const pe=Ce.length,ze=ut.length;if(Math.abs(pe-ze)>1)return 2;let Dt=0,kt=0,Nt=0;for(;Dt<pe&&kt<ze;){if(Ce[Dt]===ut[kt]){Dt+=1,kt+=1;continue}if(Nt+=1,Nt>1)return Nt;pe>ze?Dt+=1:(ze>pe||(Dt+=1),kt+=1)}return(Dt<pe||kt<ze)&&(Nt+=1),Nt},se=Ce=>/[0-9]/.test(Ce)?2:1;let ve=0,re=0;for(const Ce of b){const ut=se(Ce);if(re+=ut,D.has(Ce)||L&&L.includes(Ce)){ve+=ut;continue}if(Ce.length>=4){let pe=!1;for(const ze of A){if(ze===Ce){pe=!0;break}if(ze.includes(Ce)||Ce.includes(ze)){pe=!0;break}if(L&&L.includes(Ce)){pe=!0;break}if(W(Ce,ze)<=1){pe=!0;break}}pe&&(ve+=ut*.8)}}const De=ve/Math.max(1,re),Ie=Math.min(.12,Math.abs(k.length-h.length)/Math.max(1,Math.max(k.length,h.length))),We=(()=>{const Ce=b.filter(pe=>/[0-9]/.test(pe)&&pe.length>=3);if(!Ce.length)return 0;let ut=0;for(const pe of Ce)(D.has(pe)||L&&L.includes(pe))&&(ut+=1);return Math.min(.08,.04*ut)})();return Math.max(0,Math.min(1,De-Ie+We))},Ue=r=>{const k=String(r||"").trim().match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!k)return null;const h=new Date(Number(k[1]),Number(k[2])-1,Number(k[3]));return Number.isNaN(h.getTime())?null:h.getTime()},xt=(r,l)=>{const k=Array.isArray(r==null?void 0:r.codCandidates)&&r.codCandidates.length?r.codCandidates:[Number((r==null?void 0:r.cod)||0)||0],h=Number((l==null?void 0:l.cod)||0)||0;let f=1/0,L=0;for(const K of k){const b=Number(K||0)||0;if(b<=0)continue;const A=Math.abs(h-b);A<f&&(f=A,L=b)}return Number.isFinite(f)||(f=1/0),{bestDiff:f,bestCand:L,oCod:h}},at=(r,l,k)=>{const h=String((r==null?void 0:r.phoneNorm)||"").trim(),f=!!(h&&String((l==null?void 0:l.phoneNorm)||"")===h),L=Math.max(0,Number((k==null?void 0:k.codTolerance)||0)||0),{bestDiff:K,bestCand:b}=xt(r,l),A=K===0,D=Number.isFinite(K)&&L>0&&K>0&&K<=L,W=String((r==null?void 0:r.dayKey)||"").trim(),se=String((l==null?void 0:l.dayKey)||"").trim(),ve=!!(W&&se&&W===se),re=(()=>{if(!W||!se)return!1;const Dt=Ue(W),kt=Ue(se);if(Dt==null||kt==null)return!1;const Nt=Math.abs(Dt-kt)/(24*60*60*1e3);return Nt>0&&Nt<=1.01})(),Ie=!!h?{phone:.65,cod:.27,day:.08}:{phone:0,cod:.85,day:.15},We=f?Ie.phone:0,Ce=A?Ie.cod:D?Ie.cod*(1-K/Math.max(1,L)):0,ut=ve?Ie.day:re?Ie.day*.6:0,pe=We+Ce+ut,ze=[];return f&&ze.push("S\u0110T tr\xF9ng"),A?ze.push("COD tr\xF9ng"):D?ze.push(`COD l\u1EC7ch ${window.KTM.money.formatNumber(K)} (<= ${window.KTM.money.formatNumber(L)})`):b>0&&Number.isFinite(K)&&K!==1/0&&ze.push(`COD l\u1EC7ch ${window.KTM.money.formatNumber(K)}`),ve?ze.push("C\xF9ng ng\xE0y"):re&&ze.push("Ng\xE0y g\u1EA7n \u0111\xFAng (\xB11)"),{score:pe,reasons:ze,nameSim:null,phoneMatch:f,codExact:A,codWithin:D,codDiff:K,bestCand:b}},un=r=>{let l=String(r!=null?r:"");return l=l.replace(/^\s*(?:x\s*)?(\d{1,3})\s*(?:x|\*|×)?\s*/i," "),l=l.replace(/\s+/g," ").trim(),yn(l)},Vt=r=>{var L;const l=new Map,k=new Map,h=Array.isArray(r==null?void 0:r.rows)?r.rows:[],f=h.length>1||h.some(K=>String((K==null?void 0:K.qtySource)||"default")!=="default");for(const K of h){const b=String((K==null?void 0:K.product)||"").trim(),A=un(b);if(!A)continue;const D=Math.max(1,Number((L=K==null?void 0:K.qty)!=null?L:1)||1),W=f?D:1;l.set(A,(l.get(A)||0)+W),k.has(A)||k.set(A,b)}return{qtyByKey:l,labelByKey:k,qtyReliable:f}},on=r=>{var b;const l=new Map,k=new Map,h=(r==null?void 0:r.raw)||null,f=Array.isArray(h==null?void 0:h.items)?h.items:[];if(f.length){for(const A of f){const D=A==null?void 0:A.product_id,W=D?Ut(D):null,se=String((W==null?void 0:W.name)||(A==null?void 0:A.product_name)||"").trim(),ve=String((A==null?void 0:A.variant)||"").trim(),re=(se||(r==null?void 0:r.productSummary)||"").trim()+(ve?` (${ve})`:""),De=un(re);if(!De)continue;const Ie=Math.max(1,Number((b=A==null?void 0:A.quantity)!=null?b:1)||1);l.set(De,(l.get(De)||0)+Ie),k.has(De)||k.set(De,se||re)}return{qtyByKey:l,labelByKey:k}}const L=String((r==null?void 0:r.productSummary)||"").trim();if(!L)return{qtyByKey:l,labelByKey:k};const K=L.split("+").map(A=>String(A||"").trim()).filter(Boolean);for(const A of K){const D=A.match(/\bx\s*(\d{1,3})\b/i),W=D?Math.max(1,Number(D[1])||1):1,se=A.replace(/\bx\s*\d{1,3}\b/ig," ").replace(/\s+/g," ").trim(),ve=un(se);ve&&(l.set(ve,(l.get(ve)||0)+W),k.has(ve)||k.set(ve,se))}return{qtyByKey:l,labelByKey:k}},Nn=(r,l)=>{const k=Vt(r),h=on(l),f=Array.from(k.qtyByKey.keys()),L=Array.from(h.qtyByKey.keys()),K=[];for(const re of f)for(const De of L){const Ie=je(re,De);Ie>=.9&&K.push({ek:re,sk:De,sc:Ie})}K.sort((re,De)=>De.sc-re.sc);const b=new Map,A=new Set,D=new Set;for(const re of K)A.has(re.ek)||D.has(re.sk)||(b.set(re.ek,re.sk),A.add(re.ek),D.add(re.sk));const W=[],se=[];for(const[re,De]of k.qtyByKey.entries()){const Ie=b.get(re)||re,We=h.qtyByKey.get(Ie)||0;We<De&&W.push({name:k.labelByKey.get(re)||re,qty:De-We})}for(const[re,De]of h.qtyByKey.entries()){let Ie=k.qtyByKey.get(re)||0;if(!Ie){for(const[We,Ce]of b.entries())if(Ce===re){Ie=k.qtyByKey.get(We)||0;break}}Ie<De&&se.push({name:h.labelByKey.get(re)||re,qty:De-Ie})}return{hasDiff:W.length>0||se.length>0,missingInSystem:W,missingInExcel:se}},it=r=>{if(!(r!=null&&r.hasDiff))return"";const l=h=>h.slice(0,4).map(f=>`${f.name} x${f.qty}`).join(", ")+(h.length>4?` (+${h.length-4})`:""),k=[];return Array.isArray(r.missingInExcel)&&r.missingInExcel.length&&k.push(`Thi\u1EBFu trong Excel: ${l(r.missingInExcel)}`),Array.isArray(r.missingInSystem)&&r.missingInSystem.length&&k.push(`Thi\u1EBFu trong h\u1EC7 th\u1ED1ng: ${l(r.missingInSystem)}`),k.join(" \xB7 ")},pn=async r=>{ke(""),Le(null),Ve((r==null?void 0:r.name)||""),Ee(!0),rt("\u0110ang \u0111\u1ECDc file Excel...");try{await Xt();const l=await p(r),k=Array.isArray(l.rows)?l.rows:[],h=String(B||"").trim()||getCurrentMonth(),f=ee=>{const s=String(ee||"").match(/^(\d{4})-(\d{2})$/);if(!s)return NaN;const m=Number(s[1]),c=Number(s[2]);return!Number.isFinite(m)||!Number.isFinite(c)||c<1||c>12?NaN:m*12+(c-1)},L=ee=>{if(!Number.isFinite(ee))return"";const s=Math.floor(ee/12),m=ee%12+1;return!Number.isFinite(s)||!Number.isFinite(m)||m<1||m>12?"":`${String(s).padStart(4,"0")}-${String(m).padStart(2,"0")}`},K=f(h),b=Number.isFinite(K)?K-2:NaN,A=ee=>{const s=f(ee);return!Number.isFinite(s)||!Number.isFinite(K)||!Number.isFinite(b)?!1:s>=b&&s<=K},D=(()=>{if(!Number.isFinite(K)||!Number.isFinite(b))return[h];const ee=[];for(let s=b;s<=K;s++){const m=L(s);m&&ee.push(m)}return ee.length?ee:[h]})(),W=k.filter(ee=>{const s=String((ee==null?void 0:ee.monthKey)||"").trim();return s?A(s):!0}),se=k.filter(ee=>{const s=String((ee==null?void 0:ee.monthKey)||"").trim();return s?!A(s):!1});if(!W.length)throw new Error(`File kh\xF4ng c\xF3 d\u1EEF li\u1EC7u trong 3 th\xE1ng g\u1EA7n nh\u1EA5t quanh ${h}.`);const ve=D,re=await Pe(ve),De=(()=>{const ee=new Map;for(const s of Array.isArray(re)?re:[]){const m=String((s==null?void 0:s.phoneNorm)||"").trim(),c=String((s==null?void 0:s.dayKey)||"").trim();if(!m||!c)continue;const x=`${m}|${c}`;ee.set(x,(ee.get(x)||0)+1)}return ee})(),Ie=ee=>{const s=Number(ee);return Number.isFinite(s)?Math.trunc(s):0},We=(ee,s)=>{const m=String(ee||"").trim(),c=Ie(s);return!m||!c?"":`${m}|${c}`},Ce=(()=>{const ee=new Map;for(const s of Array.isArray(re)?re:[]){const m=We(s==null?void 0:s.phoneNorm,s==null?void 0:s.cod);m&&ee.set(m,(ee.get(m)||0)+1)}return ee})(),ut=new Set(re.map(ee=>We(ee==null?void 0:ee.phoneNorm,ee==null?void 0:ee.cod)).filter(Boolean)),pe=(()=>{var s,m,c,x,R;const ee=new Map;for(const w of se){const N=We(w==null?void 0:w.phoneNorm,w==null?void 0:w.cod);if(!N||!ut.has(N))continue;const U=ee.get(N)||[];U.push({rowIndex:(s=w==null?void 0:w.rowIndex)!=null?s:null,dateRaw:(m=w==null?void 0:w.dateRaw)!=null?m:"",monthKey:(c=w==null?void 0:w.monthKey)!=null?c:"",dayKey:(x=w==null?void 0:w.dayKey)!=null?x:"",product:(R=w==null?void 0:w.product)!=null?R:""}),ee.set(N,U)}return ee})(),ze=W,Dt=ee=>{const s=Number((ee==null?void 0:ee.cod)||0)||0;if(s>0)return s;const m=Number((ee==null?void 0:ee.codAlt)||0)||0;return m>0?m:0},kt=ee=>{var c;const s=new Map;for(const x of Array.isArray(ee)?ee:[]){const R=String((x==null?void 0:x.phoneNorm)||"").trim(),w=String((x==null?void 0:x.dayKey)||"").trim();if(!R||!w)continue;const N=`${R}|${w}`,U=s.get(N)||[];U.push(x),s.set(N,U)}const m=[];for(const[x,R]of s.entries()){if(!Array.isArray(R)||R.length<2)continue;const[w,N]=String(x).split("|"),U=N&&N.length>=7?N.slice(0,7):"",le=R.map(Dt).filter(Ae=>Ae>0).reduce((Ae,y)=>Ae+y,0);if(!le)continue;const Q=R.map(Ae=>Ae==null?void 0:Ae.rowIndex).filter(Boolean),te=[],Oe=new Set;for(const Ae of R){const y=String((Ae==null?void 0:Ae.product)||"").trim();y&&(Oe.has(y)||(Oe.add(y),te.push(y)))}m.push({key:`merge:p:${w}:d:${N}`,isMerged:!0,phoneNorm:w,phone:w,monthKey:U,dayKey:N,dateRaw:((c=R.find(Ae=>Ae==null?void 0:Ae.dateRaw))==null?void 0:c.dateRaw)||"",rowIndices:Q,rowIndexFirst:Q.length?Math.min(...Q):null,rowCount:R.length,productDisplay:te.join(" + "),productNorm:"",productCompact:"",cod:le,codCandidates:[],rows:R})}return m},Nt=G(ze),Be=kt(ze),O=Be.length?Nt.concat(Be):Nt;rt(`\u0110\u1ECDc \u0111\u01B0\u1EE3c ${ze.length} d\xF2ng (${Nt.length} c\u1EE5m; +${Be.length} c\u1EE5m g\u1ED9p) trong 3 th\xE1ng g\u1EA7n nh\u1EA5t. \u0110ang chu\u1EA9n b\u1ECB \u0111\u1ED1i so\xE1t...`),rt(`\u0110ang \u0111\u1ED1i so\xE1t (${O.length} c\u1EE5m Excel vs ${re.length} \u0111\u01A1n h\u1EC7 th\u1ED1ng)...`);const me=new Map,Xe=new Map,ft=new Map;for(const ee of O){const s=String(ee.phoneNorm||"").trim();if(!s)continue;const m=me.get(s)||[];m.push(ee),me.set(s,m);const c=We(s,ee.cod);if(c){const x=Xe.get(c)||[];x.push(ee),Xe.set(c,x);const R=String((ee==null?void 0:ee.dayKey)||"").trim();if(R){const w=`${c}|${R}`,N=ft.get(w)||[];N.push(ee),ft.set(w,N)}}}const Ct=new Set,Yt=(()=>{const ee=new Map;for(const s of O){const m=String((s==null?void 0:s.key)||"").trim();if(!m)continue;const c=Array.isArray(s==null?void 0:s.rowIndices)?s.rowIndices:[];for(const x of c){const R=Number(x);if(!Number.isFinite(R))continue;const w=ee.get(R)||[];w.push(m),ee.set(R,w)}}return ee})(),wt=ee=>{const s=Array.isArray(ee==null?void 0:ee.rowIndices)?ee.rowIndices:[];for(const c of s){const x=Number(c);if(!Number.isFinite(x))continue;const R=Yt.get(x)||[];for(const w of R)Ct.add(String(w))}const m=String((ee==null?void 0:ee.key)||"").trim();m&&Ct.add(m)},Lt=[],Qt=[],It=[],tn=ee=>{const s=Array.isArray(ee)?ee.filter(Boolean):[];return s.length?`C\xF3 d\xF2ng Excel ngo\xE0i 3 th\xE1ng tr\xF9ng S\u0110T+COD: ${s.slice(0,2).map(c=>{const x=String((c==null?void 0:c.dateRaw)||(c==null?void 0:c.dayKey)||(c==null?void 0:c.monthKey)||"").trim(),R=c!=null&&c.rowIndex?`d\xF2ng ${c.rowIndex}`:"";return[x,R].filter(Boolean).join(" \xB7 ")}).join(" | ")}`:""};for(const ee of re){const s=String(ee.phoneNorm||"").trim(),m=Ie(ee.cod);if(!s||!m){It.push(ee);continue}const c=We(s,m),x=String(ee.dayKey||"").trim();let R=c?Xe.get(c)||[]:[],w=[];if(c&&x&&(w=ft.get(`${c}|${x}`)||[]),x&&R.length){const fe=(Ce.get(c)||0)>1;R=R.filter(ot=>{const ct=String((ot==null?void 0:ot.dayKey)||"").trim();return ct?ct===x:!fe})}const N=fe=>{if(!(fe!=null&&fe.isMerged))return!0;const ot=String((fe==null?void 0:fe.dayKey)||"").trim();return!x||!ot||ot!==x?!1:(De.get(`${s}|${x}`)||0)===1},U=fe=>{const ot=(Array.isArray(fe)?fe:[]).filter(At=>!Ct.has(String(At==null?void 0:At.key)));if(!ot.length)return null;let ct=ot.find(At=>!(At!=null&&At.isMerged))||null;return ct||(ct=ot.find(At=>N(At))||null),ct&&(ct!=null&&ct.isMerged)&&!N(ct)?null:ct};if(w.length){const fe=U(w);if(fe){wt(fe),Lt.push({group:fe,order:ee,score:1,reasons:["S\u0110T tr\xF9ng","COD tr\xF9ng","C\xF9ng ng\xE0y"]});continue}}if(R.length){const fe=U(R);if(fe){wt(fe),Lt.push({group:fe,order:ee,score:1,reasons:["S\u0110T tr\xF9ng","COD tr\xF9ng",...fe.dayKey&&x&&fe.dayKey===x?["C\xF9ng ng\xE0y"]:[]]});continue}}const le=me.get(s)||[];if(!le.length){const fe=pe.get(c)||[];It.push(fe.length?{...ee,excelOutsideHints:fe,excelOutsideHintText:tn(fe)}:ee);continue}let Q=le.filter(fe=>!Ct.has(String(fe==null?void 0:fe.key)));if(x){const fe=Q.filter(ot=>String(ot.dayKey||"").trim()===x);fe.length&&(Q=fe)}if(!Q.length){const fe=pe.get(c)||[];It.push(fe.length?{...ee,excelOutsideHints:fe,excelOutsideHintText:tn(fe)}:ee);continue}let te=null,Oe=Number.POSITIVE_INFINITY;for(const fe of Q){const ot=Ie(fe.cod);if(!ot)continue;const ct=Math.abs(ot-m);ct<Oe&&(Oe=ct,te=fe)}if(!te){const fe=pe.get(c)||[];It.push(fe.length?{...ee,excelOutsideHints:fe,excelOutsideHintText:tn(fe)}:ee);continue}const Ae=Ie(te.cod)-m,y=Math.abs(Ae),ge=Ht?Math.max(0,Ie(T)):0;if(y===0||ge>0&&y<=ge){wt(te),Lt.push({group:te,order:ee,score:1,reasons:["S\u0110T tr\xF9ng","COD tr\xF9ng",...ge>0&&y>0?[`Trong ng\u01B0\u1EE1ng \xB1${ge}`]:[],...x&&String(te.dayKey||"").trim()===x?["C\xF9ng ng\xE0y"]:[]]});continue}Qt.push({group:te,order:ee,score:0,diff:Ae,reason:x&&String(te.dayKey||"").trim()===x?"S\u0110T tr\xF9ng \xB7 C\xF9ng ng\xE0y":"S\u0110T tr\xF9ng",suggestions:Q.slice(0,3).map(fe=>({key:fe.key,cod:Ie(fe.cod),productSummary:String(fe.product||"").trim(),score:0,reasons:["Excel c\xF9ng S\u0110T"]}))})}const fn=It.length===0&&Qt.length===0;Le({ok:fn,monthKeys:ve,excelCount:ze.length,excelGroupCount:O.length,systemCount:re.length,matches:Lt,systemOnly:It,moneyMismatch:Qt}),pt(It.length?"systemOnly":Qt.length?"moneyMismatch":"matches"),S(new Set),rt(fn?"OK \u2705":"\u0110\xE3 \u0111\u1ED1i so\xE1t xong")}catch(l){ke(String((l==null?void 0:l.message)||l||"L\u1ED7i \u0111\u1ED1i so\xE1t")),rt("")}finally{Ee(!1)}},In=(r,l)=>{var D,W,se,ve,re,De,Ie,We,Ce,ut;const k=pe=>String(pe||"").replace(/[^0-9]/g,""),h=(r==null?void 0:r.raw)||{},f=String((W=(D=r==null?void 0:r.id)!=null?D:h==null?void 0:h.id)!=null?W:"").trim(),L=k((ve=(se=h==null?void 0:h.phone)!=null?se:r==null?void 0:r.phone)!=null?ve:"");if(!f||!L)return null;let b=(Array.isArray(h==null?void 0:h.items)?h.items:[]).map(pe=>{var ze,Dt;return{product_id:(pe==null?void 0:pe.product_id)||"",quantity:Number((ze=pe==null?void 0:pe.quantity)!=null?ze:1),variant:String((pe==null?void 0:pe.variant)||"").trim()||null,variant_json:(Dt=pe==null?void 0:pe.variant_json)!=null?Dt:null,unit_price:(()=>{var Be;const kt=(Be=pe==null?void 0:pe.unit_price)!=null?Be:pe==null?void 0:pe.unitPrice,Nt=kt==null||kt===""?NaN:Number(kt);return Number.isFinite(Nt)?Math.max(0,Math.trunc(Nt)):null})()}}).filter(pe=>pe.product_id&&Number.isFinite(pe.quantity)&&pe.quantity>0);if(!b.length&&(h!=null&&h.product_id)){const pe=Number((re=h==null?void 0:h.quantity)!=null?re:1);b=[{product_id:h.product_id,quantity:Number.isFinite(pe)&&pe>0?pe:1,variant:null,variant_json:null,unit_price:null}]}if(!b.length)return null;const A=b[0];return{id:f,customer_name:String((De=h==null?void 0:h.customer_name)!=null?De:"").trim(),phone:L,address:String((Ie=h==null?void 0:h.address)!=null?Ie:"").trim(),note:String((We=h==null?void 0:h.note)!=null?We:"").trim(),adjustment_amount:Number((Ce=h==null?void 0:h.adjustment_amount)!=null?Ce:0)||0,adjustment_note:String((ut=h==null?void 0:h.adjustment_note)!=null?ut:"").trim(),product_id:A.product_id,quantity:A.quantity,status:l,items:b}},xn=async()=>{if(!ie||ye)return;const r=Array.from(_e.values()).map(h=>String(h||"").trim()).filter(Boolean);if(!r.length||!confirm(`\u0110\xE1nh d\u1EA5u \u0111\xE3 nh\u1EADn ti\u1EC1n cho ${r.length} \u0111\u01A1n?`))return;we(!0),he("\u0110ang c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i...");let l=0;const k=[];try{for(let h=0;h<r.length;h++){const f=r[h];he(`\u0110ang c\u1EADp nh\u1EADt (${h+1}/${r.length})...`);const L=(Array.isArray(ie==null?void 0:ie.matches)?ie.matches:[]).find(b=>{var A;return String(((A=b==null?void 0:b.order)==null?void 0:A.id)||"")===f}),K=In(L==null?void 0:L.order,"paid");if(!K){k.push({id:f,error:"Thi\u1EBFu d\u1EEF li\u1EC7u (phone/items)"});continue}try{await window.KTM.api.putJSON(`${API_BASE}/api/orders/${encodeURIComponent(f)}`,K,"L\u1ED7i c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i"),l+=1}catch(b){k.push({id:f,error:String((b==null?void 0:b.message)||b||"L\u1ED7i")})}}}finally{we(!1),he("")}if(l>0){F(`\u0110\xE3 c\u1EADp nh\u1EADt ${l} \u0111\u01A1n sang \u0110\xE3 nh\u1EADn ti\u1EC1n`,"success");const h=new Set(r);Le(f=>{if(!f)return f;const L=K=>{if(!K||!h.has(String(K.id)))return K;const b=K.raw?{...K.raw,status:"paid"}:K.raw;return{...K,status:"paid",raw:b}};return{...f,matches:Array.isArray(f.matches)?f.matches.map(K=>({...K,order:L(K==null?void 0:K.order)})):f.matches,systemOnly:Array.isArray(f.systemOnly)?f.systemOnly.map(L):f.systemOnly,moneyMismatch:Array.isArray(f.moneyMismatch)?f.moneyMismatch.map(K=>({...K,order:L(K==null?void 0:K.order)})):f.moneyMismatch}}),S(new Set)}k.length&&(F(`C\xF3 ${k.length} \u0111\u01A1n c\u1EADp nh\u1EADt l\u1ED7i (xem console)`,"warning"),console.warn("Recon paid update failures:",k))};return React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-file-excel me-2 text-success"}),"\u0110\u1ED1i so\xE1t Excel")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"Th\xE1ng m\u1EB7c \u0111\u1ECBnh (n\u1EBFu Excel kh\xF4ng c\xF3 c\u1ED9t ng\xE0y)"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:oe,onChange:r=>J(r.target.value),"aria-label":"Ch\u1ECDn th\xE1ng",disabled:V}))))),React.createElement("div",{className:"card border-0 shadow-sm mb-3"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-2"},React.createElement("div",{className:"fw-semibold"},React.createElement("i",{className:"fas fa-file-excel me-2 text-success"}),"\u0110\u1ED1i so\xE1t c\xF4ng n\u1EE3 (Excel)"),React.createElement("div",{className:"d-flex flex-wrap gap-2 align-items-center"},React.createElement("span",{className:"text-muted small"},"\u0110\u1ED1i so\xE1t theo: ",React.createElement("span",{className:"fw-semibold"},"S\u0110T")," + ",React.createElement("span",{className:"fw-semibold"},"T\u1ED5ng ti\u1EC1n thu h\u1ED9")))),St==="loading"&&React.createElement("div",{className:"alert alert-info mt-3 mb-0"},"\u0110ang t\u1EA3i th\u01B0 vi\u1EC7n \u0111\u1ECDc Excel (XLSX)..."),St==="failed"&&React.createElement("div",{className:"alert alert-warning mt-3 mb-0"},"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c th\u01B0 vi\u1EC7n \u0111\u1ECDc Excel (XLSX). H\xE3y ki\u1EC3m tra m\u1EA1ng / ch\u1EB7n CDN (AdBlock) ho\u1EB7c refresh l\u1EA1i trang."),React.createElement("div",{className:"row g-2 align-items-end mt-2"},React.createElement("div",{className:"col-12 col-md-7"},React.createElement("label",{className:"form-label mb-1"},"Upload file Excel"),React.createElement("input",{type:"file",className:"form-control",accept:".xlsx,.xls,.csv",disabled:V,onChange:async r=>{const l=r.target.files&&r.target.files[0];l&&await pn(l)}}),React.createElement("div",{className:"form-text"},Fe?`File: ${Fe}`:'Header c\u1EA7n c\xF3: "T\u1ED5ng Ti\u1EC1n Thu H\u1ED9". "T\xEAn s\u1EA3n ph\u1EA9m" (n\u1EBFu c\xF3) s\u1EBD gi\xFAp g\u1EE3i \xFD kh\u1EDBp t\u1ED1t h\u01A1n. C\xF3 c\u1ED9t "Ng\xE0y" th\xEC s\u1EBD t\u1EF1 t\u1EA3i \u0111\xFAng th\xE1ng trong file.')),React.createElement("div",{className:"col-12 col-md-5"},React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-md-end"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("label",{className:"form-label mb-0 small text-muted"},"Ng\xE0y theo"),React.createElement("select",{className:"form-select form-select-sm",style:{width:150},value:tt,disabled:V,onChange:r=>jt(r.target.value)},React.createElement("option",{value:"created_at"},"created_at"),React.createElement("option",{value:"updated_at"},"updated_at"))),React.createElement("div",{className:"form-check"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"recon-exc-draft",checked:Ge,disabled:V,onChange:r=>st(!!r.target.checked)}),React.createElement("label",{className:"form-check-label small",htmlFor:"recon-exc-draft"},"B\u1ECF nh\xE1p")),React.createElement("div",{className:"form-check"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"recon-exc-canceled",checked:Ke,disabled:V,onChange:r=>vt(!!r.target.checked)}),React.createElement("label",{className:"form-check-label small",htmlFor:"recon-exc-canceled"},"B\u1ECF h\u1EE7y")),React.createElement("div",{className:"form-check"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"recon-exc-paid",checked:$t,disabled:V,onChange:r=>rn(!!r.target.checked)}),React.createElement("label",{className:"form-check-label small",htmlFor:"recon-exc-paid"},"B\u1ECF \u0111\xE3 nh\u1EADn ti\u1EC1n")),React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("div",{className:"form-check mb-0"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"recon-cod-tol",checked:Ht,disabled:V,onChange:r=>_(!!r.target.checked)}),React.createElement("label",{className:"form-check-label small",htmlFor:"recon-cod-tol"},"Cho l\u1EC7ch COD")),React.createElement("input",{type:"number",className:"form-control form-control-sm",style:{width:110},value:T,min:"0",step:"1000",disabled:V||!Ht,onChange:r=>z(r.target.value)})))),React.createElement("div",{className:"col-12 d-flex gap-2 justify-content-md-end"},React.createElement("button",{className:"btn btn-outline-secondary",disabled:V,onClick:()=>{ke(""),rt(""),Le(null),Ve(""),pt("matches"),_t(""),F("\u0110\xE3 reset \u0111\u1ED1i so\xE1t","info")}},React.createElement("i",{className:"fas fa-rotate-left me-2"}),"Reset"))),Je&&React.createElement("div",{className:"mt-2 small text-muted"},Je),He&&React.createElement("div",{className:"alert alert-danger mt-3 mb-0"},He),ie&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:`alert ${ie.ok?"alert-success":"alert-warning"} mb-3`},ie.ok?React.createElement("div",{className:"fw-semibold"},"OK \u2014 Kh\xF4ng th\u1EA5y \u0111\u01A1n h\u1EC7 th\u1ED1ng b\u1ECB thi\u1EBFu trong Excel ho\u1EB7c l\u1EC7ch ti\u1EC1n."):React.createElement("div",{className:"fw-semibold"},"CH\u01AFA KH\u1EDAP \u2014 C\xF3 \u0111\u01A1n h\u1EC7 th\u1ED1ng thi\u1EBFu trong Excel ho\u1EB7c l\u1EC7ch ti\u1EC1n."),React.createElement("div",{className:"small mt-1"},"Th\xE1ng \u0111\u1ED1i so\xE1t: ",Array.isArray(ie.monthKeys)?ie.monthKeys.join(", "):""," \xB7 Excel: ",ie.excelCount," d\xF2ng",Number(ie.excelGroupCount||0)?` (${ie.excelGroupCount} c\u1EE5m)`:""," \xB7 H\u1EC7 th\u1ED1ng: ",ie.systemCount," \u0111\u01A1n")),React.createElement("div",{className:"d-flex flex-wrap gap-2 align-items-center justify-content-between mb-2"},React.createElement("div",{className:"btn-group btn-group-sm",role:"group","aria-label":"Recon view"},React.createElement("button",{type:"button",className:`btn ${X==="matches"?"btn-success":"btn-outline-success"}`,disabled:!Array.isArray(ie.matches)||ie.matches.length===0,onClick:()=>pt("matches")},"Kh\u1EDBp (",Array.isArray(ie.matches)?ie.matches.length:0,")"),React.createElement("button",{type:"button",className:`btn ${X==="systemOnly"?"btn-warning":"btn-outline-warning"}`,disabled:!Array.isArray(ie.systemOnly)||ie.systemOnly.length===0,onClick:()=>pt("systemOnly")},"Thi\u1EBFu Excel (",Array.isArray(ie.systemOnly)?ie.systemOnly.length:0,")"),React.createElement("button",{type:"button",className:`btn ${X==="moneyMismatch"?"btn-danger":"btn-outline-danger"}`,disabled:!Array.isArray(ie.moneyMismatch)||ie.moneyMismatch.length===0,onClick:()=>pt("moneyMismatch")},"Sai ti\u1EC1n (",Array.isArray(ie.moneyMismatch)?ie.moneyMismatch.length:0,")")),React.createElement("div",{className:"d-flex flex-wrap gap-2 align-items-center"},React.createElement("input",{type:"text",className:"form-control form-control-sm recon-phone-input",placeholder:"L\u1ECDc theo S\u0110T...",value:bt,onChange:r=>_t(r.target.value)}),React.createElement("div",{className:"btn-group btn-group-sm",role:"group","aria-label":"Export CSV"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{var k,h,f,L,K,b,A;const r=Ze(bt),l=[["type","order_id","date","phone","product","cod_excel","cod_system","diff","reason"]];for(const D of Array.isArray(ie.moneyMismatch)?ie.moneyMismatch:[])r&&String(((k=D==null?void 0:D.group)==null?void 0:k.phoneNorm)||"").indexOf(r)<0||l.push(["moneyMismatch",((h=D==null?void 0:D.order)==null?void 0:h.id)||"",String(((f=D==null?void 0:D.group)==null?void 0:f.dateRaw)||""),((L=D==null?void 0:D.group)==null?void 0:L.phone)||"",((K=D==null?void 0:D.group)==null?void 0:K.productDisplay)||"",Number(((b=D==null?void 0:D.group)==null?void 0:b.cod)||0),Number(((A=D==null?void 0:D.order)==null?void 0:A.cod)||0),Number((D==null?void 0:D.diff)||0),String((D==null?void 0:D.reason)||"")]);for(const D of Array.isArray(ie.systemOnly)?ie.systemOnly:[])r&&String((D==null?void 0:D.phoneNorm)||"").indexOf(r)<0||l.push(["systemOnly",(D==null?void 0:D.id)||"",window.KTM.date.formatDateTime(D==null?void 0:D.created_at),(D==null?void 0:D.phone)||"",(D==null?void 0:D.productSummary)||"","",Number((D==null?void 0:D.cod)||0),"",String((D==null?void 0:D.excelOutsideHintText)||"")]);Kt(`recon_${String(B||"").replace(/[^0-9\-]/g,"")}.csv`,l)}},"Export CSV")))),Array.isArray(ie.moneyMismatch)&&ie.moneyMismatch.length>0&&X==="moneyMismatch"&&React.createElement("div",{className:"card border-0 shadow-sm mb-2"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"fw-semibold mb-2 text-danger"},"Sai l\u1EC7ch s\u1ED1 ti\u1EC1n"),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Excel (d\xF2ng)"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"T\xEAn s\u1EA3n ph\u1EA9m (Excel)"),React.createElement("th",{className:"text-end"},"Thu h\u1ED9 (Excel)"),React.createElement("th",null,"Order ID"),React.createElement("th",null,"T\xEAn SP (H\u1EC7 th\u1ED1ng)"),React.createElement("th",{className:"text-end"},"Thu h\u1ED9 (H\u1EC7 th\u1ED1ng)"),React.createElement("th",{className:"text-end"},"L\u1EC7ch"),React.createElement("th",null,"L\xFD do"))),React.createElement("tbody",null,ie.moneyMismatch.filter(r=>{var k;const l=Ze(bt);return l?String(((k=r==null?void 0:r.group)==null?void 0:k.phoneNorm)||"").includes(l):!0}).slice(0,30).map(r=>{var l,k,h,f,L,K,b,A,D,W;return React.createElement("tr",{key:`mm-${String(((l=r==null?void 0:r.group)==null?void 0:l.key)||((k=r==null?void 0:r.order)==null?void 0:k.id)||Math.random())}`,className:"table-danger"},React.createElement("td",null,((h=r==null?void 0:r.group)==null?void 0:h.rowIndexFirst)||"\u2014",Number(((f=r==null?void 0:r.group)==null?void 0:f.rowCount)||0)>1?` (+${Number(r.group.rowCount)-1})`:""),React.createElement("td",{className:"text-muted"},((L=r==null?void 0:r.group)==null?void 0:L.phone)||"\u2014"),React.createElement("td",{style:{minWidth:260}},((K=r==null?void 0:r.group)==null?void 0:K.productDisplay)||"\u2014"),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(Number(((b=r==null?void 0:r.group)==null?void 0:b.cod)||0))),React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",onClick:()=>{xe((r==null?void 0:r.order)||null),Y(!0)}},(A=r==null?void 0:r.order)==null?void 0:A.id)),React.createElement("td",{style:{minWidth:240}},(D=r==null?void 0:r.order)==null?void 0:D.productSummary),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber((W=r==null?void 0:r.order)==null?void 0:W.cod)),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(r==null?void 0:r.diff)),React.createElement("td",{className:"text-muted",style:{minWidth:220}},(r==null?void 0:r.reason)||""))})))),ie.moneyMismatch.length>30&&React.createElement("div",{className:"text-muted small mt-2"},"\u0110ang hi\u1EC3n th\u1ECB 30/",ie.moneyMismatch.length," d\xF2ng.")),React.createElement("div",{className:"d-md-none"},ie.moneyMismatch.filter(r=>{var k;const l=Ze(bt);return l?String(((k=r==null?void 0:r.group)==null?void 0:k.phoneNorm)||"").includes(l):!0}).slice(0,30).map(r=>{var h,f,L,K,b,A,D,W,se,ve,re,De;const l=`${((h=r==null?void 0:r.group)==null?void 0:h.rowIndexFirst)||"\u2014"}${Number(((f=r==null?void 0:r.group)==null?void 0:f.rowCount)||0)>1?` (+${Number(r.group.rowCount)-1})`:""}`,k=String(((L=r==null?void 0:r.group)==null?void 0:L.dateRaw)||((K=r==null?void 0:r.group)==null?void 0:K.dayKey)||"").trim();return React.createElement("div",{key:`mm-m-${String(((b=r==null?void 0:r.group)==null?void 0:b.key)||((A=r==null?void 0:r.order)==null?void 0:A.id)||Math.random())}`,className:"recon-mobile-card recon-mobile-card-danger"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold text-truncate",style:{maxWidth:"70%"}},((D=r==null?void 0:r.group)==null?void 0:D.phone)||"\u2014"),React.createElement("div",{className:"fw-semibold text-danger"},window.KTM.money.formatNumber(r==null?void 0:r.diff))),React.createElement("div",{className:"small text-muted mt-1"},"Excel d\xF2ng ",l,k?` \u2022 ${k}`:""),React.createElement("div",{className:"mt-2"},React.createElement("div",{className:"recon-mobile-kv"},React.createElement("span",{className:"text-muted"},"Thu h\u1ED9 (Excel)"),React.createElement("span",{className:"fw-semibold"},window.KTM.money.formatNumber(Number(((W=r==null?void 0:r.group)==null?void 0:W.cod)||0)))),React.createElement("div",{className:"recon-mobile-value mt-1"},((se=r==null?void 0:r.group)==null?void 0:se.productDisplay)||"\u2014")),React.createElement("div",{className:"mt-2 pt-2 border-top"},React.createElement("div",{className:"recon-mobile-kv"},React.createElement("span",{className:"text-muted"},"Order"),React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",onClick:()=>{xe((r==null?void 0:r.order)||null),Y(!0)}},((ve=r==null?void 0:r.order)==null?void 0:ve.id)||"\u2014")),React.createElement("div",{className:"recon-mobile-value mt-1"},((re=r==null?void 0:r.order)==null?void 0:re.productSummary)||"\u2014"),React.createElement("div",{className:"recon-mobile-kv mt-1"},React.createElement("span",{className:"text-muted"},"Thu h\u1ED9 (H\u1EC7 th\u1ED1ng)"),React.createElement("span",{className:"fw-semibold"},window.KTM.money.formatNumber(Number(((De=r==null?void 0:r.order)==null?void 0:De.cod)||0))))),r!=null&&r.reason?React.createElement("div",{className:"small text-muted mt-2"},"L\xFD do: ",r.reason):null)}),ie.moneyMismatch.length>30&&React.createElement("div",{className:"text-muted small mt-2"},"\u0110ang hi\u1EC3n th\u1ECB 30/",ie.moneyMismatch.length," d\xF2ng.")))),Array.isArray(ie.systemOnly)&&ie.systemOnly.length>0&&X==="systemOnly"&&React.createElement("div",{className:"card border-0 shadow-sm mb-2"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"fw-semibold mb-2 text-warning"},"C\xF3 trong h\u1EC7 th\u1ED1ng nh\u01B0ng thi\u1EBFu trong Excel"),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Order ID"),React.createElement("th",null,"Ng\xE0y t\u1EA1o"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"T\xEAn s\u1EA3n ph\u1EA9m"),React.createElement("th",{className:"text-end"},"Thu h\u1ED9"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"))),React.createElement("tbody",null,ie.systemOnly.filter(r=>{const l=Ze(bt);return l?String((r==null?void 0:r.phoneNorm)||"").includes(l):!0}).slice(0,30).map(r=>React.createElement("tr",{key:`so-${r.id}`,className:"table-warning"},React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",onClick:()=>{xe(r||null),Y(!0)}},r.id)),React.createElement("td",{className:"text-muted"},window.KTM.date.formatDateTime(r.created_at)),React.createElement("td",{className:"text-muted"},r.phone||"\u2014"),React.createElement("td",{style:{minWidth:280}},r.productSummary),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(r.cod)),React.createElement("td",{className:"text-muted"},r.status,r!=null&&r.excelOutsideHintText?React.createElement("div",{className:"small text-muted mt-1"},r.excelOutsideHintText):null)))))),ie.systemOnly.length>30&&React.createElement("div",{className:"text-muted small mt-2"},"\u0110ang hi\u1EC3n th\u1ECB 30/",ie.systemOnly.length," \u0111\u01A1n.")),React.createElement("div",{className:"d-md-none"},ie.systemOnly.filter(r=>{const l=Ze(bt);return l?String((r==null?void 0:r.phoneNorm)||"").includes(l):!0}).slice(0,30).map(r=>React.createElement("div",{key:`so-m-${r.id}`,className:"recon-mobile-card recon-mobile-card-warning"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",onClick:()=>{xe(r||null),Y(!0)}},r.id),React.createElement("span",{className:"badge bg-secondary"},r.status||"\u2014")),React.createElement("div",{className:"small text-muted mt-1"},window.KTM.date.formatDateTime(r.created_at),r.phone?` \u2022 ${r.phone}`:""),React.createElement("div",{className:"recon-mobile-value mt-2"},r.productSummary||"\u2014"),React.createElement("div",{className:"recon-mobile-kv mt-2"},React.createElement("span",{className:"text-muted"},"Thu h\u1ED9"),React.createElement("span",{className:"fw-semibold"},window.KTM.money.formatNumber(r.cod))),r!=null&&r.excelOutsideHintText?React.createElement("div",{className:"small text-muted mt-2"},r.excelOutsideHintText):null)),ie.systemOnly.length>30&&React.createElement("div",{className:"text-muted small mt-2"},"\u0110ang hi\u1EC3n th\u1ECB 30/",ie.systemOnly.length," \u0111\u01A1n.")))),X==="matches"&&Array.isArray(ie.matches)&&ie.matches.length>0&&React.createElement("div",{className:"card border-0 shadow-sm mb-2"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2"},React.createElement("div",{className:"fw-semibold"},"\u0110\u01A1n \u0111\xE3 kh\u1EDBp"),React.createElement("div",{className:"d-flex flex-wrap align-items-center gap-2"},ue?React.createElement("span",{className:"text-muted small"},ue):null,React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",disabled:ye||!(_e&&_e.size),onClick:xn},"\u0110\xE1nh d\u1EA5u \u0111\xE3 nh\u1EADn ti\u1EC1n"))),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",{style:{width:34}},React.createElement("input",{type:"checkbox",checked:(()=>{var k;const r=Ze(bt),l=(ie.matches||[]).filter(h=>{var K;const f=h==null?void 0:h.order;if(!(f!=null&&f.id))return!1;const L=String((f==null?void 0:f.status)||((K=f==null?void 0:f.raw)==null?void 0:K.status)||"").toLowerCase();return!($t&&L==="paid"||r&&!String((f==null?void 0:f.phoneNorm)||"").includes(r))});if(!l.length)return!1;for(const h of l)if(!_e.has(String(((k=h==null?void 0:h.order)==null?void 0:k.id)||"")))return!1;return!0})(),onChange:r=>{const l=!!r.target.checked;S(k=>{var K;const h=new Set(k),f=Ze(bt),L=(ie.matches||[]).filter(b=>{var W;const A=b==null?void 0:b.order;if(!(A!=null&&A.id))return!1;const D=String((A==null?void 0:A.status)||((W=A==null?void 0:A.raw)==null?void 0:W.status)||"").toLowerCase();return!($t&&D==="paid"||f&&!String((A==null?void 0:A.phoneNorm)||"").includes(f))});for(const b of L){const A=String(((K=b==null?void 0:b.order)==null?void 0:K.id)||"").trim();A&&(l?h.add(A):h.delete(A))}return h})}})),React.createElement("th",null,"Order ID"),React.createElement("th",null,"Ng\xE0y"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"Excel"),React.createElement("th",null,"H\u1EC7 th\u1ED1ng"),React.createElement("th",{className:"text-end"},"Thu h\u1ED9"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"))),React.createElement("tbody",null,(ie.matches||[]).filter(r=>{var f;const l=r==null?void 0:r.order;if(!(l!=null&&l.id))return!1;const k=String((l==null?void 0:l.status)||((f=l==null?void 0:l.raw)==null?void 0:f.status)||"").toLowerCase();if($t&&k==="paid")return!1;const h=Ze(bt);return!(h&&!String((l==null?void 0:l.phoneNorm)||"").includes(h))}).slice(0,50).map(r=>{var h,f,L,K;const l=r.order,k=String(l.id);return React.createElement("tr",{key:`match-${k}`},React.createElement("td",null,React.createElement("input",{type:"checkbox",checked:_e.has(k),onChange:b=>{const A=!!b.target.checked;S(D=>{const W=new Set(D);return A?W.add(k):W.delete(k),W})}})),React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",onClick:()=>{xe(l||null),Y(!0)}},k)),React.createElement("td",{className:"text-muted"},window.KTM.date.formatDateTime(l.created_at)),React.createElement("td",{className:"text-muted"},l.phone||"\u2014"),React.createElement("td",{style:{minWidth:240}},((h=r==null?void 0:r.group)==null?void 0:h.productDisplay)||"\u2014"),React.createElement("td",{style:{minWidth:240}},l.productSummary||"\u2014"),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(l.cod)),React.createElement("td",null,React.createElement("span",{className:`badge ${String((l==null?void 0:l.status)||((f=l==null?void 0:l.raw)==null?void 0:f.status)||"").toLowerCase()==="paid"?"bg-primary":"bg-secondary"}`},String((l==null?void 0:l.status)||((L=l==null?void 0:l.raw)==null?void 0:L.status)||"").toLowerCase()==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":(l==null?void 0:l.status)||((K=l==null?void 0:l.raw)==null?void 0:K.status)||"\u2014")))})))),React.createElement("div",{className:"text-muted small mt-2"},"Hi\u1EC3n th\u1ECB t\u1ED1i \u0111a 50 \u0111\u01A1n. D\xF9ng l\u1ECDc S\u0110T \u0111\u1EC3 thu h\u1EB9p.")),React.createElement("div",{className:"d-md-none"},(()=>{const r=(ie.matches||[]).filter(h=>{var b;const f=h==null?void 0:h.order;if(!(f!=null&&f.id))return!1;const L=String((f==null?void 0:f.status)||((b=f==null?void 0:f.raw)==null?void 0:b.status)||"").toLowerCase();if($t&&L==="paid")return!1;const K=Ze(bt);return!(K&&!String((f==null?void 0:f.phoneNorm)||"").includes(K))}).slice(0,50),l=r.map(h=>{var f;return String(((f=h==null?void 0:h.order)==null?void 0:f.id)||"").trim()}).filter(Boolean),k=(()=>{if(!l.length)return!1;for(const h of l)if(!_e.has(h))return!1;return!0})();return React.createElement(React.Fragment,null,React.createElement("div",{className:"d-flex align-items-center justify-content-between mb-2"},React.createElement("label",{className:"d-flex align-items-center gap-2 small mb-0"},React.createElement("input",{type:"checkbox",checked:k,disabled:!l.length,onChange:h=>{const f=!!h.target.checked;S(L=>{const K=new Set(L);for(const b of l)f?K.add(b):K.delete(b);return K})}}),React.createElement("span",null,"Ch\u1ECDn t\u1EA5t c\u1EA3 (\u0111ang hi\u1EC3n th\u1ECB)")),React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",disabled:!l.length,onClick:()=>{S(h=>{const f=new Set(h);for(const L of l)f.delete(L);return f})}},"B\u1ECF ch\u1ECDn")),r.map(h=>{var b,A,D;const f=h==null?void 0:h.order,L=String((f==null?void 0:f.id)||"").trim(),K=String((f==null?void 0:f.status)||((b=f==null?void 0:f.raw)==null?void 0:b.status)||"").toLowerCase();return React.createElement("div",{key:`match-m-${L||String((f==null?void 0:f.created_at)||"")}`,className:"recon-mobile-card recon-mobile-card-success"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"d-flex align-items-center gap-2",style:{minWidth:0}},React.createElement("input",{type:"checkbox",checked:!!L&&_e.has(L),onChange:W=>{const se=!!W.target.checked;S(ve=>{const re=new Set(ve);return L&&(se?re.add(L):re.delete(L)),re})}}),React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none text-truncate",onClick:()=>{xe(f||null),Y(!0)}},L||"\u2014")),React.createElement("span",{className:`badge ${K==="paid"?"bg-primary":"bg-secondary"}`},K==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":(f==null?void 0:f.status)||((A=f==null?void 0:f.raw)==null?void 0:A.status)||"\u2014")),React.createElement("div",{className:"small text-muted mt-1"},window.KTM.date.formatDateTime(f==null?void 0:f.created_at),f!=null&&f.phone?` \u2022 ${f.phone}`:""),React.createElement("div",{className:"recon-mobile-kv mt-2"},React.createElement("span",{className:"text-muted"},"Thu h\u1ED9"),React.createElement("span",{className:"fw-semibold"},window.KTM.money.formatNumber(f==null?void 0:f.cod))),React.createElement("div",{className:"recon-mobile-value mt-2"},React.createElement("span",{className:"text-muted"},"Excel:")," ",((D=h==null?void 0:h.group)==null?void 0:D.productDisplay)||"\u2014"),React.createElement("div",{className:"recon-mobile-value mt-1"},React.createElement("span",{className:"text-muted"},"H\u1EC7 th\u1ED1ng:")," ",(f==null?void 0:f.productSummary)||"\u2014"))}))})(),React.createElement("div",{className:"text-muted small mt-2"},"Hi\u1EC3n th\u1ECB t\u1ED1i \u0111a 50 \u0111\u01A1n. D\xF9ng l\u1ECDc S\u0110T \u0111\u1EC3 thu h\u1EB9p."))))))),React.createElement(AdminDrawer,{open:q,title:de?`Order #${de.id}`:"Order",subtitle:de?`${de.phone||""} \u2022 ${window.KTM.money.formatNumber(Number(de.cod||0))}`:"",onClose:()=>{Y(!1),xe(null)}},de?React.createElement("div",{className:"small"},React.createElement("div",{className:"mb-2"},React.createElement("div",null,React.createElement("span",{className:"text-muted"},"Tr\u1EA1ng th\xE1i:")," ",de.status||"\u2014"),React.createElement("div",null,React.createElement("span",{className:"text-muted"},"created_at:")," ",window.KTM.date.formatDateTime(de.created_at)),React.createElement("div",null,React.createElement("span",{className:"text-muted"},"updated_at:")," ",de.updated_at?window.KTM.date.formatDateTime(de.updated_at):"\u2014"),React.createElement("div",null,React.createElement("span",{className:"text-muted"},"S\u1EA3n ph\u1EA9m:")," ",de.productSummary||"\u2014")),React.createElement("div",{className:"fw-semibold mb-1"},"Line items"),React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"#"),React.createElement("th",null,"product_id"),React.createElement("th",{className:"text-end"},"qty"),React.createElement("th",{className:"text-end"},"price"),React.createElement("th",{className:"text-end"},"total"))),React.createElement("tbody",null,(Array.isArray((mt=de==null?void 0:de.raw)==null?void 0:mt.items)?de.raw.items:[]).map((r,l)=>{var K,b,A,D,W,se;const k=String((b=(K=r==null?void 0:r.product_id)!=null?K:r==null?void 0:r.id)!=null?b:"").trim(),h=Number((D=(A=r==null?void 0:r.qty)!=null?A:r==null?void 0:r.quantity)!=null?D:0)||0,f=Number((se=(W=r==null?void 0:r.price)!=null?W:r==null?void 0:r.unit_price)!=null?se:0)||0,L=h*f;return React.createElement("tr",{key:`li-${l}-${k}`},React.createElement("td",{className:"text-muted"},l+1),React.createElement("td",{className:"text-muted"},k||"\u2014"),React.createElement("td",{className:"text-end"},h),React.createElement("td",{className:"text-end"},window.KTM.money.formatNumber(f)),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(L)))}))))):null))}function AdminApp(){const[P,F]=useState(!1),[B,Ne]=useState(""),[oe,J]=useState(null),[V,Ee]=useState("search"),[He,ke]=useState(()=>loadAdminPins()),[Je,rt]=useState(()=>loadAdminRecent()),[Fe,Ve]=useState(null),[ie,Le]=useState(""),[X,pt]=useState([]),[bt,_t]=useState(null),[Ge,st]=useState(!1),[Ke,vt]=useState(null),[$t,rn]=useState(!0),[tt,jt]=useState([]),[Ht,_]=useState(!1),[T,z]=useState(null),[ye,we]=useState(!1),[ue,he]=useState(!1),[_e,S]=useState(""),[q,Y]=useState(()=>loadAdminSettings()),[de,xe]=useState(null),[$e,Qe]=useState([]);useEffect(()=>{const p=localStorage.getItem("ktm_admin_session");if(p)try{const G=JSON.parse(p);G.expiry>Date.now()?(F(!0),J(G.user)):localStorage.removeItem("ktm_admin_session")}catch(G){localStorage.removeItem("ktm_admin_session")}},[]),useEffect(()=>{P&&Mt()},[P]),useEffect(()=>{const p=()=>{try{const ae=document.querySelector(".admin-topbar");if(!ae)return;const Pe=ae.getBoundingClientRect(),je=Math.max(0,Math.round(Pe.height));document.documentElement.style.setProperty("--ktm-admin-sticky-top",`${je+10}px`)}catch(ae){}};p(),window.addEventListener("resize",p);const G=setTimeout(p,0);return()=>{clearTimeout(G),window.removeEventListener("resize",p)}},[P,V]),useEffect(()=>{var ae,Pe;const p=window.visualViewport,G=()=>{try{const je=Number(window.innerHeight)||0,Ue=Number(p==null?void 0:p.height)||je,xt=Number(p==null?void 0:p.offsetTop)||0,at=Math.max(0,Math.round(je-Ue-xt));document.documentElement.style.setProperty("--ktm-visual-inset-bottom",`${at}px`)}catch(je){}};G(),window.addEventListener("resize",G);try{(ae=p==null?void 0:p.addEventListener)==null||ae.call(p,"resize",G),(Pe=p==null?void 0:p.addEventListener)==null||Pe.call(p,"scroll",G)}catch(je){}return()=>{var je,Ue;window.removeEventListener("resize",G);try{(je=p==null?void 0:p.removeEventListener)==null||je.call(p,"resize",G),(Ue=p==null?void 0:p.removeEventListener)==null||Ue.call(p,"scroll",G)}catch(xt){}}},[]),useEffect(()=>{if(!P)return;const p=ae=>{if(!ae)return!1;const Pe=String(ae.tagName||"").toLowerCase();return!!(Pe==="input"||Pe==="textarea"||Pe==="select"||ae.isContentEditable)},G=ae=>{if(!ae||ae.ctrlKey||ae.metaKey||ae.altKey||p(ae.target))return;const Pe=ae.key;(Pe==="/"||Pe==="N"||Pe==="n"||Pe==="Escape"||Pe==="j"||Pe==="J"||Pe==="k"||Pe==="K")&&(Pe==="/"&&ae.preventDefault(),window.dispatchEvent(new CustomEvent("ktm-admin-hotkey",{detail:{key:Pe}})))};return document.addEventListener("keydown",G),()=>document.removeEventListener("keydown",G)},[P]),useEffect(()=>{P&&rt(p=>{const G=Array.isArray(p)?p:[],ae=[V,...G.filter(Pe=>Pe!==V)].slice(0,8);return saveAdminRecent(ae),ae})},[P]);const Ye=p=>{const G=String(p||"").trim();G&&rt(ae=>{const Pe=Array.isArray(ae)?ae:[],je=[G,...Pe.filter(Ue=>Ue!==G)].slice(0,8);return saveAdminRecent(je),je})},St=p=>{const G=String(p||"").trim();G&&ke(ae=>{const Pe=Array.isArray(ae)?ae:[],Ue=Pe.includes(G)?Pe.filter(xt=>xt!==G):[G,...Pe].slice(0,10);return saveAdminPins(Ue),Ue})};useEffect(()=>{if(!P)return;let p=!1;return(async()=>{try{const G=await fetchAdminSettingsFromServer();if(p)return;Y(G),saveAdminSettings(G)}catch(G){}})(),()=>{p=!0}},[P]);const Et=async(p,G)=>{Ne("");try{const ae=await window.KTM.api.postJSON(`${API_BASE}/api/auth/login`,{username:p,password:G},"\u0110\u0103ng nh\u1EADp th\u1EA5t b\u1EA1i"),Pe={user:ae.user,token:ae.token,expiry:Date.now()+100*365*24*60*60*1e3};localStorage.setItem("ktm_admin_session",JSON.stringify(Pe)),J(ae.user),F(!0)}catch(ae){Ne(ae.message)}},Se=()=>{localStorage.removeItem("ktm_admin_session"),F(!1),J(null),pt([]),_t(null)},nt=(p,G="success",ae=null)=>{const Pe=Date.now()+Math.floor(Math.random()*1e3);if(p&&typeof p=="object"){const Ue=p;jt(xt=>[...xt,{id:Pe,message:String(Ue.message||""),type:String(Ue.type||G||"success"),actionLabel:Ue.actionLabel||null,onAction:typeof Ue.onAction=="function"?Ue.onAction:null,durationMs:Ue.durationMs||null}]);return}const je=ae&&typeof ae=="object"?ae:null;jt(Ue=>[...Ue,{id:Pe,message:String(p||""),type:String(G||"success"),actionLabel:(je==null?void 0:je.actionLabel)||null,onAction:typeof(je==null?void 0:je.onAction)=="function"?je.onAction:null,durationMs:(je==null?void 0:je.durationMs)||null}])},Jt=p=>{jt(G=>G.filter(ae=>ae.id!==p))},Mt=async(p=null)=>{rn(!0);try{const G=p?`${API_BASE}/api/albums?parent_id=${p}`:`${API_BASE}/api/albums?parent_id=root`,ae=await window.KTM.api.getJSON(G,"L\u1ED7i t\u1EA3i danh s\xE1ch album");pt(Array.isArray(ae)?ae:[])}catch(G){console.error(G),nt("L\u1ED7i t\u1EA3i danh s\xE1ch album","danger")}rn(!1)},dn=()=>{vt(null),st(!0)},Ft=p=>{Ze(p),we(!0)},yn=async(p,G="modal")=>{try{const ae=Ke&&Ke.uuid;!ae&&de&&(p.parent_id=de.uuid);const Pe=ae?`${API_BASE}/api/albums/${Ke.uuid||Ke.id}`:`${API_BASE}/api/albums`;ae?await window.KTM.api.putJSON(Pe,p,"L\u1ED7i c\u1EADp nh\u1EADt"):await window.KTM.api.postJSON(Pe,p,"L\u1ED7i t\u1EA1o"),nt(ae?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"T\u1EA1o th\xE0nh c\xF4ng!","success"),G==="drawer"?(we(!1),vt(null),Mt(de==null?void 0:de.uuid),ae&&T&&z({...T,...p})):(st(!1),vt(null),Mt(de==null?void 0:de.uuid))}catch(ae){nt(ae.message,"danger")}},vn=p=>{_t(p)},E=p=>{if(p==="root")Qe([]),xe(null),Mt(null);else if(p){const G=$e.findIndex(ae=>ae.uuid===p.uuid);G>=0&&(Qe($e.slice(0,G+1)),xe(p),Mt(p.uuid))}else{const G=[...$e];G.pop();const ae=G[G.length-1]||null;Qe(G),xe(ae),Mt(ae==null?void 0:ae.uuid)}},ce=async p=>{const G=`X\xF3a folder "${p.title}"? T\u1EA5t c\u1EA3 folder con v\xE0 \u1EA3nh b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`;if(confirm(G))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${p.uuid||p.id}`,"L\u1ED7i x\xF3a album"),nt("\u0110\xE3 x\xF3a","success"),Mt(de==null?void 0:de.uuid)}catch(ae){nt("L\u1ED7i x\xF3a album","danger")}},Ze=async p=>{p&&(_(!0),S(""),he(!1),we(!1),z(p))},Kt=()=>{_(!1),he(!1),S(""),we(!1),z(null)},mn=p=>{we(!0)};if(!P)return React.createElement(LoginPage,{onLogin:Et,error:B});const Xt=()=>{const p=new Date,G=p.getFullYear(),ae=String(p.getMonth()+1).padStart(2,"0");return`${G}-${ae}`};function Ut(){const[p,G]=useState(()=>{var Ue;return String((Ue=q==null?void 0:q.ship_percent)!=null?Ue:DEFAULT_SHIP_PERCENT)}),[ae,Pe]=useState(!1);return useEffect(()=>{var Ue;G(String((Ue=q==null?void 0:q.ship_percent)!=null?Ue:DEFAULT_SHIP_PERCENT))},[q==null?void 0:q.ship_percent]),React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-cog me-2 text-warning"}),"C\xE0i \u0111\u1EB7t")),React.createElement("div",{className:"card p-3"},React.createElement("form",{onSubmit:async Ue=>{Ue.preventDefault(),Pe(!0);const xt=saveAdminSettings({ship_percent:p});try{const at=await saveAdminSettingsToServer(xt);Y(at),saveAdminSettings(at),nt("\u0110\xE3 l\u01B0u c\xE0i \u0111\u1EB7t v\xE0o DB","success")}catch(at){Y(xt),nt("Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c DB, \u0111\xE3 l\u01B0u t\u1EA1m tr\xEAn m\xE1y","warning")}finally{Pe(!1)}}},React.createElement("div",{className:"mb-2 text-muted small"},"\xC1p d\u1EE5ng cho th\u1ED1ng k\xEA hoa h\u1ED3ng khi \u0111\u01A1n h\xE0ng kh\xF4ng ghi ph\xED ship trong ghi ch\xFA s\u1EA3n ph\u1EA9m."),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ph\xED ship (%) khi kh\xF4ng c\xF3 ship"),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",value:p,min:"0",max:"100",step:"0.01",onChange:Ue=>G(Ue.target.value)}),React.createElement("span",{className:"input-group-text"},"%")),React.createElement("div",{className:"form-text"},"M\u1EB7c \u0111\u1ECBnh: ",DEFAULT_SHIP_PERCENT,"%")),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:ae},ae?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u c\xE0i \u0111\u1EB7t"))))}function H(){const[p,G]=useState(Xt()),[ae,Pe]=useState(!0),je=useRef(null),Ue=useRef(null),[xt,at]=useState(0),[un,Vt]=useState(!1),on=useRef(0),Nn=()=>({statusCounts:{draft:0,pending:0,processing:0,done:0,paid:0,canceled:0,other:0},activeOrders:0,totalQty:0,totalRevenue:0,doneRevenue:0,tempCommission:0,tempCommissionAll:0,products:[],customers:[],days:[],uniqueCustomers:0,avgOrderValue:0,avgQtyPerOrder:0}),[it,pn]=useState(Nn),In=useRef(new Map),xn=normalizeShipPercent(q==null?void 0:q.ship_percent),{formatNumber:mt,formatVND:r}=window.KTM.money,l=async(O,me=!1)=>{var It,tn;const Xe=String(O||"").trim();if(!Xe)return Nn();const ft=`${Xe}|${xn}`,Ct=(It=In.current)==null?void 0:It.get(ft);if(!me&&Ct)return Ct;const Yt=`${API_BASE}/api/orders?resource=stats&month=${encodeURIComponent(Xe)}&ship_percent=${encodeURIComponent(xn)}`,wt=await window.KTM.api.getJSON(Yt,"L\u1ED7i t\u1EA3i th\u1ED1ng k\xEA"),Lt=wt!=null&&wt.stats&&(wt!=null&&wt.meta)?wt.stats:wt,Qt=Lt&&typeof Lt=="object"?Lt:Nn();return(tn=In.current)==null||tn.set(ft,Qt),Qt},k=async(O=!1)=>{Pe(!0);try{const me=await l(p,O);pn(me)}catch(me){console.error("Load stats error:",me),pn(Nn())}finally{Pe(!1)}};useEffect(()=>{k()},[p,xn]);const h=(O,me)=>{const Xe=String(O||"").trim(),ft=Xe.match(/^(\d{4})-(\d{2})$/);if(!ft)return Xe;const Ct=Number(ft[1]),Yt=Number(ft[2])-1,wt=new Date(Ct,Yt,1);wt.setMonth(wt.getMonth()+Number(me||0));const Lt=wt.getFullYear(),Qt=String(wt.getMonth()+1).padStart(2,"0");return`${Lt}-${Qt}`},f=Xt(),L=h(f,-5),K=O=>{const me=String(O||"").trim();return me?me>=L&&me<=f:!1},b=O=>{const me=String(O||"").trim();return me&&(me<L?L:me>f?f:me)},A=O=>{const me=Date.now();me-Number(on.current||0)<1200||(on.current=me,nt(O==="future"?"Kh\xF4ng xem \u0111\u01B0\u1EE3c th\xE1ng t\u01B0\u01A1ng lai":"Ch\u1EC9 xem t\u1ED1i \u0111a 5 th\xE1ng g\u1EA7n nh\u1EA5t","warning"))},D=(O,me,Xe)=>Math.max(me,Math.min(Xe,O)),W=()=>{var O;return Math.max(320,Number((O=Ue.current)==null?void 0:O.clientWidth)||360)},se=()=>{const O=W();return D(Math.floor(O*.35),110,180)},ve=()=>{const O=W();return D(Math.floor(O*.22),70,140)},re=O=>{try{if(!(O!=null&&O.touches)||O.touches.length!==1||un)return;const me=O.target;if(me&&typeof me.closest=="function"&&me.closest('input, textarea, select, button, a, [role="button"], [contenteditable="true"], .dropdown-menu, .modal')){je.current=null;return}const Xe=O.touches[0];je.current={x:Xe.clientX,y:Xe.clientY,at:Date.now(),swiping:!1}}catch(me){je.current=null}},De=O=>{const me=je.current;if(!me||un)return;const Xe=(O==null?void 0:O.touches)&&O.touches[0];if(!Xe)return;const ft=Xe.clientX-me.x,Ct=Xe.clientY-me.y,Yt=Math.abs(ft),wt=Math.abs(Ct);if(!me.swiping)if(Yt>12&&Yt>wt*1.2)me.swiping=!0,Vt(!1);else return;const Lt=se();at(D(ft,-Lt,Lt))},Ie=O=>{const me=je.current;if(je.current=null,!me||un||!me.swiping){at(0);return}const Xe=(O==null?void 0:O.changedTouches)&&O.changedTouches[0];if(!Xe)return;const ft=Xe.clientX-me.x,Ct=Xe.clientY-me.y,Yt=Date.now()-me.at,wt=Math.abs(ft),Lt=Math.abs(Ct);if(Yt>1e3)return;if(wt<30){at(0);return}if(wt<Lt*1.5)return;const Qt=ve(),It=wt>=Qt,tn=ft>0?1:-1;if(!It){Vt(!0),at(0),setTimeout(()=>Vt(!1),220);return}const fn=tn>0?-1:1,ee=h(p,fn);if(!K(ee)){Vt(!0),at(tn*Math.floor(se()*.55)),setTimeout(()=>{at(0),setTimeout(()=>Vt(!1),200)},140),A(ee>f?"future":"past");return}Vt(!0),at(tn*se()),setTimeout(()=>{G(s=>h(s,fn)),at(-tn*se()),requestAnimationFrame(()=>{requestAnimationFrame(()=>{at(0),setTimeout(()=>Vt(!1),220)})})},140)},We=()=>{je.current=null,at(0)},Ce=O=>{var me,Xe;try{if(!O||O.pointerType==="touch"||typeof O.button=="number"&&O.button!==0||un)return;const ft=O.target;if(ft&&typeof ft.closest=="function"&&ft.closest('input, textarea, select, button, a, [role="button"], [contenteditable="true"], .dropdown-menu, .modal')){je.current=null;return}je.current={x:O.clientX,y:O.clientY,at:Date.now(),swiping:!1};try{(Xe=(me=O.currentTarget)==null?void 0:me.setPointerCapture)==null||Xe.call(me,O.pointerId)}catch(Ct){}}catch(ft){je.current=null}},ut=O=>{try{if(!O||O.pointerType==="touch")return;const me=je.current;if(!me||un)return;const Xe=O.clientX-me.x,ft=O.clientY-me.y,Ct=Math.abs(Xe),Yt=Math.abs(ft);if(!me.swiping)if(Ct>12&&Ct>Yt*1.2)me.swiping=!0,Vt(!1);else return;const wt=se();at(D(Xe,-wt,wt))}catch(me){}},pe=O=>{try{if(!O||O.pointerType==="touch")return;const me=je.current;if(je.current=null,!me||un||!me.swiping){at(0);return}const Xe=O.clientX-me.x,ft=O.clientY-me.y,Ct=Date.now()-me.at,Yt=Math.abs(Xe),wt=Math.abs(ft);if(Ct>1e3)return;if(Yt<30){at(0);return}if(Yt<wt*1.5)return;const Lt=ve(),Qt=Yt>=Lt,It=Xe>0?1:-1;if(!Qt){Vt(!0),at(0),setTimeout(()=>Vt(!1),220);return}const tn=It>0?-1:1,fn=h(p,tn);if(!K(fn)){Vt(!0),at(It*Math.floor(se()*.55)),setTimeout(()=>{at(0),setTimeout(()=>Vt(!1),200)},140),A(fn>f?"future":"past");return}Vt(!0),at(It*se()),setTimeout(()=>{G(ee=>h(ee,tn)),at(-It*se()),requestAnimationFrame(()=>{requestAnimationFrame(()=>{at(0),setTimeout(()=>Vt(!1),220)})})},140)}catch(me){je.current=null}},ze=()=>{je.current=null,at(0)},Dt=xt>0?"Th\xE1ng tr\u01B0\u1EDBc":xt<0?"Th\xE1ng sau":"",kt=xt>0?h(p,-1):xt<0?h(p,1):"",Nt=kt&&K(kt)?kt:"",Be=Math.min(1,Math.abs(xt)/Math.max(1,ve()));return React.createElement("div",{className:"product-manager pb-5 mb-4 stats-manager",ref:Ue,style:{touchAction:"pan-y",transform:`translateX(${xt}px)`,transition:un?"transform 220ms ease":"none",willChange:"transform"},onTouchStartCapture:re,onTouchMoveCapture:De,onTouchEndCapture:Ie,onTouchCancelCapture:We,onPointerDown:Ce,onPointerMove:ut,onPointerUp:pe,onPointerCancel:ze},!!Dt&&React.createElement("div",{"aria-hidden":"true",style:{position:"fixed",left:0,right:0,top:84,zIndex:1060,pointerEvents:"none",opacity:.15+.55*Be,transform:"translateZ(0)"}},React.createElement("div",{className:"d-flex justify-content-center"},React.createElement("div",{className:"px-3 py-2 rounded-pill bg-dark text-white shadow-sm",style:{fontSize:13}},xt>0?"\u2190":"\u2192"," ",Dt," \xB7 ",Nt))),React.createElement(Loading,{show:ae}),React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-chart-column me-2 text-warning"}),"Th\u1ED1ng k\xEA"),React.createElement("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>k(!0),disabled:ae},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"Ch\u1ECDn th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:p,onChange:O=>G(O.target.value),"aria-label":"Ch\u1ECDn th\xE1ng"}))),React.createElement("div",{className:"col-12 col-md-7 d-flex gap-2 justify-content-md-end"},React.createElement("div",{className:"d-flex flex-wrap gap-2 align-self-center"},React.createElement("span",{className:"badge rounded-pill bg-secondary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-truck me-1"}),"Ship \u01B0\u1EDBc t\xEDnh: ",xn,"%"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-receipt me-1"}),mt(it.activeOrders)," \u0111\u01A1n"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-user me-1"}),mt(it.uniqueCustomers)," kh\xE1ch"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-boxes-stacked me-1"}),mt(it.totalQty)," SL"),React.createElement("span",{className:"badge rounded-pill bg-primary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-hand-holding-dollar me-1"}),"\u0110\xE3 nh\u1EADn ti\u1EC1n: ",mt(it.statusCounts.paid),"/",mt(it.statusCounts.done)))))),React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng \u0111\u01A1n (kh\xF4ng t\xEDnh h\u1EE7y/nh\xE1p)"),React.createElement("i",{className:"fas fa-receipt text-dark"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},mt(it.activeOrders)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (t\u1EA1m t\xEDnh)"),React.createElement("i",{className:"fas fa-sack-dollar text-warning"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},r(it.totalRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (Ho\xE0n th\xE0nh)"),React.createElement("i",{className:"fas fa-circle-check text-success"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},r(it.doneRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-info bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng s\u1EBD nh\u1EADn (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-chart-line text-info"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},r(it.tempCommission)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng t\u1ED5ng (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-coins text-primary"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},r(it.tempCommissionAll))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-layer-group me-2 text-warning"}),"T\u1ED5ng quan tr\u1EA1ng th\xE1i"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},"SL TB/\u0111\u01A1n: ",it.avgQtyPerOrder?it.avgQtyPerOrder.toFixed(2):"0.00")),React.createElement("div",{className:"d-md-none mt-2"},React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-light bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Nh\xE1p"),React.createElement("div",{className:"fw-semibold"},mt(it.statusCounts.draft)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-secondary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("div",{className:"fw-semibold"},mt(it.statusCounts.pending)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("div",{className:"fw-semibold"},mt(it.statusCounts.processing)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-danger bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"H\u1EE7y \u0111\u01A1n"),React.createElement("div",{className:"fw-semibold"},mt(it.statusCounts.canceled)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh"),React.createElement("div",{className:"fw-semibold"},mt(it.statusCounts.done)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("div",{className:"fw-semibold"},mt(it.statusCounts.paid)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng SL"),React.createElement("div",{className:"fw-semibold"},mt(it.totalQty)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Nh\xE1p"),React.createElement("th",null,"Ch\u1EDD x\u1EED l\xFD"),React.createElement("th",null,"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("th",null,"H\u1EE7y \u0111\u01A1n"),React.createElement("th",null,"Ho\xE0n th\xE0nh"),React.createElement("th",null,"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("th",null,"Kh\xE1c"),React.createElement("th",null,"T\u1ED5ng SL"))),React.createElement("tbody",null,React.createElement("tr",null,React.createElement("td",null,mt(it.statusCounts.draft)),React.createElement("td",null,mt(it.statusCounts.pending)),React.createElement("td",null,mt(it.statusCounts.processing)),React.createElement("td",null,mt(it.statusCounts.canceled)),React.createElement("td",null,mt(it.statusCounts.done)),React.createElement("td",null,mt(it.statusCounts.paid)),React.createElement("td",null,mt(it.statusCounts.other)),React.createElement("td",null,mt(it.totalQty))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-box me-2 text-info"}),"Top s\u1EA3n ph\u1EA9m"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},it.products.slice(0,10).map(O=>React.createElement("div",{key:O.product_id,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-info"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},O.product_name),React.createElement("div",{className:"text-muted small text-truncate"},O.product_code?`#${O.product_code} \u2022 `:"",mt(O.orders)," \u0111\u01A1n \u2022 ",mt(O.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},r(O.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"M\xE3"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,it.products.slice(0,10).map(O=>React.createElement("tr",{key:O.product_id},React.createElement("td",null,O.product_name),React.createElement("td",null,O.product_code||"\u2014"),React.createElement("td",null,mt(O.orders)),React.createElement("td",null,mt(O.quantity)),React.createElement("td",{className:"fw-semibold"},r(O.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-user-group me-2 text-warning"}),"Top kh\xE1ch h\xE0ng"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},it.customers.slice(0,10).map(O=>React.createElement("div",{key:O.key,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-warning"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},O.customer_name||"\u2014"),React.createElement("div",{className:"text-muted small text-truncate"},O.phone||"\u2014"," \u2022 ",mt(O.orders)," \u0111\u01A1n \u2022 ",mt(O.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},r(O.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,it.customers.slice(0,10).map(O=>React.createElement("tr",{key:O.key},React.createElement("td",null,O.customer_name||"\u2014"),React.createElement("td",null,O.phone||"\u2014"),React.createElement("td",null,mt(O.orders)),React.createElement("td",null,mt(O.quantity)),React.createElement("td",{className:"fw-semibold"},r(O.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3 mb-4"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-calendar-day me-2 text-success"}),"Theo ng\xE0y"),React.createElement("span",{className:"badge rounded-pill bg-success bg-opacity-10 text-dark"},"DT (t\u1EA1m t\xEDnh) & ho\xE0n th\xE0nh")),React.createElement("div",{className:"d-md-none mt-2"},it.days.map(O=>React.createElement("div",{key:O.day,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-success"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"fw-semibold"},O.day),React.createElement("div",{className:"text-muted small"},mt(O.orders)," \u0111\u01A1n \u2022 ",mt(O.quantity)," SL"),React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh: ",mt(O.doneOrders)," \u2022 ",r(O.doneRevenue))),React.createElement("div",{className:"fw-semibold text-nowrap"},r(O.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Ng\xE0y"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"DT (t\u1EA1m t\xEDnh)"),React.createElement("th",null,"\u0110\u01A1n ho\xE0n th\xE0nh"),React.createElement("th",null,"DT ho\xE0n th\xE0nh"))),React.createElement("tbody",null,it.days.map(O=>React.createElement("tr",{key:O.day},React.createElement("td",null,O.day),React.createElement("td",null,mt(O.orders)),React.createElement("td",null,mt(O.quantity)),React.createElement("td",{className:"fw-semibold"},r(O.revenue)),React.createElement("td",null,mt(O.doneOrders)),React.createElement("td",{className:"fw-semibold"},r(O.doneRevenue)))))))))}return React.createElement("div",null,React.createElement(Sidebar,{activeMenu:V,onMenuChange:p=>{Ye(p),Ee(p),p==="albums"&&(xe(null),Qe([]),Mt(null))},onLogout:Se,currentUser:oe,pinnedMenus:He,recentMenus:Je,onTogglePin:St}),React.createElement("div",{className:"main-content"},React.createElement("header",{className:"admin-topbar",role:"banner"},(()=>{const G={search:{title:"Tra c\u1EE9u",icon:"fa-search",sub:"T\xECm nhanh s\u1EA3n ph\u1EA9m/kh\xE1ch/\u0111\u01A1n"},albums:{title:"Album",icon:"fa-images",sub:"Qu\u1EA3n l\xFD \u1EA3nh & folder"},videos:{title:"Video",icon:"fa-video",sub:"Qu\u1EA3n l\xFD video & folder"},products:{title:"S\u1EA3n ph\u1EA9m",icon:"fa-box",sub:"Danh s\xE1ch, gi\xE1, m\xF4 t\u1EA3"},orders:{title:"\u0110\u01A1n h\xE0ng",icon:"fa-receipt",sub:"T\u1EA1o & theo d\xF5i tr\u1EA1ng th\xE1i"},recon:{title:"\u0110\u1ED1i so\xE1t Excel",icon:"fa-file-excel",sub:"\u0110\u1ED1i so\xE1t c\xF4ng n\u1EE3 t\u1EEB Excel"},stats:{title:"Th\u1ED1ng k\xEA",icon:"fa-chart-column",sub:"Doanh thu & hoa h\u1ED3ng"},settings:{title:"C\xE0i \u0111\u1EB7t",icon:"fa-cog",sub:"Tu\u1EF3 ch\u1EC9nh h\u1EC7 th\u1ED1ng"}}[V]||{title:"KTM Admin",icon:"fa-tractor",sub:""},ae=(oe==null?void 0:oe.username)||(oe==null?void 0:oe.name)||(oe==null?void 0:oe.email)||"Admin",Pe=(()=>{if(V!=="albums")return"";const je=[];return je.push("Root"),Array.isArray($e)&&$e.length>0&&je.push(...$e.map(Ue=>Ue==null?void 0:Ue.title).filter(Boolean)),bt!=null&&bt.title&&je.push(bt.title),je.length>0?je.join(" / "):""})();return React.createElement("div",{className:"admin-topbar-inner"},React.createElement("div",{className:"admin-topbar-left"},React.createElement("div",{className:"admin-page-icon","aria-hidden":"true"},React.createElement("i",{className:`fas ${G.icon}`})),React.createElement("div",{className:"admin-page-title"},React.createElement("div",{className:"admin-page-heading"},G.title),React.createElement("div",{className:"admin-page-subtitle"},Pe||G.sub))),React.createElement("div",{className:"admin-topbar-right"},V==="albums"&&React.createElement("button",{className:"btn btn-warning btn-sm admin-topbar-action",onClick:dn,title:"T\u1EA1o folder"},React.createElement("i",{className:"fas fa-plus me-2"}),React.createElement("span",{className:"d-none d-sm-inline"},"Folder")),React.createElement("a",{href:"/",className:"btn btn-outline-secondary btn-sm d-none d-md-inline-flex",title:"V\u1EC1 trang ch\u1EE7"},React.createElement("i",{className:"fas fa-home me-2"}),"Trang ch\u1EE7"),React.createElement("div",{className:"admin-user-chip",title:ae},React.createElement("i",{className:"fas fa-user-circle"}),React.createElement("span",{className:"admin-user-chip-name"},ae)),React.createElement("button",{className:"btn btn-outline-danger btn-sm d-md-none",onClick:Se,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"}))))})()),React.createElement("div",{className:"admin-page-body"},V==="albums"&&!bt&&React.createElement(AlbumList,{albums:X,loading:$t,currentFolder:de,breadcrumb:$e,onSelect:vn,onCreate:dn,onEdit:Ft,onDelete:ce,onBack:E}),V==="search"&&React.createElement(SearchCenter,{showToast:nt,onNavigate:(p,G,ae)=>{Ee(p),p==="orders"&&G==="create"&&(Ve(Date.now()),Le((ae==null?void 0:ae.productId)||""))}}),V==="albums"&&bt&&React.createElement(AlbumDetail,{album:bt,parentAlbum:$e.length>0?$e[$e.length-1]:null,onBack:()=>{if(bt.parentId){const p=$e.findIndex(G=>G.uuid===bt.parentId);p>=0?_t($e[p]):_t(null)}else _t(null)},onRefresh:()=>Mt(de==null?void 0:de.uuid),showToast:nt,onNavigateToFolder:p=>{Qe(G=>[...G,bt]),_t(p)},onEditSubfolder:p=>{vt(p),st(!0)}}),V==="videos"&&React.createElement(VideoList,{showToast:nt}),V==="products"&&React.createElement(ProductManager,{showToast:nt,settings:q}),V==="orders"&&React.createElement(OrderManager,{autoOpenCreateToken:Fe,autoOpenCreateProductId:ie,showToast:nt}),V==="recon"&&React.createElement(ReconExcelManager,{showToast:nt}),V==="stats"&&React.createElement(H,null),V==="settings"&&React.createElement(Ut,null))),React.createElement("nav",{className:"mobile-bottom-nav"},React.createElement("div",{className:"nav-items"},React.createElement("a",{href:"#",className:`nav-item ${V==="search"?"active":""}`,onClick:p=>{p.preventDefault(),Ee("search")}},React.createElement("i",{className:"fas fa-search"}),React.createElement("span",null,"Tra c\u1EE9u")),React.createElement("a",{href:"#",className:`nav-item ${V==="albums"?"active":""}`,onClick:p=>{p.preventDefault(),Ee("albums"),_t(null)}},React.createElement("i",{className:"fas fa-images"}),React.createElement("span",null,"Album")),React.createElement("a",{href:"#",className:`nav-item ${V==="videos"?"active":""}`,onClick:p=>{p.preventDefault(),Ee("videos")}},React.createElement("i",{className:"fas fa-video"}),React.createElement("span",null,"Video")),React.createElement("a",{href:"#",className:`nav-item ${V==="products"?"active":""}`,onClick:p=>{p.preventDefault(),Ee("products")}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",null,"S\u1EA3n ph\u1EA9m")),React.createElement("a",{href:"#",className:`nav-item ${V==="orders"?"active":""}`,onClick:p=>{p.preventDefault(),Ee("orders")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",null,"\u0110\u01A1n h\xE0ng")),React.createElement("a",{href:"#",className:`nav-item ${V==="recon"?"active":""}`,onClick:p=>{p.preventDefault(),Ee("recon")}},React.createElement("i",{className:"fas fa-file-excel"}),React.createElement("span",null,"\u0110\u1ED1i so\xE1t")),React.createElement("a",{href:"#",className:`nav-item ${V==="stats"?"active":""}`,onClick:p=>{p.preventDefault(),Ee("stats")}},React.createElement("i",{className:"fas fa-chart-column"}),React.createElement("span",null,"Th\u1ED1ng k\xEA")))),React.createElement(AlbumModal,{show:Ge,album:Ke,parentId:de==null?void 0:de.uuid,onClose:()=>st(!1),onSave:yn}),React.createElement(AdminDrawer,{open:Ht,title:T?T.title:"Album",subtitle:T?`${T.subfolderCount||0} subfolder \u2022 ${T.count||0} \u1EA3nh`:"",onClose:Kt,footer:ye?React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{we(!1)}},React.createElement("i",{className:"fas fa-xmark me-2"}),"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-warning fw-semibold",onClick:()=>{T&&(vt(T),yn({slug:T.id||"",title:T.title||"",description:T.description||"",cover_url:T.cover||"",parent_id:T.parentId||null},"drawer"))}},React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u")):T?React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{window.KTM.clipboard.writeText(T.title),nt("\u0110\xE3 copy t\xEAn folder","success")}},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy"),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>mn(T)},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>{T&&confirm(`X\xF3a folder "${T.title}"?`)&&(ce(T),Kt())}},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a"))):null},ye&&T?React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-pen me-2 text-warning"}),"Ch\u1EC9nh s\u1EEDa"),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:T.title,onChange:p=>z({...T,title:p.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:T.description,onChange:p=>z({...T,description:p.target.value})}))):T?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"Th\xF4ng tin"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"T\xEAn"),React.createElement("div",{className:"v"},T.title),React.createElement("div",{className:"k"},"Slug"),React.createElement("div",{className:"v font-monospace"},T.id),React.createElement("div",{className:"k"},"Subfolder"),React.createElement("div",{className:"v"},T.subfolderCount||0),React.createElement("div",{className:"k"},"\u1EA2nh"),React.createElement("div",{className:"v"},T.count||0))),T.description&&React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-note-sticky me-2 text-secondary"}),"M\xF4 t\u1EA3"),React.createElement("p",null,T.description))):React.createElement("div",{className:"text-muted"},"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u")),React.createElement("div",{className:"toast-container"},tt.map(p=>React.createElement(Toast,{key:p.id,message:p.message,type:p.type,actionLabel:p.actionLabel,onAction:p.onAction,durationMs:p.durationMs,onClose:()=>Jt(p.id)}))))}ReactDOM.render(React.createElement(AdminApp,null),document.getElementById("root"));function OrderManager({autoOpenCreateToken:P,autoOpenCreateProductId:F,showToast:B}){const[Ne,oe]=useState([]),[J,V]=useState(0),[Ee,He]=useState(!1),[ke,Je]=useState(!1),[rt,Fe]=useState([]),[Ve,ie]=useState(!0),[Le,X]=useState(!1),[pt,bt]=useState([]),[_t,Ge]=useState(!1),[st,Ke]=useState(""),[vt,$t]=useState([]),[rn,tt]=useState(!1),[jt,Ht]=useState(""),[_,T]=useState(!1),[z,ye]=useState(null),[we,ue]=useState(null),[he,_e]=useState(!1),[S,q]=useState(()=>{const e=new Date,n=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0");return`${n}-${t}`}),[Y,de]=useState(""),[xe,$e]=useState(!1),[Qe,Ye]=useState(!1),[St,Et]=useState(!1),[Se,nt]=useState(null),[Jt,Mt]=useState(!1),[dn,Ft]=useState(""),[yn,vn]=useState(!1),E=useRef(0),[ce,Ze]=useState(!1),[Kt,mn]=useState(null),[Xt,Ut]=useState(!1),[H,p]=useState(null),[G,ae]=useState(()=>({left:12,top:12,placement:"bottom"})),Pe=useRef(null),je=useRef(!1),Ue=useRef({active:!1,id:null,startX:0,startY:0,dx:0,dy:0,lock:null,pointerId:null,captured:!1}),[xt,at]=useState(()=>({id:null,dir:null})),un=useRef(!1),Vt=useRef(new Map),on=useRef(null),Nn=useRef(null),it="ktm_orders_status_sync_queue_v1",pn=useRef([]),In=useRef(!1),[xn,mt]=useState(()=>({})),[r,l]=useState(!1),[k,h]=useState(!1),[f,L]=useState(!1),[K,b]=useState(()=>new Set),[A,D]=useState(()=>({})),W="ktm_orders_pinned_v1",[se,ve]=useState(()=>new Set),[re,De]=useState(!1),[Ie,We]=useState(!1),[Ce,ut]=useState(!1),[pe,ze]=useState(""),[Dt,kt]=useState(()=>[]),Nt=useRef(null),Be=useRef(null),O=useRef(!1),me=useRef({active:!1,startY:0,startX:0,fired:!1}),[Xe,ft]=useState(()=>{try{return((window==null?void 0:window.innerWidth)||1024)<768}catch(e){return!1}}),Ct=24,Yt=20,[wt,Lt]=useState(Ct),Qt=useRef(null),It=useRef(null),tn=useRef(!1),fn=useRef(new Map),ee=useRef({timer:null,events:[]}),s=useRef(null),m="ktm_orders_phone_tip_v1",c="ktm_orders_search_history_v1",[x,R]=useState(null),[w,N]=useState(!1),[U,le]=useState([]),[Q,te]=useState(!1),[Oe,Ae]=useState([]),[y,ge]=useState({customer_name:"",phone:"",address:"",note:"",items:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:[{amount:"",note:""}],adjustment_amount:0,adjustment_note:"",status:"pending"}),[fe,ot]=useState([""]),[ct,At]=useState(null),Zt=useRef({}),[zt,Wt]=useState([]),[yt,nn]=useState(null),hn=useRef(null),cn=useRef(null),Z=useRef(0),ne=useRef(null),be=useRef(0),qe=useRef(new Map),Re=useRef(null),Me=useRef(0),ht=useRef(new Map),lt=useRef(new Map),Tt=useRef(""),en=useRef(null),ln=useRef(null),kn=useRef(0),Mn=useRef(null),An=9,Tn=150,Rn=250,Kn=3*60*1e3,On=24*60*60*1e3,Gn=5*60*1e3,Bn="ktm_customer_lookup_cache_v1",ka=200,Pn=3,Jn=3,Xa=1,tr=24*60*60*1e3,nr=120,ar=5*60*1e3,cs=80,ls=2,ds=4,ms=60,et=React.useMemo(()=>String(st||"").trim().length>0,[st]),ua=React.useMemo(()=>[{value:"draft",label:"\u0110\u01A1n nh\xE1p"},{value:"pending",label:"Ch\u1EDD x\u1EED l\xFD"},{value:"processing",label:"\u0110ang v\u1EADn chuy\u1EC3n"},{value:"done",label:"Ho\xE0n th\xE0nh"},{value:"paid",label:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},{value:"canceled",label:"H\u1EE7y \u0111\u01A1n"}],[]),us=e=>{mn(e),Ze(!0)},ps=(e,n)=>{var t,a,i,o;try{const g=(t=n==null?void 0:n.getBoundingClientRect)==null?void 0:t.call(n),u=window.innerWidth||360,$=window.innerHeight||640,v=230,C=280,I=Math.min(Math.max(10,Math.round((a=g==null?void 0:g.left)!=null?a:10)),Math.max(10,u-v-10));let d=Math.round(((i=g==null?void 0:g.bottom)!=null?i:10)+8),j="bottom";d+C>$-10&&(d=Math.max(10,Math.round(((o=g==null?void 0:g.top)!=null?o:10)-8-C)),j="top"),ae({left:I,top:d,placement:j})}catch(g){ae({left:12,top:12,placement:"bottom"})}p(e),Ut(!0)},Un=()=>{Ut(!1),setTimeout(()=>p(null),120)};useEffect(()=>{if(!Xt)return;const e=n=>{n.key==="Escape"&&Un()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[Xt]);const qn=()=>{Ze(!1),setTimeout(()=>mn(null),180)},sr=()=>{l(!0)},Ca=()=>{l(!1)},hs=e=>{const n=String(e||"").trim();n&&b(t=>{const a=new Set(t);return a.has(n)?a.delete(n):a.add(n),a})};useEffect(()=>{try{const e=localStorage.getItem(W);if(!e)return;const n=JSON.parse(e);if(!Array.isArray(n))return;ve(new Set(n.map(t=>String(t||"").trim()).filter(Boolean)))}catch(e){}},[]),useEffect(()=>{try{const e=Array.from(se||[]).map(n=>String(n||"").trim()).filter(Boolean);localStorage.setItem(W,JSON.stringify(e))}catch(e){}},[se]);const rr=e=>{const n=String(e||"").trim();n&&ve(t=>{const a=new Set(t);return a.has(n)?a.delete(n):a.add(n),a})};useEffect(()=>{try{const e=localStorage.getItem(c);if(!e)return;const n=JSON.parse(e);if(!Array.isArray(n))return;kt(n.map(t=>String(t||"").trim()).filter(Boolean).slice(0,10))}catch(e){}},[]);const ir=e=>{try{localStorage.setItem(c,JSON.stringify(e))}catch(n){}},pa=e=>{const n=String(e||"").trim();n&&kt(t=>{const a=Array.isArray(t)?t:[],i=[n,...a.filter(o=>String(o||"").trim().toLowerCase()!==n.toLowerCase())].slice(0,10);return ir(i),i})},fs=e=>{var t;const n=String((t=e!=null?e:st)!=null?t:"").trim();ze(n),ut(!0),setTimeout(()=>{var a,i;try{(i=(a=Nt.current)==null?void 0:a.focus)==null||i.call(a)}catch(o){}},0)},$n=()=>{ut(!1)};useEffect(()=>{if(!Ce)return;const e=n=>{n.key==="Escape"&&$n()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[Ce]),useEffect(()=>{if(!Xe)return;const e=a=>{if(Ce||(window.scrollY||0)>6)return;const i=a.touches&&a.touches[0];i&&(me.current={active:!0,startY:i.clientY,startX:i.clientX,fired:!1})},n=a=>{const i=me.current;if(!(i!=null&&i.active)||i.fired||(window.scrollY||0)>6)return;const o=a.touches&&a.touches[0];if(!o)return;const g=o.clientY-i.startY,u=o.clientX-i.startX;Math.abs(u)>24||g>92&&(i.fired=!0,fs(st))},t=()=>{me.current={active:!1,startY:0,startX:0,fired:!1}};return window.addEventListener("touchstart",e,{passive:!0}),window.addEventListener("touchmove",n,{passive:!0}),window.addEventListener("touchend",t,{passive:!0}),window.addEventListener("touchcancel",t,{passive:!0}),()=>{window.removeEventListener("touchstart",e),window.removeEventListener("touchmove",n),window.removeEventListener("touchend",t),window.removeEventListener("touchcancel",t)}},[Xe,Ce,st]);const gs=e=>{try{const n=gn(e==null?void 0:e.status);if(!(n==="pending"||n==="processing"))return!1;const t=new Date(e==null?void 0:e.created_at);if(!Number.isFinite(t.getTime()))return!1;const a=new Date;return t.getFullYear()===a.getFullYear()&&t.getMonth()===a.getMonth()&&t.getDate()===a.getDate()}catch(n){return!1}};useEffect(()=>{var t;let e;const n=()=>{try{ft(e?!!e.matches:((window==null?void 0:window.innerWidth)||1024)<768)}catch(a){ft(!1)}};try{e=(t=window.matchMedia)==null?void 0:t.call(window,"(max-width: 767.98px)"),e!=null&&e.addEventListener?e.addEventListener("change",n):e!=null&&e.addListener&&e.addListener(n)}catch(a){e=null}return window.addEventListener("resize",n),n(),()=>{try{e!=null&&e.removeEventListener?e.removeEventListener("change",n):e!=null&&e.removeListener&&e.removeListener(n)}catch(a){}window.removeEventListener("resize",n)}},[]),useEffect(()=>{const e="admin-sheet-open";return ce||r||Xt?document.body.classList.add(e):document.body.classList.remove(e),()=>document.body.classList.remove(e)},[ce,r,Xt]),useEffect(()=>{if(!ce&&!r&&!Xt)return;const e=n=>{n.key==="Escape"&&(ce&&qn(),r&&Ca(),Xt&&Un())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[ce,r,Xt]);const or=()=>{try{if(localStorage.getItem(m))return;localStorage.setItem(m,"1"),typeof B=="function"&&B("Tip: Ch\u1EA1m S\u0110T \u0111\u1EC3 copy \u2022 Gi\u1EEF \u0111\u1EC3 g\u1ECDi","info",{durationMs:7e3})}catch(e){}},bs=e=>String((e==null?void 0:e.address)||"").replace(/\s*\n+\s*/g,", ").replace(/\s+/g," ").trim(),ys=e=>String((e==null?void 0:e.note)||"").replace(/\s*\n+\s*/g," \u2014 ").replace(/\s+/g," ").trim(),cr=e=>{const n=Gt(String(e||"")).replace(/[^0-9+]/g,"");if(n)try{window.location.href=`tel:${n}`}catch(t){}},vs=async e=>{var t,a,i,o,g;const n=Gt(String(e||"")).replace(/[^0-9+]/g,"");if(n)try{(a=(t=window==null?void 0:window.KTM)==null?void 0:t.clipboard)!=null&&a.writeText?await window.KTM.clipboard.writeText(n):await((g=(o=(i=navigator.clipboard)==null?void 0:i.writeText)==null?void 0:o.call(i,n))!=null?g:Promise.reject(new Error("Clipboard not available"))),typeof B=="function"&&B("\u0110\xE3 copy S\u0110T","success")}catch(u){typeof B=="function"&&B("Kh\xF4ng copy \u0111\u01B0\u1EE3c S\u0110T","danger")}},lr=()=>{try{const e=localStorage.getItem(it),n=e?JSON.parse(e):[];return Array.isArray(n)?n:[]}catch(e){return[]}},Ns=e=>{try{localStorage.setItem(it,JSON.stringify(Array.isArray(e)?e:[]))}catch(n){}},Aa=(e,n)=>{const t=String(e||"").trim();t&&mt(a=>{const i={...a||{}};return n?i[t]=!0:delete i[t],i})},dr=(e,n,t)=>{const a=String(e||"").trim(),i=gn(n),o=gn(t);if(!a||!i)return;const g=Array.isArray(pn.current)?pn.current:[],u=new Map(g.map(v=>[String((v==null?void 0:v.orderId)||""),v]));u.set(a,{orderId:a,nextStatus:i,prevStatus:o,ts:Date.now()});const $=Array.from(u.values()).sort((v,C)=>(Number(v.ts)||0)-(Number(C.ts)||0));pn.current=$,Ns($),Aa(a,!0)},Va=async()=>{if(In.current||!navigator.onLine)return;const e=Array.isArray(pn.current)?pn.current.slice():[];if(e.length){In.current=!0;try{for(const n of e){const t=String((n==null?void 0:n.orderId)||"").trim(),a=gn(n==null?void 0:n.nextStatus);if(!(!t||!a)){Aa(t,!0);try{await Zn({id:t,status:(n==null?void 0:n.prevStatus)||""},a,{silentToast:!0,skipToastBatch:!0,fromSync:!0});const i=(Array.isArray(pn.current)?pn.current:[]).filter(o=>String((o==null?void 0:o.orderId)||"")!==t);pn.current=i,Ns(i),Aa(t,!1)}catch(i){if(!navigator.onLine)break}}}}finally{In.current=!1}}};useEffect(()=>{const e=lr();pn.current=e;try{const n={};for(const t of e){const a=String((t==null?void 0:t.orderId)||"").trim();a&&(n[a]=!0)}mt(n)}catch(n){}setTimeout(()=>Va(),600)},[]),useEffect(()=>{const e=()=>Va();window.addEventListener("online",e);const n=setInterval(()=>Va(),8e3);return()=>{clearInterval(n),window.removeEventListener("online",e)}},[]);const mr=(e,n)=>{var t;(t=e==null?void 0:e.stopPropagation)==null||t.call(e),tn.current=!1,or(),It.current={t0:Date.now(),phoneRaw:n}},Wa=e=>{var n;(n=e==null?void 0:e.stopPropagation)==null||n.call(e),It.current=null},ur=(e,n)=>{var o;(o=e==null?void 0:e.stopPropagation)==null||o.call(e);const t=It.current;It.current=null;const a=Number(t==null?void 0:t.t0)||0;(a?Date.now()-a:0)>=520&&(tn.current=!0,cr(n!=null?n:t==null?void 0:t.phoneRaw))},pr=e=>{const n=String(e||"").trim();if(!n)return;D(i=>({...i,[n]:Date.now()}));const t=fn.current;try{const i=t.get(n);i&&clearTimeout(i)}catch(i){}const a=setTimeout(()=>{D(i=>{const o={...i||{}};return delete o[n],o});try{t.delete(n)}catch(i){}},9e3);t.set(n,a)},ws=e=>String(e||"").replace(/\s+/g," ").trim(),hr=e=>String(e||"").replace(/[^0-9]+/g,""),ha=e=>{try{const n=new Date(e==null?void 0:e.created_at).getTime();if(!Number.isFinite(n))return 0;const t=Date.now()-n;return!Number.isFinite(t)||t<=0?0:Math.floor(t/tr)}catch(n){return 0}},Ma=e=>String((e==null?void 0:e.status)||"").trim()!=="pending"?!1:ha(e)>=Pn,gn=e=>{const n=String(e!=null?e:"").trim().toLowerCase();return n==="cancelled"?"canceled":n},Ga=React.useMemo(()=>["draft","pending","processing","done","paid"],[]),aa=(e,n)=>{const t=gn(e);if(!t||t==="canceled")return null;const a=Ga.indexOf(t);return a<0?null:n==="left"?Ga[a+1]||null:n==="right"&&Ga[a-1]||null},Ss=e=>{var i;const n=gn(e);if(!n)return{label:"",icon:"fa-circle"};const t=((i=ua.find(o=>gn(o==null?void 0:o.value)===n))==null?void 0:i.label)||"",a=(()=>{switch(n){case"draft":return"fa-file-lines";case"pending":return"fa-hourglass-half";case"processing":return"fa-truck";case"done":return"fa-check";case"paid":return"fa-money-bill-wave";case"canceled":return"fa-ban";default:return"fa-circle"}})();return{label:t,icon:a}},Ta=e=>{if(gn(e==null?void 0:e.status)!=="draft")return null;const t=Jn-ha(e);return Number.isFinite(t)?t:null},_a=e=>{const n=Ta(e);return Number.isFinite(n)?n>0&&n<=Xa:!1},Hn=e=>{ge({customer_name:"",phone:"",address:"",note:"",items:[{product_id:e||"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:[{amount:"",note:""}],adjustment_amount:0,adjustment_note:"",status:"pending"}),ot([""]),R(null),At(null)};useEffect(()=>{const e=n=>{var a;if(ct==null)return;const t=(a=Zt.current)==null?void 0:a[ct];t&&!t.contains(n.target)&&At(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[ct]);const xs=e=>window.KTM.money.parseMoney(e),ks=e=>window.KTM.money.parseSignedMoney(e),qt=e=>window.KTM.money.formatVND(e),En=e=>{const t=(Array.isArray(e)?e:[]).map(a=>{var i,o;return{amount:String((i=a==null?void 0:a.amount)!=null?i:""),note:String((o=a==null?void 0:a.note)!=null?o:"")}});return t.length?t:[{amount:"",note:""}]},fr=e=>{try{const n=window.KTM.orders.getOrderAdjustmentItems(e),t=(Array.isArray(n)?n:[]).map(a=>{var i,o;return{amount:(a==null?void 0:a.amount)===0?"":String((i=a==null?void 0:a.amount)!=null?i:""),note:String((o=a==null?void 0:a.note)!=null?o:"").trim()}}).filter(a=>String(a.amount||"").trim()||String(a.note||"").trim());return t.length?t:[{amount:"",note:""}]}catch(n){return[{amount:"",note:""}]}},sa=e=>(Array.isArray(e)?e:[]).map(t=>({amount:ks(t==null?void 0:t.amount),note:String((t==null?void 0:t.note)||"").trim()})).filter(t=>t.amount!==0||!!t.note),Ja=e=>{const n=Array.isArray(e==null?void 0:e.adjustment_items)?e.adjustment_items:[],t=sa(n),a=ra(t),i=(()=>{if(!t.length)return"";const o=t.map(g=>String((g==null?void 0:g.note)||"").trim()).filter(Boolean);return o.length?o.join(" \u2022 "):t.length>1?`${t.length} m\u1EE5c`:""})();return{cleanAdjItems:t,amount:a,summaryText:i}},ra=e=>(Array.isArray(e)?e:[]).reduce((t,a)=>t+(Number(a==null?void 0:a.amount)||0),0),Ua=e=>{const n=Array.isArray(e)?e:[];return n.length?JSON.stringify(n):""},Lr=e=>window.KTM.money.parseShipFeeFromNote(e),ia=e=>window.KTM.phone.isValid(e),Gt=e=>window.KTM.phone.normalize(e),$a=async e=>{if(!e)return null;const n=await window.KTM.api.getJSON(`${API_BASE}/api/orders/${e}`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng");return n&&typeof n=="object"&&n.order&&typeof n.order=="object"?n.order:n},gr=(e,n)=>{var o;const t=Array.isArray(e)?e:[],a=Array.isArray(n)?n:[];if(!t.length)return a;if(!a.length)return t;const i=new Map(t.map(g=>{var u;return[String((u=g==null?void 0:g.id)!=null?u:""),g]}));for(const g of a){const u=String((o=g==null?void 0:g.id)!=null?o:"");u&&i.set(u,g)}return Array.from(i.values())},Da=async e=>{var n,t,a,i;if(!(e!=null&&e.id)||Array.isArray(e.items)&&e.items.length)return e;try{const o=(t=(n=Vt.current)==null?void 0:n.get)==null?void 0:t.call(n,String(e.id));if(o&&typeof o=="object"&&Array.isArray(o.items)&&o.items.length)return o}catch(o){}try{const o=await $a(e.id);if(o&&typeof o=="object"){try{(i=(a=Vt.current)==null?void 0:a.set)==null||i.call(a,String(e.id),o)}catch(g){}return oe(g=>Array.isArray(g)?g.map(u=>String(u==null?void 0:u.id)===String(e.id)?o:u):g),o}}catch(o){console.error("Fetch order by id error:",o)}return e},br=()=>{var e;try{const n=localStorage.getItem(Bn);if(!n)return;const t=JSON.parse(n);if(!t||typeof t!="object")return;const a=Object.entries(t);for(const[i,o]of a)!i||!o||typeof o!="object"||(e=lt.current)==null||e.set(String(i),o)}catch(n){}},Ya=()=>{try{const e=lt.current;if(!e||typeof e.entries!="function")return;const n=Array.from(e.entries()).filter(([a,i])=>a&&i&&typeof i=="object"&&Number.isFinite(i.ts)).sort((a,i)=>(Number(i[1].ts)||0)-(Number(a[1].ts)||0)).slice(0,ka),t={};for(const[a,i]of n)t[a]=i;localStorage.setItem(Bn,JSON.stringify(t))}catch(e){}};useEffect(()=>{br()},[]);const Cs=e=>{const n=Gt(e);if(!n)return null;const t=Array.isArray(Ne)?Ne:[];let a=null,i=-1;for(const o of t){if(!o||Gt(o.phone||"")!==n)continue;const g=new Date(o.created_at).getTime(),u=Number.isFinite(g)?g:0;u>=i&&(i=u,a=o)}return a?{name:String(a.customer_name||"").trim(),address:String(a.address||"").trim()}:null},As=(e,n)=>{e&&ge(t=>n&&Gt(t.phone)!==n?t:{...t,customer_name:e.name||t.customer_name,address:e.address||t.address})},yr=e=>{const n=Cs(e);if(!n)return;const t=Gt(e);ge(a=>{if(t&&Gt(a.phone)!==t)return a;const i={...a};return!String(a.customer_name||"").trim()&&n.name&&(i.customer_name=n.name),!String(a.address||"").trim()&&n.address&&(i.address=n.address),i})},vr=(e,n,t)=>{var a;try{const i=Gt(e);if(!i)return;const o=String(n||"").trim(),g=String(t||"").trim();if(!o&&!g)return;(a=lt.current)==null||a.set(i,{ts:Date.now(),status:"found",customer:{phone:i,name:o||null,address:g||null}}),Ya()}catch(i){}},Ia=async e=>{var i,o,g;const n=Gt(e);if(!n)return;yr(n);const t=(i=lt.current)==null?void 0:i.get(n);if(t&&Number.isFinite(t.ts)){const u=Date.now()-t.ts,$=t.status==="found"?On:Gn;if(u>=0&&u<=$){R({status:t.status,phone:n,customer:t.customer}),t.status==="found"&&t.customer&&As(t.customer,n);return}}const a=++Z.current;R({status:"loading",phone:n});try{const u=await window.KTM.api.getJSON(`${API_BASE}/api/customers?phone=${encodeURIComponent(n)}`,"L\u1ED7i tra c\u1EE9u kh\xE1ch");if(Z.current!==a)return;if(u&&u.exists&&u.customer){(o=lt.current)==null||o.set(n,{ts:Date.now(),status:"found",customer:u.customer}),Ya(),R({status:"found",phone:n,customer:u.customer}),As(u.customer,n);return}(g=lt.current)==null||g.set(n,{ts:Date.now(),status:"not-found",customer:null}),Ya(),R({status:"not-found",phone:n})}catch(u){if(Z.current!==a)return;console.error("Customer lookup error:",u),R({status:"error",phone:n})}},Ms=e=>{const n=Gt(e),t=Cs(n);ge(i=>{const o={...i,phone:n};return t&&(!String(i.customer_name||"").trim()&&t.name&&(o.customer_name=t.name),!String(i.address||"").trim()&&t.address&&(o.address=t.address)),o}),N(!1),cn.current&&(clearTimeout(cn.current),cn.current=null);const a=n;if(a.length<An){R(null);return}if(ia(a)&&a!==Tt.current){Tt.current=a,Ia(a);return}cn.current=setTimeout(()=>{const i=Gt(n);ia(i)&&i!==Tt.current&&(Tt.current=i,Ia(i))},Tn)},Ts=()=>{const e=Gt(y.phone);e.length<An||ia(e)&&e!==Tt.current&&(Tt.current=e,Ia(e))};useEffect(()=>(Qe?(document.body.classList.add("order-modal-open"),document.body.style.overflow="hidden"):(document.body.classList.remove("order-modal-open"),document.body.style.overflow=""),()=>{document.body.classList.remove("order-modal-open"),document.body.style.overflow=""}),[Qe]);const Ra=Array.isArray(y.items)?y.items.length:0;useEffect(()=>{if(!Qe){kn.current=Ra;return}Ra>kn.current&&setTimeout(()=>{const e=en.current;e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},0),kn.current=Ra},[Qe,Ra]),useEffect(()=>()=>{cn.current&&(clearTimeout(cn.current),cn.current=null),ne.current&&(clearTimeout(ne.current),ne.current=null)},[]),useEffect(()=>{if(!Qe)return;ne.current&&(clearTimeout(ne.current),ne.current=null);const e=Gt((y==null?void 0:y.phone)||"");if(!ia(e)){le([]),te(!1);return}return ne.current=setTimeout(async()=>{var i;const n=String(e),t=(i=qe.current)==null?void 0:i.get(n);if(t&&Number.isFinite(t.ts)&&Date.now()-t.ts<=Kn){le(Array.isArray(t.orders)?t.orders:[]),te(!1);return}const a=++be.current;te(!0);try{const o=`${API_BASE}/api/orders?search=${encodeURIComponent(e)}`,g=await window.KTM.api.getJSON(o,"L\u1ED7i t\u1EA3i l\u1ECBch s\u1EED \u0111\u01A1n theo S\u0110T");if(be.current!==a)return;const u=Array.isArray(g)?g:Array.isArray(g==null?void 0:g.orders)?g.orders:[];le(u);try{const $=qe.current;if($&&typeof $.set=="function"&&($.set(n,{ts:Date.now(),orders:u}),$.size>100)){const v=Array.from($.entries()).sort((I,d)=>{var j,M;return(Number((j=I==null?void 0:I[1])==null?void 0:j.ts)||0)-(Number((M=d==null?void 0:d[1])==null?void 0:M.ts)||0)}),C=Math.max(0,v.length-100);for(let I=0;I<C;I++)$.delete(v[I][0])}}catch($){}}catch(o){if(be.current!==a)return;console.error("Phone history fetch error:",o),le([])}finally{if(be.current!==a)return;te(!1)}},Rn),()=>{ne.current&&(clearTimeout(ne.current),ne.current=null)}},[Qe,y==null?void 0:y.phone]),useEffect(()=>{Sr()},[]),useEffect(()=>{et||Yn()},[S,et]),useEffect(()=>{ga()},[]),useEffect(()=>{P&&hn.current!==P&&(hn.current=P,Pa(F))},[P]);const Dn=e=>e==="draft"?"\u0110\u01A1n nh\xE1p":e==="pending"?"Ch\u1EDD x\u1EED l\xFD":e==="processing"?"\u0110ang v\u1EADn chuy\u1EC3n":e==="done"?"Ho\xE0n th\xE0nh":e==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":e==="cancelled"||e==="canceled"?"H\u1EE7y \u0111\u01A1n":e||"",oa=e=>e==="draft"?"bg-light text-dark":e==="pending"?"bg-secondary":e==="processing"?"bg-warning text-dark":e==="done"?"bg-success":e==="paid"?"bg-primary":e==="cancelled"||e==="canceled"?"bg-danger":"bg-light text-dark",zn=React.useMemo(()=>{const e=window.KTM.orders.sortOrders(Ne),n=se;if(!n||!(n instanceof Set)||n.size===0)return e;const t=Array.isArray(e)?e.slice():[];return t.sort((a,i)=>{var u,$;const o=n.has(String((u=a==null?void 0:a.id)!=null?u:""))?1:0;return(n.has(String(($=i==null?void 0:i.id)!=null?$:""))?1:0)-o}),t},[Ne,se]),Qa=React.useMemo(()=>window.KTM.orders.sortOrders(rt),[rt]),Ka=React.useMemo(()=>{const n=(Array.isArray(Qa)?Qa:[]).filter(t=>Ma(t));return n.sort((t,a)=>{const i=new Date(t==null?void 0:t.created_at).getTime(),o=new Date(a==null?void 0:a.created_at).getTime();return(Number.isFinite(i)?i:0)-(Number.isFinite(o)?o:0)}),n},[Qa]),_s=React.useMemo(()=>{const n=(Array.isArray(pt)?pt:[]).filter(t=>_a(t));return n.sort((t,a)=>{const i=new Date(t==null?void 0:t.created_at).getTime(),o=new Date(a==null?void 0:a.created_at).getTime();return(Number.isFinite(i)?i:0)-(Number.isFinite(o)?o:0)}),n},[pt]),fa=React.useMemo(()=>{if(xe)return Ka;let e=zn;if(re){const t=se;e=(Array.isArray(e)?e:[]).filter(a=>{var i,o;return(o=t==null?void 0:t.has)==null?void 0:o.call(t,String((i=a==null?void 0:a.id)!=null?i:""))})}Ie&&(e=(Array.isArray(e)?e:[]).filter(t=>gs(t)));const n=String(S||"").trim();if(n){const t=a=>{try{const i=new Date(a==null?void 0:a.created_at);if(!i||Number.isNaN(i.getTime()))return"";const o=i.getFullYear(),g=String(i.getMonth()+1).padStart(2,"0");return`${o}-${g}`}catch(i){return""}};e=(Array.isArray(e)?e:[]).filter(a=>t(a)===n)}return e},[xe,Ka,zn,re,se,Ie,S]),Oa=React.useMemo(()=>{if(xe)return fa;const e=String(Y||"").trim();return e?(Array.isArray(fa)?fa:[]).filter(n=>String((n==null?void 0:n.status)||"").trim()===e):fa},[fa,Y,xe]),$s=React.useMemo(()=>window.KTM.orders.sortOrders(vt),[vt]),an=React.useMemo(()=>et?$s:Oa,[Oa,et,$s]),Ds=React.useMemo(()=>{const e=Array.isArray(an)?an:[];return Xe?e.slice(0,Math.max(0,Number(wt)||0)):e},[Xe,wt,an]);useEffect(()=>{Xe&&Lt(Ct)},[Xe,Y,xe,S,st]),useEffect(()=>{if(!Xe)return;const e=Array.isArray(an)?an.length:0;if(wt>=e)return;const n=Qt.current;if(!n)return;const t=new IntersectionObserver(a=>{Array.isArray(a)&&a.some(o=>o==null?void 0:o.isIntersecting)&&Lt(o=>Math.min((Number(o)||0)+Yt,e))},{root:null,rootMargin:"520px 0px",threshold:0});return t.observe(n),()=>t.disconnect()},[Xe,wt,an]),useEffect(()=>{if(!Xe){h(!1),L(!1);return}const e=()=>{s.current||(s.current=window.requestAnimationFrame(()=>{s.current=null;const n=window.scrollY||document.documentElement.scrollTop||0;h(n>140),L(n>60)}))};return window.addEventListener("scroll",e,{passive:!0}),e(),()=>{window.removeEventListener("scroll",e),s.current&&(window.cancelAnimationFrame(s.current),s.current=null)}},[Xe]),useEffect(()=>{if(!Xe){try{document.documentElement.style.removeProperty("--ktm-mobile-bottom-nav-h")}catch(n){}return}const e=()=>{try{const n=document.querySelector(".mobile-bottom-nav"),t=n&&n.offsetHeight?n.offsetHeight:0;document.documentElement.style.setProperty("--ktm-mobile-bottom-nav-h",`${t}px`)}catch(n){}};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[Xe]);const Xn=React.useMemo(()=>{const e=Array.isArray(an)?an:[],n={all:e.length,draft:0,pending:0,processing:0,done:0,paid:0,canceled:0,other:0};for(const t of e){const a=gn(t==null?void 0:t.status);a==="draft"?n.draft+=1:a==="pending"?n.pending+=1:a==="processing"?n.processing+=1:a==="done"?n.done+=1:a==="paid"?n.paid+=1:a==="canceled"?n.canceled+=1:n.other+=1}return n},[an]),Nr=React.useMemo(()=>{const e=se;return!e||e.size===0?0:(Array.isArray(zn)?zn:[]).reduce((n,t)=>{var a;return n+(e.has(String((a=t==null?void 0:t.id)!=null?a:""))?1:0)},0)},[se,zn]),wr=React.useMemo(()=>(Array.isArray(zn)?zn:[]).filter(e=>gs(e)).length,[zn]),jn=React.useMemo(()=>{const e=new Date,n=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0");return`${n}-${t}`},[]),Fn=e=>{if(et&&Ke(""),e==="thisMonth"){$e(!1),de(""),q(jn);return}if(e==="overduePending"){q(""),$e(!0),de("pending");return}if(e==="draftExpiring"){$e(!1),de("draft"),q(""),ga();return}if(e==="all"){$e(!1),de(""),q(jn);return}},ca=e=>window.KTM.date.formatDateTime(e),Sr=async()=>{try{const e=await window.KTM.api.getJSON(`${API_BASE}/api/products?fields=order`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");Wt(Array.isArray(e)?e:[])}catch(e){console.error("Load products error:",e),Wt([])}},Yn=async()=>{ie(!0),Je(!1);try{const n=new URLSearchParams;S&&n.set("month",String(S)),n.set("includeItems","1"),n.set("meta","1"),n.set("limit",String(ms)),n.set("offset","0");const t=`${API_BASE}/api/orders?${n.toString()}`,a=await window.KTM.api.getJSON(t,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),i=Array.isArray(a)?a:Array.isArray(a==null?void 0:a.orders)?a.orders:[],o=!Array.isArray(a)&&a&&typeof a=="object"&&a.meta||null;oe(Array.isArray(i)?i:[]),V(Array.isArray(i)?i.length:0),He(!!(o!=null&&o.hasMore)),ga()}catch(n){console.error("Load orders error:",n),oe([]),V(0),He(!1)}finally{ie(!1),Je(!1)}},xr=async()=>{if(!(Ve||ke||et)&&Ee){Je(!0);try{const e=new URLSearchParams;S&&e.set("month",String(S)),e.set("includeItems","1"),e.set("meta","1"),e.set("limit",String(ms)),e.set("offset",String(J));const n=`${API_BASE}/api/orders?${e.toString()}`,t=await window.KTM.api.getJSON(n,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),a=Array.isArray(t)?t:Array.isArray(t==null?void 0:t.orders)?t.orders:[],i=!Array.isArray(t)&&t&&typeof t=="object"&&t.meta||null;oe(o=>gr(o,Array.isArray(a)?a:[])),V(o=>o+(Array.isArray(a)?a.length:0)),He(!!(i!=null&&i.hasMore))}catch(e){console.error("Load more orders error:",e)}finally{Je(!1)}}},Is=async e=>{var i;const n=ws(e);if(!n){$t([]),Ht(""),tt(!1);return}const t=hr(n);if(n.length<ls&&t.length<ds){$t([]),Ht(`Nh\u1EADp \xEDt nh\u1EA5t ${ls} k\xFD t\u1EF1 (ho\u1EB7c ${ds} s\u1ED1) \u0111\u1EC3 search nhanh`),tt(!1);return}try{const o=(i=ht.current)==null?void 0:i.get(n);if(o&&Number.isFinite(o.ts)&&Date.now()-o.ts<=ar){$t(Array.isArray(o.results)?o.results:[]),Ht(""),tt(!1);return}}catch(o){}const a=++Me.current;tt(!0),Ht("");try{const o=`${API_BASE}/api/orders?search=${encodeURIComponent(n)}`,g=await window.KTM.api.getJSON(o,"L\u1ED7i search \u0111\u01A1n h\xE0ng");if(Me.current!==a)return;const u=Array.isArray(g)?g:[];$t(u);try{const $=ht.current;if($&&typeof $.set=="function"&&($.set(n,{ts:Date.now(),results:u}),$.size>cs)){const v=Array.from($.entries()).sort((I,d)=>{var j,M;return(Number((j=I==null?void 0:I[1])==null?void 0:j.ts)||0)-(Number((M=d==null?void 0:d[1])==null?void 0:M.ts)||0)}),C=Math.max(0,v.length-cs);for(let I=0;I<C;I++)$.delete(v[I][0])}}catch($){}}catch(o){if(Me.current!==a)return;console.error("Order search error:",o),$t([]),Ht((o==null?void 0:o.message)||"Search l\u1ED7i")}finally{if(Me.current!==a)return;tt(!1)}};useEffect(()=>{Re.current&&(clearTimeout(Re.current),Re.current=null);const e=ws(st);if(!e){$t([]),Ht(""),tt(!1);return}return xe&&$e(!1),Re.current=setTimeout(()=>{Is(e)},nr),()=>{Re.current&&(clearTimeout(Re.current),Re.current=null)}},[st]);const ga=async()=>{X(!0),Ge(!0);try{const[e,n]=await Promise.all([window.KTM.api.getJSON(`${API_BASE}/api/orders?overdue=1&days=${encodeURIComponent(Pn)}&includeItems=0`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),window.KTM.api.getJSON(`${API_BASE}/api/orders?draftExpiring=1&remainingDays=${encodeURIComponent(Xa)}&includeItems=0`,"L\u1ED7i t\u1EA3i \u0111\u01A1n nh\xE1p")]);Fe(Array.isArray(e)?e:[]),bt(Array.isArray(n)?n:[])}catch(e){console.error("Load all orders error:",e),Fe([]),bt([])}finally{X(!1),Ge(!1)}},Za=async e=>{const n=await Da(e);if(!n)return;nn(n.id);const t=Array.isArray(n.items)&&n.items.length?n.items.map(u=>{var $,v,C,I;return{product_id:(u==null?void 0:u.product_id)||"",quantity:Number(($=u==null?void 0:u.quantity)!=null?$:1)||1,unit_price:(()=>{var M;const d=(M=u==null?void 0:u.unit_price)!=null?M:u==null?void 0:u.unitPrice,j=d==null||d===""?NaN:Number(d);return Number.isFinite(j)?Math.trunc(j):null})(),variant:String((v=u==null?void 0:u.variant)!=null?v:"").trim(),variant_json:(I=(C=u==null?void 0:u.variant_json)!=null?C:u==null?void 0:u.variantJson)!=null?I:null}}).filter(u=>u.product_id):[{product_id:n.product_id||"",quantity:Number(n.quantity||1)||1,unit_price:null,variant:"",variant_json:null}],a=fr(n),i=sa(a),o=ra(i),g=Ua(i);ge({customer_name:n.customer_name||"",phone:Gt(n.phone||""),address:n.address||"",note:(n==null?void 0:n.note)||"",items:t.length?t:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:a,adjustment_amount:o,adjustment_note:g||(n==null?void 0:n.adjustment_note)||"",status:n.status||"pending"}),ot(new Array(t.length?t.length:1).fill("")),Ae(new Array(t.length?t.length:1).fill(!0)),R(null),Ye(!1),nt(n),Et(!0),Ft(""),Mt(!1),vn(!0),n.phone&&Ia(Gt(n.phone))},ba=async e=>{if(!e)return;Et(!0),Ft(""),Mt(!0),vn(!1),nt(e);const n=++E.current;try{const t=await Da(e);if(E.current!==n)return;nt(t||e)}catch(t){if(E.current!==n)return;Ft((t==null?void 0:t.message)||"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c chi ti\u1EBFt \u0111\u01A1n")}finally{if(E.current!==n)return;Mt(!1)}},Rs=(e={})=>{!(e!=null&&e.force)&&(_||he)||(Et(!1),Mt(!1),Ft(""),vn(!1),nn(null),Hn(""),N(!1),Ae([]))};function Pa(e){Et(!1),vn(!1),Mt(!1),Ft(""),nn(null),Hn(e||""),N(!1),Ae([]),Ye(!0)}const es=(e={})=>{!(e!=null&&e.force)&&(_||he)||(Ye(!1),nn(null),Hn(""),N(!1),Ae([]))},Ks=async e=>{var v,C,I;if(!yt||he||_)return;const n=e||(Qe?"modal":St?"drawer":"modal"),t=(Array.isArray(Ne)?Ne:[]).find(d=>String(d==null?void 0:d.id)===String(yt))||null,a=String((t==null?void 0:t.status)||(y==null?void 0:y.status)||"").trim();if(a==="done"||a==="paid"||a==="canceled"){const d="Kh\xF4ng th\u1EC3 t\xE1ch: \u0111\u01A1n \u0111\xE3 ho\xE0n th\xE0nh/\u0111\xE3 nh\u1EADn ti\u1EC1n/\u0111\xE3 h\u1EE7y.";typeof B=="function"?B(d,"warning"):alert(d);return}const i=Gt(y.phone),g=(Array.isArray(y.items)?y.items:[]).map((d,j)=>{var M,Te;return{idx:j,product_id:String((d==null?void 0:d.product_id)||"").trim(),quantity:Number((M=d==null?void 0:d.quantity)!=null?M:0),variant:String((d==null?void 0:d.variant)||"").trim()||null,variant_json:(Te=d==null?void 0:d.variant_json)!=null?Te:null,unit_price:(()=>{const dt=d==null?void 0:d.unit_price,Ot=dt===""||dt==null?NaN:Number(dt);if(Number.isFinite(Ot))return Math.max(0,Math.trunc(Ot));const gt=_n(d==null?void 0:d.product_id),bn=d!=null&&d.variant_json&&typeof d.variant_json=="object"?d.variant_json:null;return la(gt,bn)})()}}).filter(d=>d.product_id&&Number.isFinite(d.quantity)&&d.quantity>0);if(g.length<2){const d="C\u1EA7n \xEDt nh\u1EA5t 2 s\u1EA3n ph\u1EA9m \u0111\u1EC3 t\xE1ch \u0111\u01A1n.";typeof B=="function"?B(d,"warning"):alert(d);return}const u=[],$=[];for(const d of g){const j=!!Oe[d.idx],M={product_id:d.product_id,quantity:d.quantity,unit_price:d.unit_price,variant:d.variant,variant_json:d.variant_json};j?u.push(M):$.push(M)}if(!u.length||!$.length){const d="Ch\u1ECDn m\u1ED9t s\u1ED1 s\u1EA3n ph\u1EA9m \u201CGiao \u0111\u1EE3t 1\u201D, v\xE0 \u0111\u1EC3 l\u1EA1i \xEDt nh\u1EA5t 1 s\u1EA3n ph\u1EA9m \u201CCh\u1EDD h\xE0ng\u201D.";typeof B=="function"?B(d,"warning"):alert(d);return}_e(!0);try{const d=Array.isArray(y==null?void 0:y.adjustment_items)?y.adjustment_items:[],j=sa(d),M=ra(j),Te=Ua(j),dt={customer_name:y.customer_name,phone:i,address:y.address,note:(y.note||"").trim(),adjustment_amount:M,adjustment_note:Te,adjustment_items:j,status:"processing",items:u,created_at_from_order_id:String(yt),product_id:u[0].product_id,quantity:u[0].quantity,split_seq:1},Ot=await window.KTM.api.postJSON(`${API_BASE}/api/orders`,dt,"L\u1ED7i t\xE1ch \u0111\u01A1n (t\u1EA1o \u0111\u01A1n giao ngay)"),gt=(I=(C=Ot==null?void 0:Ot.id)!=null?C:(v=Ot==null?void 0:Ot.order)==null?void 0:v.id)!=null?I:null;if(!gt)throw new Error("T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i: kh\xF4ng nh\u1EADn \u0111\u01B0\u1EE3c ID \u0111\u01A1n giao ngay");const bn={id:yt,customer_name:y.customer_name,phone:i,address:y.address,note:(y.note||"").trim(),adjustment_amount:0,adjustment_note:"",adjustment_items:[],status:"pending",items:$,product_id:$[0].product_id,quantity:$[0].quantity,parent_order_id:String(gt),split_seq:2};if(await window.KTM.api.putJSON(`${API_BASE}/api/orders/${yt}`,bn,"L\u1ED7i t\xE1ch \u0111\u01A1n (c\u1EADp nh\u1EADt ph\u1EA7n ch\u1EDD h\xE0ng)"),n==="drawer"){vn(!1),nn(null),Hn(""),N(!1),Ae([]),Ft(""),Mt(!0);try{const wn=await $a(gt);wn&&typeof wn=="object"?nt(wn):(nt(null),Ft("Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c \u0111\u01A1n giao ngay sau khi t\xE1ch"))}catch(wn){Ft((wn==null?void 0:wn.message)||"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c \u0111\u01A1n giao ngay sau khi t\xE1ch")}finally{Mt(!1)}}else es({force:!0});Yn(),ga();const Bt=gt?`\u0110\xE3 t\xE1ch \u0111\u01A1n. \u0110\u01A1n giao ngay: #${gt}`:"\u0110\xE3 t\xE1ch \u0111\u01A1n.";typeof B=="function"?B(Bt,"success"):alert(Bt)}catch(d){console.error(d);const j=(d==null?void 0:d.message)||"T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i";typeof B=="function"?B(j,"danger"):alert(j)}finally{_e(!1)}},Os=e=>{if(!e)return"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --";const n=String(e),t=zt.find(a=>String(a==null?void 0:a.id)===n);return t?`${t.name}${t.code?` (${t.code})`:""}`:"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"},Ln=e=>{try{return String(e!=null?e:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(n){return String(e!=null?e:"").toLowerCase()}},kr=e=>{const t=Ln(e).trim().split(/\s+/).filter(Boolean),a=t.join(" ");return{contentTokens:t,cleanedQuery:a}},Ps=React.useMemo(()=>(Array.isArray(zt)?zt:[]).map((e,n)=>{var v,C,I,d,j,M;const t=Ln((v=e==null?void 0:e.name)!=null?v:""),a=Ln((C=e==null?void 0:e.code)!=null?C:""),i=Ln((I=e==null?void 0:e.category)!=null?I:""),o=Ln((d=e==null?void 0:e.note)!=null?d:""),g=Ln((j=e==null?void 0:e.id)!=null?j:""),u=Ln((M=e==null?void 0:e.stt)!=null?M:""),$=`${t} ${a} ${i} ${o} ${g} ${u}`.trim();return{p:e,originalIndex:n,name:t,code:a,category:i,note:o,haystackAll:$}}),[zt]),Cr=(e,n,t)=>{var I,d,j,M,Te;const a=Array.isArray(n)?n:[],i=Ln(t).trim();if(!a.length&&!i)return 0;const o=(I=e==null?void 0:e.name)!=null?I:"",g=(d=e==null?void 0:e.code)!=null?d:"",u=(j=e==null?void 0:e.category)!=null?j:"",$=(M=e==null?void 0:e.note)!=null?M:"";if(!((Te=e==null?void 0:e.haystackAll)!=null?Te:""))return 0;let C=0;i&&(o===i&&(C+=220),o.includes(i)&&(C+=140),o.startsWith(i)&&(C+=160),g&&g===i&&(C+=180),g&&g.includes(i)&&(C+=90));for(const dt of a){if(!dt)continue;const Ot=new RegExp(`(?:^|\\s)${dt.replace(/[.*+?^${}()|[\[\]\\]/g,"\\$&")}`);o.includes(dt)&&(C+=35),Ot.test(o)&&(C+=25),g&&g.includes(dt)&&(C+=20),g&&Ot.test(g)&&(C+=10),u&&u.includes(dt)&&(C+=12),$&&$.includes(dt)&&(C+=6)}return C>0&&o&&(C+=Math.max(0,10-Math.min(10,Math.floor(o.length/10)))),C},ts=(e,n)=>{const t=String(e||""),a=String(n||"");if(t===a)return 0;if(!t)return a.length;if(!a)return t.length;const i=t.length,o=a.length;if(o>i)return ts(a,t);let g=new Array(o+1),u=new Array(o+1);for(let $=0;$<=o;$++)g[$]=$;for(let $=1;$<=i;$++){u[0]=$;const v=t.charCodeAt($-1);for(let I=1;I<=o;I++){const d=v===a.charCodeAt(I-1)?0:1;u[I]=Math.min(g[I]+1,u[I-1]+1,g[I-1]+d)}const C=g;g=u,u=C}return g[o]},Ar=(e,n)=>{const t=String(e||"").trim(),a=String(n||"");if(!t||!a)return!1;if(a.includes(t))return!0;const i=a.split(/\s+/).filter(Boolean);if(!i.length)return!1;const o=t.length<=4?1:2;for(const g of i)if(!(Math.abs(g.length-t.length)>o)&&ts(t,g)<=o)return!0;return!1},Ea=e=>{const n=Ln(e).replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim();return n?n.split(" ").filter(Boolean):[]},Mr=(e,n)=>{const t=Array.isArray(n)?n:[];if(!t.length)return 0;const a=Ea((e==null?void 0:e.name)||""),i=Ea((e==null?void 0:e.code)||""),o=Ea((e==null?void 0:e.category)||""),g=Ea((e==null?void 0:e.note)||""),u=(v,C,I)=>{const d=String(v||"").trim();if(!d||!C.length)return 0;const j=d.length<=4?1:2;let M=1/0,Te=-1;for(let gt=0;gt<C.length;gt++){const bn=C[gt];if(!bn||Math.abs(bn.length-d.length)>j)continue;const Bt=ts(d,bn);if(Bt<M&&(M=Bt,Te=gt,Bt===0))break}if(M===1/0||M>j)return 0;let Ot=Math.round(I*(M===0?1:M===1?.65:.45));return Te===0?Ot+=Math.round(I*.25):Te===1&&(Ot+=Math.round(I*.12)),Ot};let $=0;for(const v of t){if(!v)continue;const C=u(v,a,180),I=u(v,i,120),d=u(v,o,60),j=u(v,g,30);$+=Math.max(C,I,d,j)}if($>0){const v=((e==null?void 0:e.name)||"").length;$+=Math.max(0,60-Math.min(60,Math.floor(v/2)))}return $},ns=React.useRef(new Map);React.useEffect(()=>{ns.current=new Map},[zt]);const Es=e=>{var v,C;const n=String(fe[e]||"").trim();if(!n)return zt;const{contentTokens:t,cleanedQuery:a}=kr(n);if(t.length===0)return zt;const i=Ln(n).trim(),o=ns.current.get(i);if(o)return o;const g=[];for(const I of Ps){const d=I.haystackAll;d&&t.some(j=>d.includes(j))&&g.push(I)}let u=g;if(u.length<8&&t.length>0){const I=[],d=new Set(u.map(j=>{var M,Te;return String((Te=(M=j.p)==null?void 0:M.id)!=null?Te:"")+":"+String(j.originalIndex)}));for(const j of Ps){const M=String((C=(v=j.p)==null?void 0:v.id)!=null?C:"")+":"+String(j.originalIndex);if(d.has(M))continue;const Te=j.haystackAll;Te&&t.some(dt=>Ar(dt,Te))&&(I.push(j),d.add(M))}I.length&&(u=u.concat(I))}const $=u.map(I=>({entry:I,score:Cr(I,t,a)})).map(I=>{if(I.score>0)return I;const d=Mr(I.entry,t);return d>0?{...I,score:d}:I}).filter(I=>I.score>0).sort((I,d)=>d.score!==I.score?d.score-I.score:I.entry.originalIndex-d.entry.originalIndex).slice(0,40).map(I=>I.entry.p);return ns.current.set(i,$),$},_n=e=>{if(!e)return null;const n=String(e);return zt.find(t=>String(t==null?void 0:t.id)===n)||null},Vn=e=>{if(e==null||e==="")return[];let n=e;if(typeof n=="string"){const t=n.trim();if(!t)return[];try{n=JSON.parse(t)}catch(a){return[]}}return Array.isArray(n)?n.map((t,a)=>{var g;if(!t||typeof t!="object")return null;const i=String((g=t.name)!=null?g:"").trim()||`Bi\u1EBFn th\u1EC3 ${a+1}`,o=(Array.isArray(t.options)?t.options:[]).map(u=>{var Te,dt,Ot,gt,bn,Bt,wn;if(!u||typeof u!="object")return null;const $=String((Te=u.label)!=null?Te:"").trim();if(!$)return null;const v=(bn=(gt=(Ot=(dt=u.price)!=null?dt:u.priceValue)!=null?Ot:u.unit_price)!=null?gt:u.unitPrice)!=null?bn:null,C=v==null||v===""?NaN:typeof v=="number"?v:typeof v=="string"?xs(v):Number(v),I=Number.isFinite(C)?Math.trunc(C):null,d=(wn=(Bt=u.price_delta)!=null?Bt:u.priceDelta)!=null?wn:null,j=Number(d),M=Number.isFinite(j)?Math.trunc(j):0;return{label:$,price:I,price_delta:M}}).filter(Boolean);return{name:i,options:o}}).filter(Boolean):[]},jr=e=>{const n=_n(e);return Vn(n==null?void 0:n.variants)},La=e=>{if(!e||typeof e!="object")return"";const n=[];for(const[t,a]of Object.entries(e)){const i=String(t||"").trim(),o=String(a||"").trim();!i||!o||n.push(`${i}: ${o}`)}return n.join(", ")},la=(e,n)=>{const t=xs(e==null?void 0:e.price),a=Vn(e==null?void 0:e.variants);if(!a.length||!n||typeof n!="object")return t;let i=t,o=!1;for(const g of a){const u=String((g==null?void 0:g.name)||"").trim(),$=String((n==null?void 0:n[u])||"").trim();if(!u||!$)continue;const v=(Array.isArray(g.options)?g.options:[]).find(M=>String((M==null?void 0:M.label)||"").trim()===$);if(!v)continue;const C=v==null?void 0:v.price,I=C==null||C===""?NaN:Number(C);if(Number.isFinite(I)){i=Math.max(0,Math.trunc(I)),o=!0;continue}const d=v==null?void 0:v.price_delta,j=d==null||d===""?NaN:Number(d);Number.isFinite(j)&&(i+=Math.trunc(j))}return i},as=e=>window.KTM.orders.getOrderItems(e),Ls=e=>window.KTM.orders.getOrderTotalQty(e),da=e=>window.KTM.orders.getOrderProductSummary(e,_n),ja=e=>window.KTM.orders.getOrderItemRows(e,_n),ya=e=>window.KTM.orders.getOrderAdjustmentMoney(e),Qn=e=>window.KTM.orders.getOrderAdjustmentSummaryText(e),Tr=e=>{const n=as(e),t=ja(e),a=Na(n),i=va(n),o=i.fee,g=ya(e),u=a+o+g,$=C=>{const I=Number(C)||0;return I>0?`+${qt(I)}`:qt(I)},v=[];if(e!=null&&e.customer_name&&v.push(`KH\xC1CH: ${e.customer_name}`),e!=null&&e.phone&&v.push(`S\u0110T: ${e.phone}`),e!=null&&e.address&&v.push(`\u0110\u1ECAA CH\u1EC8: ${e.address}`),((e==null?void 0:e.note)||"").trim()&&v.push(`GHI CH\xDA: ${(e.note||"").trim()}`),v.push(""),v.push("S\u1EA2N PH\u1EA8M:"),t.length)for(const C of t)v.push(`- ${C.name} (SL: ${C.qty})`);else{const C=da(e);C&&C!=="\u2014"&&v.push(`- ${C}`)}v.push(""),v.push(`T\u1EA0M T\xCDNH: ${qt(a)}`),i.found&&o!==0&&v.push(`SHIP: ${qt(o)}`);{const C=window.KTM.orders.getOrderAdjustmentItems(e),I=(Array.isArray(C)?C:[]).map(M=>{var Te;return{amount:Number((Te=M==null?void 0:M.amount)!=null?Te:0)||0,note:String((M==null?void 0:M.note)||"").trim()}}).filter(M=>M.amount!==0||!!M.note),d=Qn(e);if(g!==0||I.length>0||!!d)if(I.length===1){const M=I[0];v.push(`\u0110I\u1EC0U CH\u1EC8NH: ${$(g)}${M.note?` \u2014 ${M.note}`:""}`)}else{v.push(`\u0110I\u1EC0U CH\u1EC8NH: ${$(g)}${!I.length&&d?` \u2014 ${d}`:""}`);for(const M of I)v.push(`- ${$(M.amount)}${M.note?`: ${M.note}`:""}`)}}return v.push(`T\u1ED4NG: ${qt(u)}`),v.filter(Boolean).join(`
`)},Fa=e=>{try{const n=Tr(e);Promise.resolve(window.KTM.clipboard.writeText(n)).then(()=>{typeof B=="function"?B("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng","success"):alert("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng")}).catch(t=>{console.error(t),typeof B=="function"?B("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)","danger"):alert("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)")});try{Da(e)}catch(t){}}catch(n){console.error(n),typeof B=="function"?B("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)","danger"):alert("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)")}},va=e=>window.KTM.orders.getOrderShipInfo(e,_n),Na=e=>window.KTM.orders.getItemsSubtotal(e,_n),ss=e=>{try{const n=e instanceof Date?e:new Date(e);if(!n||Number.isNaN(n.getTime()))return"";const t=n.getFullYear(),a=String(n.getMonth()+1).padStart(2,"0");return`${t}-${a}`}catch(n){return""}},rs=()=>S?String(S):ss(new Date),js=e=>{const n=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),t=Gt((e==null?void 0:e.phone)||""),a=String((e==null?void 0:e.address)||"").trim().toLowerCase(),i=Ja(e).amount,g=(Array.isArray(e==null?void 0:e.items)?e.items:[]).map(u=>{var $;return{product_id:String((u==null?void 0:u.product_id)||"").trim(),quantity:Number(($=u==null?void 0:u.quantity)!=null?$:0),variant:String((u==null?void 0:u.variant)||"").trim()}}).filter(u=>u.product_id&&Number.isFinite(u.quantity)&&u.quantity>0).sort((u,$)=>u.product_id<$.product_id?-1:u.product_id>$.product_id?1:u.variant<$.variant?-1:u.variant>$.variant?1:u.quantity-$.quantity);return JSON.stringify({name:n,phone:t,address:a,items:g,adj:i})},Cn=React.useMemo(()=>{const e=Gt((y==null?void 0:y.phone)||"");if(!e)return{count:0,orders:[],monthKey:rs()};const n=rs(),a=(Array.isArray(U)?U:[]).filter(i=>{if(!i||yt&&String(i.id)===String(yt)||Gt(i.phone||"")!==e)return!1;const o=ss(i.created_at);return o&&o===n}).sort((i,o)=>{const g=new Date(i.created_at).getTime(),u=new Date(o.created_at).getTime();return(Number.isFinite(u)?u:0)-(Number.isFinite(g)?g:0)});return{count:a.length,orders:a,monthKey:n}},[U,y==null?void 0:y.phone,S,yt]),_r=e=>{var u;const n=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),t=Gt((e==null?void 0:e.phone)||""),a=String((e==null?void 0:e.address)||"").trim().toLowerCase(),i=ks((u=e==null?void 0:e.adjustment_amount)!=null?u:0),o=as(e),g=(Array.isArray(o)?o:[]).map($=>{var v;return{product_id:String(($==null?void 0:$.product_id)||"").trim(),quantity:Number((v=$==null?void 0:$.quantity)!=null?v:0),variant:String(($==null?void 0:$.variant)||"").trim()}}).filter($=>$.product_id&&Number.isFinite($.quantity)&&$.quantity>0).sort(($,v)=>$.product_id<v.product_id?-1:$.product_id>v.product_id?1:$.variant<v.variant?-1:$.variant>v.variant?1:$.quantity-v.quantity);return JSON.stringify({name:n,phone:t,address:a,items:g,adj:i})},Fs=React.useMemo(()=>{if(yt)return"";const e=Gt((y==null?void 0:y.phone)||"");if(!e)return"";const n=rs(),t=js(y),a=Array.isArray(U)?U:[];for(const i of a){if(!i||yt&&String(i.id)===String(yt)||Gt(i.phone||"")!==e)continue;const o=ss(i.created_at);if(!o||o!==n)continue;const g=_r(i);if(g&&g===t)return`\u0110\u01A1n n\xE0y gi\u1ED1ng 100% m\u1ED9t \u0111\u01A1n trong th\xE1ng ${n}${i!=null&&i.id?` (#${i.id})`:""}`}return""},[U,y,S,yt]),Bs=e=>{var bn;const n=[],t=[],a=String((e==null?void 0:e.customer_name)||"").trim(),i=Gt((e==null?void 0:e.phone)||""),o=String((e==null?void 0:e.address)||"").trim();a||n.push("Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng"),i||n.push("Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i"),i&&!ia(i)&&n.push("S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)"),o||t.push("Thi\u1EBFu \u0111\u1ECBa ch\u1EC9");const u=(Array.isArray(e==null?void 0:e.items)?e.items:[]).filter(Bt=>Bt&&Bt.product_id);u.length===0&&n.push("Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m"),u.some(Bt=>{var na;const wn=Number((na=Bt==null?void 0:Bt.quantity)!=null?na:0);return!Number.isFinite(wn)||wn<=0})&&n.push("S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0");const v=new Set;let C=!1;for(const Bt of u){const wn=String(Bt.product_id||"").trim(),na=String((Bt==null?void 0:Bt.variant)||"").trim();if(!wn)continue;const Pt=`${wn}||${na}`;if(v.has(Pt)){C=!0;break}v.add(Pt)}C&&t.push("S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)");const I=Na(u),d=va(u),j=d!=null&&d.found?Number((bn=d==null?void 0:d.fee)!=null?bn:0):0,M=Array.isArray(e==null?void 0:e.adjustment_items)?e.adjustment_items:[],Te=sa(M),dt=ra(Te),Ot=Te.some(Bt=>(Number(Bt==null?void 0:Bt.amount)||0)!==0&&!String((Bt==null?void 0:Bt.note)||"").trim());d!=null&&d.found&&(j>=2e5||I>0&&j>I*.6)&&t.push(`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${qt(j)}`),Ot&&t.push("C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh");const gt=Math.abs(dt);return(gt>=5e5||I>0&&gt>I*.5)&&dt!==0&&t.push(`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${qt(dt)}`),{errors:n,warnings:t,canSubmit:n.length===0}},Fr=React.useMemo(()=>Bs(y),[y,zt]),Rt=React.useMemo(()=>{var na;const e=String((y==null?void 0:y.customer_name)||"").trim(),n=Gt((y==null?void 0:y.phone)||""),t=String((y==null?void 0:y.address)||"").trim(),a=Array.isArray(y==null?void 0:y.items)?y.items:[],i=new Map;for(const Pt of a){const ma=String((Pt==null?void 0:Pt.product_id)||"").trim(),Ha=String((Pt==null?void 0:Pt.variant)||"").trim();if(!ma)continue;const za=`${ma}||${Ha}`;i.set(za,(i.get(za)||0)+1)}const o=a.map(Pt=>{var er;const ma=String((Pt==null?void 0:Pt.product_id)||"").trim(),Ha=Number((er=Pt==null?void 0:Pt.quantity)!=null?er:0),za=ma?"":"Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m",Kr=Number.isFinite(Ha)&&Ha>0?"":"S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0",Or=String((Pt==null?void 0:Pt.variant)||"").trim(),Pr=`${ma}||${Or}`,Er=ma&&(i.get(Pr)||0)>1?"S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)":"";return{productError:za,qtyError:Kr,dupWarn:Er}}),g=a.filter(Pt=>Pt&&Pt.product_id),u=Na(g),$=va(g),v=$!=null&&$.found?Number((na=$==null?void 0:$.fee)!=null?na:0):0,C=Array.isArray(y==null?void 0:y.adjustment_items)?y.adjustment_items:[],I=sa(C),d=ra(I),j=I.some(Pt=>(Number(Pt==null?void 0:Pt.amount)||0)!==0&&!String((Pt==null?void 0:Pt.note)||"").trim()),M=Math.abs(d),Te=j?"C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh":"",dt=d!==0&&(M>=5e5||u>0&&M>u*.5)?`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${qt(d)}`:"",Ot=$!=null&&$.found&&(v>=2e5||u>0&&v>u*.6)?`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${qt(v)}`:"",gt=e?"":"Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng",bn=n?ia(n)?"":"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)":"Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",Bt=t?"":"Thi\u1EBFu \u0111\u1ECBa ch\u1EC9",wn=!gt&&!bn&&o.every(Pt=>!Pt.productError&&!Pt.qtyError);return{nameError:gt,phoneError:bn,addressWarn:Bt,items:o,shipAbnormalWarn:Ot,adjustmentNoteWarn:Te,adjustmentAbnormalWarn:dt,canSubmit:wn}},[y,zt]),Ba=async e=>{var u,$,v;const n=(e==null?void 0:e.mode)||"close",t=(e==null?void 0:e.origin)||"modal",a=Bs(y);if(!a.canSubmit){const C=a.errors[0]||"Thi\u1EBFu d\u1EEF li\u1EC7u b\u1EAFt bu\u1ED9c";typeof B=="function"?B(C,"danger"):alert(C);return}if(!yt&&Fs){const C=`${Fs}

B\u1EA1n c\xF3 mu\u1ED1n ti\u1EBFp t\u1EE5c l\u01B0u kh\xF4ng?`;if(!window.confirm(C)){(Cn==null?void 0:Cn.count)>0&&N(!0),setTimeout(()=>{var j;const d=document.getElementById("order-phone-input");d&&typeof d.scrollIntoView=="function"&&(d.scrollIntoView({block:"center",behavior:"smooth"}),(j=d.focus)==null||j.call(d))},0);return}}const i=Gt(y.phone),g=(Array.isArray(y.items)?y.items:[]).map(C=>{var I,d;return{product_id:(C==null?void 0:C.product_id)||"",quantity:Number((I=C==null?void 0:C.quantity)!=null?I:1),variant:String((C==null?void 0:C.variant)||"").trim()||null,variant_json:(d=C==null?void 0:C.variant_json)!=null?d:null,unit_price:(()=>{const j=C==null?void 0:C.unit_price,M=j===""||j==null?NaN:Number(j);if(Number.isFinite(M))return Math.max(0,Math.trunc(M));const Te=_n(C==null?void 0:C.product_id),dt=C!=null&&C.variant_json&&typeof C.variant_json=="object"?C.variant_json:null;return la(Te,dt)})()}}).filter(C=>C.product_id&&Number.isFinite(C.quantity)&&C.quantity>0);T(!0);try{const C=yt,I=yt?`${API_BASE}/api/orders/${yt}`:`${API_BASE}/api/orders`,d=g[0],j=Array.isArray(y==null?void 0:y.adjustment_items)?y.adjustment_items:[],M=sa(j),Te=ra(M),dt=Ua(M),Ot={customer_name:y.customer_name,phone:i,address:y.address,note:(y.note||"").trim(),adjustment_amount:Te,adjustment_note:dt,adjustment_items:M,product_id:d.product_id,quantity:d.quantity,status:y.status,items:g,...yt?{id:yt}:{}};if(yt)await window.KTM.api.putJSON(I,Ot,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");else{const gt=await window.KTM.api.postJSON(I,Ot,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");Mn.current={id:(v=($=gt==null?void 0:gt.id)!=null?$:(u=gt==null?void 0:gt.order)==null?void 0:u.id)!=null?v:null,fingerprint:js(y),ts:Date.now()}}if(vr(i,y.customer_name,y.address),t==="drawer"){if(Hn(""),nn(null),Ye(!1),vn(!1),N(!1),Ae([]),Yn(),C){Mt(!0),Ft("");try{const gt=await $a(C);gt&&typeof gt=="object"&&nt(gt)}catch(gt){Ft((gt==null?void 0:gt.message)||"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c chi ti\u1EBFt \u0111\u01A1n")}finally{Mt(!1)}}}else n==="new"&&!yt?(Hn(""),nn(null),Ye(!0)):(Hn(""),nn(null),Ye(!1)),Yn()}catch(C){console.error(C),typeof B=="function"?B(C.message,"danger"):alert(C.message);return}finally{T(!1)}},wa=e=>window.KTM.orders.getOrderTotalMoney(e,_n),qs=async e=>{if(confirm("X\xF3a \u0111\u01A1n h\xE0ng n\xE0y?")){ye(e);try{await window.KTM.api.deleteJSON(`${API_BASE}/api/orders/${e}`,"L\u1ED7i x\xF3a \u0111\u01A1n h\xE0ng");try{const n=String(e);oe(t=>Array.isArray(t)?t.filter(a=>String(a==null?void 0:a.id)!==n):t),Fe(t=>Array.isArray(t)?t.filter(a=>String(a==null?void 0:a.id)!==n):t),bt(t=>Array.isArray(t)?t.filter(a=>String(a==null?void 0:a.id)!==n):t),$t(t=>Array.isArray(t)?t.filter(a=>String(a==null?void 0:a.id)!==n):t),le(t=>Array.isArray(t)?t.filter(a=>String(a==null?void 0:a.id)!==n):t)}catch(n){}try{St&&String(Se==null?void 0:Se.id)===String(e)&&Rs()}catch(n){}try{ce&&String(Kt==null?void 0:Kt.id)===String(e)&&qn()}catch(n){}Yn(),ga()}catch(n){console.error(n),typeof B=="function"?B(n.message,"danger"):alert(n.message)}finally{ye(null)}}},$r=()=>{const e=ee.current;if(!e)return;if(e.timer){try{clearTimeout(e.timer)}catch(o){}e.timer=null}const n=Array.isArray(e.events)?e.events.splice(0):[];if(!n.length||typeof B!="function")return;const t=new Map;for(const o of n){const g=String((o==null?void 0:o.orderId)||"").trim();g&&t.set(g,o)}const a=Array.from(t.values());if(!a.length)return;const i=o=>async()=>{try{for(const g of o)!(g!=null&&g.prevStatus)||!(g!=null&&g.orderId)||await Zn({id:g.orderId,status:g.nextStatus},g.prevStatus,{silentToast:!0,skipToastBatch:!0,fromUndo:!0});B(o.length>1?`\u0110\xE3 ho\xE0n t\xE1c ${o.length} \u0111\u01A1n`:"\u0110\xE3 ho\xE0n t\xE1c","info")}catch(g){B("Ho\xE0n t\xE1c th\u1EA5t b\u1EA1i","danger")}};if(a.length===1){const o=a[0],g=`${Dn(o.prevStatus)} \u2192 ${Dn(o.nextStatus)}`.trim();B(`\u0110\xE3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i: ${g}`,"success",{actionLabel:"Undo",durationMs:8500,onAction:i([o])});return}B(`\u0110\xE3 c\u1EADp nh\u1EADt ${a.length} \u0111\u01A1n`,"success",{actionLabel:"Undo",durationMs:9500,onAction:i(a)})},Dr=e=>{const n=ee.current;n&&(Array.isArray(n.events)||(n.events=[]),n.events.push(e),!n.timer&&(n.timer=setTimeout(()=>$r(),320)))};useEffect(()=>()=>{try{const e=ee.current;e!=null&&e.timer&&clearTimeout(e.timer)}catch(e){}},[]);const Zn=async(e,n,t={})=>{var g;const a=await Da(e),i=a==null?void 0:a.id;if(!i||!n)return;const o=gn(a==null?void 0:a.status);ue(i);try{const u=as(a),$=(Array.isArray(u)?u:[]).map(M=>{var Te,dt;return{product_id:(M==null?void 0:M.product_id)||"",quantity:Number((Te=M==null?void 0:M.quantity)!=null?Te:1),variant:String((M==null?void 0:M.variant)||"").trim()||null,variant_json:(dt=M==null?void 0:M.variant_json)!=null?dt:null,unit_price:(()=>{var bn;const Ot=(bn=M==null?void 0:M.unit_price)!=null?bn:M==null?void 0:M.unitPrice,gt=Number(Ot);return Number.isFinite(gt)?Math.max(0,Math.trunc(gt)):null})()}}).filter(M=>M.product_id&&Number.isFinite(M.quantity)&&M.quantity>0);if(!$.length)throw new Error("Kh\xF4ng th\u1EC3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i: \u0111\u01A1n kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m h\u1EE3p l\u1EC7");const v=$[0],C={id:i,customer_name:(a==null?void 0:a.customer_name)||"",phone:Gt((a==null?void 0:a.phone)||""),address:(a==null?void 0:a.address)||"",note:((a==null?void 0:a.note)||"").trim(),adjustment_amount:Number((g=a==null?void 0:a.adjustment_amount)!=null?g:0)||0,adjustment_note:(a==null?void 0:a.adjustment_note)||"",product_id:v.product_id,quantity:v.quantity,status:n,items:$};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${i}`,C,"L\u1ED7i c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i");const I=String(i),d=M=>({...M||{},status:n}),j=gn(n);if(oe(M=>Array.isArray(M)?M.map(Te=>String(Te==null?void 0:Te.id)===I?d(Te):Te):M),Fe(M=>Array.isArray(M)?M.flatMap(Te=>String(Te==null?void 0:Te.id)!==I?[Te]:j==="pending"?[d(Te)]:[]):M),bt(M=>Array.isArray(M)?j==="draft"?M.map(Te=>String(Te==null?void 0:Te.id)===I?d(Te):Te):M.filter(Te=>String(Te==null?void 0:Te.id)!==I):M),$t(M=>Array.isArray(M)?M.map(Te=>String(Te==null?void 0:Te.id)===I?d(Te):Te):M),le(M=>Array.isArray(M)?M.map(Te=>String(Te==null?void 0:Te.id)===I?d(Te):Te):M),nt(M=>String(M==null?void 0:M.id)===I?d(M):M),mn(M=>String(M==null?void 0:M.id)===I?d(M):M),p(M=>String(M==null?void 0:M.id)===I?d(M):M),Aa(i,!1),pr(i),t!=null&&t.silentToast)return;if(t!=null&&t.skipToastBatch){typeof B=="function"&&B("\u0110\xE3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i","success",{durationMs:4500});return}Dr({orderId:i,prevStatus:o,nextStatus:gn(n)})}catch(u){if(console.error(u),(!navigator.onLine||(u==null?void 0:u.name)==="TypeError"||String((u==null?void 0:u.message)||"").toLowerCase().includes("failed to fetch"))&&!(t!=null&&t.fromSync)){const v=String(i),C=d=>({...d||{},status:n}),I=gn(n);oe(d=>Array.isArray(d)?d.map(j=>String(j==null?void 0:j.id)===v?C(j):j):d),Fe(d=>Array.isArray(d)?d.flatMap(j=>String(j==null?void 0:j.id)!==v?[j]:I==="pending"?[C(j)]:[]):d),bt(d=>Array.isArray(d)?I==="draft"?d.map(j=>String(j==null?void 0:j.id)===v?C(j):j):d.filter(j=>String(j==null?void 0:j.id)!==v):d),$t(d=>Array.isArray(d)?d.map(j=>String(j==null?void 0:j.id)===v?C(j):j):d),le(d=>Array.isArray(d)?d.map(j=>String(j==null?void 0:j.id)===v?C(j):j):d),nt(d=>String(d==null?void 0:d.id)===v?C(d):d),mn(d=>String(d==null?void 0:d.id)===v?C(d):d),p(d=>String(d==null?void 0:d.id)===v?C(d):d),dr(i,n,o),typeof B=="function"&&B("M\u1EA5t m\u1EA1ng/timeout \u2022 \u0110\xE3 x\u1EBFp h\xE0ng \u0111\u1ED3ng b\u1ED9","info",{durationMs:6500});return}typeof B=="function"?B(u.message,"danger"):alert(u.message)}finally{ue(null)}};useEffect(()=>{const e=n=>{var a;const t=(a=n==null?void 0:n.detail)==null?void 0:a.key;if(t){if(t==="/"){setTimeout(()=>{var i,o;(o=(i=ln.current)==null?void 0:i.focus)==null||o.call(i)},0);return}if(t==="N"||t==="n"){Pa();return}if((t==="j"||t==="J"||t==="k"||t==="K")&&St&&(Se!=null&&Se.id)){const i=Array.isArray(an)?an:[],o=i.findIndex($=>String($==null?void 0:$.id)===String(Se==null?void 0:Se.id));if(o<0)return;const u=i[o+(t==="j"||t==="J"?-1:1)];u&&ba(u)}}};return window.addEventListener("ktm-admin-hotkey",e),()=>window.removeEventListener("ktm-admin-hotkey",e)},[an,St,Se]);const Ir=()=>React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"T\xEAn kh\xE1ch h\xE0ng *"),React.createElement("input",{className:"form-control",value:y.customer_name,onChange:e=>ge({...y,customer_name:e.target.value}),placeholder:"Nh\u1EADp t\xEAn kh\xE1ch h\xE0ng",required:!0,style:{borderRadius:10,padding:12}}),!!Rt.nameError&&React.createElement("div",{className:"form-text text-danger"},Rt.nameError)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i *"),React.createElement("input",{className:"form-control",type:"tel",inputMode:"numeric",id:"order-phone-input",value:y.phone,onChange:e=>Ms(e.target.value),onBlur:Ts,placeholder:"Nh\u1EADp s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",required:!0,style:{borderRadius:10,padding:12}}),!!Rt.phoneError&&React.createElement("div",{className:"form-text text-danger"},Rt.phoneError),!Rt.phoneError&&Cn.count>0&&React.createElement("div",{className:"form-text text-warning d-flex align-items-center justify-content-between gap-2"},React.createElement("span",null,"Kh\xE1ch n\xE0y \u0111\xE3 c\xF3 ",Cn.count," \u0111\u01A1n trong th\xE1ng ",Cn.monthKey,"."),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>N(e=>!e)},w?"\u1EA8n l\u1ECBch s\u1EED":"Xem l\u1ECBch s\u1EED")),w&&Cn.orders.length>0&&React.createElement("div",{className:"mt-2 border rounded-3 p-2",style:{background:"#fff"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between gap-2 mb-2"},React.createElement("div",{className:"small fw-semibold"},"L\u1ECBch s\u1EED \u0111\u01A1n (c\xF9ng th\xE1ng)"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>N(!1)},"\u1EA8n")),React.createElement("div",{className:"d-grid gap-2"},Cn.orders.slice(0,5).map(e=>React.createElement("div",{key:e.id,className:"d-flex align-items-start justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"small fw-semibold",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},"#",e.id," \u2022 ",React.createElement("span",{className:`badge ${oa(e.status)}`},Dn(e.status))),React.createElement("div",{className:"text-muted small"},ca(e.created_at)," \u2022 ",qt(wa(e))),React.createElement("div",{className:"text-muted small",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},da(e))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{confirm(`M\u1EDF \u0111\u01A1n #${e.id}? D\u1EEF li\u1EC7u \u0111ang nh\u1EADp s\u1EBD m\u1EA5t.`)&&Za(e)}},"M\u1EDF")))),Cn.orders.length>5&&React.createElement("div",{className:"text-muted small mt-2"},"Ch\u1EC9 hi\u1EC3n th\u1ECB 5 \u0111\u01A1n g\u1EA7n nh\u1EA5t.")),(x==null?void 0:x.status)==="loading"&&React.createElement("div",{className:"form-text"},"\u0110ang t\xECm kh\xE1ch theo S\u0110T..."),(x==null?void 0:x.status)==="found"&&React.createElement("div",{className:"form-text text-success"},"\u0110\xE3 c\xF3 kh\xE1ch, t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n th\xF4ng tin."),(x==null?void 0:x.status)==="not-found"&&React.createElement("div",{className:"form-text text-muted"},"Ch\u01B0a c\xF3 kh\xE1ch, s\u1EBD t\u1EA1o m\u1EDBi khi l\u01B0u \u0111\u01A1n."),(x==null?void 0:x.status)==="error"&&React.createElement("div",{className:"form-text text-danger"},"Kh\xF4ng tra \u0111\u01B0\u1EE3c kh\xE1ch (l\u1ED7i m\u1EA1ng/server).")),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("select",{className:"form-select",value:y.status,onChange:e=>ge({...y,status:e.target.value}),style:{borderRadius:10,padding:12}},React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n"))),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("input",{className:"form-control",value:y.address,onChange:e=>ge({...y,address:e.target.value}),placeholder:"Nh\u1EADp \u0111\u1ECBa ch\u1EC9 (kh\xF4ng b\u1EAFt bu\u1ED9c)",style:{borderRadius:10,padding:12}}),!!Rt.addressWarn&&React.createElement("div",{className:"form-text text-warning"},Rt.addressWarn)),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111\u01A1n h\xE0ng"),React.createElement("textarea",{className:"form-control",value:y.note,onChange:e=>ge({...y,note:e.target.value}),placeholder:"V\xED d\u1EE5: Giao gi\u1EDD h\xE0nh ch\xEDnh / G\u1ECDi tr\u01B0\u1EDBc khi giao...",rows:2,style:{borderRadius:10,padding:12,resize:"vertical"}})),React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110i\u1EC1u ch\u1EC9nh gi\xE1 (th\xEAm/b\u1EDBt)"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{ge(e=>({...e,adjustment_items:[...Array.isArray(e.adjustment_items)?e.adjustment_items:[{amount:"",note:""}],{amount:"",note:""}]}))}},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm \u0111i\u1EC1u ch\u1EC9nh")),React.createElement("div",{className:"d-grid gap-2"},En(y.adjustment_items).map((e,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label small text-muted mb-1"},"S\u1ED1 ti\u1EC1n"),React.createElement("input",{type:"text",inputMode:"numeric",className:"form-control",value:e.amount,onChange:t=>{const a=t.target.value;ge(i=>{const o=En(i.adjustment_items);return o[n]={...o[n],amount:a},{...i,adjustment_items:o}})},placeholder:"+500000 ho\u1EB7c -200000",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("label",{className:"form-label small text-muted mb-1"},"Ghi ch\xFA"),React.createElement("input",{className:"form-control",value:e.note,onChange:t=>{const a=t.target.value;ge(i=>{const o=En(i.adjustment_items);return o[n]={...o[n],note:a},{...i,adjustment_items:o}})},placeholder:"V\xED d\u1EE5: th\xEAm van 1 tay / gi\u1EA3m gi\xE1...",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-1 d-flex"},React.createElement("button",{type:"button",className:"btn btn-outline-danger w-100",onClick:()=>{ge(t=>{const a=En(t.adjustment_items);return a.splice(n,1),{...t,adjustment_items:a.length?a:[{amount:"",note:""}]}})},disabled:_||En(y.adjustment_items).length<=1,title:"X\xF3a \u0111i\u1EC1u ch\u1EC9nh",style:{borderRadius:10,padding:12}},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement("div",{className:"form-text"},"\xC2m = gi\u1EA3m gi\xE1, d\u01B0\u01A1ng = c\u1ED9ng th\xEAm."),!!Rt.adjustmentAbnormalWarn&&React.createElement("div",{className:"form-text text-warning"},Rt.adjustmentAbnormalWarn),!!Rt.adjustmentNoteWarn&&React.createElement("div",{className:"form-text text-warning"},Rt.adjustmentNoteWarn)),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1EA3n ph\u1EA9m *"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{ge(e=>({...e,items:[...Array.isArray(e.items)?e.items:[],{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]})),ot(e=>[...Array.isArray(e)?e:[],""]),yt&&Ae(e=>[...Array.isArray(e)?e:[],!0])},disabled:_},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(y.items)?y.items:[{product_id:"",quantity:1}]).map((e,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"dropdown w-100",ref:t=>{Zt.current[n]=t}},React.createElement("button",{type:"button",className:"form-control text-start d-flex align-items-center justify-content-between",style:{borderRadius:10,padding:12},onClick:()=>{At(t=>t===n?null:n),setTimeout(()=>{const t=document.getElementById(`order-product-search-${n}`);t&&t.focus()},0)}},React.createElement("span",{className:e.product_id?"":"text-muted",style:{minWidth:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},Os(e.product_id)),React.createElement("i",{className:"fas fa-chevron-down text-muted",style:{marginLeft:8,flexShrink:0}})),ct===n&&React.createElement("div",{className:"dropdown-menu show w-100 p-2",style:{maxHeight:320,overflowY:"auto"}},React.createElement("input",{id:`order-product-search-${n}`,className:"form-control",value:fe[n]||"",onChange:t=>{const a=t.target.value;ot(i=>{const o=Array.isArray(i)?[...i]:[];return o[n]=a,o})},placeholder:"T\xECm theo t\xEAn / m\xE3...",style:{borderRadius:10,padding:10}}),React.createElement("div",{className:"mt-2"}),(()=>{const t=Es(n);return t.length===0?React.createElement("div",{className:"text-muted small px-2 py-1"},"Kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p"):t.map(a=>React.createElement("button",{key:a.id,type:"button",className:"dropdown-item",onClick:()=>{const i=String(a.id),o=Vn(a==null?void 0:a.variants),g={};for(const v of o){const C=String((v==null?void 0:v.name)||"").trim(),I=Array.isArray(v==null?void 0:v.options)?v.options[0]:null,d=String((I==null?void 0:I.label)||"").trim();C&&d&&(g[C]=d)}const u=La(g),$=la(a,g);ge(v=>{const C=Array.isArray(v.items)?[...v.items]:[];return C[n]={...C[n]||{quantity:1},product_id:i,variant_json:Object.keys(g).length?g:null,variant:u,unit_price:o.length?$:null},{...v,items:C}}),At(null)}},a.name,a.code?` (${a.code})`:""))})()),React.createElement("select",{className:"form-select",value:e.product_id,onChange:()=>{},required:!0,style:{position:"absolute",opacity:0,height:0,pointerEvents:"none"},tabIndex:-1,"aria-hidden":"true"},React.createElement("option",{value:""},"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"),zt.map(t=>React.createElement("option",{key:t.id,value:t.id},t.name)))),(()=>{var a;const t=(a=Rt.items)==null?void 0:a[n];return t?React.createElement(React.Fragment,null,!!t.productError&&React.createElement("div",{className:"form-text text-danger"},t.productError),!!t.dupWarn&&React.createElement("div",{className:"form-text text-warning"},t.dupWarn)):null})(),(()=>{if(!(e!=null&&e.product_id))return null;const t=_n(e.product_id),a=Vn(t==null?void 0:t.variants);if(!a.length)return null;const i=e!=null&&e.variant_json&&typeof e.variant_json=="object"?e.variant_json:{};return React.createElement("div",{className:"mt-2 d-grid gap-2"},a.map((o,g)=>{const u=String((o==null?void 0:o.name)||`Bi\u1EBFn th\u1EC3 ${g+1}`).trim(),$=String((i==null?void 0:i[u])||"").trim();return React.createElement("div",{key:u},React.createElement("label",{className:"form-label small text-muted mb-1"},u),React.createElement("select",{className:"form-select",value:$,onChange:v=>{const C=String(v.target.value||"").trim();ge(I=>{const d=Array.isArray(I.items)?[...I.items]:[],j={...d[n]||{}},M=_n(j.product_id),Te=Vn(M==null?void 0:M.variants),dt=j!=null&&j.variant_json&&typeof j.variant_json=="object"?{...j.variant_json}:{};C?dt[u]=C:delete dt[u];const Ot=La(dt),gt=la(M,dt);return d[n]={...j,variant_json:Object.keys(dt).length?dt:null,variant:Ot,unit_price:gt},{...I,items:d}})},style:{borderRadius:10,padding:12}},React.createElement("option",{value:""},"-- ch\u1ECDn ",u," --"),(Array.isArray(o==null?void 0:o.options)?o.options:[]).map(v=>React.createElement("option",{key:v.label,value:v.label},v.label,Number.isFinite(Number(v==null?void 0:v.price))?` (${qt(Number(v.price))})`:Number(v==null?void 0:v.price_delta)?` (${v.price_delta>0?"+":""}${v.price_delta})`:""))))}))})(),yt&&React.createElement("div",{className:"form-check mt-1"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:`order-split-deliver-${n}`,checked:!!Oe[n],onChange:t=>{const a=!!t.target.checked;Ae(i=>{const o=Array.isArray(i)?[...i]:[],g=Array.isArray(y.items)?y.items.length:0;for(;o.length<g;)o.push(!0);return o[n]=a,o})},disabled:_||he}),React.createElement("label",{className:"form-check-label small text-muted",htmlFor:`order-split-deliver-${n}`},"Giao \u0111\u1EE3t 1"))),React.createElement("div",{className:"col-8 col-md-3"},React.createElement("input",{type:"number",className:"form-control",value:e.quantity,onChange:t=>{const a=t.target.value;ge(i=>{const o=Array.isArray(i.items)?[...i.items]:[];return o[n]={...o[n]||{product_id:""},quantity:a},{...i,items:o}})},min:"1",style:{borderRadius:10,padding:12}}),(()=>{var a;const t=(a=Rt.items)==null?void 0:a[n];return t&&t.qtyError?React.createElement("div",{className:"form-text text-danger"},t.qtyError):null})()),React.createElement("div",{className:"col-4 col-md-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>{ge(t=>{const a=Array.isArray(t.items)?[...t.items]:[];return a.splice(n,1),{...t,items:a.length?a:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]}}),ot(t=>{const a=Array.isArray(t)?[...t]:[];return a.splice(n,1),a.length?a:[""]}),Ae(t=>{const a=Array.isArray(t)?[...t]:[];return a.splice(n,1),a}),At(t=>t==null?t:t===n?null:t>n?t-1:t)},disabled:_||he||(Array.isArray(y.items)?y.items.length:1)<=1,title:"X\xF3a s\u1EA3n ph\u1EA9m",style:{borderRadius:10,padding:10}},React.createElement("i",{className:"fas fa-trash"}))))))),(()=>{const n=(Array.isArray(y.items)?y.items:[]).filter(u=>u==null?void 0:u.product_id),t=Na(n),a=va(n),i=Ja(y),o=i.amount,g=t+(a.found?a.fee:0)+o;return React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-column gap-1 small bg-light rounded-3 p-3"},React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1EA1m t\xEDnh"),React.createElement("span",{className:"fw-semibold"},qt(t))),a.found&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"Ship"),React.createElement("span",{className:"fw-semibold"},qt(a.fee))),!!Rt.shipAbnormalWarn&&React.createElement("div",{className:"text-warning"},Rt.shipAbnormalWarn),o!==0&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh"),React.createElement("span",{className:"fw-semibold"},qt(o))),(y.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111\u01A1n: ",(y.note||"").trim()),!!i.summaryText&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh: ",i.summaryText),React.createElement("div",{className:"d-flex justify-content-between pt-1 border-top"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng"),React.createElement("span",{className:"fw-bold"},qt(g)))))})()),[ea,sn]=useState(0),[Sa,Sn]=useState(!1),ta=useRef(null),Wn=useRef(null),Hs=e=>{try{return!e||typeof e.closest!="function"?!1:!!(e.closest(".modal, .dropdown-menu")||e.closest('[contenteditable="true"]')||e.closest(".orders-search")||e.closest('button, a, [role="button"]'))}catch(n){return!1}},qa=(e,n)=>{const a=String(e||"").trim().split("-"),i=Number(a[0]||0),o=Number(a[1]||0);if(!i||!o)return"";const g=new Date(i,o-1+Number(n||0),1);return`${g.getFullYear()}-${String(g.getMonth()+1).padStart(2,"0")}`},xa=()=>{try{const e=(window==null?void 0:window.innerWidth)||360;return Math.max(110,Math.min(180,Math.floor(e*.28)))}catch(e){return 140}},is=()=>Math.min(96,Math.max(66,Math.floor(xa()*.62))),zs=e=>{var n;try{if(xe||et||Y==="draft"||!(e!=null&&e.touches)||e.touches.length!==1||Sa||(n=Wn.current)!=null&&n.active)return;const t=e.target;if(Hs(t))return;const a=e.touches[0];ta.current={x:a.clientX,y:a.clientY,at:Date.now(),swiping:!1}}catch(t){ta.current=null}},Xs=e=>{var v,C,I,d;const n=ta.current;if(!n||Sa)return;const t=(e==null?void 0:e.touches)&&e.touches[0];if(!t)return;const a=t.clientX-n.x,i=t.clientY-n.y,o=Math.abs(a),g=Math.abs(i);if(!n.swiping)if(o>10&&o>g*1.15){n.swiping=!0,Sn(!1);try{(v=e.preventDefault)==null||v.call(e),(C=e.stopPropagation)==null||C.call(e)}catch(j){}}else return;const u=xa(),$=Math.max(-u,Math.min(u,a));sn($);try{(I=e.preventDefault)==null||I.call(e),(d=e.stopPropagation)==null||d.call(e)}catch(j){}},Vs=e=>{const n=ta.current;ta.current=null;try{if(!n||xe||et||Y==="draft")return;if(!n.swiping){sn(0);return}const t=(e==null?void 0:e.changedTouches)&&e.changedTouches[0];if(!t)return;const a=t.clientX-n.x,i=t.clientY-n.y,o=Date.now()-n.at,g=Math.abs(a),u=Math.abs(i);if(o>1e3)return;if(g<24){sn(0);return}if(g<u*1.45)return;const $=is(),v=g>=$,C=a>0?1:-1,I=xa();if(!v){Sn(!0),sn(0),setTimeout(()=>Sn(!1),220);return}const d=C>0?-1:1,j=String(S||jn||"").trim(),M=qa(j,d);if(!M){Sn(!0),sn(0),setTimeout(()=>Sn(!1),220);return}if(String(M)>String(jn)){Sn(!0),sn(C*Math.floor(I*.55)),setTimeout(()=>{sn(0),setTimeout(()=>Sn(!1),200)},140);return}Sn(!0),sn(C*I),setTimeout(()=>{q(M),sn(-C*I),requestAnimationFrame(()=>{requestAnimationFrame(()=>{sn(0),setTimeout(()=>Sn(!1),220)})})},140)}catch(t){}},Ws=()=>{ta.current=null,sn(0)},Gs=e=>{var n,t;try{if(xe||et||Y==="draft"||Sa||(e==null?void 0:e.pointerType)==="mouse"&&e.button!=null&&e.button!==0)return;const a=e.target;if(Hs(a))return;ta.current=null,Wn.current={active:!0,pointerId:e.pointerId,startX:e.clientX,startY:e.clientY,at:Date.now(),lock:null,swiping:!1,captured:!1};try{(t=(n=e.currentTarget)==null?void 0:n.setPointerCapture)==null||t.call(n,e.pointerId),Wn.current.captured=!0}catch(i){}}catch(a){Wn.current=null}},Js=e=>{var $,v;const n=Wn.current;if(!n||!n.active||Sa)return;const t=e.clientX-n.startX,a=e.clientY-n.startY,i=Math.abs(t),o=Math.abs(a);if(n.lock||(i>10||o>10)&&(n.lock=i>o*1.15?"x":"y"),n.lock!=="x"){n.swiping&&sn(0);return}n.swiping=!0;const g=xa(),u=Math.max(-g,Math.min(g,t));sn(u);try{($=e.preventDefault)==null||$.call(e),(v=e.stopPropagation)==null||v.call(e)}catch(C){}},Us=e=>{var t,a;const n=Wn.current;Wn.current=null;try{if(!n||!n.active||xe||et||Y==="draft")return;if(n.captured)try{(a=(t=e.currentTarget)==null?void 0:t.releasePointerCapture)==null||a.call(t,n.pointerId)}catch(dt){}if(!n.swiping){sn(0);return}const i=e.clientX-n.startX,o=e.clientY-n.startY,g=Date.now()-n.at,u=Math.abs(i),$=Math.abs(o);if(g>1e3)return;if(u<24){sn(0);return}if(u<$*1.45)return;const v=is(),C=u>=v,I=i>0?1:-1,d=xa();if(!C){Sn(!0),sn(0),setTimeout(()=>Sn(!1),220);return}const j=I>0?-1:1,M=String(S||jn||"").trim(),Te=qa(M,j);if(!Te){Sn(!0),sn(0),setTimeout(()=>Sn(!1),220);return}if(String(Te)>String(jn)){Sn(!0),sn(I*Math.floor(d*.55)),setTimeout(()=>{sn(0),setTimeout(()=>Sn(!1),200)},140);return}Sn(!0),sn(I*d),setTimeout(()=>{q(Te),sn(-I*d),requestAnimationFrame(()=>{requestAnimationFrame(()=>{sn(0),setTimeout(()=>Sn(!1),220)})})},140)}catch(i){}},Ys=()=>{Wn.current=null,sn(0)},Qs=ea>0?"Th\xE1ng tr\u01B0\u1EDBc":ea<0?"Th\xE1ng sau":"",os=ea>0?qa(String(S||jn||"").trim(),-1):ea<0?qa(String(S||jn||"").trim(),1):"",Zs=os&&String(os)<=String(jn)?os:"",Rr=Math.min(1,Math.abs(ea)/Math.max(1,is()));return React.createElement("div",{className:"product-manager"},React.createElement(Loading,{show:_||!!z||!!we}),!!Qs&&React.createElement("div",{"aria-hidden":"true",style:{position:"fixed",left:0,right:0,top:84,zIndex:1060,pointerEvents:"none",opacity:.15+.55*Rr,transform:"translateZ(0)"}},React.createElement("div",{className:"d-flex justify-content-center"},React.createElement("div",{className:"px-3 py-2 rounded-pill bg-dark text-white shadow-sm",style:{fontSize:13}},ea>0?"\u2190":"\u2192"," ",Qs,Zs?` \xB7 ${Zs}`:""))),React.createElement("div",{className:"orders-ops-toolbar card p-3"},React.createElement("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0}},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("h5",{className:"mb-0"},"\u0110\u01A1n h\xE0ng"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.all," \u0111\u01A1n"),et&&React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-25 text-dark"},"Search mode")),React.createElement("div",{className:"text-muted small mt-1"},"Hotkeys: ",React.createElement("span",{className:"fw-semibold"},"/")," search \u2022 ",React.createElement("span",{className:"fw-semibold"},"N")," t\u1EA1o \u0111\u01A1n \u2022 ",React.createElement("span",{className:"fw-semibold"},"Esc")," \u0111\xF3ng drawer")),React.createElement("div",{className:"d-flex gap-2"},React.createElement("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>et?Is(st):Yn(),disabled:rn,title:"L\xE0m m\u1EDBi"},React.createElement("i",{className:"fas fa-rotate"})),React.createElement("button",{className:"btn btn-dark btn-sm",onClick:()=>Pa(),disabled:_||!!z},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o \u0111\u01A1n"))),React.createElement("div",{className:"orders-chip-row mt-3"},React.createElement("button",{type:"button",className:`orders-chip d-md-none ${re&&!xe&&!et?"active":""}`,onClick:()=>{et&&Ke(""),$e(!1),We(!1),De(e=>!e)},title:"\u0110\u01A1n \u01B0u ti\xEAn (\u0111\xE3 ghim)"},React.createElement("i",{className:"fas fa-star me-1"}),"\u01AFu ti\xEAn"," ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Nr)),React.createElement("button",{type:"button",className:`orders-chip d-md-none ${Ie&&!xe&&!et?"active":""}`,onClick:()=>{et&&Ke(""),$e(!1),De(!1),We(e=>!e)},title:"\u0110\u01A1n c\u1EA7n x\u1EED l\xFD h\xF4m nay"},React.createElement("i",{className:"fas fa-calendar me-1"}),"H\xF4m nay"," ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},wr)),React.createElement("button",{type:"button",className:`orders-chip ${!Y&&!xe&&!et?"active":""}`,onClick:()=>{et&&Ke(""),$e(!1),de("")}},"T\u1EA5t c\u1EA3 ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.all)),React.createElement("button",{type:"button",className:`orders-chip ${Y==="draft"&&!xe&&!et?"active":""}`,onClick:()=>{et&&Ke(""),$e(!1),de("draft"),q("")}},"Nh\xE1p ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.draft)),React.createElement("button",{type:"button",className:`orders-chip ${Y==="pending"&&!xe&&!et?"active":""}`,onClick:()=>{et&&Ke(""),$e(!1),de("pending")}},"Ch\u1EDD x\u1EED l\xFD ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.pending)),React.createElement("button",{type:"button",className:`orders-chip ${Y==="processing"&&!xe&&!et?"active":""}`,onClick:()=>{et&&Ke(""),$e(!1),de("processing")}},"V\u1EADn chuy\u1EC3n ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.processing)),React.createElement("button",{type:"button",className:`orders-chip ${Y==="done"&&!xe&&!et?"active":""}`,onClick:()=>{et&&Ke(""),$e(!1),de("done")}},"Ho\xE0n th\xE0nh ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.done)),React.createElement("button",{type:"button",className:`orders-chip ${Y==="paid"&&!xe&&!et?"active":""}`,onClick:()=>{et&&Ke(""),$e(!1),de("paid")}},"\u0110\xE3 nh\u1EADn ti\u1EC1n ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.paid)),React.createElement("button",{type:"button",className:`orders-chip ${Y==="canceled"&&!xe&&!et?"active":""}`,onClick:()=>{et&&Ke(""),$e(!1),de("canceled")}},"H\u1EE7y ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.canceled))),React.createElement("div",{className:"orders-presets mt-2 d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>Fn("thisMonth"),disabled:et},React.createElement("i",{className:"fas fa-calendar me-2"}),"Th\xE1ng n\xE0y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger",onClick:()=>Fn("overduePending"),disabled:et},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"Ch\u1EADm > ",Pn," ng\xE0y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>Fn("draftExpiring"),disabled:et},React.createElement("i",{className:"fas fa-clock me-2"}),"Nh\xE1p s\u1EAFp h\u1EE7y"),(Y||xe||!S&&!et)&&React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>Fn("all")},"Clear")),React.createElement("div",{className:"orders-filterbar mt-3 d-flex flex-wrap gap-2 align-items-center",style:{touchAction:"pan-y",transform:`translateX(${ea}px)`,transition:Sa?"transform 220ms ease":"none",willChange:"transform"},onTouchStartCapture:zs,onTouchMoveCapture:Xs,onTouchEndCapture:Vs,onTouchCancelCapture:Ws,onPointerDownCapture:Gs,onPointerMoveCapture:Js,onPointerUpCapture:Us,onPointerCancelCapture:Ys},React.createElement("div",{className:"input-group input-group-sm orders-search"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-search"})),React.createElement("input",{ref:ln,type:"text",className:"form-control",value:st,onChange:e=>Ke(e.target.value),placeholder:"Search t\xEAn / S\u0110T\u2026 (nh\u1EA5n /)","aria-label":"Search \u0111\u01A1n h\xE0ng theo t\xEAn ho\u1EB7c S\u0110T"}),String(st||"").trim()&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>Ke(""),disabled:rn},React.createElement("i",{className:"fas fa-times"})),rn&&React.createElement("span",{className:"input-group-text",title:"\u0110ang search...","aria-label":"\u0110ang search"},React.createElement("span",{className:"spinner-border spinner-border-sm text-warning",role:"status","aria-hidden":"true"}))),React.createElement("div",{className:"input-group input-group-sm orders-month"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:S,onChange:e=>q(e.target.value),"aria-label":"Ch\u1ECDn th\xE1ng",disabled:xe||et})),React.createElement("div",{className:"text-muted small ms-auto"},et?"Search b\u1ECF qua filter":xe?"\u0110ang xem \u0111\u01A1n ch\u1EADm":Y?`L\u1ECDc: ${Dn(Y)}`:Xe?"Vu\u1ED1t tr\xE1i/ph\u1EA3i \u0111\u1EC3 \u0111\u1ED5i th\xE1ng":""))),React.createElement("div",{className:`orders-context-header d-md-none ${f?"visible":""}`,title:"Vu\u1ED1t tr\xE1i/ph\u1EA3i \u0111\u1EC3 \u0111\u1ED5i th\xE1ng",onTouchStartCapture:zs,onTouchMoveCapture:Xs,onTouchEndCapture:Vs,onTouchCancelCapture:Ws,onPointerDownCapture:Gs,onPointerMoveCapture:Js,onPointerUpCapture:Us,onPointerCancelCapture:Ys},React.createElement("div",{className:"orders-context-text"},(()=>{if(et){const e=String(st||"").trim();return`Search: ${e?`"${e}"`:""} \u2022 ${an.length} k\u1EBFt qu\u1EA3`}return xe?`\u0110\u01A1n ch\u1EADm \u2022 ${an.length} \u0111\u01A1n`:re?`\u01AFu ti\xEAn \u2022 ${an.length} \u0111\u01A1n`:Ie?`H\xF4m nay \u2022 ${an.length} \u0111\u01A1n`:Y?`L\u1ECDc: ${Dn(Y)} \u2022 ${an.length} \u0111\u01A1n`:`T\u1EA5t c\u1EA3 \u2022 ${an.length} \u0111\u01A1n`})()),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{Ke(""),De(!1),We(!1),Fn("all")},"aria-label":"Clear"},"Clear")),React.createElement("div",{className:"card p-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},"Danh s\xE1ch \u0111\u01A1n h\xE0ng"),React.createElement("span",{className:"text-muted small"},et?`${an.length} k\u1EBFt qu\u1EA3`:Y?`${Oa.length}/${Ne.length} \u0111\u01A1n`:`${Ne.length}${Ee?"+":""} \u0111\u01A1n`)),et&&jt&&React.createElement("div",{className:"alert alert-danger mt-3 mb-0",role:"alert"},jt),Ka.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"C\xF3 ",React.createElement("strong",null,Ka.length)," \u0111\u01A1n ",React.createElement("strong",null,"Ch\u1EDD x\u1EED l\xFD")," qu\xE1 ",Pn," ng\xE0y.",Le&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{$e(!0),de("pending")}},"Xem ngay")),_s.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-clock me-2"}),"C\xF3 ",React.createElement("strong",null,_s.length)," \u0111\u01A1n ",React.createElement("strong",null,"Nh\xE1p")," s\u1EAFp t\u1EF1 h\u1EE7y (c\xF2n \u2264 ",Xa," ng\xE0y).",_t&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{$e(!1),de("draft"),q(""),Yn()}},"Xem ngay")),(et?rn:Ve)?React.createElement("div",{className:"orders-skeleton-wrap mt-3"},React.createElement("div",{className:"d-md-none"},new Array(6).fill(0).map((e,n)=>React.createElement("div",{key:n,className:"card mb-2"},React.createElement("div",{className:"card-body p-3"},React.createElement("div",{className:"admin-skeleton-line w-50 mb-2"}),React.createElement("div",{className:"admin-skeleton-line w-75 mb-2"}),React.createElement("div",{className:"admin-skeleton-line w-35"}))))),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive orders-table-wrap mt-3"},React.createElement("table",{className:"table orders-table align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"SL"),React.createElement("th",null,"T\u1ED5ng ti\u1EC1n"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"),React.createElement("th",null,"Th\u1EDDi gian"),React.createElement("th",null))),React.createElement("tbody",null,new Array(10).fill(0).map((e,n)=>React.createElement("tr",{key:n},React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-60"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-70"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-85"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-30"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-50"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-40"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-55"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-40"}))))))))):(et?an.length===0:Ne.length===0)?React.createElement("div",{className:"text-center py-4 text-muted"},et?"Kh\xF4ng c\xF3 k\u1EBFt qu\u1EA3":"Ch\u01B0a c\xF3 \u0111\u01A1n h\xE0ng"):!et&&Oa.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},"Kh\xF4ng c\xF3 \u0111\u01A1n ph\xF9 h\u1EE3p"):React.createElement(React.Fragment,null,React.createElement("div",{className:"d-md-none mt-3"},Ds.map(e=>{var n;return React.createElement("div",{key:e.id,className:`orders-mobile-swipe-shell mb-2 ${(xt==null?void 0:xt.id)===String(e.id)?`swipe-preview swipe-${(xt==null?void 0:xt.dir)||""}`:""}`,role:"button",tabIndex:0,onClick:()=>{if(un.current){un.current=!1;return}ba(e)},onPointerDown:t=>{if(ce||r||Xt||t.button!=null&&t.button!==0)return;const a=String(e.id);un.current=!1,Ue.current={active:!0,id:a,startX:t.clientX,startY:t.clientY,dx:0,dy:0,lock:null,pointerId:t.pointerId,captured:!1},at(i=>(i==null?void 0:i.id)===a?i:{id:a,dir:null});try{t.currentTarget.classList.remove("swiping"),t.currentTarget.style.setProperty("--swipe-x","0px"),t.currentTarget.style.setProperty("--swipe-p","0"),t.currentTarget.style.setProperty("--swipe-l","0"),t.currentTarget.style.setProperty("--swipe-r","0")}catch(i){}try{on.current&&clearTimeout(on.current)}catch(i){}Nn.current=a,on.current=setTimeout(async()=>{var o,g,u,$;const i=Nn.current;if(i)try{if((g=(o=Vt.current)==null?void 0:o.has)!=null&&g.call(o,i))return;const v=await $a(i);v&&typeof v=="object"&&(($=(u=Vt.current)==null?void 0:u.set)==null||$.call(u,i,v))}catch(v){}},150)},onPointerMove:t=>{const a=Ue.current;if(!(a!=null&&a.active)||String(a.id)!==String(e.id))return;const i=t.clientX-a.startX,o=t.clientY-a.startY;if(a.dx=i,a.dy=o,Math.abs(i)>14||Math.abs(o)>14){try{on.current&&clearTimeout(on.current)}catch(d){}on.current=null,Nn.current=null}if(!a.lock){const d=Math.abs(i),j=Math.abs(o);if((d>10||j>10)&&(a.lock=d>j*1.2?"x":"y",a.lock==="x"&&!a.captured))try{t.currentTarget.setPointerCapture(t.pointerId),a.captured=!0}catch(M){}}if(a.lock!=="x"){try{t.currentTarget.classList.remove("swiping"),t.currentTarget.style.setProperty("--swipe-x","0px"),t.currentTarget.style.setProperty("--swipe-p","0"),t.currentTarget.style.setProperty("--swipe-l","0"),t.currentTarget.style.setProperty("--swipe-r","0")}catch(d){}Math.abs(o)>24&&at(d=>(d==null?void 0:d.id)===a.id?{id:a.id,dir:null}:d);return}const g=!!aa(e==null?void 0:e.status,"right"),u=!!aa(e==null?void 0:e.status,"left"),$=(d,j,M)=>Math.max(j,Math.min(M,d)),v=$(i,-140,140),C=v>0&&!g||v<0&&!u?v*.35:v,I=$(Math.abs(C)/88,0,1);try{t.currentTarget.classList.add("swiping"),t.currentTarget.style.setProperty("--swipe-x",`${C}px`),t.currentTarget.style.setProperty("--swipe-p",String(I)),t.currentTarget.style.setProperty("--swipe-l",C>0&&g?String(I):"0"),t.currentTarget.style.setProperty("--swipe-r",C<0&&u?String(I):"0")}catch(d){}Math.abs(C)>12&&(un.current=!0),i>72&&g?at({id:a.id,dir:"right"}):i<-72&&u?at({id:a.id,dir:"left"}):at({id:a.id,dir:null})},onPointerCancel:t=>{try{on.current&&clearTimeout(on.current)}catch(i){}on.current=null,Nn.current=null;const a=Ue.current;try{a!=null&&a.captured&&(a==null?void 0:a.pointerId)!=null&&t.currentTarget.releasePointerCapture(a.pointerId)}catch(i){}Ue.current={active:!1,id:null,startX:0,startY:0,dx:0,dy:0,lock:null,pointerId:null,captured:!1},at({id:null,dir:null});try{t.currentTarget.classList.remove("swiping"),t.currentTarget.style.setProperty("--swipe-x","0px"),t.currentTarget.style.setProperty("--swipe-p","0"),t.currentTarget.style.setProperty("--swipe-l","0"),t.currentTarget.style.setProperty("--swipe-r","0")}catch(i){}},onPointerUp:t=>{try{on.current&&clearTimeout(on.current)}catch(C){}on.current=null,Nn.current=null;const a=Ue.current;if(!(a!=null&&a.active)||String(a.id)!==String(e.id)){at({id:null,dir:null});return}try{a!=null&&a.captured&&(a==null?void 0:a.pointerId)!=null&&t.currentTarget.releasePointerCapture(a.pointerId)}catch(C){}Ue.current={active:!1,id:null,startX:0,startY:0,dx:0,dy:0,lock:null,pointerId:null,captured:!1};const i=Number(a.dx)||0,o=Math.abs(i),g=a.lock==="x",u=gn(e==null?void 0:e.status);at({id:null,dir:null});try{t.currentTarget.classList.remove("swiping"),t.currentTarget.style.setProperty("--swipe-x","0px"),t.currentTarget.style.setProperty("--swipe-p","0"),t.currentTarget.style.setProperty("--swipe-l","0"),t.currentTarget.style.setProperty("--swipe-r","0")}catch(C){}if(g&&o>12&&(un.current=!0),!g||o<88)return;t.preventDefault(),t.stopPropagation();const $=i>0?aa(e==null?void 0:e.status,"right"):aa(e==null?void 0:e.status,"left"),v=gn($);!v||v===u||Zn(e,v)},onKeyDown:t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),ba(e))},title:"Xem chi ti\u1EBFt"},React.createElement("div",{className:"orders-mobile-swipe-bg","aria-hidden":"true"},React.createElement("div",{className:"orders-mobile-swipe-bg-left"},React.createElement("div",{className:"orders-mobile-swipe-label"},(()=>{const t=aa(e==null?void 0:e.status,"right"),a=Ss(t),i=(a==null?void 0:a.label)||String(t||"").trim();return i?React.createElement(React.Fragment,null,React.createElement("i",{className:`fas ${a.icon||"fa-circle"}`}),i):null})())),React.createElement("div",{className:"orders-mobile-swipe-bg-right"},React.createElement("div",{className:"orders-mobile-swipe-label"},(()=>{const t=aa(e==null?void 0:e.status,"left"),a=Ss(t),i=(a==null?void 0:a.label)||String(t||"").trim();return i?React.createElement(React.Fragment,null,React.createElement("i",{className:`fas ${a.icon||"fa-circle"}`}),i):null})()))),React.createElement("div",{className:`card orders-mobile-card ${A!=null&&A[String(e.id)]?"order-recent-updated":""}`},React.createElement("div",{className:"card-body p-3 order-card-mobile"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"flex-grow-1",style:{minWidth:0}},React.createElement("div",{className:"fw-semibold order-customer-name"},e.customer_name),React.createElement("div",{className:"fw-bold font-monospace order-phone",role:"button",tabIndex:0,onPointerDown:t=>mr(t,e.phone),onPointerMove:Wa,onPointerUp:t=>ur(t,e.phone),onPointerCancel:Wa,onPointerLeave:Wa,onContextMenu:t=>{t.preventDefault(),t.stopPropagation()},onClick:t=>{if(t.stopPropagation(),tn.current){tn.current=!1;return}vs(e.phone)},onKeyDown:t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),t.stopPropagation(),vs(e.phone))},title:"Ch\u1EA1m \u0111\u1EC3 copy \u2022 Gi\u1EEF \u0111\u1EC3 g\u1ECDi"},e.phone),Number((n=e==null?void 0:e.split_seq)!=null?n:0)>0&&React.createElement("div",{className:"text-muted small"},"\u0110\u1EE3t ",e.split_seq),(()=>{const t=bs(e);if(!t)return null;const a=K.has(String(e.id)),i=t.length>84||ys(e).length>84;return React.createElement(React.Fragment,null,React.createElement("div",{className:`text-muted small order-address ${a?"":"order-text-collapsed"}`},t),i&&React.createElement("button",{type:"button",className:"btn btn-link p-0 order-expand-btn",onClick:o=>{o.stopPropagation(),hs(e.id)}},a?"Thu g\u1ECDn":"Xem th\xEAm"))})(),(()=>{const t=ys(e);if(!t)return null;const a=K.has(String(e.id)),i=bs(e).length,o=i>84||t.length>84;return React.createElement(React.Fragment,null,React.createElement("div",{className:`text-muted small order-note ${a?"":"order-text-collapsed"}`},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",t),o&&i<=0&&React.createElement("button",{type:"button",className:"btn btn-link p-0 order-expand-btn",onClick:g=>{g.stopPropagation(),hs(e.id)}},a?"Thu g\u1ECDn":"Xem th\xEAm"))})()),React.createElement("div",{className:"d-flex align-items-start gap-1 flex-shrink-0"},React.createElement("button",{type:"button",className:`btn btn-sm btn-link order-pin-btn ${se.has(String(e.id))?"active":""}`,onClick:t=>{t.stopPropagation(),rr(e.id)},title:se.has(String(e.id))?"B\u1ECF ghim":"Ghim","aria-label":se.has(String(e.id))?"B\u1ECF ghim":"Ghim"},React.createElement("i",{className:se.has(String(e.id))?"fas fa-star":"far fa-star"})),!!(xn!=null&&xn[String(e.id)])&&React.createElement("span",{className:"badge bg-info text-dark orders-sync-badge",title:"\u0110ang \u0111\u1ED3ng b\u1ED9","aria-label":"\u0110ang \u0111\u1ED3ng b\u1ED9"},React.createElement("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}),"Sync"),React.createElement("button",{type:"button",className:`badge ${oa(e.status)} order-status-badge-btn`,onPointerDown:t=>{t.stopPropagation(),je.current=!1;try{Pe.current&&clearTimeout(Pe.current)}catch(a){}Pe.current=setTimeout(()=>{je.current=!0,ps(e,t.currentTarget)},420)},onPointerUp:t=>{t.stopPropagation();try{Pe.current&&clearTimeout(Pe.current)}catch(a){}Pe.current=null},onPointerCancel:t=>{t.stopPropagation();try{Pe.current&&clearTimeout(Pe.current)}catch(a){}Pe.current=null},onClick:t=>{if(t.stopPropagation(),je.current){je.current=!1;return}Xt&&String(H==null?void 0:H.id)===String(e.id)?Un():ps(e,t.currentTarget)},title:"\u0110\u1ED5i tr\u1EA1ng th\xE1i nhanh"},Dn(e.status)),Ma(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${Pn} ng\xE0y`},"\u26A0 Ch\u1EADm ",ha(e),"d"),_a(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 h\u1EE7y sau ${Jn} ng\xE0y`},"\u23F3 C\xF2n ",Ta(e),"d"))),React.createElement("div",{className:"mt-2 small"},React.createElement("div",null,React.createElement("div",{className:"text-muted"},"S\u1EA3n ph\u1EA9m:"),(()=>{const t=ja(e);return t.length?React.createElement("div",{className:"mt-1"},t.map((a,i)=>React.createElement("div",{key:i,className:"d-flex justify-content-between gap-2",style:{lineHeight:1.25}},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,whiteSpace:"normal",wordBreak:"break-word",flex:1}},React.createElement("span",{className:"text-muted me-1"},i+1,"."),a.name),React.createElement("div",{className:"text-muted small text-end text-nowrap",style:{flexShrink:0}},"x",a.qty,Number(a.unitPrice)>0?` \u2022 ${qt(a.unitPrice)}`:"")))):React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},da(e))})()),(ya(e)!==0||Qn(e))&&React.createElement("div",{style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh:")," ",React.createElement("span",{className:"fw-semibold"},qt(ya(e))),Qn(e)?React.createElement("span",{className:"text-muted"}," ","(",Qn(e),")"):null),React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng ti\u1EC1n"),React.createElement("span",{className:"fw-bold"},qt(wa(e)))),React.createElement("div",{className:"text-muted"},React.createElement("span",null,"Th\u1EDDi gian:")," ",ca(e.created_at))),React.createElement("div",{className:"mt-3 d-flex gap-2 align-items-center order-card-actions"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:t=>{t.stopPropagation(),Fa(e)},disabled:_||!!z||we===e.id},React.createElement("i",{className:"fas fa-copy me-1"}),"Copy"),React.createElement("button",{type:"button",className:"btn btn-sm btn-dark orders-mobile-action",onClick:t=>{t.stopPropagation(),us(e)},disabled:_||!!z||we===e.id,"aria-label":"M\u1EDF thao t\xE1c nhanh"},React.createElement("i",{className:"fas fa-bolt me-1"}),"Thao t\xE1c")))))}),React.createElement("div",{ref:Qt,className:"orders-mobile-sentinel","aria-hidden":"true"}),Array.isArray(an)&&Ds.length<an.length&&React.createElement("div",{className:"text-center text-muted small py-2"},"\u0110ang t\u1EA3i th\xEAm\u2026")),Xt&&H&&React.createElement("div",{className:"orders-status-popover-root",role:"dialog","aria-modal":"true",onClick:()=>Un()},React.createElement("div",{className:`orders-status-popover ${(G==null?void 0:G.placement)||""}`,style:{left:G.left,top:G.top},onClick:e=>e.stopPropagation()},React.createElement("div",{className:"orders-status-popover-title"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0}},H.customer_name||"\u0110\u01A1n h\xE0ng"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>Un(),"aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"orders-status-popover-grid"},ua.map(e=>{const n=gn(H.status)===gn(e.value),t=_||!!z||we===H.id;return React.createElement("button",{key:e.value,type:"button",className:`orders-status-chip ${n?"active":""}`,onClick:()=>{n||(Zn(H,e.value),Un())},disabled:t},e.label)})),React.createElement("div",{className:"orders-status-popover-footer"},React.createElement("button",{type:"button",className:"btn btn-sm btn-dark",onClick:()=>{us(H),Un()}},React.createElement("i",{className:"fas fa-bolt me-2"}),"Thao t\xE1c")))),ce&&Kt&&React.createElement("div",{className:"admin-sheet-root",role:"dialog","aria-modal":"true",onClick:()=>qn()},React.createElement("div",{className:"admin-sheet",onClick:e=>e.stopPropagation()},React.createElement("div",{className:"admin-sheet-handle"}),React.createElement("div",{className:"admin-sheet-header"},React.createElement("div",{style:{minWidth:0}},React.createElement("div",{className:"fw-semibold admin-sheet-title"},Kt.customer_name||"\u0110\u01A1n h\xE0ng"),React.createElement("div",{className:"text-muted small d-flex align-items-center gap-2",style:{flexWrap:"wrap"}},React.createElement("span",{className:"font-monospace"},Kt.phone||""),React.createElement("span",{className:`badge ${oa(Kt.status)}`},Dn(Kt.status)))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>qn(),"aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"admin-sheet-actions"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{Fa(Kt),qn()},disabled:_||!!z||we===Kt.id},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy"),!!String(Kt.phone||"").trim()&&React.createElement("a",{className:"btn btn-outline-secondary",href:`tel:${String(Kt.phone||"").trim()}`,onClick:()=>qn()},React.createElement("i",{className:"fas fa-phone me-2"}),"G\u1ECDi"),React.createElement("button",{type:"button",className:"btn btn-dark",onClick:()=>{ba(Kt),qn()}},React.createElement("i",{className:"fas fa-eye me-2"}),"M\u1EDF chi ti\u1EBFt"),React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>qs(Kt.id),disabled:_||!!z||we===Kt.id},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a")),React.createElement("div",{className:"admin-sheet-section-title"},"\u0110\u1ED5i tr\u1EA1ng th\xE1i"),React.createElement("div",{className:"orders-status-grid"},ua.map(e=>{const n=gn(Kt.status)===gn(e.value),t=_||!!z||we===Kt.id;return React.createElement("button",{key:e.value,type:"button",className:`orders-status-chip ${n?"active":""}`,onClick:()=>{n||(Zn(Kt,e.value),qn())},disabled:t},e.label)})))),r&&React.createElement("div",{className:"admin-sheet-root",role:"dialog","aria-modal":"true",onClick:()=>Ca()},React.createElement("div",{className:"admin-sheet",onClick:e=>e.stopPropagation()},React.createElement("div",{className:"admin-sheet-handle"}),React.createElement("div",{className:"admin-sheet-header"},React.createElement("div",{style:{minWidth:0}},React.createElement("div",{className:"fw-semibold admin-sheet-title"},"L\u1ECDc \u0111\u01A1n h\xE0ng"),React.createElement("div",{className:"text-muted small"},"T\u1ED1i \u01B0u cho thao t\xE1c m\u1ED9t tay")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>Ca(),"aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"p-3"},React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>Fn("thisMonth"),disabled:et},React.createElement("i",{className:"fas fa-calendar me-2"}),"Th\xE1ng n\xE0y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger",onClick:()=>Fn("overduePending"),disabled:et},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"Ch\u1EADm"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>Fn("draftExpiring"),disabled:et},React.createElement("i",{className:"fas fa-clock me-2"}),"Nh\xE1p s\u1EAFp h\u1EE7y")),React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"fw-semibold mb-2"},"Tr\u1EA1ng th\xE1i"),React.createElement("div",{className:"orders-filter-chip-grid"},React.createElement("button",{type:"button",className:`orders-filter-chip ${!Y&&!xe?"active":""}`,onClick:()=>{et&&Ke(""),$e(!1),de("")}},"T\u1EA5t c\u1EA3"),ua.map(e=>React.createElement("button",{key:e.value,type:"button",className:`orders-filter-chip ${Y===e.value&&!xe?"active":""}`,onClick:()=>{et&&Ke(""),$e(!1),de(e.value),e.value==="draft"&&q("")}},e.label)))),React.createElement("div",{className:"mt-3"},React.createElement("label",{className:"form-label small text-muted mb-1"},"Th\xE1ng"),React.createElement("input",{type:"month",className:"form-control",value:S,onChange:e=>q(e.target.value),disabled:xe||et}),React.createElement("div",{className:"form-text"},"B\u1EADt \u201CCh\u1EADm\u201D s\u1EBD b\u1ECF qua th\xE1ng.")),React.createElement("div",{className:"form-check mt-3"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"ordersOverdueOnly",checked:xe,onChange:e=>{et&&Ke("");const n=!!e.target.checked;$e(n),n&&(q(""),de("pending"))},disabled:et}),React.createElement("label",{className:"form-check-label",htmlFor:"ordersOverdueOnly"},"Ch\u1EC9 xem \u0111\u01A1n ch\u1EADm > ",Pn," ng\xE0y")),React.createElement("div",{className:"d-flex gap-2 mt-4"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>Fn("all"),disabled:et},"Reset"),React.createElement("button",{type:"button",className:"btn btn-dark flex-grow-1",onClick:()=>Ca()},"Xong"))))),React.createElement("div",{className:`orders-mobile-toolbar d-md-none ${k?"visible":""}`},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onPointerDown:e=>{if(!(e.button!=null&&e.button!==0)){O.current=!1;try{Be.current&&clearTimeout(Be.current)}catch(n){}Be.current=setTimeout(()=>{O.current=!0,fs(st)},460)}},onPointerUp:()=>{try{Be.current&&clearTimeout(Be.current)}catch(e){}Be.current=null},onPointerCancel:()=>{try{Be.current&&clearTimeout(Be.current)}catch(e){}Be.current=null},onClick:()=>{if(O.current){O.current=!1;return}try{window.scrollTo({top:0,behavior:"smooth"})}catch(e){}setTimeout(()=>{var e,n;return(n=(e=ln.current)==null?void 0:e.focus)==null?void 0:n.call(e)},120)},"aria-label":"Search"},React.createElement("i",{className:"fas fa-search me-2"}),"Search"),React.createElement("button",{type:"button",className:"btn btn-dark",onClick:()=>Pa(),disabled:_||!!z,"aria-label":"T\u1EA1o \u0111\u01A1n"},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o \u0111\u01A1n"),React.createElement("button",{type:"button",className:"btn btn-outline-dark",onClick:()=>sr(),"aria-label":"L\u1ECDc"},React.createElement("i",{className:"fas fa-sliders me-2"}),"L\u1ECDc")),Ce&&React.createElement("div",{className:"orders-search-palette-root",role:"dialog","aria-modal":"true",onClick:()=>{pa(pe),$n()}},React.createElement("div",{className:"orders-search-palette",onClick:e=>e.stopPropagation(),onTouchStart:e=>{const n=e.touches&&e.touches[0];n&&(me.current={active:!0,startY:n.clientY,startX:n.clientX,fired:!1})},onTouchMove:e=>{const n=me.current;if(!(n!=null&&n.active)||n.fired)return;const t=e.touches&&e.touches[0];if(!t)return;const a=t.clientY-n.startY,i=t.clientX-n.startX;Math.abs(i)>24||a>90&&(n.fired=!0,pa(pe),$n())},onTouchEnd:()=>{me.current={active:!1,startY:0,startX:0,fired:!1}}},React.createElement("div",{className:"orders-search-palette-header"},React.createElement("div",{className:"fw-semibold"},"T\xECm nhanh"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{pa(pe),$n()},"aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"orders-search-palette-body"},React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-search"})),React.createElement("input",{ref:Nt,type:"text",className:"form-control",value:pe,onChange:e=>{const n=e.target.value;ze(n),Ke(n)},placeholder:"Nh\u1EADp t\xEAn / S\u0110T\u2026",onKeyDown:e=>{e.key==="Enter"&&(pa(pe),$n())}}),!!String(pe||"").trim()&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{ze(""),Ke("")}},React.createElement("i",{className:"fas fa-times"}))),Array.isArray(Dt)&&Dt.length>0&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"text-muted small mb-2"},"G\u1EA7n \u0111\xE2y"),React.createElement("div",{className:"orders-chip-row",style:{marginTop:0}},Dt.slice(0,8).map(e=>React.createElement("button",{key:e,type:"button",className:"orders-chip",onClick:()=>{ze(e),Ke(e),pa(e),$n()}},e)))),React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"text-muted small mb-2"},"Filter nhanh"),React.createElement("div",{className:"orders-filter-chip-grid"},React.createElement("button",{type:"button",className:`orders-filter-chip ${re?"active":""}`,onClick:()=>{Ke(""),ze(""),$e(!1),We(!1),De(e=>!e),$n()}},React.createElement("i",{className:"fas fa-star me-2"}),"\u01AFu ti\xEAn"),React.createElement("button",{type:"button",className:`orders-filter-chip ${Ie?"active":""}`,onClick:()=>{Ke(""),ze(""),$e(!1),De(!1),We(e=>!e),$n()}},React.createElement("i",{className:"fas fa-calendar me-2"}),"H\xF4m nay"),React.createElement("button",{type:"button",className:`orders-filter-chip ${xe?"active":""}`,onClick:()=>{Ke(""),ze(""),$e(e=>!e),xe||(q(""),de("pending")),$n()}},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"Ch\u1EADm"),React.createElement("button",{type:"button",className:`orders-filter-chip ${!Y&&!xe&&!re&&!Ie?"active":""}`,onClick:()=>{Ke(""),ze(""),$e(!1),De(!1),We(!1),de(""),$n()}},"T\u1EA5t c\u1EA3"),ua.map(e=>React.createElement("button",{key:e.value,type:"button",className:`orders-filter-chip ${Y===e.value&&!xe?"active":""}`,onClick:()=>{Ke(""),ze(""),$e(!1),De(!1),We(!1),de(e.value),e.value==="draft"&&q(""),$n()}},e.label))))),React.createElement("div",{className:"orders-search-palette-hint text-muted small"},"Tip: Gi\u1EEF n\xFAt Search \u0111\u1EC3 m\u1EDF \u2022 Vu\u1ED1t xu\u1ED1ng \u0111\u1EC3 \u0111\xF3ng"))),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive orders-table-wrap mt-3"},React.createElement("table",{className:"table orders-table table-hover align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"SL"),React.createElement("th",null,"T\u1ED5ng ti\u1EC1n"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"),React.createElement("th",null,"Th\u1EDDi gian"),React.createElement("th",null))),React.createElement("tbody",null,an.map(e=>React.createElement("tr",{key:e.id,style:{cursor:"pointer"},onClick:()=>ba(e),title:"Xem chi ti\u1EBFt"},React.createElement("td",null,React.createElement("div",{className:"fw-semibold"},e.customer_name),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("td",null,e.phone),React.createElement("td",null,(()=>{const n=ja(e);return n.length?React.createElement("div",{className:"d-grid gap-1"},n.map((t,a)=>React.createElement("div",{key:a,className:"small",style:{whiteSpace:"normal",wordBreak:"break-word",lineHeight:1.2}},React.createElement("span",{className:"text-muted me-1"},a+1,"."),React.createElement("span",{className:"fw-semibold"},t.name)," ",React.createElement("span",{className:"text-muted"},"x",t.qty),Number(t.unitPrice)>0&&React.createElement("span",{className:"text-muted"}," ","\u2022 ",qt(t.unitPrice))))):da(e)})()),React.createElement("td",null,Ls(e)),React.createElement("td",{className:"fw-semibold"},qt(wa(e))),React.createElement("td",null,React.createElement("div",{className:"d-flex align-items-center gap-1 flex-wrap"},React.createElement("span",{className:`badge ${oa(e.status)}`},Dn(e.status)),Ma(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${Pn} ng\xE0y`},"\u26A0 Ch\u1EADm ",ha(e),"d"),_a(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 h\u1EE7y sau ${Jn} ng\xE0y`},"\u23F3 C\xF2n ",Ta(e),"d"))),React.createElement("td",null,ca(e.created_at)),React.createElement("td",null,React.createElement("div",{className:"d-flex gap-2 justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:n=>{n.stopPropagation(),Fa(e)},disabled:_||!!z||we===e.id},React.createElement("i",{className:"fas fa-copy"})),React.createElement("select",{className:"form-select form-select-sm orders-status-quick",defaultValue:"",onClick:n=>n.stopPropagation(),onChange:n=>{n.stopPropagation();const t=String(n.target.value||"").trim();n.target.value="",t&&Zn(e,t)},disabled:_||!!z||we===e.id,"aria-label":"\u0110\u1ED5i tr\u1EA1ng th\xE1i"},React.createElement("option",{value:""},"Status\u2026"),React.createElement("option",{value:"pending"},"Pending"),React.createElement("option",{value:"processing"},"Processing"),React.createElement("option",{value:"done"},"Done"),React.createElement("option",{value:"paid"},"Paid"),React.createElement("option",{value:"canceled"},"H\u1EE7y")))))))))),!et&&Ee&&!xe&&React.createElement("div",{className:"d-flex justify-content-center mt-3"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:xr,disabled:Ve||ke},ke?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2","aria-hidden":"true"}),"\u0110ang t\u1EA3i th\xEAm..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-angle-down me-2"}),"T\u1EA3i th\xEAm \u0111\u01A1n"))))),React.createElement(AdminDrawer,{open:St,title:(()=>{const e=Se,n=e!=null&&e.id?`#${e.id}`:"",t=e!=null&&e.status?`\u2022 ${Dn(e.status)}`:"";return`\u0110\u01A1n h\xE0ng ${n} ${t}`.trim()})(),subtitle:(()=>{const e=Se,n=String((e==null?void 0:e.customer_name)||"").trim(),t=String((e==null?void 0:e.phone)||"").trim(),a=e!=null&&e.created_at?ca(e.created_at):"";return[n||t||null,a||null].filter(Boolean).join(" \u2022 ")})(),onClose:Rs,footer:React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},yn?React.createElement(React.Fragment,null,React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{vn(!1),nn(null),Hn(""),N(!1),Ae([])},disabled:_||he},React.createElement("i",{className:"fas fa-xmark me-2"}),"H\u1EE7y s\u1EEDa"),!!yt&&React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary fw-semibold",onClick:()=>Ks("drawer"),disabled:_||he,title:"Ch\u1ECDn s\u1EA3n ph\u1EA9m giao \u0111\u1EE3t 1 v\xE0 t\xE1ch ph\u1EA7n c\xF2n l\u1EA1i sang \u0111\u01A1n ch\u1EDD h\xE0ng"},he?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang t\xE1ch..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-random me-2"}),"T\xE1ch giao ngay"))),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-warning fw-semibold",onClick:()=>Ba({mode:"close",origin:"drawer"}),disabled:_||he||!Rt.canSubmit,style:{boxShadow:"0 4px 12px rgba(255,193,7,0.25)"}},_?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u")))):React.createElement(React.Fragment,null,React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>Se&&Fa(Se),disabled:!Se||Jt||_||!!z},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy"),React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>Se&&Za(Se),disabled:!Se||Jt||_||!!z},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger",onClick:()=>Se&&qs(Se.id),disabled:!Se||Jt||_||!!z},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a")),React.createElement("div",{className:"d-flex flex-wrap gap-2 align-items-center"},React.createElement("select",{className:"form-select form-select-sm",defaultValue:"",onChange:e=>{const n=String(e.target.value||"").trim();e.target.value="",n&&Se&&Zn(Se,n)},disabled:!Se||Jt||_||!!z||we===(Se==null?void 0:Se.id),"aria-label":"\u0110\u1ED5i tr\u1EA1ng th\xE1i",style:{minWidth:140}},React.createElement("option",{value:""},"Status\u2026"),React.createElement("option",{value:"pending"},"Pending"),React.createElement("option",{value:"processing"},"Processing"),React.createElement("option",{value:"done"},"Done"),React.createElement("option",{value:"paid"},"Paid"),React.createElement("option",{value:"canceled"},"H\u1EE7y")))))},yn?React.createElement("form",{onSubmit:e=>{e.preventDefault(),Ba({mode:"close",origin:"drawer"})}},React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-pen me-2 text-warning"}),"Ch\u1EC9nh s\u1EEDa"),Ir())):Jt?React.createElement("div",{className:"admin-drawer-section"},React.createElement("div",{className:"text-muted small mb-2"},"\u0110ang t\u1EA3i chi ti\u1EBFt\u2026"),React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("span",{className:"spinner-border spinner-border-sm text-warning","aria-hidden":"true"}),React.createElement("span",{className:"text-muted"},"Vui l\xF2ng ch\u1EDD"))):dn?React.createElement("div",{className:"alert alert-danger",role:"alert"},dn):Se?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"T\u1ED5ng quan"),React.createElement("div",{className:"d-flex flex-wrap gap-2 mb-2"},React.createElement("span",{className:`badge ${oa(Se.status)}`},Dn(Se.status)),Ma(Se)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${Pn} ng\xE0y`},"\u26A0 Ch\u1EADm ",ha(Se),"d"),_a(Se)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 h\u1EE7y sau ${Jn} ng\xE0y`},"\u23F3 C\xF2n ",Ta(Se),"d")),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"T\u1ED5ng ti\u1EC1n"),React.createElement("div",{className:"v"},qt(wa(Se))),React.createElement("div",{className:"k"},"S\u1ED1 l\u01B0\u1EE3ng"),React.createElement("div",{className:"v"},Ls(Se)),React.createElement("div",{className:"k"},"Th\u1EDDi gian"),React.createElement("div",{className:"v"},ca(Se.created_at)))),React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-user me-2 text-info"}),"Kh\xE1ch h\xE0ng"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"T\xEAn"),React.createElement("div",{className:"v"},Se.customer_name||"\u2014"),React.createElement("div",{className:"k"},"S\u0110T"),React.createElement("div",{className:"v",style:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}},React.createElement("span",{className:"font-monospace"},Se.phone||"\u2014"),!!String(Se.phone||"").trim()&&React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>window.KTM.clipboard.writeText(String(Se.phone||"").trim()),title:"Copy S\u0110T"},React.createElement("i",{className:"fas fa-copy"}))),React.createElement("div",{className:"k"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("div",{className:"v"},Se.address||"\u2014")),((Se==null?void 0:Se.note)||"").trim()&&React.createElement("div",{className:"mt-2 text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(Se.note||"").trim())),React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-boxes-stacked me-2 text-primary"}),"S\u1EA3n ph\u1EA9m"),(()=>{const e=ja(Se);return e.length?React.createElement("div",{className:"d-grid gap-2"},e.map((n,t)=>React.createElement("div",{key:t,className:"d-flex justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted me-1"},t+1,"."),n.name),n.variant?React.createElement("div",{className:"text-muted small"},n.variant):null),React.createElement("div",{className:"text-muted small text-end text-nowrap",style:{flexShrink:0}},"x",n.qty,Number(n.unitPrice)>0?` \u2022 ${qt(n.unitPrice)}`:"")))):React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},da(Se)||"\u2014")})(),(ya(Se)!==0||Qn(Se))&&React.createElement("div",{className:"mt-2",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh:")," ",React.createElement("span",{className:"fw-semibold"},qt(ya(Se))),Qn(Se)?React.createElement("span",{className:"text-muted"}," ","(",Qn(Se),")"):null))):React.createElement("div",{className:"text-muted"},"Ch\u01B0a c\xF3 d\u1EEF li\u1EC7u")),Qe&&React.createElement("div",{className:"modal show d-block order-modal",style:{background:"rgba(0,0,0,0.6)"},role:"dialog","aria-modal":"true"},React.createElement("div",{className:"modal-dialog modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ffca2c)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark mb-0"},React.createElement("i",{className:"fas fa-receipt me-2"}),yt?"S\u1EEDa \u0111\u01A1n h\xE0ng":"T\u1EA1o \u0111\u01A1n h\xE0ng"),React.createElement("button",{type:"button",className:"btn-close",onClick:es})),React.createElement("form",{onSubmit:e=>{e.preventDefault(),Ba({mode:"close",origin:"modal"})}},React.createElement("div",{className:"modal-body",ref:en},React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"T\xEAn kh\xE1ch h\xE0ng *"),React.createElement("input",{className:"form-control",value:y.customer_name,onChange:e=>ge({...y,customer_name:e.target.value}),placeholder:"Nh\u1EADp t\xEAn kh\xE1ch h\xE0ng",required:!0,style:{borderRadius:10,padding:12}}),!!Rt.nameError&&React.createElement("div",{className:"form-text text-danger"},Rt.nameError)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i *"),React.createElement("input",{className:"form-control",type:"tel",inputMode:"numeric",id:"order-phone-input",value:y.phone,onChange:e=>Ms(e.target.value),onBlur:Ts,placeholder:"Nh\u1EADp s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",required:!0,style:{borderRadius:10,padding:12}}),!!Rt.phoneError&&React.createElement("div",{className:"form-text text-danger"},Rt.phoneError),!Rt.phoneError&&Cn.count>0&&React.createElement("div",{className:"form-text text-warning d-flex align-items-center justify-content-between gap-2"},React.createElement("span",null,"Kh\xE1ch n\xE0y \u0111\xE3 c\xF3 ",Cn.count," \u0111\u01A1n trong th\xE1ng ",Cn.monthKey,"."),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>N(e=>!e)},w?"\u1EA8n l\u1ECBch s\u1EED":"Xem l\u1ECBch s\u1EED")),w&&Cn.orders.length>0&&React.createElement("div",{className:"mt-2 border rounded-3 p-2",style:{background:"#fff"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between gap-2 mb-2"},React.createElement("div",{className:"small fw-semibold"},"L\u1ECBch s\u1EED \u0111\u01A1n (c\xF9ng th\xE1ng)"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>N(!1)},"\u1EA8n")),React.createElement("div",{className:"d-grid gap-2"},Cn.orders.slice(0,5).map(e=>React.createElement("div",{key:e.id,className:"d-flex align-items-start justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"small fw-semibold",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},"#",e.id," \u2022 ",React.createElement("span",{className:`badge ${oa(e.status)}`},Dn(e.status))),React.createElement("div",{className:"text-muted small"},ca(e.created_at)," \u2022 ",qt(wa(e))),React.createElement("div",{className:"text-muted small",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},da(e))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{confirm(`M\u1EDF \u0111\u01A1n #${e.id}? D\u1EEF li\u1EC7u \u0111ang nh\u1EADp s\u1EBD m\u1EA5t.`)&&Za(e)}},"M\u1EDF")))),Cn.orders.length>5&&React.createElement("div",{className:"text-muted small mt-2"},"Ch\u1EC9 hi\u1EC3n th\u1ECB 5 \u0111\u01A1n g\u1EA7n nh\u1EA5t.")),(x==null?void 0:x.status)==="loading"&&React.createElement("div",{className:"form-text"},"\u0110ang t\xECm kh\xE1ch theo S\u0110T..."),(x==null?void 0:x.status)==="found"&&React.createElement("div",{className:"form-text text-success"},"\u0110\xE3 c\xF3 kh\xE1ch, t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n th\xF4ng tin."),(x==null?void 0:x.status)==="not-found"&&React.createElement("div",{className:"form-text text-muted"},"Ch\u01B0a c\xF3 kh\xE1ch, s\u1EBD t\u1EA1o m\u1EDBi khi l\u01B0u \u0111\u01A1n."),(x==null?void 0:x.status)==="error"&&React.createElement("div",{className:"form-text text-danger"},"Kh\xF4ng tra \u0111\u01B0\u1EE3c kh\xE1ch (l\u1ED7i m\u1EA1ng/server).")),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("select",{className:"form-select",value:y.status,onChange:e=>ge({...y,status:e.target.value}),style:{borderRadius:10,padding:12}},React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n"))),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("input",{className:"form-control",value:y.address,onChange:e=>ge({...y,address:e.target.value}),placeholder:"Nh\u1EADp \u0111\u1ECBa ch\u1EC9 (kh\xF4ng b\u1EAFt bu\u1ED9c)",style:{borderRadius:10,padding:12}}),!!Rt.addressWarn&&React.createElement("div",{className:"form-text text-warning"},Rt.addressWarn)),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111\u01A1n h\xE0ng"),React.createElement("textarea",{className:"form-control",value:y.note,onChange:e=>ge({...y,note:e.target.value}),placeholder:"V\xED d\u1EE5: Giao gi\u1EDD h\xE0nh ch\xEDnh / G\u1ECDi tr\u01B0\u1EDBc khi giao...",rows:2,style:{borderRadius:10,padding:12,resize:"vertical"}})),React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110i\u1EC1u ch\u1EC9nh gi\xE1 (th\xEAm/b\u1EDBt)"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{ge(e=>({...e,adjustment_items:[...Array.isArray(e.adjustment_items)?e.adjustment_items:[{amount:"",note:""}],{amount:"",note:""}]}))}},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm \u0111i\u1EC1u ch\u1EC9nh")),React.createElement("div",{className:"d-grid gap-2"},En(y.adjustment_items).map((e,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label small text-muted mb-1"},"S\u1ED1 ti\u1EC1n"),React.createElement("input",{type:"text",inputMode:"numeric",className:"form-control",value:e.amount,onChange:t=>{const a=t.target.value;ge(i=>{const o=En(i.adjustment_items);return o[n]={...o[n],amount:a},{...i,adjustment_items:o}})},placeholder:"+500000 ho\u1EB7c -200000",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("label",{className:"form-label small text-muted mb-1"},"Ghi ch\xFA"),React.createElement("input",{className:"form-control",value:e.note,onChange:t=>{const a=t.target.value;ge(i=>{const o=En(i.adjustment_items);return o[n]={...o[n],note:a},{...i,adjustment_items:o}})},placeholder:"V\xED d\u1EE5: th\xEAm van 1 tay / gi\u1EA3m gi\xE1...",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-1 d-flex"},React.createElement("button",{type:"button",className:"btn btn-outline-danger w-100",onClick:()=>{ge(t=>{const a=En(t.adjustment_items);return a.splice(n,1),{...t,adjustment_items:a.length?a:[{amount:"",note:""}]}})},disabled:_||En(y.adjustment_items).length<=1,title:"X\xF3a \u0111i\u1EC1u ch\u1EC9nh",style:{borderRadius:10,padding:12}},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement("div",{className:"form-text"},"\xC2m = gi\u1EA3m gi\xE1, d\u01B0\u01A1ng = c\u1ED9ng th\xEAm."),!!Rt.adjustmentAbnormalWarn&&React.createElement("div",{className:"form-text text-warning"},Rt.adjustmentAbnormalWarn),!!Rt.adjustmentNoteWarn&&React.createElement("div",{className:"form-text text-warning"},Rt.adjustmentNoteWarn)),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1EA3n ph\u1EA9m *"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{ge(e=>({...e,items:[...Array.isArray(e.items)?e.items:[],{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]})),ot(e=>[...Array.isArray(e)?e:[],""]),yt&&Ae(e=>[...Array.isArray(e)?e:[],!0])},disabled:_},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(y.items)?y.items:[{product_id:"",quantity:1}]).map((e,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"dropdown w-100",ref:t=>{Zt.current[n]=t}},React.createElement("button",{type:"button",className:"form-control text-start d-flex align-items-center justify-content-between",style:{borderRadius:10,padding:12},onClick:()=>{At(t=>t===n?null:n),setTimeout(()=>{const t=document.getElementById(`order-product-search-${n}`);t&&t.focus()},0)}},React.createElement("span",{className:e.product_id?"":"text-muted",style:{minWidth:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},Os(e.product_id)),React.createElement("i",{className:"fas fa-chevron-down text-muted",style:{marginLeft:8,flexShrink:0}})),ct===n&&React.createElement("div",{className:"dropdown-menu show w-100 p-2",style:{maxHeight:320,overflowY:"auto"}},React.createElement("input",{id:`order-product-search-${n}`,className:"form-control",value:fe[n]||"",onChange:t=>{const a=t.target.value;ot(i=>{const o=Array.isArray(i)?[...i]:[];return o[n]=a,o})},placeholder:"T\xECm theo t\xEAn / m\xE3...",style:{borderRadius:10,padding:10}}),React.createElement("div",{className:"mt-2"}),(()=>{const t=Es(n);return t.length===0?React.createElement("div",{className:"text-muted small px-2 py-1"},"Kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p"):t.map(a=>React.createElement("button",{key:a.id,type:"button",className:"dropdown-item",onClick:()=>{const i=String(a.id),o=Vn(a==null?void 0:a.variants),g={};for(const v of o){const C=String((v==null?void 0:v.name)||"").trim(),I=Array.isArray(v==null?void 0:v.options)?v.options[0]:null,d=String((I==null?void 0:I.label)||"").trim();C&&d&&(g[C]=d)}const u=La(g),$=la(a,g);ge(v=>{const C=Array.isArray(v.items)?[...v.items]:[];return C[n]={...C[n]||{quantity:1},product_id:i,variant_json:Object.keys(g).length?g:null,variant:u,unit_price:o.length?$:null},{...v,items:C}}),At(null)}},a.name,a.code?` (${a.code})`:""))})()),React.createElement("select",{className:"form-select",value:e.product_id,onChange:()=>{},required:!0,style:{position:"absolute",opacity:0,height:0,pointerEvents:"none"},tabIndex:-1,"aria-hidden":"true"},React.createElement("option",{value:""},"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"),zt.map(t=>React.createElement("option",{key:t.id,value:t.id},t.name)))),(()=>{var a;const t=(a=Rt.items)==null?void 0:a[n];return t?React.createElement(React.Fragment,null,!!t.productError&&React.createElement("div",{className:"form-text text-danger"},t.productError),!!t.dupWarn&&React.createElement("div",{className:"form-text text-warning"},t.dupWarn)):null})(),(()=>{if(!(e!=null&&e.product_id))return null;const t=_n(e.product_id),a=Vn(t==null?void 0:t.variants);if(!a.length)return null;const i=e!=null&&e.variant_json&&typeof e.variant_json=="object"?e.variant_json:{};return React.createElement("div",{className:"mt-2 d-grid gap-2"},a.map((o,g)=>{const u=String((o==null?void 0:o.name)||`Bi\u1EBFn th\u1EC3 ${g+1}`).trim(),$=String((i==null?void 0:i[u])||"").trim();return React.createElement("div",{key:u},React.createElement("label",{className:"form-label small text-muted mb-1"},u),React.createElement("select",{className:"form-select",value:$,onChange:v=>{const C=String(v.target.value||"").trim();ge(I=>{const d=Array.isArray(I.items)?[...I.items]:[],j={...d[n]||{}},M=_n(j.product_id),Te=Vn(M==null?void 0:M.variants),dt=j!=null&&j.variant_json&&typeof j.variant_json=="object"?{...j.variant_json}:{};C?dt[u]=C:delete dt[u];const Ot=La(dt),gt=la(M,dt);return d[n]={...j,variant_json:Object.keys(dt).length?dt:null,variant:Ot,unit_price:gt},{...I,items:d}})},style:{borderRadius:10,padding:12}},React.createElement("option",{value:""},"-- ch\u1ECDn ",u," --"),(Array.isArray(o==null?void 0:o.options)?o.options:[]).map(v=>React.createElement("option",{key:v.label,value:v.label},v.label,Number.isFinite(Number(v==null?void 0:v.price))?` (${qt(Number(v.price))})`:Number(v==null?void 0:v.price_delta)?` (${v.price_delta>0?"+":""}${v.price_delta})`:""))))}))})(),yt&&React.createElement("div",{className:"form-check mt-1"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:`order-split-deliver-${n}`,checked:!!Oe[n],onChange:t=>{const a=!!t.target.checked;Ae(i=>{const o=Array.isArray(i)?[...i]:[],g=Array.isArray(y.items)?y.items.length:0;for(;o.length<g;)o.push(!0);return o[n]=a,o})},disabled:_||he}),React.createElement("label",{className:"form-check-label small text-muted",htmlFor:`order-split-deliver-${n}`},"Giao \u0111\u1EE3t 1"))),React.createElement("div",{className:"col-8 col-md-3"},React.createElement("input",{type:"number",className:"form-control",value:e.quantity,onChange:t=>{const a=t.target.value;ge(i=>{const o=Array.isArray(i.items)?[...i.items]:[];return o[n]={...o[n]||{product_id:""},quantity:a},{...i,items:o}})},min:"1",style:{borderRadius:10,padding:12}}),(()=>{var a;const t=(a=Rt.items)==null?void 0:a[n];return t&&t.qtyError?React.createElement("div",{className:"form-text text-danger"},t.qtyError):null})()),React.createElement("div",{className:"col-4 col-md-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>{ge(t=>{const a=Array.isArray(t.items)?[...t.items]:[];return a.splice(n,1),{...t,items:a.length?a:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]}}),ot(t=>{const a=Array.isArray(t)?[...t]:[];return a.splice(n,1),a.length?a:[""]}),Ae(t=>{const a=Array.isArray(t)?[...t]:[];return a.splice(n,1),a}),At(t=>t==null?t:t===n?null:t>n?t-1:t)},disabled:_||he||(Array.isArray(y.items)?y.items.length:1)<=1,title:"X\xF3a s\u1EA3n ph\u1EA9m",style:{borderRadius:10,padding:10}},React.createElement("i",{className:"fas fa-trash"}))))))),(()=>{const n=(Array.isArray(y.items)?y.items:[]).filter(u=>u==null?void 0:u.product_id),t=Na(n),a=va(n),i=Ja(y),o=i.amount,g=t+(a.found?a.fee:0)+o;return React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-column gap-1 small bg-light rounded-3 p-3"},React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1EA1m t\xEDnh"),React.createElement("span",{className:"fw-semibold"},qt(t))),a.found&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"Ship"),React.createElement("span",{className:"fw-semibold"},qt(a.fee))),!!Rt.shipAbnormalWarn&&React.createElement("div",{className:"text-warning"},Rt.shipAbnormalWarn),o!==0&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh"),React.createElement("span",{className:"fw-semibold"},qt(o))),(y.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111\u01A1n: ",(y.note||"").trim()),!!i.summaryText&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh: ",i.summaryText),React.createElement("div",{className:"d-flex justify-content-between pt-1 border-top"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng"),React.createElement("span",{className:"fw-bold"},qt(g)))))})())),React.createElement("div",{className:"modal-footer",style:{border:"none"}},React.createElement("button",{type:"button",className:"btn btn-light",onClick:es,disabled:_||he,style:{borderRadius:10}},"H\u1EE7y"),!!yt&&React.createElement("button",{type:"button",className:"btn btn-outline-primary fw-semibold",onClick:()=>Ks("modal"),disabled:_||he,style:{borderRadius:10},title:"Ch\u1ECDn s\u1EA3n ph\u1EA9m giao \u0111\u1EE3t 1 v\xE0 t\xE1ch ph\u1EA7n c\xF2n l\u1EA1i sang \u0111\u01A1n ch\u1EDD h\xE0ng"},he?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang t\xE1ch..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-random me-2"}),"T\xE1ch \u0111\u01A1n giao ngay")),!yt&&React.createElement("button",{type:"button",className:"btn btn-outline-warning fw-semibold",onClick:()=>Ba({mode:"new",origin:"modal"}),disabled:_||!Rt.canSubmit,style:{borderRadius:10},title:"L\u01B0u xong gi\u1EEF form \u0111\u1EC3 t\u1EA1o \u0111\u01A1n m\u1EDBi"},React.createElement("i",{className:"fas fa-plus me-2"}),"L\u01B0u & t\u1EA1o \u0111\u01A1n m\u1EDBi"),React.createElement("button",{type:"submit",className:"btn btn-warning fw-semibold",disabled:_||he||!Rt.canSubmit,style:{borderRadius:10,boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},_?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u"))))))))}

