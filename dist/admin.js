const{useState,useEffect,useRef}=React,CLOUDINARY_CLOUD_NAME="diwxfpt92",CLOUDINARY_UPLOAD_PRESET="ktm_unsigned",API_BASE="";function LoginPage({onLogin:A,error:S}){const[D,ie]=useState(""),[G,x]=useState(""),[P,ce]=useState(!1),[de,U]=useState(!1);return React.createElement("div",{className:"login-page"},React.createElement("div",{className:"login-box"},React.createElement("div",{className:"text-center mb-4"},React.createElement("i",{className:"fas fa-tractor fa-3x text-warning mb-3"}),React.createElement("h4",{className:"text-dark"},"KTM Admin"),React.createElement("p",{className:"text-muted small"},"\u0110\u0103ng nh\u1EADp \u0111\u1EC3 qu\u1EA3n l\xFD")),S&&React.createElement("div",{className:"alert alert-danger py-2 small"},React.createElement("i",{className:"fas fa-exclamation-circle me-2"}),S),React.createElement("form",{onSubmit:async _e=>{_e.preventDefault(),ce(!0),await A(D,G),ce(!1)}},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small"},"T\xEAn \u0111\u0103ng nh\u1EADp"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-user"})),React.createElement("input",{type:"text",className:"form-control",value:D,onChange:_e=>ie(_e.target.value),placeholder:"admin",required:!0,autoFocus:!0}))),React.createElement("div",{className:"mb-4"},React.createElement("label",{className:"form-label small"},"M\u1EADt kh\u1EA9u"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-lock"})),React.createElement("input",{type:de?"text":"password",className:"form-control",value:G,onChange:_e=>x(_e.target.value),placeholder:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",required:!0}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>U(!de)},React.createElement("i",{className:`fas fa-eye${de?"-slash":""}`})))),React.createElement("button",{type:"submit",className:"btn btn-warning w-100",disabled:P},P?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang \u0111\u0103ng nh\u1EADp..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-sign-in-alt me-2"}),"\u0110\u0103ng nh\u1EADp"))),React.createElement("div",{className:"text-center mt-4"},React.createElement("a",{href:"/",className:"text-muted small text-decoration-none"},React.createElement("i",{className:"fas fa-arrow-left me-1"}),"V\u1EC1 trang ch\u1EE7"))))}function Toast({message:A,type:S,onClose:D}){return useEffect(()=>{const ie=setTimeout(D,3e3);return()=>clearTimeout(ie)},[]),React.createElement("div",{className:`toast show align-items-center text-white bg-${S} border-0`,role:"alert"},React.createElement("div",{className:"d-flex"},React.createElement("div",{className:"toast-body"},A),React.createElement("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto",onClick:D})))}function Loading({show:A}){return A?React.createElement("div",{className:"loading-overlay"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"3rem",height:"3rem"}},React.createElement("span",{className:"visually-hidden"},"\u0110ang t\u1EA3i..."))):null}function Sidebar({activeMenu:A,onMenuChange:S,onLogout:D,currentUser:ie}){return React.createElement("div",{className:"sidebar d-none d-md-block"},React.createElement("div",{className:"logo"},React.createElement("i",{className:"fas fa-tractor me-2"})," KTM Admin"),React.createElement("nav",{className:"nav flex-column mt-3"},[{id:"search",icon:"fa-search",label:"Tra c\u1EE9u nhanh",highlight:!0},{id:"albums",icon:"fa-images",label:"Qu\u1EA3n l\xFD Album"},{id:"videos",icon:"fa-video",label:"Qu\u1EA3n l\xFD Video"},{id:"products",icon:"fa-box",label:"S\u1EA3n ph\u1EA9m"},{id:"orders",icon:"fa-receipt",label:"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"},{id:"stats",icon:"fa-chart-column",label:"Th\u1ED1ng k\xEA"},{id:"settings",icon:"fa-cog",label:"C\xE0i \u0111\u1EB7t"}].map(x=>React.createElement("a",{key:x.id,href:"#",className:`nav-link ${A===x.id?"active":""} ${x.disabled?"opacity-50":""} ${x.highlight?"text-warning":""}`,onClick:P=>{P.preventDefault(),x.disabled||S(x.id)}},React.createElement("i",{className:`fas ${x.icon}`})," ",x.label,x.disabled&&React.createElement("span",{className:"badge bg-secondary ms-2"},"Soon"),x.highlight&&React.createElement("span",{className:"badge bg-warning text-dark ms-2"},"HOT")))),React.createElement("div",{className:"position-absolute bottom-0 w-100 p-3 border-top border-secondary"},React.createElement("div",{className:"d-flex justify-content-between align-items-center"},React.createElement("a",{href:"/",className:"text-white-50 text-decoration-none small"},React.createElement("i",{className:"fas fa-home me-1"})," Trang ch\u1EE7"),D&&React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:D,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"})))))}const ADMIN_SETTINGS_STORAGE_KEY="ktm_admin_settings_v1",DEFAULT_SHIP_PERCENT=1.64;function normalizeShipPercent(A){const S=typeof A=="number"?A:parseFloat(String(A!=null?A:"").trim());return Number.isFinite(S)?Math.max(0,Math.min(100,S)):DEFAULT_SHIP_PERCENT}function loadAdminSettings(){var A;try{const S=localStorage.getItem(ADMIN_SETTINGS_STORAGE_KEY);if(!S)return{ship_percent:DEFAULT_SHIP_PERCENT};const D=JSON.parse(S);return{ship_percent:normalizeShipPercent((A=D==null?void 0:D.ship_percent)!=null?A:D==null?void 0:D.shipPercent)}}catch(S){return{ship_percent:DEFAULT_SHIP_PERCENT}}}function saveAdminSettings(A){var S;try{const D={ship_percent:normalizeShipPercent((S=A==null?void 0:A.ship_percent)!=null?S:A==null?void 0:A.shipPercent)};return localStorage.setItem(ADMIN_SETTINGS_STORAGE_KEY,JSON.stringify(D)),D}catch(D){return{ship_percent:DEFAULT_SHIP_PERCENT}}}async function fetchAdminSettingsFromServer(){var S;const A=await window.KTM.api.getJSON(`${API_BASE}/api/settings`,"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t t\u1EEB DB");return{ship_percent:normalizeShipPercent((S=A==null?void 0:A.ship_percent)!=null?S:A==null?void 0:A.shipPercent)}}async function saveAdminSettingsToServer(A){var ie,G,x;const S={ship_percent:normalizeShipPercent((ie=A==null?void 0:A.ship_percent)!=null?ie:A==null?void 0:A.shipPercent)},D=await window.KTM.api.putJSON(`${API_BASE}/api/settings`,S,"Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t v\xE0o DB");return{ship_percent:normalizeShipPercent((x=(G=D==null?void 0:D.ship_percent)!=null?G:D==null?void 0:D.shipPercent)!=null?x:S.ship_percent)}}function AlbumList({albums:A,onSelect:S,onCreate:D,onEdit:ie,onDelete:G,loading:x,currentFolder:P,onBack:ce,breadcrumb:de}){return React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},P&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:ce},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),P?P.title:"Th\u01B0 vi\u1EC7n \u1EA3nh")),React.createElement("button",{className:"btn btn-warning",onClick:D},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder")),de&&de.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:U=>{U.preventDefault(),ce("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),de.map((U,be)=>React.createElement("li",{key:U.id,className:`breadcrumb-item ${be===de.length-1?"active":""}`},be===de.length-1?U.title:React.createElement("a",{href:"#",onClick:_e=>{_e.preventDefault(),ce(U)},className:"text-warning"},U.title))))),x?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):A.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},P?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder n\xE0o. H\xE3y t\u1EA1o folder \u0111\u1EA7u ti\xEAn!")):React.createElement("div",{className:"row g-3"},A.map(U=>React.createElement("div",{key:U.uuid||U.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card album-card h-100",onClick:()=>S(U)},U.cover?React.createElement("img",{src:U.cover,className:"album-cover",alt:U.title}):React.createElement("div",{className:"card-body text-center py-4"},React.createElement("i",{className:"fas fa-folder fa-3x text-warning mb-2"})),React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"card-title mb-1"},U.title),React.createElement("small",{className:"text-muted"},U.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),U.subfolderCount),U.subfolderCount>0&&U.count>0&&" \u2022 ",U.count>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-image me-1"}),U.count),U.subfolderCount===0&&U.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-2",onClick:be=>{be.stopPropagation(),ie(U)},title:"S\u1EEDa album"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:be=>{be.stopPropagation(),G(U)},title:"X\xF3a album"},React.createElement("i",{className:"fas fa-trash"}))))))))}function AlbumModal({show:A,album:S,onClose:D,onSave:ie,parentId:G}){const[x,P]=useState({slug:"",title:"",description:"",cover_url:"",parent_id:null}),[ce,de]=useState(!1),[U,be]=useState(!1),_e=useRef(null);useEffect(()=>{P(S?{slug:S.id||"",title:S.title||"",description:S.description||"",cover_url:S.cover||"",parent_id:S.parentId||null}:{slug:"",title:"",description:"",cover_url:"",parent_id:G||null})},[S,A,G]);const le=async ue=>{ue.preventDefault(),de(!0),await ie(x),de(!1)},re=ue=>ue.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),xe=async ue=>{const Ce=ue.type==="image/heic"||ue.type==="image/heif"||/\.heic$/i.test(ue.name);if(ue.size<=2097152&&!Ce)return ue;try{const qe=await createImageBitmap(ue),Ke=document.createElement("canvas");let Ie=qe.width,ke=qe.height;const Ee=800;return(Ie>Ee||ke>Ee)&&(Ie>ke?(ke=Math.round(ke/Ie*Ee),Ie=Ee):(Ie=Math.round(Ie/ke*Ee),ke=Ee)),Ke.width=Ie,Ke.height=ke,Ke.getContext("2d").drawImage(qe,0,0,Ie,ke),qe.close(),new Promise((ct,je)=>{Ke.toBlob(Xe=>{Xe?ct(new File([Xe],ue.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):je(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(qe){throw console.error("Compress cover error:",qe),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},Ue=async ue=>{var qe;const Se=ue.target.files[0];if(!Se)return;if(!(Se.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(Se.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}be(!0);try{const Ke=await xe(Se),Ie=await window.KTM.cloudinary.uploadImage({file:Ke,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-albums/covers"});if(!Ie.secure_url)throw console.error("Cloudinary error:",Ie),new Error(((qe=Ie.error)==null?void 0:qe.message)||"Upload failed");P(ke=>({...ke,cover_url:Ie.secure_url}))}catch(Ke){console.error("Cover upload error:",Ke),alert("L\u1ED7i upload \u1EA3nh b\xECa: "+Ke.message)}be(!1),ue.target.value=""};return A?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},S?"S\u1EEDa":"T\u1EA1o"," Folder"),React.createElement("button",{type:"button",className:"btn-close",onClick:D})),React.createElement("form",{onSubmit:le},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:x.title,onChange:ue=>P({...x,title:ue.target.value,slug:x.slug||re(ue.target.value)}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Slug (URL) *"),React.createElement("input",{type:"text",className:"form-control",value:x.slug,onChange:ue=>P({...x,slug:ue.target.value}),required:!0,disabled:!!S}),React.createElement("small",{className:"text-muted"},"VD: may-cay-kubota-l1501")),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:x.description,onChange:ue=>P({...x,description:ue.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex gap-2 align-items-start"},x.cover_url&&React.createElement("div",{className:"position-relative",style:{width:80,height:80}},React.createElement("img",{src:x.cover_url,alt:"Cover",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:8}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute",style:{top:-8,right:-8,padding:"2px 6px",fontSize:10},onClick:()=>P(ue=>({...ue,cover_url:""}))},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{ref:_e,type:"file",accept:"image/*",className:"d-none",onChange:Ue}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100 mb-2",onClick:()=>{var ue;return(ue=_e.current)==null?void 0:ue.click()},disabled:U},U?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh b\xECa")),React.createElement("input",{type:"url",className:"form-control form-control-sm",value:x.cover_url,onChange:ue=>P({...x,cover_url:ue.target.value}),placeholder:"Ho\u1EB7c d\xE1n URL \u1EA3nh..."}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:D},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:ce||U},ce?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function FolderTreeItem({folder:A,allAlbums:S,currentAlbumId:D,targetAlbum:ie,onSelect:G,level:x=0}){const[P,ce]=useState(!0),de=A.uuid||A.id,U=de===D,be=ie===de,_e=S.filter(re=>re.parentId===de),le=_e.length>0;return React.createElement("div",{style:{marginLeft:x*16+"px"}},React.createElement("div",{className:`d-flex align-items-center p-2 rounded mb-1 ${be?"bg-info text-white":U?"bg-light text-muted":"hover-bg"}`,style:{cursor:U?"not-allowed":"pointer",opacity:U?.5:1,transition:"background 0.2s"},onClick:()=>!U&&G(de)},le&&React.createElement("i",{className:`fas fa-chevron-${P?"down":"right"} me-2`,style:{fontSize:"10px",width:"12px",cursor:"pointer"},onClick:re=>{re.stopPropagation(),ce(!P)}}),!le&&React.createElement("span",{style:{width:"20px"}}),React.createElement("i",{className:`fas fa-folder${be?"-open":""} me-2 ${be?"":"text-warning"}`}),React.createElement("span",{className:"small"},A.title),U&&React.createElement("span",{className:"ms-2 badge bg-secondary",style:{fontSize:"9px"}},"Hi\u1EC7n t\u1EA1i"),A.count>0&&!U&&React.createElement("span",{className:"ms-auto badge bg-light text-muted",style:{fontSize:"10px"}},A.count)),P&&le&&React.createElement("div",null,_e.map(re=>React.createElement(FolderTreeItem,{key:re.uuid||re.id,folder:re,allAlbums:S,currentAlbumId:D,targetAlbum:ie,onSelect:G,level:x+1}))))}function AlbumDetail({album:A,onBack:S,onRefresh:D,showToast:ie,onNavigateToFolder:G,onEditSubfolder:x,parentAlbum:P}){const[ce,de]=useState([]),[U,be]=useState([]),[_e,le]=useState(!0),[re,xe]=useState(!1),[Ue,ue]=useState(""),[Se,Ce]=useState([]),[qe,Ke]=useState([]),[Ie,ke]=useState({}),[Ee,Oe]=useState(null),[ct,je]=useState(!1),[Xe,ze]=useState(""),[m,$]=useState(!1),i=useRef(null),b=useRef(null),[y,O]=useState(!1),[F,Y]=useState([]),[E,z]=useState([]),[Ne,Je]=useState(""),[u,v]=useState(!1),ge=async(h,se=2)=>{const oe=se*1024*1024,me=h.type==="image/heic"||h.type==="image/heif"||/\.heic$/i.test(h.name);if(h.size<=oe&&!me)return h;try{const w=await createImageBitmap(h),we=document.createElement("canvas");let Me=w.width,De=w.height;const Ve=1200;return(Me>Ve||De>Ve)&&(Me>De?(De=Math.round(De/Me*Ve),Me=Ve):(Me=Math.round(Me/De*Ve),De=Ve)),we.width=Me,we.height=De,we.getContext("2d").drawImage(w,0,0,Me,De),w.close(),new Promise((tt,at)=>{we.toBlob(bt=>{bt?tt(new File([bt],h.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):at(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(w){throw console.error("Compress error:",w),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh")}};useEffect(()=>{k(),K()},[A.id,A.uuid]);const k=async()=>{le(!0);try{const h=await window.KTM.api.getJSON(`${API_BASE}/api/albums/${A.uuid||A.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");de(h.images||[]);const se=await window.KTM.api.getJSON(`${API_BASE}/api/albums?parent_id=${A.uuid||A.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");be(Array.isArray(se)?se:[])}catch(h){console.error(h),ie("L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u","danger")}le(!1)},K=async()=>{try{const h=await window.KTM.api.getJSON(`${API_BASE}/api/albums`,"L\u1ED7i t\u1EA3i album");z(Array.isArray(h)?h:[])}catch(h){console.error("Error loading albums:",h)}},te=h=>{Y(se=>se.includes(h)?se.filter(oe=>oe!==h):[...se,h])},Re=async()=>{if(!Ne||F.length===0){ie("Vui l\xF2ng ch\u1ECDn folder \u0111\xEDch","warning");return}v(!0);let h=0;for(const se of F)try{await window.KTM.api.putJSON(`${API_BASE}/api/images/${se}`,{album_id:Ne},"L\u1ED7i di chuy\u1EC3n \u1EA3nh"),h++}catch(oe){console.error("Move error:",oe)}v(!1),O(!1),Y([]),Je(""),h>0?(ie("\u0110\xE3 di chuy\u1EC3n \u1EA3nh th\xE0nh c\xF4ng!","success"),k(),D()):ie("Di chuy\u1EC3n th\u1EA5t b\u1EA1i","danger")},[Ye,Be]=useState(!1),Le=async()=>{if(F.length===0||!confirm(`X\xF3a ${F.length} \u1EA3nh \u0111\xE3 ch\u1ECDn? H\xE0nh \u0111\u1ED9ng n\xE0y kh\xF4ng th\u1EC3 ho\xE0n t\xE1c!`))return;Be(!0);let h=0;for(const se of F)try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${se}`,"L\u1ED7i x\xF3a \u1EA3nh"),h++}catch(oe){console.error("Delete error:",oe)}Be(!1),Y([]),h>0?(ie(`\u0110\xE3 x\xF3a ${h} \u1EA3nh!`,"success"),k(),D()):ie("X\xF3a th\u1EA5t b\u1EA1i","danger")},ot=()=>{F.length===ce.length?Y([]):Y(ce.map(h=>h.id))},xt=async()=>{if(Xe.trim()){$(!0);try{const h=Xe.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");await window.KTM.api.postJSON(`${API_BASE}/api/albums`,{slug:h+"-"+Date.now(),title:Xe,parent_id:A.uuid||A.id},"L\u1ED7i t\u1EA1o folder"),ie("T\u1EA1o folder th\xE0nh c\xF4ng!","success"),ze(""),je(!1),k(),D()}catch(h){ie(h.message,"danger")}$(!1)}},Pt=async h=>{if(confirm(`X\xF3a folder "${h.title}"? T\u1EA5t c\u1EA3 n\u1ED9i dung b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${h.uuid||h.id}`,"L\u1ED7i x\xF3a folder"),ie("\u0110\xE3 x\xF3a folder","success"),k(),D()}catch(se){ie("L\u1ED7i x\xF3a folder","danger")}},yt=h=>{const se=Array.from(h).filter(oe=>oe.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(oe.name));Ce(oe=>[...oe,...se]),se.forEach(oe=>{const me=new FileReader;me.onload=w=>{Ke(we=>[...we,{file:oe,preview:w.target.result}])},me.readAsDataURL(oe)})},_=h=>{Ce(se=>se.filter((oe,me)=>me!==h)),Ke(se=>se.filter((oe,me)=>me!==h))},Qe=async h=>{var oe;const se=await window.KTM.cloudinary.uploadImage({file:h,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:`ktm-albums/${A.id}`});if(!se.secure_url)throw console.error("Cloudinary error:",se),new Error(((oe=se.error)==null?void 0:oe.message)||"Upload failed");return se},jt=async()=>{if(Se.length===0)return;xe(!0);let h=0;for(let se=0;se<Se.length;se++)try{ue(`\u0110ang x\u1EED l\xFD ${se+1}/${Se.length}...`);const oe=await ge(Se[se],2);ue(`\u0110ang upload ${se+1}/${Se.length}...`);const me=await Qe(oe);await window.KTM.api.postJSON(`${API_BASE}/api/albums/${A.id}`,{url:me.secure_url,caption:Ie[se]||Se[se].name.replace(/\.[^/.]+$/,""),sort_order:ce.length+se},"L\u1ED7i l\u01B0u \u1EA3nh"),h++}catch(oe){console.error("Upload error:",oe)}xe(!1),ue(""),Ce([]),Ke([]),ke({}),h>0?(ie(`\u0110\xE3 upload ${h} \u1EA3nh th\xE0nh c\xF4ng!`,"success"),k(),D()):ie("Upload th\u1EA5t b\u1EA1i","danger")},ve=async(h,se)=>{if(confirm("X\xF3a \u1EA3nh n\xE0y?"))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${h}`,"L\u1ED7i x\xF3a \u1EA3nh"),ie("\u0110\xE3 x\xF3a \u1EA3nh","success"),k(),D()}catch(oe){ie("L\u1ED7i x\xF3a \u1EA3nh","danger")}},et=h=>{var se;h.preventDefault(),(se=b.current)==null||se.classList.add("dragover")},dt=()=>{var h;(h=b.current)==null||h.classList.remove("dragover")},$t=h=>{var se;h.preventDefault(),(se=b.current)==null||se.classList.remove("dragover"),yt(h.dataTransfer.files)};return React.createElement("div",null,React.createElement("div",{className:"d-flex align-items-center justify-content-between mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:S},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("h4",{className:"m-0"},A.title),React.createElement("small",{className:"text-muted"},U.length>0&&React.createElement("span",null,U.length," folder \u2022 "),ce.length," \u1EA3nh"))),React.createElement("button",{className:"btn btn-outline-warning btn-sm",onClick:()=>je(!0)},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder con")),ct&&React.createElement("div",{className:"card mb-4 border-warning"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder-plus me-2 text-warning"}),"T\u1EA1o folder con"),React.createElement("div",{className:"d-flex gap-2"},React.createElement("input",{type:"text",className:"form-control",placeholder:"T\xEAn folder...",value:Xe,onChange:h=>ze(h.target.value),onKeyPress:h=>h.key==="Enter"&&xt(),autoFocus:!0}),React.createElement("button",{className:"btn btn-warning",onClick:xt,disabled:m||!Xe.trim()},m?React.createElement("span",{className:"spinner-border spinner-border-sm"}):"T\u1EA1o"),React.createElement("button",{className:"btn btn-secondary",onClick:()=>{je(!1),ze("")}},"H\u1EE7y")))),U.length>0&&React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),"Folder con"),React.createElement("div",{className:"row g-2"},U.map(h=>React.createElement("div",{key:h.uuid||h.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-item",style:{cursor:"pointer"},onClick:()=>G&&G(h)},React.createElement("div",{className:"card-body text-center py-3"},React.createElement("i",{className:"fas fa-folder fa-2x text-warning mb-2"}),React.createElement("div",{className:"small fw-bold text-truncate"},h.title),React.createElement("small",{className:"text-muted"},h.subfolderCount>0&&React.createElement("span",null,h.subfolderCount," folder"),h.subfolderCount>0&&h.count>0&&" \u2022 ",h.count>0&&React.createElement("span",null,h.count," \u1EA3nh"),h.subfolderCount===0&&h.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0 text-center"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-1",onClick:se=>{se.stopPropagation(),x&&x(h)},title:"S\u1EEDa folder"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:se=>{se.stopPropagation(),Pt(h)},title:"X\xF3a folder"},React.createElement("i",{className:"fas fa-trash"}))))))))),React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-cloud-upload-alt me-2"}),"Upload \u1EA3nh m\u1EDBi"),React.createElement("div",{ref:b,className:"upload-zone",onClick:()=>{var h;return(h=i.current)==null?void 0:h.click()},onDragOver:et,onDragLeave:dt,onDrop:$t},React.createElement("i",{className:"fas fa-images fa-2x text-muted mb-2"}),React.createElement("p",{className:"mb-0"},"K\xE9o th\u1EA3 \u1EA3nh v\xE0o \u0111\xE2y ho\u1EB7c click \u0111\u1EC3 ch\u1ECDn"),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3 JPG, PNG, WebP"),React.createElement("input",{ref:i,type:"file",multiple:!0,accept:"image/*",onChange:h=>yt(h.target.files)})),qe.length>0&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"upload-preview"},qe.map((h,se)=>React.createElement("div",{key:se,className:"upload-preview-item"},React.createElement("img",{src:h.preview,alt:""}),React.createElement("button",{className:"remove",onClick:()=>_(se)},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("div",{className:"mt-3"},React.createElement("button",{className:"btn btn-warning",onClick:jt,disabled:re},re?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),Ue||"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload ",Se.length," \u1EA3nh")))))),React.createElement("div",{className:"card"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("h6",{className:"m-0"},React.createElement("i",{className:"fas fa-th me-2"}),"\u1EA2nh (",ce.length,")"),ce.length>0&&React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:ot},F.length===ce.length?"B\u1ECF ch\u1ECDn":"Ch\u1ECDn t\u1EA5t c\u1EA3")),F.length>0&&React.createElement("div",{className:"d-flex align-items-center gap-2 flex-wrap"},React.createElement("span",{className:"badge bg-primary"},F.length," \u0111\xE3 ch\u1ECDn"),React.createElement("button",{className:"btn btn-sm btn-info",onClick:()=>O(!0)},React.createElement("i",{className:"fas fa-folder-open me-1"}),"Di chuy\u1EC3n"),React.createElement("button",{className:"btn btn-sm btn-danger",onClick:Le,disabled:Ye},Ye?React.createElement("span",{className:"spinner-border spinner-border-sm"}):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-trash me-1"}),"X\xF3a")),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>Y([])},React.createElement("i",{className:"fas fa-times"})))),_e?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):ce.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},React.createElement("i",{className:"fas fa-image fa-2x mb-2"}),React.createElement("p",null,"Ch\u01B0a c\xF3 \u1EA3nh n\xE0o trong album n\xE0y")):React.createElement("div",{className:"image-grid"},ce.map((h,se)=>React.createElement("div",{key:se,className:`image-item ${F.includes(h.id)?"selected":""}`,style:{position:"relative",cursor:"pointer"},onClick:()=>te(h.id)},React.createElement("div",{className:"select-checkbox",style:{position:"absolute",top:"6px",left:"6px",zIndex:10,width:"24px",height:"24px",borderRadius:"4px",background:F.includes(h.id)?"#0d6efd":"rgba(255,255,255,0.9)",border:F.includes(h.id)?"none":"2px solid #ccc",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"}},F.includes(h.id)&&React.createElement("i",{className:"fas fa-check",style:{color:"#fff",fontSize:"12px"}})),React.createElement("img",{src:h.src,alt:h.caption,style:{opacity:F.includes(h.id)?.7:1,border:F.includes(h.id)?"3px solid #0d6efd":"none",borderRadius:"8px"}}),React.createElement("div",{className:"actions"},React.createElement("button",{className:"btn btn-sm btn-danger",onClick:oe=>{oe.stopPropagation(),ve(h.id,se)},title:"X\xF3a \u1EA3nh"},React.createElement("i",{className:"fas fa-trash"}))),h.caption&&React.createElement("div",{className:"p-2 bg-light small text-truncate"},h.caption)))))),y&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header bg-info text-white"},React.createElement("h5",{className:"modal-title"},React.createElement("i",{className:"fas fa-folder-open me-2"}),"Di chuy\u1EC3n ",F.length," \u1EA3nh"),React.createElement("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>O(!1)})),React.createElement("div",{className:"modal-body",style:{maxHeight:"400px",overflowY:"auto"}},React.createElement("p",{className:"text-muted small mb-3"},"Ch\u1ECDn th\u01B0 m\u1EE5c \u0111\xEDch:"),React.createElement("div",{className:"folder-tree"},E.filter(h=>!h.parentId).map(h=>React.createElement(FolderTreeItem,{key:h.uuid||h.id,folder:h,allAlbums:E,currentAlbumId:A.uuid||A.id,targetAlbum:Ne,onSelect:Je})))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>O(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-info",onClick:Re,disabled:!Ne||u},u?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang chuy\u1EC3n..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-1"}),"Di chuy\u1EC3n \u0111\u1EBFn \u0111\xE2y")))))),Ee&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.9)"},onClick:()=>Oe(null)},React.createElement("div",{className:"modal-dialog modal-fullscreen d-flex align-items-center justify-content-center"},React.createElement("div",{className:"position-relative",style:{maxWidth:"95vw",maxHeight:"95vh"}},React.createElement("button",{className:"btn btn-light position-absolute",style:{top:"-50px",right:"0",borderRadius:"50%",width:"40px",height:"40px"},onClick:()=>Oe(null)},React.createElement("i",{className:"fas fa-times"})),React.createElement("img",{src:Ee.src,alt:Ee.caption,style:{maxWidth:"95vw",maxHeight:"90vh",objectFit:"contain"},onClick:h=>h.stopPropagation()}),Ee.caption&&React.createElement("div",{className:"text-white text-center mt-2"},Ee.caption)))))}function SearchCenter({showToast:A,onNavigate:S}){const[D,ie]=useState(""),[G,x]=useState([]),[P,ce]=useState([]),[de,U]=useState([]),[be,_e]=useState("all"),[le,re]=useState(null),[xe,Ue]=useState("list"),[ue,Se]=useState(!0),[Ce,qe]=useState([]),[Ke,Ie]=useState([]),ke=useRef(null),[Ee,Oe]=useState(!0),[ct,je]=useState(!1),Xe=useRef(null),[ze,m]=useState(!1),[$,i]=useState([{role:"assistant",content:`Xin ch\xE0o! H\xE3y h\u1ECFi t\xF4i v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3... V\xED d\u1EE5:
\u2022 "Gi\xE1 van 2 tay?"
\u2022 "Combo r\u1EBB nh\u1EA5t?"
\u2022 "Freeship?"`,attachments:[]}]),[b,y]=useState(""),[O,F]=useState(!1),Y=useRef(null),E=useRef(null),[z,Ne]=useState(null),[Je,u]=useState(!1),[v,ge]=useState(null),[k,K]=useState(!1),[te,Re]=useState(!1),[Ye,Be]=useState(null),[Le,ot]=useState({name:"",code:"",price:"",image:"",category:"",note:"",commission_percent:""}),xt=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"],Pt=n=>{var f,T;n._type==="product"&&(ge(n),ot({name:n.name||"",code:n.code||"",price:n.price||"",image:n.image||"",category:n.category||"",note:n.note||"",commission_percent:(T=(f=n.commission_percent)!=null?f:n.commissionPercent)!=null?T:""}),u(!0))},yt=async()=>{if(v)try{await window.KTM.api.putJSON(`${API_BASE}/api/products?id=${v.id}`,Le,"L\u1ED7i c\u1EADp nh\u1EADt"),A("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),u(!1),ge(null),et()}catch(n){A(n.message,"danger")}},_=async n=>{const f=n._type==="product"?"s\u1EA3n ph\u1EA9m":n._type==="album"?"\u1EA3nh":"video";if(confirm(`X\xF3a ${f} "${n.name}"?`))try{let T="";n._type==="product"?T=`${API_BASE}/api/products?id=${n.id}`:n._type==="album"?T=`${API_BASE}/api/images/${n.id}`:n._type==="video"&&(T=`${API_BASE}/api/videos/${n.id}`),await window.KTM.api.deleteJSON(T,"L\u1ED7i x\xF3a"),A(`\u0110\xE3 x\xF3a ${f}`,"success"),et()}catch(T){A(T.message,"danger")}},Qe=async n=>{try{const f=Ye?`${API_BASE}/api/products?id=${Ye.id}`:`${API_BASE}/api/products`;Ye?await window.KTM.api.putJSON(f,n,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(f,n,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),A(Ye?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Re(!1),Be(null),et()}catch(f){A(f.message,"danger")}},jt="ktm_admin_data_cache_v1",ve=1e3*60*10,et=async()=>{let n=null,f=!1;const T=window.KTM.cache.read(jt,{ttlMs:ve,validate:Array.isArray});T.hit?(n=T.value,console.log("[CACHE] Using cache, items:",n.length),ce(n),x(n),Se(!1),f=!0):T.status==="miss"?console.log("[CACHE] No cache found"):T.status==="expired"||T.status==="invalid"?console.log("[CACHE] Cache expired or invalid"):T.status==="error"&&console.error("[CACHE] Error parsing cache"),f||Se(!0);try{const q=async(X,he)=>{try{const st=await window.KTM.api.getJSON(X,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");return st!=null?st:he}catch(st){return he}},[Z,j,p]=await Promise.all([q(`${API_BASE}/api/products`,[]),q(`${API_BASE}/api/albums`,[]),q(`${API_BASE}/api/video-folders?withVideos=true`,[])]),B=Array.isArray(Z)?Z.map(X=>({...X,_type:"product",_source:"database"})):[];qe(j);let ae=[];Array.isArray(j)&&j.length>0&&(await Promise.all(j.map(he=>q(`${API_BASE}/api/albums/${he.id}`,{})))).forEach((he,st)=>{const vt=j[st];he.images&&he.images.length>0&&he.images.forEach(it=>{ae.push({id:it.id,name:it.caption||"\u1EA2nh t\u1EEB "+vt.title,image:it.src,folder:vt.title,_type:"album",_source:"database"})})}),Ie(p);let ne=[];Array.isArray(p)&&p.forEach(X=>{X.videos&&X.videos.forEach(he=>{ne.push({id:he.id,name:he.title,folder:X.name,image:he.thumb,youtubeId:he.youtubeId,url:he.url,_type:"video",_source:"database"})})});const W=[...B,...ae,...ne];(!n||JSON.stringify(W)!==JSON.stringify(n))&&(ce(W),x(W),window.KTM.cache.write(jt,W))}catch(q){console.error("Song song fetch error:",q)}Se(!1)};useEffect(()=>{et(),setTimeout(()=>{var n;return(n=ke.current)==null?void 0:n.focus()},100)},[]);const dt=n=>{try{return String(n!=null?n:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(f){return String(n!=null?n:"").toLowerCase()}},$t=n=>{const T=dt(n).trim().split(/\s+/).filter(Boolean),q=T.includes("anh"),Z=T.includes("video"),j=T.filter(ae=>ae!=="anh"&&ae!=="video"),p=j.join(" "),B=new Set(["product"]);return q&&B.add("album"),Z&&B.add("video"),{allowedTypes:B,includeAlbum:q,includeVideo:Z,contentTokens:j,cleanedQuery:p}},h=(n,f,T)=>{var X,he,st,vt,it;const q=Array.isArray(f)?f:[],Z=dt(T).trim();if(!q.length&&!Z)return 0;const j=dt((X=n==null?void 0:n.name)!=null?X:""),p=dt((he=n==null?void 0:n.code)!=null?he:""),B=dt((st=n==null?void 0:n.category)!=null?st:""),ae=dt((vt=n==null?void 0:n.note)!=null?vt:""),ne=dt((it=n==null?void 0:n.folder)!=null?it:"");if(!`${j} ${p} ${B} ${ae} ${ne}`.trim())return 0;let pe=0;Z&&(j===Z&&(pe+=220),j.includes(Z)&&(pe+=140),j.startsWith(Z)&&(pe+=160),p&&p===Z&&(pe+=180),p&&p.includes(Z)&&(pe+=90));for(const pt of q){if(!pt)continue;const Fe=new RegExp(`(?:^|\\s)${pt.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}`);j.includes(pt)&&(pe+=35),Fe.test(j)&&(pe+=25),p&&p.includes(pt)&&(pe+=20),p&&Fe.test(p)&&(pe+=10),B&&B.includes(pt)&&(pe+=12),ne&&ne.includes(pt)&&(pe+=12),ae&&ae.includes(pt)&&(pe+=6)}return pe>0&&j&&(pe+=Math.max(0,10-Math.min(10,Math.floor(j.length/10)))),pe},se=(n,f,T)=>{const q=Array.isArray(n)?n:[];return q.length?q.map((j,p)=>({it:j,idx:p,score:h(j,f,T)})).sort((j,p)=>p.score!==j.score?p.score-j.score:j.idx-p.idx).map(j=>j.it):[]},oe=async(n,f)=>{if(!(!Ee||f.length===0)){je(!0);try{const T=f.map(Z=>({id:Z.id,name:Z.name,price:Z.price,category:Z.category,note:Z.note,folder:Z.folder,_type:Z._type})),q=await window.KTM.api.postJSON(`${API_BASE}/api/ai-search`,{query:n,products:T},"AI Search error");if(q&&q.matchedIds&&q.matchedIds.length>0){const{contentTokens:Z,cleanedQuery:j}=$t(n),p=new Set(q.matchedIds),B=f.filter(ae=>p.has(ae.id)).sort((ae,ne)=>h(ne,Z,j)-h(ae,Z,j));B.length>0&&x(B)}else q&&q.matchedIds&&q.matchedIds.length===0&&x([])}catch(T){console.error("AI Search error:",T)}je(!1)}},me=n=>{if(ie(n),Xe.current&&clearTimeout(Xe.current),!n.trim()){w(be);return}const{allowedTypes:f,contentTokens:T,cleanedQuery:q}=$t(n),Z=P.filter(p=>{if(!f.has(p==null?void 0:p._type))return!1;if(T.length===0)return!0;const B=dt(Object.entries(p).filter(([ae])=>!ae.startsWith("_")).map(([,ae])=>String(ae||"")).join(" "));return T.some(ae=>B.includes(ae))});let j=Z;be!=="all"&&(j=Z.filter(p=>(p.category||p._type)===be)),x(se(j,T,q)),Ee&&q.length>=3&&(Xe.current=setTimeout(()=>{oe(q,j)},500))},w=n=>{_e(n);const{allowedTypes:f,contentTokens:T}=$t(D),{cleanedQuery:q}=$t(D);let Z=P.filter(j=>f.has(j==null?void 0:j._type));n!=="all"&&(Z=Z.filter(j=>(j.category||j._type)===n)),D.trim()&&T.length>0&&(Z=Z.filter(j=>{const p=dt(Object.entries(j).filter(([B])=>!B.startsWith("_")).map(([,B])=>String(B||"")).join(" "));return T.every(B=>p.includes(B))})),x(se(Z,T,q))},we=(n,f)=>{window.KTM.clipboard.writeText(n).then(()=>{re(f),A("\u0110\xE3 copy!","success"),setTimeout(()=>re(null),1500)})},Me=async(n,f)=>{try{await window.KTM.clipboard.writeImageFromUrl(n),re(f+"-img"),A("\u0110\xE3 copy \u1EA3nh!","success"),setTimeout(()=>re(null),1500)}catch(T){we(n,f+"-img")}},De=n=>{let f=n.toLowerCase();const T=[],q=P.filter(p=>p._type==="product");if(f.includes("ty")||f.includes("xy lanh")){if(f.includes("gi\u1EEFa")||f.includes("giua")){const p=q.find(B=>{var ae;return(ae=B.name)==null?void 0:ae.toLowerCase().includes("xy lanh gi\u1EEFa")});p&&!T.find(B=>B.id===p.id)&&T.push(p)}if(f.includes("nghi\xEAng")||f.includes("nghieng")){const p=q.find(B=>{var ae;return(ae=B.name)==null?void 0:ae.toLowerCase().includes("xy lanh nghi\xEAng")});p&&!T.find(B=>B.id===p.id)&&T.push(p)}if(f.includes("\u1EE7i")||f.includes("ui")){const p=q.find(B=>{var ae;return(ae=B.name)==null?void 0:ae.toLowerCase().includes("xy lanh \u1EE7i")});p&&!T.find(B=>B.id===p.id)&&T.push(p)}}const Z=f.match(/van\s*(\d+)\s*tay.*?(\d+)\s*ty/);if(Z){const p=Z[1],B=Z[2],ae=q.find(ne=>{var pe;const W=((pe=ne.name)==null?void 0:pe.toLowerCase())||"";return W.includes("combo")&&W.includes(`${p} tay`)&&(W.includes(`${B} xy`)||W.includes(`${B} xylanh`))});if(ae&&!T.find(ne=>ne.id===ae.id))T.push(ae);else{const ne=q.find(W=>{var X;const pe=((X=W.name)==null?void 0:X.toLowerCase())||"";return pe.includes("combo")&&pe.includes(`${p} tay`)});ne&&!T.find(W=>W.id===ne.id)&&T.push(ne)}}if(f.includes("combo")&&!Z){const p=f.match(/combo.*?(\d+)\s*tay/);if(p){const B=p[1];q.filter(ne=>{var pe;const W=((pe=ne.name)==null?void 0:pe.toLowerCase())||"";return W.includes("combo")&&W.includes(`${B} tay`)}).forEach(ne=>{T.find(W=>W.id===ne.id)||T.push(ne)})}}const j=f.match(/van\s*(\d+)\s*tay/);if(j&&!f.includes("ty")&&!f.includes("combo")){const p=j[1],B=q.find(ae=>{var W;const ne=((W=ae.name)==null?void 0:W.toLowerCase())||"";return ne.includes(`van ${p} tay`)&&!ne.includes("combo")});B&&!T.find(ae=>ae.id===B.id)&&T.push(B)}return T.slice(0,4)},Ve=async n=>{if(!n.trim())return;const f={role:"user",content:n,attachments:[]};i(q=>[...q,f]),y(""),F(!0);const T=De(n);setTimeout(()=>{var q;return(q=Y.current)==null?void 0:q.scrollIntoView({behavior:"smooth"})},100);try{const Z=P.filter(W=>W._type==="product").map(W=>{let pe=`- ${W.name}`;return W.code&&(pe+=` (M\xE3: ${W.code})`),W.price&&(pe+=` - Gi\xE1: ${W.price.replace(/[đ\s]/g,"")}\u0111`),W.category&&(pe+=` [${W.category}]`),W.note&&(pe+=` (${W.note})`),pe}).join(`
`),p=$.slice(-6).map(W=>`${W.role==="user"?"Kh\xE1ch":"AI"}: ${W.content}`).join(`
`),B=p?`L\u1ECACH S\u1EEC H\u1ED8I THO\u1EA0I:
${p}

DANH S\xC1CH S\u1EA2N PH\u1EA8M:
${Z}`:Z,ne=(await window.KTM.api.postJSON(`${API_BASE}/api/ai-chat`,{message:n,context:B,audience:"admin"},"API error")).response||"Xin l\u1ED7i, t\xF4i kh\xF4ng th\u1EC3 tr\u1EA3 l\u1EDDi l\xFAc n\xE0y.";i(W=>[...W,{role:"assistant",content:ne,attachments:T}])}catch(q){console.error("AI Error:",q);const Z=n.toLowerCase(),j=P.filter(B=>{const ae=Object.values(B).join(" ").toLowerCase();return Z.split(" ").some(ne=>ae.includes(ne))});let p="";j.length>0?(p=`T\xECm th\u1EA5y ${j.length} s\u1EA3n ph\u1EA9m li\xEAn quan:

`,j.slice(0,5).forEach(B=>{p+=`\u2022 ${B.name}`,B.price&&(p+=` - ${B.price.replace(/[đ\s]/g,"")}\u0111`),B.note&&(p+=` (${B.note})`),p+=`
`}),j.length>5&&(p+=`
...v\xE0 ${j.length-5} s\u1EA3n ph\u1EA9m kh\xE1c`)):p='Kh\xF4ng t\xECm th\u1EA5y s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p. H\xE3y th\u1EED t\u1EEB kh\xF3a kh\xE1c nh\u01B0 "van", "combo", "xy lanh"...',i(B=>[...B,{role:"assistant",content:p,attachments:j.slice(0,4)}])}F(!1),setTimeout(()=>{var q,Z;(q=Y.current)==null||q.scrollIntoView({behavior:"smooth"}),(Z=E.current)==null||Z.focus()},100)};function Ge({show:n,product:f,categories:T,onClose:q,onSave:Z}){const[j,p]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[B,ae]=useState(!1),[ne,W]=useState(!1),pe=useRef(null),X=M=>window.KTM.money.formatVNDInputDigits(M),he=M=>{const L=window.KTM.money.getDigits(String(M!=null?M:"")),H=Number(L);return L&&Number.isFinite(H)?Math.trunc(H):0},st=(M,L)=>{if(M==null||M==="")return[];let H=M;if(typeof H=="string"){const J=H.trim();if(!J)return[];try{H=JSON.parse(J)}catch(Q){return[]}}if(!Array.isArray(H))return[];const I=he(L);return H.map(J=>{var ye;if(!J||typeof J!="object")return null;const Q=String((ye=J.name)!=null?ye:"").trim(),fe=(Array.isArray(J.options)?J.options:[]).map(He=>{var Ct,At,It,_t,Ht,qt,Yt;if(!He||typeof He!="object")return null;const nt=String((Ct=He.label)!=null?Ct:"").trim();if(!nt)return null;const rt=(Ht=(_t=(It=(At=He.price)!=null?At:He.priceValue)!=null?It:He.unit_price)!=null?_t:He.unitPrice)!=null?Ht:null,Ze=Number(rt);let Ae=Number.isFinite(Ze)?Math.trunc(Ze):null;if(Ae==null){const ma=(Yt=(qt=He.price_delta)!=null?qt:He.priceDelta)!=null?Yt:null,Jt=Number(ma);Number.isFinite(Jt)&&(Ae=I+Math.trunc(Jt))}Ae==null&&(Ae=I);const kt=String(Math.max(0,Math.trunc(Number(Ae)||0)));return{label:nt,price:Math.max(0,Math.trunc(Number(Ae)||0)),priceDigits:kt}}).filter(Boolean);return{name:Q||"Bi\u1EBFn th\u1EC3",options:fe}}).filter(Boolean)},vt=M=>{if(M==null||M==="")return[];let L=M;if(typeof L=="string"){const H=L.trim();if(!H)return[];try{L=JSON.parse(H)}catch(I){return[]}}return L&&typeof L=="object"&&!Array.isArray(L)&&(L=Object.entries(L).map(([H,I])=>({key:H,value:I}))),Array.isArray(L)?L.map(H=>{var fe,ye,He,nt,rt;if(!H||typeof H!="object")return null;const I=String((He=(ye=(fe=H.key)!=null?fe:H.name)!=null?ye:H.label)!=null?He:"").trim(),J=String((nt=H.value)!=null?nt:"").trim(),Q=String((rt=H.unit)!=null?rt:"").trim();return I?{key:I,value:J,unit:Q}:null}).filter(Boolean):[]};useEffect(()=>{var M,L;if(f)if(p({name:f.name||"",code:f.code||"",price:f.price||"",image:f.image||"",category:f.category||"",note:f.note||"",sort_order:f.sort_order||0,commission_percent:(L=(M=f.commission_percent)!=null?M:f.commissionPercent)!=null?L:5,variants:st(f.variants,f.price),attributes:vt(f.attributes)}),f.price){const H=window.KTM.money.getDigits(f.price);St(H),p(I=>({...I,price:X(H)}))}else St("");else p({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),St("")},[f,n]);const it=M=>{p(L=>{var fe;const H=he(L.price),I=String(H),J=Array.isArray(L.variants)?[...L.variants]:[],Q={...J[M]||{},options:Array.isArray((fe=J[M])==null?void 0:fe.options)?[...J[M].options]:[]};return Q.options=Q.options.map(ye=>({label:String((ye==null?void 0:ye.label)||""),price:H,priceDigits:I})),J[M]=Q,{...L,variants:J}})},pt=()=>{p(M=>{const L=he(M.price),H=String(L),J=(Array.isArray(M.variants)?[...M.variants]:[]).map(Q=>{const fe=(Array.isArray(Q==null?void 0:Q.options)?Q.options:[]).map(ye=>({label:String((ye==null?void 0:ye.label)||""),price:L,priceDigits:H}));return{name:String((Q==null?void 0:Q.name)||"Bi\u1EBFn th\u1EC3"),options:fe}});return{...M,variants:J}})},[Fe,Tt]=React.useState(""),[Bt,St]=React.useState(""),Kt=M=>{const L=window.KTM.money.nextPriceInputState(M.target.value,Bt);St(L.digits),p({...j,price:L.price})},Ot=async(M,L=2)=>{const H=L*1024*1024;if(M.size<=H)return M;try{const I=await createImageBitmap(M),J=document.createElement("canvas");let Q=I.width,fe=I.height;const ye=1200;return(Q>ye||fe>ye)&&(Q>fe?(fe=Math.round(fe/Q*ye),Q=ye):(Q=Math.round(Q/fe*ye),fe=ye)),J.width=Q,J.height=fe,J.getContext("2d").drawImage(I,0,0,Q,fe),I.close(),new Promise((nt,rt)=>{J.toBlob(Ze=>{Ze?nt(new File([Ze],M.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):rt(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(I){throw console.error("Compress error:",I),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},Et=async M=>{var I;const L=M.target.files[0];if(!L)return;if(!(L.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp)$/i.test(L.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}W(!0);try{const J=await Ot(L),Q=await window.KTM.cloudinary.uploadImage({file:J,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-products"});if(!Q.secure_url)throw console.error("Cloudinary error:",Q),new Error(((I=Q.error)==null?void 0:I.message)||"Upload failed");p(fe=>({...fe,image:Q.secure_url}))}catch(J){console.error("Upload error:",J),alert("L\u1ED7i upload \u1EA3nh: "+J.message)}W(!1),M.target.value=""},zt=async M=>{M.preventDefault(),ae(!0);const L={...j,variants:st(j.variants,j.price),attributes:vt(j.attributes)};await Z(L),ae(!1)};return n?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-lg"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,border:"none",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark"},React.createElement("i",{className:"fas fa-box me-2"}),f?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:q})),React.createElement("form",{onSubmit:zt},React.createElement("div",{className:"modal-body",style:{maxHeight:"70vh",overflowY:"auto"}},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-8"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-tag me-1"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:j.name,onChange:M=>p({...j,name:M.target.value}),placeholder:"V\xED d\u1EE5: Xy lanh nghi\xEAng KTM",required:!0,style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-hashtag me-1"}),"M\xE3 s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:j.code,onChange:M=>p({...j,code:M.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1"}),"Gi\xE1 b\xE1n"),React.createElement("input",{type:"text",className:"form-control",value:j.price,onChange:Kt,placeholder:"1.950.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3 mt-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-percent me-1"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:j.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:M=>p({...j,commission_percent:M.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-list me-1"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:j.category,onChange:M=>p({...j,category:M.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),T.map(M=>React.createElement("option",{key:M,value:M},M)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1"}),"Ghi ch\xFA"),React.createElement("textarea",{className:"form-control",rows:"2",value:j.note,onChange:M=>p({...j,note:M.target.value}),placeholder:"V\xED d\u1EE5: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(j.attributes)?j.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(j.attributes)?j.attributes:[]).map((M,L)=>React.createElement("div",{key:L,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(M==null?void 0:M.key)||"",onChange:H=>{const I=H.target.value;p(J=>{const Q=Array.isArray(J.attributes)?[...J.attributes]:[];return Q[L]={...Q[L]||{},key:I},{...J,attributes:Q}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(M==null?void 0:M.value)||"",onChange:H=>{const I=H.target.value;p(J=>{const Q=Array.isArray(J.attributes)?[...J.attributes]:[];return Q[L]={...Q[L]||{},value:I},{...J,attributes:Q}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(M==null?void 0:M.unit)||"",onChange:H=>{const I=H.target.value;p(J=>{const Q=Array.isArray(J.attributes)?[...J.attributes]:[];return Q[L]={...Q[L]||{},unit:I},{...J,attributes:Q}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{p(H=>{const I=Array.isArray(H.attributes)?[...H.attributes]:[];return I.splice(L,1),{...H,attributes:I}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{p(M=>{const L=Array.isArray(M.attributes)?[...M.attributes]:[];return L.push({key:"",value:"",unit:""}),{...M,attributes:L}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(j.variants)?j.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3. C\xF3 th\u1EC3 th\xEAm (v\xED d\u1EE5 Size: S/M/L)."):null,(Array.isArray(j.variants)?j.variants:[]).map((M,L)=>React.createElement("div",{key:L,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(M==null?void 0:M.name)||"",onChange:H=>{const I=H.target.value;p(J=>{var fe;const Q=Array.isArray(J.variants)?[...J.variants]:[];return Q[L]={...Q[L]||{},name:I,options:Array.isArray((fe=Q[L])==null?void 0:fe.options)?Q[L].options:[]},{...J,variants:Q}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>it(L),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(M==null?void 0:M.options)||M.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{p(H=>{const I=Array.isArray(H.variants)?[...H.variants]:[];return I.splice(L,1),{...H,variants:I}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(M==null?void 0:M.options)?M.options:[]).map((H,I)=>{var J,Q;return React.createElement("div",{key:I,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(H==null?void 0:H.label)||"",onChange:fe=>{const ye=fe.target.value;p(He=>{var kt,Ct,At,It,_t;const nt=Array.isArray(He.variants)?[...He.variants]:[],rt={...nt[L]||{},options:Array.isArray((kt=nt[L])==null?void 0:kt.options)?[...nt[L].options]:[]},Ze=Number((At=(Ct=rt.options[I])==null?void 0:Ct.price)!=null?At:0)||0,Ae=String((_t=(It=rt.options[I])==null?void 0:It.priceDigits)!=null?_t:Math.max(0,Math.trunc(Ze)));return rt.options[I]={...rt.options[I]||{},label:ye,price:Math.max(0,Math.trunc(Ze)),priceDigits:Ae},nt[L]=rt,{...He,variants:nt}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:X(String((Q=H==null?void 0:H.priceDigits)!=null?Q:window.KTM.money.getDigits(String((J=H==null?void 0:H.price)!=null?J:"")))),onChange:fe=>{p(ye=>{var At,It,_t,Ht,qt;const He=String((It=H==null?void 0:H.priceDigits)!=null?It:window.KTM.money.getDigits(String((At=H==null?void 0:H.price)!=null?At:""))),nt=window.KTM.money.nextPriceInputState(fe.target.value,He),rt=String((_t=nt.digits)!=null?_t:""),Ze=Number(rt),Ae=Number.isFinite(Ze)?Math.max(0,Math.trunc(Ze)):0,kt=Array.isArray(ye.variants)?[...ye.variants]:[],Ct={...kt[L]||{},options:Array.isArray((Ht=kt[L])==null?void 0:Ht.options)?[...kt[L].options]:[]};return Ct.options[I]={...Ct.options[I]||{},label:String(((qt=Ct.options[I])==null?void 0:qt.label)||""),price:Ae,priceDigits:rt},kt[L]=Ct,{...ye,variants:kt}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{p(fe=>{var nt;const ye=Array.isArray(fe.variants)?[...fe.variants]:[],He={...ye[L]||{},options:Array.isArray((nt=ye[L])==null?void 0:nt.options)?[...ye[L].options]:[]};return He.options.splice(I,1),ye[L]=He,{...fe,variants:ye}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{p(H=>{var fe;const I=Array.isArray(H.variants)?[...H.variants]:[],J={...I[L]||{},options:Array.isArray((fe=I[L])==null?void 0:fe.options)?[...I[L].options]:[]},Q=he(H.price);return J.options.push({label:"",price:Q,priceDigits:String(Q)}),I[L]=J,{...H,variants:I}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{p(M=>{const L=he(M.price),H=Array.isArray(M.variants)?[...M.variants]:[],I=String(L);return H.push({name:"Size",options:[{label:"S",price:L,priceDigits:I},{label:"M",price:L,priceDigits:I},{label:"L",price:L,priceDigits:I}]}),{...M,variants:H}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:pt,disabled:!Array.isArray(j.variants)||j.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111.")))),React.createElement("div",{className:"col-md-4"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-image me-1"}),"\u1EA2nh s\u1EA3n ph\u1EA9m"),React.createElement("div",{className:"mb-2"},j.image?React.createElement(React.Fragment,null,React.createElement("img",{src:j.image,alt:"Product",style:{width:"100%",height:150,objectFit:"cover",borderRadius:"12px",border:"2px solid #e9ecef"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger mt-2",onClick:()=>p({...j,image:""}),style:{borderRadius:"20px",fontSize:"0.75rem"}},React.createElement("i",{className:"fas fa-times me-1"}),"X\xF3a \u1EA3nh")):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:"100%",height:150,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd",cursor:"pointer"},onClick:()=>{var M;return(M=pe.current)==null?void 0:M.click()}},React.createElement("div",{className:"text-center"},React.createElement("i",{className:"fas fa-cloud-upload-alt fa-2x text-muted mb-2"}),React.createElement("div",{className:"small text-muted"},"Click \u0111\u1EC3 upload")))),React.createElement("input",{ref:pe,type:"file",accept:"image/*",className:"d-none",onChange:Et}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100",onClick:()=>{var M;return(M=pe.current)==null?void 0:M.click()},disabled:ne,style:{borderRadius:"10px"}},ne?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh")),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"Ho\u1EB7c URL \u1EA3nh"),React.createElement("input",{type:"url",className:"form-control",value:j.image,onChange:M=>p({...j,image:M.target.value}),placeholder:"https://...",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"8px",fontSize:"0.875rem"}}))))),React.createElement("div",{className:"modal-footer",style:{border:"none",padding:"20px"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:q,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:B,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},B?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}const tt=n=>window.KTM.money.formatVND(n),at=n=>{if(n==null||n==="")return[];let f=n;if(typeof f=="string"){const T=f.trim();if(!T)return[];try{f=JSON.parse(T)}catch(q){return[]}}return Array.isArray(f)?f:[]},bt=n=>{if(n==null||n==="")return[];let f=n;if(typeof f=="string"){const T=f.trim();if(!T)return[];try{f=JSON.parse(T)}catch(q){return[]}}return f&&typeof f=="object"&&!Array.isArray(f)&&(f=Object.entries(f).map(([T,q])=>({key:T,value:q}))),Array.isArray(f)?f:[]},gt=(n,f={})=>{var j;const T=bt(n).map(p=>{var B,ae,ne,W,pe;return{key:String((ne=(ae=(B=p==null?void 0:p.key)!=null?B:p==null?void 0:p.name)!=null?ae:p==null?void 0:p.label)!=null?ne:"").trim(),value:String((W=p==null?void 0:p.value)!=null?W:"").trim(),unit:String((pe=p==null?void 0:p.unit)!=null?pe:"").trim()}}).filter(p=>!!p.key);if(!T.length)return null;const q=!!f.compact,Z=String((j=f.className)!=null?j:"").trim();return React.createElement("div",{className:`ktm-variants-preview${q?" compact":""}${Z?" "+Z:""}`},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},T.map((p,B)=>{const ae=p.key,ne=`${p.value||""}${p.unit?(p.value?" ":"")+p.unit:""}`.trim();return React.createElement("div",{key:`${ae}-${B}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},ae),ne?React.createElement("span",{className:"ktm-chip ktm-chip-option"},ne):null)})))},Nt=(n,f={})=>{var ae;const T=at(n).map(ne=>{var W;return{name:String((W=ne==null?void 0:ne.name)!=null?W:"").trim(),options:Array.isArray(ne==null?void 0:ne.options)?ne.options:[]}}).map(ne=>({...ne,options:ne.options.map(W=>{var pe;return{label:String((pe=W==null?void 0:W.label)!=null?pe:"").trim(),price:Number(W==null?void 0:W.price)}}).filter(W=>!!W.label)})).filter(ne=>ne.options.length>0);if(!T.length)return null;const q=Number.isFinite(f.maxGroups)?Math.max(1,Math.trunc(f.maxGroups)):T.length,Z=Number.isFinite(f.maxOptionsPerGroup)?Math.max(1,Math.trunc(f.maxOptionsPerGroup)):3,j=!!f.compact,p=String((ae=f.className)!=null?ae:"").trim(),B=T.slice(0,q);return React.createElement("div",{className:`ktm-variants-preview${j?" compact":""}${p?" "+p:""}`},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},B.map((ne,W)=>{const pe=ne.name||"Bi\u1EBFn th\u1EC3",X=ne.options.slice(0,Z),he=ne.options.length-X.length;return React.createElement("div",{key:`${pe}-${W}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},pe),X.map((st,vt)=>{const it=st.price,pt=Number.isFinite(it)&&it>=0?tt(Math.trunc(it)):"",Fe=pt?`${st.label} \xB7 ${pt}`:st.label;return React.createElement("span",{key:`${pe}-${W}-${vt}`,className:"ktm-chip ktm-chip-option"},Fe)}),he>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",he))})))},wt=(n,f)=>{const T=n._type==="product",q=n._type==="album",Z=n._type==="video",j=n.note&&(n.note.toLowerCase().includes("free")||n.note.toLowerCase().includes("gi\u1EA3m")||n.note.toLowerCase().includes("sale")),p=T?gt(n.attributes,{compact:xe==="grid",className:xe==="grid"?"meta text-muted":"text-muted"}):null,B=T?Nt(n.variants,{compact:xe==="grid",maxOptionsPerGroup:999,className:xe==="grid"?"meta text-muted":"text-muted"}):null;return xe==="grid"?React.createElement("div",{key:n.id||f,className:"grid-card"},React.createElement("div",{className:"thumb-wrap",onClick:()=>Ne({url:n.image,name:n.name,price:n.price,note:n.note,item:n})},n.image?React.createElement("img",{src:n.image,alt:n.name,className:"thumb",loading:"lazy"}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${Z?"fa-video":"fa-image"} fa-2x text-muted`})),n.price&&React.createElement("div",{className:"price-overlay"},n.price.replace(/[đ\s]/g,""),"\u0111"),React.createElement("span",{className:`type-badge ${T?"product":q?"album":"video"}`},T?"SP":q?"\u1EA2nh":"Video"),j&&React.createElement("span",{className:"promo-badge"},"\u{1F525} \u01AFU \u0110\xC3I")),React.createElement("div",{className:"card-body"},React.createElement("div",{className:"name"},n.name),n.note&&React.createElement("div",{className:"meta text-info",style:{fontSize:10}},n.note),p&&React.createElement("div",{style:{marginTop:2}},p),B&&React.createElement("div",{style:{marginTop:2}},B),React.createElement("div",{className:"quick-copy"},React.createElement("button",{className:le===n.id+"-img"?"copied":"",onClick:()=>Me(n.image,n.id)},React.createElement("i",{className:"fas fa-image"})),n.price&&React.createElement("button",{className:le===n.id+"-price"?"copied":"",onClick:()=>we(n.price.replace(/[đ\s]/g,""),n.id+"-price")},React.createElement("i",{className:"fas fa-tag"}))))):React.createElement("div",{key:n.id||f,className:"product-card-mobile"},React.createElement("span",{className:`type-badge ${T?"product":q?"album":"video"}`},T?"S\u1EA3n ph\u1EA9m":q?"\u1EA2nh":"Video"),React.createElement("div",{className:"card-inner"},n.image?React.createElement("img",{src:n.image,alt:n.name,className:"thumb",loading:"lazy",onClick:()=>Ne({url:n.image,name:n.name,price:n.price,note:n.note,item:n})}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${Z?"fa-video":"fa-image"} fa-2x text-muted`})),React.createElement("div",{className:"info"},React.createElement("div",null,React.createElement("div",{className:"name"},n.name),React.createElement("div",{className:"price-row"},n.price&&React.createElement("span",{className:"price"},n.price.replace(/[đ\s]/g,""),"\u0111"),j&&React.createElement("span",{className:"badge-promo"},"\u{1F525} \u01AFU \u0110\xC3I")),p&&React.createElement("div",{style:{marginTop:4}},p),B&&React.createElement("div",{style:{marginTop:4}},B)),React.createElement("div",{className:"meta"},n.code&&React.createElement("span",{className:"meta-tag"},"#",n.code),n.category&&React.createElement("span",{className:"meta-tag"},n.category),n.note&&React.createElement("span",{className:"meta-tag highlight"},n.note),n.folder&&React.createElement("span",{className:"meta-tag"},n.folder),Z&&React.createElement("span",{className:"meta-tag"},React.createElement("i",{className:"fab fa-youtube text-danger"})," Video")))),React.createElement("div",{className:"quick-actions"},T&&React.createElement("button",{onClick:()=>S&&S("orders","create",{productId:n.id})},React.createElement("i",{className:"fas fa-receipt"})," T\u1EA1o \u0111\u01A1n"),n.price&&React.createElement("button",{className:le===n.id+"-price"?"copied":"",onClick:()=>we(n.price.replace(/[đ\s]/g,""),n.id+"-price")},React.createElement("i",{className:"fas fa-tag"})," Gi\xE1"),React.createElement("button",{className:le===n.id+"-name"?"copied":"",onClick:()=>we(n.name,n.id+"-name")},React.createElement("i",{className:"fas fa-font"})," T\xEAn"),Z&&n.youtubeId&&React.createElement("button",{className:le===n.id+"-yt"?"copied":"",onClick:()=>we(`https://www.youtube.com/watch?v=${n.youtubeId}`,n.id+"-yt")},React.createElement("i",{className:"fab fa-youtube"})),T&&React.createElement("button",{className:"action-edit",onClick:()=>Pt(n)},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"action-delete",onClick:()=>_(n)},React.createElement("i",{className:"fas fa-trash"}))))},[lt,ut]=useState(!1);return React.createElement(React.Fragment,null,React.createElement("div",{className:"result-header"},React.createElement("span",null,React.createElement("strong",null,G.length)," k\u1EBFt qu\u1EA3",Ee&&D.length>=3&&React.createElement("span",{className:"ai-badge ms-2"},React.createElement("i",{className:"fas fa-robot"})," AI"),be!=="all"&&React.createElement("span",{className:"ms-2 badge bg-warning text-dark"},be==="product"?"S\u1EA3n ph\u1EA9m":be==="album"?"\u1EA2nh":"Video")),React.createElement("div",{className:"d-flex gap-1 align-items-center"},React.createElement("button",{className:`btn btn-sm ${xe==="list"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>Ue("list"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-list"})),React.createElement("button",{className:`btn btn-sm ${xe==="grid"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>Ue("grid"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-th"})))),React.createElement("div",{className:"search-results-area"},ue?React.createElement("div",null,[...Array(8)].map((n,f)=>React.createElement("div",{key:f,className:"product-card-mobile mb-2",style:{opacity:.7}},React.createElement("div",{className:"card-inner"},React.createElement("div",{className:"thumb bg-light",style:{width:80,height:80,borderRadius:8}}),React.createElement("div",{className:"info",style:{flex:1,minWidth:0}},React.createElement("div",{className:"skeleton-box mb-2",style:{height:16,width:"60%",background:"#eee",borderRadius:4}}),React.createElement("div",{className:"skeleton-box mb-1",style:{height:12,width:"40%",background:"#f3f3f3",borderRadius:4}}),React.createElement("div",{className:"skeleton-box",style:{height:10,width:"30%",background:"#f3f3f3",borderRadius:4}})))))):G.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-search"}),React.createElement("p",null,'Kh\xF4ng t\xECm th\u1EA5y "',D,'"'),React.createElement("button",{className:"btn btn-warning",onClick:()=>{ie(""),me("")}},"Xem t\u1EA5t c\u1EA3")):xe==="grid"?React.createElement("div",{className:"product-grid-mobile"},G.map((n,f)=>wt(n,f))):React.createElement("div",null,G.map((n,f)=>wt(n,f)))),lt&&React.createElement("div",{className:"filter-dropdown"},React.createElement("div",{className:"filter-header"},React.createElement("strong",null,"L\u1ECDc theo lo\u1EA1i"),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>ut(!1)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"filter-chips"},React.createElement("span",{className:`filter-chip ${be==="all"?"active":""}`,onClick:()=>{w("all"),ut(!1)}},"T\u1EA5t c\u1EA3"),React.createElement("span",{className:`filter-chip ${be==="product"?"active":""}`,onClick:()=>{w("product"),ut(!1)}},React.createElement("i",{className:"fas fa-box me-1"}),"S\u1EA3n ph\u1EA9m"),React.createElement("span",{className:`filter-chip ${be==="album"?"active":""}`,onClick:()=>{w("album"),ut(!1)}},React.createElement("i",{className:"fas fa-images me-1"}),"\u1EA2nh"),React.createElement("span",{className:`filter-chip ${be==="video"?"active":""}`,onClick:()=>{w("video"),ut(!1)}},React.createElement("i",{className:"fas fa-video me-1"}),"Video")),React.createElement("div",{className:"mt-3 pt-3 border-top d-flex align-items-center justify-content-between"},React.createElement("span",null,"AI Search th\xF4ng minh"),React.createElement("div",{className:"form-check form-switch m-0"},React.createElement("input",{type:"checkbox",className:"form-check-input",checked:Ee,onChange:n=>Oe(n.target.checked),style:{width:40,height:20}})))),React.createElement("div",{className:"search-bar-bottom"},React.createElement("div",{className:"search-input-wrap"},React.createElement("input",{ref:ke,type:"text",className:"search-input",placeholder:"\u{1F50D} T\xECm: van 3 tay, xylanh...",value:D,onChange:n=>me(n.target.value)}),React.createElement("button",{className:`filter-btn ${lt||be!=="all"?"active":""}`,onClick:()=>ut(!lt)},React.createElement("i",{className:"fas fa-filter"})))),React.createElement("button",{className:"btn btn-lg rounded-circle position-fixed shadow-lg",style:{bottom:k?320:130,right:16,width:56,height:56,zIndex:1050,transition:"bottom 0.2s ease",background:"linear-gradient(135deg, #667eea, #764ba2)",color:"#fff",border:"none",WebkitTapHighlightColor:"transparent",touchAction:"manipulation",cursor:"pointer",outline:"none"},onClick:()=>m(!0),onTouchStart:()=>m(!0)},React.createElement("i",{className:"fas fa-robot fa-lg"})),ze&&React.createElement("div",{className:"ai-chat-mobile"},React.createElement("div",{className:"chat-header"},React.createElement("button",{className:"back-btn",onClick:()=>m(!1)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("strong",null,"KTM AI Assistant"),React.createElement("div",{style:{fontSize:11,opacity:.8}},"H\u1ECFi v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3..."))),React.createElement("div",{className:"chat-messages"},$.map((n,f)=>React.createElement("div",{key:f,className:`mb-3 ${n.role==="user"?"d-flex justify-content-end":""}`},React.createElement("div",{className:`p-3 rounded-3 position-relative ${n.role==="user"?"text-white":"bg-white border"}`,style:{maxWidth:"85%",whiteSpace:"pre-wrap",background:n.role==="user"?"linear-gradient(135deg, #667eea, #764ba2)":void 0}},n.content,n.role==="assistant"&&React.createElement("button",{className:"btn btn-sm position-absolute",style:{top:4,right:4,padding:"2px 6px",fontSize:11,background:le===`chat-${f}`?"#28a745":"rgba(0,0,0,0.1)",border:"none",borderRadius:4,color:le===`chat-${f}`?"#fff":"#666"},onClick:()=>{window.KTM.clipboard.writeText(n.content),re(`chat-${f}`),setTimeout(()=>re(null),1500)}},React.createElement("i",{className:`fas ${le===`chat-${f}`?"fa-check":"fa-copy"}`})),n.attachments&&n.attachments.length>0&&React.createElement("div",{className:"mt-2 d-flex flex-wrap gap-2"},n.attachments.map((T,q)=>React.createElement("div",{key:q,style:{width:70},className:"text-center"},T.image&&React.createElement("img",{src:T.image,className:"rounded",style:{width:70,height:50,objectFit:"cover",cursor:"pointer"},onClick:()=>Ne({url:T.image,name:T.name,price:T.price})}),React.createElement("div",{style:{fontSize:9},className:"text-truncate"},T.name),T.price&&React.createElement("div",{style:{fontSize:10,color:"#dc3545",fontWeight:600}},T.price.replace(/[đ\s]/g,""),"\u0111"))))))),O&&React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"bg-white border p-3 rounded-3 d-inline-block"},React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang suy ngh\u0129...")),React.createElement("div",{ref:Y})),React.createElement("div",{className:"px-3 py-2 border-top d-flex gap-2 overflow-auto"},["Gi\xE1 van 2 tay?","Combo r\u1EBB nh\u1EA5t?","Freeship?","Van 3 tay?"].map(n=>React.createElement("button",{key:n,className:"btn btn-sm btn-outline-secondary flex-shrink-0",onClick:()=>Ve(n),disabled:O,style:{whiteSpace:"nowrap"}},n))),React.createElement("div",{className:"chat-input-area"},React.createElement("form",{onSubmit:n=>{n.preventDefault(),Ve(b)},className:"chat-input-wrap"},React.createElement("input",{ref:E,type:"text",className:"chat-input",placeholder:"Nh\u1EADp c\xE2u h\u1ECFi...",value:b,onChange:n=>y(n.target.value),disabled:O}),React.createElement("button",{type:"submit",className:"send-btn",disabled:O||!b.trim()},React.createElement("i",{className:"fas fa-paper-plane"}))))),z&&React.createElement("div",{className:"preview-modal",onClick:()=>Ne(null)},React.createElement("div",{className:"preview-header"},React.createElement("div",null),React.createElement("button",{className:"close-btn",onClick:()=>Ne(null)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"preview-body",onClick:n=>n.stopPropagation()},React.createElement("img",{src:z.url,alt:z.name})),React.createElement("div",{className:"preview-footer",onClick:n=>n.stopPropagation()},React.createElement("div",{className:"name"},z.name),z.price&&React.createElement("div",{className:"price"},z.price.replace(/[đ\s]/g,""),"\u0111"),z.note&&React.createElement("div",{className:"mb-2",style:{fontSize:14,color:"#17a2b8"}},z.note),React.createElement("div",{className:"action-btns"},React.createElement("button",{className:le==="preview-img"?"btn-success text-white":"btn-outline-light text-white",style:{background:le==="preview-img"?"#28a745":"rgba(255,255,255,0.2)"},onClick:()=>Me(z.url,"preview")},React.createElement("i",{className:`fas ${le==="preview-img"?"fa-check":"fa-copy"}`}),"Copy \u1EA3nh"),z.price&&React.createElement("button",{className:le==="preview-price"?"btn-success text-white":"btn-warning",onClick:()=>we(z.price.replace(/[đ\s]/g,""),"preview-price")},React.createElement("i",{className:`fas ${le==="preview-price"?"fa-check":"fa-tag"}`}),"Copy gi\xE1")))),React.createElement(Ge,{show:te,product:Ye,categories:de,onClose:()=>{Re(!1),Be(null)},onSave:Qe}),React.createElement("div",{className:`fab-container mobile-only ${k?"open":""}`},React.createElement("div",{className:"fab-actions"},React.createElement("button",{className:"fab-action product",onClick:()=>{K(!1),Re(!0),Be(null)}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",{className:"tooltip"},"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("button",{className:"fab-action product",onClick:()=>{K(!1),S&&S("orders","create")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",{className:"tooltip"},"T\u1EA1o order nhanh"))),React.createElement("button",{className:`fab-main ${k?"open":""}`,onClick:()=>K(!k)},React.createElement("i",{className:"fas fa-plus"}))),Je&&v&&React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,maxHeight:"90vh"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none"}},React.createElement("h6",{className:"modal-title fw-bold"},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa nhanh"),React.createElement("button",{type:"button",className:"btn-close",onClick:()=>u(!1)})),React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"T\xEAn s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:Le.name,onChange:n=>ot({...Le,name:n.target.value})})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:Le.code,onChange:n=>ot({...Le,code:n.target.value})})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:Le.price,onChange:n=>ot({...Le,price:n.target.value})}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:Le.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:n=>ot({...Le,commission_percent:n.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:Le.category,onChange:n=>ot({...Le,category:n.target.value})},React.createElement("option",{value:""},"-- Ch\u1ECDn danh m\u1EE5c --"),xt.map(n=>React.createElement("option",{key:n,value:n},n)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Ghi ch\xFA (\u01B0u \u0111\xE3i)"),React.createElement("input",{type:"text",className:"form-control",value:Le.note,placeholder:"VD: Free ship, Gi\u1EA3m 10%...",onChange:n=>ot({...Le,note:n.target.value})}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>u(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-warning",onClick:yt},React.createElement("i",{className:"fas fa-save me-1"}),"L\u01B0u"))))))}function VideoList({onRefresh:A,showToast:S}){const[D,ie]=useState([]),[G,x]=useState([]),[P,ce]=useState(!0),[de,U]=useState(null),[be,_e]=useState(!1),[le,re]=useState(null),[xe,Ue]=useState(!1),[ue,Se]=useState(null),[Ce,qe]=useState(null),[Ke,Ie]=useState([]);useEffect(()=>{ke()},[]);const ke=async(u=null)=>{ce(!0);try{const v=u?`${API_BASE}/api/video-folders?withVideos=true&parent_id=${u}`:`${API_BASE}/api/video-folders?withVideos=true&parent_id=root`,ge=await window.KTM.api.getJSON(v,"L\u1ED7i t\u1EA3i danh s\xE1ch folder");ie(Array.isArray(ge)?ge:[])}catch(v){console.error(v),S("L\u1ED7i t\u1EA3i danh s\xE1ch folder","danger")}ce(!1)},Ee=async u=>{try{const v=await window.KTM.api.getJSON(`${API_BASE}/api/videos?folderId=${u}`,"L\u1ED7i t\u1EA3i video");x(Array.isArray(v)?v:[])}catch(v){console.error(v)}},Oe=async u=>{if(u===0)return;const v=[...D];[v[u-1],v[u]]=[v[u],v[u-1]],ie(v),await je(v)},ct=async u=>{if(u===D.length-1)return;const v=[...D];[v[u],v[u+1]]=[v[u+1],v[u]],ie(v),await je(v)},je=async u=>{try{await Promise.all(u.map((v,ge)=>window.KTM.api.putJSON(`${API_BASE}/api/video-folders/${v.id}`,{sortOrder:ge},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),S("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(v){S("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),ke(Ce==null?void 0:Ce.id)}},Xe=async u=>{if(u===0)return;const v=[...G];[v[u-1],v[u]]=[v[u],v[u-1]],x(v),await m(v)},ze=async u=>{if(u===G.length-1)return;const v=[...G];[v[u],v[u+1]]=[v[u+1],v[u]],x(v),await m(v)},m=async u=>{try{await Promise.all(u.map((v,ge)=>window.KTM.api.putJSON(`${API_BASE}/api/videos/${v.id}`,{sort_order:ge},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),S("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(v){S("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),Ee(de.id)}},$=()=>{re(null),_e(!0)},i=u=>{re(u),_e(!0)},b=async u=>{try{!le&&Ce&&(u.parent_id=Ce.id);const v=le?`${API_BASE}/api/video-folders/${le.id}`:`${API_BASE}/api/video-folders`;le?await window.KTM.api.putJSON(v,u,"L\u1ED7i l\u01B0u folder"):await window.KTM.api.postJSON(v,u,"L\u1ED7i l\u01B0u folder"),S(le?"\u0110\xE3 c\u1EADp nh\u1EADt folder!":"\u0110\xE3 t\u1EA1o folder m\u1EDBi!","success"),_e(!1),ke(Ce==null?void 0:Ce.id)}catch(v){S(v.message,"danger")}},y=async u=>{const v=u.subfolderCount>0?`X\xF3a folder "${u.name}"? T\u1EA5t c\u1EA3 subfolder v\xE0 videos b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`:`X\xF3a folder "${u.name}"? Videos trong folder s\u1EBD kh\xF4ng b\u1ECB x\xF3a.`;if(confirm(v))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/video-folders/${u.id}`,"L\u1ED7i x\xF3a folder"),S("\u0110\xE3 x\xF3a folder","success"),U(null),ke(Ce==null?void 0:Ce.id)}catch(ge){S("L\u1ED7i x\xF3a folder","danger")}},O=u=>{u.subfolderCount>0?(Ie(v=>[...v,u]),qe(u),ke(u.id)):(U(u),x(u.videos||[]))},F=u=>{if(u==="root")Ie([]),qe(null),ke(null);else if(u){const v=Ke.findIndex(ge=>ge.id===u.id);v>=0&&(Ie(Ke.slice(0,v+1)),qe(u),ke(u.id))}else{const v=[...Ke];v.pop();const ge=v[v.length-1]||null;Ie(v),qe(ge),ke(ge==null?void 0:ge.id)}},Y=()=>{Se(null),Ue(!0)},E=u=>{Se(u),Ue(!0)},z=async u=>{try{u.folder_id=de==null?void 0:de.id;const v=ue?`${API_BASE}/api/videos/${ue.id}`:`${API_BASE}/api/videos`;ue?await window.KTM.api.putJSON(v,u,"L\u1ED7i l\u01B0u video"):await window.KTM.api.postJSON(v,u,"L\u1ED7i l\u01B0u video"),S(ue?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm video th\xE0nh c\xF4ng!","success"),Ue(!1),ke(),de&&Ee(de.id)}catch(v){S(v.message,"danger")}},Ne=async u=>{if(confirm(`X\xF3a video "${u.title}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/videos/${u.id}`,"L\u1ED7i x\xF3a video"),S("\u0110\xE3 x\xF3a video","success"),ke(),de&&Ee(de.id)}catch(v){S("L\u1ED7i x\xF3a video","danger")}},Je=u=>{const v=`https://www.youtube.com/watch?v=${u.youtubeId}`;window.KTM.clipboard.writeText(v).then(()=>{S("\u0110\xE3 copy link!","success")}).catch(()=>{S("Kh\xF4ng th\u1EC3 copy link","danger")})};return de?React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>U(null)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:`fas fa-folder-open me-2 ${de.slug==="shorts"?"text-danger":"text-warning"}`}),de.name)),React.createElement("button",{className:"btn btn-warning",onClick:Y},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm Video")),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1 videos"),G.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-video fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},"Ch\u01B0a c\xF3 video trong folder n\xE0y")):React.createElement("div",{className:"row g-4"},G.map((u,v)=>React.createElement("div",{key:u.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>Xe(v),disabled:v===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},v+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>ze(v),disabled:v===G.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"position-relative"},React.createElement("img",{src:u.thumb,className:"card-img-top",alt:u.title,style:{height:"120px",objectFit:"cover"}}),React.createElement("a",{href:`https://www.youtube.com/watch?v=${u.youtubeId}`,target:"_blank",className:"position-absolute top-50 start-50 translate-middle"},React.createElement("i",{className:"fas fa-play-circle fa-3x text-white",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"}}))),React.createElement("div",{className:"card-body py-2"},React.createElement("h6",{className:"card-title small mb-1 text-truncate",title:u.title},u.title),React.createElement("small",{className:"text-muted"},u.youtubeId)),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-primary",onClick:()=>Je(u),title:"Copy link"},React.createElement("i",{className:"fas fa-link"})),React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>E(u),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-outline-danger",onClick:()=>Ne(u),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))))),React.createElement(VideoModal,{show:xe,video:ue,onClose:()=>Ue(!1),onSave:z})):React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},Ce&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>F()},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-video me-2 text-warning"}),Ce?Ce.name:"Qu\u1EA3n l\xFD Video")),React.createElement("button",{className:"btn btn-warning",onClick:$},React.createElement("i",{className:"fas fa-folder-plus me-2"}),"T\u1EA1o Folder")),Ke.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:u=>{u.preventDefault(),F("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),Ke.map((u,v)=>React.createElement("li",{key:u.id,className:`breadcrumb-item ${v===Ke.length-1?"active":""}`},v===Ke.length-1?u.name:React.createElement("a",{href:"#",onClick:ge=>{ge.preventDefault(),F(u)},className:"text-warning"},u.name))))),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1. Click v\xE0o folder \u0111\u1EC3 v\xE0o b\xEAn trong."),P?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):D.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},Ce?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder video n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:$},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o folder",Ce?" con":" \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"row g-3"},D.map((u,v)=>{var ge,k,K,te;return React.createElement("div",{key:u.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-card"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Re=>{Re.stopPropagation(),Oe(v)},disabled:v===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},v+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Re=>{Re.stopPropagation(),ct(v)},disabled:v===D.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"card-body text-center py-3",onClick:()=>O(u),style:{cursor:"pointer"}},React.createElement("i",{className:`fas fa-folder fa-3x mb-3 ${u.slug==="shorts"?"text-danger":"text-warning"}`}),React.createElement("h5",{className:"card-title"},u.name),React.createElement("p",{className:"text-muted mb-0"},u.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),u.subfolderCount," folder"),u.subfolderCount>0&&(u.videoCount>0||((ge=u.videos)==null?void 0:ge.length)>0)&&" \u2022 ",(u.videoCount>0||((k=u.videos)==null?void 0:k.length)>0)&&React.createElement("span",null,React.createElement("i",{className:"fas fa-video me-1"}),u.videoCount||((K=u.videos)==null?void 0:K.length)||0," videos"),u.subfolderCount===0&&!u.videoCount&&!((te=u.videos)!=null&&te.length)&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:Re=>{Re.stopPropagation(),i(u)}},React.createElement("i",{className:"fas fa-edit"})," S\u1EEDa"),React.createElement("button",{className:"btn btn-outline-danger",onClick:Re=>{Re.stopPropagation(),y(u)}},React.createElement("i",{className:"fas fa-trash"})," X\xF3a")))))})),React.createElement(VideoFolderModal,{show:be,folder:le,onClose:()=>_e(!1),onSave:b}))}function VideoFolderModal({show:A,folder:S,onClose:D,onSave:ie}){const[G,x]=useState({name:"",description:"",sortOrder:0,coverImage:""}),[P,ce]=useState(!1),[de,U]=useState(!1);useEffect(()=>{x(S?{name:S.name||"",description:S.description||"",sortOrder:S.sortOrder||0,coverImage:S.coverImage||""}:{name:"",description:"",sortOrder:0,coverImage:""})},[S,A]);const be=async le=>{const re=le.target.files[0];if(re){U(!0);try{const xe=await window.KTM.cloudinary.uploadImage({file:re,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});xe.secure_url&&x(Ue=>({...Ue,coverImage:xe.secure_url})),window.KTM.cache.remove(CACHE_KEY),showToast("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),setShowQuickEdit(!1),setEditingItem(null),loadAllData()}catch(xe){console.error("Cloudinary upload error:",xe),alert("L\u1ED7i upload \u1EA3nh: "+(xe.message||xe))}finally{U(!1)}}},_e=async le=>{le.preventDefault(),ce(!0);const re={...G,variants:normalizeVariants(G.variants,G.price),attributes:normalizeAttributes(G.attributes)};await ie(re),ce(!1)};return A?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},S?"S\u1EEDa Folder":"T\u1EA1o Folder m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:D})),React.createElement("form",{onSubmit:_e},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn folder *"),React.createElement("input",{type:"text",className:"form-control",value:G.name,onChange:le=>x({...G,name:le.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",value:G.description,onChange:le=>x({...G,description:le.target.value}),rows:"2"})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:G.sortOrder,onChange:le=>x({...G,sortOrder:parseInt(le.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex align-items-start gap-3"},G.coverImage?React.createElement("div",{className:"position-relative"},React.createElement("img",{src:G.coverImage,alt:"Cover",className:"rounded",style:{width:120,height:80,objectFit:"cover"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute top-0 end-0",onClick:()=>x({...G,coverImage:""}),style:{transform:"translate(30%, -30%)"}},React.createElement("i",{className:"fas fa-times"}))):React.createElement("div",{className:"bg-light rounded d-flex align-items-center justify-content-center text-muted",style:{width:120,height:80}},React.createElement("i",{className:"fas fa-image fa-2x"})),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{type:"file",className:"form-control form-control-sm",accept:"image/*,image/jpeg,image/png,image/gif,image/webp",onChange:be,disabled:de}),de&&React.createElement("div",{className:"mt-1 text-muted small"},React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang upload..."),React.createElement("div",{className:"mt-1 text-muted small"},"Ho\u1EB7c d\xE1n URL:"),React.createElement("input",{type:"url",className:"form-control form-control-sm",placeholder:"https://...",value:G.coverImage,onChange:le=>x({...G,coverImage:le.target.value})}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:D},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:P},P?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function ProductManager({showToast:A,settings:S}){const[D,ie]=useState([]),[G,x]=useState(!0),[P,ce]=useState(!1),[de,U]=useState(null),[be,_e]=useState(""),[le,re]=useState(""),xe=normalizeShipPercent(S==null?void 0:S.ship_percent),{parseMoney:Ue,formatVND:ue}=window.KTM.money,Se=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"];useEffect(()=>{Ce()},[]);const Ce=async()=>{x(!0);try{const i=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");ie(Array.isArray(i)?i:[])}catch(i){console.error(i),A("L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m","danger")}x(!1)},qe=()=>{U(null),ce(!0)},Ke=i=>{U(i),ce(!0)},Ie=async i=>{if(!(!i||!i.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:i},"L\u1ED7i x\xF3a \u1EA3nh"),window.KTM.cache.remove(CACHE_KEY),A(`\u0110\xE3 x\xF3a ${typeName}`,"success"),loadAllData(),Ce()}catch(b){A("L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m","danger")}},ke=async i=>{try{const b=de?`${API_BASE}/api/products?id=${de.id}`:`${API_BASE}/api/products`;de?await window.KTM.api.putJSON(b,i,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(b,i,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),A(de?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),ce(!1),Ce()}catch(b){A(b.message,"danger")}},Ee=async i=>{if(confirm(`B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n x\xF3a s\u1EA3n ph\u1EA9m "${i.name}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/products?id=${i.id}`,"L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m"),A("X\xF3a s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Ce()}catch(b){A(b.message,"danger")}},Oe=D.filter(i=>{const b=!be||i.name.toLowerCase().includes(be.toLowerCase())||i.code&&i.code.toLowerCase().includes(be.toLowerCase()),y=!le||i.category===le;return b&&y}),ct=i=>{var O;const b=(O=i==null?void 0:i.commission_percent)!=null?O:i==null?void 0:i.commissionPercent,y=b===""||b==null?NaN:Number(b);return Number.isFinite(y)?Math.max(0,Math.min(100,y)):5},je=i=>{const b=ct(i),y=Number.isInteger(b)?String(b):String(Math.round(b*100)/100),O=Ue(i==null?void 0:i.price);if(!Number.isFinite(O)||O<=0)return`${y}%`;const F=(Number(b)||0)/100,E=window.KTM.money.parseShipFeeFromNote(i==null?void 0:i.note)!=null?0:xe>0?O*xe/100:0,z=O*F-E*F,Ne=Math.max(0,Math.round(z));return`${y}% - ${ue(Ne)}`},Xe=i=>{if(i==null||i==="")return[];let b=i;if(typeof b=="string"){const y=b.trim();if(!y)return[];try{b=JSON.parse(y)}catch(O){return[]}}return Array.isArray(b)?b:[]},ze=i=>{if(i==null||i==="")return[];let b=i;if(typeof b=="string"){const y=b.trim();if(!y)return[];try{b=JSON.parse(y)}catch(O){return[]}}return b&&typeof b=="object"&&!Array.isArray(b)&&(b=Object.entries(b).map(([y,O])=>({key:y,value:O}))),Array.isArray(b)?b:[]},m=i=>{const b=ze(i).map(y=>{var O,F,Y,E,z;return{key:String((Y=(F=(O=y==null?void 0:y.key)!=null?O:y==null?void 0:y.name)!=null?F:y==null?void 0:y.label)!=null?Y:"").trim(),value:String((E=y==null?void 0:y.value)!=null?E:"").trim(),unit:String((z=y==null?void 0:y.unit)!=null?z:"").trim()}}).filter(y=>!!y.key);return b.length?React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},b.map((y,O)=>{const F=y.key,Y=`${y.value||""}${y.unit?(y.value?" ":"")+y.unit:""}`.trim();return React.createElement("div",{key:`${F}-${O}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},F),Y?React.createElement("span",{className:"ktm-chip ktm-chip-option"},Y):null)}))):null},$=(i,b={})=>{const y=Xe(i).map(E=>{var z;return{name:String((z=E==null?void 0:E.name)!=null?z:"").trim(),options:Array.isArray(E==null?void 0:E.options)?E.options:[]}}).map(E=>({...E,options:E.options.map(z=>{var Ne;return{label:String((Ne=z==null?void 0:z.label)!=null?Ne:"").trim(),price:Number(z==null?void 0:z.price)}}).filter(z=>!!z.label)})).filter(E=>E.options.length>0);if(!y.length)return null;const O=Number.isFinite(b.maxGroups)?Math.max(1,Math.trunc(b.maxGroups)):y.length,F=Number.isFinite(b.maxOptionsPerGroup)?Math.max(1,Math.trunc(b.maxOptionsPerGroup)):4,Y=y.slice(0,O);return React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},Y.map((E,z)=>{const Ne=E.name||"Bi\u1EBFn th\u1EC3",Je=E.options.slice(0,F),u=E.options.length-Je.length;return React.createElement("div",{key:`${Ne}-${z}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},Ne),Je.map((v,ge)=>{const k=v.price,K=Number.isFinite(k)&&k>=0?ue(Math.trunc(k)):"",te=K?`${v.label} \xB7 ${K}`:v.label;return React.createElement("span",{key:`${Ne}-${z}-${ge}`,className:"ktm-chip ktm-chip-option"},te)}),u>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",u))})))};return React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",null,React.createElement("i",{className:"fas fa-box me-2"}),"S\u1EA3n ph\u1EA9m"),React.createElement("button",{className:"btn-add-product",onClick:qe},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"d-flex gap-2 mb-2"},React.createElement("div",{className:"flex-grow-1 position-relative"},React.createElement("input",{type:"text",className:"form-control",placeholder:"\u{1F50D} T\xECm s\u1EA3n ph\u1EA9m...",value:be,onChange:i=>_e(i.target.value)})),React.createElement("span",{className:"product-count"},Oe.length)),React.createElement("select",{className:"form-select",value:le,onChange:i=>re(i.target.value)},React.createElement("option",{value:""},"\u{1F4C1} T\u1EA5t c\u1EA3 danh m\u1EE5c"),Se.map(i=>React.createElement("option",{key:i,value:i},i)))),G?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"2.5rem",height:"2.5rem"}}),React.createElement("p",{className:"text-muted mt-3 mb-0"},"\u0110ang t\u1EA3i...")):Oe.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-box-open"}),React.createElement("p",null,"Ch\u01B0a c\xF3 s\u1EA3n ph\u1EA9m n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:qe},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"product-list"},Oe.map(i=>React.createElement("div",{key:i.id,className:"product-item d-flex align-items-center gap-3"},i.image?React.createElement("img",{src:i.image,alt:"",className:"product-img"}):React.createElement("div",{className:"product-img-placeholder"},React.createElement("i",{className:"fas fa-image text-muted"})),React.createElement("div",{className:"flex-grow-1 min-width-0"},React.createElement("div",{className:"product-name"},i.name),React.createElement("div",{className:"d-flex flex-wrap gap-1 mb-1"},i.category&&React.createElement("span",{className:"product-badge bg-info bg-opacity-75"},i.category),i.code&&React.createElement("span",{className:"product-badge bg-secondary"},i.code),React.createElement("span",{className:"product-badge bg-warning text-dark",title:"Hoa h\u1ED3ng (%)"},React.createElement("i",{className:"fas fa-percent me-1"}),je(i))),React.createElement("div",{className:"product-price"},i.price?i.price.replace(/[đ\s]/g,"")+"\u0111":"Li\xEAn h\u1EC7"),i.note&&React.createElement("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"}},i.note),m(i.attributes)&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},m(i.attributes)),$(i.variants,{maxOptionsPerGroup:4})&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},$(i.variants,{maxOptionsPerGroup:4}))),React.createElement("div",{className:"product-actions"},React.createElement("button",{className:"btn btn-edit",onClick:()=>Ke(i),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"btn btn-delete",onClick:()=>Ee(i),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement(ProductModal,{show:P,product:de,categories:Se,onClose:()=>ce(!1),onSave:ke}))}function ProductModal({show:A,product:S,categories:D,onClose:ie,onSave:G}){const[x,P]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[ce,de]=useState(!1),[U,be]=useState(!1),_e=m=>{const $=window.KTM.money.getDigits(String(m!=null?m:"")),i=Number($);return $&&Number.isFinite(i)?Math.trunc(i):0},le=m=>{if(m==null||m==="")return[];let $=m;if(typeof $=="string"){const i=$.trim();if(!i)return[];try{$=JSON.parse(i)}catch(b){return[]}}return $&&typeof $=="object"&&!Array.isArray($)&&($=Object.entries($).map(([i,b])=>({key:i,value:b}))),Array.isArray($)?$.map(i=>{var F,Y,E,z,Ne;if(!i||typeof i!="object")return null;const b=String((E=(Y=(F=i.key)!=null?F:i.name)!=null?Y:i.label)!=null?E:"").trim(),y=String((z=i.value)!=null?z:"").trim(),O=String((Ne=i.unit)!=null?Ne:"").trim();return b?{key:b,value:y,unit:O}:null}).filter(Boolean):[]},re=(m,$)=>{if(m==null||m==="")return[];let i=m;if(typeof i=="string"){const y=i.trim();if(!y)return[];try{i=JSON.parse(y)}catch(O){return[]}}if(!Array.isArray(i))return[];const b=_e($);return i.map(y=>{var Y;if(!y||typeof y!="object")return null;const O=String((Y=y.name)!=null?Y:"").trim(),F=(Array.isArray(y.options)?y.options:[]).map(E=>{var ge,k,K,te,Re,Ye,Be;if(!E||typeof E!="object")return null;const z=String((ge=E.label)!=null?ge:"").trim();if(!z)return null;const Ne=(Re=(te=(K=(k=E.price)!=null?k:E.priceValue)!=null?K:E.unit_price)!=null?te:E.unitPrice)!=null?Re:null,Je=Number(Ne);let u=Number.isFinite(Je)?Math.trunc(Je):null;if(u==null){const Le=(Be=(Ye=E.price_delta)!=null?Ye:E.priceDelta)!=null?Be:null,ot=Number(Le);Number.isFinite(ot)&&(u=b+Math.trunc(ot))}u==null&&(u=b);const v=String(Math.max(0,Math.trunc(Number(u)||0)));return{label:z,price:Math.max(0,Math.trunc(Number(u)||0)),priceDigits:v}}).filter(Boolean);return{name:O||"Bi\u1EBFn th\u1EC3",options:F}}).filter(Boolean)};useEffect(()=>{var m,$;P(S?{name:S.name||"",code:S.code||"",price:S.price||"",image:S.image||"",category:S.category||"",note:S.note||"",sort_order:S.sort_order||0,commission_percent:($=(m=S.commission_percent)!=null?m:S.commissionPercent)!=null?$:5,variants:re(S.variants,S.price),attributes:le(S.attributes)}:{name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]})},[S,A]);const xe=m=>{P($=>{var F;const i=_e($.price),b=String(i),y=Array.isArray($.variants)?[...$.variants]:[],O={...y[m]||{},options:Array.isArray((F=y[m])==null?void 0:F.options)?[...y[m].options]:[]};return O.options=O.options.map(Y=>({label:String((Y==null?void 0:Y.label)||""),price:i,priceDigits:b})),y[m]=O,{...$,variants:y}})},Ue=()=>{P(m=>{const $=_e(m.price),i=String($),y=(Array.isArray(m.variants)?[...m.variants]:[]).map(O=>{const F=(Array.isArray(O==null?void 0:O.options)?O.options:[]).map(Y=>({label:String((Y==null?void 0:Y.label)||""),price:$,priceDigits:i}));return{name:String((O==null?void 0:O.name)||"Bi\u1EBFn th\u1EC3"),options:F}});return{...m,variants:y}})},[ue,Se]=React.useState(""),Ce=m=>window.KTM.money.formatVNDInputDigits(m),[qe,Ke]=React.useState(""),Ie=m=>{const $=window.KTM.money.nextPriceInputState(m.target.value,qe);Ke($.digits),P({...x,price:$.price})},[ke,Ee]=React.useState("");React.useEffect(()=>{S!=null&&S.image&&Ee(S.image)},[S]);const Oe=async m=>{if(!(!m||!m.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:m},"L\u1ED7i x\xF3a \u1EA3nh")}catch($){console.error("Delete cloudinary image error:",$)}},ct=async(m,$=2,i)=>{const b=$*1024*1024,y=m.type==="image/heic"||m.type==="image/heif"||/\.heic$/i.test(m.name);if(m.size<=b&&!y)return m;i==null||i("\u0110ang x\u1EED l\xFD \u1EA3nh...");try{const O=await createImageBitmap(m);i==null||i("\u0110ang n\xE9n \u1EA3nh...");const F=document.createElement("canvas");let Y=O.width,E=O.height;const z=1200;return(Y>z||E>z)&&(Y>E?(E=Math.round(E/Y*z),Y=z):(Y=Math.round(Y/E*z),E=z)),F.width=Y,F.height=E,F.getContext("2d").drawImage(O,0,0,Y,E),O.close(),new Promise((Je,u)=>{F.toBlob(v=>{v?(i==null||i("Ho\xE0n t\u1EA5t!"),Je(new File([v],m.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"}))):u(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(O){throw console.error("createImageBitmap error:",O),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},je=async m=>{var b,y;const $=(b=m.target.files)==null?void 0:b[0];if(!$)return;if(!($.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test($.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}be(!0),Se("\u0110ang chu\u1EA9n b\u1ECB...");try{const O=($.size/1024/1024).toFixed(1);Se(`File ${O}MB - \u0110ang n\xE9n...`);const F=await ct($,2,z=>{Se(z)}),Y=(F.size/1024/1024).toFixed(1);Se(`\u0110\xE3 n\xE9n: ${Y}MB - \u0110ang upload...`);const E=await window.KTM.cloudinary.uploadImage({file:F,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});E.secure_url?(x.image&&x.image!==ke&&Oe(x.image),P(z=>({...z,image:E.secure_url})),Se("")):(console.error("Cloudinary error:",E),alert("Upload th\u1EA5t b\u1EA1i: "+(((y=E.error)==null?void 0:y.message)||"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh")),Se(""))}catch(O){console.error("Upload error:",O),alert("L\u1ED7i: "+O.message),Se("")}be(!1),m.target.value=""},Xe=()=>{x.image&&(x.image!==ke&&Oe(x.image),P(m=>({...m,image:""})))},ze=async m=>{m.preventDefault(),de(!0),ke&&x.image&&ke!==x.image&&await Oe(ke),ke&&!x.image&&await Oe(ke),await G(x),de(!1)};return A?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down"},React.createElement("div",{className:"modal-content",style:{borderRadius:"16px",overflow:"hidden"}},React.createElement("div",{className:"modal-header border-0 py-3",style:{background:"linear-gradient(135deg, #ffc107 0%, #ffca2c 100%)"}},React.createElement("h6",{className:"modal-title fw-bold",style:{color:"#1a1a2e"}},React.createElement("i",{className:`fas ${S?"fa-edit":"fa-plus-circle"} me-2`}),S?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:ie})),React.createElement("form",{onSubmit:ze},React.createElement("div",{className:"modal-body py-4",style:{maxHeight:"65vh",overflowY:"auto",background:"#f8f9fa"}},React.createElement("div",{className:"text-center mb-4"},React.createElement("div",{className:"position-relative d-inline-block"},x.image?React.createElement(React.Fragment,null,React.createElement("img",{src:x.image,alt:"",style:{width:110,height:110,objectFit:"cover",borderRadius:"12px",boxShadow:"0 4px 15px rgba(0,0,0,0.15)"}}),React.createElement("button",{type:"button",className:"btn btn-danger position-absolute",onClick:Xe,style:{top:-10,right:-10,width:28,height:28,padding:0,borderRadius:"50%",boxShadow:"0 2px 8px rgba(220,53,69,0.4)"}},React.createElement("i",{className:"fas fa-times",style:{fontSize:"0.75rem"}}))):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:110,height:110,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd"}},React.createElement("i",{className:"fas fa-image fa-2x text-muted"}))),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"btn btn-warning btn-sm px-3",style:{borderRadius:"20px"}},React.createElement("i",{className:`fas ${U?"fa-spinner fa-spin":"fa-camera"} me-1`}),U?ue||"\u0110ang x\u1EED l\xFD...":"Ch\u1ECDn \u1EA3nh",React.createElement("input",{type:"file",accept:"image/*",onChange:je,disabled:U,style:{position:"absolute",left:"-9999px",opacity:0,width:1,height:1}})),U&&ue&&React.createElement("div",{className:"text-center mt-1",style:{fontSize:11,color:"#6c757d"}},ue))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-tag me-1 text-warning"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:x.name,onChange:m=>P({...x,name:m.target.value}),required:!0,placeholder:"VD: Combo Van 3 tay + 2 xylanh",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-barcode me-1 text-info"}),"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:x.code,onChange:m=>P({...x,code:m.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1 text-success"}),"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:x.price,onChange:Ie,placeholder:"1.950.000\u0111",inputMode:"numeric",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-percent me-1 text-secondary"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:x.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:m=>P({...x,commission_percent:m.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-folder me-1 text-primary"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:x.category,onChange:m=>P({...x,category:m.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),D.map(m=>React.createElement("option",{key:m,value:m},m)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1 text-secondary"}),"Ghi ch\xFA"),React.createElement("input",{type:"text",className:"form-control",value:x.note,onChange:m=>P({...x,note:m.target.value}),placeholder:"VD: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1 text-secondary"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(x.attributes)?x.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(x.attributes)?x.attributes:[]).map((m,$)=>React.createElement("div",{key:$,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(m==null?void 0:m.key)||"",onChange:i=>{const b=i.target.value;P(y=>{const O=Array.isArray(y.attributes)?[...y.attributes]:[];return O[$]={...O[$]||{},key:b},{...y,attributes:O}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(m==null?void 0:m.value)||"",onChange:i=>{const b=i.target.value;P(y=>{const O=Array.isArray(y.attributes)?[...y.attributes]:[];return O[$]={...O[$]||{},value:b},{...y,attributes:O}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(m==null?void 0:m.unit)||"",onChange:i=>{const b=i.target.value;P(y=>{const O=Array.isArray(y.attributes)?[...y.attributes]:[];return O[$]={...O[$]||{},unit:b},{...y,attributes:O}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{P(i=>{const b=Array.isArray(i.attributes)?[...i.attributes]:[];return b.splice($,1),{...i,attributes:b}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{P(m=>{const $=Array.isArray(m.attributes)?[...m.attributes]:[];return $.push({key:"",value:"",unit:""}),{...m,attributes:$}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1 text-secondary"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(x.variants)?x.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3."):null,(Array.isArray(x.variants)?x.variants:[]).map((m,$)=>React.createElement("div",{key:$,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(m==null?void 0:m.name)||"",onChange:i=>{const b=i.target.value;P(y=>{var F;const O=Array.isArray(y.variants)?[...y.variants]:[];return O[$]={...O[$]||{},name:b,options:Array.isArray((F=O[$])==null?void 0:F.options)?O[$].options:[]},{...y,variants:O}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>xe($),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(m==null?void 0:m.options)||m.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{P(i=>{const b=Array.isArray(i.variants)?[...i.variants]:[];return b.splice($,1),{...i,variants:b}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(m==null?void 0:m.options)?m.options:[]).map((i,b)=>{var y,O;return React.createElement("div",{key:b,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(i==null?void 0:i.label)||"",onChange:F=>{const Y=F.target.value;P(E=>{var v,ge,k,K,te;const z=Array.isArray(E.variants)?[...E.variants]:[],Ne={...z[$]||{},options:Array.isArray((v=z[$])==null?void 0:v.options)?[...z[$].options]:[]},Je=Number((k=(ge=Ne.options[b])==null?void 0:ge.price)!=null?k:0)||0,u=String((te=(K=Ne.options[b])==null?void 0:K.priceDigits)!=null?te:Math.max(0,Math.trunc(Je)));return Ne.options[b]={...Ne.options[b]||{},label:Y,price:Math.max(0,Math.trunc(Je)),priceDigits:u},z[$]=Ne,{...E,variants:z}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:Ce(String((O=i==null?void 0:i.priceDigits)!=null?O:window.KTM.money.getDigits(String((y=i==null?void 0:i.price)!=null?y:"")))),onChange:F=>{P(Y=>{var k,K,te,Re,Ye;const E=String((K=i==null?void 0:i.priceDigits)!=null?K:window.KTM.money.getDigits(String((k=i==null?void 0:i.price)!=null?k:""))),z=window.KTM.money.nextPriceInputState(F.target.value,E),Ne=String((te=z.digits)!=null?te:""),Je=Number(Ne),u=Number.isFinite(Je)?Math.max(0,Math.trunc(Je)):0,v=Array.isArray(Y.variants)?[...Y.variants]:[],ge={...v[$]||{},options:Array.isArray((Re=v[$])==null?void 0:Re.options)?[...v[$].options]:[]};return ge.options[b]={...ge.options[b]||{},label:String(((Ye=ge.options[b])==null?void 0:Ye.label)||""),price:u,priceDigits:Ne},v[$]=ge,{...Y,variants:v}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{P(F=>{var z;const Y=Array.isArray(F.variants)?[...F.variants]:[],E={...Y[$]||{},options:Array.isArray((z=Y[$])==null?void 0:z.options)?[...Y[$].options]:[]};return E.options.splice(b,1),Y[$]=E,{...F,variants:Y}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{P(i=>{var F;const b=Array.isArray(i.variants)?[...i.variants]:[],y={...b[$]||{},options:Array.isArray((F=b[$])==null?void 0:F.options)?[...b[$].options]:[]},O=_e(i.price);return y.options.push({label:"",price:O,priceDigits:String(O)}),b[$]=y,{...i,variants:b}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{P(m=>{const $=_e(m.price),i=Array.isArray(m.variants)?[...m.variants]:[],b=String($);return i.push({name:"Size",options:[{label:"S",price:$,priceDigits:b},{label:"M",price:$,priceDigits:b},{label:"L",price:$,priceDigits:b}]}),{...m,variants:i}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:Ue,disabled:!Array.isArray(x.variants)||x.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111."))),React.createElement("div",{className:"mb-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"URL \u1EA3nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",placeholder:"https://...",value:x.image,onChange:m=>P({...x,image:m.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"10px",fontSize:"0.9rem"}}))),React.createElement("div",{className:"modal-footer border-0 py-3",style:{background:"#fff"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:ie,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:ce,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},ce?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}function VideoModal({show:A,video:S,onClose:D,onSave:ie}){const[G,x]=useState({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),[P,ce]=useState(!1),[de,U]=useState("");useEffect(()=>{S?(x({title:S.title||"",youtube_url:`https://www.youtube.com/watch?v=${S.youtubeId}`,thumbnail_url:S.thumb||"",sort_order:S.sortOrder||0}),U(S.thumb)):(x({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),U(""))},[S,A]);const be=re=>{const xe=re.match(/(?:youtube\.com\/(?:embed\/|watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return xe?xe[1]:null},_e=re=>{x({...G,youtube_url:re});const xe=be(re);xe&&U(`https://img.youtube.com/vi/${xe}/hqdefault.jpg`)},le=async re=>{re.preventDefault(),ce(!0),await ie(G),ce(!1)};return A?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},S?"S\u1EEDa Video":"Th\xEAm Video m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:D})),React.createElement("form",{onSubmit:le},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Link YouTube *"),React.createElement("input",{type:"url",className:"form-control",value:G.youtube_url,onChange:re=>_e(re.target.value),placeholder:"https://www.youtube.com/watch?v=... ho\u1EB7c shorts/...",required:!0}),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3: youtube.com/watch, youtu.be, youtube.com/shorts")),de&&React.createElement("div",{className:"mb-3 text-center"},React.createElement("img",{src:de,alt:"Preview",className:"img-fluid rounded",style:{maxHeight:"150px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ti\xEAu \u0111\u1EC1 *"),React.createElement("input",{type:"text",className:"form-control",value:G.title,onChange:re=>x({...G,title:re.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:G.sort_order,onChange:re=>x({...G,sort_order:parseInt(re.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Thumbnail t\xF9y ch\u1EC9nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",value:G.thumbnail_url,onChange:re=>x({...G,thumbnail_url:re.target.value}),placeholder:"\u0110\u1EC3 tr\u1ED1ng s\u1EBD d\xF9ng thumbnail m\u1EB7c \u0111\u1ECBnh c\u1EE7a YouTube"}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:D},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:P},P?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function AdminApp(){const[A,S]=useState(!1),[D,ie]=useState(""),[G,x]=useState(null),[P,ce]=useState("search"),[de,U]=useState(null),[be,_e]=useState(""),[le,re]=useState([]),[xe,Ue]=useState(null),[ue,Se]=useState(!1),[Ce,qe]=useState(null),[Ke,Ie]=useState(!0),[ke,Ee]=useState([]),[Oe,ct]=useState(()=>loadAdminSettings()),[je,Xe]=useState(null),[ze,m]=useState([]);useEffect(()=>{const k=localStorage.getItem("ktm_admin_session");if(k)try{const K=JSON.parse(k);K.expiry>Date.now()?(S(!0),x(K.user)):localStorage.removeItem("ktm_admin_session")}catch(K){localStorage.removeItem("ktm_admin_session")}},[]),useEffect(()=>{A&&O()},[A]),useEffect(()=>{if(!A)return;let k=!1;return(async()=>{try{const K=await fetchAdminSettingsFromServer();if(k)return;ct(K),saveAdminSettings(K)}catch(K){}})(),()=>{k=!0}},[A]);const $=async(k,K)=>{ie("");try{const te=await window.KTM.api.postJSON(`${API_BASE}/api/auth/login`,{username:k,password:K},"\u0110\u0103ng nh\u1EADp th\u1EA5t b\u1EA1i"),Re={user:te.user,token:te.token,expiry:Date.now()+100*365*24*60*60*1e3};localStorage.setItem("ktm_admin_session",JSON.stringify(Re)),x(te.user),S(!0)}catch(te){ie(te.message)}},i=()=>{localStorage.removeItem("ktm_admin_session"),S(!1),x(null),re([]),Ue(null)},b=(k,K="success")=>{const te=Date.now();Ee(Re=>[...Re,{id:te,message:k,type:K}])},y=k=>{Ee(K=>K.filter(te=>te.id!==k))},O=async(k=null)=>{Ie(!0);try{const K=k?`${API_BASE}/api/albums?parent_id=${k}`:`${API_BASE}/api/albums?parent_id=root`,te=await window.KTM.api.getJSON(K,"L\u1ED7i t\u1EA3i danh s\xE1ch album");re(Array.isArray(te)?te:[])}catch(K){console.error(K),b("L\u1ED7i t\u1EA3i danh s\xE1ch album","danger")}Ie(!1)},F=()=>{qe(null),Se(!0)},Y=k=>{qe(k),Se(!0)},E=async k=>{try{const K=Ce&&Ce.uuid;!K&&je&&(k.parent_id=je.uuid);const te=K?`${API_BASE}/api/albums/${Ce.uuid||Ce.id}`:`${API_BASE}/api/albums`;K?await window.KTM.api.putJSON(te,k,"L\u1ED7i c\u1EADp nh\u1EADt"):await window.KTM.api.postJSON(te,k,"L\u1ED7i t\u1EA1o"),b(K?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"T\u1EA1o th\xE0nh c\xF4ng!","success"),Se(!1),O(je==null?void 0:je.uuid)}catch(K){b(K.message,"danger")}},z=k=>{Ue(k)},Ne=k=>{if(k==="root")m([]),Xe(null),O(null);else if(k){const K=ze.findIndex(te=>te.uuid===k.uuid);K>=0&&(m(ze.slice(0,K+1)),Xe(k),O(k.uuid))}else{const K=[...ze];K.pop();const te=K[K.length-1]||null;m(K),Xe(te),O(te==null?void 0:te.uuid)}},Je=async k=>{const K=`X\xF3a folder "${k.title}"? T\u1EA5t c\u1EA3 folder con v\xE0 \u1EA3nh b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`;if(confirm(K))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${k.uuid||k.id}`,"L\u1ED7i x\xF3a album"),b("\u0110\xE3 x\xF3a","success"),O(je==null?void 0:je.uuid)}catch(te){b("L\u1ED7i x\xF3a album","danger")}};if(!A)return React.createElement(LoginPage,{onLogin:$,error:D});const u=()=>{const k=new Date,K=k.getFullYear(),te=String(k.getMonth()+1).padStart(2,"0");return`${K}-${te}`};function v(){const[k,K]=useState(()=>{var Be;return String((Be=Oe==null?void 0:Oe.ship_percent)!=null?Be:DEFAULT_SHIP_PERCENT)}),[te,Re]=useState(!1);return useEffect(()=>{var Be;K(String((Be=Oe==null?void 0:Oe.ship_percent)!=null?Be:DEFAULT_SHIP_PERCENT))},[Oe==null?void 0:Oe.ship_percent]),React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-cog me-2 text-warning"}),"C\xE0i \u0111\u1EB7t")),React.createElement("div",{className:"card p-3"},React.createElement("form",{onSubmit:async Be=>{Be.preventDefault(),Re(!0);const Le=saveAdminSettings({ship_percent:k});try{const ot=await saveAdminSettingsToServer(Le);ct(ot),saveAdminSettings(ot),b("\u0110\xE3 l\u01B0u c\xE0i \u0111\u1EB7t v\xE0o DB","success")}catch(ot){ct(Le),b("Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c DB, \u0111\xE3 l\u01B0u t\u1EA1m tr\xEAn m\xE1y","warning")}finally{Re(!1)}}},React.createElement("div",{className:"mb-2 text-muted small"},"\xC1p d\u1EE5ng cho th\u1ED1ng k\xEA hoa h\u1ED3ng khi \u0111\u01A1n h\xE0ng kh\xF4ng ghi ph\xED ship trong ghi ch\xFA s\u1EA3n ph\u1EA9m."),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ph\xED ship (%) khi kh\xF4ng c\xF3 ship"),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",value:k,min:"0",max:"100",step:"0.01",onChange:Be=>K(Be.target.value)}),React.createElement("span",{className:"input-group-text"},"%")),React.createElement("div",{className:"form-text"},"M\u1EB7c \u0111\u1ECBnh: ",DEFAULT_SHIP_PERCENT,"%")),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:te},te?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u c\xE0i \u0111\u1EB7t"))))}function ge(){const[k,K]=useState(u()),[te,Re]=useState(!0),[Ye,Be]=useState([]),[Le,ot]=useState([]),xt=useRef(!1),Pt=useRef(new Map),yt=normalizeShipPercent(Oe==null?void 0:Oe.ship_percent),_=React.useMemo(()=>{var we;const w=new Map;for(const Me of Array.isArray(Le)?Le:[]){const De=String((we=Me==null?void 0:Me.id)!=null?we:"").trim();De&&w.set(De,Me)}return w},[Le]),Qe=w=>{const we=String(w!=null?w:"").trim();return we&&_.get(we)||null},{parseMoney:jt,formatNumber:ve,formatVND:et}=window.KTM.money,dt=w=>(Array.isArray(w)?w:[]).map(Me=>{const De=String((Me==null?void 0:Me.name)||"").trim();if(!De)return null;const Ve=(Array.isArray(Me==null?void 0:Me.options)?Me.options:[]).map(Ge=>{var ut,n;const tt=String((Ge==null?void 0:Ge.label)||"").trim();if(!tt)return null;const at=Ge==null?void 0:Ge.price,bt=at==null||at===""?NaN:typeof at=="number"?at:typeof at=="string"?jt(at):Number(at),gt=Number.isFinite(bt)?Math.trunc(bt):null,Nt=(n=(ut=Ge==null?void 0:Ge.price_delta)!=null?ut:Ge==null?void 0:Ge.priceDelta)!=null?n:null,wt=Number(Nt),lt=Number.isFinite(wt)?Math.trunc(wt):0;return{label:tt,price:gt,price_delta:lt}}).filter(Boolean);return{name:De,options:Ve}}).filter(Boolean),$t=w=>{var Nt,wt;const we=(Nt=w==null?void 0:w.unit_price)!=null?Nt:w==null?void 0:w.unitPrice,Me=we==null||we===""?NaN:Number(we);if(Number.isFinite(Me))return Math.max(0,Math.trunc(Me));const De=String((w==null?void 0:w.product_id)||"").trim(),Ve=Qe(De),Ge=jt(Ve==null?void 0:Ve.price),tt=(wt=w==null?void 0:w.variant_json)!=null?wt:w==null?void 0:w.variantJson,at=tt&&typeof tt=="object"?tt:null;if(!at)return Ge;const bt=dt(Ve==null?void 0:Ve.variants);if(!bt.length)return Ge;let gt=Ge;for(const lt of bt){const ut=String((lt==null?void 0:lt.name)||"").trim(),n=String((at==null?void 0:at[ut])||"").trim();if(!ut||!n)continue;const f=(Array.isArray(lt.options)?lt.options:[]).find(q=>String((q==null?void 0:q.label)||"").trim()===n);if(!f)continue;if(Number.isFinite(Number(f.price))){gt=Math.max(0,Math.trunc(Number(f.price)));continue}const T=Number(f.price_delta);Number.isFinite(T)&&(gt+=Math.trunc(T))}return gt},h=async()=>{if(!xt.current)try{const w=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i danh s\xE1ch s\u1EA3n ph\u1EA9m");ot(Array.isArray(w)?w:[]),xt.current=!0}catch(w){console.error("Load products for stats error:",w),ot([]),xt.current=!0}},se=async w=>{var Ge,tt;const we=String(w||"").trim();if(!we)return[];const Me=(Ge=Pt.current)==null?void 0:Ge.get(we);if(Me&&Array.isArray(Me))return Me;const De=await window.KTM.api.getJSON(`${API_BASE}/api/orders?month=${encodeURIComponent(we)}`,"L\u1ED7i t\u1EA3i th\u1ED1ng k\xEA"),Ve=Array.isArray(De)?De:[];return(tt=Pt.current)==null||tt.set(we,Ve),Ve},oe=async()=>{Re(!0);try{await h();const w=await se(k);Be(Array.isArray(w)?w:[])}catch(w){console.error("Load stats error:",w),Be([])}finally{Re(!1)}};useEffect(()=>{oe()},[k]);const me=React.useMemo(()=>{var pe;const w={draft:0,pending:0,processing:0,done:0,paid:0,canceled:0,other:0};let we=0,Me=0,De=0,Ve=0,Ge=0,tt=0,at=0,bt=0;const gt=X=>X.customer_id||X.phone||"unknown",Nt=X=>window.KTM.orders.getOrderItems(X),wt=new Map,lt=new Map,ut=new Map,n=5,f=new Map((Array.isArray(Le)?Le:[]).map(X=>{var it;const he=(it=X==null?void 0:X.commission_percent)!=null?it:X==null?void 0:X.commissionPercent,st=Number(he),vt=Number.isFinite(st)?Math.max(0,Math.min(100,st)):n;return[String(X==null?void 0:X.id),vt]})),T=X=>{const he=String(X!=null?X:"").trim().toLowerCase();return he==="cancelled"?"canceled":he};for(const X of Ye){const he=T(X==null?void 0:X.status),it=he==="canceled"||he==="draft",pt=Nt(X);let Fe=0,Tt=0,Bt=0;for(const I of pt){const J=Number((I==null?void 0:I.quantity)||0)||0,Q=$t(I),fe=J*Q,ye=String((I==null?void 0:I.product_id)||""),He=f.has(ye)?f.get(ye):n,nt=(Number(He)||0)/100;if(Fe+=J,Tt+=fe,Bt+=fe*nt,!it){const rt=(I==null?void 0:I.product_id)||"unknown",Ze=Qe(rt),Ae=wt.get(rt)||{product_id:rt,product_name:(Ze==null?void 0:Ze.name)||"\u2014",product_code:(Ze==null?void 0:Ze.code)||"",orders:0,quantity:0,revenue:0};Ae.orders+=1,Ae.quantity+=J,Ae.revenue+=fe,wt.set(rt,Ae)}}const St=window.KTM.orders.getOrderShipInfo(pt,Qe),Kt=Number((pe=X==null?void 0:X.adjustment_amount)!=null?pe:0)||0,Ot=Tt+(St.found?St.fee:0)+Kt,Et=Tt+Kt,zt=!St.found&&yt>0&&Tt>0?Tt*yt/100:0,M=Tt>0?Bt/Tt:n/100,L=Bt+Kt*M-zt*M,H=he==="done"||he==="paid";if(he==="draft"?w.draft+=1:he==="pending"?w.pending+=1:he==="processing"?w.processing+=1:he==="canceled"?w.canceled+=1:he==="paid"?(w.paid+=1,w.done+=1,Ve+=Ot,tt+=Et,bt+=L):he==="done"?(w.done+=1,Ve+=Ot,tt+=Et,bt+=L):w.other+=1,!it){we+=1,Me+=Fe,De+=Ot,Ge+=Et,at+=L;const I=gt(X),J=lt.get(I)||{key:I,customer_name:X.customer_name||"",phone:X.phone||"",orders:0,quantity:0,revenue:0};J.orders+=1,J.quantity+=Fe,J.revenue+=Ot,!J.customer_name&&X.customer_name&&(J.customer_name=X.customer_name),!J.phone&&X.phone&&(J.phone=X.phone),lt.set(I,J);const Q=X.created_at?new Date(X.created_at):null;if(Q&&!Number.isNaN(Q.getTime())){const fe=`${Q.getFullYear()}-${String(Q.getMonth()+1).padStart(2,"0")}-${String(Q.getDate()).padStart(2,"0")}`,ye=ut.get(fe)||{day:fe,orders:0,quantity:0,revenue:0,doneOrders:0,doneRevenue:0};ye.orders+=1,ye.quantity+=Fe,ye.revenue+=Ot,H&&(ye.doneOrders+=1,ye.doneRevenue+=Ot),ut.set(fe,ye)}}}const q=Array.from(wt.values()).sort((X,he)=>he.revenue-X.revenue),Z=Array.from(lt.values()).sort((X,he)=>he.revenue-X.revenue),j=Array.from(ut.values()).sort((X,he)=>X.day.localeCompare(he.day)),p=lt.size,B=we?Math.round(De/we):0,ae=we?Me/we:0,ne=Math.round(bt),W=Math.round(at);return{statusCounts:w,activeOrders:we,totalQty:Me,totalRevenue:De,doneRevenue:Ve,tempCommission:ne,tempCommissionAll:W,products:q,customers:Z,days:j,uniqueCustomers:p,avgOrderValue:B,avgQtyPerOrder:ae}},[Ye,Le,k]);return React.createElement("div",{className:"product-manager pb-5 mb-4 stats-manager"},React.createElement(Loading,{show:te}),React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-chart-column me-2 text-warning"}),"Th\u1ED1ng k\xEA"),React.createElement("button",{className:"btn btn-outline-secondary btn-sm",onClick:oe,disabled:te},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"Ch\u1ECDn th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:k,onChange:w=>K(w.target.value),"aria-label":"Ch\u1ECDn th\xE1ng"}))),React.createElement("div",{className:"col-12 col-md-7 d-flex gap-2 justify-content-md-end"},React.createElement("div",{className:"d-flex flex-wrap gap-2 align-self-center"},React.createElement("span",{className:"badge rounded-pill bg-secondary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-truck me-1"}),"Ship \u01B0\u1EDBc t\xEDnh: ",yt,"%"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-receipt me-1"}),ve(me.activeOrders)," \u0111\u01A1n"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-user me-1"}),ve(me.uniqueCustomers)," kh\xE1ch"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-boxes-stacked me-1"}),ve(me.totalQty)," SL"),React.createElement("span",{className:"badge rounded-pill bg-primary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-hand-holding-dollar me-1"}),"\u0110\xE3 nh\u1EADn ti\u1EC1n: ",ve(me.statusCounts.paid),"/",ve(me.statusCounts.done)))))),React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng \u0111\u01A1n (kh\xF4ng t\xEDnh h\u1EE7y/nh\xE1p)"),React.createElement("i",{className:"fas fa-receipt text-dark"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},ve(me.activeOrders)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (t\u1EA1m t\xEDnh)"),React.createElement("i",{className:"fas fa-sack-dollar text-warning"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},et(me.totalRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (Ho\xE0n th\xE0nh)"),React.createElement("i",{className:"fas fa-circle-check text-success"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},et(me.doneRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-info bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng s\u1EBD nh\u1EADn (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-chart-line text-info"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},et(me.tempCommission)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng t\u1ED5ng (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-coins text-primary"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},et(me.tempCommissionAll))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-layer-group me-2 text-warning"}),"T\u1ED5ng quan tr\u1EA1ng th\xE1i"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},"SL TB/\u0111\u01A1n: ",me.avgQtyPerOrder?me.avgQtyPerOrder.toFixed(2):"0.00")),React.createElement("div",{className:"d-md-none mt-2"},React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-light bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Nh\xE1p"),React.createElement("div",{className:"fw-semibold"},ve(me.statusCounts.draft)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-secondary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("div",{className:"fw-semibold"},ve(me.statusCounts.pending)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("div",{className:"fw-semibold"},ve(me.statusCounts.processing)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-danger bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"H\u1EE7y \u0111\u01A1n"),React.createElement("div",{className:"fw-semibold"},ve(me.statusCounts.canceled)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh"),React.createElement("div",{className:"fw-semibold"},ve(me.statusCounts.done)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("div",{className:"fw-semibold"},ve(me.statusCounts.paid)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng SL"),React.createElement("div",{className:"fw-semibold"},ve(me.totalQty)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Nh\xE1p"),React.createElement("th",null,"Ch\u1EDD x\u1EED l\xFD"),React.createElement("th",null,"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("th",null,"H\u1EE7y \u0111\u01A1n"),React.createElement("th",null,"Ho\xE0n th\xE0nh"),React.createElement("th",null,"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("th",null,"Kh\xE1c"),React.createElement("th",null,"T\u1ED5ng SL"))),React.createElement("tbody",null,React.createElement("tr",null,React.createElement("td",null,ve(me.statusCounts.draft)),React.createElement("td",null,ve(me.statusCounts.pending)),React.createElement("td",null,ve(me.statusCounts.processing)),React.createElement("td",null,ve(me.statusCounts.canceled)),React.createElement("td",null,ve(me.statusCounts.done)),React.createElement("td",null,ve(me.statusCounts.paid)),React.createElement("td",null,ve(me.statusCounts.other)),React.createElement("td",null,ve(me.totalQty))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-box me-2 text-info"}),"Top s\u1EA3n ph\u1EA9m"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},me.products.slice(0,10).map(w=>React.createElement("div",{key:w.product_id,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-info"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},w.product_name),React.createElement("div",{className:"text-muted small text-truncate"},w.product_code?`#${w.product_code} \u2022 `:"",ve(w.orders)," \u0111\u01A1n \u2022 ",ve(w.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},et(w.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"M\xE3"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,me.products.slice(0,10).map(w=>React.createElement("tr",{key:w.product_id},React.createElement("td",null,w.product_name),React.createElement("td",null,w.product_code||"\u2014"),React.createElement("td",null,ve(w.orders)),React.createElement("td",null,ve(w.quantity)),React.createElement("td",{className:"fw-semibold"},et(w.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-user-group me-2 text-warning"}),"Top kh\xE1ch h\xE0ng"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},me.customers.slice(0,10).map(w=>React.createElement("div",{key:w.key,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-warning"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},w.customer_name||"\u2014"),React.createElement("div",{className:"text-muted small text-truncate"},w.phone||"\u2014"," \u2022 ",ve(w.orders)," \u0111\u01A1n \u2022 ",ve(w.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},et(w.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,me.customers.slice(0,10).map(w=>React.createElement("tr",{key:w.key},React.createElement("td",null,w.customer_name||"\u2014"),React.createElement("td",null,w.phone||"\u2014"),React.createElement("td",null,ve(w.orders)),React.createElement("td",null,ve(w.quantity)),React.createElement("td",{className:"fw-semibold"},et(w.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3 mb-4"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-calendar-day me-2 text-success"}),"Theo ng\xE0y"),React.createElement("span",{className:"badge rounded-pill bg-success bg-opacity-10 text-dark"},"DT (t\u1EA1m t\xEDnh) & ho\xE0n th\xE0nh")),React.createElement("div",{className:"d-md-none mt-2"},me.days.map(w=>React.createElement("div",{key:w.day,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-success"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"fw-semibold"},w.day),React.createElement("div",{className:"text-muted small"},ve(w.orders)," \u0111\u01A1n \u2022 ",ve(w.quantity)," SL"),React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh: ",ve(w.doneOrders)," \u2022 ",et(w.doneRevenue))),React.createElement("div",{className:"fw-semibold text-nowrap"},et(w.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Ng\xE0y"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"DT (t\u1EA1m t\xEDnh)"),React.createElement("th",null,"\u0110\u01A1n ho\xE0n th\xE0nh"),React.createElement("th",null,"DT ho\xE0n th\xE0nh"))),React.createElement("tbody",null,me.days.map(w=>React.createElement("tr",{key:w.day},React.createElement("td",null,w.day),React.createElement("td",null,ve(w.orders)),React.createElement("td",null,ve(w.quantity)),React.createElement("td",{className:"fw-semibold"},et(w.revenue)),React.createElement("td",null,ve(w.doneOrders)),React.createElement("td",{className:"fw-semibold"},et(w.doneRevenue)))))))))}return React.createElement("div",null,React.createElement(Sidebar,{activeMenu:P,onMenuChange:k=>{ce(k),k==="albums"&&(Xe(null),m([]),O(null))},onLogout:i,currentUser:G}),React.createElement("div",{className:"main-content"},P==="albums"&&!xe&&React.createElement(AlbumList,{albums:le,loading:Ke,currentFolder:je,breadcrumb:ze,onSelect:z,onCreate:F,onEdit:Y,onDelete:Je,onBack:Ne}),P==="search"&&React.createElement(SearchCenter,{showToast:b,onNavigate:(k,K,te)=>{ce(k),k==="orders"&&K==="create"&&(U(Date.now()),_e((te==null?void 0:te.productId)||""))}}),P==="albums"&&xe&&React.createElement(AlbumDetail,{album:xe,parentAlbum:ze.length>0?ze[ze.length-1]:null,onBack:()=>{if(xe.parentId){const k=ze.findIndex(K=>K.uuid===xe.parentId);k>=0?Ue(ze[k]):Ue(null)}else Ue(null)},onRefresh:()=>O(je==null?void 0:je.uuid),showToast:b,onNavigateToFolder:k=>{m(K=>[...K,xe]),Ue(k)},onEditSubfolder:k=>{qe(k),Se(!0)}}),P==="videos"&&React.createElement(VideoList,{showToast:b}),P==="products"&&React.createElement(ProductManager,{showToast:b,settings:Oe}),P==="orders"&&React.createElement(OrderManager,{autoOpenCreateToken:de,autoOpenCreateProductId:be,showToast:b}),P==="stats"&&React.createElement(ge,null),P==="settings"&&React.createElement(v,null)),React.createElement("nav",{className:"mobile-bottom-nav"},React.createElement("div",{className:"nav-items"},React.createElement("a",{href:"#",className:`nav-item ${P==="search"?"active":""}`,onClick:k=>{k.preventDefault(),ce("search")}},React.createElement("i",{className:"fas fa-search"}),React.createElement("span",null,"Tra c\u1EE9u")),React.createElement("a",{href:"#",className:`nav-item ${P==="albums"?"active":""}`,onClick:k=>{k.preventDefault(),ce("albums"),Ue(null)}},React.createElement("i",{className:"fas fa-images"}),React.createElement("span",null,"Album")),React.createElement("a",{href:"#",className:`nav-item ${P==="videos"?"active":""}`,onClick:k=>{k.preventDefault(),ce("videos")}},React.createElement("i",{className:"fas fa-video"}),React.createElement("span",null,"Video")),React.createElement("a",{href:"#",className:`nav-item ${P==="products"?"active":""}`,onClick:k=>{k.preventDefault(),ce("products")}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",null,"S\u1EA3n ph\u1EA9m")),React.createElement("a",{href:"#",className:`nav-item ${P==="orders"?"active":""}`,onClick:k=>{k.preventDefault(),ce("orders")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",null,"\u0110\u01A1n h\xE0ng")),React.createElement("a",{href:"#",className:`nav-item ${P==="stats"?"active":""}`,onClick:k=>{k.preventDefault(),ce("stats")}},React.createElement("i",{className:"fas fa-chart-column"}),React.createElement("span",null,"Th\u1ED1ng k\xEA")))),React.createElement(AlbumModal,{show:ue,album:Ce,parentId:je==null?void 0:je.uuid,onClose:()=>Se(!1),onSave:E}),React.createElement("div",{className:"toast-container"},ke.map(k=>React.createElement(Toast,{key:k.id,message:k.message,type:k.type,onClose:()=>y(k.id)}))))}ReactDOM.render(React.createElement(AdminApp,null),document.getElementById("root"));function OrderManager({autoOpenCreateToken:A,autoOpenCreateProductId:S,showToast:D}){const[ie,G]=useState([]),[x,P]=useState(0),[ce,de]=useState(!1),[U,be]=useState(!1),[_e,le]=useState([]),[re,xe]=useState(!0),[Ue,ue]=useState(!1),[Se,Ce]=useState([]),[qe,Ke]=useState(!1),[Ie,ke]=useState(""),[Ee,Oe]=useState([]),[ct,je]=useState(!1),[Xe,ze]=useState(""),[m,$]=useState(!1),[i,b]=useState(null),[y,O]=useState(null),[F,Y]=useState(!1),[E,z]=useState(()=>{const e=new Date,a=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0");return`${a}-${t}`}),[Ne,Je]=useState(""),[u,v]=useState(!1),[ge,k]=useState(!1),[K,te]=useState(null),[Re,Ye]=useState(!1),[Be,Le]=useState([]),[ot,xt]=useState(!1),[Pt,yt]=useState([]),[_,Qe]=useState({customer_name:"",phone:"",address:"",note:"",items:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:[{amount:"",note:""}],adjustment_amount:0,adjustment_note:"",status:"pending"}),[jt,ve]=useState([""]),[et,dt]=useState(null),$t=useRef({}),[h,se]=useState([]),[oe,me]=useState(null),w=useRef(null),we=useRef(null),Me=useRef(0),De=useRef(null),Ve=useRef(0),Ge=useRef(new Map),tt=useRef(null),at=useRef(0),bt=useRef(new Map),gt=useRef(new Map),Nt=useRef(""),wt=useRef(null),lt=useRef(0),ut=useRef(null),n=9,f=150,T=250,q=3*60*1e3,Z=24*60*60*1e3,j=5*60*1e3,p="ktm_customer_lookup_cache_v1",B=200,ae=3,ne=3,W=1,pe=24*60*60*1e3,X=120,he=5*60*1e3,st=80,vt=2,it=4,pt=60,Fe=React.useMemo(()=>String(Ie||"").trim().length>0,[Ie]),Tt=e=>String(e||"").replace(/\s+/g," ").trim(),Bt=e=>String(e||"").replace(/[^0-9]+/g,""),St=e=>{try{const a=new Date(e==null?void 0:e.created_at).getTime();if(!Number.isFinite(a))return 0;const t=Date.now()-a;return!Number.isFinite(t)||t<=0?0:Math.floor(t/pe)}catch(a){return 0}},Kt=e=>String((e==null?void 0:e.status)||"").trim()!=="pending"?!1:St(e)>=ae,Ot=e=>{const a=String(e!=null?e:"").trim().toLowerCase();return a==="cancelled"?"canceled":a},Et=e=>{if(Ot(e==null?void 0:e.status)!=="draft")return null;const t=ne-St(e);return Number.isFinite(t)?t:null},zt=e=>{const a=Et(e);return Number.isFinite(a)?a>0&&a<=W:!1},M=e=>{Qe({customer_name:"",phone:"",address:"",note:"",items:[{product_id:e||"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:[{amount:"",note:""}],adjustment_amount:0,adjustment_note:"",status:"pending"}),ve([""]),te(null),dt(null)};useEffect(()=>{const e=a=>{var s;if(et==null)return;const t=(s=$t.current)==null?void 0:s[et];t&&!t.contains(a.target)&&dt(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[et]);const L=e=>window.KTM.money.parseMoney(e),H=e=>window.KTM.money.parseSignedMoney(e),I=e=>window.KTM.money.formatVND(e),J=e=>{const t=(Array.isArray(e)?e:[]).map(s=>{var l,o;return{amount:String((l=s==null?void 0:s.amount)!=null?l:""),note:String((o=s==null?void 0:s.note)!=null?o:"")}});return t.length?t:[{amount:"",note:""}]},Q=e=>{try{const a=window.KTM.orders.getOrderAdjustmentItems(e),t=(Array.isArray(a)?a:[]).map(s=>{var l,o;return{amount:(s==null?void 0:s.amount)===0?"":String((l=s==null?void 0:s.amount)!=null?l:""),note:String((o=s==null?void 0:s.note)!=null?o:"").trim()}}).filter(s=>String(s.amount||"").trim()||String(s.note||"").trim());return t.length?t:[{amount:"",note:""}]}catch(a){return[{amount:"",note:""}]}},fe=e=>(Array.isArray(e)?e:[]).map(t=>({amount:H(t==null?void 0:t.amount),note:String((t==null?void 0:t.note)||"").trim()})).filter(t=>t.amount!==0||!!t.note),ye=e=>{const a=Array.isArray(e==null?void 0:e.adjustment_items)?e.adjustment_items:[],t=fe(a),s=He(t),l=(()=>{if(!t.length)return"";const o=t.map(N=>String((N==null?void 0:N.note)||"").trim()).filter(Boolean);return o.length?o.join(" \u2022 "):t.length>1?`${t.length} m\u1EE5c`:""})();return{cleanAdjItems:t,amount:s,summaryText:l}},He=e=>(Array.isArray(e)?e:[]).reduce((t,s)=>t+(Number(s==null?void 0:s.amount)||0),0),nt=e=>{const a=Array.isArray(e)?e:[];return a.length?JSON.stringify(a):""},rt=e=>window.KTM.money.parseShipFeeFromNote(e),Ze=e=>window.KTM.phone.isValid(e),Ae=e=>window.KTM.phone.normalize(e),kt=async e=>{if(!e)return null;const a=await window.KTM.api.getJSON(`${API_BASE}/api/orders/${e}`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng");return a&&typeof a=="object"&&a.order&&typeof a.order=="object"?a.order:a},Ct=(e,a)=>{var o;const t=Array.isArray(e)?e:[],s=Array.isArray(a)?a:[];if(!t.length)return s;if(!s.length)return t;const l=new Map(t.map(N=>{var c;return[String((c=N==null?void 0:N.id)!=null?c:""),N]}));for(const N of s){const c=String((o=N==null?void 0:N.id)!=null?o:"");c&&l.set(c,N)}return Array.from(l.values())},At=async e=>{if(!(e!=null&&e.id)||Array.isArray(e.items)&&e.items.length)return e;try{const a=await kt(e.id);if(a&&typeof a=="object")return G(t=>Array.isArray(t)?t.map(s=>String(s==null?void 0:s.id)===String(e.id)?a:s):t),a}catch(a){console.error("Fetch order by id error:",a)}return e},It=()=>{var e;try{const a=localStorage.getItem(p);if(!a)return;const t=JSON.parse(a);if(!t||typeof t!="object")return;const s=Object.entries(t);for(const[l,o]of s)!l||!o||typeof o!="object"||(e=gt.current)==null||e.set(String(l),o)}catch(a){}},_t=()=>{try{const e=gt.current;if(!e||typeof e.entries!="function")return;const a=Array.from(e.entries()).filter(([s,l])=>s&&l&&typeof l=="object"&&Number.isFinite(l.ts)).sort((s,l)=>(Number(l[1].ts)||0)-(Number(s[1].ts)||0)).slice(0,B),t={};for(const[s,l]of a)t[s]=l;localStorage.setItem(p,JSON.stringify(t))}catch(e){}};useEffect(()=>{It()},[]);const Ht=e=>{const a=Ae(e);if(!a)return null;const t=Array.isArray(ie)?ie:[];let s=null,l=-1;for(const o of t){if(!o||Ae(o.phone||"")!==a)continue;const N=new Date(o.created_at).getTime(),c=Number.isFinite(N)?N:0;c>=l&&(l=c,s=o)}return s?{name:String(s.customer_name||"").trim(),address:String(s.address||"").trim()}:null},qt=(e,a)=>{e&&Qe(t=>a&&Ae(t.phone)!==a?t:{...t,customer_name:e.name||t.customer_name,address:e.address||t.address})},Yt=e=>{const a=Ht(e);if(!a)return;const t=Ae(e);Qe(s=>{if(t&&Ae(s.phone)!==t)return s;const l={...s};return!String(s.customer_name||"").trim()&&a.name&&(l.customer_name=a.name),!String(s.address||"").trim()&&a.address&&(l.address=a.address),l})},ma=(e,a,t)=>{var s;try{const l=Ae(e);if(!l)return;const o=String(a||"").trim(),N=String(t||"").trim();if(!o&&!N)return;(s=gt.current)==null||s.set(l,{ts:Date.now(),status:"found",customer:{phone:l,name:o||null,address:N||null}}),_t()}catch(l){}},Jt=async e=>{var l,o,N;const a=Ae(e);if(!a)return;Yt(a);const t=(l=gt.current)==null?void 0:l.get(a);if(t&&Number.isFinite(t.ts)){const c=Date.now()-t.ts,C=t.status==="found"?Z:j;if(c>=0&&c<=C){te({status:t.status,phone:a,customer:t.customer}),t.status==="found"&&t.customer&&qt(t.customer,a);return}}const s=++Me.current;te({status:"loading",phone:a});try{const c=await window.KTM.api.getJSON(`${API_BASE}/api/customers?phone=${encodeURIComponent(a)}`,"L\u1ED7i tra c\u1EE9u kh\xE1ch");if(Me.current!==s)return;if(c&&c.exists&&c.customer){(o=gt.current)==null||o.set(a,{ts:Date.now(),status:"found",customer:c.customer}),_t(),te({status:"found",phone:a,customer:c.customer}),qt(c.customer,a);return}(N=gt.current)==null||N.set(a,{ts:Date.now(),status:"not-found",customer:null}),_t(),te({status:"not-found",phone:a})}catch(c){if(Me.current!==s)return;console.error("Customer lookup error:",c),te({status:"error",phone:a})}},Ha=e=>{const a=Ae(e),t=Ht(a);Qe(l=>{const o={...l,phone:a};return t&&(!String(l.customer_name||"").trim()&&t.name&&(o.customer_name=t.name),!String(l.address||"").trim()&&t.address&&(o.address=t.address)),o}),Ye(!1),we.current&&(clearTimeout(we.current),we.current=null);const s=a;if(s.length<n){te(null);return}if(Ze(s)&&s!==Nt.current){Nt.current=s,Jt(s);return}we.current=setTimeout(()=>{const l=Ae(a);Ze(l)&&l!==Nt.current&&(Nt.current=l,Jt(l))},f)},qa=()=>{const e=Ae(_.phone);e.length<n||Ze(e)&&e!==Nt.current&&(Nt.current=e,Jt(e))};useEffect(()=>(ge?(document.body.classList.add("order-modal-open"),document.body.style.overflow="hidden"):(document.body.classList.remove("order-modal-open"),document.body.style.overflow=""),()=>{document.body.classList.remove("order-modal-open"),document.body.style.overflow=""}),[ge]);const Zt=Array.isArray(_.items)?_.items.length:0;useEffect(()=>{if(!ge){lt.current=Zt;return}Zt>lt.current&&setTimeout(()=>{const e=wt.current;e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},0),lt.current=Zt},[ge,Zt]),useEffect(()=>()=>{we.current&&(clearTimeout(we.current),we.current=null),De.current&&(clearTimeout(De.current),De.current=null)},[]),useEffect(()=>{if(!ge)return;De.current&&(clearTimeout(De.current),De.current=null);const e=Ae((_==null?void 0:_.phone)||"");if(!Ze(e)){Le([]),xt(!1);return}return De.current=setTimeout(async()=>{var l;const a=String(e),t=(l=Ge.current)==null?void 0:l.get(a);if(t&&Number.isFinite(t.ts)&&Date.now()-t.ts<=q){Le(Array.isArray(t.orders)?t.orders:[]),xt(!1);return}const s=++Ve.current;xt(!0);try{const o=`${API_BASE}/api/orders?search=${encodeURIComponent(e)}`,N=await window.KTM.api.getJSON(o,"L\u1ED7i t\u1EA3i l\u1ECBch s\u1EED \u0111\u01A1n theo S\u0110T");if(Ve.current!==s)return;const c=Array.isArray(N)?N:Array.isArray(N==null?void 0:N.orders)?N.orders:[];Le(c);try{const C=Ge.current;if(C&&typeof C.set=="function"&&(C.set(a,{ts:Date.now(),orders:c}),C.size>100)){const r=Array.from(C.entries()).sort((g,R)=>{var ee,V;return(Number((ee=g==null?void 0:g[1])==null?void 0:ee.ts)||0)-(Number((V=R==null?void 0:R[1])==null?void 0:V.ts)||0)}),d=Math.max(0,r.length-100);for(let g=0;g<d;g++)C.delete(r[g][0])}}catch(C){}}catch(o){if(Ve.current!==s)return;console.error("Phone history fetch error:",o),Le([])}finally{if(Ve.current!==s)return;xt(!1)}},T),()=>{De.current&&(clearTimeout(De.current),De.current=null)}},[ge,_==null?void 0:_.phone]),useEffect(()=>{Va()},[]),useEffect(()=>{Fe||Gt()},[E,Fe]),useEffect(()=>{fa()},[]),useEffect(()=>{A&&w.current!==A&&(w.current=A,ja(S))},[A]);const ua=e=>e==="draft"?"\u0110\u01A1n nh\xE1p":e==="pending"?"Ch\u1EDD x\u1EED l\xFD":e==="processing"?"\u0110ang v\u1EADn chuy\u1EC3n":e==="done"?"Ho\xE0n th\xE0nh":e==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":e==="cancelled"||e==="canceled"?"H\u1EE7y \u0111\u01A1n":e||"",pa=e=>e==="draft"?"bg-light text-dark":e==="pending"?"bg-secondary":e==="processing"?"bg-warning text-dark":e==="done"?"bg-success":e==="paid"?"bg-primary":e==="cancelled"||e==="canceled"?"bg-danger":"bg-light text-dark",_a=React.useMemo(()=>window.KTM.orders.sortOrders(ie),[ie]),ha=React.useMemo(()=>window.KTM.orders.sortOrders(_e),[_e]),ea=React.useMemo(()=>{const a=(Array.isArray(ha)?ha:[]).filter(t=>Kt(t));return a.sort((t,s)=>{const l=new Date(t==null?void 0:t.created_at).getTime(),o=new Date(s==null?void 0:s.created_at).getTime();return(Number.isFinite(l)?l:0)-(Number.isFinite(o)?o:0)}),a},[ha]),Ma=React.useMemo(()=>{const a=(Array.isArray(Se)?Se:[]).filter(t=>zt(t));return a.sort((t,s)=>{const l=new Date(t==null?void 0:t.created_at).getTime(),o=new Date(s==null?void 0:s.created_at).getTime();return(Number.isFinite(l)?l:0)-(Number.isFinite(o)?o:0)}),a},[Se]),Xt=React.useMemo(()=>u?ea:_a,[u,ea,_a]),ta=React.useMemo(()=>{if(u)return Xt;const e=String(Ne||"").trim();return e?(Array.isArray(Xt)?Xt:[]).filter(a=>String((a==null?void 0:a.status)||"").trim()===e):Xt},[Xt,Ne,u]),$a=React.useMemo(()=>window.KTM.orders.sortOrders(Ee),[Ee]),aa=React.useMemo(()=>Fe?$a:ta,[ta,Fe,$a]),ba=e=>window.KTM.date.formatDateTime(e),Va=async()=>{try{const e=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");se(Array.isArray(e)?e:[])}catch(e){console.error("Load products error:",e),se([])}},Gt=async()=>{xe(!0),be(!1);try{const a=new URLSearchParams;E&&a.set("month",String(E)),a.set("includeItems","0"),a.set("meta","1"),a.set("limit",String(pt)),a.set("offset","0");const t=`${API_BASE}/api/orders?${a.toString()}`,s=await window.KTM.api.getJSON(t,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),l=Array.isArray(s)?s:Array.isArray(s==null?void 0:s.orders)?s.orders:[],o=!Array.isArray(s)&&s&&typeof s=="object"&&s.meta||null;G(Array.isArray(l)?l:[]),P(Array.isArray(l)?l.length:0),de(!!(o!=null&&o.hasMore)),fa()}catch(a){console.error("Load orders error:",a),G([]),P(0),de(!1)}finally{xe(!1),be(!1)}},Ba=async()=>{if(!(re||U||Fe)&&ce){be(!0);try{const e=new URLSearchParams;E&&e.set("month",String(E)),e.set("includeItems","0"),e.set("meta","1"),e.set("limit",String(pt)),e.set("offset",String(x));const a=`${API_BASE}/api/orders?${e.toString()}`,t=await window.KTM.api.getJSON(a,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),s=Array.isArray(t)?t:Array.isArray(t==null?void 0:t.orders)?t.orders:[],l=!Array.isArray(t)&&t&&typeof t=="object"&&t.meta||null;G(o=>Ct(o,Array.isArray(s)?s:[])),P(o=>o+(Array.isArray(s)?s.length:0)),de(!!(l!=null&&l.hasMore))}catch(e){console.error("Load more orders error:",e)}finally{be(!1)}}},Ta=async e=>{var l;const a=Tt(e);if(!a){Oe([]),ze(""),je(!1);return}const t=Bt(a);if(a.length<vt&&t.length<it){Oe([]),ze(`Nh\u1EADp \xEDt nh\u1EA5t ${vt} k\xFD t\u1EF1 (ho\u1EB7c ${it} s\u1ED1) \u0111\u1EC3 search nhanh`),je(!1);return}try{const o=(l=bt.current)==null?void 0:l.get(a);if(o&&Number.isFinite(o.ts)&&Date.now()-o.ts<=he){Oe(Array.isArray(o.results)?o.results:[]),ze(""),je(!1);return}}catch(o){}const s=++at.current;je(!0),ze("");try{const o=`${API_BASE}/api/orders?search=${encodeURIComponent(a)}`,N=await window.KTM.api.getJSON(o,"L\u1ED7i search \u0111\u01A1n h\xE0ng");if(at.current!==s)return;const c=Array.isArray(N)?N:[];Oe(c);try{const C=bt.current;if(C&&typeof C.set=="function"&&(C.set(a,{ts:Date.now(),results:c}),C.size>st)){const r=Array.from(C.entries()).sort((g,R)=>{var ee,V;return(Number((ee=g==null?void 0:g[1])==null?void 0:ee.ts)||0)-(Number((V=R==null?void 0:R[1])==null?void 0:V.ts)||0)}),d=Math.max(0,r.length-st);for(let g=0;g<d;g++)C.delete(r[g][0])}}catch(C){}}catch(o){if(at.current!==s)return;console.error("Order search error:",o),Oe([]),ze((o==null?void 0:o.message)||"Search l\u1ED7i")}finally{if(at.current!==s)return;je(!1)}};useEffect(()=>{tt.current&&(clearTimeout(tt.current),tt.current=null);const e=Tt(Ie);if(!e){Oe([]),ze(""),je(!1);return}return u&&v(!1),tt.current=setTimeout(()=>{Ta(e)},X),()=>{tt.current&&(clearTimeout(tt.current),tt.current=null)}},[Ie]);const fa=async()=>{ue(!0),Ke(!0);try{const[e,a]=await Promise.all([window.KTM.api.getJSON(`${API_BASE}/api/orders?overdue=1&days=${encodeURIComponent(ae)}&includeItems=0`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),window.KTM.api.getJSON(`${API_BASE}/api/orders?draftExpiring=1&remainingDays=${encodeURIComponent(W)}&includeItems=0`,"L\u1ED7i t\u1EA3i \u0111\u01A1n nh\xE1p")]);le(Array.isArray(e)?e:[]),Ce(Array.isArray(a)?a:[])}catch(e){console.error("Load all orders error:",e),le([]),Ce([])}finally{ue(!1),Ke(!1)}},ga=async e=>{const a=await At(e);if(!a)return;me(a.id);const t=Array.isArray(a.items)&&a.items.length?a.items.map(c=>{var C,r,d,g;return{product_id:(c==null?void 0:c.product_id)||"",quantity:Number((C=c==null?void 0:c.quantity)!=null?C:1)||1,unit_price:(()=>{var V;const R=(V=c==null?void 0:c.unit_price)!=null?V:c==null?void 0:c.unitPrice,ee=R==null||R===""?NaN:Number(R);return Number.isFinite(ee)?Math.trunc(ee):null})(),variant:String((r=c==null?void 0:c.variant)!=null?r:"").trim(),variant_json:(g=(d=c==null?void 0:c.variant_json)!=null?d:c==null?void 0:c.variantJson)!=null?g:null}}).filter(c=>c.product_id):[{product_id:a.product_id||"",quantity:Number(a.quantity||1)||1,unit_price:null,variant:"",variant_json:null}],s=Q(a),l=fe(s),o=He(l),N=nt(l);Qe({customer_name:a.customer_name||"",phone:Ae(a.phone||""),address:a.address||"",note:(a==null?void 0:a.note)||"",items:t.length?t:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:s,adjustment_amount:o,adjustment_note:N||(a==null?void 0:a.adjustment_note)||"",status:a.status||"pending"}),ve(new Array(t.length?t.length:1).fill("")),yt(new Array(t.length?t.length:1).fill(!0)),te(null),k(!0),a.phone&&Jt(Ae(a.phone))};function ja(e){me(null),M(e||""),Ye(!1),yt([]),k(!0)}const va=()=>{m||F||(k(!1),me(null),M(""),Ye(!1),yt([]))},za=async()=>{var c,C,r;if(!oe||F||m)return;const e=(Array.isArray(ie)?ie:[]).find(d=>String(d==null?void 0:d.id)===String(oe))||null,a=String((e==null?void 0:e.status)||(_==null?void 0:_.status)||"").trim();if(a==="done"||a==="paid"||a==="canceled"){const d="Kh\xF4ng th\u1EC3 t\xE1ch: \u0111\u01A1n \u0111\xE3 ho\xE0n th\xE0nh/\u0111\xE3 nh\u1EADn ti\u1EC1n/\u0111\xE3 h\u1EE7y.";typeof D=="function"?D(d,"warning"):alert(d);return}const t=Ae(_.phone),l=(Array.isArray(_.items)?_.items:[]).map((d,g)=>{var R,ee;return{idx:g,product_id:String((d==null?void 0:d.product_id)||"").trim(),quantity:Number((R=d==null?void 0:d.quantity)!=null?R:0),variant:String((d==null?void 0:d.variant)||"").trim()||null,variant_json:(ee=d==null?void 0:d.variant_json)!=null?ee:null,unit_price:(()=>{const V=d==null?void 0:d.unit_price,$e=V===""||V==null?NaN:Number(V);if(Number.isFinite($e))return Math.max(0,Math.trunc($e));const Te=Rt(d==null?void 0:d.product_id),mt=d!=null&&d.variant_json&&typeof d.variant_json=="object"?d.variant_json:null;return sa(Te,mt)})()}}).filter(d=>d.product_id&&Number.isFinite(d.quantity)&&d.quantity>0);if(l.length<2){const d="C\u1EA7n \xEDt nh\u1EA5t 2 s\u1EA3n ph\u1EA9m \u0111\u1EC3 t\xE1ch \u0111\u01A1n.";typeof D=="function"?D(d,"warning"):alert(d);return}const o=[],N=[];for(const d of l){const g=!!Pt[d.idx],R={product_id:d.product_id,quantity:d.quantity,unit_price:d.unit_price,variant:d.variant,variant_json:d.variant_json};g?o.push(R):N.push(R)}if(!o.length||!N.length){const d="Ch\u1ECDn m\u1ED9t s\u1ED1 s\u1EA3n ph\u1EA9m \u201CGiao \u0111\u1EE3t 1\u201D, v\xE0 \u0111\u1EC3 l\u1EA1i \xEDt nh\u1EA5t 1 s\u1EA3n ph\u1EA9m \u201CCh\u1EDD h\xE0ng\u201D.";typeof D=="function"?D(d,"warning"):alert(d);return}Y(!0);try{const d=Array.isArray(_==null?void 0:_.adjustment_items)?_.adjustment_items:[],g=fe(d),R=He(g),ee=nt(g),V={customer_name:_.customer_name,phone:t,address:_.address,note:(_.note||"").trim(),adjustment_amount:R,adjustment_note:ee,adjustment_items:g,status:"processing",items:o,product_id:o[0].product_id,quantity:o[0].quantity,split_seq:1},$e=await window.KTM.api.postJSON(`${API_BASE}/api/orders`,V,"L\u1ED7i t\xE1ch \u0111\u01A1n (t\u1EA1o \u0111\u01A1n giao ngay)"),Te=(r=(C=$e==null?void 0:$e.id)!=null?C:(c=$e==null?void 0:$e.order)==null?void 0:c.id)!=null?r:null;if(!Te)throw new Error("T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i: kh\xF4ng nh\u1EADn \u0111\u01B0\u1EE3c ID \u0111\u01A1n giao ngay");const mt={id:oe,customer_name:_.customer_name,phone:t,address:_.address,note:(_.note||"").trim(),adjustment_amount:0,adjustment_note:"",adjustment_items:[],status:"pending",items:N,product_id:N[0].product_id,quantity:N[0].quantity,parent_order_id:String(Te),split_seq:2};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${oe}`,mt,"L\u1ED7i t\xE1ch \u0111\u01A1n (c\u1EADp nh\u1EADt ph\u1EA7n ch\u1EDD h\xE0ng)"),va(),Gt();const ht=Te?`\u0110\xE3 t\xE1ch \u0111\u01A1n. \u0110\u01A1n giao ngay: #${Te}`:"\u0110\xE3 t\xE1ch \u0111\u01A1n.";typeof D=="function"?D(ht,"success"):alert(ht)}catch(d){console.error(d);const g=(d==null?void 0:d.message)||"T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i";typeof D=="function"?D(g,"danger"):alert(g)}finally{Y(!1)}},Ja=e=>{if(!e)return"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --";const a=String(e),t=h.find(s=>String(s==null?void 0:s.id)===a);return t?`${t.name}${t.code?` (${t.code})`:""}`:"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"},Dt=e=>{try{return String(e!=null?e:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(a){return String(e!=null?e:"").toLowerCase()}},Ua=e=>{const t=Dt(e).trim().split(/\s+/).filter(Boolean),s=t.join(" ");return{contentTokens:t,cleanedQuery:s}},Oa=React.useMemo(()=>(Array.isArray(h)?h:[]).map((e,a)=>{var r,d,g,R,ee,V;const t=Dt((r=e==null?void 0:e.name)!=null?r:""),s=Dt((d=e==null?void 0:e.code)!=null?d:""),l=Dt((g=e==null?void 0:e.category)!=null?g:""),o=Dt((R=e==null?void 0:e.note)!=null?R:""),N=Dt((ee=e==null?void 0:e.id)!=null?ee:""),c=Dt((V=e==null?void 0:e.stt)!=null?V:""),C=`${t} ${s} ${l} ${o} ${N} ${c}`.trim();return{p:e,originalIndex:a,name:t,code:s,category:l,note:o,haystackAll:C}}),[h]),Ga=(e,a,t)=>{var g,R,ee,V,$e;const s=Array.isArray(a)?a:[],l=Dt(t).trim();if(!s.length&&!l)return 0;const o=(g=e==null?void 0:e.name)!=null?g:"",N=(R=e==null?void 0:e.code)!=null?R:"",c=(ee=e==null?void 0:e.category)!=null?ee:"",C=(V=e==null?void 0:e.note)!=null?V:"";if(!(($e=e==null?void 0:e.haystackAll)!=null?$e:""))return 0;let d=0;l&&(o===l&&(d+=220),o.includes(l)&&(d+=140),o.startsWith(l)&&(d+=160),N&&N===l&&(d+=180),N&&N.includes(l)&&(d+=90));for(const Te of s){if(!Te)continue;const mt=new RegExp(`(?:^|\\s)${Te.replace(/[.*+?^${}()|[\[\]\\]/g,"\\$&")}`);o.includes(Te)&&(d+=35),mt.test(o)&&(d+=25),N&&N.includes(Te)&&(d+=20),N&&mt.test(N)&&(d+=10),c&&c.includes(Te)&&(d+=12),C&&C.includes(Te)&&(d+=6)}return d>0&&o&&(d+=Math.max(0,10-Math.min(10,Math.floor(o.length/10)))),d},ya=(e,a)=>{const t=String(e||""),s=String(a||"");if(t===s)return 0;if(!t)return s.length;if(!s)return t.length;const l=t.length,o=s.length;if(o>l)return ya(s,t);let N=new Array(o+1),c=new Array(o+1);for(let C=0;C<=o;C++)N[C]=C;for(let C=1;C<=l;C++){c[0]=C;const r=t.charCodeAt(C-1);for(let g=1;g<=o;g++){const R=r===s.charCodeAt(g-1)?0:1;c[g]=Math.min(N[g]+1,c[g-1]+1,N[g-1]+R)}const d=N;N=c,c=d}return N[o]},Wa=(e,a)=>{const t=String(e||"").trim(),s=String(a||"");if(!t||!s)return!1;if(s.includes(t))return!0;const l=s.split(/\s+/).filter(Boolean);if(!l.length)return!1;const o=t.length<=4?1:2;for(const N of l)if(!(Math.abs(N.length-t.length)>o)&&ya(t,N)<=o)return!0;return!1},na=e=>{const a=Dt(e).replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim();return a?a.split(" ").filter(Boolean):[]},Xa=(e,a)=>{const t=Array.isArray(a)?a:[];if(!t.length)return 0;const s=na((e==null?void 0:e.name)||""),l=na((e==null?void 0:e.code)||""),o=na((e==null?void 0:e.category)||""),N=na((e==null?void 0:e.note)||""),c=(r,d,g)=>{const R=String(r||"").trim();if(!R||!d.length)return 0;const ee=R.length<=4?1:2;let V=1/0,$e=-1;for(let ht=0;ht<d.length;ht++){const Mt=d[ht];if(!Mt||Math.abs(Mt.length-R.length)>ee)continue;const We=ya(R,Mt);if(We<V&&(V=We,$e=ht,We===0))break}if(V===1/0||V>ee)return 0;let mt=Math.round(g*(V===0?1:V===1?.65:.45));return $e===0?mt+=Math.round(g*.25):$e===1&&(mt+=Math.round(g*.12)),mt};let C=0;for(const r of t){if(!r)continue;const d=c(r,s,180),g=c(r,l,120),R=c(r,o,60),ee=c(r,N,30);C+=Math.max(d,g,R,ee)}if(C>0){const r=((e==null?void 0:e.name)||"").length;C+=Math.max(0,60-Math.min(60,Math.floor(r/2)))}return C},Na=React.useRef(new Map);React.useEffect(()=>{Na.current=new Map},[h]);const Qa=e=>{var r,d;const a=String(jt[e]||"").trim();if(!a)return h;const{contentTokens:t,cleanedQuery:s}=Ua(a);if(t.length===0)return h;const l=Dt(a).trim(),o=Na.current.get(l);if(o)return o;const N=[];for(const g of Oa){const R=g.haystackAll;R&&t.some(ee=>R.includes(ee))&&N.push(g)}let c=N;if(c.length<8&&t.length>0){const g=[],R=new Set(c.map(ee=>{var V,$e;return String(($e=(V=ee.p)==null?void 0:V.id)!=null?$e:"")+":"+String(ee.originalIndex)}));for(const ee of Oa){const V=String((d=(r=ee.p)==null?void 0:r.id)!=null?d:"")+":"+String(ee.originalIndex);if(R.has(V))continue;const $e=ee.haystackAll;$e&&t.some(Te=>Wa(Te,$e))&&(g.push(ee),R.add(V))}g.length&&(c=c.concat(g))}const C=c.map(g=>({entry:g,score:Ga(g,t,s)})).map(g=>{if(g.score>0)return g;const R=Xa(g.entry,t);return R>0?{...g,score:R}:g}).filter(g=>g.score>0).sort((g,R)=>R.score!==g.score?R.score-g.score:g.entry.originalIndex-R.entry.originalIndex).slice(0,40).map(g=>g.entry.p);return Na.current.set(l,C),C},Rt=e=>{if(!e)return null;const a=String(e);return h.find(t=>String(t==null?void 0:t.id)===a)||null},Qt=e=>{if(e==null||e==="")return[];let a=e;if(typeof a=="string"){const t=a.trim();if(!t)return[];try{a=JSON.parse(t)}catch(s){return[]}}return Array.isArray(a)?a.map((t,s)=>{var N;if(!t||typeof t!="object")return null;const l=String((N=t.name)!=null?N:"").trim()||`Bi\u1EBFn th\u1EC3 ${s+1}`,o=(Array.isArray(t.options)?t.options:[]).map(c=>{var $e,Te,mt,ht,Mt,We,Lt;if(!c||typeof c!="object")return null;const C=String(($e=c.label)!=null?$e:"").trim();if(!C)return null;const r=(Mt=(ht=(mt=(Te=c.price)!=null?Te:c.priceValue)!=null?mt:c.unit_price)!=null?ht:c.unitPrice)!=null?Mt:null,d=r==null||r===""?NaN:typeof r=="number"?r:typeof r=="string"?L(r):Number(r),g=Number.isFinite(d)?Math.trunc(d):null,R=(Lt=(We=c.price_delta)!=null?We:c.priceDelta)!=null?Lt:null,ee=Number(R),V=Number.isFinite(ee)?Math.trunc(ee):0;return{label:C,price:g,price_delta:V}}).filter(Boolean);return{name:l,options:o}}).filter(Boolean):[]},rn=e=>{const a=Rt(e);return Qt(a==null?void 0:a.variants)},Ia=e=>{if(!e||typeof e!="object")return"";const a=[];for(const[t,s]of Object.entries(e)){const l=String(t||"").trim(),o=String(s||"").trim();!l||!o||a.push(`${l}: ${o}`)}return a.join(", ")},sa=(e,a)=>{const t=L(e==null?void 0:e.price),s=Qt(e==null?void 0:e.variants);if(!s.length||!a||typeof a!="object")return t;let l=t,o=!1;for(const N of s){const c=String((N==null?void 0:N.name)||"").trim(),C=String((a==null?void 0:a[c])||"").trim();if(!c||!C)continue;const r=(Array.isArray(N.options)?N.options:[]).find(V=>String((V==null?void 0:V.label)||"").trim()===C);if(!r)continue;const d=r==null?void 0:r.price,g=d==null||d===""?NaN:Number(d);if(Number.isFinite(g)){l=Math.max(0,Math.trunc(g)),o=!0;continue}const R=r==null?void 0:r.price_delta,ee=R==null||R===""?NaN:Number(R);Number.isFinite(ee)&&(l+=Math.trunc(ee))}return l},wa=e=>window.KTM.orders.getOrderItems(e),Ya=e=>window.KTM.orders.getOrderTotalQty(e),ia=e=>window.KTM.orders.getOrderProductSummary(e,Rt),xa=e=>window.KTM.orders.getOrderItemRows(e,Rt),Sa=e=>window.KTM.orders.getOrderAdjustmentMoney(e),ra=e=>window.KTM.orders.getOrderAdjustmentSummaryText(e),Za=e=>{const a=wa(e),t=xa(e),s=la(a),l=oa(a),o=l.fee,N=Sa(e),c=s+o+N,C=d=>{const g=Number(d)||0;return g>0?`+${I(g)}`:I(g)},r=[];if(e!=null&&e.customer_name&&r.push(`KH\xC1CH: ${e.customer_name}`),e!=null&&e.phone&&r.push(`S\u0110T: ${e.phone}`),e!=null&&e.address&&r.push(`\u0110\u1ECAA CH\u1EC8: ${e.address}`),((e==null?void 0:e.note)||"").trim()&&r.push(`GHI CH\xDA: ${(e.note||"").trim()}`),r.push(""),r.push("S\u1EA2N PH\u1EA8M:"),t.length)for(const d of t)r.push(`- ${d.name} (SL: ${d.qty})`);else{const d=ia(e);d&&d!=="\u2014"&&r.push(`- ${d}`)}r.push(""),r.push(`T\u1EA0M T\xCDNH: ${I(s)}`),l.found&&o!==0&&r.push(`SHIP: ${I(o)}`);{const d=window.KTM.orders.getOrderAdjustmentItems(e),g=(Array.isArray(d)?d:[]).map(V=>{var $e;return{amount:Number(($e=V==null?void 0:V.amount)!=null?$e:0)||0,note:String((V==null?void 0:V.note)||"").trim()}}).filter(V=>V.amount!==0||!!V.note),R=ra(e);if(N!==0||g.length>0||!!R)if(g.length===1){const V=g[0];r.push(`\u0110I\u1EC0U CH\u1EC8NH: ${C(N)}${V.note?` \u2014 ${V.note}`:""}`)}else{r.push(`\u0110I\u1EC0U CH\u1EC8NH: ${C(N)}${!g.length&&R?` \u2014 ${R}`:""}`);for(const V of g)r.push(`- ${C(V.amount)}${V.note?`: ${V.note}`:""}`)}}return r.push(`T\u1ED4NG: ${I(c)}`),r.filter(Boolean).join(`
`)},Da=async e=>{try{const a=await At(e),t=Za(a);await window.KTM.clipboard.writeText(t),typeof D=="function"?D("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng","success"):alert("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng")}catch(a){console.error(a),typeof D=="function"?D("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)","danger"):alert("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)")}},oa=e=>window.KTM.orders.getOrderShipInfo(e,Rt),la=e=>window.KTM.orders.getItemsSubtotal(e,Rt),ka=e=>{try{const a=e instanceof Date?e:new Date(e);if(!a||Number.isNaN(a.getTime()))return"";const t=a.getFullYear(),s=String(a.getMonth()+1).padStart(2,"0");return`${t}-${s}`}catch(a){return""}},Ca=()=>E?String(E):ka(new Date),Ra=e=>{const a=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),t=Ae((e==null?void 0:e.phone)||""),s=String((e==null?void 0:e.address)||"").trim().toLowerCase(),l=ye(e).amount,N=(Array.isArray(e==null?void 0:e.items)?e.items:[]).map(c=>{var C;return{product_id:String((c==null?void 0:c.product_id)||"").trim(),quantity:Number((C=c==null?void 0:c.quantity)!=null?C:0),variant:String((c==null?void 0:c.variant)||"").trim()}}).filter(c=>c.product_id&&Number.isFinite(c.quantity)&&c.quantity>0).sort((c,C)=>c.product_id<C.product_id?-1:c.product_id>C.product_id?1:c.variant<C.variant?-1:c.variant>C.variant?1:c.quantity-C.quantity);return JSON.stringify({name:a,phone:t,address:s,items:N,adj:l})},Ft=React.useMemo(()=>{const e=Ae((_==null?void 0:_.phone)||"");if(!e)return{count:0,orders:[],monthKey:Ca()};const a=Ca(),s=(Array.isArray(Be)?Be:[]).filter(l=>{if(!l||oe&&String(l.id)===String(oe)||Ae(l.phone||"")!==e)return!1;const o=ka(l.created_at);return o&&o===a}).sort((l,o)=>{const N=new Date(l.created_at).getTime(),c=new Date(o.created_at).getTime();return(Number.isFinite(c)?c:0)-(Number.isFinite(N)?N:0)});return{count:s.length,orders:s,monthKey:a}},[Be,_==null?void 0:_.phone,E,oe]),en=e=>{var c;const a=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),t=Ae((e==null?void 0:e.phone)||""),s=String((e==null?void 0:e.address)||"").trim().toLowerCase(),l=H((c=e==null?void 0:e.adjustment_amount)!=null?c:0),o=wa(e),N=(Array.isArray(o)?o:[]).map(C=>{var r;return{product_id:String((C==null?void 0:C.product_id)||"").trim(),quantity:Number((r=C==null?void 0:C.quantity)!=null?r:0),variant:String((C==null?void 0:C.variant)||"").trim()}}).filter(C=>C.product_id&&Number.isFinite(C.quantity)&&C.quantity>0).sort((C,r)=>C.product_id<r.product_id?-1:C.product_id>r.product_id?1:C.variant<r.variant?-1:C.variant>r.variant?1:C.quantity-r.quantity);return JSON.stringify({name:a,phone:t,address:s,items:N,adj:l})},La=React.useMemo(()=>{if(oe)return"";const e=Ae((_==null?void 0:_.phone)||"");if(!e)return"";const a=Ca(),t=Ra(_),s=Array.isArray(Be)?Be:[];for(const l of s){if(!l||oe&&String(l.id)===String(oe)||Ae(l.phone||"")!==e)continue;const o=ka(l.created_at);if(!o||o!==a)continue;const N=en(l);if(N&&N===t)return`\u0110\u01A1n n\xE0y gi\u1ED1ng 100% m\u1ED9t \u0111\u01A1n trong th\xE1ng ${a}${l!=null&&l.id?` (#${l.id})`:""}`}return""},[Be,_,E,oe]),Pa=e=>{var Mt;const a=[],t=[],s=String((e==null?void 0:e.customer_name)||"").trim(),l=Ae((e==null?void 0:e.phone)||""),o=String((e==null?void 0:e.address)||"").trim();s||a.push("Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng"),l||a.push("Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i"),l&&!Ze(l)&&a.push("S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)"),o||t.push("Thi\u1EBFu \u0111\u1ECBa ch\u1EC9");const c=(Array.isArray(e==null?void 0:e.items)?e.items:[]).filter(We=>We&&We.product_id);c.length===0&&a.push("Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m"),c.some(We=>{var Ut;const Lt=Number((Ut=We==null?void 0:We.quantity)!=null?Ut:0);return!Number.isFinite(Lt)||Lt<=0})&&a.push("S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0");const r=new Set;let d=!1;for(const We of c){const Lt=String(We.product_id||"").trim(),Ut=String((We==null?void 0:We.variant)||"").trim();if(!Lt)continue;const Pe=`${Lt}||${Ut}`;if(r.has(Pe)){d=!0;break}r.add(Pe)}d&&t.push("S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)");const g=la(c),R=oa(c),ee=R!=null&&R.found?Number((Mt=R==null?void 0:R.fee)!=null?Mt:0):0,V=Array.isArray(e==null?void 0:e.adjustment_items)?e.adjustment_items:[],$e=fe(V),Te=He($e),mt=$e.some(We=>(Number(We==null?void 0:We.amount)||0)!==0&&!String((We==null?void 0:We.note)||"").trim());R!=null&&R.found&&(ee>=2e5||g>0&&ee>g*.6)&&t.push(`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${I(ee)}`),mt&&t.push("C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh");const ht=Math.abs(Te);return(ht>=5e5||g>0&&ht>g*.5)&&Te!==0&&t.push(`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${I(Te)}`),{errors:a,warnings:t,canSubmit:a.length===0}},on=React.useMemo(()=>Pa(_),[_,h]),ft=React.useMemo(()=>{var Ut;const e=String((_==null?void 0:_.customer_name)||"").trim(),a=Ae((_==null?void 0:_.phone)||""),t=String((_==null?void 0:_.address)||"").trim(),s=Array.isArray(_==null?void 0:_.items)?_.items:[],l=new Map;for(const Pe of s){const Wt=String((Pe==null?void 0:Pe.product_id)||"").trim(),ca=String((Pe==null?void 0:Pe.variant)||"").trim();if(!Wt)continue;const da=`${Wt}||${ca}`;l.set(da,(l.get(da)||0)+1)}const o=s.map(Pe=>{var Fa;const Wt=String((Pe==null?void 0:Pe.product_id)||"").trim(),ca=Number((Fa=Pe==null?void 0:Pe.quantity)!=null?Fa:0),da=Wt?"":"Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m",tn=Number.isFinite(ca)&&ca>0?"":"S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0",an=String((Pe==null?void 0:Pe.variant)||"").trim(),nn=`${Wt}||${an}`,sn=Wt&&(l.get(nn)||0)>1?"S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)":"";return{productError:da,qtyError:tn,dupWarn:sn}}),N=s.filter(Pe=>Pe&&Pe.product_id),c=la(N),C=oa(N),r=C!=null&&C.found?Number((Ut=C==null?void 0:C.fee)!=null?Ut:0):0,d=Array.isArray(_==null?void 0:_.adjustment_items)?_.adjustment_items:[],g=fe(d),R=He(g),ee=g.some(Pe=>(Number(Pe==null?void 0:Pe.amount)||0)!==0&&!String((Pe==null?void 0:Pe.note)||"").trim()),V=Math.abs(R),$e=ee?"C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh":"",Te=R!==0&&(V>=5e5||c>0&&V>c*.5)?`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${I(R)}`:"",mt=C!=null&&C.found&&(r>=2e5||c>0&&r>c*.6)?`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${I(r)}`:"",ht=e?"":"Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng",Mt=a?Ze(a)?"":"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)":"Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",We=t?"":"Thi\u1EBFu \u0111\u1ECBa ch\u1EC9",Lt=!ht&&!Mt&&o.every(Pe=>!Pe.productError&&!Pe.qtyError);return{nameError:ht,phoneError:Mt,addressWarn:We,items:o,shipAbnormalWarn:mt,adjustmentNoteWarn:$e,adjustmentAbnormalWarn:Te,canSubmit:Lt}},[_,h]),Ka=async e=>{var N,c,C;const a=(e==null?void 0:e.mode)||"close",t=Pa(_);if(!t.canSubmit){const r=t.errors[0]||"Thi\u1EBFu d\u1EEF li\u1EC7u b\u1EAFt bu\u1ED9c";typeof D=="function"?D(r,"danger"):alert(r);return}if(!oe&&La){const r=`${La}

B\u1EA1n c\xF3 mu\u1ED1n ti\u1EBFp t\u1EE5c l\u01B0u kh\xF4ng?`;if(!window.confirm(r)){(Ft==null?void 0:Ft.count)>0&&Ye(!0),setTimeout(()=>{var R;const g=document.getElementById("order-phone-input");g&&typeof g.scrollIntoView=="function"&&(g.scrollIntoView({block:"center",behavior:"smooth"}),(R=g.focus)==null||R.call(g))},0);return}}const s=Ae(_.phone),o=(Array.isArray(_.items)?_.items:[]).map(r=>{var d,g;return{product_id:(r==null?void 0:r.product_id)||"",quantity:Number((d=r==null?void 0:r.quantity)!=null?d:1),variant:String((r==null?void 0:r.variant)||"").trim()||null,variant_json:(g=r==null?void 0:r.variant_json)!=null?g:null,unit_price:(()=>{const R=r==null?void 0:r.unit_price,ee=R===""||R==null?NaN:Number(R);if(Number.isFinite(ee))return Math.max(0,Math.trunc(ee));const V=Rt(r==null?void 0:r.product_id),$e=r!=null&&r.variant_json&&typeof r.variant_json=="object"?r.variant_json:null;return sa(V,$e)})()}}).filter(r=>r.product_id&&Number.isFinite(r.quantity)&&r.quantity>0);$(!0);try{const r=oe?`${API_BASE}/api/orders/${oe}`:`${API_BASE}/api/orders`,d=o[0],g=Array.isArray(_==null?void 0:_.adjustment_items)?_.adjustment_items:[],R=fe(g),ee=He(R),V=nt(R),$e={customer_name:_.customer_name,phone:s,address:_.address,note:(_.note||"").trim(),adjustment_amount:ee,adjustment_note:V,adjustment_items:R,product_id:d.product_id,quantity:d.quantity,status:_.status,items:o,...oe?{id:oe}:{}};if(oe)await window.KTM.api.putJSON(r,$e,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");else{const Te=await window.KTM.api.postJSON(r,$e,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");ut.current={id:(C=(c=Te==null?void 0:Te.id)!=null?c:(N=Te==null?void 0:Te.order)==null?void 0:N.id)!=null?C:null,fingerprint:Ra(_),ts:Date.now()}}ma(s,_.customer_name,_.address),a==="new"&&!oe?(M(""),me(null),k(!0)):(M(""),me(null),k(!1)),Gt()}catch(r){console.error(r),typeof D=="function"?D(r.message,"danger"):alert(r.message);return}finally{$(!1)}},Aa=e=>window.KTM.orders.getOrderTotalMoney(e,Rt),Ea=async e=>{if(confirm("X\xF3a \u0111\u01A1n h\xE0ng n\xE0y?")){b(e);try{await window.KTM.api.deleteJSON(`${API_BASE}/api/orders/${e}`,"L\u1ED7i x\xF3a \u0111\u01A1n h\xE0ng"),Gt(),fa()}catch(a){console.error(a),typeof D=="function"?D(a.message,"danger"):alert(a.message)}finally{b(null)}}},Vt=async(e,a)=>{var l;const t=await At(e),s=t==null?void 0:t.id;if(!(!s||!a)){O(s);try{const o=wa(t),N=(Array.isArray(o)?o:[]).map(r=>{var d,g;return{product_id:(r==null?void 0:r.product_id)||"",quantity:Number((d=r==null?void 0:r.quantity)!=null?d:1),variant:String((r==null?void 0:r.variant)||"").trim()||null,variant_json:(g=r==null?void 0:r.variant_json)!=null?g:null,unit_price:(()=>{var V;const R=(V=r==null?void 0:r.unit_price)!=null?V:r==null?void 0:r.unitPrice,ee=Number(R);return Number.isFinite(ee)?Math.max(0,Math.trunc(ee)):null})()}}).filter(r=>r.product_id&&Number.isFinite(r.quantity)&&r.quantity>0);if(!N.length)throw new Error("Kh\xF4ng th\u1EC3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i: \u0111\u01A1n kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m h\u1EE3p l\u1EC7");const c=N[0],C={id:s,customer_name:(t==null?void 0:t.customer_name)||"",phone:Ae((t==null?void 0:t.phone)||""),address:(t==null?void 0:t.address)||"",note:((t==null?void 0:t.note)||"").trim(),adjustment_amount:Number((l=t==null?void 0:t.adjustment_amount)!=null?l:0)||0,adjustment_note:(t==null?void 0:t.adjustment_note)||"",product_id:c.product_id,quantity:c.quantity,status:a,items:N};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${s}`,C,"L\u1ED7i c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i"),G(r=>Array.isArray(r)?r.map(d=>(d==null?void 0:d.id)===s?{...d,status:a}:d):r),le(r=>Array.isArray(r)?r.map(d=>(d==null?void 0:d.id)===s?{...d,status:a}:d):r),typeof D=="function"&&D("\u0110\xE3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i","success")}catch(o){console.error(o),typeof D=="function"?D(o.message,"danger"):alert(o.message)}finally{O(null)}}};return React.createElement("div",{className:"product-manager"},React.createElement(Loading,{show:re&&!ge&&!Fe||m||!!i||!!y}),React.createElement("div",{className:"product-header"},React.createElement("h5",null,"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"),React.createElement("button",{className:"btn btn-dark btn-sm",onClick:ja,disabled:m||!!i},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o \u0111\u01A1n")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-4"},React.createElement("label",{className:"form-label mb-1"},"L\u1ECDc theo th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:E,onChange:e=>z(e.target.value),"aria-label":"Ch\u1ECDn th\xE1ng",disabled:u||Fe}),E&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{z("")},title:"B\u1ECF l\u1ECDc","aria-label":"B\u1ECF l\u1ECDc",disabled:re||Fe},React.createElement("i",{className:"fas fa-times"})))),React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-filter"})),React.createElement("select",{className:"form-select",value:Ne,onChange:e=>Je(e.target.value),"aria-label":"L\u1ECDc theo tr\u1EA1ng th\xE1i",disabled:u||Fe},React.createElement("option",{value:""},"T\u1EA5t c\u1EA3"),React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n")),Ne&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>Je(""),title:"B\u1ECF l\u1ECDc tr\u1EA1ng th\xE1i","aria-label":"B\u1ECF l\u1ECDc tr\u1EA1ng th\xE1i",disabled:re||Fe},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"form-check mt-2"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"orders-overdue-only",checked:u,onChange:e=>{if(Fe)return;const a=!!e.target.checked;v(a),a&&Je("pending")},disabled:Fe}),React.createElement("label",{className:"form-check-label",htmlFor:"orders-overdue-only"},"Ch\u1EC9 hi\u1EC7n \u0111\u01A1n ch\u1EADm > ",ae," ng\xE0y (Ch\u1EDD x\u1EED l\xFD)"))),React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label mb-1"},"Search (t\xEAn / S\u0110T)"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-search"})),React.createElement("input",{type:"text",className:"form-control",value:Ie,onChange:e=>ke(e.target.value),placeholder:"Nh\u1EADp t\xEAn ho\u1EB7c S\u0110T...","aria-label":"Search \u0111\u01A1n h\xE0ng theo t\xEAn ho\u1EB7c S\u0110T"}),String(Ie||"").trim()&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>ke(""),title:"X\xF3a search","aria-label":"X\xF3a search",disabled:ct},React.createElement("i",{className:"fas fa-times"})),ct&&React.createElement("span",{className:"input-group-text",title:"\u0110ang search...","aria-label":"\u0110ang search"},React.createElement("span",{className:"spinner-border spinner-border-sm text-warning",role:"status","aria-hidden":"true"}))),React.createElement("div",{className:"text-muted small mt-1"},"Search s\u1EBD ra to\xE0n b\u1ED9 data, b\u1ECF qua filter")),React.createElement("div",{className:"col-12 col-md-2 d-flex gap-2 justify-content-md-end"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>Fe?Ta(Ie):Gt(),disabled:re||ct},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")))),React.createElement("div",{className:"card p-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},"Danh s\xE1ch \u0111\u01A1n h\xE0ng"),React.createElement("span",{className:"text-muted small"},Fe?`${aa.length} k\u1EBFt qu\u1EA3`:Ne?`${ta.length}/${ie.length} \u0111\u01A1n`:`${ie.length}${ce?"+":""} \u0111\u01A1n`)),Fe&&Xe&&React.createElement("div",{className:"alert alert-danger mt-3 mb-0",role:"alert"},Xe),ea.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"C\xF3 ",React.createElement("strong",null,ea.length)," \u0111\u01A1n ",React.createElement("strong",null,"Ch\u1EDD x\u1EED l\xFD")," qu\xE1 ",ae," ng\xE0y.",Ue&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{v(!0),Je("pending")}},"Xem ngay")),Ma.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-clock me-2"}),"C\xF3 ",React.createElement("strong",null,Ma.length)," \u0111\u01A1n ",React.createElement("strong",null,"Nh\xE1p")," s\u1EAFp t\u1EF1 x\xF3a (c\xF2n \u2264 ",W," ng\xE0y).",qe&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{v(!1),Je("draft"),z(""),Gt()}},"Xem ngay")),(Fe?ct:re)?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):(Fe?aa.length===0:ie.length===0)?React.createElement("div",{className:"text-center py-4 text-muted"},Fe?"Kh\xF4ng c\xF3 k\u1EBFt qu\u1EA3":"Ch\u01B0a c\xF3 \u0111\u01A1n h\xE0ng"):!Fe&&ta.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},"Kh\xF4ng c\xF3 \u0111\u01A1n ph\xF9 h\u1EE3p"):React.createElement(React.Fragment,null,React.createElement("div",{className:"d-md-none mt-3"},aa.map(e=>{var a;return React.createElement("div",{key:e.id,className:"card mb-2"},React.createElement("div",{className:"card-body p-3"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"flex-grow-1",style:{minWidth:0}},React.createElement("div",{className:"fw-semibold text-truncate"},e.customer_name),React.createElement("div",{className:"fw-bold font-monospace"},e.phone),Number((a=e==null?void 0:e.split_seq)!=null?a:0)>0&&React.createElement("div",{className:"text-muted small"},"\u0110\u1EE3t ",e.split_seq),e.address&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},e.address),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("div",{className:"d-flex align-items-start gap-1 flex-shrink-0"},React.createElement("span",{className:`badge ${pa(e.status)}`},ua(e.status)),Kt(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${ae} ng\xE0y`},"\u26A0 Ch\u1EADm ",St(e),"d"),zt(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 x\xF3a sau ${ne} ng\xE0y`},"\u23F3 C\xF2n ",Et(e),"d"))),React.createElement("div",{className:"mt-2 small"},React.createElement("div",null,React.createElement("div",{className:"text-muted"},"S\u1EA3n ph\u1EA9m:"),(()=>{const t=xa(e);return t.length?React.createElement("div",{className:"mt-1"},t.map((s,l)=>React.createElement("div",{key:l,className:"d-flex justify-content-between gap-2",style:{lineHeight:1.25}},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,whiteSpace:"normal",wordBreak:"break-word",flex:1}},React.createElement("span",{className:"text-muted me-1"},l+1,"."),s.name),React.createElement("div",{className:"text-muted small text-end text-nowrap",style:{flexShrink:0}},"x",s.qty,Number(s.unitPrice)>0?` \u2022 ${I(s.unitPrice)}`:"")))):React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},ia(e))})()),(Sa(e)!==0||ra(e))&&React.createElement("div",{style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh:")," ",React.createElement("span",{className:"fw-semibold"},I(Sa(e))),ra(e)?React.createElement("span",{className:"text-muted"}," ","(",ra(e),")"):null),React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng ti\u1EC1n"),React.createElement("span",{className:"fw-bold"},I(Aa(e)))),React.createElement("div",{className:"text-muted"},React.createElement("span",null,"Th\u1EDDi gian:")," ",ba(e.created_at))),React.createElement("div",{className:"mt-3 d-flex gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary flex-fill",onClick:()=>ga(e),disabled:m||!!i||y===e.id},"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary flex-fill",onClick:()=>Da(e),disabled:m||!!i||y===e.id},React.createElement("i",{className:"fas fa-copy me-1"}),"Copy"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger flex-fill",onClick:()=>Ea(e.id),disabled:m||i===e.id||y===e.id},i===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a")),React.createElement("div",{className:"mt-2 d-flex gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning flex-fill",onClick:()=>Vt(e,"processing"),disabled:m||!!i||y===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success flex-fill",onClick:()=>Vt(e,"done"),disabled:m||!!i||y===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary flex-fill",onClick:()=>Vt(e,"paid"),disabled:m||!!i||y===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger flex-fill",onClick:()=>Vt(e,"canceled"),disabled:m||!!i||y===e.id||e.status==="canceled",title:"H\u1EE7y \u0111\u01A1n"},"H\u1EE7y"))))})),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive orders-table-wrap mt-3"},React.createElement("table",{className:"table orders-table table-hover align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"SL"),React.createElement("th",null,"T\u1ED5ng ti\u1EC1n"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"),React.createElement("th",null,"Th\u1EDDi gian"),React.createElement("th",null))),React.createElement("tbody",null,aa.map(e=>React.createElement("tr",{key:e.id},React.createElement("td",null,React.createElement("div",{className:"fw-semibold"},e.customer_name),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("td",null,e.phone),React.createElement("td",null,(()=>{const a=xa(e);return a.length?React.createElement("div",{className:"d-grid gap-1"},a.map((t,s)=>React.createElement("div",{key:s,className:"small",style:{whiteSpace:"normal",wordBreak:"break-word",lineHeight:1.2}},React.createElement("span",{className:"text-muted me-1"},s+1,"."),React.createElement("span",{className:"fw-semibold"},t.name)," ",React.createElement("span",{className:"text-muted"},"x",t.qty),Number(t.unitPrice)>0&&React.createElement("span",{className:"text-muted"}," ","\u2022 ",I(t.unitPrice))))):ia(e)})()),React.createElement("td",null,Ya(e)),React.createElement("td",{className:"fw-semibold"},I(Aa(e))),React.createElement("td",null,React.createElement("div",{className:"d-flex align-items-center gap-1 flex-wrap"},React.createElement("span",{className:`badge ${pa(e.status)}`},ua(e.status)),Kt(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${ae} ng\xE0y`},"\u26A0 Ch\u1EADm ",St(e),"d"),zt(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 x\xF3a sau ${ne} ng\xE0y`},"\u23F3 C\xF2n ",Et(e),"d"))),React.createElement("td",null,ba(e.created_at)),React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-sm btn-primary me-1",onClick:()=>ga(e),disabled:m||!!i||y===e.id},"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary me-1",onClick:()=>Da(e),disabled:m||!!i||y===e.id},React.createElement("i",{className:"fas fa-copy"})),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning me-1",onClick:()=>Vt(e,"processing"),disabled:m||!!i||y===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success me-1",onClick:()=>Vt(e,"done"),disabled:m||!!i||y===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary me-1",onClick:()=>Vt(e,"paid"),disabled:m||!!i||y===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger me-1",onClick:()=>Vt(e,"canceled"),disabled:m||!!i||y===e.id||e.status==="canceled",title:"H\u1EE7y \u0111\u01A1n"},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>Ea(e.id),disabled:m||i===e.id},i===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a")))))))),!Fe&&ce&&!u&&React.createElement("div",{className:"d-flex justify-content-center mt-3"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:Ba,disabled:re||U},U?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2","aria-hidden":"true"}),"\u0110ang t\u1EA3i th\xEAm..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-angle-down me-2"}),"T\u1EA3i th\xEAm \u0111\u01A1n"))))),ge&&React.createElement("div",{className:"modal show d-block order-modal",style:{background:"rgba(0,0,0,0.6)"},role:"dialog","aria-modal":"true"},React.createElement("div",{className:"modal-dialog modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ffca2c)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark mb-0"},React.createElement("i",{className:"fas fa-receipt me-2"}),oe?"S\u1EEDa \u0111\u01A1n h\xE0ng":"T\u1EA1o \u0111\u01A1n h\xE0ng"),React.createElement("button",{type:"button",className:"btn-close",onClick:va})),React.createElement("form",{onSubmit:e=>{e.preventDefault(),Ka({mode:"close"})}},React.createElement("div",{className:"modal-body",ref:wt},React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"T\xEAn kh\xE1ch h\xE0ng *"),React.createElement("input",{className:"form-control",value:_.customer_name,onChange:e=>Qe({..._,customer_name:e.target.value}),placeholder:"Nh\u1EADp t\xEAn kh\xE1ch h\xE0ng",required:!0,style:{borderRadius:10,padding:12}}),!!ft.nameError&&React.createElement("div",{className:"form-text text-danger"},ft.nameError)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i *"),React.createElement("input",{className:"form-control",type:"tel",inputMode:"numeric",pattern:"[0-9+\\s-]*",id:"order-phone-input",value:_.phone,onChange:e=>Ha(e.target.value),onBlur:qa,placeholder:"Nh\u1EADp s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",required:!0,style:{borderRadius:10,padding:12}}),!!ft.phoneError&&React.createElement("div",{className:"form-text text-danger"},ft.phoneError),!ft.phoneError&&Ft.count>0&&React.createElement("div",{className:"form-text text-warning d-flex align-items-center justify-content-between gap-2"},React.createElement("span",null,"Kh\xE1ch n\xE0y \u0111\xE3 c\xF3 ",Ft.count," \u0111\u01A1n trong th\xE1ng ",Ft.monthKey,"."),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>Ye(e=>!e)},Re?"\u1EA8n l\u1ECBch s\u1EED":"Xem l\u1ECBch s\u1EED")),Re&&Ft.orders.length>0&&React.createElement("div",{className:"mt-2 border rounded-3 p-2",style:{background:"#fff"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between gap-2 mb-2"},React.createElement("div",{className:"small fw-semibold"},"L\u1ECBch s\u1EED \u0111\u01A1n (c\xF9ng th\xE1ng)"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>Ye(!1)},"\u1EA8n")),React.createElement("div",{className:"d-grid gap-2"},Ft.orders.slice(0,5).map(e=>React.createElement("div",{key:e.id,className:"d-flex align-items-start justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"small fw-semibold",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},"#",e.id," \u2022 ",React.createElement("span",{className:`badge ${pa(e.status)}`},ua(e.status))),React.createElement("div",{className:"text-muted small"},ba(e.created_at)," \u2022 ",I(Aa(e))),React.createElement("div",{className:"text-muted small",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},ia(e))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{confirm(`M\u1EDF \u0111\u01A1n #${e.id}? D\u1EEF li\u1EC7u \u0111ang nh\u1EADp s\u1EBD m\u1EA5t.`)&&ga(e)}},"M\u1EDF")))),Ft.orders.length>5&&React.createElement("div",{className:"text-muted small mt-2"},"Ch\u1EC9 hi\u1EC3n th\u1ECB 5 \u0111\u01A1n g\u1EA7n nh\u1EA5t.")),(K==null?void 0:K.status)==="loading"&&React.createElement("div",{className:"form-text"},"\u0110ang t\xECm kh\xE1ch theo S\u0110T..."),(K==null?void 0:K.status)==="found"&&React.createElement("div",{className:"form-text text-success"},"\u0110\xE3 c\xF3 kh\xE1ch, t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n th\xF4ng tin."),(K==null?void 0:K.status)==="not-found"&&React.createElement("div",{className:"form-text text-muted"},"Ch\u01B0a c\xF3 kh\xE1ch, s\u1EBD t\u1EA1o m\u1EDBi khi l\u01B0u \u0111\u01A1n."),(K==null?void 0:K.status)==="error"&&React.createElement("div",{className:"form-text text-danger"},"Kh\xF4ng tra \u0111\u01B0\u1EE3c kh\xE1ch (l\u1ED7i m\u1EA1ng/server).")),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("select",{className:"form-select",value:_.status,onChange:e=>Qe({..._,status:e.target.value}),style:{borderRadius:10,padding:12}},React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n"))),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("input",{className:"form-control",value:_.address,onChange:e=>Qe({..._,address:e.target.value}),placeholder:"Nh\u1EADp \u0111\u1ECBa ch\u1EC9 (kh\xF4ng b\u1EAFt bu\u1ED9c)",style:{borderRadius:10,padding:12}}),!!ft.addressWarn&&React.createElement("div",{className:"form-text text-warning"},ft.addressWarn)),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111\u01A1n h\xE0ng"),React.createElement("textarea",{className:"form-control",value:_.note,onChange:e=>Qe({..._,note:e.target.value}),placeholder:"V\xED d\u1EE5: Giao gi\u1EDD h\xE0nh ch\xEDnh / G\u1ECDi tr\u01B0\u1EDBc khi giao...",rows:2,style:{borderRadius:10,padding:12,resize:"vertical"}})),React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110i\u1EC1u ch\u1EC9nh gi\xE1 (th\xEAm/b\u1EDBt)"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{Qe(e=>({...e,adjustment_items:[...Array.isArray(e.adjustment_items)?e.adjustment_items:[{amount:"",note:""}],{amount:"",note:""}]}))}},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm \u0111i\u1EC1u ch\u1EC9nh")),React.createElement("div",{className:"d-grid gap-2"},J(_.adjustment_items).map((e,a)=>React.createElement("div",{key:a,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label small text-muted mb-1"},"S\u1ED1 ti\u1EC1n"),React.createElement("input",{type:"text",inputMode:"numeric",className:"form-control",value:e.amount,onChange:t=>{const s=t.target.value;Qe(l=>{const o=J(l.adjustment_items);return o[a]={...o[a],amount:s},{...l,adjustment_items:o}})},placeholder:"+500000 ho\u1EB7c -200000",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("label",{className:"form-label small text-muted mb-1"},"Ghi ch\xFA"),React.createElement("input",{className:"form-control",value:e.note,onChange:t=>{const s=t.target.value;Qe(l=>{const o=J(l.adjustment_items);return o[a]={...o[a],note:s},{...l,adjustment_items:o}})},placeholder:"V\xED d\u1EE5: th\xEAm van 1 tay / gi\u1EA3m gi\xE1...",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-1 d-flex"},React.createElement("button",{type:"button",className:"btn btn-outline-danger w-100",onClick:()=>{Qe(t=>{const s=J(t.adjustment_items);return s.splice(a,1),{...t,adjustment_items:s.length?s:[{amount:"",note:""}]}})},disabled:m||J(_.adjustment_items).length<=1,title:"X\xF3a \u0111i\u1EC1u ch\u1EC9nh",style:{borderRadius:10,padding:12}},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement("div",{className:"form-text"},"\xC2m = gi\u1EA3m gi\xE1, d\u01B0\u01A1ng = c\u1ED9ng th\xEAm."),!!ft.adjustmentAbnormalWarn&&React.createElement("div",{className:"form-text text-warning"},ft.adjustmentAbnormalWarn),!!ft.adjustmentNoteWarn&&React.createElement("div",{className:"form-text text-warning"},ft.adjustmentNoteWarn)),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1EA3n ph\u1EA9m *"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{Qe(e=>({...e,items:[...Array.isArray(e.items)?e.items:[],{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]})),ve(e=>[...Array.isArray(e)?e:[],""]),oe&&yt(e=>[...Array.isArray(e)?e:[],!0])},disabled:m},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(_.items)?_.items:[{product_id:"",quantity:1}]).map((e,a)=>React.createElement("div",{key:a,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"dropdown w-100",ref:t=>{$t.current[a]=t}},React.createElement("button",{type:"button",className:"form-control text-start d-flex align-items-center justify-content-between",style:{borderRadius:10,padding:12},onClick:()=>{dt(t=>t===a?null:a),setTimeout(()=>{const t=document.getElementById(`order-product-search-${a}`);t&&t.focus()},0)}},React.createElement("span",{className:e.product_id?"":"text-muted",style:{minWidth:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},Ja(e.product_id)),React.createElement("i",{className:"fas fa-chevron-down text-muted",style:{marginLeft:8,flexShrink:0}})),et===a&&React.createElement("div",{className:"dropdown-menu show w-100 p-2",style:{maxHeight:320,overflowY:"auto"}},React.createElement("input",{id:`order-product-search-${a}`,className:"form-control",value:jt[a]||"",onChange:t=>{const s=t.target.value;ve(l=>{const o=Array.isArray(l)?[...l]:[];return o[a]=s,o})},placeholder:"T\xECm theo t\xEAn / m\xE3...",style:{borderRadius:10,padding:10}}),React.createElement("div",{className:"mt-2"}),(()=>{const t=Qa(a);return t.length===0?React.createElement("div",{className:"text-muted small px-2 py-1"},"Kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p"):t.map(s=>React.createElement("button",{key:s.id,type:"button",className:"dropdown-item",onClick:()=>{const l=String(s.id),o=Qt(s==null?void 0:s.variants),N={};for(const r of o){const d=String((r==null?void 0:r.name)||"").trim(),g=Array.isArray(r==null?void 0:r.options)?r.options[0]:null,R=String((g==null?void 0:g.label)||"").trim();d&&R&&(N[d]=R)}const c=Ia(N),C=sa(s,N);Qe(r=>{const d=Array.isArray(r.items)?[...r.items]:[];return d[a]={...d[a]||{quantity:1},product_id:l,variant_json:Object.keys(N).length?N:null,variant:c,unit_price:o.length?C:null},{...r,items:d}}),dt(null)}},s.name,s.code?` (${s.code})`:""))})()),React.createElement("select",{className:"form-select",value:e.product_id,onChange:()=>{},required:!0,style:{position:"absolute",opacity:0,height:0,pointerEvents:"none"},tabIndex:-1,"aria-hidden":"true"},React.createElement("option",{value:""},"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"),h.map(t=>React.createElement("option",{key:t.id,value:t.id},t.name)))),(()=>{var s;const t=(s=ft.items)==null?void 0:s[a];return t?React.createElement(React.Fragment,null,!!t.productError&&React.createElement("div",{className:"form-text text-danger"},t.productError),!!t.dupWarn&&React.createElement("div",{className:"form-text text-warning"},t.dupWarn)):null})(),(()=>{if(!(e!=null&&e.product_id))return null;const t=Rt(e.product_id),s=Qt(t==null?void 0:t.variants);if(!s.length)return null;const l=e!=null&&e.variant_json&&typeof e.variant_json=="object"?e.variant_json:{};return React.createElement("div",{className:"mt-2 d-grid gap-2"},s.map((o,N)=>{const c=String((o==null?void 0:o.name)||`Bi\u1EBFn th\u1EC3 ${N+1}`).trim(),C=String((l==null?void 0:l[c])||"").trim();return React.createElement("div",{key:c},React.createElement("label",{className:"form-label small text-muted mb-1"},c),React.createElement("select",{className:"form-select",value:C,onChange:r=>{const d=String(r.target.value||"").trim();Qe(g=>{const R=Array.isArray(g.items)?[...g.items]:[],ee={...R[a]||{}},V=Rt(ee.product_id),$e=Qt(V==null?void 0:V.variants),Te=ee!=null&&ee.variant_json&&typeof ee.variant_json=="object"?{...ee.variant_json}:{};d?Te[c]=d:delete Te[c];const mt=Ia(Te),ht=sa(V,Te);return R[a]={...ee,variant_json:Object.keys(Te).length?Te:null,variant:mt,unit_price:ht},{...g,items:R}})},style:{borderRadius:10,padding:12}},React.createElement("option",{value:""},"-- ch\u1ECDn ",c," --"),(Array.isArray(o==null?void 0:o.options)?o.options:[]).map(r=>React.createElement("option",{key:r.label,value:r.label},r.label,Number.isFinite(Number(r==null?void 0:r.price))?` (${I(Number(r.price))})`:Number(r==null?void 0:r.price_delta)?` (${r.price_delta>0?"+":""}${r.price_delta})`:""))))}))})(),oe&&React.createElement("div",{className:"form-check mt-1"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:`order-split-deliver-${a}`,checked:!!Pt[a],onChange:t=>{const s=!!t.target.checked;yt(l=>{const o=Array.isArray(l)?[...l]:[],N=Array.isArray(_.items)?_.items.length:0;for(;o.length<N;)o.push(!0);return o[a]=s,o})},disabled:m||F}),React.createElement("label",{className:"form-check-label small text-muted",htmlFor:`order-split-deliver-${a}`},"Giao \u0111\u1EE3t 1"))),React.createElement("div",{className:"col-8 col-md-3"},React.createElement("input",{type:"number",className:"form-control",value:e.quantity,onChange:t=>{const s=t.target.value;Qe(l=>{const o=Array.isArray(l.items)?[...l.items]:[];return o[a]={...o[a]||{product_id:""},quantity:s},{...l,items:o}})},min:"1",style:{borderRadius:10,padding:12}}),(()=>{var s;const t=(s=ft.items)==null?void 0:s[a];return t&&t.qtyError?React.createElement("div",{className:"form-text text-danger"},t.qtyError):null})()),React.createElement("div",{className:"col-4 col-md-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>{Qe(t=>{const s=Array.isArray(t.items)?[...t.items]:[];return s.splice(a,1),{...t,items:s.length?s:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]}}),ve(t=>{const s=Array.isArray(t)?[...t]:[];return s.splice(a,1),s.length?s:[""]}),yt(t=>{const s=Array.isArray(t)?[...t]:[];return s.splice(a,1),s}),dt(t=>t==null?t:t===a?null:t>a?t-1:t)},disabled:m||F||(Array.isArray(_.items)?_.items.length:1)<=1,title:"X\xF3a s\u1EA3n ph\u1EA9m",style:{borderRadius:10,padding:10}},React.createElement("i",{className:"fas fa-trash"}))))))),(()=>{const a=(Array.isArray(_.items)?_.items:[]).filter(c=>c==null?void 0:c.product_id),t=la(a),s=oa(a),l=ye(_),o=l.amount,N=t+(s.found?s.fee:0)+o;return React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-column gap-1 small bg-light rounded-3 p-3"},React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1EA1m t\xEDnh"),React.createElement("span",{className:"fw-semibold"},I(t))),s.found&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"Ship"),React.createElement("span",{className:"fw-semibold"},I(s.fee))),!!ft.shipAbnormalWarn&&React.createElement("div",{className:"text-warning"},ft.shipAbnormalWarn),o!==0&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh"),React.createElement("span",{className:"fw-semibold"},I(o))),(_.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111\u01A1n: ",(_.note||"").trim()),!!l.summaryText&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh: ",l.summaryText),React.createElement("div",{className:"d-flex justify-content-between pt-1 border-top"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng"),React.createElement("span",{className:"fw-bold"},I(N)))))})())),React.createElement("div",{className:"modal-footer",style:{border:"none"}},React.createElement("button",{type:"button",className:"btn btn-light",onClick:va,disabled:m||F,style:{borderRadius:10}},"H\u1EE7y"),!!oe&&React.createElement("button",{type:"button",className:"btn btn-outline-primary fw-semibold",onClick:za,disabled:m||F,style:{borderRadius:10},title:"Ch\u1ECDn s\u1EA3n ph\u1EA9m giao \u0111\u1EE3t 1 v\xE0 t\xE1ch ph\u1EA7n c\xF2n l\u1EA1i sang \u0111\u01A1n ch\u1EDD h\xE0ng"},F?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang t\xE1ch..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-random me-2"}),"T\xE1ch \u0111\u01A1n giao ngay")),!oe&&React.createElement("button",{type:"button",className:"btn btn-outline-warning fw-semibold",onClick:()=>Ka({mode:"new"}),disabled:m||!ft.canSubmit,style:{borderRadius:10},title:"L\u01B0u xong gi\u1EEF form \u0111\u1EC3 t\u1EA1o \u0111\u01A1n m\u1EDBi"},React.createElement("i",{className:"fas fa-plus me-2"}),"L\u01B0u & t\u1EA1o \u0111\u01A1n m\u1EDBi"),React.createElement("button",{type:"submit",className:"btn btn-warning fw-semibold",disabled:m||F||!ft.canSubmit,style:{borderRadius:10,boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},m?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u"))))))))}

