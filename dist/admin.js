const{useState,useEffect,useRef}=React,CLOUDINARY_CLOUD_NAME="diwxfpt92",CLOUDINARY_UPLOAD_PRESET="ktm_unsigned",API_BASE="";function LoginPage({onLogin:$,error:k}){const[L,Y]=useState(""),[X,w]=useState(""),[E,ie]=useState(!1),[le,W]=useState(!1);return React.createElement("div",{className:"login-page"},React.createElement("div",{className:"login-box"},React.createElement("div",{className:"text-center mb-4"},React.createElement("i",{className:"fas fa-tractor fa-3x text-warning mb-3"}),React.createElement("h4",{className:"text-dark"},"KTM Admin"),React.createElement("p",{className:"text-muted small"},"\u0110\u0103ng nh\u1EADp \u0111\u1EC3 qu\u1EA3n l\xFD")),k&&React.createElement("div",{className:"alert alert-danger py-2 small"},React.createElement("i",{className:"fas fa-exclamation-circle me-2"}),k),React.createElement("form",{onSubmit:async Ne=>{Ne.preventDefault(),ie(!0),await $(L,X),ie(!1)}},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small"},"T\xEAn \u0111\u0103ng nh\u1EADp"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-user"})),React.createElement("input",{type:"text",className:"form-control",value:L,onChange:Ne=>Y(Ne.target.value),placeholder:"admin",required:!0,autoFocus:!0}))),React.createElement("div",{className:"mb-4"},React.createElement("label",{className:"form-label small"},"M\u1EADt kh\u1EA9u"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-lock"})),React.createElement("input",{type:le?"text":"password",className:"form-control",value:X,onChange:Ne=>w(Ne.target.value),placeholder:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",required:!0}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>W(!le)},React.createElement("i",{className:`fas fa-eye${le?"-slash":""}`})))),React.createElement("button",{type:"submit",className:"btn btn-warning w-100",disabled:E},E?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang \u0111\u0103ng nh\u1EADp..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-sign-in-alt me-2"}),"\u0110\u0103ng nh\u1EADp"))),React.createElement("div",{className:"text-center mt-4"},React.createElement("a",{href:"/",className:"text-muted small text-decoration-none"},React.createElement("i",{className:"fas fa-arrow-left me-1"}),"V\u1EC1 trang ch\u1EE7"))))}function Toast({message:$,type:k,onClose:L}){return useEffect(()=>{const Y=setTimeout(L,3e3);return()=>clearTimeout(Y)},[]),React.createElement("div",{className:`toast show align-items-center text-white bg-${k} border-0`,role:"alert"},React.createElement("div",{className:"d-flex"},React.createElement("div",{className:"toast-body"},$),React.createElement("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto",onClick:L})))}function Loading({show:$}){return $?React.createElement("div",{className:"loading-overlay"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"3rem",height:"3rem"}},React.createElement("span",{className:"visually-hidden"},"\u0110ang t\u1EA3i..."))):null}function Sidebar({activeMenu:$,onMenuChange:k,onLogout:L,currentUser:Y}){return React.createElement("div",{className:"sidebar d-none d-md-block"},React.createElement("div",{className:"logo"},React.createElement("i",{className:"fas fa-tractor me-2"})," KTM Admin"),React.createElement("nav",{className:"nav flex-column mt-3"},[{id:"search",icon:"fa-search",label:"Tra c\u1EE9u nhanh",highlight:!0},{id:"albums",icon:"fa-images",label:"Qu\u1EA3n l\xFD Album"},{id:"videos",icon:"fa-video",label:"Qu\u1EA3n l\xFD Video"},{id:"products",icon:"fa-box",label:"S\u1EA3n ph\u1EA9m"},{id:"orders",icon:"fa-receipt",label:"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"},{id:"stats",icon:"fa-chart-column",label:"Th\u1ED1ng k\xEA"},{id:"settings",icon:"fa-cog",label:"C\xE0i \u0111\u1EB7t"}].map(w=>React.createElement("a",{key:w.id,href:"#",className:`nav-link ${$===w.id?"active":""} ${w.disabled?"opacity-50":""} ${w.highlight?"text-warning":""}`,onClick:E=>{E.preventDefault(),w.disabled||k(w.id)}},React.createElement("i",{className:`fas ${w.icon}`})," ",w.label,w.disabled&&React.createElement("span",{className:"badge bg-secondary ms-2"},"Soon"),w.highlight&&React.createElement("span",{className:"badge bg-warning text-dark ms-2"},"HOT")))),React.createElement("div",{className:"position-absolute bottom-0 w-100 p-3 border-top border-secondary"},React.createElement("div",{className:"d-flex justify-content-between align-items-center"},React.createElement("a",{href:"/",className:"text-white-50 text-decoration-none small"},React.createElement("i",{className:"fas fa-home me-1"})," Trang ch\u1EE7"),L&&React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:L,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"})))))}const ADMIN_SETTINGS_STORAGE_KEY="ktm_admin_settings_v1",DEFAULT_SHIP_PERCENT=1.64;function normalizeShipPercent($){const k=typeof $=="number"?$:parseFloat(String($!=null?$:"").trim());return Number.isFinite(k)?Math.max(0,Math.min(100,k)):DEFAULT_SHIP_PERCENT}function loadAdminSettings(){var $;try{const k=localStorage.getItem(ADMIN_SETTINGS_STORAGE_KEY);if(!k)return{ship_percent:DEFAULT_SHIP_PERCENT};const L=JSON.parse(k);return{ship_percent:normalizeShipPercent(($=L==null?void 0:L.ship_percent)!=null?$:L==null?void 0:L.shipPercent)}}catch(k){return{ship_percent:DEFAULT_SHIP_PERCENT}}}function saveAdminSettings($){var k;try{const L={ship_percent:normalizeShipPercent((k=$==null?void 0:$.ship_percent)!=null?k:$==null?void 0:$.shipPercent)};return localStorage.setItem(ADMIN_SETTINGS_STORAGE_KEY,JSON.stringify(L)),L}catch(L){return{ship_percent:DEFAULT_SHIP_PERCENT}}}async function fetchAdminSettingsFromServer(){var k;const $=await window.KTM.api.getJSON(`${API_BASE}/api/settings`,"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t t\u1EEB DB");return{ship_percent:normalizeShipPercent((k=$==null?void 0:$.ship_percent)!=null?k:$==null?void 0:$.shipPercent)}}async function saveAdminSettingsToServer($){var Y,X,w;const k={ship_percent:normalizeShipPercent((Y=$==null?void 0:$.ship_percent)!=null?Y:$==null?void 0:$.shipPercent)},L=await window.KTM.api.putJSON(`${API_BASE}/api/settings`,k,"Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t v\xE0o DB");return{ship_percent:normalizeShipPercent((w=(X=L==null?void 0:L.ship_percent)!=null?X:L==null?void 0:L.shipPercent)!=null?w:k.ship_percent)}}function AlbumList({albums:$,onSelect:k,onCreate:L,onEdit:Y,onDelete:X,loading:w,currentFolder:E,onBack:ie,breadcrumb:le}){return React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},E&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:ie},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),E?E.title:"Th\u01B0 vi\u1EC7n \u1EA3nh")),React.createElement("button",{className:"btn btn-warning",onClick:L},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder")),le&&le.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:W=>{W.preventDefault(),ie("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),le.map((W,pe)=>React.createElement("li",{key:W.id,className:`breadcrumb-item ${pe===le.length-1?"active":""}`},pe===le.length-1?W.title:React.createElement("a",{href:"#",onClick:Ne=>{Ne.preventDefault(),ie(W)},className:"text-warning"},W.title))))),w?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):$.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},E?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder n\xE0o. H\xE3y t\u1EA1o folder \u0111\u1EA7u ti\xEAn!")):React.createElement("div",{className:"row g-3"},$.map(W=>React.createElement("div",{key:W.uuid||W.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card album-card h-100",onClick:()=>k(W)},W.cover?React.createElement("img",{src:W.cover,className:"album-cover",alt:W.title}):React.createElement("div",{className:"card-body text-center py-4"},React.createElement("i",{className:"fas fa-folder fa-3x text-warning mb-2"})),React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"card-title mb-1"},W.title),React.createElement("small",{className:"text-muted"},W.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),W.subfolderCount),W.subfolderCount>0&&W.count>0&&" \u2022 ",W.count>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-image me-1"}),W.count),W.subfolderCount===0&&W.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-2",onClick:pe=>{pe.stopPropagation(),Y(W)},title:"S\u1EEDa album"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:pe=>{pe.stopPropagation(),X(W)},title:"X\xF3a album"},React.createElement("i",{className:"fas fa-trash"}))))))))}function AlbumModal({show:$,album:k,onClose:L,onSave:Y,parentId:X}){const[w,E]=useState({slug:"",title:"",description:"",cover_url:"",parent_id:null}),[ie,le]=useState(!1),[W,pe]=useState(!1),Ne=useRef(null);useEffect(()=>{E(k?{slug:k.id||"",title:k.title||"",description:k.description||"",cover_url:k.cover||"",parent_id:k.parentId||null}:{slug:"",title:"",description:"",cover_url:"",parent_id:X||null})},[k,$,X]);const oe=async ce=>{ce.preventDefault(),le(!0),await Y(w),le(!1)},de=ce=>ce.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),fe=async ce=>{const be=ce.type==="image/heic"||ce.type==="image/heif"||/\.heic$/i.test(ce.name);if(ce.size<=2097152&&!be)return ce;try{const $e=await createImageBitmap(ce),Ae=document.createElement("canvas");let Re=$e.width,he=$e.height;const re=800;return(Re>re||he>re)&&(Re>he?(he=Math.round(he/Re*re),Re=re):(Re=Math.round(Re/he*re),he=re)),Ae.width=Re,Ae.height=he,Ae.getContext("2d").drawImage($e,0,0,Re,he),$e.close(),new Promise((je,_e)=>{Ae.toBlob(ke=>{ke?je(new File([ke],ce.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):_e(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch($e){throw console.error("Compress cover error:",$e),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},Me=async ce=>{var $e;const we=ce.target.files[0];if(!we)return;if(!(we.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(we.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}pe(!0);try{const Ae=await fe(we),Re=await window.KTM.cloudinary.uploadImage({file:Ae,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-albums/covers"});if(!Re.secure_url)throw console.error("Cloudinary error:",Re),new Error((($e=Re.error)==null?void 0:$e.message)||"Upload failed");E(he=>({...he,cover_url:Re.secure_url}))}catch(Ae){console.error("Cover upload error:",Ae),alert("L\u1ED7i upload \u1EA3nh b\xECa: "+Ae.message)}pe(!1),ce.target.value=""};return $?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},k?"S\u1EEDa":"T\u1EA1o"," Folder"),React.createElement("button",{type:"button",className:"btn-close",onClick:L})),React.createElement("form",{onSubmit:oe},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:w.title,onChange:ce=>E({...w,title:ce.target.value,slug:w.slug||de(ce.target.value)}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Slug (URL) *"),React.createElement("input",{type:"text",className:"form-control",value:w.slug,onChange:ce=>E({...w,slug:ce.target.value}),required:!0,disabled:!!k}),React.createElement("small",{className:"text-muted"},"VD: may-cay-kubota-l1501")),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:w.description,onChange:ce=>E({...w,description:ce.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex gap-2 align-items-start"},w.cover_url&&React.createElement("div",{className:"position-relative",style:{width:80,height:80}},React.createElement("img",{src:w.cover_url,alt:"Cover",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:8}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute",style:{top:-8,right:-8,padding:"2px 6px",fontSize:10},onClick:()=>E(ce=>({...ce,cover_url:""}))},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{ref:Ne,type:"file",accept:"image/*",className:"d-none",onChange:Me}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100 mb-2",onClick:()=>{var ce;return(ce=Ne.current)==null?void 0:ce.click()},disabled:W},W?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh b\xECa")),React.createElement("input",{type:"url",className:"form-control form-control-sm",value:w.cover_url,onChange:ce=>E({...w,cover_url:ce.target.value}),placeholder:"Ho\u1EB7c d\xE1n URL \u1EA3nh..."}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:L},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:ie||W},ie?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function FolderTreeItem({folder:$,allAlbums:k,currentAlbumId:L,targetAlbum:Y,onSelect:X,level:w=0}){const[E,ie]=useState(!0),le=$.uuid||$.id,W=le===L,pe=Y===le,Ne=k.filter(de=>de.parentId===le),oe=Ne.length>0;return React.createElement("div",{style:{marginLeft:w*16+"px"}},React.createElement("div",{className:`d-flex align-items-center p-2 rounded mb-1 ${pe?"bg-info text-white":W?"bg-light text-muted":"hover-bg"}`,style:{cursor:W?"not-allowed":"pointer",opacity:W?.5:1,transition:"background 0.2s"},onClick:()=>!W&&X(le)},oe&&React.createElement("i",{className:`fas fa-chevron-${E?"down":"right"} me-2`,style:{fontSize:"10px",width:"12px",cursor:"pointer"},onClick:de=>{de.stopPropagation(),ie(!E)}}),!oe&&React.createElement("span",{style:{width:"20px"}}),React.createElement("i",{className:`fas fa-folder${pe?"-open":""} me-2 ${pe?"":"text-warning"}`}),React.createElement("span",{className:"small"},$.title),W&&React.createElement("span",{className:"ms-2 badge bg-secondary",style:{fontSize:"9px"}},"Hi\u1EC7n t\u1EA1i"),$.count>0&&!W&&React.createElement("span",{className:"ms-auto badge bg-light text-muted",style:{fontSize:"10px"}},$.count)),E&&oe&&React.createElement("div",null,Ne.map(de=>React.createElement(FolderTreeItem,{key:de.uuid||de.id,folder:de,allAlbums:k,currentAlbumId:L,targetAlbum:Y,onSelect:X,level:w+1}))))}function AlbumDetail({album:$,onBack:k,onRefresh:L,showToast:Y,onNavigateToFolder:X,onEditSubfolder:w,parentAlbum:E}){const[ie,le]=useState([]),[W,pe]=useState([]),[Ne,oe]=useState(!0),[de,fe]=useState(!1),[Me,ce]=useState(""),[we,be]=useState([]),[$e,Ae]=useState([]),[Re,he]=useState({}),[re,Te]=useState(null),[je,_e]=useState(!1),[ke,Ue]=useState(""),[h,D]=useState(!1),i=useRef(null),b=useRef(null),[_,O]=useState(!1),[F,Q]=useState([]),[q,z]=useState([]),[me,Le]=useState(""),[d,v]=useState(!1),ve=async(f,R=2)=>{const T=R*1024*1024,Ke=f.type==="image/heic"||f.type==="image/heif"||/\.heic$/i.test(f.name);if(f.size<=T&&!Ke)return f;try{const We=await createImageBitmap(f),Qe=document.createElement("canvas");let tt=We.width,rt=We.height;const ot=1200;return(tt>ot||rt>ot)&&(tt>rt?(rt=Math.round(rt/tt*ot),tt=ot):(tt=Math.round(tt/rt*ot),rt=ot)),Qe.width=tt,Qe.height=rt,Qe.getContext("2d").drawImage(We,0,0,tt,rt),We.close(),new Promise((jt,vt)=>{Qe.toBlob(At=>{At?jt(new File([At],f.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):vt(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(We){throw console.error("Compress error:",We),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh")}};useEffect(()=>{C(),o()},[$.id,$.uuid]);const C=async()=>{oe(!0);try{const f=await window.KTM.api.getJSON(`${API_BASE}/api/albums/${$.uuid||$.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");le(f.images||[]);const R=await window.KTM.api.getJSON(`${API_BASE}/api/albums?parent_id=${$.uuid||$.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");pe(Array.isArray(R)?R:[])}catch(f){console.error(f),Y("L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u","danger")}oe(!1)},o=async()=>{try{const f=await window.KTM.api.getJSON(`${API_BASE}/api/albums`,"L\u1ED7i t\u1EA3i album");z(Array.isArray(f)?f:[])}catch(f){console.error("Error loading albums:",f)}},V=f=>{Q(R=>R.includes(f)?R.filter(T=>T!==f):[...R,f])},Oe=async()=>{if(!me||F.length===0){Y("Vui l\xF2ng ch\u1ECDn folder \u0111\xEDch","warning");return}v(!0);let f=0;for(const R of F)try{await window.KTM.api.putJSON(`${API_BASE}/api/images/${R}`,{album_id:me},"L\u1ED7i di chuy\u1EC3n \u1EA3nh"),f++}catch(T){console.error("Move error:",T)}v(!1),O(!1),Q([]),Le(""),f>0?(Y("\u0110\xE3 di chuy\u1EC3n \u1EA3nh th\xE0nh c\xF4ng!","success"),C(),L()):Y("Di chuy\u1EC3n th\u1EA5t b\u1EA1i","danger")},[Ge,Ve]=useState(!1),Pe=async()=>{if(F.length===0||!confirm(`X\xF3a ${F.length} \u1EA3nh \u0111\xE3 ch\u1ECDn? H\xE0nh \u0111\u1ED9ng n\xE0y kh\xF4ng th\u1EC3 ho\xE0n t\xE1c!`))return;Ve(!0);let f=0;for(const R of F)try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${R}`,"L\u1ED7i x\xF3a \u1EA3nh"),f++}catch(T){console.error("Delete error:",T)}Ve(!1),Q([]),f>0?(Y(`\u0110\xE3 x\xF3a ${f} \u1EA3nh!`,"success"),C(),L()):Y("X\xF3a th\u1EA5t b\u1EA1i","danger")},Ze=()=>{F.length===ie.length?Q([]):Q(ie.map(f=>f.id))},et=async()=>{if(ke.trim()){D(!0);try{const f=ke.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");await window.KTM.api.postJSON(`${API_BASE}/api/albums`,{slug:f+"-"+Date.now(),title:ke,parent_id:$.uuid||$.id},"L\u1ED7i t\u1EA1o folder"),Y("T\u1EA1o folder th\xE0nh c\xF4ng!","success"),Ue(""),_e(!1),C(),L()}catch(f){Y(f.message,"danger")}D(!1)}},Tt=async f=>{if(confirm(`X\xF3a folder "${f.title}"? T\u1EA5t c\u1EA3 n\u1ED9i dung b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${f.uuid||f.id}`,"L\u1ED7i x\xF3a folder"),Y("\u0110\xE3 x\xF3a folder","success"),C(),L()}catch(R){Y("L\u1ED7i x\xF3a folder","danger")}},De=f=>{const R=Array.from(f).filter(T=>T.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(T.name));be(T=>[...T,...R]),R.forEach(T=>{const Ke=new FileReader;Ke.onload=We=>{Ae(Qe=>[...Qe,{file:T,preview:We.target.result}])},Ke.readAsDataURL(T)})},St=f=>{be(R=>R.filter((T,Ke)=>Ke!==f)),Ae(R=>R.filter((T,Ke)=>Ke!==f))},Vt=async f=>{var T;const R=await window.KTM.cloudinary.uploadImage({file:f,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:`ktm-albums/${$.id}`});if(!R.secure_url)throw console.error("Cloudinary error:",R),new Error(((T=R.error)==null?void 0:T.message)||"Upload failed");return R},bt=async()=>{if(we.length===0)return;fe(!0);let f=0;for(let R=0;R<we.length;R++)try{ce(`\u0110ang x\u1EED l\xFD ${R+1}/${we.length}...`);const T=await ve(we[R],2);ce(`\u0110ang upload ${R+1}/${we.length}...`);const Ke=await Vt(T);await window.KTM.api.postJSON(`${API_BASE}/api/albums/${$.id}`,{url:Ke.secure_url,caption:Re[R]||we[R].name.replace(/\.[^/.]+$/,""),sort_order:ie.length+R},"L\u1ED7i l\u01B0u \u1EA3nh"),f++}catch(T){console.error("Upload error:",T)}fe(!1),ce(""),be([]),Ae([]),he({}),f>0?(Y(`\u0110\xE3 upload ${f} \u1EA3nh th\xE0nh c\xF4ng!`,"success"),C(),L()):Y("Upload th\u1EA5t b\u1EA1i","danger")},ge=async(f,R)=>{if(confirm("X\xF3a \u1EA3nh n\xE0y?"))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${f}`,"L\u1ED7i x\xF3a \u1EA3nh"),Y("\u0110\xE3 x\xF3a \u1EA3nh","success"),C(),L()}catch(T){Y("L\u1ED7i x\xF3a \u1EA3nh","danger")}},He=f=>{var R;f.preventDefault(),(R=b.current)==null||R.classList.add("dragover")},st=()=>{var f;(f=b.current)==null||f.classList.remove("dragover")},kt=f=>{var R;f.preventDefault(),(R=b.current)==null||R.classList.remove("dragover"),De(f.dataTransfer.files)};return React.createElement("div",null,React.createElement("div",{className:"d-flex align-items-center justify-content-between mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:k},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("h4",{className:"m-0"},$.title),React.createElement("small",{className:"text-muted"},W.length>0&&React.createElement("span",null,W.length," folder \u2022 "),ie.length," \u1EA3nh"))),React.createElement("button",{className:"btn btn-outline-warning btn-sm",onClick:()=>_e(!0)},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder con")),je&&React.createElement("div",{className:"card mb-4 border-warning"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder-plus me-2 text-warning"}),"T\u1EA1o folder con"),React.createElement("div",{className:"d-flex gap-2"},React.createElement("input",{type:"text",className:"form-control",placeholder:"T\xEAn folder...",value:ke,onChange:f=>Ue(f.target.value),onKeyPress:f=>f.key==="Enter"&&et(),autoFocus:!0}),React.createElement("button",{className:"btn btn-warning",onClick:et,disabled:h||!ke.trim()},h?React.createElement("span",{className:"spinner-border spinner-border-sm"}):"T\u1EA1o"),React.createElement("button",{className:"btn btn-secondary",onClick:()=>{_e(!1),Ue("")}},"H\u1EE7y")))),W.length>0&&React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),"Folder con"),React.createElement("div",{className:"row g-2"},W.map(f=>React.createElement("div",{key:f.uuid||f.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-item",style:{cursor:"pointer"},onClick:()=>X&&X(f)},React.createElement("div",{className:"card-body text-center py-3"},React.createElement("i",{className:"fas fa-folder fa-2x text-warning mb-2"}),React.createElement("div",{className:"small fw-bold text-truncate"},f.title),React.createElement("small",{className:"text-muted"},f.subfolderCount>0&&React.createElement("span",null,f.subfolderCount," folder"),f.subfolderCount>0&&f.count>0&&" \u2022 ",f.count>0&&React.createElement("span",null,f.count," \u1EA3nh"),f.subfolderCount===0&&f.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0 text-center"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-1",onClick:R=>{R.stopPropagation(),w&&w(f)},title:"S\u1EEDa folder"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:R=>{R.stopPropagation(),Tt(f)},title:"X\xF3a folder"},React.createElement("i",{className:"fas fa-trash"}))))))))),React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-cloud-upload-alt me-2"}),"Upload \u1EA3nh m\u1EDBi"),React.createElement("div",{ref:b,className:"upload-zone",onClick:()=>{var f;return(f=i.current)==null?void 0:f.click()},onDragOver:He,onDragLeave:st,onDrop:kt},React.createElement("i",{className:"fas fa-images fa-2x text-muted mb-2"}),React.createElement("p",{className:"mb-0"},"K\xE9o th\u1EA3 \u1EA3nh v\xE0o \u0111\xE2y ho\u1EB7c click \u0111\u1EC3 ch\u1ECDn"),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3 JPG, PNG, WebP"),React.createElement("input",{ref:i,type:"file",multiple:!0,accept:"image/*",onChange:f=>De(f.target.files)})),$e.length>0&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"upload-preview"},$e.map((f,R)=>React.createElement("div",{key:R,className:"upload-preview-item"},React.createElement("img",{src:f.preview,alt:""}),React.createElement("button",{className:"remove",onClick:()=>St(R)},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("div",{className:"mt-3"},React.createElement("button",{className:"btn btn-warning",onClick:bt,disabled:de},de?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),Me||"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload ",we.length," \u1EA3nh")))))),React.createElement("div",{className:"card"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("h6",{className:"m-0"},React.createElement("i",{className:"fas fa-th me-2"}),"\u1EA2nh (",ie.length,")"),ie.length>0&&React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:Ze},F.length===ie.length?"B\u1ECF ch\u1ECDn":"Ch\u1ECDn t\u1EA5t c\u1EA3")),F.length>0&&React.createElement("div",{className:"d-flex align-items-center gap-2 flex-wrap"},React.createElement("span",{className:"badge bg-primary"},F.length," \u0111\xE3 ch\u1ECDn"),React.createElement("button",{className:"btn btn-sm btn-info",onClick:()=>O(!0)},React.createElement("i",{className:"fas fa-folder-open me-1"}),"Di chuy\u1EC3n"),React.createElement("button",{className:"btn btn-sm btn-danger",onClick:Pe,disabled:Ge},Ge?React.createElement("span",{className:"spinner-border spinner-border-sm"}):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-trash me-1"}),"X\xF3a")),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>Q([])},React.createElement("i",{className:"fas fa-times"})))),Ne?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):ie.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},React.createElement("i",{className:"fas fa-image fa-2x mb-2"}),React.createElement("p",null,"Ch\u01B0a c\xF3 \u1EA3nh n\xE0o trong album n\xE0y")):React.createElement("div",{className:"image-grid"},ie.map((f,R)=>React.createElement("div",{key:R,className:`image-item ${F.includes(f.id)?"selected":""}`,style:{position:"relative",cursor:"pointer"},onClick:()=>V(f.id)},React.createElement("div",{className:"select-checkbox",style:{position:"absolute",top:"6px",left:"6px",zIndex:10,width:"24px",height:"24px",borderRadius:"4px",background:F.includes(f.id)?"#0d6efd":"rgba(255,255,255,0.9)",border:F.includes(f.id)?"none":"2px solid #ccc",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"}},F.includes(f.id)&&React.createElement("i",{className:"fas fa-check",style:{color:"#fff",fontSize:"12px"}})),React.createElement("img",{src:f.src,alt:f.caption,style:{opacity:F.includes(f.id)?.7:1,border:F.includes(f.id)?"3px solid #0d6efd":"none",borderRadius:"8px"}}),React.createElement("div",{className:"actions"},React.createElement("button",{className:"btn btn-sm btn-danger",onClick:T=>{T.stopPropagation(),ge(f.id,R)},title:"X\xF3a \u1EA3nh"},React.createElement("i",{className:"fas fa-trash"}))),f.caption&&React.createElement("div",{className:"p-2 bg-light small text-truncate"},f.caption)))))),_&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header bg-info text-white"},React.createElement("h5",{className:"modal-title"},React.createElement("i",{className:"fas fa-folder-open me-2"}),"Di chuy\u1EC3n ",F.length," \u1EA3nh"),React.createElement("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>O(!1)})),React.createElement("div",{className:"modal-body",style:{maxHeight:"400px",overflowY:"auto"}},React.createElement("p",{className:"text-muted small mb-3"},"Ch\u1ECDn th\u01B0 m\u1EE5c \u0111\xEDch:"),React.createElement("div",{className:"folder-tree"},q.filter(f=>!f.parentId).map(f=>React.createElement(FolderTreeItem,{key:f.uuid||f.id,folder:f,allAlbums:q,currentAlbumId:$.uuid||$.id,targetAlbum:me,onSelect:Le})))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>O(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-info",onClick:Oe,disabled:!me||d},d?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang chuy\u1EC3n..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-1"}),"Di chuy\u1EC3n \u0111\u1EBFn \u0111\xE2y")))))),re&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.9)"},onClick:()=>Te(null)},React.createElement("div",{className:"modal-dialog modal-fullscreen d-flex align-items-center justify-content-center"},React.createElement("div",{className:"position-relative",style:{maxWidth:"95vw",maxHeight:"95vh"}},React.createElement("button",{className:"btn btn-light position-absolute",style:{top:"-50px",right:"0",borderRadius:"50%",width:"40px",height:"40px"},onClick:()=>Te(null)},React.createElement("i",{className:"fas fa-times"})),React.createElement("img",{src:re.src,alt:re.caption,style:{maxWidth:"95vw",maxHeight:"90vh",objectFit:"contain"},onClick:f=>f.stopPropagation()}),re.caption&&React.createElement("div",{className:"text-white text-center mt-2"},re.caption)))))}function SearchCenter({showToast:$,onNavigate:k}){const[L,Y]=useState(""),[X,w]=useState([]),[E,ie]=useState([]),[le,W]=useState([]),[pe,Ne]=useState("all"),[oe,de]=useState(null),[fe,Me]=useState("list"),[ce,we]=useState(!0),[be,$e]=useState([]),[Ae,Re]=useState([]),he=useRef(null),[re,Te]=useState(!0),[je,_e]=useState(!1),ke=useRef(null),[Ue,h]=useState(!1),[D,i]=useState([{role:"assistant",content:`Xin ch\xE0o! H\xE3y h\u1ECFi t\xF4i v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3... V\xED d\u1EE5:
\u2022 "Gi\xE1 van 2 tay?"
\u2022 "Combo r\u1EBB nh\u1EA5t?"
\u2022 "Freeship?"`,attachments:[]}]),[b,_]=useState(""),[O,F]=useState(!1),Q=useRef(null),q=useRef(null),[z,me]=useState(null),[Le,d]=useState(!1),[v,ve]=useState(null),[C,o]=useState(!1),[V,Oe]=useState(!1),[Ge,Ve]=useState(null),[Pe,Ze]=useState({name:"",code:"",price:"",image:"",category:"",note:"",commission_percent:""}),et=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"],Tt=n=>{var y,x;n._type==="product"&&(ve(n),Ze({name:n.name||"",code:n.code||"",price:n.price||"",image:n.image||"",category:n.category||"",note:n.note||"",commission_percent:(x=(y=n.commission_percent)!=null?y:n.commissionPercent)!=null?x:""}),d(!0))},De=async()=>{if(v)try{await window.KTM.api.putJSON(`${API_BASE}/api/products?id=${v.id}`,Pe,"L\u1ED7i c\u1EADp nh\u1EADt"),$("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),d(!1),ve(null),He()}catch(n){$(n.message,"danger")}},St=async n=>{const y=n._type==="product"?"s\u1EA3n ph\u1EA9m":n._type==="album"?"\u1EA3nh":"video";if(confirm(`X\xF3a ${y} "${n.name}"?`))try{let x="";n._type==="product"?x=`${API_BASE}/api/products?id=${n.id}`:n._type==="album"?x=`${API_BASE}/api/images/${n.id}`:n._type==="video"&&(x=`${API_BASE}/api/videos/${n.id}`),await window.KTM.api.deleteJSON(x,"L\u1ED7i x\xF3a"),$(`\u0110\xE3 x\xF3a ${y}`,"success"),He()}catch(x){$(x.message,"danger")}},Vt=async n=>{try{const y=Ge?`${API_BASE}/api/products?id=${Ge.id}`:`${API_BASE}/api/products`;Ge?await window.KTM.api.putJSON(y,n,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(y,n,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),$(Ge?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Oe(!1),Ve(null),He()}catch(y){$(y.message,"danger")}},bt="ktm_admin_data_cache_v1",ge=1e3*60*10,He=async()=>{let n=null,y=!1;const x=window.KTM.cache.read(bt,{ttlMs:ge,validate:Array.isArray});x.hit?(n=x.value,console.log("[CACHE] Using cache, items:",n.length),ie(n),w(n),we(!1),y=!0):x.status==="miss"?console.log("[CACHE] No cache found"):x.status==="expired"||x.status==="invalid"?console.log("[CACHE] Cache expired or invalid"):x.status==="error"&&console.error("[CACHE] Error parsing cache"),y||we(!0);try{const B=async(ze,ue)=>{try{const qe=await window.KTM.api.getJSON(ze,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");return qe!=null?qe:ue}catch(qe){return ue}},[ee,j,m]=await Promise.all([B(`${API_BASE}/api/products`,[]),B(`${API_BASE}/api/albums`,[]),B(`${API_BASE}/api/video-folders?withVideos=true`,[])]),H=Array.isArray(ee)?ee.map(ze=>({...ze,_type:"product",_source:"database"})):[];$e(j);let se=[];Array.isArray(j)&&j.length>0&&(await Promise.all(j.map(ue=>B(`${API_BASE}/api/albums/${ue.id}`,{})))).forEach((ue,qe)=>{const pt=j[qe];ue.images&&ue.images.length>0&&ue.images.forEach(Xe=>{se.push({id:Xe.id,name:Xe.caption||"\u1EA2nh t\u1EEB "+pt.title,image:Xe.src,folder:pt.title,_type:"album",_source:"database"})})}),Re(m);let te=[];Array.isArray(m)&&m.forEach(ze=>{ze.videos&&ze.videos.forEach(ue=>{te.push({id:ue.id,name:ue.title,folder:ze.name,image:ue.thumb,youtubeId:ue.youtubeId,url:ue.url,_type:"video",_source:"database"})})});const A=[...H,...se,...te];(!n||JSON.stringify(A)!==JSON.stringify(n))&&(ie(A),w(A),window.KTM.cache.write(bt,A))}catch(B){console.error("Song song fetch error:",B)}we(!1)};useEffect(()=>{He(),setTimeout(()=>{var n;return(n=he.current)==null?void 0:n.focus()},100)},[]);const st=n=>{try{return String(n!=null?n:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(y){return String(n!=null?n:"").toLowerCase()}},kt=n=>{const x=st(n).trim().split(/\s+/).filter(Boolean),B=x.includes("anh"),ee=x.includes("video"),j=x.filter(se=>se!=="anh"&&se!=="video"),m=j.join(" "),H=new Set(["product"]);return B&&H.add("album"),ee&&H.add("video"),{allowedTypes:H,includeAlbum:B,includeVideo:ee,contentTokens:j,cleanedQuery:m}},f=(n,y,x)=>{var ze,ue,qe,pt,Xe;const B=Array.isArray(y)?y:[],ee=st(x).trim();if(!B.length&&!ee)return 0;const j=st((ze=n==null?void 0:n.name)!=null?ze:""),m=st((ue=n==null?void 0:n.code)!=null?ue:""),H=st((qe=n==null?void 0:n.category)!=null?qe:""),se=st((pt=n==null?void 0:n.note)!=null?pt:""),te=st((Xe=n==null?void 0:n.folder)!=null?Xe:"");if(!`${j} ${m} ${H} ${se} ${te}`.trim())return 0;let J=0;ee&&(j===ee&&(J+=220),j.includes(ee)&&(J+=140),j.startsWith(ee)&&(J+=160),m&&m===ee&&(J+=180),m&&m.includes(ee)&&(J+=90));for(const Ye of B){if(!Ye)continue;const dt=new RegExp(`(?:^|\\s)${Ye.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}`);j.includes(Ye)&&(J+=35),dt.test(j)&&(J+=25),m&&m.includes(Ye)&&(J+=20),m&&dt.test(m)&&(J+=10),H&&H.includes(Ye)&&(J+=12),te&&te.includes(Ye)&&(J+=12),se&&se.includes(Ye)&&(J+=6)}return J>0&&j&&(J+=Math.max(0,10-Math.min(10,Math.floor(j.length/10)))),J},R=(n,y,x)=>{const B=Array.isArray(n)?n:[];return B.length?B.map((j,m)=>({it:j,idx:m,score:f(j,y,x)})).sort((j,m)=>m.score!==j.score?m.score-j.score:j.idx-m.idx).map(j=>j.it):[]},T=async(n,y)=>{if(!(!re||y.length===0)){_e(!0);try{const x=y.map(ee=>({id:ee.id,name:ee.name,price:ee.price,category:ee.category,note:ee.note,folder:ee.folder,_type:ee._type})),B=await window.KTM.api.postJSON(`${API_BASE}/api/ai-search`,{query:n,products:x},"AI Search error");if(B&&B.matchedIds&&B.matchedIds.length>0){const{contentTokens:ee,cleanedQuery:j}=kt(n),m=new Set(B.matchedIds),H=y.filter(se=>m.has(se.id)).sort((se,te)=>f(te,ee,j)-f(se,ee,j));H.length>0&&w(H)}else B&&B.matchedIds&&B.matchedIds.length===0&&w([])}catch(x){console.error("AI Search error:",x)}_e(!1)}},Ke=n=>{if(Y(n),ke.current&&clearTimeout(ke.current),!n.trim()){We(pe);return}const{allowedTypes:y,contentTokens:x,cleanedQuery:B}=kt(n),ee=E.filter(m=>{if(!y.has(m==null?void 0:m._type))return!1;if(x.length===0)return!0;const H=st(Object.entries(m).filter(([se])=>!se.startsWith("_")).map(([,se])=>String(se||"")).join(" "));return x.some(se=>H.includes(se))});let j=ee;pe!=="all"&&(j=ee.filter(m=>(m.category||m._type)===pe)),w(R(j,x,B)),re&&B.length>=3&&(ke.current=setTimeout(()=>{T(B,j)},500))},We=n=>{Ne(n);const{allowedTypes:y,contentTokens:x}=kt(L),{cleanedQuery:B}=kt(L);let ee=E.filter(j=>y.has(j==null?void 0:j._type));n!=="all"&&(ee=ee.filter(j=>(j.category||j._type)===n)),L.trim()&&x.length>0&&(ee=ee.filter(j=>{const m=st(Object.entries(j).filter(([H])=>!H.startsWith("_")).map(([,H])=>String(H||"")).join(" "));return x.every(H=>m.includes(H))})),w(R(ee,x,B))},Qe=(n,y)=>{window.KTM.clipboard.writeText(n).then(()=>{de(y),$("\u0110\xE3 copy!","success"),setTimeout(()=>de(null),1500)})},tt=async(n,y)=>{try{await window.KTM.clipboard.writeImageFromUrl(n),de(y+"-img"),$("\u0110\xE3 copy \u1EA3nh!","success"),setTimeout(()=>de(null),1500)}catch(x){Qe(n,y+"-img")}},rt=n=>{let y=n.toLowerCase();const x=[],B=E.filter(m=>m._type==="product");if(y.includes("ty")||y.includes("xy lanh")){if(y.includes("gi\u1EEFa")||y.includes("giua")){const m=B.find(H=>{var se;return(se=H.name)==null?void 0:se.toLowerCase().includes("xy lanh gi\u1EEFa")});m&&!x.find(H=>H.id===m.id)&&x.push(m)}if(y.includes("nghi\xEAng")||y.includes("nghieng")){const m=B.find(H=>{var se;return(se=H.name)==null?void 0:se.toLowerCase().includes("xy lanh nghi\xEAng")});m&&!x.find(H=>H.id===m.id)&&x.push(m)}if(y.includes("\u1EE7i")||y.includes("ui")){const m=B.find(H=>{var se;return(se=H.name)==null?void 0:se.toLowerCase().includes("xy lanh \u1EE7i")});m&&!x.find(H=>H.id===m.id)&&x.push(m)}}const ee=y.match(/van\s*(\d+)\s*tay.*?(\d+)\s*ty/);if(ee){const m=ee[1],H=ee[2],se=B.find(te=>{var J;const A=((J=te.name)==null?void 0:J.toLowerCase())||"";return A.includes("combo")&&A.includes(`${m} tay`)&&(A.includes(`${H} xy`)||A.includes(`${H} xylanh`))});if(se&&!x.find(te=>te.id===se.id))x.push(se);else{const te=B.find(A=>{var ze;const J=((ze=A.name)==null?void 0:ze.toLowerCase())||"";return J.includes("combo")&&J.includes(`${m} tay`)});te&&!x.find(A=>A.id===te.id)&&x.push(te)}}if(y.includes("combo")&&!ee){const m=y.match(/combo.*?(\d+)\s*tay/);if(m){const H=m[1];B.filter(te=>{var J;const A=((J=te.name)==null?void 0:J.toLowerCase())||"";return A.includes("combo")&&A.includes(`${H} tay`)}).forEach(te=>{x.find(A=>A.id===te.id)||x.push(te)})}}const j=y.match(/van\s*(\d+)\s*tay/);if(j&&!y.includes("ty")&&!y.includes("combo")){const m=j[1],H=B.find(se=>{var A;const te=((A=se.name)==null?void 0:A.toLowerCase())||"";return te.includes(`van ${m} tay`)&&!te.includes("combo")});H&&!x.find(se=>se.id===H.id)&&x.push(H)}return x.slice(0,4)},ot=async n=>{if(!n.trim())return;const y={role:"user",content:n,attachments:[]};i(B=>[...B,y]),_(""),F(!0);const x=rt(n);setTimeout(()=>{var B;return(B=Q.current)==null?void 0:B.scrollIntoView({behavior:"smooth"})},100);try{const ee=E.filter(A=>A._type==="product").map(A=>{let J=`- ${A.name}`;return A.code&&(J+=` (M\xE3: ${A.code})`),A.price&&(J+=` - Gi\xE1: ${A.price.replace(/[đ\s]/g,"")}\u0111`),A.category&&(J+=` [${A.category}]`),A.note&&(J+=` (${A.note})`),J}).join(`
`),m=D.slice(-6).map(A=>`${A.role==="user"?"Kh\xE1ch":"AI"}: ${A.content}`).join(`
`),H=m?`L\u1ECACH S\u1EEC H\u1ED8I THO\u1EA0I:
${m}

DANH S\xC1CH S\u1EA2N PH\u1EA8M:
${ee}`:ee,te=(await window.KTM.api.postJSON(`${API_BASE}/api/ai-chat`,{message:n,context:H,audience:"admin"},"API error")).response||"Xin l\u1ED7i, t\xF4i kh\xF4ng th\u1EC3 tr\u1EA3 l\u1EDDi l\xFAc n\xE0y.";i(A=>[...A,{role:"assistant",content:te,attachments:x}])}catch(B){console.error("AI Error:",B);const ee=n.toLowerCase(),j=E.filter(H=>{const se=Object.values(H).join(" ").toLowerCase();return ee.split(" ").some(te=>se.includes(te))});let m="";j.length>0?(m=`T\xECm th\u1EA5y ${j.length} s\u1EA3n ph\u1EA9m li\xEAn quan:

`,j.slice(0,5).forEach(H=>{m+=`\u2022 ${H.name}`,H.price&&(m+=` - ${H.price.replace(/[đ\s]/g,"")}\u0111`),H.note&&(m+=` (${H.note})`),m+=`
`}),j.length>5&&(m+=`
...v\xE0 ${j.length-5} s\u1EA3n ph\u1EA9m kh\xE1c`)):m='Kh\xF4ng t\xECm th\u1EA5y s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p. H\xE3y th\u1EED t\u1EEB kh\xF3a kh\xE1c nh\u01B0 "van", "combo", "xy lanh"...',i(H=>[...H,{role:"assistant",content:m,attachments:j.slice(0,4)}])}F(!1),setTimeout(()=>{var B,ee;(B=Q.current)==null||B.scrollIntoView({behavior:"smooth"}),(ee=q.current)==null||ee.focus()},100)};function Rt({show:n,product:y,categories:x,onClose:B,onSave:ee}){const[j,m]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[H,se]=useState(!1),[te,A]=useState(!1),J=useRef(null),ze=I=>window.KTM.money.formatVNDInputDigits(I),ue=I=>{const M=window.KTM.money.getDigits(String(I!=null?I:"")),P=Number(M);return M&&Number.isFinite(P)?Math.trunc(P):0},qe=(I,M)=>{if(I==null||I==="")return[];let P=I;if(typeof P=="string"){const ae=P.trim();if(!ae)return[];try{P=JSON.parse(ae)}catch(G){return[]}}if(!Array.isArray(P))return[];const U=ue(M);return P.map(ae=>{var Ce;if(!ae||typeof ae!="object")return null;const G=String((Ce=ae.name)!=null?Ce:"").trim(),ye=(Array.isArray(ae.options)?ae.options:[]).map(Fe=>{var ht,Ct,gt,Nt,Ht,wt,Wt;if(!Fe||typeof Fe!="object")return null;const Je=String((ht=Fe.label)!=null?ht:"").trim();if(!Je)return null;const at=(Ht=(Nt=(gt=(Ct=Fe.price)!=null?Ct:Fe.priceValue)!=null?gt:Fe.unit_price)!=null?Nt:Fe.unitPrice)!=null?Ht:null,mt=Number(at);let ft=Number.isFinite(mt)?Math.trunc(mt):null;if(ft==null){const Xt=(Wt=(wt=Fe.price_delta)!=null?wt:Fe.priceDelta)!=null?Wt:null,Jt=Number(Xt);Number.isFinite(Jt)&&(ft=U+Math.trunc(Jt))}ft==null&&(ft=U);const ut=String(Math.max(0,Math.trunc(Number(ft)||0)));return{label:Je,price:Math.max(0,Math.trunc(Number(ft)||0)),priceDigits:ut}}).filter(Boolean);return{name:G||"Bi\u1EBFn th\u1EC3",options:ye}}).filter(Boolean)},pt=I=>{if(I==null||I==="")return[];let M=I;if(typeof M=="string"){const P=M.trim();if(!P)return[];try{M=JSON.parse(P)}catch(U){return[]}}return M&&typeof M=="object"&&!Array.isArray(M)&&(M=Object.entries(M).map(([P,U])=>({key:P,value:U}))),Array.isArray(M)?M.map(P=>{var ye,Ce,Fe,Je,at;if(!P||typeof P!="object")return null;const U=String((Fe=(Ce=(ye=P.key)!=null?ye:P.name)!=null?Ce:P.label)!=null?Fe:"").trim(),ae=String((Je=P.value)!=null?Je:"").trim(),G=String((at=P.unit)!=null?at:"").trim();return U?{key:U,value:ae,unit:G}:null}).filter(Boolean):[]};useEffect(()=>{var I,M;if(y)if(m({name:y.name||"",code:y.code||"",price:y.price||"",image:y.image||"",category:y.category||"",note:y.note||"",sort_order:y.sort_order||0,commission_percent:(M=(I=y.commission_percent)!=null?I:y.commissionPercent)!=null?M:5,variants:qe(y.variants,y.price),attributes:pt(y.attributes)}),y.price){const P=window.KTM.money.getDigits(y.price);lt(P),m(U=>({...U,price:ze(P)}))}else lt("");else m({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),lt("")},[y,n]);const Xe=I=>{m(M=>{var ye;const P=ue(M.price),U=String(P),ae=Array.isArray(M.variants)?[...M.variants]:[],G={...ae[I]||{},options:Array.isArray((ye=ae[I])==null?void 0:ye.options)?[...ae[I].options]:[]};return G.options=G.options.map(Ce=>({label:String((Ce==null?void 0:Ce.label)||""),price:P,priceDigits:U})),ae[I]=G,{...M,variants:ae}})},Ye=()=>{m(I=>{const M=ue(I.price),P=String(M),ae=(Array.isArray(I.variants)?[...I.variants]:[]).map(G=>{const ye=(Array.isArray(G==null?void 0:G.options)?G.options:[]).map(Ce=>({label:String((Ce==null?void 0:Ce.label)||""),price:M,priceDigits:P}));return{name:String((G==null?void 0:G.name)||"Bi\u1EBFn th\u1EC3"),options:ye}});return{...I,variants:ae}})},[dt,Kt]=React.useState(""),[Bt,lt]=React.useState(""),Ee=I=>{const M=window.KTM.money.nextPriceInputState(I.target.value,Bt);lt(M.digits),m({...j,price:M.price})},Gt=async(I,M=2)=>{const P=M*1024*1024;if(I.size<=P)return I;try{const U=await createImageBitmap(I),ae=document.createElement("canvas");let G=U.width,ye=U.height;const Ce=1200;return(G>Ce||ye>Ce)&&(G>ye?(ye=Math.round(ye/G*Ce),G=Ce):(G=Math.round(G/ye*Ce),ye=Ce)),ae.width=G,ae.height=ye,ae.getContext("2d").drawImage(U,0,0,G,ye),U.close(),new Promise((Je,at)=>{ae.toBlob(mt=>{mt?Je(new File([mt],I.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):at(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(U){throw console.error("Compress error:",U),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},Et=async I=>{var U;const M=I.target.files[0];if(!M)return;if(!(M.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp)$/i.test(M.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}A(!0);try{const ae=await Gt(M),G=await window.KTM.cloudinary.uploadImage({file:ae,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-products"});if(!G.secure_url)throw console.error("Cloudinary error:",G),new Error(((U=G.error)==null?void 0:U.message)||"Upload failed");m(ye=>({...ye,image:G.secure_url}))}catch(ae){console.error("Upload error:",ae),alert("L\u1ED7i upload \u1EA3nh: "+ae.message)}A(!1),I.target.value=""},Ft=async I=>{I.preventDefault(),se(!0);const M={...j,variants:qe(j.variants,j.price),attributes:pt(j.attributes)};await ee(M),se(!1)};return n?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-lg"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,border:"none",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark"},React.createElement("i",{className:"fas fa-box me-2"}),y?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:B})),React.createElement("form",{onSubmit:Ft},React.createElement("div",{className:"modal-body",style:{maxHeight:"70vh",overflowY:"auto"}},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-8"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-tag me-1"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:j.name,onChange:I=>m({...j,name:I.target.value}),placeholder:"V\xED d\u1EE5: Xy lanh nghi\xEAng KTM",required:!0,style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-hashtag me-1"}),"M\xE3 s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:j.code,onChange:I=>m({...j,code:I.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1"}),"Gi\xE1 b\xE1n"),React.createElement("input",{type:"text",className:"form-control",value:j.price,onChange:Ee,placeholder:"1.950.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3 mt-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-percent me-1"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:j.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:I=>m({...j,commission_percent:I.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-list me-1"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:j.category,onChange:I=>m({...j,category:I.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),x.map(I=>React.createElement("option",{key:I,value:I},I)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1"}),"Ghi ch\xFA"),React.createElement("textarea",{className:"form-control",rows:"2",value:j.note,onChange:I=>m({...j,note:I.target.value}),placeholder:"V\xED d\u1EE5: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(j.attributes)?j.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(j.attributes)?j.attributes:[]).map((I,M)=>React.createElement("div",{key:M,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(I==null?void 0:I.key)||"",onChange:P=>{const U=P.target.value;m(ae=>{const G=Array.isArray(ae.attributes)?[...ae.attributes]:[];return G[M]={...G[M]||{},key:U},{...ae,attributes:G}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(I==null?void 0:I.value)||"",onChange:P=>{const U=P.target.value;m(ae=>{const G=Array.isArray(ae.attributes)?[...ae.attributes]:[];return G[M]={...G[M]||{},value:U},{...ae,attributes:G}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(I==null?void 0:I.unit)||"",onChange:P=>{const U=P.target.value;m(ae=>{const G=Array.isArray(ae.attributes)?[...ae.attributes]:[];return G[M]={...G[M]||{},unit:U},{...ae,attributes:G}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{m(P=>{const U=Array.isArray(P.attributes)?[...P.attributes]:[];return U.splice(M,1),{...P,attributes:U}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{m(I=>{const M=Array.isArray(I.attributes)?[...I.attributes]:[];return M.push({key:"",value:"",unit:""}),{...I,attributes:M}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(j.variants)?j.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3. C\xF3 th\u1EC3 th\xEAm (v\xED d\u1EE5 Size: S/M/L)."):null,(Array.isArray(j.variants)?j.variants:[]).map((I,M)=>React.createElement("div",{key:M,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(I==null?void 0:I.name)||"",onChange:P=>{const U=P.target.value;m(ae=>{var ye;const G=Array.isArray(ae.variants)?[...ae.variants]:[];return G[M]={...G[M]||{},name:U,options:Array.isArray((ye=G[M])==null?void 0:ye.options)?G[M].options:[]},{...ae,variants:G}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>Xe(M),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(I==null?void 0:I.options)||I.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{m(P=>{const U=Array.isArray(P.variants)?[...P.variants]:[];return U.splice(M,1),{...P,variants:U}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(I==null?void 0:I.options)?I.options:[]).map((P,U)=>{var ae,G;return React.createElement("div",{key:U,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(P==null?void 0:P.label)||"",onChange:ye=>{const Ce=ye.target.value;m(Fe=>{var ut,ht,Ct,gt,Nt;const Je=Array.isArray(Fe.variants)?[...Fe.variants]:[],at={...Je[M]||{},options:Array.isArray((ut=Je[M])==null?void 0:ut.options)?[...Je[M].options]:[]},mt=Number((Ct=(ht=at.options[U])==null?void 0:ht.price)!=null?Ct:0)||0,ft=String((Nt=(gt=at.options[U])==null?void 0:gt.priceDigits)!=null?Nt:Math.max(0,Math.trunc(mt)));return at.options[U]={...at.options[U]||{},label:Ce,price:Math.max(0,Math.trunc(mt)),priceDigits:ft},Je[M]=at,{...Fe,variants:Je}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:ze(String((G=P==null?void 0:P.priceDigits)!=null?G:window.KTM.money.getDigits(String((ae=P==null?void 0:P.price)!=null?ae:"")))),onChange:ye=>{m(Ce=>{var Ct,gt,Nt,Ht,wt;const Fe=String((gt=P==null?void 0:P.priceDigits)!=null?gt:window.KTM.money.getDigits(String((Ct=P==null?void 0:P.price)!=null?Ct:""))),Je=window.KTM.money.nextPriceInputState(ye.target.value,Fe),at=String((Nt=Je.digits)!=null?Nt:""),mt=Number(at),ft=Number.isFinite(mt)?Math.max(0,Math.trunc(mt)):0,ut=Array.isArray(Ce.variants)?[...Ce.variants]:[],ht={...ut[M]||{},options:Array.isArray((Ht=ut[M])==null?void 0:Ht.options)?[...ut[M].options]:[]};return ht.options[U]={...ht.options[U]||{},label:String(((wt=ht.options[U])==null?void 0:wt.label)||""),price:ft,priceDigits:at},ut[M]=ht,{...Ce,variants:ut}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{m(ye=>{var Je;const Ce=Array.isArray(ye.variants)?[...ye.variants]:[],Fe={...Ce[M]||{},options:Array.isArray((Je=Ce[M])==null?void 0:Je.options)?[...Ce[M].options]:[]};return Fe.options.splice(U,1),Ce[M]=Fe,{...ye,variants:Ce}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{m(P=>{var ye;const U=Array.isArray(P.variants)?[...P.variants]:[],ae={...U[M]||{},options:Array.isArray((ye=U[M])==null?void 0:ye.options)?[...U[M].options]:[]},G=ue(P.price);return ae.options.push({label:"",price:G,priceDigits:String(G)}),U[M]=ae,{...P,variants:U}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{m(I=>{const M=ue(I.price),P=Array.isArray(I.variants)?[...I.variants]:[],U=String(M);return P.push({name:"Size",options:[{label:"S",price:M,priceDigits:U},{label:"M",price:M,priceDigits:U},{label:"L",price:M,priceDigits:U}]}),{...I,variants:P}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:Ye,disabled:!Array.isArray(j.variants)||j.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111.")))),React.createElement("div",{className:"col-md-4"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-image me-1"}),"\u1EA2nh s\u1EA3n ph\u1EA9m"),React.createElement("div",{className:"mb-2"},j.image?React.createElement(React.Fragment,null,React.createElement("img",{src:j.image,alt:"Product",style:{width:"100%",height:150,objectFit:"cover",borderRadius:"12px",border:"2px solid #e9ecef"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger mt-2",onClick:()=>m({...j,image:""}),style:{borderRadius:"20px",fontSize:"0.75rem"}},React.createElement("i",{className:"fas fa-times me-1"}),"X\xF3a \u1EA3nh")):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:"100%",height:150,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd",cursor:"pointer"},onClick:()=>{var I;return(I=J.current)==null?void 0:I.click()}},React.createElement("div",{className:"text-center"},React.createElement("i",{className:"fas fa-cloud-upload-alt fa-2x text-muted mb-2"}),React.createElement("div",{className:"small text-muted"},"Click \u0111\u1EC3 upload")))),React.createElement("input",{ref:J,type:"file",accept:"image/*",className:"d-none",onChange:Et}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100",onClick:()=>{var I;return(I=J.current)==null?void 0:I.click()},disabled:te,style:{borderRadius:"10px"}},te?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh")),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"Ho\u1EB7c URL \u1EA3nh"),React.createElement("input",{type:"url",className:"form-control",value:j.image,onChange:I=>m({...j,image:I.target.value}),placeholder:"https://...",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"8px",fontSize:"0.875rem"}}))))),React.createElement("div",{className:"modal-footer",style:{border:"none",padding:"20px"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:B,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:H,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},H?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}const jt=n=>window.KTM.money.formatVND(n),vt=n=>{if(n==null||n==="")return[];let y=n;if(typeof y=="string"){const x=y.trim();if(!x)return[];try{y=JSON.parse(x)}catch(B){return[]}}return Array.isArray(y)?y:[]},At=n=>{if(n==null||n==="")return[];let y=n;if(typeof y=="string"){const x=y.trim();if(!x)return[];try{y=JSON.parse(x)}catch(B){return[]}}return y&&typeof y=="object"&&!Array.isArray(y)&&(y=Object.entries(y).map(([x,B])=>({key:x,value:B}))),Array.isArray(y)?y:[]},Ot=(n,y={})=>{var j;const x=At(n).map(m=>{var H,se,te,A,J;return{key:String((te=(se=(H=m==null?void 0:m.key)!=null?H:m==null?void 0:m.name)!=null?se:m==null?void 0:m.label)!=null?te:"").trim(),value:String((A=m==null?void 0:m.value)!=null?A:"").trim(),unit:String((J=m==null?void 0:m.unit)!=null?J:"").trim()}}).filter(m=>!!m.key);if(!x.length)return null;const B=!!y.compact,ee=String((j=y.className)!=null?j:"").trim();return React.createElement("div",{className:`ktm-variants-preview${B?" compact":""}${ee?" "+ee:""}`},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},x.map((m,H)=>{const se=m.key,te=`${m.value||""}${m.unit?(m.value?" ":"")+m.unit:""}`.trim();return React.createElement("div",{key:`${se}-${H}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},se),te?React.createElement("span",{className:"ktm-chip ktm-chip-option"},te):null)})))},Lt=(n,y={})=>{var se;const x=vt(n).map(te=>{var A;return{name:String((A=te==null?void 0:te.name)!=null?A:"").trim(),options:Array.isArray(te==null?void 0:te.options)?te.options:[]}}).map(te=>({...te,options:te.options.map(A=>{var J;return{label:String((J=A==null?void 0:A.label)!=null?J:"").trim(),price:Number(A==null?void 0:A.price)}}).filter(A=>!!A.label)})).filter(te=>te.options.length>0);if(!x.length)return null;const B=Number.isFinite(y.maxGroups)?Math.max(1,Math.trunc(y.maxGroups)):x.length,ee=Number.isFinite(y.maxOptionsPerGroup)?Math.max(1,Math.trunc(y.maxOptionsPerGroup)):3,j=!!y.compact,m=String((se=y.className)!=null?se:"").trim(),H=x.slice(0,B);return React.createElement("div",{className:`ktm-variants-preview${j?" compact":""}${m?" "+m:""}`},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},H.map((te,A)=>{const J=te.name||"Bi\u1EBFn th\u1EC3",ze=te.options.slice(0,ee),ue=te.options.length-ze.length;return React.createElement("div",{key:`${J}-${A}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},J),ze.map((qe,pt)=>{const Xe=qe.price,Ye=Number.isFinite(Xe)&&Xe>=0?jt(Math.trunc(Xe)):"",dt=Ye?`${qe.label} \xB7 ${Ye}`:qe.label;return React.createElement("span",{key:`${J}-${A}-${pt}`,className:"ktm-chip ktm-chip-option"},dt)}),ue>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",ue))})))},Pt=(n,y)=>{const x=n._type==="product",B=n._type==="album",ee=n._type==="video",j=n.note&&(n.note.toLowerCase().includes("free")||n.note.toLowerCase().includes("gi\u1EA3m")||n.note.toLowerCase().includes("sale")),m=x?Ot(n.attributes,{compact:fe==="grid",className:fe==="grid"?"meta text-muted":"text-muted"}):null,H=x?Lt(n.variants,{compact:fe==="grid",maxOptionsPerGroup:999,className:fe==="grid"?"meta text-muted":"text-muted"}):null;return fe==="grid"?React.createElement("div",{key:n.id||y,className:"grid-card"},React.createElement("div",{className:"thumb-wrap",onClick:()=>me({url:n.image,name:n.name,price:n.price,note:n.note,item:n})},n.image?React.createElement("img",{src:n.image,alt:n.name,className:"thumb",loading:"lazy"}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${ee?"fa-video":"fa-image"} fa-2x text-muted`})),n.price&&React.createElement("div",{className:"price-overlay"},n.price.replace(/[đ\s]/g,""),"\u0111"),React.createElement("span",{className:`type-badge ${x?"product":B?"album":"video"}`},x?"SP":B?"\u1EA2nh":"Video"),j&&React.createElement("span",{className:"promo-badge"},"\u{1F525} \u01AFU \u0110\xC3I")),React.createElement("div",{className:"card-body"},React.createElement("div",{className:"name"},n.name),n.note&&React.createElement("div",{className:"meta text-info",style:{fontSize:10}},n.note),m&&React.createElement("div",{style:{marginTop:2}},m),H&&React.createElement("div",{style:{marginTop:2}},H),React.createElement("div",{className:"quick-copy"},React.createElement("button",{className:oe===n.id+"-img"?"copied":"",onClick:()=>tt(n.image,n.id)},React.createElement("i",{className:"fas fa-image"})),n.price&&React.createElement("button",{className:oe===n.id+"-price"?"copied":"",onClick:()=>Qe(n.price.replace(/[đ\s]/g,""),n.id+"-price")},React.createElement("i",{className:"fas fa-tag"}))))):React.createElement("div",{key:n.id||y,className:"product-card-mobile"},React.createElement("span",{className:`type-badge ${x?"product":B?"album":"video"}`},x?"S\u1EA3n ph\u1EA9m":B?"\u1EA2nh":"Video"),React.createElement("div",{className:"card-inner"},n.image?React.createElement("img",{src:n.image,alt:n.name,className:"thumb",loading:"lazy",onClick:()=>me({url:n.image,name:n.name,price:n.price,note:n.note,item:n})}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${ee?"fa-video":"fa-image"} fa-2x text-muted`})),React.createElement("div",{className:"info"},React.createElement("div",null,React.createElement("div",{className:"name"},n.name),React.createElement("div",{className:"price-row"},n.price&&React.createElement("span",{className:"price"},n.price.replace(/[đ\s]/g,""),"\u0111"),j&&React.createElement("span",{className:"badge-promo"},"\u{1F525} \u01AFU \u0110\xC3I")),m&&React.createElement("div",{style:{marginTop:4}},m),H&&React.createElement("div",{style:{marginTop:4}},H)),React.createElement("div",{className:"meta"},n.code&&React.createElement("span",{className:"meta-tag"},"#",n.code),n.category&&React.createElement("span",{className:"meta-tag"},n.category),n.note&&React.createElement("span",{className:"meta-tag highlight"},n.note),n.folder&&React.createElement("span",{className:"meta-tag"},n.folder),ee&&React.createElement("span",{className:"meta-tag"},React.createElement("i",{className:"fab fa-youtube text-danger"})," Video")))),React.createElement("div",{className:"quick-actions"},x&&React.createElement("button",{onClick:()=>k&&k("orders","create",{productId:n.id})},React.createElement("i",{className:"fas fa-receipt"})," T\u1EA1o \u0111\u01A1n"),n.price&&React.createElement("button",{className:oe===n.id+"-price"?"copied":"",onClick:()=>Qe(n.price.replace(/[đ\s]/g,""),n.id+"-price")},React.createElement("i",{className:"fas fa-tag"})," Gi\xE1"),React.createElement("button",{className:oe===n.id+"-name"?"copied":"",onClick:()=>Qe(n.name,n.id+"-name")},React.createElement("i",{className:"fas fa-font"})," T\xEAn"),ee&&n.youtubeId&&React.createElement("button",{className:oe===n.id+"-yt"?"copied":"",onClick:()=>Qe(`https://www.youtube.com/watch?v=${n.youtubeId}`,n.id+"-yt")},React.createElement("i",{className:"fab fa-youtube"})),x&&React.createElement("button",{className:"action-edit",onClick:()=>Tt(n)},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"action-delete",onClick:()=>St(n)},React.createElement("i",{className:"fas fa-trash"}))))},[Dt,yt]=useState(!1);return React.createElement(React.Fragment,null,React.createElement("div",{className:"result-header"},React.createElement("span",null,React.createElement("strong",null,X.length)," k\u1EBFt qu\u1EA3",re&&L.length>=3&&React.createElement("span",{className:"ai-badge ms-2"},React.createElement("i",{className:"fas fa-robot"})," AI"),pe!=="all"&&React.createElement("span",{className:"ms-2 badge bg-warning text-dark"},pe==="product"?"S\u1EA3n ph\u1EA9m":pe==="album"?"\u1EA2nh":"Video")),React.createElement("div",{className:"d-flex gap-1 align-items-center"},React.createElement("button",{className:`btn btn-sm ${fe==="list"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>Me("list"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-list"})),React.createElement("button",{className:`btn btn-sm ${fe==="grid"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>Me("grid"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-th"})))),React.createElement("div",{className:"search-results-area"},ce?React.createElement("div",null,[...Array(8)].map((n,y)=>React.createElement("div",{key:y,className:"product-card-mobile mb-2",style:{opacity:.7}},React.createElement("div",{className:"card-inner"},React.createElement("div",{className:"thumb bg-light",style:{width:80,height:80,borderRadius:8}}),React.createElement("div",{className:"info",style:{flex:1,minWidth:0}},React.createElement("div",{className:"skeleton-box mb-2",style:{height:16,width:"60%",background:"#eee",borderRadius:4}}),React.createElement("div",{className:"skeleton-box mb-1",style:{height:12,width:"40%",background:"#f3f3f3",borderRadius:4}}),React.createElement("div",{className:"skeleton-box",style:{height:10,width:"30%",background:"#f3f3f3",borderRadius:4}})))))):X.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-search"}),React.createElement("p",null,'Kh\xF4ng t\xECm th\u1EA5y "',L,'"'),React.createElement("button",{className:"btn btn-warning",onClick:()=>{Y(""),Ke("")}},"Xem t\u1EA5t c\u1EA3")):fe==="grid"?React.createElement("div",{className:"product-grid-mobile"},X.map((n,y)=>Pt(n,y))):React.createElement("div",null,X.map((n,y)=>Pt(n,y)))),Dt&&React.createElement("div",{className:"filter-dropdown"},React.createElement("div",{className:"filter-header"},React.createElement("strong",null,"L\u1ECDc theo lo\u1EA1i"),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>yt(!1)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"filter-chips"},React.createElement("span",{className:`filter-chip ${pe==="all"?"active":""}`,onClick:()=>{We("all"),yt(!1)}},"T\u1EA5t c\u1EA3"),React.createElement("span",{className:`filter-chip ${pe==="product"?"active":""}`,onClick:()=>{We("product"),yt(!1)}},React.createElement("i",{className:"fas fa-box me-1"}),"S\u1EA3n ph\u1EA9m"),React.createElement("span",{className:`filter-chip ${pe==="album"?"active":""}`,onClick:()=>{We("album"),yt(!1)}},React.createElement("i",{className:"fas fa-images me-1"}),"\u1EA2nh"),React.createElement("span",{className:`filter-chip ${pe==="video"?"active":""}`,onClick:()=>{We("video"),yt(!1)}},React.createElement("i",{className:"fas fa-video me-1"}),"Video")),React.createElement("div",{className:"mt-3 pt-3 border-top d-flex align-items-center justify-content-between"},React.createElement("span",null,"AI Search th\xF4ng minh"),React.createElement("div",{className:"form-check form-switch m-0"},React.createElement("input",{type:"checkbox",className:"form-check-input",checked:re,onChange:n=>Te(n.target.checked),style:{width:40,height:20}})))),React.createElement("div",{className:"search-bar-bottom"},React.createElement("div",{className:"search-input-wrap"},React.createElement("input",{ref:he,type:"text",className:"search-input",placeholder:"\u{1F50D} T\xECm: van 3 tay, xylanh...",value:L,onChange:n=>Ke(n.target.value)}),React.createElement("button",{className:`filter-btn ${Dt||pe!=="all"?"active":""}`,onClick:()=>yt(!Dt)},React.createElement("i",{className:"fas fa-filter"})))),React.createElement("button",{className:"btn btn-lg rounded-circle position-fixed shadow-lg",style:{bottom:C?320:130,right:16,width:56,height:56,zIndex:1050,transition:"bottom 0.2s ease",background:"linear-gradient(135deg, #667eea, #764ba2)",color:"#fff",border:"none",WebkitTapHighlightColor:"transparent",touchAction:"manipulation",cursor:"pointer",outline:"none"},onClick:()=>h(!0),onTouchStart:()=>h(!0)},React.createElement("i",{className:"fas fa-robot fa-lg"})),Ue&&React.createElement("div",{className:"ai-chat-mobile"},React.createElement("div",{className:"chat-header"},React.createElement("button",{className:"back-btn",onClick:()=>h(!1)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("strong",null,"KTM AI Assistant"),React.createElement("div",{style:{fontSize:11,opacity:.8}},"H\u1ECFi v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3..."))),React.createElement("div",{className:"chat-messages"},D.map((n,y)=>React.createElement("div",{key:y,className:`mb-3 ${n.role==="user"?"d-flex justify-content-end":""}`},React.createElement("div",{className:`p-3 rounded-3 position-relative ${n.role==="user"?"text-white":"bg-white border"}`,style:{maxWidth:"85%",whiteSpace:"pre-wrap",background:n.role==="user"?"linear-gradient(135deg, #667eea, #764ba2)":void 0}},n.content,n.role==="assistant"&&React.createElement("button",{className:"btn btn-sm position-absolute",style:{top:4,right:4,padding:"2px 6px",fontSize:11,background:oe===`chat-${y}`?"#28a745":"rgba(0,0,0,0.1)",border:"none",borderRadius:4,color:oe===`chat-${y}`?"#fff":"#666"},onClick:()=>{window.KTM.clipboard.writeText(n.content),de(`chat-${y}`),setTimeout(()=>de(null),1500)}},React.createElement("i",{className:`fas ${oe===`chat-${y}`?"fa-check":"fa-copy"}`})),n.attachments&&n.attachments.length>0&&React.createElement("div",{className:"mt-2 d-flex flex-wrap gap-2"},n.attachments.map((x,B)=>React.createElement("div",{key:B,style:{width:70},className:"text-center"},x.image&&React.createElement("img",{src:x.image,className:"rounded",style:{width:70,height:50,objectFit:"cover",cursor:"pointer"},onClick:()=>me({url:x.image,name:x.name,price:x.price})}),React.createElement("div",{style:{fontSize:9},className:"text-truncate"},x.name),x.price&&React.createElement("div",{style:{fontSize:10,color:"#dc3545",fontWeight:600}},x.price.replace(/[đ\s]/g,""),"\u0111"))))))),O&&React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"bg-white border p-3 rounded-3 d-inline-block"},React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang suy ngh\u0129...")),React.createElement("div",{ref:Q})),React.createElement("div",{className:"px-3 py-2 border-top d-flex gap-2 overflow-auto"},["Gi\xE1 van 2 tay?","Combo r\u1EBB nh\u1EA5t?","Freeship?","Van 3 tay?"].map(n=>React.createElement("button",{key:n,className:"btn btn-sm btn-outline-secondary flex-shrink-0",onClick:()=>ot(n),disabled:O,style:{whiteSpace:"nowrap"}},n))),React.createElement("div",{className:"chat-input-area"},React.createElement("form",{onSubmit:n=>{n.preventDefault(),ot(b)},className:"chat-input-wrap"},React.createElement("input",{ref:q,type:"text",className:"chat-input",placeholder:"Nh\u1EADp c\xE2u h\u1ECFi...",value:b,onChange:n=>_(n.target.value),disabled:O}),React.createElement("button",{type:"submit",className:"send-btn",disabled:O||!b.trim()},React.createElement("i",{className:"fas fa-paper-plane"}))))),z&&React.createElement("div",{className:"preview-modal",onClick:()=>me(null)},React.createElement("div",{className:"preview-header"},React.createElement("div",null),React.createElement("button",{className:"close-btn",onClick:()=>me(null)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"preview-body",onClick:n=>n.stopPropagation()},React.createElement("img",{src:z.url,alt:z.name})),React.createElement("div",{className:"preview-footer",onClick:n=>n.stopPropagation()},React.createElement("div",{className:"name"},z.name),z.price&&React.createElement("div",{className:"price"},z.price.replace(/[đ\s]/g,""),"\u0111"),z.note&&React.createElement("div",{className:"mb-2",style:{fontSize:14,color:"#17a2b8"}},z.note),React.createElement("div",{className:"action-btns"},React.createElement("button",{className:oe==="preview-img"?"btn-success text-white":"btn-outline-light text-white",style:{background:oe==="preview-img"?"#28a745":"rgba(255,255,255,0.2)"},onClick:()=>tt(z.url,"preview")},React.createElement("i",{className:`fas ${oe==="preview-img"?"fa-check":"fa-copy"}`}),"Copy \u1EA3nh"),z.price&&React.createElement("button",{className:oe==="preview-price"?"btn-success text-white":"btn-warning",onClick:()=>Qe(z.price.replace(/[đ\s]/g,""),"preview-price")},React.createElement("i",{className:`fas ${oe==="preview-price"?"fa-check":"fa-tag"}`}),"Copy gi\xE1")))),React.createElement(Rt,{show:V,product:Ge,categories:le,onClose:()=>{Oe(!1),Ve(null)},onSave:Vt}),React.createElement("div",{className:`fab-container mobile-only ${C?"open":""}`},React.createElement("div",{className:"fab-actions"},React.createElement("button",{className:"fab-action product",onClick:()=>{o(!1),Oe(!0),Ve(null)}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",{className:"tooltip"},"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("button",{className:"fab-action product",onClick:()=>{o(!1),k&&k("orders","create")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",{className:"tooltip"},"T\u1EA1o order nhanh"))),React.createElement("button",{className:`fab-main ${C?"open":""}`,onClick:()=>o(!C)},React.createElement("i",{className:"fas fa-plus"}))),Le&&v&&React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,maxHeight:"90vh"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none"}},React.createElement("h6",{className:"modal-title fw-bold"},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa nhanh"),React.createElement("button",{type:"button",className:"btn-close",onClick:()=>d(!1)})),React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"T\xEAn s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:Pe.name,onChange:n=>Ze({...Pe,name:n.target.value})})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:Pe.code,onChange:n=>Ze({...Pe,code:n.target.value})})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:Pe.price,onChange:n=>Ze({...Pe,price:n.target.value})}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:Pe.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:n=>Ze({...Pe,commission_percent:n.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:Pe.category,onChange:n=>Ze({...Pe,category:n.target.value})},React.createElement("option",{value:""},"-- Ch\u1ECDn danh m\u1EE5c --"),et.map(n=>React.createElement("option",{key:n,value:n},n)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Ghi ch\xFA (\u01B0u \u0111\xE3i)"),React.createElement("input",{type:"text",className:"form-control",value:Pe.note,placeholder:"VD: Free ship, Gi\u1EA3m 10%...",onChange:n=>Ze({...Pe,note:n.target.value})}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>d(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-warning",onClick:De},React.createElement("i",{className:"fas fa-save me-1"}),"L\u01B0u"))))))}function VideoList({onRefresh:$,showToast:k}){const[L,Y]=useState([]),[X,w]=useState([]),[E,ie]=useState(!0),[le,W]=useState(null),[pe,Ne]=useState(!1),[oe,de]=useState(null),[fe,Me]=useState(!1),[ce,we]=useState(null),[be,$e]=useState(null),[Ae,Re]=useState([]);useEffect(()=>{he()},[]);const he=async(d=null)=>{ie(!0);try{const v=d?`${API_BASE}/api/video-folders?withVideos=true&parent_id=${d}`:`${API_BASE}/api/video-folders?withVideos=true&parent_id=root`,ve=await window.KTM.api.getJSON(v,"L\u1ED7i t\u1EA3i danh s\xE1ch folder");Y(Array.isArray(ve)?ve:[])}catch(v){console.error(v),k("L\u1ED7i t\u1EA3i danh s\xE1ch folder","danger")}ie(!1)},re=async d=>{try{const v=await window.KTM.api.getJSON(`${API_BASE}/api/videos?folderId=${d}`,"L\u1ED7i t\u1EA3i video");w(Array.isArray(v)?v:[])}catch(v){console.error(v)}},Te=async d=>{if(d===0)return;const v=[...L];[v[d-1],v[d]]=[v[d],v[d-1]],Y(v),await _e(v)},je=async d=>{if(d===L.length-1)return;const v=[...L];[v[d],v[d+1]]=[v[d+1],v[d]],Y(v),await _e(v)},_e=async d=>{try{await Promise.all(d.map((v,ve)=>window.KTM.api.putJSON(`${API_BASE}/api/video-folders/${v.id}`,{sortOrder:ve},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),k("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(v){k("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),he(be==null?void 0:be.id)}},ke=async d=>{if(d===0)return;const v=[...X];[v[d-1],v[d]]=[v[d],v[d-1]],w(v),await h(v)},Ue=async d=>{if(d===X.length-1)return;const v=[...X];[v[d],v[d+1]]=[v[d+1],v[d]],w(v),await h(v)},h=async d=>{try{await Promise.all(d.map((v,ve)=>window.KTM.api.putJSON(`${API_BASE}/api/videos/${v.id}`,{sort_order:ve},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),k("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(v){k("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),re(le.id)}},D=()=>{de(null),Ne(!0)},i=d=>{de(d),Ne(!0)},b=async d=>{try{!oe&&be&&(d.parent_id=be.id);const v=oe?`${API_BASE}/api/video-folders/${oe.id}`:`${API_BASE}/api/video-folders`;oe?await window.KTM.api.putJSON(v,d,"L\u1ED7i l\u01B0u folder"):await window.KTM.api.postJSON(v,d,"L\u1ED7i l\u01B0u folder"),k(oe?"\u0110\xE3 c\u1EADp nh\u1EADt folder!":"\u0110\xE3 t\u1EA1o folder m\u1EDBi!","success"),Ne(!1),he(be==null?void 0:be.id)}catch(v){k(v.message,"danger")}},_=async d=>{const v=d.subfolderCount>0?`X\xF3a folder "${d.name}"? T\u1EA5t c\u1EA3 subfolder v\xE0 videos b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`:`X\xF3a folder "${d.name}"? Videos trong folder s\u1EBD kh\xF4ng b\u1ECB x\xF3a.`;if(confirm(v))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/video-folders/${d.id}`,"L\u1ED7i x\xF3a folder"),k("\u0110\xE3 x\xF3a folder","success"),W(null),he(be==null?void 0:be.id)}catch(ve){k("L\u1ED7i x\xF3a folder","danger")}},O=d=>{d.subfolderCount>0?(Re(v=>[...v,d]),$e(d),he(d.id)):(W(d),w(d.videos||[]))},F=d=>{if(d==="root")Re([]),$e(null),he(null);else if(d){const v=Ae.findIndex(ve=>ve.id===d.id);v>=0&&(Re(Ae.slice(0,v+1)),$e(d),he(d.id))}else{const v=[...Ae];v.pop();const ve=v[v.length-1]||null;Re(v),$e(ve),he(ve==null?void 0:ve.id)}},Q=()=>{we(null),Me(!0)},q=d=>{we(d),Me(!0)},z=async d=>{try{d.folder_id=le==null?void 0:le.id;const v=ce?`${API_BASE}/api/videos/${ce.id}`:`${API_BASE}/api/videos`;ce?await window.KTM.api.putJSON(v,d,"L\u1ED7i l\u01B0u video"):await window.KTM.api.postJSON(v,d,"L\u1ED7i l\u01B0u video"),k(ce?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm video th\xE0nh c\xF4ng!","success"),Me(!1),he(),le&&re(le.id)}catch(v){k(v.message,"danger")}},me=async d=>{if(confirm(`X\xF3a video "${d.title}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/videos/${d.id}`,"L\u1ED7i x\xF3a video"),k("\u0110\xE3 x\xF3a video","success"),he(),le&&re(le.id)}catch(v){k("L\u1ED7i x\xF3a video","danger")}},Le=d=>{const v=`https://www.youtube.com/watch?v=${d.youtubeId}`;window.KTM.clipboard.writeText(v).then(()=>{k("\u0110\xE3 copy link!","success")}).catch(()=>{k("Kh\xF4ng th\u1EC3 copy link","danger")})};return le?React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>W(null)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:`fas fa-folder-open me-2 ${le.slug==="shorts"?"text-danger":"text-warning"}`}),le.name)),React.createElement("button",{className:"btn btn-warning",onClick:Q},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm Video")),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1 videos"),X.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-video fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},"Ch\u01B0a c\xF3 video trong folder n\xE0y")):React.createElement("div",{className:"row g-4"},X.map((d,v)=>React.createElement("div",{key:d.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>ke(v),disabled:v===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},v+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>Ue(v),disabled:v===X.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"position-relative"},React.createElement("img",{src:d.thumb,className:"card-img-top",alt:d.title,style:{height:"120px",objectFit:"cover"}}),React.createElement("a",{href:`https://www.youtube.com/watch?v=${d.youtubeId}`,target:"_blank",className:"position-absolute top-50 start-50 translate-middle"},React.createElement("i",{className:"fas fa-play-circle fa-3x text-white",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"}}))),React.createElement("div",{className:"card-body py-2"},React.createElement("h6",{className:"card-title small mb-1 text-truncate",title:d.title},d.title),React.createElement("small",{className:"text-muted"},d.youtubeId)),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-primary",onClick:()=>Le(d),title:"Copy link"},React.createElement("i",{className:"fas fa-link"})),React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>q(d),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-outline-danger",onClick:()=>me(d),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))))),React.createElement(VideoModal,{show:fe,video:ce,onClose:()=>Me(!1),onSave:z})):React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},be&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>F()},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-video me-2 text-warning"}),be?be.name:"Qu\u1EA3n l\xFD Video")),React.createElement("button",{className:"btn btn-warning",onClick:D},React.createElement("i",{className:"fas fa-folder-plus me-2"}),"T\u1EA1o Folder")),Ae.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:d=>{d.preventDefault(),F("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),Ae.map((d,v)=>React.createElement("li",{key:d.id,className:`breadcrumb-item ${v===Ae.length-1?"active":""}`},v===Ae.length-1?d.name:React.createElement("a",{href:"#",onClick:ve=>{ve.preventDefault(),F(d)},className:"text-warning"},d.name))))),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1. Click v\xE0o folder \u0111\u1EC3 v\xE0o b\xEAn trong."),E?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):L.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},be?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder video n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:D},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o folder",be?" con":" \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"row g-3"},L.map((d,v)=>{var ve,C,o,V;return React.createElement("div",{key:d.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-card"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Oe=>{Oe.stopPropagation(),Te(v)},disabled:v===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},v+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Oe=>{Oe.stopPropagation(),je(v)},disabled:v===L.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"card-body text-center py-3",onClick:()=>O(d),style:{cursor:"pointer"}},React.createElement("i",{className:`fas fa-folder fa-3x mb-3 ${d.slug==="shorts"?"text-danger":"text-warning"}`}),React.createElement("h5",{className:"card-title"},d.name),React.createElement("p",{className:"text-muted mb-0"},d.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),d.subfolderCount," folder"),d.subfolderCount>0&&(d.videoCount>0||((ve=d.videos)==null?void 0:ve.length)>0)&&" \u2022 ",(d.videoCount>0||((C=d.videos)==null?void 0:C.length)>0)&&React.createElement("span",null,React.createElement("i",{className:"fas fa-video me-1"}),d.videoCount||((o=d.videos)==null?void 0:o.length)||0," videos"),d.subfolderCount===0&&!d.videoCount&&!((V=d.videos)!=null&&V.length)&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:Oe=>{Oe.stopPropagation(),i(d)}},React.createElement("i",{className:"fas fa-edit"})," S\u1EEDa"),React.createElement("button",{className:"btn btn-outline-danger",onClick:Oe=>{Oe.stopPropagation(),_(d)}},React.createElement("i",{className:"fas fa-trash"})," X\xF3a")))))})),React.createElement(VideoFolderModal,{show:pe,folder:oe,onClose:()=>Ne(!1),onSave:b}))}function VideoFolderModal({show:$,folder:k,onClose:L,onSave:Y}){const[X,w]=useState({name:"",description:"",sortOrder:0,coverImage:""}),[E,ie]=useState(!1),[le,W]=useState(!1);useEffect(()=>{w(k?{name:k.name||"",description:k.description||"",sortOrder:k.sortOrder||0,coverImage:k.coverImage||""}:{name:"",description:"",sortOrder:0,coverImage:""})},[k,$]);const pe=async oe=>{const de=oe.target.files[0];if(de){W(!0);try{const fe=await window.KTM.cloudinary.uploadImage({file:de,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});fe.secure_url&&w(Me=>({...Me,coverImage:fe.secure_url})),window.KTM.cache.remove(CACHE_KEY),showToast("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),setShowQuickEdit(!1),setEditingItem(null),loadAllData()}catch(fe){console.error("Cloudinary upload error:",fe),alert("L\u1ED7i upload \u1EA3nh: "+(fe.message||fe))}finally{W(!1)}}},Ne=async oe=>{oe.preventDefault(),ie(!0);const de={...X,variants:normalizeVariants(X.variants,X.price),attributes:normalizeAttributes(X.attributes)};await Y(de),ie(!1)};return $?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},k?"S\u1EEDa Folder":"T\u1EA1o Folder m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:L})),React.createElement("form",{onSubmit:Ne},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn folder *"),React.createElement("input",{type:"text",className:"form-control",value:X.name,onChange:oe=>w({...X,name:oe.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",value:X.description,onChange:oe=>w({...X,description:oe.target.value}),rows:"2"})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:X.sortOrder,onChange:oe=>w({...X,sortOrder:parseInt(oe.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex align-items-start gap-3"},X.coverImage?React.createElement("div",{className:"position-relative"},React.createElement("img",{src:X.coverImage,alt:"Cover",className:"rounded",style:{width:120,height:80,objectFit:"cover"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute top-0 end-0",onClick:()=>w({...X,coverImage:""}),style:{transform:"translate(30%, -30%)"}},React.createElement("i",{className:"fas fa-times"}))):React.createElement("div",{className:"bg-light rounded d-flex align-items-center justify-content-center text-muted",style:{width:120,height:80}},React.createElement("i",{className:"fas fa-image fa-2x"})),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{type:"file",className:"form-control form-control-sm",accept:"image/*,image/jpeg,image/png,image/gif,image/webp",onChange:pe,disabled:le}),le&&React.createElement("div",{className:"mt-1 text-muted small"},React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang upload..."),React.createElement("div",{className:"mt-1 text-muted small"},"Ho\u1EB7c d\xE1n URL:"),React.createElement("input",{type:"url",className:"form-control form-control-sm",placeholder:"https://...",value:X.coverImage,onChange:oe=>w({...X,coverImage:oe.target.value})}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:L},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:E},E?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function ProductManager({showToast:$,settings:k}){const[L,Y]=useState([]),[X,w]=useState(!0),[E,ie]=useState(!1),[le,W]=useState(null),[pe,Ne]=useState(""),[oe,de]=useState(""),fe=normalizeShipPercent(k==null?void 0:k.ship_percent),{parseMoney:Me,formatVND:ce}=window.KTM.money,we=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"];useEffect(()=>{be()},[]);const be=async()=>{w(!0);try{const i=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");Y(Array.isArray(i)?i:[])}catch(i){console.error(i),$("L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m","danger")}w(!1)},$e=()=>{W(null),ie(!0)},Ae=i=>{W(i),ie(!0)},Re=async i=>{if(!(!i||!i.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:i},"L\u1ED7i x\xF3a \u1EA3nh"),window.KTM.cache.remove(CACHE_KEY),$(`\u0110\xE3 x\xF3a ${typeName}`,"success"),loadAllData(),be()}catch(b){$("L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m","danger")}},he=async i=>{try{const b=le?`${API_BASE}/api/products?id=${le.id}`:`${API_BASE}/api/products`;le?await window.KTM.api.putJSON(b,i,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(b,i,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),$(le?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),ie(!1),be()}catch(b){$(b.message,"danger")}},re=async i=>{if(confirm(`B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n x\xF3a s\u1EA3n ph\u1EA9m "${i.name}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/products?id=${i.id}`,"L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m"),$("X\xF3a s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),be()}catch(b){$(b.message,"danger")}},Te=L.filter(i=>{const b=!pe||i.name.toLowerCase().includes(pe.toLowerCase())||i.code&&i.code.toLowerCase().includes(pe.toLowerCase()),_=!oe||i.category===oe;return b&&_}),je=i=>{var O;const b=(O=i==null?void 0:i.commission_percent)!=null?O:i==null?void 0:i.commissionPercent,_=b===""||b==null?NaN:Number(b);return Number.isFinite(_)?Math.max(0,Math.min(100,_)):5},_e=i=>{const b=je(i),_=Number.isInteger(b)?String(b):String(Math.round(b*100)/100),O=Me(i==null?void 0:i.price);if(!Number.isFinite(O)||O<=0)return`${_}%`;const F=(Number(b)||0)/100,q=window.KTM.money.parseShipFeeFromNote(i==null?void 0:i.note)!=null?0:fe>0?O*fe/100:0,z=O*F-q*F,me=Math.max(0,Math.round(z));return`${_}% - ${ce(me)}`},ke=i=>{if(i==null||i==="")return[];let b=i;if(typeof b=="string"){const _=b.trim();if(!_)return[];try{b=JSON.parse(_)}catch(O){return[]}}return Array.isArray(b)?b:[]},Ue=i=>{if(i==null||i==="")return[];let b=i;if(typeof b=="string"){const _=b.trim();if(!_)return[];try{b=JSON.parse(_)}catch(O){return[]}}return b&&typeof b=="object"&&!Array.isArray(b)&&(b=Object.entries(b).map(([_,O])=>({key:_,value:O}))),Array.isArray(b)?b:[]},h=i=>{const b=Ue(i).map(_=>{var O,F,Q,q,z;return{key:String((Q=(F=(O=_==null?void 0:_.key)!=null?O:_==null?void 0:_.name)!=null?F:_==null?void 0:_.label)!=null?Q:"").trim(),value:String((q=_==null?void 0:_.value)!=null?q:"").trim(),unit:String((z=_==null?void 0:_.unit)!=null?z:"").trim()}}).filter(_=>!!_.key);return b.length?React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},b.map((_,O)=>{const F=_.key,Q=`${_.value||""}${_.unit?(_.value?" ":"")+_.unit:""}`.trim();return React.createElement("div",{key:`${F}-${O}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},F),Q?React.createElement("span",{className:"ktm-chip ktm-chip-option"},Q):null)}))):null},D=(i,b={})=>{const _=ke(i).map(q=>{var z;return{name:String((z=q==null?void 0:q.name)!=null?z:"").trim(),options:Array.isArray(q==null?void 0:q.options)?q.options:[]}}).map(q=>({...q,options:q.options.map(z=>{var me;return{label:String((me=z==null?void 0:z.label)!=null?me:"").trim(),price:Number(z==null?void 0:z.price)}}).filter(z=>!!z.label)})).filter(q=>q.options.length>0);if(!_.length)return null;const O=Number.isFinite(b.maxGroups)?Math.max(1,Math.trunc(b.maxGroups)):_.length,F=Number.isFinite(b.maxOptionsPerGroup)?Math.max(1,Math.trunc(b.maxOptionsPerGroup)):4,Q=_.slice(0,O);return React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},Q.map((q,z)=>{const me=q.name||"Bi\u1EBFn th\u1EC3",Le=q.options.slice(0,F),d=q.options.length-Le.length;return React.createElement("div",{key:`${me}-${z}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},me),Le.map((v,ve)=>{const C=v.price,o=Number.isFinite(C)&&C>=0?ce(Math.trunc(C)):"",V=o?`${v.label} \xB7 ${o}`:v.label;return React.createElement("span",{key:`${me}-${z}-${ve}`,className:"ktm-chip ktm-chip-option"},V)}),d>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",d))})))};return React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",null,React.createElement("i",{className:"fas fa-box me-2"}),"S\u1EA3n ph\u1EA9m"),React.createElement("button",{className:"btn-add-product",onClick:$e},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"d-flex gap-2 mb-2"},React.createElement("div",{className:"flex-grow-1 position-relative"},React.createElement("input",{type:"text",className:"form-control",placeholder:"\u{1F50D} T\xECm s\u1EA3n ph\u1EA9m...",value:pe,onChange:i=>Ne(i.target.value)})),React.createElement("span",{className:"product-count"},Te.length)),React.createElement("select",{className:"form-select",value:oe,onChange:i=>de(i.target.value)},React.createElement("option",{value:""},"\u{1F4C1} T\u1EA5t c\u1EA3 danh m\u1EE5c"),we.map(i=>React.createElement("option",{key:i,value:i},i)))),X?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"2.5rem",height:"2.5rem"}}),React.createElement("p",{className:"text-muted mt-3 mb-0"},"\u0110ang t\u1EA3i...")):Te.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-box-open"}),React.createElement("p",null,"Ch\u01B0a c\xF3 s\u1EA3n ph\u1EA9m n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:$e},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"product-list"},Te.map(i=>React.createElement("div",{key:i.id,className:"product-item d-flex align-items-center gap-3"},i.image?React.createElement("img",{src:i.image,alt:"",className:"product-img"}):React.createElement("div",{className:"product-img-placeholder"},React.createElement("i",{className:"fas fa-image text-muted"})),React.createElement("div",{className:"flex-grow-1 min-width-0"},React.createElement("div",{className:"product-name"},i.name),React.createElement("div",{className:"d-flex flex-wrap gap-1 mb-1"},i.category&&React.createElement("span",{className:"product-badge bg-info bg-opacity-75"},i.category),i.code&&React.createElement("span",{className:"product-badge bg-secondary"},i.code),React.createElement("span",{className:"product-badge bg-warning text-dark",title:"Hoa h\u1ED3ng (%)"},React.createElement("i",{className:"fas fa-percent me-1"}),_e(i))),React.createElement("div",{className:"product-price"},i.price?i.price.replace(/[đ\s]/g,"")+"\u0111":"Li\xEAn h\u1EC7"),i.note&&React.createElement("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"}},i.note),h(i.attributes)&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},h(i.attributes)),D(i.variants,{maxOptionsPerGroup:4})&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},D(i.variants,{maxOptionsPerGroup:4}))),React.createElement("div",{className:"product-actions"},React.createElement("button",{className:"btn btn-edit",onClick:()=>Ae(i),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"btn btn-delete",onClick:()=>re(i),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement(ProductModal,{show:E,product:le,categories:we,onClose:()=>ie(!1),onSave:he}))}function ProductModal({show:$,product:k,categories:L,onClose:Y,onSave:X}){const[w,E]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[ie,le]=useState(!1),[W,pe]=useState(!1),Ne=h=>{const D=window.KTM.money.getDigits(String(h!=null?h:"")),i=Number(D);return D&&Number.isFinite(i)?Math.trunc(i):0},oe=h=>{if(h==null||h==="")return[];let D=h;if(typeof D=="string"){const i=D.trim();if(!i)return[];try{D=JSON.parse(i)}catch(b){return[]}}return D&&typeof D=="object"&&!Array.isArray(D)&&(D=Object.entries(D).map(([i,b])=>({key:i,value:b}))),Array.isArray(D)?D.map(i=>{var F,Q,q,z,me;if(!i||typeof i!="object")return null;const b=String((q=(Q=(F=i.key)!=null?F:i.name)!=null?Q:i.label)!=null?q:"").trim(),_=String((z=i.value)!=null?z:"").trim(),O=String((me=i.unit)!=null?me:"").trim();return b?{key:b,value:_,unit:O}:null}).filter(Boolean):[]},de=(h,D)=>{if(h==null||h==="")return[];let i=h;if(typeof i=="string"){const _=i.trim();if(!_)return[];try{i=JSON.parse(_)}catch(O){return[]}}if(!Array.isArray(i))return[];const b=Ne(D);return i.map(_=>{var Q;if(!_||typeof _!="object")return null;const O=String((Q=_.name)!=null?Q:"").trim(),F=(Array.isArray(_.options)?_.options:[]).map(q=>{var ve,C,o,V,Oe,Ge,Ve;if(!q||typeof q!="object")return null;const z=String((ve=q.label)!=null?ve:"").trim();if(!z)return null;const me=(Oe=(V=(o=(C=q.price)!=null?C:q.priceValue)!=null?o:q.unit_price)!=null?V:q.unitPrice)!=null?Oe:null,Le=Number(me);let d=Number.isFinite(Le)?Math.trunc(Le):null;if(d==null){const Pe=(Ve=(Ge=q.price_delta)!=null?Ge:q.priceDelta)!=null?Ve:null,Ze=Number(Pe);Number.isFinite(Ze)&&(d=b+Math.trunc(Ze))}d==null&&(d=b);const v=String(Math.max(0,Math.trunc(Number(d)||0)));return{label:z,price:Math.max(0,Math.trunc(Number(d)||0)),priceDigits:v}}).filter(Boolean);return{name:O||"Bi\u1EBFn th\u1EC3",options:F}}).filter(Boolean)};useEffect(()=>{var h,D;E(k?{name:k.name||"",code:k.code||"",price:k.price||"",image:k.image||"",category:k.category||"",note:k.note||"",sort_order:k.sort_order||0,commission_percent:(D=(h=k.commission_percent)!=null?h:k.commissionPercent)!=null?D:5,variants:de(k.variants,k.price),attributes:oe(k.attributes)}:{name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]})},[k,$]);const fe=h=>{E(D=>{var F;const i=Ne(D.price),b=String(i),_=Array.isArray(D.variants)?[...D.variants]:[],O={..._[h]||{},options:Array.isArray((F=_[h])==null?void 0:F.options)?[..._[h].options]:[]};return O.options=O.options.map(Q=>({label:String((Q==null?void 0:Q.label)||""),price:i,priceDigits:b})),_[h]=O,{...D,variants:_}})},Me=()=>{E(h=>{const D=Ne(h.price),i=String(D),_=(Array.isArray(h.variants)?[...h.variants]:[]).map(O=>{const F=(Array.isArray(O==null?void 0:O.options)?O.options:[]).map(Q=>({label:String((Q==null?void 0:Q.label)||""),price:D,priceDigits:i}));return{name:String((O==null?void 0:O.name)||"Bi\u1EBFn th\u1EC3"),options:F}});return{...h,variants:_}})},[ce,we]=React.useState(""),be=h=>window.KTM.money.formatVNDInputDigits(h),[$e,Ae]=React.useState(""),Re=h=>{const D=window.KTM.money.nextPriceInputState(h.target.value,$e);Ae(D.digits),E({...w,price:D.price})},[he,re]=React.useState("");React.useEffect(()=>{k!=null&&k.image&&re(k.image)},[k]);const Te=async h=>{if(!(!h||!h.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:h},"L\u1ED7i x\xF3a \u1EA3nh")}catch(D){console.error("Delete cloudinary image error:",D)}},je=async(h,D=2,i)=>{const b=D*1024*1024,_=h.type==="image/heic"||h.type==="image/heif"||/\.heic$/i.test(h.name);if(h.size<=b&&!_)return h;i==null||i("\u0110ang x\u1EED l\xFD \u1EA3nh...");try{const O=await createImageBitmap(h);i==null||i("\u0110ang n\xE9n \u1EA3nh...");const F=document.createElement("canvas");let Q=O.width,q=O.height;const z=1200;return(Q>z||q>z)&&(Q>q?(q=Math.round(q/Q*z),Q=z):(Q=Math.round(Q/q*z),q=z)),F.width=Q,F.height=q,F.getContext("2d").drawImage(O,0,0,Q,q),O.close(),new Promise((Le,d)=>{F.toBlob(v=>{v?(i==null||i("Ho\xE0n t\u1EA5t!"),Le(new File([v],h.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"}))):d(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(O){throw console.error("createImageBitmap error:",O),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},_e=async h=>{var b,_;const D=(b=h.target.files)==null?void 0:b[0];if(!D)return;if(!(D.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(D.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}pe(!0),we("\u0110ang chu\u1EA9n b\u1ECB...");try{const O=(D.size/1024/1024).toFixed(1);we(`File ${O}MB - \u0110ang n\xE9n...`);const F=await je(D,2,z=>{we(z)}),Q=(F.size/1024/1024).toFixed(1);we(`\u0110\xE3 n\xE9n: ${Q}MB - \u0110ang upload...`);const q=await window.KTM.cloudinary.uploadImage({file:F,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});q.secure_url?(w.image&&w.image!==he&&Te(w.image),E(z=>({...z,image:q.secure_url})),we("")):(console.error("Cloudinary error:",q),alert("Upload th\u1EA5t b\u1EA1i: "+(((_=q.error)==null?void 0:_.message)||"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh")),we(""))}catch(O){console.error("Upload error:",O),alert("L\u1ED7i: "+O.message),we("")}pe(!1),h.target.value=""},ke=()=>{w.image&&(w.image!==he&&Te(w.image),E(h=>({...h,image:""})))},Ue=async h=>{h.preventDefault(),le(!0),he&&w.image&&he!==w.image&&await Te(he),he&&!w.image&&await Te(he),await X(w),le(!1)};return $?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down"},React.createElement("div",{className:"modal-content",style:{borderRadius:"16px",overflow:"hidden"}},React.createElement("div",{className:"modal-header border-0 py-3",style:{background:"linear-gradient(135deg, #ffc107 0%, #ffca2c 100%)"}},React.createElement("h6",{className:"modal-title fw-bold",style:{color:"#1a1a2e"}},React.createElement("i",{className:`fas ${k?"fa-edit":"fa-plus-circle"} me-2`}),k?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:Y})),React.createElement("form",{onSubmit:Ue},React.createElement("div",{className:"modal-body py-4",style:{maxHeight:"65vh",overflowY:"auto",background:"#f8f9fa"}},React.createElement("div",{className:"text-center mb-4"},React.createElement("div",{className:"position-relative d-inline-block"},w.image?React.createElement(React.Fragment,null,React.createElement("img",{src:w.image,alt:"",style:{width:110,height:110,objectFit:"cover",borderRadius:"12px",boxShadow:"0 4px 15px rgba(0,0,0,0.15)"}}),React.createElement("button",{type:"button",className:"btn btn-danger position-absolute",onClick:ke,style:{top:-10,right:-10,width:28,height:28,padding:0,borderRadius:"50%",boxShadow:"0 2px 8px rgba(220,53,69,0.4)"}},React.createElement("i",{className:"fas fa-times",style:{fontSize:"0.75rem"}}))):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:110,height:110,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd"}},React.createElement("i",{className:"fas fa-image fa-2x text-muted"}))),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"btn btn-warning btn-sm px-3",style:{borderRadius:"20px"}},React.createElement("i",{className:`fas ${W?"fa-spinner fa-spin":"fa-camera"} me-1`}),W?ce||"\u0110ang x\u1EED l\xFD...":"Ch\u1ECDn \u1EA3nh",React.createElement("input",{type:"file",accept:"image/*",onChange:_e,disabled:W,style:{position:"absolute",left:"-9999px",opacity:0,width:1,height:1}})),W&&ce&&React.createElement("div",{className:"text-center mt-1",style:{fontSize:11,color:"#6c757d"}},ce))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-tag me-1 text-warning"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:w.name,onChange:h=>E({...w,name:h.target.value}),required:!0,placeholder:"VD: Combo Van 3 tay + 2 xylanh",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-barcode me-1 text-info"}),"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:w.code,onChange:h=>E({...w,code:h.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1 text-success"}),"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:w.price,onChange:Re,placeholder:"1.950.000\u0111",inputMode:"numeric",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-percent me-1 text-secondary"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:w.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:h=>E({...w,commission_percent:h.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-folder me-1 text-primary"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:w.category,onChange:h=>E({...w,category:h.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),L.map(h=>React.createElement("option",{key:h,value:h},h)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1 text-secondary"}),"Ghi ch\xFA"),React.createElement("input",{type:"text",className:"form-control",value:w.note,onChange:h=>E({...w,note:h.target.value}),placeholder:"VD: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1 text-secondary"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(w.attributes)?w.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(w.attributes)?w.attributes:[]).map((h,D)=>React.createElement("div",{key:D,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(h==null?void 0:h.key)||"",onChange:i=>{const b=i.target.value;E(_=>{const O=Array.isArray(_.attributes)?[..._.attributes]:[];return O[D]={...O[D]||{},key:b},{..._,attributes:O}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(h==null?void 0:h.value)||"",onChange:i=>{const b=i.target.value;E(_=>{const O=Array.isArray(_.attributes)?[..._.attributes]:[];return O[D]={...O[D]||{},value:b},{..._,attributes:O}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(h==null?void 0:h.unit)||"",onChange:i=>{const b=i.target.value;E(_=>{const O=Array.isArray(_.attributes)?[..._.attributes]:[];return O[D]={...O[D]||{},unit:b},{..._,attributes:O}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{E(i=>{const b=Array.isArray(i.attributes)?[...i.attributes]:[];return b.splice(D,1),{...i,attributes:b}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{E(h=>{const D=Array.isArray(h.attributes)?[...h.attributes]:[];return D.push({key:"",value:"",unit:""}),{...h,attributes:D}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1 text-secondary"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(w.variants)?w.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3."):null,(Array.isArray(w.variants)?w.variants:[]).map((h,D)=>React.createElement("div",{key:D,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(h==null?void 0:h.name)||"",onChange:i=>{const b=i.target.value;E(_=>{var F;const O=Array.isArray(_.variants)?[..._.variants]:[];return O[D]={...O[D]||{},name:b,options:Array.isArray((F=O[D])==null?void 0:F.options)?O[D].options:[]},{..._,variants:O}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>fe(D),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(h==null?void 0:h.options)||h.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{E(i=>{const b=Array.isArray(i.variants)?[...i.variants]:[];return b.splice(D,1),{...i,variants:b}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(h==null?void 0:h.options)?h.options:[]).map((i,b)=>{var _,O;return React.createElement("div",{key:b,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(i==null?void 0:i.label)||"",onChange:F=>{const Q=F.target.value;E(q=>{var v,ve,C,o,V;const z=Array.isArray(q.variants)?[...q.variants]:[],me={...z[D]||{},options:Array.isArray((v=z[D])==null?void 0:v.options)?[...z[D].options]:[]},Le=Number((C=(ve=me.options[b])==null?void 0:ve.price)!=null?C:0)||0,d=String((V=(o=me.options[b])==null?void 0:o.priceDigits)!=null?V:Math.max(0,Math.trunc(Le)));return me.options[b]={...me.options[b]||{},label:Q,price:Math.max(0,Math.trunc(Le)),priceDigits:d},z[D]=me,{...q,variants:z}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:be(String((O=i==null?void 0:i.priceDigits)!=null?O:window.KTM.money.getDigits(String((_=i==null?void 0:i.price)!=null?_:"")))),onChange:F=>{E(Q=>{var C,o,V,Oe,Ge;const q=String((o=i==null?void 0:i.priceDigits)!=null?o:window.KTM.money.getDigits(String((C=i==null?void 0:i.price)!=null?C:""))),z=window.KTM.money.nextPriceInputState(F.target.value,q),me=String((V=z.digits)!=null?V:""),Le=Number(me),d=Number.isFinite(Le)?Math.max(0,Math.trunc(Le)):0,v=Array.isArray(Q.variants)?[...Q.variants]:[],ve={...v[D]||{},options:Array.isArray((Oe=v[D])==null?void 0:Oe.options)?[...v[D].options]:[]};return ve.options[b]={...ve.options[b]||{},label:String(((Ge=ve.options[b])==null?void 0:Ge.label)||""),price:d,priceDigits:me},v[D]=ve,{...Q,variants:v}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{E(F=>{var z;const Q=Array.isArray(F.variants)?[...F.variants]:[],q={...Q[D]||{},options:Array.isArray((z=Q[D])==null?void 0:z.options)?[...Q[D].options]:[]};return q.options.splice(b,1),Q[D]=q,{...F,variants:Q}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{E(i=>{var F;const b=Array.isArray(i.variants)?[...i.variants]:[],_={...b[D]||{},options:Array.isArray((F=b[D])==null?void 0:F.options)?[...b[D].options]:[]},O=Ne(i.price);return _.options.push({label:"",price:O,priceDigits:String(O)}),b[D]=_,{...i,variants:b}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{E(h=>{const D=Ne(h.price),i=Array.isArray(h.variants)?[...h.variants]:[],b=String(D);return i.push({name:"Size",options:[{label:"S",price:D,priceDigits:b},{label:"M",price:D,priceDigits:b},{label:"L",price:D,priceDigits:b}]}),{...h,variants:i}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:Me,disabled:!Array.isArray(w.variants)||w.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111."))),React.createElement("div",{className:"mb-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"URL \u1EA3nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",placeholder:"https://...",value:w.image,onChange:h=>E({...w,image:h.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"10px",fontSize:"0.9rem"}}))),React.createElement("div",{className:"modal-footer border-0 py-3",style:{background:"#fff"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:Y,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:ie,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},ie?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}function VideoModal({show:$,video:k,onClose:L,onSave:Y}){const[X,w]=useState({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),[E,ie]=useState(!1),[le,W]=useState("");useEffect(()=>{k?(w({title:k.title||"",youtube_url:`https://www.youtube.com/watch?v=${k.youtubeId}`,thumbnail_url:k.thumb||"",sort_order:k.sortOrder||0}),W(k.thumb)):(w({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),W(""))},[k,$]);const pe=de=>{const fe=de.match(/(?:youtube\.com\/(?:embed\/|watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return fe?fe[1]:null},Ne=de=>{w({...X,youtube_url:de});const fe=pe(de);fe&&W(`https://img.youtube.com/vi/${fe}/hqdefault.jpg`)},oe=async de=>{de.preventDefault(),ie(!0),await Y(X),ie(!1)};return $?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},k?"S\u1EEDa Video":"Th\xEAm Video m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:L})),React.createElement("form",{onSubmit:oe},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Link YouTube *"),React.createElement("input",{type:"url",className:"form-control",value:X.youtube_url,onChange:de=>Ne(de.target.value),placeholder:"https://www.youtube.com/watch?v=... ho\u1EB7c shorts/...",required:!0}),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3: youtube.com/watch, youtu.be, youtube.com/shorts")),le&&React.createElement("div",{className:"mb-3 text-center"},React.createElement("img",{src:le,alt:"Preview",className:"img-fluid rounded",style:{maxHeight:"150px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ti\xEAu \u0111\u1EC1 *"),React.createElement("input",{type:"text",className:"form-control",value:X.title,onChange:de=>w({...X,title:de.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:X.sort_order,onChange:de=>w({...X,sort_order:parseInt(de.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Thumbnail t\xF9y ch\u1EC9nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",value:X.thumbnail_url,onChange:de=>w({...X,thumbnail_url:de.target.value}),placeholder:"\u0110\u1EC3 tr\u1ED1ng s\u1EBD d\xF9ng thumbnail m\u1EB7c \u0111\u1ECBnh c\u1EE7a YouTube"}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:L},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:E},E?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function AdminApp(){const[$,k]=useState(!1),[L,Y]=useState(""),[X,w]=useState(null),[E,ie]=useState("search"),[le,W]=useState(null),[pe,Ne]=useState(""),[oe,de]=useState([]),[fe,Me]=useState(null),[ce,we]=useState(!1),[be,$e]=useState(null),[Ae,Re]=useState(!0),[he,re]=useState([]),[Te,je]=useState(()=>loadAdminSettings()),[_e,ke]=useState(null),[Ue,h]=useState([]);useEffect(()=>{const C=localStorage.getItem("ktm_admin_session");if(C)try{const o=JSON.parse(C);o.expiry>Date.now()?(k(!0),w(o.user)):localStorage.removeItem("ktm_admin_session")}catch(o){localStorage.removeItem("ktm_admin_session")}},[]),useEffect(()=>{$&&O()},[$]),useEffect(()=>{if(!$)return;let C=!1;return(async()=>{try{const o=await fetchAdminSettingsFromServer();if(C)return;je(o),saveAdminSettings(o)}catch(o){}})(),()=>{C=!0}},[$]);const D=async(C,o)=>{Y("");try{const V=await window.KTM.api.postJSON(`${API_BASE}/api/auth/login`,{username:C,password:o},"\u0110\u0103ng nh\u1EADp th\u1EA5t b\u1EA1i"),Oe={user:V.user,token:V.token,expiry:Date.now()+100*365*24*60*60*1e3};localStorage.setItem("ktm_admin_session",JSON.stringify(Oe)),w(V.user),k(!0)}catch(V){Y(V.message)}},i=()=>{localStorage.removeItem("ktm_admin_session"),k(!1),w(null),de([]),Me(null)},b=(C,o="success")=>{const V=Date.now();re(Oe=>[...Oe,{id:V,message:C,type:o}])},_=C=>{re(o=>o.filter(V=>V.id!==C))},O=async(C=null)=>{Re(!0);try{const o=C?`${API_BASE}/api/albums?parent_id=${C}`:`${API_BASE}/api/albums?parent_id=root`,V=await window.KTM.api.getJSON(o,"L\u1ED7i t\u1EA3i danh s\xE1ch album");de(Array.isArray(V)?V:[])}catch(o){console.error(o),b("L\u1ED7i t\u1EA3i danh s\xE1ch album","danger")}Re(!1)},F=()=>{$e(null),we(!0)},Q=C=>{$e(C),we(!0)},q=async C=>{try{const o=be&&be.uuid;!o&&_e&&(C.parent_id=_e.uuid);const V=o?`${API_BASE}/api/albums/${be.uuid||be.id}`:`${API_BASE}/api/albums`;o?await window.KTM.api.putJSON(V,C,"L\u1ED7i c\u1EADp nh\u1EADt"):await window.KTM.api.postJSON(V,C,"L\u1ED7i t\u1EA1o"),b(o?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"T\u1EA1o th\xE0nh c\xF4ng!","success"),we(!1),O(_e==null?void 0:_e.uuid)}catch(o){b(o.message,"danger")}},z=C=>{Me(C)},me=C=>{if(C==="root")h([]),ke(null),O(null);else if(C){const o=Ue.findIndex(V=>V.uuid===C.uuid);o>=0&&(h(Ue.slice(0,o+1)),ke(C),O(C.uuid))}else{const o=[...Ue];o.pop();const V=o[o.length-1]||null;h(o),ke(V),O(V==null?void 0:V.uuid)}},Le=async C=>{const o=`X\xF3a folder "${C.title}"? T\u1EA5t c\u1EA3 folder con v\xE0 \u1EA3nh b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`;if(confirm(o))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${C.uuid||C.id}`,"L\u1ED7i x\xF3a album"),b("\u0110\xE3 x\xF3a","success"),O(_e==null?void 0:_e.uuid)}catch(V){b("L\u1ED7i x\xF3a album","danger")}};if(!$)return React.createElement(LoginPage,{onLogin:D,error:L});const d=()=>{const C=new Date,o=C.getFullYear(),V=String(C.getMonth()+1).padStart(2,"0");return`${o}-${V}`};function v(){const[C,o]=useState(()=>{var Ve;return String((Ve=Te==null?void 0:Te.ship_percent)!=null?Ve:DEFAULT_SHIP_PERCENT)}),[V,Oe]=useState(!1);return useEffect(()=>{var Ve;o(String((Ve=Te==null?void 0:Te.ship_percent)!=null?Ve:DEFAULT_SHIP_PERCENT))},[Te==null?void 0:Te.ship_percent]),React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-cog me-2 text-warning"}),"C\xE0i \u0111\u1EB7t")),React.createElement("div",{className:"card p-3"},React.createElement("form",{onSubmit:async Ve=>{Ve.preventDefault(),Oe(!0);const Pe=saveAdminSettings({ship_percent:C});try{const Ze=await saveAdminSettingsToServer(Pe);je(Ze),saveAdminSettings(Ze),b("\u0110\xE3 l\u01B0u c\xE0i \u0111\u1EB7t v\xE0o DB","success")}catch(Ze){je(Pe),b("Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c DB, \u0111\xE3 l\u01B0u t\u1EA1m tr\xEAn m\xE1y","warning")}finally{Oe(!1)}}},React.createElement("div",{className:"mb-2 text-muted small"},"\xC1p d\u1EE5ng cho th\u1ED1ng k\xEA hoa h\u1ED3ng khi \u0111\u01A1n h\xE0ng kh\xF4ng ghi ph\xED ship trong ghi ch\xFA s\u1EA3n ph\u1EA9m."),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ph\xED ship (%) khi kh\xF4ng c\xF3 ship"),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",value:C,min:"0",max:"100",step:"0.01",onChange:Ve=>o(Ve.target.value)}),React.createElement("span",{className:"input-group-text"},"%")),React.createElement("div",{className:"form-text"},"M\u1EB7c \u0111\u1ECBnh: ",DEFAULT_SHIP_PERCENT,"%")),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:V},V?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u c\xE0i \u0111\u1EB7t"))))}function ve(){const[C,o]=useState(d()),[V,Oe]=useState(!0),[Ge,Ve]=useState([]),[Pe,Ze]=useState([]),et=useRef(!1),Tt=useRef(new Map),De=normalizeShipPercent(Te==null?void 0:Te.ship_percent),{parseMoney:St,parseShipFeeFromNote:Vt,getShipFeeForItems:bt,formatNumber:ge,formatVND:He}=window.KTM.money,st=async()=>{if(!et.current)try{const T=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i danh s\xE1ch s\u1EA3n ph\u1EA9m");Ze(Array.isArray(T)?T:[]),et.current=!0}catch(T){console.error("Load products for stats error:",T),Ze([]),et.current=!0}},kt=async T=>{var rt,ot;const Ke=String(T||"").trim();if(!Ke)return[];const We=(rt=Tt.current)==null?void 0:rt.get(Ke);if(We&&Array.isArray(We))return We;const Qe=await window.KTM.api.getJSON(`${API_BASE}/api/orders?month=${encodeURIComponent(Ke)}`,"L\u1ED7i t\u1EA3i th\u1ED1ng k\xEA"),tt=Array.isArray(Qe)?Qe:[];return(ot=Tt.current)==null||ot.set(Ke,tt),tt},f=async()=>{Oe(!0);try{await st();const T=await kt(C);Ve(Array.isArray(T)?T:[])}catch(T){console.error("Load stats error:",T),Ve([])}finally{Oe(!1)}};useEffect(()=>{f()},[C]);const R=React.useMemo(()=>{var te;const T={draft:0,pending:0,processing:0,done:0,paid:0,canceled:0,other:0};let Ke=0,We=0,Qe=0,tt=0,rt=0,ot=0,Rt=0,jt=0;const vt=A=>A.customer_id||A.phone||"unknown",At=A=>window.KTM.orders.getOrderItems(A),Ot=new Map,Lt=new Map,Pt=new Map,Dt=5,yt=new Map((Array.isArray(Pe)?Pe:[]).map(A=>{var qe;const J=(qe=A==null?void 0:A.commission_percent)!=null?qe:A==null?void 0:A.commissionPercent,ze=Number(J),ue=Number.isFinite(ze)?Math.max(0,Math.min(100,ze)):Dt;return[String(A==null?void 0:A.id),ue]})),n=A=>{const J=String(A!=null?A:"").trim().toLowerCase();return J==="cancelled"?"canceled":J};for(const A of Ge){const J=n(A==null?void 0:A.status),qe=J==="canceled"||J==="draft",pt=At(A);let Xe=0,Ye=0,dt=0;for(const M of pt){const P=Number((M==null?void 0:M.quantity)||0)||0,U=St(M==null?void 0:M.product_price),ae=P*U,G=String((M==null?void 0:M.product_id)||""),ye=yt.has(G)?yt.get(G):Dt,Ce=(Number(ye)||0)/100;if(Xe+=P,Ye+=ae,dt+=ae*Ce,!qe){const Fe=(M==null?void 0:M.product_id)||"unknown",Je=Ot.get(G)||{product_id:Fe,product_name:(M==null?void 0:M.product_name)||"\u2014",product_code:(M==null?void 0:M.product_code)||"",orders:0,quantity:0,revenue:0};Je.orders+=1,Je.quantity+=P,Je.revenue+=ae,Ot.set(Fe,Je)}}const Kt=bt(pt),Bt=Number((te=A==null?void 0:A.adjustment_amount)!=null?te:0)||0,lt=Ye+(Kt.found?Kt.fee:0)+Bt,Ee=Ye+Bt,Gt=!Kt.found&&De>0&&Ye>0?Ye*De/100:0,Et=Ye>0?dt/Ye:Dt/100,Ft=dt+Bt*Et-Gt*Et,I=J==="done"||J==="paid";if(J==="draft"?T.draft+=1:J==="pending"?T.pending+=1:J==="processing"?T.processing+=1:J==="canceled"?T.canceled+=1:J==="paid"?(T.paid+=1,T.done+=1,tt+=lt,ot+=Ee,jt+=Ft):J==="done"?(T.done+=1,tt+=lt,ot+=Ee,jt+=Ft):T.other+=1,!qe){Ke+=1,We+=Xe,Qe+=lt,rt+=Ee,Rt+=Ft;const M=vt(A),P=Lt.get(M)||{key:M,customer_name:A.customer_name||"",phone:A.phone||"",orders:0,quantity:0,revenue:0};P.orders+=1,P.quantity+=Xe,P.revenue+=lt,!P.customer_name&&A.customer_name&&(P.customer_name=A.customer_name),!P.phone&&A.phone&&(P.phone=A.phone),Lt.set(M,P);const U=A.created_at?new Date(A.created_at):null;if(U&&!Number.isNaN(U.getTime())){const ae=`${U.getFullYear()}-${String(U.getMonth()+1).padStart(2,"0")}-${String(U.getDate()).padStart(2,"0")}`,G=Pt.get(ae)||{day:ae,orders:0,quantity:0,revenue:0,doneOrders:0,doneRevenue:0};G.orders+=1,G.quantity+=Xe,G.revenue+=lt,I&&(G.doneOrders+=1,G.doneRevenue+=lt),Pt.set(ae,G)}}}const y=Array.from(Ot.values()).sort((A,J)=>J.revenue-A.revenue),x=Array.from(Lt.values()).sort((A,J)=>J.revenue-A.revenue),B=Array.from(Pt.values()).sort((A,J)=>A.day.localeCompare(J.day)),ee=Lt.size,j=Ke?Math.round(Qe/Ke):0,m=Ke?We/Ke:0,H=Math.round(jt),se=Math.round(Rt);return{statusCounts:T,activeOrders:Ke,totalQty:We,totalRevenue:Qe,doneRevenue:tt,tempCommission:H,tempCommissionAll:se,products:y,customers:x,days:B,uniqueCustomers:ee,avgOrderValue:j,avgQtyPerOrder:m}},[Ge,Pe,C]);return React.createElement("div",{className:"product-manager pb-5 mb-4 stats-manager"},React.createElement(Loading,{show:V}),React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-chart-column me-2 text-warning"}),"Th\u1ED1ng k\xEA"),React.createElement("button",{className:"btn btn-outline-secondary btn-sm",onClick:f,disabled:V},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"Ch\u1ECDn th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:C,onChange:T=>o(T.target.value),"aria-label":"Ch\u1ECDn th\xE1ng"}))),React.createElement("div",{className:"col-12 col-md-7 d-flex gap-2 justify-content-md-end"},React.createElement("div",{className:"d-flex flex-wrap gap-2 align-self-center"},React.createElement("span",{className:"badge rounded-pill bg-secondary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-truck me-1"}),"Ship \u01B0\u1EDBc t\xEDnh: ",De,"%"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-receipt me-1"}),ge(R.activeOrders)," \u0111\u01A1n"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-user me-1"}),ge(R.uniqueCustomers)," kh\xE1ch"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-boxes-stacked me-1"}),ge(R.totalQty)," SL"),React.createElement("span",{className:"badge rounded-pill bg-primary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-hand-holding-dollar me-1"}),"\u0110\xE3 nh\u1EADn ti\u1EC1n: ",ge(R.statusCounts.paid),"/",ge(R.statusCounts.done)))))),React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng \u0111\u01A1n (kh\xF4ng t\xEDnh h\u1EE7y/nh\xE1p)"),React.createElement("i",{className:"fas fa-receipt text-dark"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},ge(R.activeOrders)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (t\u1EA1m t\xEDnh)"),React.createElement("i",{className:"fas fa-sack-dollar text-warning"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},He(R.totalRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (Ho\xE0n th\xE0nh)"),React.createElement("i",{className:"fas fa-circle-check text-success"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},He(R.doneRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-info bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng s\u1EBD nh\u1EADn (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-chart-line text-info"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},He(R.tempCommission)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng t\u1ED5ng (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-coins text-primary"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},He(R.tempCommissionAll))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-layer-group me-2 text-warning"}),"T\u1ED5ng quan tr\u1EA1ng th\xE1i"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},"SL TB/\u0111\u01A1n: ",R.avgQtyPerOrder?R.avgQtyPerOrder.toFixed(2):"0.00")),React.createElement("div",{className:"d-md-none mt-2"},React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-light bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Nh\xE1p"),React.createElement("div",{className:"fw-semibold"},ge(R.statusCounts.draft)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-secondary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("div",{className:"fw-semibold"},ge(R.statusCounts.pending)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("div",{className:"fw-semibold"},ge(R.statusCounts.processing)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-danger bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"H\u1EE7y \u0111\u01A1n"),React.createElement("div",{className:"fw-semibold"},ge(R.statusCounts.canceled)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh"),React.createElement("div",{className:"fw-semibold"},ge(R.statusCounts.done)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("div",{className:"fw-semibold"},ge(R.statusCounts.paid)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng SL"),React.createElement("div",{className:"fw-semibold"},ge(R.totalQty)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Nh\xE1p"),React.createElement("th",null,"Ch\u1EDD x\u1EED l\xFD"),React.createElement("th",null,"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("th",null,"H\u1EE7y \u0111\u01A1n"),React.createElement("th",null,"Ho\xE0n th\xE0nh"),React.createElement("th",null,"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("th",null,"Kh\xE1c"),React.createElement("th",null,"T\u1ED5ng SL"))),React.createElement("tbody",null,React.createElement("tr",null,React.createElement("td",null,ge(R.statusCounts.draft)),React.createElement("td",null,ge(R.statusCounts.pending)),React.createElement("td",null,ge(R.statusCounts.processing)),React.createElement("td",null,ge(R.statusCounts.canceled)),React.createElement("td",null,ge(R.statusCounts.done)),React.createElement("td",null,ge(R.statusCounts.paid)),React.createElement("td",null,ge(R.statusCounts.other)),React.createElement("td",null,ge(R.totalQty))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-box me-2 text-info"}),"Top s\u1EA3n ph\u1EA9m"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},R.products.slice(0,10).map(T=>React.createElement("div",{key:T.product_id,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-info"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},T.product_name),React.createElement("div",{className:"text-muted small text-truncate"},T.product_code?`#${T.product_code} \u2022 `:"",ge(T.orders)," \u0111\u01A1n \u2022 ",ge(T.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},He(T.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"M\xE3"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,R.products.slice(0,10).map(T=>React.createElement("tr",{key:T.product_id},React.createElement("td",null,T.product_name),React.createElement("td",null,T.product_code||"\u2014"),React.createElement("td",null,ge(T.orders)),React.createElement("td",null,ge(T.quantity)),React.createElement("td",{className:"fw-semibold"},He(T.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-user-group me-2 text-warning"}),"Top kh\xE1ch h\xE0ng"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},R.customers.slice(0,10).map(T=>React.createElement("div",{key:T.key,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-warning"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},T.customer_name||"\u2014"),React.createElement("div",{className:"text-muted small text-truncate"},T.phone||"\u2014"," \u2022 ",ge(T.orders)," \u0111\u01A1n \u2022 ",ge(T.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},He(T.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,R.customers.slice(0,10).map(T=>React.createElement("tr",{key:T.key},React.createElement("td",null,T.customer_name||"\u2014"),React.createElement("td",null,T.phone||"\u2014"),React.createElement("td",null,ge(T.orders)),React.createElement("td",null,ge(T.quantity)),React.createElement("td",{className:"fw-semibold"},He(T.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3 mb-4"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-calendar-day me-2 text-success"}),"Theo ng\xE0y"),React.createElement("span",{className:"badge rounded-pill bg-success bg-opacity-10 text-dark"},"DT (t\u1EA1m t\xEDnh) & ho\xE0n th\xE0nh")),React.createElement("div",{className:"d-md-none mt-2"},R.days.map(T=>React.createElement("div",{key:T.day,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-success"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"fw-semibold"},T.day),React.createElement("div",{className:"text-muted small"},ge(T.orders)," \u0111\u01A1n \u2022 ",ge(T.quantity)," SL"),React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh: ",ge(T.doneOrders)," \u2022 ",He(T.doneRevenue))),React.createElement("div",{className:"fw-semibold text-nowrap"},He(T.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Ng\xE0y"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"DT (t\u1EA1m t\xEDnh)"),React.createElement("th",null,"\u0110\u01A1n ho\xE0n th\xE0nh"),React.createElement("th",null,"DT ho\xE0n th\xE0nh"))),React.createElement("tbody",null,R.days.map(T=>React.createElement("tr",{key:T.day},React.createElement("td",null,T.day),React.createElement("td",null,ge(T.orders)),React.createElement("td",null,ge(T.quantity)),React.createElement("td",{className:"fw-semibold"},He(T.revenue)),React.createElement("td",null,ge(T.doneOrders)),React.createElement("td",{className:"fw-semibold"},He(T.doneRevenue)))))))))}return React.createElement("div",null,React.createElement(Sidebar,{activeMenu:E,onMenuChange:C=>{ie(C),C==="albums"&&(ke(null),h([]),O(null))},onLogout:i,currentUser:X}),React.createElement("div",{className:"main-content"},E==="albums"&&!fe&&React.createElement(AlbumList,{albums:oe,loading:Ae,currentFolder:_e,breadcrumb:Ue,onSelect:z,onCreate:F,onEdit:Q,onDelete:Le,onBack:me}),E==="search"&&React.createElement(SearchCenter,{showToast:b,onNavigate:(C,o,V)=>{ie(C),C==="orders"&&o==="create"&&(W(Date.now()),Ne((V==null?void 0:V.productId)||""))}}),E==="albums"&&fe&&React.createElement(AlbumDetail,{album:fe,parentAlbum:Ue.length>0?Ue[Ue.length-1]:null,onBack:()=>{if(fe.parentId){const C=Ue.findIndex(o=>o.uuid===fe.parentId);C>=0?Me(Ue[C]):Me(null)}else Me(null)},onRefresh:()=>O(_e==null?void 0:_e.uuid),showToast:b,onNavigateToFolder:C=>{h(o=>[...o,fe]),Me(C)},onEditSubfolder:C=>{$e(C),we(!0)}}),E==="videos"&&React.createElement(VideoList,{showToast:b}),E==="products"&&React.createElement(ProductManager,{showToast:b,settings:Te}),E==="orders"&&React.createElement(OrderManager,{autoOpenCreateToken:le,autoOpenCreateProductId:pe,showToast:b}),E==="stats"&&React.createElement(ve,null),E==="settings"&&React.createElement(v,null)),React.createElement("nav",{className:"mobile-bottom-nav"},React.createElement("div",{className:"nav-items"},React.createElement("a",{href:"#",className:`nav-item ${E==="search"?"active":""}`,onClick:C=>{C.preventDefault(),ie("search")}},React.createElement("i",{className:"fas fa-search"}),React.createElement("span",null,"Tra c\u1EE9u")),React.createElement("a",{href:"#",className:`nav-item ${E==="albums"?"active":""}`,onClick:C=>{C.preventDefault(),ie("albums"),Me(null)}},React.createElement("i",{className:"fas fa-images"}),React.createElement("span",null,"Album")),React.createElement("a",{href:"#",className:`nav-item ${E==="videos"?"active":""}`,onClick:C=>{C.preventDefault(),ie("videos")}},React.createElement("i",{className:"fas fa-video"}),React.createElement("span",null,"Video")),React.createElement("a",{href:"#",className:`nav-item ${E==="products"?"active":""}`,onClick:C=>{C.preventDefault(),ie("products")}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",null,"S\u1EA3n ph\u1EA9m")),React.createElement("a",{href:"#",className:`nav-item ${E==="orders"?"active":""}`,onClick:C=>{C.preventDefault(),ie("orders")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",null,"\u0110\u01A1n h\xE0ng")),React.createElement("a",{href:"#",className:`nav-item ${E==="stats"?"active":""}`,onClick:C=>{C.preventDefault(),ie("stats")}},React.createElement("i",{className:"fas fa-chart-column"}),React.createElement("span",null,"Th\u1ED1ng k\xEA")))),React.createElement(AlbumModal,{show:ce,album:be,parentId:_e==null?void 0:_e.uuid,onClose:()=>we(!1),onSave:q}),React.createElement("div",{className:"toast-container"},he.map(C=>React.createElement(Toast,{key:C.id,message:C.message,type:C.type,onClose:()=>_(C.id)}))))}ReactDOM.render(React.createElement(AdminApp,null),document.getElementById("root"));function OrderManager({autoOpenCreateToken:$,autoOpenCreateProductId:k,showToast:L}){const[Y,X]=useState([]),[w,E]=useState([]),[ie,le]=useState(!0),[W,pe]=useState(!1),[Ne,oe]=useState([]),[de,fe]=useState(!1),[Me,ce]=useState(""),[we,be]=useState([]),[$e,Ae]=useState(!1),[Re,he]=useState(""),[re,Te]=useState(!1),[je,_e]=useState(null),[ke,Ue]=useState(null),[h,D]=useState(!1),[i,b]=useState(()=>{const e=new Date,a=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0");return`${a}-${t}`}),[_,O]=useState(""),[F,Q]=useState(!1),[q,z]=useState(!1),[me,Le]=useState(null),[d,v]=useState(!1),[ve,C]=useState([]),[o,V]=useState({customer_name:"",phone:"",address:"",note:"",items:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:[{amount:"",note:""}],adjustment_amount:0,adjustment_note:"",status:"pending"}),[Oe,Ge]=useState([""]),[Ve,Pe]=useState(null),Ze=useRef({}),[et,Tt]=useState([]),[De,St]=useState(null),Vt=useRef(null),bt=useRef(null),ge=useRef(0),He=useRef(null),st=useRef(0),kt=useRef(new Map),f=useRef(new Map),R=useRef(""),T=useRef(null),Ke=useRef(0),We=useRef(null),Qe=9,tt=150,rt=24*60*60*1e3,ot=5*60*1e3,Rt="ktm_customer_lookup_cache_v1",jt=200,vt=3,At=3,Ot=1,Lt=24*60*60*1e3,Pt=120,Dt=5*60*1e3,yt=80,n=2,y=4,x=React.useMemo(()=>String(Me||"").trim().length>0,[Me]),B=e=>String(e||"").replace(/\s+/g," ").trim(),ee=e=>String(e||"").replace(/[^0-9]+/g,""),j=e=>{try{const a=new Date(e==null?void 0:e.created_at).getTime();if(!Number.isFinite(a))return 0;const t=Date.now()-a;return!Number.isFinite(t)||t<=0?0:Math.floor(t/Lt)}catch(a){return 0}},m=e=>String((e==null?void 0:e.status)||"").trim()!=="pending"?!1:j(e)>=vt,H=e=>{const a=String(e!=null?e:"").trim().toLowerCase();return a==="cancelled"?"canceled":a},se=e=>{if(H(e==null?void 0:e.status)!=="draft")return null;const t=At-j(e);return Number.isFinite(t)?t:null},te=e=>{const a=se(e);return Number.isFinite(a)?a>0&&a<=Ot:!1},A=e=>{V({customer_name:"",phone:"",address:"",note:"",items:[{product_id:e||"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:[{amount:"",note:""}],adjustment_amount:0,adjustment_note:"",status:"pending"}),Ge([""]),Le(null),Pe(null)};useEffect(()=>{const e=a=>{var s;if(Ve==null)return;const t=(s=Ze.current)==null?void 0:s[Ve];t&&!t.contains(a.target)&&Pe(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[Ve]);const J=e=>window.KTM.money.parseMoney(e),ze=e=>window.KTM.money.parseSignedMoney(e),ue=e=>window.KTM.money.formatVND(e),qe=e=>{const t=(Array.isArray(e)?e:[]).map(s=>{var l,c;return{amount:String((l=s==null?void 0:s.amount)!=null?l:""),note:String((c=s==null?void 0:s.note)!=null?c:"")}});return t.length?t:[{amount:"",note:""}]},pt=e=>{try{const a=window.KTM.orders.getOrderAdjustmentItems(e),t=(Array.isArray(a)?a:[]).map(s=>{var l,c;return{amount:(s==null?void 0:s.amount)===0?"":String((l=s==null?void 0:s.amount)!=null?l:""),note:String((c=s==null?void 0:s.note)!=null?c:"").trim()}}).filter(s=>String(s.amount||"").trim()||String(s.note||"").trim());return t.length?t:[{amount:"",note:""}]}catch(a){return[{amount:"",note:""}]}},Xe=e=>(Array.isArray(e)?e:[]).map(t=>({amount:ze(t==null?void 0:t.amount),note:String((t==null?void 0:t.note)||"").trim()})).filter(t=>t.amount!==0||!!t.note),Ye=e=>{const a=Array.isArray(e==null?void 0:e.adjustment_items)?e.adjustment_items:[],t=Xe(a),s=dt(t),l=(()=>{if(!t.length)return"";const c=t.map(g=>String((g==null?void 0:g.note)||"").trim()).filter(Boolean);return c.length?c.join(" \u2022 "):t.length>1?`${t.length} m\u1EE5c`:""})();return{cleanAdjItems:t,amount:s,summaryText:l}},dt=e=>(Array.isArray(e)?e:[]).reduce((t,s)=>t+(Number(s==null?void 0:s.amount)||0),0),Kt=e=>{const a=Array.isArray(e)?e:[];return a.length?JSON.stringify(a):""},Bt=e=>window.KTM.money.parseShipFeeFromNote(e),lt=e=>window.KTM.phone.isValid(e),Ee=e=>window.KTM.phone.normalize(e),Gt=()=>{var e;try{const a=localStorage.getItem(Rt);if(!a)return;const t=JSON.parse(a);if(!t||typeof t!="object")return;const s=Object.entries(t);for(const[l,c]of s)!l||!c||typeof c!="object"||(e=f.current)==null||e.set(String(l),c)}catch(a){}},Et=()=>{try{const e=f.current;if(!e||typeof e.entries!="function")return;const a=Array.from(e.entries()).filter(([s,l])=>s&&l&&typeof l=="object"&&Number.isFinite(l.ts)).sort((s,l)=>(Number(l[1].ts)||0)-(Number(s[1].ts)||0)).slice(0,jt),t={};for(const[s,l]of a)t[s]=l;localStorage.setItem(Rt,JSON.stringify(t))}catch(e){}};useEffect(()=>{Gt()},[]);const Ft=e=>{const a=Ee(e);if(!a)return null;const t=Array.isArray(Y)?Y:[];let s=null,l=-1;for(const c of t){if(!c||Ee(c.phone||"")!==a)continue;const g=new Date(c.created_at).getTime(),N=Number.isFinite(g)?g:0;N>=l&&(l=N,s=c)}return s?{name:String(s.customer_name||"").trim(),address:String(s.address||"").trim()}:null},I=(e,a)=>{e&&V(t=>a&&Ee(t.phone)!==a?t:{...t,customer_name:e.name||t.customer_name,address:e.address||t.address})},M=e=>{const a=Ft(e);if(!a)return;const t=Ee(e);V(s=>{if(t&&Ee(s.phone)!==t)return s;const l={...s};return!String(s.customer_name||"").trim()&&a.name&&(l.customer_name=a.name),!String(s.address||"").trim()&&a.address&&(l.address=a.address),l})},P=(e,a,t)=>{var s;try{const l=Ee(e);if(!l)return;const c=String(a||"").trim(),g=String(t||"").trim();if(!c&&!g)return;(s=f.current)==null||s.set(l,{ts:Date.now(),status:"found",customer:{phone:l,name:c||null,address:g||null}}),Et()}catch(l){}},U=async e=>{var l,c,g;const a=Ee(e);if(!a)return;M(a);const t=(l=f.current)==null?void 0:l.get(a);if(t&&Number.isFinite(t.ts)){const N=Date.now()-t.ts,p=t.status==="found"?rt:ot;if(N>=0&&N<=p){Le({status:t.status,phone:a,customer:t.customer}),t.status==="found"&&t.customer&&I(t.customer,a);return}}const s=++ge.current;Le({status:"loading",phone:a});try{const N=await window.KTM.api.getJSON(`${API_BASE}/api/customers?phone=${encodeURIComponent(a)}`,"L\u1ED7i tra c\u1EE9u kh\xE1ch");if(ge.current!==s)return;if(N&&N.exists&&N.customer){(c=f.current)==null||c.set(a,{ts:Date.now(),status:"found",customer:N.customer}),Et(),Le({status:"found",phone:a,customer:N.customer}),I(N.customer,a);return}(g=f.current)==null||g.set(a,{ts:Date.now(),status:"not-found",customer:null}),Et(),Le({status:"not-found",phone:a})}catch(N){if(ge.current!==s)return;console.error("Customer lookup error:",N),Le({status:"error",phone:a})}},ae=e=>{const a=Ee(e),t=Ft(a);V(l=>{const c={...l,phone:a};return t&&(!String(l.customer_name||"").trim()&&t.name&&(c.customer_name=t.name),!String(l.address||"").trim()&&t.address&&(c.address=t.address)),c}),v(!1),bt.current&&(clearTimeout(bt.current),bt.current=null);const s=a;if(s.length<Qe){Le(null);return}if(lt(s)&&s!==R.current){R.current=s,U(s);return}bt.current=setTimeout(()=>{const l=Ee(a);lt(l)&&l!==R.current&&(R.current=l,U(l))},tt)},G=()=>{const e=Ee(o.phone);e.length<Qe||lt(e)&&e!==R.current&&(R.current=e,U(e))};useEffect(()=>(q?(document.body.classList.add("order-modal-open"),document.body.style.overflow="hidden"):(document.body.classList.remove("order-modal-open"),document.body.style.overflow=""),()=>{document.body.classList.remove("order-modal-open"),document.body.style.overflow=""}),[q]);const ye=Array.isArray(o.items)?o.items.length:0;useEffect(()=>{if(!q){Ke.current=ye;return}ye>Ke.current&&setTimeout(()=>{const e=T.current;e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},0),Ke.current=ye},[q,ye]),useEffect(()=>()=>{bt.current&&(clearTimeout(bt.current),bt.current=null)},[]),useEffect(()=>{Ht()},[]),useEffect(()=>{x||wt()},[i,x]),useEffect(()=>{Xt()},[]),useEffect(()=>{$&&Vt.current!==$&&(Vt.current=$,ba(k))},[$]);const Ce=e=>e==="draft"?"\u0110\u01A1n nh\xE1p":e==="pending"?"Ch\u1EDD x\u1EED l\xFD":e==="processing"?"\u0110ang v\u1EADn chuy\u1EC3n":e==="done"?"Ho\xE0n th\xE0nh":e==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":e==="cancelled"||e==="canceled"?"H\u1EE7y \u0111\u01A1n":e||"",Fe=e=>e==="draft"?"bg-light text-dark":e==="pending"?"bg-secondary":e==="processing"?"bg-warning text-dark":e==="done"?"bg-success":e==="paid"?"bg-primary":e==="cancelled"||e==="canceled"?"bg-danger":"bg-light text-dark",Je=React.useMemo(()=>window.KTM.orders.sortOrders(Y),[Y]),at=React.useMemo(()=>window.KTM.orders.sortOrders(w),[w]),mt=React.useMemo(()=>{const a=(Array.isArray(at)?at:[]).filter(t=>m(t));return a.sort((t,s)=>{const l=new Date(t==null?void 0:t.created_at).getTime(),c=new Date(s==null?void 0:s.created_at).getTime();return(Number.isFinite(l)?l:0)-(Number.isFinite(c)?c:0)}),a},[at]),ft=React.useMemo(()=>{const a=(Array.isArray(Ne)?Ne:[]).filter(t=>te(t));return a.sort((t,s)=>{const l=new Date(t==null?void 0:t.created_at).getTime(),c=new Date(s==null?void 0:s.created_at).getTime();return(Number.isFinite(l)?l:0)-(Number.isFinite(c)?c:0)}),a},[Ne]),ut=React.useMemo(()=>F?mt:Je,[F,mt,Je]),ht=React.useMemo(()=>{if(F)return ut;const e=String(_||"").trim();return e?(Array.isArray(ut)?ut:[]).filter(a=>String((a==null?void 0:a.status)||"").trim()===e):ut},[ut,_,F]),Ct=React.useMemo(()=>window.KTM.orders.sortOrders(we),[we]),gt=React.useMemo(()=>x?Ct:ht,[ht,x,Ct]),Nt=e=>window.KTM.date.formatDateTime(e),Ht=async()=>{try{const e=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");Tt(Array.isArray(e)?e:[])}catch(e){console.error("Load products error:",e),Tt([])}},wt=async()=>{le(!0);try{let e=`${API_BASE}/api/orders`;i&&(e+=`?month=${i}`);const a=await window.KTM.api.getJSON(e,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng");X(Array.isArray(a)?a:[]),Xt()}catch(e){console.error("Load orders error:",e),X([])}finally{le(!1)}},Wt=async e=>{var l;const a=B(e);if(!a){be([]),he(""),Ae(!1);return}const t=ee(a);if(a.length<n&&t.length<y){be([]),he(`Nh\u1EADp \xEDt nh\u1EA5t ${n} k\xFD t\u1EF1 (ho\u1EB7c ${y} s\u1ED1) \u0111\u1EC3 search nhanh`),Ae(!1);return}try{const c=(l=kt.current)==null?void 0:l.get(a);if(c&&Number.isFinite(c.ts)&&Date.now()-c.ts<=Dt){be(Array.isArray(c.results)?c.results:[]),he(""),Ae(!1);return}}catch(c){}const s=++st.current;Ae(!0),he("");try{const c=`${API_BASE}/api/orders?search=${encodeURIComponent(a)}`,g=await window.KTM.api.getJSON(c,"L\u1ED7i search \u0111\u01A1n h\xE0ng");if(st.current!==s)return;const N=Array.isArray(g)?g:[];be(N);try{const p=kt.current;if(p&&typeof p.set=="function"&&(p.set(a,{ts:Date.now(),results:N}),p.size>yt)){const r=Array.from(p.entries()).sort((S,K)=>{var ne,Z;return(Number((ne=S==null?void 0:S[1])==null?void 0:ne.ts)||0)-(Number((Z=K==null?void 0:K[1])==null?void 0:Z.ts)||0)}),u=Math.max(0,r.length-yt);for(let S=0;S<u;S++)p.delete(r[S][0])}}catch(p){}}catch(c){if(st.current!==s)return;console.error("Order search error:",c),be([]),he((c==null?void 0:c.message)||"Search l\u1ED7i")}finally{if(st.current!==s)return;Ae(!1)}};useEffect(()=>{He.current&&(clearTimeout(He.current),He.current=null);const e=B(Me);if(!e){be([]),he(""),Ae(!1);return}return F&&Q(!1),He.current=setTimeout(()=>{Wt(e)},Pt),()=>{He.current&&(clearTimeout(He.current),He.current=null)}},[Me]);const Xt=async()=>{pe(!0),fe(!0);try{const[e,a]=await Promise.all([window.KTM.api.getJSON(`${API_BASE}/api/orders?overdue=1&days=${encodeURIComponent(vt)}`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),window.KTM.api.getJSON(`${API_BASE}/api/orders?draftExpiring=1&remainingDays=${encodeURIComponent(Ot)}`,"L\u1ED7i t\u1EA3i \u0111\u01A1n nh\xE1p")]);E(Array.isArray(e)?e:[]),oe(Array.isArray(a)?a:[])}catch(e){console.error("Load all orders error:",e),E([]),oe([])}finally{pe(!1),fe(!1)}},Jt=e=>{St(e.id);const a=Array.isArray(e.items)&&e.items.length?e.items.map(g=>{var N,p,r,u;return{product_id:(g==null?void 0:g.product_id)||"",quantity:Number((N=g==null?void 0:g.quantity)!=null?N:1)||1,unit_price:(()=>{var ne;const S=(ne=g==null?void 0:g.unit_price)!=null?ne:g==null?void 0:g.unitPrice,K=S==null||S===""?NaN:Number(S);return Number.isFinite(K)?Math.trunc(K):null})(),variant:String((p=g==null?void 0:g.variant)!=null?p:"").trim(),variant_json:(u=(r=g==null?void 0:g.variant_json)!=null?r:g==null?void 0:g.variantJson)!=null?u:null}}).filter(g=>g.product_id):[{product_id:e.product_id||"",quantity:Number(e.quantity||1)||1,unit_price:null,variant:"",variant_json:null}],t=pt(e),s=Xe(t),l=dt(s),c=Kt(s);V({customer_name:e.customer_name||"",phone:Ee(e.phone||""),address:e.address||"",note:(e==null?void 0:e.note)||"",items:a.length?a:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:t,adjustment_amount:l,adjustment_note:c||(e==null?void 0:e.adjustment_note)||"",status:e.status||"pending"}),Ge(new Array(a.length?a.length:1).fill("")),C(new Array(a.length?a.length:1).fill(!0)),Le(null),z(!0),e.phone&&U(Ee(e.phone))};function ba(e){St(null),A(e||""),v(!1),C([]),z(!0)}const ra=()=>{re||h||(z(!1),St(null),A(""),v(!1),C([]))},Ca=async()=>{var N,p,r;if(!De||h||re)return;const e=(Array.isArray(Y)?Y:[]).find(u=>String(u==null?void 0:u.id)===String(De))||null,a=String((e==null?void 0:e.status)||(o==null?void 0:o.status)||"").trim();if(a==="done"||a==="paid"||a==="canceled"){const u="Kh\xF4ng th\u1EC3 t\xE1ch: \u0111\u01A1n \u0111\xE3 ho\xE0n th\xE0nh/\u0111\xE3 nh\u1EADn ti\u1EC1n/\u0111\xE3 h\u1EE7y.";typeof L=="function"?L(u,"warning"):alert(u);return}const t=Ee(o.phone),l=(Array.isArray(o.items)?o.items:[]).map((u,S)=>{var K,ne;return{idx:S,product_id:String((u==null?void 0:u.product_id)||"").trim(),quantity:Number((K=u==null?void 0:u.quantity)!=null?K:0),variant:String((u==null?void 0:u.variant)||"").trim()||null,variant_json:(ne=u==null?void 0:u.variant_json)!=null?ne:null,unit_price:(()=>{const Z=u==null?void 0:u.unit_price,xe=Z===""||Z==null?NaN:Number(Z);if(Number.isFinite(xe))return Math.max(0,Math.trunc(xe));const Se=Mt(u==null?void 0:u.product_id),nt=u!=null&&u.variant_json&&typeof u.variant_json=="object"?u.variant_json:null;return Zt(Se,nt)})()}}).filter(u=>u.product_id&&Number.isFinite(u.quantity)&&u.quantity>0);if(l.length<2){const u="C\u1EA7n \xEDt nh\u1EA5t 2 s\u1EA3n ph\u1EA9m \u0111\u1EC3 t\xE1ch \u0111\u01A1n.";typeof L=="function"?L(u,"warning"):alert(u);return}const c=[],g=[];for(const u of l){const S=!!ve[u.idx],K={product_id:u.product_id,quantity:u.quantity,unit_price:u.unit_price,variant:u.variant,variant_json:u.variant_json};S?c.push(K):g.push(K)}if(!c.length||!g.length){const u="Ch\u1ECDn m\u1ED9t s\u1ED1 s\u1EA3n ph\u1EA9m \u201CGiao \u0111\u1EE3t 1\u201D, v\xE0 \u0111\u1EC3 l\u1EA1i \xEDt nh\u1EA5t 1 s\u1EA3n ph\u1EA9m \u201CCh\u1EDD h\xE0ng\u201D.";typeof L=="function"?L(u,"warning"):alert(u);return}D(!0);try{const u=Array.isArray(o==null?void 0:o.adjustment_items)?o.adjustment_items:[],S=Xe(u),K=dt(S),ne=Kt(S),Z={customer_name:o.customer_name,phone:t,address:o.address,note:(o.note||"").trim(),adjustment_amount:K,adjustment_note:ne,adjustment_items:S,status:"processing",items:c,product_id:c[0].product_id,quantity:c[0].quantity,split_seq:1},xe=await window.KTM.api.postJSON(`${API_BASE}/api/orders`,Z,"L\u1ED7i t\xE1ch \u0111\u01A1n (t\u1EA1o \u0111\u01A1n giao ngay)"),Se=(r=(p=xe==null?void 0:xe.id)!=null?p:(N=xe==null?void 0:xe.order)==null?void 0:N.id)!=null?r:null;if(!Se)throw new Error("T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i: kh\xF4ng nh\u1EADn \u0111\u01B0\u1EE3c ID \u0111\u01A1n giao ngay");const nt={id:De,customer_name:o.customer_name,phone:t,address:o.address,note:(o.note||"").trim(),adjustment_amount:0,adjustment_note:"",adjustment_items:[],status:"pending",items:g,product_id:g[0].product_id,quantity:g[0].quantity,parent_order_id:String(Se),split_seq:2};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${De}`,nt,"L\u1ED7i t\xE1ch \u0111\u01A1n (c\u1EADp nh\u1EADt ph\u1EA7n ch\u1EDD h\xE0ng)"),ra(),wt();const it=Se?`\u0110\xE3 t\xE1ch \u0111\u01A1n. \u0110\u01A1n giao ngay: #${Se}`:"\u0110\xE3 t\xE1ch \u0111\u01A1n.";typeof L=="function"?L(it,"success"):alert(it)}catch(u){console.error(u);const S=(u==null?void 0:u.message)||"T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i";typeof L=="function"?L(S,"danger"):alert(S)}finally{D(!1)}},Aa=e=>{if(!e)return"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --";const a=String(e),t=et.find(s=>String(s==null?void 0:s.id)===a);return t?`${t.name}${t.code?` (${t.code})`:""}`:"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"},_t=e=>{try{return String(e!=null?e:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(a){return String(e!=null?e:"").toLowerCase()}},_a=e=>{const t=_t(e).trim().split(/\s+/).filter(Boolean),s=t.join(" ");return{contentTokens:t,cleanedQuery:s}},fa=React.useMemo(()=>(Array.isArray(et)?et:[]).map((e,a)=>{var r,u,S,K,ne,Z;const t=_t((r=e==null?void 0:e.name)!=null?r:""),s=_t((u=e==null?void 0:e.code)!=null?u:""),l=_t((S=e==null?void 0:e.category)!=null?S:""),c=_t((K=e==null?void 0:e.note)!=null?K:""),g=_t((ne=e==null?void 0:e.id)!=null?ne:""),N=_t((Z=e==null?void 0:e.stt)!=null?Z:""),p=`${t} ${s} ${l} ${c} ${g} ${N}`.trim();return{p:e,originalIndex:a,name:t,code:s,category:l,note:c,haystackAll:p}}),[et]),Ma=(e,a,t)=>{var S,K,ne,Z,xe;const s=Array.isArray(a)?a:[],l=_t(t).trim();if(!s.length&&!l)return 0;const c=(S=e==null?void 0:e.name)!=null?S:"",g=(K=e==null?void 0:e.code)!=null?K:"",N=(ne=e==null?void 0:e.category)!=null?ne:"",p=(Z=e==null?void 0:e.note)!=null?Z:"";if(!((xe=e==null?void 0:e.haystackAll)!=null?xe:""))return 0;let u=0;l&&(c===l&&(u+=220),c.includes(l)&&(u+=140),c.startsWith(l)&&(u+=160),g&&g===l&&(u+=180),g&&g.includes(l)&&(u+=90));for(const Se of s){if(!Se)continue;const nt=new RegExp(`(?:^|\\s)${Se.replace(/[.*+?^${}()|[\[\]\\]/g,"\\$&")}`);c.includes(Se)&&(u+=35),nt.test(c)&&(u+=25),g&&g.includes(Se)&&(u+=20),g&&nt.test(g)&&(u+=10),N&&N.includes(Se)&&(u+=12),p&&p.includes(Se)&&(u+=6)}return u>0&&c&&(u+=Math.max(0,10-Math.min(10,Math.floor(c.length/10)))),u},oa=(e,a)=>{const t=String(e||""),s=String(a||"");if(t===s)return 0;if(!t)return s.length;if(!s)return t.length;const l=t.length,c=s.length;if(c>l)return oa(s,t);let g=new Array(c+1),N=new Array(c+1);for(let p=0;p<=c;p++)g[p]=p;for(let p=1;p<=l;p++){N[0]=p;const r=t.charCodeAt(p-1);for(let S=1;S<=c;S++){const K=r===s.charCodeAt(S-1)?0:1;N[S]=Math.min(g[S]+1,N[S-1]+1,g[S-1]+K)}const u=g;g=N,N=u}return g[c]},$a=(e,a)=>{const t=String(e||"").trim(),s=String(a||"");if(!t||!s)return!1;if(s.includes(t))return!0;const l=s.split(/\s+/).filter(Boolean);if(!l.length)return!1;const c=t.length<=4?1:2;for(const g of l)if(!(Math.abs(g.length-t.length)>c)&&oa(t,g)<=c)return!0;return!1},Yt=e=>{const a=_t(e).replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim();return a?a.split(" ").filter(Boolean):[]},Ta=(e,a)=>{const t=Array.isArray(a)?a:[];if(!t.length)return 0;const s=Yt((e==null?void 0:e.name)||""),l=Yt((e==null?void 0:e.code)||""),c=Yt((e==null?void 0:e.category)||""),g=Yt((e==null?void 0:e.note)||""),N=(r,u,S)=>{const K=String(r||"").trim();if(!K||!u.length)return 0;const ne=K.length<=4?1:2;let Z=1/0,xe=-1;for(let it=0;it<u.length;it++){const xt=u[it];if(!xt||Math.abs(xt.length-K.length)>ne)continue;const Be=oa(K,xt);if(Be<Z&&(Z=Be,xe=it,Be===0))break}if(Z===1/0||Z>ne)return 0;let nt=Math.round(S*(Z===0?1:Z===1?.65:.45));return xe===0?nt+=Math.round(S*.25):xe===1&&(nt+=Math.round(S*.12)),nt};let p=0;for(const r of t){if(!r)continue;const u=N(r,s,180),S=N(r,l,120),K=N(r,c,60),ne=N(r,g,30);p+=Math.max(u,S,K,ne)}if(p>0){const r=((e==null?void 0:e.name)||"").length;p+=Math.max(0,60-Math.min(60,Math.floor(r/2)))}return p},la=React.useRef(new Map);React.useEffect(()=>{la.current=new Map},[et]);const ja=e=>{var r,u;const a=String(Oe[e]||"").trim();if(!a)return et;const{contentTokens:t,cleanedQuery:s}=_a(a);if(t.length===0)return et;const l=_t(a).trim(),c=la.current.get(l);if(c)return c;const g=[];for(const S of fa){const K=S.haystackAll;K&&t.some(ne=>K.includes(ne))&&g.push(S)}let N=g;if(N.length<8&&t.length>0){const S=[],K=new Set(N.map(ne=>{var Z,xe;return String((xe=(Z=ne.p)==null?void 0:Z.id)!=null?xe:"")+":"+String(ne.originalIndex)}));for(const ne of fa){const Z=String((u=(r=ne.p)==null?void 0:r.id)!=null?u:"")+":"+String(ne.originalIndex);if(K.has(Z))continue;const xe=ne.haystackAll;xe&&t.some(Se=>$a(Se,xe))&&(S.push(ne),K.add(Z))}S.length&&(N=N.concat(S))}const p=N.map(S=>({entry:S,score:Ma(S,t,s)})).map(S=>{if(S.score>0)return S;const K=Ta(S.entry,t);return K>0?{...S,score:K}:S}).filter(S=>S.score>0).sort((S,K)=>K.score!==S.score?K.score-S.score:S.entry.originalIndex-K.entry.originalIndex).slice(0,40).map(S=>S.entry.p);return la.current.set(l,p),p},Mt=e=>{if(!e)return null;const a=String(e);return et.find(t=>String(t==null?void 0:t.id)===a)||null},Qt=e=>{if(e==null||e==="")return[];let a=e;if(typeof a=="string"){const t=a.trim();if(!t)return[];try{a=JSON.parse(t)}catch(s){return[]}}return Array.isArray(a)?a.map((t,s)=>{var g;if(!t||typeof t!="object")return null;const l=String((g=t.name)!=null?g:"").trim()||`Bi\u1EBFn th\u1EC3 ${s+1}`,c=(Array.isArray(t.options)?t.options:[]).map(N=>{var xe,Se,nt,it,xt,Be,$t;if(!N||typeof N!="object")return null;const p=String((xe=N.label)!=null?xe:"").trim();if(!p)return null;const r=(xt=(it=(nt=(Se=N.price)!=null?Se:N.priceValue)!=null?nt:N.unit_price)!=null?it:N.unitPrice)!=null?xt:null,u=r==null||r===""?NaN:typeof r=="number"?r:typeof r=="string"?J(r):Number(r),S=Number.isFinite(u)?Math.trunc(u):null,K=($t=(Be=N.price_delta)!=null?Be:N.priceDelta)!=null?$t:null,ne=Number(K),Z=Number.isFinite(ne)?Math.trunc(ne):0;return{label:p,price:S,price_delta:Z}}).filter(Boolean);return{name:l,options:c}}).filter(Boolean):[]},Ea=e=>{const a=Mt(e);return Qt(a==null?void 0:a.variants)},ga=e=>{if(!e||typeof e!="object")return"";const a=[];for(const[t,s]of Object.entries(e)){const l=String(t||"").trim(),c=String(s||"").trim();!l||!c||a.push(`${l}: ${c}`)}return a.join(", ")},Zt=(e,a)=>{const t=J(e==null?void 0:e.price),s=Qt(e==null?void 0:e.variants);if(!s.length||!a||typeof a!="object")return t;let l=t,c=!1;for(const g of s){const N=String((g==null?void 0:g.name)||"").trim(),p=String((a==null?void 0:a[N])||"").trim();if(!N||!p)continue;const r=(Array.isArray(g.options)?g.options:[]).find(Z=>String((Z==null?void 0:Z.label)||"").trim()===p);if(!r)continue;const u=r==null?void 0:r.price,S=u==null||u===""?NaN:Number(u);if(Number.isFinite(S)){l=Math.max(0,Math.trunc(S)),c=!0;continue}const K=r==null?void 0:r.price_delta,ne=K==null||K===""?NaN:Number(K);Number.isFinite(ne)&&(l+=Math.trunc(ne))}return l},ca=e=>window.KTM.orders.getOrderItems(e),Oa=e=>window.KTM.orders.getOrderTotalQty(e),ea=e=>window.KTM.orders.getOrderProductSummary(e,Mt),da=e=>window.KTM.orders.getOrderItemRows(e,Mt),ma=e=>window.KTM.orders.getOrderAdjustmentMoney(e),ta=e=>window.KTM.orders.getOrderAdjustmentSummaryText(e),Da=e=>{const a=ca(e),t=da(e),s=na(a),l=aa(a),c=l.fee,g=ma(e),N=s+c+g,p=u=>{const S=Number(u)||0;return S>0?`+${ue(S)}`:ue(S)},r=[];if(e!=null&&e.customer_name&&r.push(`KH\xC1CH: ${e.customer_name}`),e!=null&&e.phone&&r.push(`S\u0110T: ${e.phone}`),e!=null&&e.address&&r.push(`\u0110\u1ECAA CH\u1EC8: ${e.address}`),((e==null?void 0:e.note)||"").trim()&&r.push(`GHI CH\xDA: ${(e.note||"").trim()}`),r.push(""),r.push("S\u1EA2N PH\u1EA8M:"),t.length)for(const u of t)r.push(`- ${u.name} (SL: ${u.qty})`);else{const u=ea(e);u&&u!=="\u2014"&&r.push(`- ${u}`)}r.push(""),r.push(`T\u1EA0M T\xCDNH: ${ue(s)}`),l.found&&c!==0&&r.push(`SHIP: ${ue(c)}`);{const u=window.KTM.orders.getOrderAdjustmentItems(e),S=(Array.isArray(u)?u:[]).map(Z=>{var xe;return{amount:Number((xe=Z==null?void 0:Z.amount)!=null?xe:0)||0,note:String((Z==null?void 0:Z.note)||"").trim()}}).filter(Z=>Z.amount!==0||!!Z.note),K=ta(e);if(g!==0||S.length>0||!!K)if(S.length===1){const Z=S[0];r.push(`\u0110I\u1EC0U CH\u1EC8NH: ${p(g)}${Z.note?` \u2014 ${Z.note}`:""}`)}else{r.push(`\u0110I\u1EC0U CH\u1EC8NH: ${p(g)}${!S.length&&K?` \u2014 ${K}`:""}`);for(const Z of S)r.push(`- ${p(Z.amount)}${Z.note?`: ${Z.note}`:""}`)}}return r.push(`T\u1ED4NG: ${ue(N)}`),r.filter(Boolean).join(`
`)},va=async e=>{try{const a=Da(e);await window.KTM.clipboard.writeText(a),typeof L=="function"?L("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng","success"):alert("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng")}catch(a){console.error(a),typeof L=="function"?L("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)","danger"):alert("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)")}},aa=e=>window.KTM.orders.getOrderShipInfo(e,Mt),na=e=>window.KTM.orders.getItemsSubtotal(e,Mt),ua=e=>{try{const a=e instanceof Date?e:new Date(e);if(!a||Number.isNaN(a.getTime()))return"";const t=a.getFullYear(),s=String(a.getMonth()+1).padStart(2,"0");return`${t}-${s}`}catch(a){return""}},pa=()=>i?String(i):ua(new Date),ya=e=>{const a=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),t=Ee((e==null?void 0:e.phone)||""),s=String((e==null?void 0:e.address)||"").trim().toLowerCase(),l=Ye(e).amount,g=(Array.isArray(e==null?void 0:e.items)?e.items:[]).map(N=>{var p;return{product_id:String((N==null?void 0:N.product_id)||"").trim(),quantity:Number((p=N==null?void 0:N.quantity)!=null?p:0),variant:String((N==null?void 0:N.variant)||"").trim()}}).filter(N=>N.product_id&&Number.isFinite(N.quantity)&&N.quantity>0).sort((N,p)=>N.product_id<p.product_id?-1:N.product_id>p.product_id?1:N.variant<p.variant?-1:N.variant>p.variant?1:N.quantity-p.quantity);return JSON.stringify({name:a,phone:t,address:s,items:g,adj:l})},It=React.useMemo(()=>{const e=Ee((o==null?void 0:o.phone)||"");if(!e)return{count:0,orders:[],monthKey:pa()};const a=pa(),t=(Array.isArray(Y)?Y:[]).filter(s=>{if(!s||De&&String(s.id)===String(De)||Ee(s.phone||"")!==e)return!1;const l=ua(s.created_at);return l&&l===a}).sort((s,l)=>{const c=new Date(s.created_at).getTime(),g=new Date(l.created_at).getTime();return(Number.isFinite(g)?g:0)-(Number.isFinite(c)?c:0)});return{count:t.length,orders:t,monthKey:a}},[Y,o==null?void 0:o.phone,i,De]),Ia=e=>{var N;const a=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),t=Ee((e==null?void 0:e.phone)||""),s=String((e==null?void 0:e.address)||"").trim().toLowerCase(),l=ze((N=e==null?void 0:e.adjustment_amount)!=null?N:0),c=ca(e),g=(Array.isArray(c)?c:[]).map(p=>{var r;return{product_id:String((p==null?void 0:p.product_id)||"").trim(),quantity:Number((r=p==null?void 0:p.quantity)!=null?r:0),variant:String((p==null?void 0:p.variant)||"").trim()}}).filter(p=>p.product_id&&Number.isFinite(p.quantity)&&p.quantity>0).sort((p,r)=>p.product_id<r.product_id?-1:p.product_id>r.product_id?1:p.variant<r.variant?-1:p.variant>r.variant?1:p.quantity-r.quantity);return JSON.stringify({name:a,phone:t,address:s,items:g,adj:l})},Na=React.useMemo(()=>{if(De)return"";const e=Ee((o==null?void 0:o.phone)||"");if(!e)return"";const a=pa(),t=ya(o),s=Array.isArray(Y)?Y:[];for(const l of s){if(!l||De&&String(l.id)===String(De)||Ee(l.phone||"")!==e)continue;const c=ua(l.created_at);if(!c||c!==a)continue;const g=Ia(l);if(g&&g===t)return`\u0110\u01A1n n\xE0y gi\u1ED1ng 100% m\u1ED9t \u0111\u01A1n trong th\xE1ng ${a}${l!=null&&l.id?` (#${l.id})`:""}`}return""},[Y,o,i,De]),wa=e=>{var xt;const a=[],t=[],s=String((e==null?void 0:e.customer_name)||"").trim(),l=Ee((e==null?void 0:e.phone)||""),c=String((e==null?void 0:e.address)||"").trim();s||a.push("Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng"),l||a.push("Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i"),l&&!lt(l)&&a.push("S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)"),c||t.push("Thi\u1EBFu \u0111\u1ECBa ch\u1EC9");const N=(Array.isArray(e==null?void 0:e.items)?e.items:[]).filter(Be=>Be&&Be.product_id);N.length===0&&a.push("Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m"),N.some(Be=>{var zt;const $t=Number((zt=Be==null?void 0:Be.quantity)!=null?zt:0);return!Number.isFinite($t)||$t<=0})&&a.push("S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0");const r=new Set;let u=!1;for(const Be of N){const $t=String(Be.product_id||"").trim(),zt=String((Be==null?void 0:Be.variant)||"").trim();if(!$t)continue;const Ie=`${$t}||${zt}`;if(r.has(Ie)){u=!0;break}r.add(Ie)}u&&t.push("S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)");const S=na(N),K=aa(N),ne=K!=null&&K.found?Number((xt=K==null?void 0:K.fee)!=null?xt:0):0,Z=Array.isArray(e==null?void 0:e.adjustment_items)?e.adjustment_items:[],xe=Xe(Z),Se=dt(xe),nt=xe.some(Be=>(Number(Be==null?void 0:Be.amount)||0)!==0&&!String((Be==null?void 0:Be.note)||"").trim());K!=null&&K.found&&(ne>=2e5||S>0&&ne>S*.6)&&t.push(`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${ue(ne)}`),nt&&t.push("C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh");const it=Math.abs(Se);return(it>=5e5||S>0&&it>S*.5)&&Se!==0&&t.push(`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${ue(Se)}`),{errors:a,warnings:t,canSubmit:a.length===0}},Fa=React.useMemo(()=>wa(o),[o,et]),ct=React.useMemo(()=>{var zt;const e=String((o==null?void 0:o.customer_name)||"").trim(),a=Ee((o==null?void 0:o.phone)||""),t=String((o==null?void 0:o.address)||"").trim(),s=Array.isArray(o==null?void 0:o.items)?o.items:[],l=new Map;for(const Ie of s){const Ut=String((Ie==null?void 0:Ie.product_id)||"").trim(),sa=String((Ie==null?void 0:Ie.variant)||"").trim();if(!Ut)continue;const ia=`${Ut}||${sa}`;l.set(ia,(l.get(ia)||0)+1)}const c=s.map(Ie=>{var ka;const Ut=String((Ie==null?void 0:Ie.product_id)||"").trim(),sa=Number((ka=Ie==null?void 0:Ie.quantity)!=null?ka:0),ia=Ut?"":"Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m",Ra=Number.isFinite(sa)&&sa>0?"":"S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0",La=String((Ie==null?void 0:Ie.variant)||"").trim(),Pa=`${Ut}||${La}`,Ka=Ut&&(l.get(Pa)||0)>1?"S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)":"";return{productError:ia,qtyError:Ra,dupWarn:Ka}}),g=s.filter(Ie=>Ie&&Ie.product_id),N=na(g),p=aa(g),r=p!=null&&p.found?Number((zt=p==null?void 0:p.fee)!=null?zt:0):0,u=Array.isArray(o==null?void 0:o.adjustment_items)?o.adjustment_items:[],S=Xe(u),K=dt(S),ne=S.some(Ie=>(Number(Ie==null?void 0:Ie.amount)||0)!==0&&!String((Ie==null?void 0:Ie.note)||"").trim()),Z=Math.abs(K),xe=ne?"C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh":"",Se=K!==0&&(Z>=5e5||N>0&&Z>N*.5)?`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${ue(K)}`:"",nt=p!=null&&p.found&&(r>=2e5||N>0&&r>N*.6)?`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${ue(r)}`:"",it=e?"":"Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng",xt=a?lt(a)?"":"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)":"Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",Be=t?"":"Thi\u1EBFu \u0111\u1ECBa ch\u1EC9",$t=!it&&!xt&&c.every(Ie=>!Ie.productError&&!Ie.qtyError);return{nameError:it,phoneError:xt,addressWarn:Be,items:c,shipAbnormalWarn:nt,adjustmentNoteWarn:xe,adjustmentAbnormalWarn:Se,canSubmit:$t}},[o,et]),xa=async e=>{var g,N,p;const a=(e==null?void 0:e.mode)||"close",t=wa(o);if(!t.canSubmit){const r=t.errors[0]||"Thi\u1EBFu d\u1EEF li\u1EC7u b\u1EAFt bu\u1ED9c";typeof L=="function"?L(r,"danger"):alert(r);return}if(!De&&Na){const r=`${Na}

B\u1EA1n c\xF3 mu\u1ED1n ti\u1EBFp t\u1EE5c l\u01B0u kh\xF4ng?`;if(!window.confirm(r)){(It==null?void 0:It.count)>0&&v(!0),setTimeout(()=>{var K;const S=document.getElementById("order-phone-input");S&&typeof S.scrollIntoView=="function"&&(S.scrollIntoView({block:"center",behavior:"smooth"}),(K=S.focus)==null||K.call(S))},0);return}}const s=Ee(o.phone),c=(Array.isArray(o.items)?o.items:[]).map(r=>{var u,S;return{product_id:(r==null?void 0:r.product_id)||"",quantity:Number((u=r==null?void 0:r.quantity)!=null?u:1),variant:String((r==null?void 0:r.variant)||"").trim()||null,variant_json:(S=r==null?void 0:r.variant_json)!=null?S:null,unit_price:(()=>{const K=r==null?void 0:r.unit_price,ne=K===""||K==null?NaN:Number(K);if(Number.isFinite(ne))return Math.max(0,Math.trunc(ne));const Z=Mt(r==null?void 0:r.product_id),xe=r!=null&&r.variant_json&&typeof r.variant_json=="object"?r.variant_json:null;return Zt(Z,xe)})()}}).filter(r=>r.product_id&&Number.isFinite(r.quantity)&&r.quantity>0);Te(!0);try{const r=De?`${API_BASE}/api/orders/${De}`:`${API_BASE}/api/orders`,u=c[0],S=Array.isArray(o==null?void 0:o.adjustment_items)?o.adjustment_items:[],K=Xe(S),ne=dt(K),Z=Kt(K),xe={customer_name:o.customer_name,phone:s,address:o.address,note:(o.note||"").trim(),adjustment_amount:ne,adjustment_note:Z,adjustment_items:K,product_id:u.product_id,quantity:u.quantity,status:o.status,items:c,...De?{id:De}:{}};if(De)await window.KTM.api.putJSON(r,xe,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");else{const Se=await window.KTM.api.postJSON(r,xe,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");We.current={id:(p=(N=Se==null?void 0:Se.id)!=null?N:(g=Se==null?void 0:Se.order)==null?void 0:g.id)!=null?p:null,fingerprint:ya(o),ts:Date.now()}}P(s,o.customer_name,o.address),a==="new"&&!De?(A(""),St(null),z(!0)):(A(""),St(null),z(!1)),wt()}catch(r){console.error(r),typeof L=="function"?L(r.message,"danger"):alert(r.message);return}finally{Te(!1)}},ha=e=>window.KTM.orders.getOrderTotalMoney(e,Mt),Sa=async e=>{if(confirm("X\xF3a \u0111\u01A1n h\xE0ng n\xE0y?")){_e(e);try{await window.KTM.api.deleteJSON(`${API_BASE}/api/orders/${e}`,"L\u1ED7i x\xF3a \u0111\u01A1n h\xE0ng"),wt(),Xt()}catch(a){console.error(a),typeof L=="function"?L(a.message,"danger"):alert(a.message)}finally{_e(null)}}},qt=async(e,a)=>{var s;const t=e==null?void 0:e.id;if(!(!t||!a)){Ue(t);try{const l=ca(e),c=(Array.isArray(l)?l:[]).map(p=>{var r,u;return{product_id:(p==null?void 0:p.product_id)||"",quantity:Number((r=p==null?void 0:p.quantity)!=null?r:1),variant:String((p==null?void 0:p.variant)||"").trim()||null,variant_json:(u=p==null?void 0:p.variant_json)!=null?u:null,unit_price:(()=>{var ne;const S=(ne=p==null?void 0:p.unit_price)!=null?ne:p==null?void 0:p.unitPrice,K=Number(S);return Number.isFinite(K)?Math.max(0,Math.trunc(K)):null})()}}).filter(p=>p.product_id&&Number.isFinite(p.quantity)&&p.quantity>0);if(!c.length)throw new Error("Kh\xF4ng th\u1EC3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i: \u0111\u01A1n kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m h\u1EE3p l\u1EC7");const g=c[0],N={id:t,customer_name:(e==null?void 0:e.customer_name)||"",phone:Ee((e==null?void 0:e.phone)||""),address:(e==null?void 0:e.address)||"",note:((e==null?void 0:e.note)||"").trim(),adjustment_amount:Number((s=e==null?void 0:e.adjustment_amount)!=null?s:0)||0,adjustment_note:(e==null?void 0:e.adjustment_note)||"",product_id:g.product_id,quantity:g.quantity,status:a,items:c};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${t}`,N,"L\u1ED7i c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i"),X(p=>Array.isArray(p)?p.map(r=>(r==null?void 0:r.id)===t?{...r,status:a}:r):p),E(p=>Array.isArray(p)?p.map(r=>(r==null?void 0:r.id)===t?{...r,status:a}:r):p),typeof L=="function"&&L("\u0110\xE3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i","success")}catch(l){console.error(l),typeof L=="function"?L(l.message,"danger"):alert(l.message)}finally{Ue(null)}}};return React.createElement("div",{className:"product-manager"},React.createElement(Loading,{show:ie&&!q&&!x||re||!!je||!!ke}),React.createElement("div",{className:"product-header"},React.createElement("h5",null,"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"),React.createElement("button",{className:"btn btn-dark btn-sm",onClick:ba,disabled:re||!!je},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o \u0111\u01A1n")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-4"},React.createElement("label",{className:"form-label mb-1"},"L\u1ECDc theo th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:i,onChange:e=>b(e.target.value),"aria-label":"Ch\u1ECDn th\xE1ng",disabled:F||x}),i&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{b("")},title:"B\u1ECF l\u1ECDc","aria-label":"B\u1ECF l\u1ECDc",disabled:ie||x},React.createElement("i",{className:"fas fa-times"})))),React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-filter"})),React.createElement("select",{className:"form-select",value:_,onChange:e=>O(e.target.value),"aria-label":"L\u1ECDc theo tr\u1EA1ng th\xE1i",disabled:F||x},React.createElement("option",{value:""},"T\u1EA5t c\u1EA3"),React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n")),_&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>O(""),title:"B\u1ECF l\u1ECDc tr\u1EA1ng th\xE1i","aria-label":"B\u1ECF l\u1ECDc tr\u1EA1ng th\xE1i",disabled:ie||x},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"form-check mt-2"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"orders-overdue-only",checked:F,onChange:e=>{if(x)return;const a=!!e.target.checked;Q(a),a&&O("pending")},disabled:x}),React.createElement("label",{className:"form-check-label",htmlFor:"orders-overdue-only"},"Ch\u1EC9 hi\u1EC7n \u0111\u01A1n ch\u1EADm > ",vt," ng\xE0y (Ch\u1EDD x\u1EED l\xFD)"))),React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label mb-1"},"Search (t\xEAn / S\u0110T)"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-search"})),React.createElement("input",{type:"text",className:"form-control",value:Me,onChange:e=>ce(e.target.value),placeholder:"Nh\u1EADp t\xEAn ho\u1EB7c S\u0110T...","aria-label":"Search \u0111\u01A1n h\xE0ng theo t\xEAn ho\u1EB7c S\u0110T"}),String(Me||"").trim()&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>ce(""),title:"X\xF3a search","aria-label":"X\xF3a search",disabled:$e},React.createElement("i",{className:"fas fa-times"})),$e&&React.createElement("span",{className:"input-group-text",title:"\u0110ang search...","aria-label":"\u0110ang search"},React.createElement("span",{className:"spinner-border spinner-border-sm text-warning",role:"status","aria-hidden":"true"}))),React.createElement("div",{className:"text-muted small mt-1"},"Search s\u1EBD ra to\xE0n b\u1ED9 data, b\u1ECF qua filter")),React.createElement("div",{className:"col-12 col-md-2 d-flex gap-2 justify-content-md-end"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>x?Wt(Me):wt(),disabled:ie||$e},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")))),React.createElement("div",{className:"card p-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},"Danh s\xE1ch \u0111\u01A1n h\xE0ng"),React.createElement("span",{className:"text-muted small"},x?`${gt.length} k\u1EBFt qu\u1EA3`:_?`${ht.length}/${Y.length} \u0111\u01A1n`:`${Y.length} \u0111\u01A1n`)),x&&Re&&React.createElement("div",{className:"alert alert-danger mt-3 mb-0",role:"alert"},Re),mt.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"C\xF3 ",React.createElement("strong",null,mt.length)," \u0111\u01A1n ",React.createElement("strong",null,"Ch\u1EDD x\u1EED l\xFD")," qu\xE1 ",vt," ng\xE0y.",W&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{Q(!0),O("pending")}},"Xem ngay")),ft.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-clock me-2"}),"C\xF3 ",React.createElement("strong",null,ft.length)," \u0111\u01A1n ",React.createElement("strong",null,"Nh\xE1p")," s\u1EAFp t\u1EF1 x\xF3a (c\xF2n \u2264 ",Ot," ng\xE0y).",de&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{Q(!1),O("draft"),b(""),wt()}},"Xem ngay")),(x?$e:ie)?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):(x?gt.length===0:Y.length===0)?React.createElement("div",{className:"text-center py-4 text-muted"},x?"Kh\xF4ng c\xF3 k\u1EBFt qu\u1EA3":"Ch\u01B0a c\xF3 \u0111\u01A1n h\xE0ng"):!x&&ht.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},"Kh\xF4ng c\xF3 \u0111\u01A1n ph\xF9 h\u1EE3p"):React.createElement(React.Fragment,null,React.createElement("div",{className:"d-md-none mt-3"},gt.map(e=>{var a;return React.createElement("div",{key:e.id,className:"card mb-2"},React.createElement("div",{className:"card-body p-3"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"flex-grow-1",style:{minWidth:0}},React.createElement("div",{className:"fw-semibold text-truncate"},e.customer_name),React.createElement("div",{className:"fw-bold font-monospace"},e.phone),Number((a=e==null?void 0:e.split_seq)!=null?a:0)>0&&React.createElement("div",{className:"text-muted small"},"\u0110\u1EE3t ",e.split_seq),e.address&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},e.address),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("div",{className:"d-flex align-items-start gap-1 flex-shrink-0"},React.createElement("span",{className:`badge ${Fe(e.status)}`},Ce(e.status)),m(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${vt} ng\xE0y`},"\u26A0 Ch\u1EADm ",j(e),"d"),te(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 x\xF3a sau ${At} ng\xE0y`},"\u23F3 C\xF2n ",se(e),"d"))),React.createElement("div",{className:"mt-2 small"},React.createElement("div",null,React.createElement("div",{className:"text-muted"},"S\u1EA3n ph\u1EA9m:"),(()=>{const t=da(e);return t.length?React.createElement("div",{className:"mt-1"},t.map((s,l)=>React.createElement("div",{key:l,className:"d-flex justify-content-between gap-2",style:{lineHeight:1.25}},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,whiteSpace:"normal",wordBreak:"break-word",flex:1}},React.createElement("span",{className:"text-muted me-1"},l+1,"."),s.name),React.createElement("div",{className:"text-muted small text-end text-nowrap",style:{flexShrink:0}},"x",s.qty,Number(s.unitPrice)>0?` \u2022 ${ue(s.unitPrice)}`:"")))):React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},ea(e))})()),(ma(e)!==0||ta(e))&&React.createElement("div",{style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh:")," ",React.createElement("span",{className:"fw-semibold"},ue(ma(e))),ta(e)?React.createElement("span",{className:"text-muted"}," ","(",ta(e),")"):null),React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng ti\u1EC1n"),React.createElement("span",{className:"fw-bold"},ue(ha(e)))),React.createElement("div",{className:"text-muted"},React.createElement("span",null,"Th\u1EDDi gian:")," ",Nt(e.created_at))),React.createElement("div",{className:"mt-3 d-flex gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary flex-fill",onClick:()=>Jt(e),disabled:re||!!je||ke===e.id},"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary flex-fill",onClick:()=>va(e),disabled:re||!!je||ke===e.id},React.createElement("i",{className:"fas fa-copy me-1"}),"Copy"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger flex-fill",onClick:()=>Sa(e.id),disabled:re||je===e.id||ke===e.id},je===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a")),React.createElement("div",{className:"mt-2 d-flex gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning flex-fill",onClick:()=>qt(e,"processing"),disabled:re||!!je||ke===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success flex-fill",onClick:()=>qt(e,"done"),disabled:re||!!je||ke===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary flex-fill",onClick:()=>qt(e,"paid"),disabled:re||!!je||ke===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger flex-fill",onClick:()=>qt(e,"canceled"),disabled:re||!!je||ke===e.id||e.status==="canceled",title:"H\u1EE7y \u0111\u01A1n"},"H\u1EE7y"))))})),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive orders-table-wrap mt-3"},React.createElement("table",{className:"table orders-table table-hover align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"SL"),React.createElement("th",null,"T\u1ED5ng ti\u1EC1n"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"),React.createElement("th",null,"Th\u1EDDi gian"),React.createElement("th",null))),React.createElement("tbody",null,gt.map(e=>React.createElement("tr",{key:e.id},React.createElement("td",null,React.createElement("div",{className:"fw-semibold"},e.customer_name),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("td",null,e.phone),React.createElement("td",null,(()=>{const a=da(e);return a.length?React.createElement("div",{className:"d-grid gap-1"},a.map((t,s)=>React.createElement("div",{key:s,className:"small",style:{whiteSpace:"normal",wordBreak:"break-word",lineHeight:1.2}},React.createElement("span",{className:"text-muted me-1"},s+1,"."),React.createElement("span",{className:"fw-semibold"},t.name)," ",React.createElement("span",{className:"text-muted"},"x",t.qty),Number(t.unitPrice)>0&&React.createElement("span",{className:"text-muted"}," ","\u2022 ",ue(t.unitPrice))))):ea(e)})()),React.createElement("td",null,Oa(e)),React.createElement("td",{className:"fw-semibold"},ue(ha(e))),React.createElement("td",null,React.createElement("div",{className:"d-flex align-items-center gap-1 flex-wrap"},React.createElement("span",{className:`badge ${Fe(e.status)}`},Ce(e.status)),m(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${vt} ng\xE0y`},"\u26A0 Ch\u1EADm ",j(e),"d"),te(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 x\xF3a sau ${At} ng\xE0y`},"\u23F3 C\xF2n ",se(e),"d"))),React.createElement("td",null,Nt(e.created_at)),React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-sm btn-primary me-1",onClick:()=>Jt(e),disabled:re||!!je||ke===e.id},"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary me-1",onClick:()=>va(e),disabled:re||!!je||ke===e.id},React.createElement("i",{className:"fas fa-copy"})),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning me-1",onClick:()=>qt(e,"processing"),disabled:re||!!je||ke===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success me-1",onClick:()=>qt(e,"done"),disabled:re||!!je||ke===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary me-1",onClick:()=>qt(e,"paid"),disabled:re||!!je||ke===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger me-1",onClick:()=>qt(e,"canceled"),disabled:re||!!je||ke===e.id||e.status==="canceled",title:"H\u1EE7y \u0111\u01A1n"},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>Sa(e.id),disabled:re||je===e.id},je===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a")))))))))),q&&React.createElement("div",{className:"modal show d-block order-modal",style:{background:"rgba(0,0,0,0.6)"},role:"dialog","aria-modal":"true"},React.createElement("div",{className:"modal-dialog modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ffca2c)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark mb-0"},React.createElement("i",{className:"fas fa-receipt me-2"}),De?"S\u1EEDa \u0111\u01A1n h\xE0ng":"T\u1EA1o \u0111\u01A1n h\xE0ng"),React.createElement("button",{type:"button",className:"btn-close",onClick:ra})),React.createElement("form",{onSubmit:e=>{e.preventDefault(),xa({mode:"close"})}},React.createElement("div",{className:"modal-body",ref:T},React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"T\xEAn kh\xE1ch h\xE0ng *"),React.createElement("input",{className:"form-control",value:o.customer_name,onChange:e=>V({...o,customer_name:e.target.value}),placeholder:"Nh\u1EADp t\xEAn kh\xE1ch h\xE0ng",required:!0,style:{borderRadius:10,padding:12}}),!!ct.nameError&&React.createElement("div",{className:"form-text text-danger"},ct.nameError)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i *"),React.createElement("input",{className:"form-control",type:"tel",inputMode:"numeric",pattern:"[0-9+\\s-]*",id:"order-phone-input",value:o.phone,onChange:e=>ae(e.target.value),onBlur:G,placeholder:"Nh\u1EADp s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",required:!0,style:{borderRadius:10,padding:12}}),!!ct.phoneError&&React.createElement("div",{className:"form-text text-danger"},ct.phoneError),!ct.phoneError&&It.count>0&&React.createElement("div",{className:"form-text text-warning d-flex align-items-center justify-content-between gap-2"},React.createElement("span",null,"Kh\xE1ch n\xE0y \u0111\xE3 c\xF3 ",It.count," \u0111\u01A1n trong th\xE1ng ",It.monthKey,"."),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>v(e=>!e)},d?"\u1EA8n l\u1ECBch s\u1EED":"Xem l\u1ECBch s\u1EED")),d&&It.orders.length>0&&React.createElement("div",{className:"mt-2 border rounded-3 p-2",style:{background:"#fff"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between gap-2 mb-2"},React.createElement("div",{className:"small fw-semibold"},"L\u1ECBch s\u1EED \u0111\u01A1n (c\xF9ng th\xE1ng)"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>v(!1)},"\u1EA8n")),React.createElement("div",{className:"d-grid gap-2"},It.orders.slice(0,5).map(e=>React.createElement("div",{key:e.id,className:"d-flex align-items-start justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"small fw-semibold",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},"#",e.id," \u2022 ",React.createElement("span",{className:`badge ${Fe(e.status)}`},Ce(e.status))),React.createElement("div",{className:"text-muted small"},Nt(e.created_at)," \u2022 ",ue(ha(e))),React.createElement("div",{className:"text-muted small",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},ea(e))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{confirm(`M\u1EDF \u0111\u01A1n #${e.id}? D\u1EEF li\u1EC7u \u0111ang nh\u1EADp s\u1EBD m\u1EA5t.`)&&Jt(e)}},"M\u1EDF")))),It.orders.length>5&&React.createElement("div",{className:"text-muted small mt-2"},"Ch\u1EC9 hi\u1EC3n th\u1ECB 5 \u0111\u01A1n g\u1EA7n nh\u1EA5t.")),(me==null?void 0:me.status)==="loading"&&React.createElement("div",{className:"form-text"},"\u0110ang t\xECm kh\xE1ch theo S\u0110T..."),(me==null?void 0:me.status)==="found"&&React.createElement("div",{className:"form-text text-success"},"\u0110\xE3 c\xF3 kh\xE1ch, t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n th\xF4ng tin."),(me==null?void 0:me.status)==="not-found"&&React.createElement("div",{className:"form-text text-muted"},"Ch\u01B0a c\xF3 kh\xE1ch, s\u1EBD t\u1EA1o m\u1EDBi khi l\u01B0u \u0111\u01A1n."),(me==null?void 0:me.status)==="error"&&React.createElement("div",{className:"form-text text-danger"},"Kh\xF4ng tra \u0111\u01B0\u1EE3c kh\xE1ch (l\u1ED7i m\u1EA1ng/server).")),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("select",{className:"form-select",value:o.status,onChange:e=>V({...o,status:e.target.value}),style:{borderRadius:10,padding:12}},React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n"))),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("input",{className:"form-control",value:o.address,onChange:e=>V({...o,address:e.target.value}),placeholder:"Nh\u1EADp \u0111\u1ECBa ch\u1EC9 (kh\xF4ng b\u1EAFt bu\u1ED9c)",style:{borderRadius:10,padding:12}}),!!ct.addressWarn&&React.createElement("div",{className:"form-text text-warning"},ct.addressWarn)),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111\u01A1n h\xE0ng"),React.createElement("textarea",{className:"form-control",value:o.note,onChange:e=>V({...o,note:e.target.value}),placeholder:"V\xED d\u1EE5: Giao gi\u1EDD h\xE0nh ch\xEDnh / G\u1ECDi tr\u01B0\u1EDBc khi giao...",rows:2,style:{borderRadius:10,padding:12,resize:"vertical"}})),React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110i\u1EC1u ch\u1EC9nh gi\xE1 (th\xEAm/b\u1EDBt)"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{V(e=>({...e,adjustment_items:[...Array.isArray(e.adjustment_items)?e.adjustment_items:[{amount:"",note:""}],{amount:"",note:""}]}))}},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm \u0111i\u1EC1u ch\u1EC9nh")),React.createElement("div",{className:"d-grid gap-2"},qe(o.adjustment_items).map((e,a)=>React.createElement("div",{key:a,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label small text-muted mb-1"},"S\u1ED1 ti\u1EC1n"),React.createElement("input",{type:"text",inputMode:"numeric",className:"form-control",value:e.amount,onChange:t=>{const s=t.target.value;V(l=>{const c=qe(l.adjustment_items);return c[a]={...c[a],amount:s},{...l,adjustment_items:c}})},placeholder:"+500000 ho\u1EB7c -200000",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("label",{className:"form-label small text-muted mb-1"},"Ghi ch\xFA"),React.createElement("input",{className:"form-control",value:e.note,onChange:t=>{const s=t.target.value;V(l=>{const c=qe(l.adjustment_items);return c[a]={...c[a],note:s},{...l,adjustment_items:c}})},placeholder:"V\xED d\u1EE5: th\xEAm van 1 tay / gi\u1EA3m gi\xE1...",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-1 d-flex"},React.createElement("button",{type:"button",className:"btn btn-outline-danger w-100",onClick:()=>{V(t=>{const s=qe(t.adjustment_items);return s.splice(a,1),{...t,adjustment_items:s.length?s:[{amount:"",note:""}]}})},disabled:re||qe(o.adjustment_items).length<=1,title:"X\xF3a \u0111i\u1EC1u ch\u1EC9nh",style:{borderRadius:10,padding:12}},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement("div",{className:"form-text"},"\xC2m = gi\u1EA3m gi\xE1, d\u01B0\u01A1ng = c\u1ED9ng th\xEAm."),!!ct.adjustmentAbnormalWarn&&React.createElement("div",{className:"form-text text-warning"},ct.adjustmentAbnormalWarn),!!ct.adjustmentNoteWarn&&React.createElement("div",{className:"form-text text-warning"},ct.adjustmentNoteWarn)),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1EA3n ph\u1EA9m *"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{V(e=>({...e,items:[...Array.isArray(e.items)?e.items:[],{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]})),Ge(e=>[...Array.isArray(e)?e:[],""]),De&&C(e=>[...Array.isArray(e)?e:[],!0])},disabled:re},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(o.items)?o.items:[{product_id:"",quantity:1}]).map((e,a)=>React.createElement("div",{key:a,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"dropdown w-100",ref:t=>{Ze.current[a]=t}},React.createElement("button",{type:"button",className:"form-control text-start d-flex align-items-center justify-content-between",style:{borderRadius:10,padding:12},onClick:()=>{Pe(t=>t===a?null:a),setTimeout(()=>{const t=document.getElementById(`order-product-search-${a}`);t&&t.focus()},0)}},React.createElement("span",{className:e.product_id?"":"text-muted",style:{minWidth:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},Aa(e.product_id)),React.createElement("i",{className:"fas fa-chevron-down text-muted",style:{marginLeft:8,flexShrink:0}})),Ve===a&&React.createElement("div",{className:"dropdown-menu show w-100 p-2",style:{maxHeight:320,overflowY:"auto"}},React.createElement("input",{id:`order-product-search-${a}`,className:"form-control",value:Oe[a]||"",onChange:t=>{const s=t.target.value;Ge(l=>{const c=Array.isArray(l)?[...l]:[];return c[a]=s,c})},placeholder:"T\xECm theo t\xEAn / m\xE3...",style:{borderRadius:10,padding:10}}),React.createElement("div",{className:"mt-2"}),(()=>{const t=ja(a);return t.length===0?React.createElement("div",{className:"text-muted small px-2 py-1"},"Kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p"):t.map(s=>React.createElement("button",{key:s.id,type:"button",className:"dropdown-item",onClick:()=>{const l=String(s.id),c=Qt(s==null?void 0:s.variants),g={};for(const r of c){const u=String((r==null?void 0:r.name)||"").trim(),S=Array.isArray(r==null?void 0:r.options)?r.options[0]:null,K=String((S==null?void 0:S.label)||"").trim();u&&K&&(g[u]=K)}const N=ga(g),p=Zt(s,g);V(r=>{const u=Array.isArray(r.items)?[...r.items]:[];return u[a]={...u[a]||{quantity:1},product_id:l,variant_json:Object.keys(g).length?g:null,variant:N,unit_price:c.length?p:null},{...r,items:u}}),Pe(null)}},s.name,s.code?` (${s.code})`:""))})()),React.createElement("select",{className:"form-select",value:e.product_id,onChange:()=>{},required:!0,style:{position:"absolute",opacity:0,height:0,pointerEvents:"none"},tabIndex:-1,"aria-hidden":"true"},React.createElement("option",{value:""},"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"),et.map(t=>React.createElement("option",{key:t.id,value:t.id},t.name)))),(()=>{var s;const t=(s=ct.items)==null?void 0:s[a];return t?React.createElement(React.Fragment,null,!!t.productError&&React.createElement("div",{className:"form-text text-danger"},t.productError),!!t.dupWarn&&React.createElement("div",{className:"form-text text-warning"},t.dupWarn)):null})(),(()=>{if(!(e!=null&&e.product_id))return null;const t=Mt(e.product_id),s=Qt(t==null?void 0:t.variants);if(!s.length)return null;const l=e!=null&&e.variant_json&&typeof e.variant_json=="object"?e.variant_json:{};return React.createElement("div",{className:"mt-2 d-grid gap-2"},s.map((c,g)=>{const N=String((c==null?void 0:c.name)||`Bi\u1EBFn th\u1EC3 ${g+1}`).trim(),p=String((l==null?void 0:l[N])||"").trim();return React.createElement("div",{key:N},React.createElement("label",{className:"form-label small text-muted mb-1"},N),React.createElement("select",{className:"form-select",value:p,onChange:r=>{const u=String(r.target.value||"").trim();V(S=>{const K=Array.isArray(S.items)?[...S.items]:[],ne={...K[a]||{}},Z=Mt(ne.product_id),xe=Qt(Z==null?void 0:Z.variants),Se=ne!=null&&ne.variant_json&&typeof ne.variant_json=="object"?{...ne.variant_json}:{};u?Se[N]=u:delete Se[N];const nt=ga(Se),it=Zt(Z,Se);return K[a]={...ne,variant_json:Object.keys(Se).length?Se:null,variant:nt,unit_price:it},{...S,items:K}})},style:{borderRadius:10,padding:12}},React.createElement("option",{value:""},"-- ch\u1ECDn ",N," --"),(Array.isArray(c==null?void 0:c.options)?c.options:[]).map(r=>React.createElement("option",{key:r.label,value:r.label},r.label,Number.isFinite(Number(r==null?void 0:r.price))?` (${ue(Number(r.price))})`:Number(r==null?void 0:r.price_delta)?` (${r.price_delta>0?"+":""}${r.price_delta})`:""))))}))})(),De&&React.createElement("div",{className:"form-check mt-1"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:`order-split-deliver-${a}`,checked:!!ve[a],onChange:t=>{const s=!!t.target.checked;C(l=>{const c=Array.isArray(l)?[...l]:[],g=Array.isArray(o.items)?o.items.length:0;for(;c.length<g;)c.push(!0);return c[a]=s,c})},disabled:re||h}),React.createElement("label",{className:"form-check-label small text-muted",htmlFor:`order-split-deliver-${a}`},"Giao \u0111\u1EE3t 1"))),React.createElement("div",{className:"col-8 col-md-3"},React.createElement("input",{type:"number",className:"form-control",value:e.quantity,onChange:t=>{const s=t.target.value;V(l=>{const c=Array.isArray(l.items)?[...l.items]:[];return c[a]={...c[a]||{product_id:""},quantity:s},{...l,items:c}})},min:"1",style:{borderRadius:10,padding:12}}),(()=>{var s;const t=(s=ct.items)==null?void 0:s[a];return t&&t.qtyError?React.createElement("div",{className:"form-text text-danger"},t.qtyError):null})()),React.createElement("div",{className:"col-4 col-md-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>{V(t=>{const s=Array.isArray(t.items)?[...t.items]:[];return s.splice(a,1),{...t,items:s.length?s:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]}}),Ge(t=>{const s=Array.isArray(t)?[...t]:[];return s.splice(a,1),s.length?s:[""]}),C(t=>{const s=Array.isArray(t)?[...t]:[];return s.splice(a,1),s}),Pe(t=>t==null?t:t===a?null:t>a?t-1:t)},disabled:re||h||(Array.isArray(o.items)?o.items.length:1)<=1,title:"X\xF3a s\u1EA3n ph\u1EA9m",style:{borderRadius:10,padding:10}},React.createElement("i",{className:"fas fa-trash"}))))))),(()=>{const a=(Array.isArray(o.items)?o.items:[]).filter(N=>N==null?void 0:N.product_id),t=na(a),s=aa(a),l=Ye(o),c=l.amount,g=t+(s.found?s.fee:0)+c;return React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-column gap-1 small bg-light rounded-3 p-3"},React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1EA1m t\xEDnh"),React.createElement("span",{className:"fw-semibold"},ue(t))),s.found&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"Ship"),React.createElement("span",{className:"fw-semibold"},ue(s.fee))),!!ct.shipAbnormalWarn&&React.createElement("div",{className:"text-warning"},ct.shipAbnormalWarn),c!==0&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh"),React.createElement("span",{className:"fw-semibold"},ue(c))),(o.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111\u01A1n: ",(o.note||"").trim()),!!l.summaryText&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh: ",l.summaryText),React.createElement("div",{className:"d-flex justify-content-between pt-1 border-top"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng"),React.createElement("span",{className:"fw-bold"},ue(g)))))})())),React.createElement("div",{className:"modal-footer",style:{border:"none"}},React.createElement("button",{type:"button",className:"btn btn-light",onClick:ra,disabled:re||h,style:{borderRadius:10}},"H\u1EE7y"),!!De&&React.createElement("button",{type:"button",className:"btn btn-outline-primary fw-semibold",onClick:Ca,disabled:re||h,style:{borderRadius:10},title:"Ch\u1ECDn s\u1EA3n ph\u1EA9m giao \u0111\u1EE3t 1 v\xE0 t\xE1ch ph\u1EA7n c\xF2n l\u1EA1i sang \u0111\u01A1n ch\u1EDD h\xE0ng"},h?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang t\xE1ch..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-random me-2"}),"T\xE1ch \u0111\u01A1n giao ngay")),!De&&React.createElement("button",{type:"button",className:"btn btn-outline-warning fw-semibold",onClick:()=>xa({mode:"new"}),disabled:re||!ct.canSubmit,style:{borderRadius:10},title:"L\u01B0u xong gi\u1EEF form \u0111\u1EC3 t\u1EA1o \u0111\u01A1n m\u1EDBi"},React.createElement("i",{className:"fas fa-plus me-2"}),"L\u01B0u & t\u1EA1o \u0111\u01A1n m\u1EDBi"),React.createElement("button",{type:"submit",className:"btn btn-warning fw-semibold",disabled:re||h||!ct.canSubmit,style:{borderRadius:10,boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},re?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u"))))))))}

