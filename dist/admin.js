const{useState,useEffect,useRef}=React,CLOUDINARY_CLOUD_NAME="diwxfpt92",CLOUDINARY_UPLOAD_PRESET="ktm_unsigned",API_BASE="";function LoginPage({onLogin:k,error:w}){const[O,G]=useState(""),[F,C]=useState(""),[_,re]=useState(!1),[de,z]=useState(!1);return React.createElement("div",{className:"login-page"},React.createElement("div",{className:"login-box"},React.createElement("div",{className:"text-center mb-4"},React.createElement("i",{className:"fas fa-tractor fa-3x text-warning mb-3"}),React.createElement("h4",{className:"text-dark"},"KTM Admin"),React.createElement("p",{className:"text-muted small"},"\u0110\u0103ng nh\u1EADp \u0111\u1EC3 qu\u1EA3n l\xFD")),w&&React.createElement("div",{className:"alert alert-danger py-2 small"},React.createElement("i",{className:"fas fa-exclamation-circle me-2"}),w),React.createElement("form",{onSubmit:async xe=>{xe.preventDefault(),re(!0),await k(O,F),re(!1)}},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small"},"T\xEAn \u0111\u0103ng nh\u1EADp"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-user"})),React.createElement("input",{type:"text",className:"form-control",value:O,onChange:xe=>G(xe.target.value),placeholder:"admin",required:!0,autoFocus:!0}))),React.createElement("div",{className:"mb-4"},React.createElement("label",{className:"form-label small"},"M\u1EADt kh\u1EA9u"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-lock"})),React.createElement("input",{type:de?"text":"password",className:"form-control",value:F,onChange:xe=>C(xe.target.value),placeholder:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",required:!0}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>z(!de)},React.createElement("i",{className:`fas fa-eye${de?"-slash":""}`})))),React.createElement("button",{type:"submit",className:"btn btn-warning w-100",disabled:_},_?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang \u0111\u0103ng nh\u1EADp..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-sign-in-alt me-2"}),"\u0110\u0103ng nh\u1EADp"))),React.createElement("div",{className:"text-center mt-4"},React.createElement("a",{href:"/",className:"text-muted small text-decoration-none"},React.createElement("i",{className:"fas fa-arrow-left me-1"}),"V\u1EC1 trang ch\u1EE7"))))}function Toast({message:k,type:w,onClose:O}){return useEffect(()=>{const G=setTimeout(O,3e3);return()=>clearTimeout(G)},[]),React.createElement("div",{className:`toast show align-items-center text-white bg-${w} border-0`,role:"alert"},React.createElement("div",{className:"d-flex"},React.createElement("div",{className:"toast-body"},k),React.createElement("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto",onClick:O})))}function Loading({show:k}){return k?React.createElement("div",{className:"loading-overlay"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"3rem",height:"3rem"}},React.createElement("span",{className:"visually-hidden"},"\u0110ang t\u1EA3i..."))):null}function Sidebar({activeMenu:k,onMenuChange:w,onLogout:O,currentUser:G}){const F=[{id:"search",icon:"fa-search",label:"Tra c\u1EE9u nhanh",highlight:!0},{id:"albums",icon:"fa-images",label:"Qu\u1EA3n l\xFD Album"},{id:"videos",icon:"fa-video",label:"Qu\u1EA3n l\xFD Video"},{id:"products",icon:"fa-box",label:"S\u1EA3n ph\u1EA9m"},{id:"orders",icon:"fa-receipt",label:"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"},{id:"stats",icon:"fa-chart-column",label:"Th\u1ED1ng k\xEA"},{id:"settings",icon:"fa-cog",label:"C\xE0i \u0111\u1EB7t"}],C=(G==null?void 0:G.username)||(G==null?void 0:G.name)||(G==null?void 0:G.email)||"Admin";return React.createElement("div",{className:"sidebar d-none d-md-block"},React.createElement("div",{className:"logo"},React.createElement("i",{className:"fas fa-tractor me-2"})," KTM Admin"),React.createElement("div",{className:"sidebar-user","aria-label":"T\xE0i kho\u1EA3n"},React.createElement("div",{className:"sidebar-user-avatar","aria-hidden":"true"},React.createElement("i",{className:"fas fa-user"})),React.createElement("div",{className:"sidebar-user-meta"},React.createElement("div",{className:"sidebar-user-name"},C),React.createElement("div",{className:"sidebar-user-sub"},"Qu\u1EA3n tr\u1ECB"))),React.createElement("nav",{className:"nav flex-column mt-3"},F.map(_=>React.createElement("a",{key:_.id,href:"#",className:`nav-link ${k===_.id?"active":""} ${_.disabled?"opacity-50":""} ${_.highlight?"text-warning":""}`,onClick:re=>{re.preventDefault(),_.disabled||w(_.id)}},React.createElement("i",{className:`fas ${_.icon}`})," ",_.label,_.disabled&&React.createElement("span",{className:"badge bg-secondary ms-2"},"Soon"),_.highlight&&React.createElement("span",{className:"badge bg-warning text-dark ms-2"},"HOT")))),React.createElement("div",{className:"position-absolute bottom-0 w-100 p-3 border-top border-secondary"},React.createElement("div",{className:"d-flex justify-content-between align-items-center"},React.createElement("a",{href:"/",className:"text-white-50 text-decoration-none small"},React.createElement("i",{className:"fas fa-home me-1"})," Trang ch\u1EE7"),O&&React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:O,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"})))))}const ADMIN_SETTINGS_STORAGE_KEY="ktm_admin_settings_v1",DEFAULT_SHIP_PERCENT=1.64;function normalizeShipPercent(k){const w=typeof k=="number"?k:parseFloat(String(k!=null?k:"").trim());return Number.isFinite(w)?Math.max(0,Math.min(100,w)):DEFAULT_SHIP_PERCENT}function loadAdminSettings(){var k;try{const w=localStorage.getItem(ADMIN_SETTINGS_STORAGE_KEY);if(!w)return{ship_percent:DEFAULT_SHIP_PERCENT};const O=JSON.parse(w);return{ship_percent:normalizeShipPercent((k=O==null?void 0:O.ship_percent)!=null?k:O==null?void 0:O.shipPercent)}}catch(w){return{ship_percent:DEFAULT_SHIP_PERCENT}}}function saveAdminSettings(k){var w;try{const O={ship_percent:normalizeShipPercent((w=k==null?void 0:k.ship_percent)!=null?w:k==null?void 0:k.shipPercent)};return localStorage.setItem(ADMIN_SETTINGS_STORAGE_KEY,JSON.stringify(O)),O}catch(O){return{ship_percent:DEFAULT_SHIP_PERCENT}}}async function fetchAdminSettingsFromServer(){var w;const k=await window.KTM.api.getJSON(`${API_BASE}/api/settings`,"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t t\u1EEB DB");return{ship_percent:normalizeShipPercent((w=k==null?void 0:k.ship_percent)!=null?w:k==null?void 0:k.shipPercent)}}async function saveAdminSettingsToServer(k){var G,F,C;const w={ship_percent:normalizeShipPercent((G=k==null?void 0:k.ship_percent)!=null?G:k==null?void 0:k.shipPercent)},O=await window.KTM.api.putJSON(`${API_BASE}/api/settings`,w,"Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t v\xE0o DB");return{ship_percent:normalizeShipPercent((C=(F=O==null?void 0:O.ship_percent)!=null?F:O==null?void 0:O.shipPercent)!=null?C:w.ship_percent)}}function AlbumList({albums:k,onSelect:w,onCreate:O,onEdit:G,onDelete:F,loading:C,currentFolder:_,onBack:re,breadcrumb:de}){return React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},_&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:re},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),_?_.title:"Th\u01B0 vi\u1EC7n \u1EA3nh")),React.createElement("button",{className:"btn btn-warning",onClick:O},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder")),de&&de.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:z=>{z.preventDefault(),re("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),de.map((z,ue)=>React.createElement("li",{key:z.id,className:`breadcrumb-item ${ue===de.length-1?"active":""}`},ue===de.length-1?z.title:React.createElement("a",{href:"#",onClick:xe=>{xe.preventDefault(),re(z)},className:"text-warning"},z.title))))),C?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):k.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},_?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder n\xE0o. H\xE3y t\u1EA1o folder \u0111\u1EA7u ti\xEAn!")):React.createElement("div",{className:"row g-3"},k.map(z=>React.createElement("div",{key:z.uuid||z.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card album-card h-100",onClick:()=>w(z)},z.cover?React.createElement("img",{src:z.cover,className:"album-cover",alt:z.title}):React.createElement("div",{className:"card-body text-center py-4"},React.createElement("i",{className:"fas fa-folder fa-3x text-warning mb-2"})),React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"card-title mb-1"},z.title),React.createElement("small",{className:"text-muted"},z.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),z.subfolderCount),z.subfolderCount>0&&z.count>0&&" \u2022 ",z.count>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-image me-1"}),z.count),z.subfolderCount===0&&z.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-2",onClick:ue=>{ue.stopPropagation(),G(z)},title:"S\u1EEDa album"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:ue=>{ue.stopPropagation(),F(z)},title:"X\xF3a album"},React.createElement("i",{className:"fas fa-trash"}))))))))}function AlbumModal({show:k,album:w,onClose:O,onSave:G,parentId:F}){const[C,_]=useState({slug:"",title:"",description:"",cover_url:"",parent_id:null}),[re,de]=useState(!1),[z,ue]=useState(!1),xe=useRef(null);useEffect(()=>{_(w?{slug:w.id||"",title:w.title||"",description:w.description||"",cover_url:w.cover||"",parent_id:w.parentId||null}:{slug:"",title:"",description:"",cover_url:"",parent_id:F||null})},[w,k,F]);const ce=async me=>{me.preventDefault(),de(!0),await G(C),de(!1)},se=me=>me.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),he=async me=>{const we=me.type==="image/heic"||me.type==="image/heif"||/\.heic$/i.test(me.name);if(me.size<=2097152&&!we)return me;try{const Le=await createImageBitmap(me),Ie=document.createElement("canvas");let _e=Le.width,ye=Le.height;const De=800;return(_e>De||ye>De)&&(_e>ye?(ye=Math.round(ye/_e*De),_e=De):(_e=Math.round(_e/ye*De),ye=De)),Ie.width=_e,Ie.height=ye,Ie.getContext("2d").drawImage(Le,0,0,_e,ye),Le.close(),new Promise((tt,Ce)=>{Ie.toBlob(qe=>{qe?tt(new File([qe],me.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):Ce(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(Le){throw console.error("Compress cover error:",Le),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},He=async me=>{var Le;const ve=me.target.files[0];if(!ve)return;if(!(ve.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(ve.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}ue(!0);try{const Ie=await he(ve),_e=await window.KTM.cloudinary.uploadImage({file:Ie,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-albums/covers"});if(!_e.secure_url)throw console.error("Cloudinary error:",_e),new Error(((Le=_e.error)==null?void 0:Le.message)||"Upload failed");_(ye=>({...ye,cover_url:_e.secure_url}))}catch(Ie){console.error("Cover upload error:",Ie),alert("L\u1ED7i upload \u1EA3nh b\xECa: "+Ie.message)}ue(!1),me.target.value=""};return k?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},w?"S\u1EEDa":"T\u1EA1o"," Folder"),React.createElement("button",{type:"button",className:"btn-close",onClick:O})),React.createElement("form",{onSubmit:ce},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:C.title,onChange:me=>_({...C,title:me.target.value,slug:C.slug||se(me.target.value)}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Slug (URL) *"),React.createElement("input",{type:"text",className:"form-control",value:C.slug,onChange:me=>_({...C,slug:me.target.value}),required:!0,disabled:!!w}),React.createElement("small",{className:"text-muted"},"VD: may-cay-kubota-l1501")),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:C.description,onChange:me=>_({...C,description:me.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex gap-2 align-items-start"},C.cover_url&&React.createElement("div",{className:"position-relative",style:{width:80,height:80}},React.createElement("img",{src:C.cover_url,alt:"Cover",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:8}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute",style:{top:-8,right:-8,padding:"2px 6px",fontSize:10},onClick:()=>_(me=>({...me,cover_url:""}))},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{ref:xe,type:"file",accept:"image/*",className:"d-none",onChange:He}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100 mb-2",onClick:()=>{var me;return(me=xe.current)==null?void 0:me.click()},disabled:z},z?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh b\xECa")),React.createElement("input",{type:"url",className:"form-control form-control-sm",value:C.cover_url,onChange:me=>_({...C,cover_url:me.target.value}),placeholder:"Ho\u1EB7c d\xE1n URL \u1EA3nh..."}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:O},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:re||z},re?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function FolderTreeItem({folder:k,allAlbums:w,currentAlbumId:O,targetAlbum:G,onSelect:F,level:C=0}){const[_,re]=useState(!0),de=k.uuid||k.id,z=de===O,ue=G===de,xe=w.filter(se=>se.parentId===de),ce=xe.length>0;return React.createElement("div",{style:{marginLeft:C*16+"px"}},React.createElement("div",{className:`d-flex align-items-center p-2 rounded mb-1 ${ue?"bg-info text-white":z?"bg-light text-muted":"hover-bg"}`,style:{cursor:z?"not-allowed":"pointer",opacity:z?.5:1,transition:"background 0.2s"},onClick:()=>!z&&F(de)},ce&&React.createElement("i",{className:`fas fa-chevron-${_?"down":"right"} me-2`,style:{fontSize:"10px",width:"12px",cursor:"pointer"},onClick:se=>{se.stopPropagation(),re(!_)}}),!ce&&React.createElement("span",{style:{width:"20px"}}),React.createElement("i",{className:`fas fa-folder${ue?"-open":""} me-2 ${ue?"":"text-warning"}`}),React.createElement("span",{className:"small"},k.title),z&&React.createElement("span",{className:"ms-2 badge bg-secondary",style:{fontSize:"9px"}},"Hi\u1EC7n t\u1EA1i"),k.count>0&&!z&&React.createElement("span",{className:"ms-auto badge bg-light text-muted",style:{fontSize:"10px"}},k.count)),_&&ce&&React.createElement("div",null,xe.map(se=>React.createElement(FolderTreeItem,{key:se.uuid||se.id,folder:se,allAlbums:w,currentAlbumId:O,targetAlbum:G,onSelect:F,level:C+1}))))}function AlbumDetail({album:k,onBack:w,onRefresh:O,showToast:G,onNavigateToFolder:F,onEditSubfolder:C,parentAlbum:_}){const[re,de]=useState([]),[z,ue]=useState([]),[xe,ce]=useState(!0),[se,he]=useState(!1),[He,me]=useState(""),[ve,we]=useState([]),[Le,Ie]=useState([]),[_e,ye]=useState({}),[De,Ae]=useState(null),[tt,Ce]=useState(!1),[qe,Re]=useState(""),[m,M]=useState(!1),i=useRef(null),b=useRef(null),[v,T]=useState(!1),[K,Y]=useState([]),[P,B]=useState([]),[fe,Ke]=useState(""),[u,g]=useState(!1),pe=async(h,U=2)=>{const ie=U*1024*1024,Ue=h.type==="image/heic"||h.type==="image/heif"||/\.heic$/i.test(h.name);if(h.size<=ie&&!Ue)return h;try{const et=await createImageBitmap(h),Ge=document.createElement("canvas");let dt=et.width,Qe=et.height;const ht=1200;return(dt>ht||Qe>ht)&&(dt>Qe?(Qe=Math.round(Qe/dt*ht),dt=ht):(dt=Math.round(dt/Qe*ht),Qe=ht)),Ge.width=dt,Ge.height=Qe,Ge.getContext("2d").drawImage(et,0,0,dt,Qe),et.close(),new Promise((xt,$t)=>{Ge.toBlob(Lt=>{Lt?xt(new File([Lt],h.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):$t(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(et){throw console.error("Compress error:",et),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh")}};useEffect(()=>{x(),R()},[k.id,k.uuid]);const x=async()=>{ce(!0);try{const h=await window.KTM.api.getJSON(`${API_BASE}/api/albums/${k.uuid||k.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");de(h.images||[]);const U=await window.KTM.api.getJSON(`${API_BASE}/api/albums?parent_id=${k.uuid||k.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");ue(Array.isArray(U)?U:[])}catch(h){console.error(h),G("L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u","danger")}ce(!1)},R=async()=>{try{const h=await window.KTM.api.getJSON(`${API_BASE}/api/albums`,"L\u1ED7i t\u1EA3i album");B(Array.isArray(h)?h:[])}catch(h){console.error("Error loading albums:",h)}},W=h=>{Y(U=>U.includes(h)?U.filter(ie=>ie!==h):[...U,h])},Te=async()=>{if(!fe||K.length===0){G("Vui l\xF2ng ch\u1ECDn folder \u0111\xEDch","warning");return}g(!0);let h=0;for(const U of K)try{await window.KTM.api.putJSON(`${API_BASE}/api/images/${U}`,{album_id:fe},"L\u1ED7i di chuy\u1EC3n \u1EA3nh"),h++}catch(ie){console.error("Move error:",ie)}g(!1),T(!1),Y([]),Ke(""),h>0?(G("\u0110\xE3 di chuy\u1EC3n \u1EA3nh th\xE0nh c\xF4ng!","success"),x(),O()):G("Di chuy\u1EC3n th\u1EA5t b\u1EA1i","danger")},[je,X]=useState(!1),Ee=async()=>{if(K.length===0||!confirm(`X\xF3a ${K.length} \u1EA3nh \u0111\xE3 ch\u1ECDn? H\xE0nh \u0111\u1ED9ng n\xE0y kh\xF4ng th\u1EC3 ho\xE0n t\xE1c!`))return;X(!0);let h=0;for(const U of K)try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${U}`,"L\u1ED7i x\xF3a \u1EA3nh"),h++}catch(ie){console.error("Delete error:",ie)}X(!1),Y([]),h>0?(G(`\u0110\xE3 x\xF3a ${h} \u1EA3nh!`,"success"),x(),O()):G("X\xF3a th\u1EA5t b\u1EA1i","danger")},Ye=()=>{K.length===re.length?Y([]):Y(re.map(h=>h.id))},pt=async()=>{if(qe.trim()){M(!0);try{const h=qe.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");await window.KTM.api.postJSON(`${API_BASE}/api/albums`,{slug:h+"-"+Date.now(),title:qe,parent_id:k.uuid||k.id},"L\u1ED7i t\u1EA1o folder"),G("T\u1EA1o folder th\xE0nh c\xF4ng!","success"),Re(""),Ce(!1),x(),O()}catch(h){G(h.message,"danger")}M(!1)}},ge=async h=>{if(confirm(`X\xF3a folder "${h.title}"? T\u1EA5t c\u1EA3 n\u1ED9i dung b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${h.uuid||h.id}`,"L\u1ED7i x\xF3a folder"),G("\u0110\xE3 x\xF3a folder","success"),x(),O()}catch(U){G("L\u1ED7i x\xF3a folder","danger")}},Je=h=>{const U=Array.from(h).filter(ie=>ie.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(ie.name));we(ie=>[...ie,...U]),U.forEach(ie=>{const Ue=new FileReader;Ue.onload=et=>{Ie(Ge=>[...Ge,{file:ie,preview:et.target.result}])},Ue.readAsDataURL(ie)})},A=h=>{we(U=>U.filter((ie,Ue)=>Ue!==h)),Ie(U=>U.filter((ie,Ue)=>Ue!==h))},ze=async h=>{var ie;const U=await window.KTM.cloudinary.uploadImage({file:h,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:`ktm-albums/${k.id}`});if(!U.secure_url)throw console.error("Cloudinary error:",U),new Error(((ie=U.error)==null?void 0:ie.message)||"Upload failed");return U},ae=async()=>{if(ve.length===0)return;he(!0);let h=0;for(let U=0;U<ve.length;U++)try{me(`\u0110ang x\u1EED l\xFD ${U+1}/${ve.length}...`);const ie=await pe(ve[U],2);me(`\u0110ang upload ${U+1}/${ve.length}...`);const Ue=await ze(ie);await window.KTM.api.postJSON(`${API_BASE}/api/albums/${k.id}`,{url:Ue.secure_url,caption:_e[U]||ve[U].name.replace(/\.[^/.]+$/,""),sort_order:re.length+U},"L\u1ED7i l\u01B0u \u1EA3nh"),h++}catch(ie){console.error("Upload error:",ie)}he(!1),me(""),we([]),Ie([]),ye({}),h>0?(G(`\u0110\xE3 upload ${h} \u1EA3nh th\xE0nh c\xF4ng!`,"success"),x(),O()):G("Upload th\u1EA5t b\u1EA1i","danger")},lt=async(h,U)=>{if(confirm("X\xF3a \u1EA3nh n\xE0y?"))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${h}`,"L\u1ED7i x\xF3a \u1EA3nh"),G("\u0110\xE3 x\xF3a \u1EA3nh","success"),x(),O()}catch(ie){G("L\u1ED7i x\xF3a \u1EA3nh","danger")}},ct=h=>{var U;h.preventDefault(),(U=b.current)==null||U.classList.add("dragover")},Ze=()=>{var h;(h=b.current)==null||h.classList.remove("dragover")},ft=h=>{var U;h.preventDefault(),(U=b.current)==null||U.classList.remove("dragover"),Je(h.dataTransfer.files)};return React.createElement("div",null,React.createElement("div",{className:"d-flex align-items-center justify-content-between mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:w},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("h4",{className:"m-0"},k.title),React.createElement("small",{className:"text-muted"},z.length>0&&React.createElement("span",null,z.length," folder \u2022 "),re.length," \u1EA3nh"))),React.createElement("button",{className:"btn btn-outline-warning btn-sm",onClick:()=>Ce(!0)},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder con")),tt&&React.createElement("div",{className:"card mb-4 border-warning"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder-plus me-2 text-warning"}),"T\u1EA1o folder con"),React.createElement("div",{className:"d-flex gap-2"},React.createElement("input",{type:"text",className:"form-control",placeholder:"T\xEAn folder...",value:qe,onChange:h=>Re(h.target.value),onKeyPress:h=>h.key==="Enter"&&pt(),autoFocus:!0}),React.createElement("button",{className:"btn btn-warning",onClick:pt,disabled:m||!qe.trim()},m?React.createElement("span",{className:"spinner-border spinner-border-sm"}):"T\u1EA1o"),React.createElement("button",{className:"btn btn-secondary",onClick:()=>{Ce(!1),Re("")}},"H\u1EE7y")))),z.length>0&&React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),"Folder con"),React.createElement("div",{className:"row g-2"},z.map(h=>React.createElement("div",{key:h.uuid||h.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-item",style:{cursor:"pointer"},onClick:()=>F&&F(h)},React.createElement("div",{className:"card-body text-center py-3"},React.createElement("i",{className:"fas fa-folder fa-2x text-warning mb-2"}),React.createElement("div",{className:"small fw-bold text-truncate"},h.title),React.createElement("small",{className:"text-muted"},h.subfolderCount>0&&React.createElement("span",null,h.subfolderCount," folder"),h.subfolderCount>0&&h.count>0&&" \u2022 ",h.count>0&&React.createElement("span",null,h.count," \u1EA3nh"),h.subfolderCount===0&&h.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0 text-center"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-1",onClick:U=>{U.stopPropagation(),C&&C(h)},title:"S\u1EEDa folder"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:U=>{U.stopPropagation(),ge(h)},title:"X\xF3a folder"},React.createElement("i",{className:"fas fa-trash"}))))))))),React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-cloud-upload-alt me-2"}),"Upload \u1EA3nh m\u1EDBi"),React.createElement("div",{ref:b,className:"upload-zone",onClick:()=>{var h;return(h=i.current)==null?void 0:h.click()},onDragOver:ct,onDragLeave:Ze,onDrop:ft},React.createElement("i",{className:"fas fa-images fa-2x text-muted mb-2"}),React.createElement("p",{className:"mb-0"},"K\xE9o th\u1EA3 \u1EA3nh v\xE0o \u0111\xE2y ho\u1EB7c click \u0111\u1EC3 ch\u1ECDn"),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3 JPG, PNG, WebP"),React.createElement("input",{ref:i,type:"file",multiple:!0,accept:"image/*",onChange:h=>Je(h.target.files)})),Le.length>0&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"upload-preview"},Le.map((h,U)=>React.createElement("div",{key:U,className:"upload-preview-item"},React.createElement("img",{src:h.preview,alt:""}),React.createElement("button",{className:"remove",onClick:()=>A(U)},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("div",{className:"mt-3"},React.createElement("button",{className:"btn btn-warning",onClick:ae,disabled:se},se?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),He||"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload ",ve.length," \u1EA3nh")))))),React.createElement("div",{className:"card"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("h6",{className:"m-0"},React.createElement("i",{className:"fas fa-th me-2"}),"\u1EA2nh (",re.length,")"),re.length>0&&React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:Ye},K.length===re.length?"B\u1ECF ch\u1ECDn":"Ch\u1ECDn t\u1EA5t c\u1EA3")),K.length>0&&React.createElement("div",{className:"d-flex align-items-center gap-2 flex-wrap"},React.createElement("span",{className:"badge bg-primary"},K.length," \u0111\xE3 ch\u1ECDn"),React.createElement("button",{className:"btn btn-sm btn-info",onClick:()=>T(!0)},React.createElement("i",{className:"fas fa-folder-open me-1"}),"Di chuy\u1EC3n"),React.createElement("button",{className:"btn btn-sm btn-danger",onClick:Ee,disabled:je},je?React.createElement("span",{className:"spinner-border spinner-border-sm"}):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-trash me-1"}),"X\xF3a")),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>Y([])},React.createElement("i",{className:"fas fa-times"})))),xe?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):re.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},React.createElement("i",{className:"fas fa-image fa-2x mb-2"}),React.createElement("p",null,"Ch\u01B0a c\xF3 \u1EA3nh n\xE0o trong album n\xE0y")):React.createElement("div",{className:"image-grid"},re.map((h,U)=>React.createElement("div",{key:U,className:`image-item ${K.includes(h.id)?"selected":""}`,style:{position:"relative",cursor:"pointer"},onClick:()=>W(h.id)},React.createElement("div",{className:"select-checkbox",style:{position:"absolute",top:"6px",left:"6px",zIndex:10,width:"24px",height:"24px",borderRadius:"4px",background:K.includes(h.id)?"#0d6efd":"rgba(255,255,255,0.9)",border:K.includes(h.id)?"none":"2px solid #ccc",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"}},K.includes(h.id)&&React.createElement("i",{className:"fas fa-check",style:{color:"#fff",fontSize:"12px"}})),React.createElement("img",{src:h.src,alt:h.caption,style:{opacity:K.includes(h.id)?.7:1,border:K.includes(h.id)?"3px solid #0d6efd":"none",borderRadius:"8px"}}),React.createElement("div",{className:"actions"},React.createElement("button",{className:"btn btn-sm btn-danger",onClick:ie=>{ie.stopPropagation(),lt(h.id,U)},title:"X\xF3a \u1EA3nh"},React.createElement("i",{className:"fas fa-trash"}))),h.caption&&React.createElement("div",{className:"p-2 bg-light small text-truncate"},h.caption)))))),v&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header bg-info text-white"},React.createElement("h5",{className:"modal-title"},React.createElement("i",{className:"fas fa-folder-open me-2"}),"Di chuy\u1EC3n ",K.length," \u1EA3nh"),React.createElement("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>T(!1)})),React.createElement("div",{className:"modal-body",style:{maxHeight:"400px",overflowY:"auto"}},React.createElement("p",{className:"text-muted small mb-3"},"Ch\u1ECDn th\u01B0 m\u1EE5c \u0111\xEDch:"),React.createElement("div",{className:"folder-tree"},P.filter(h=>!h.parentId).map(h=>React.createElement(FolderTreeItem,{key:h.uuid||h.id,folder:h,allAlbums:P,currentAlbumId:k.uuid||k.id,targetAlbum:fe,onSelect:Ke})))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>T(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-info",onClick:Te,disabled:!fe||u},u?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang chuy\u1EC3n..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-1"}),"Di chuy\u1EC3n \u0111\u1EBFn \u0111\xE2y")))))),De&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.9)"},onClick:()=>Ae(null)},React.createElement("div",{className:"modal-dialog modal-fullscreen d-flex align-items-center justify-content-center"},React.createElement("div",{className:"position-relative",style:{maxWidth:"95vw",maxHeight:"95vh"}},React.createElement("button",{className:"btn btn-light position-absolute",style:{top:"-50px",right:"0",borderRadius:"50%",width:"40px",height:"40px"},onClick:()=>Ae(null)},React.createElement("i",{className:"fas fa-times"})),React.createElement("img",{src:De.src,alt:De.caption,style:{maxWidth:"95vw",maxHeight:"90vh",objectFit:"contain"},onClick:h=>h.stopPropagation()}),De.caption&&React.createElement("div",{className:"text-white text-center mt-2"},De.caption)))))}function SearchCenter({showToast:k,onNavigate:w}){const[O,G]=useState(""),[F,C]=useState([]),[_,re]=useState([]),[de,z]=useState([]),[ue,xe]=useState("all"),[ce,se]=useState(null),[he,He]=useState("list"),[me,ve]=useState(!0),[we,Le]=useState([]),[Ie,_e]=useState([]),ye=useRef(null),[De,Ae]=useState(!0),[tt,Ce]=useState(!1),qe=useRef(null),[Re,m]=useState(!1),[M,i]=useState([{role:"assistant",content:`Xin ch\xE0o! H\xE3y h\u1ECFi t\xF4i v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3... V\xED d\u1EE5:
\u2022 "Gi\xE1 van 2 tay?"
\u2022 "Combo r\u1EBB nh\u1EA5t?"
\u2022 "Freeship?"`,attachments:[]}]),[b,v]=useState(""),[T,K]=useState(!1),Y=useRef(null),P=useRef(null),[B,fe]=useState(null),[Ke,u]=useState(!1),[g,pe]=useState(null),[x,R]=useState(!1),[W,Te]=useState(!1),[je,X]=useState(null),[Ee,Ye]=useState({name:"",code:"",price:"",image:"",category:"",note:"",commission_percent:""}),pt=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"],ge=s=>{var N,I;s._type==="product"&&(pe(s),Ye({name:s.name||"",code:s.code||"",price:s.price||"",image:s.image||"",category:s.category||"",note:s.note||"",commission_percent:(I=(N=s.commission_percent)!=null?N:s.commissionPercent)!=null?I:""}),u(!0))},Je=async()=>{if(g)try{await window.KTM.api.putJSON(`${API_BASE}/api/products?id=${g.id}`,Ee,"L\u1ED7i c\u1EADp nh\u1EADt"),k("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),u(!1),pe(null),ct()}catch(s){k(s.message,"danger")}},A=async s=>{const N=s._type==="product"?"s\u1EA3n ph\u1EA9m":s._type==="album"?"\u1EA3nh":"video";if(confirm(`X\xF3a ${N} "${s.name}"?`))try{let I="";s._type==="product"?I=`${API_BASE}/api/products?id=${s.id}`:s._type==="album"?I=`${API_BASE}/api/images/${s.id}`:s._type==="video"&&(I=`${API_BASE}/api/videos/${s.id}`),await window.KTM.api.deleteJSON(I,"L\u1ED7i x\xF3a"),k(`\u0110\xE3 x\xF3a ${N}`,"success"),ct()}catch(I){k(I.message,"danger")}},ze=async s=>{try{const N=je?`${API_BASE}/api/products?id=${je.id}`:`${API_BASE}/api/products`;je?await window.KTM.api.putJSON(N,s,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(N,s,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),k(je?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Te(!1),X(null),ct()}catch(N){k(N.message,"danger")}},ae="ktm_admin_data_cache_v1",lt=1e3*60*10,ct=async()=>{let s=null,N=!1;const I=window.KTM.cache.read(ae,{ttlMs:lt,validate:Array.isArray});I.hit?(s=I.value,console.log("[CACHE] Using cache, items:",s.length),re(s),C(s),ve(!1),N=!0):I.status==="miss"?console.log("[CACHE] No cache found"):I.status==="expired"||I.status==="invalid"?console.log("[CACHE] Cache expired or invalid"):I.status==="error"&&console.error("[CACHE] Error parsing cache"),N||ve(!0);try{const J=async(We,Fe)=>{try{const at=await window.KTM.api.getJSON(We,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");return at!=null?at:Fe}catch(at){return Fe}},[ee,j,p]=await Promise.all([J(`${API_BASE}/api/products?fields=search`,[]),J(`${API_BASE}/api/albums`,[]),J(`${API_BASE}/api/video-folders?withVideos=true`,[])]),q=Array.isArray(ee)?ee.map(We=>({...We,_type:"product",_source:"database"})):[];Le(j);let te=[];Array.isArray(j)&&j.length>0&&(await Promise.all(j.map(Fe=>J(`${API_BASE}/api/albums/${Fe.id}`,{})))).forEach((Fe,at)=>{const bt=j[at];Fe.images&&Fe.images.length>0&&Fe.images.forEach(mt=>{te.push({id:mt.id,name:mt.caption||"\u1EA2nh t\u1EEB "+bt.title,image:mt.src,folder:bt.title,_type:"album",_source:"database"})})}),_e(p);let ne=[];Array.isArray(p)&&p.forEach(We=>{We.videos&&We.videos.forEach(Fe=>{ne.push({id:Fe.id,name:Fe.title,folder:We.name,image:Fe.thumb,youtubeId:Fe.youtubeId,url:Fe.url,_type:"video",_source:"database"})})});const Q=[...q,...te,...ne];(!s||JSON.stringify(Q)!==JSON.stringify(s))&&(re(Q),C(Q),window.KTM.cache.write(ae,Q))}catch(J){console.error("Song song fetch error:",J)}ve(!1)};useEffect(()=>{ct(),setTimeout(()=>{var s;return(s=ye.current)==null?void 0:s.focus()},100)},[]);const Ze=s=>{try{return String(s!=null?s:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(N){return String(s!=null?s:"").toLowerCase()}},ft=s=>{const I=Ze(s).trim().split(/\s+/).filter(Boolean),J=I.includes("anh"),ee=I.includes("video"),j=I.filter(te=>te!=="anh"&&te!=="video"),p=j.join(" "),q=new Set(["product"]);return J&&q.add("album"),ee&&q.add("video"),{allowedTypes:q,includeAlbum:J,includeVideo:ee,contentTokens:j,cleanedQuery:p}},h=(s,N,I)=>{var We,Fe,at,bt,mt;const J=Array.isArray(N)?N:[],ee=Ze(I).trim();if(!J.length&&!ee)return 0;const j=Ze((We=s==null?void 0:s.name)!=null?We:""),p=Ze((Fe=s==null?void 0:s.code)!=null?Fe:""),q=Ze((at=s==null?void 0:s.category)!=null?at:""),te=Ze((bt=s==null?void 0:s.note)!=null?bt:""),ne=Ze((mt=s==null?void 0:s.folder)!=null?mt:"");if(!`${j} ${p} ${q} ${te} ${ne}`.trim())return 0;let be=0;ee&&(j===ee&&(be+=220),j.includes(ee)&&(be+=140),j.startsWith(ee)&&(be+=160),p&&p===ee&&(be+=180),p&&p.includes(ee)&&(be+=90));for(const ut of J){if(!ut)continue;const Be=new RegExp(`(?:^|\\s)${ut.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}`);j.includes(ut)&&(be+=35),Be.test(j)&&(be+=25),p&&p.includes(ut)&&(be+=20),p&&Be.test(p)&&(be+=10),q&&q.includes(ut)&&(be+=12),ne&&ne.includes(ut)&&(be+=12),te&&te.includes(ut)&&(be+=6)}return be>0&&j&&(be+=Math.max(0,10-Math.min(10,Math.floor(j.length/10)))),be},U=(s,N,I)=>{const J=Array.isArray(s)?s:[];return J.length?J.map((j,p)=>({it:j,idx:p,score:h(j,N,I)})).sort((j,p)=>p.score!==j.score?p.score-j.score:j.idx-p.idx).map(j=>j.it):[]},ie=async(s,N)=>{if(!(!De||N.length===0)){Ce(!0);try{const I=N.map(ee=>({id:ee.id,name:ee.name,price:ee.price,category:ee.category,note:ee.note,folder:ee.folder,_type:ee._type})),J=await window.KTM.api.postJSON(`${API_BASE}/api/ai-search`,{query:s,products:I},"AI Search error");if(J&&J.matchedIds&&J.matchedIds.length>0){const{contentTokens:ee,cleanedQuery:j}=ft(s),p=new Set(J.matchedIds),q=N.filter(te=>p.has(te.id)).sort((te,ne)=>h(ne,ee,j)-h(te,ee,j));q.length>0&&C(q)}else J&&J.matchedIds&&J.matchedIds.length===0&&C([])}catch(I){console.error("AI Search error:",I)}Ce(!1)}},Ue=s=>{if(G(s),qe.current&&clearTimeout(qe.current),!s.trim()){et(ue);return}const{allowedTypes:N,contentTokens:I,cleanedQuery:J}=ft(s),ee=_.filter(p=>{if(!N.has(p==null?void 0:p._type))return!1;if(I.length===0)return!0;const q=Ze(Object.entries(p).filter(([te])=>!te.startsWith("_")).map(([,te])=>String(te||"")).join(" "));return I.some(te=>q.includes(te))});let j=ee;ue!=="all"&&(j=ee.filter(p=>(p.category||p._type)===ue)),C(U(j,I,J)),De&&J.length>=3&&(qe.current=setTimeout(()=>{ie(J,j)},500))},et=s=>{xe(s);const{allowedTypes:N,contentTokens:I}=ft(O),{cleanedQuery:J}=ft(O);let ee=_.filter(j=>N.has(j==null?void 0:j._type));s!=="all"&&(ee=ee.filter(j=>(j.category||j._type)===s)),O.trim()&&I.length>0&&(ee=ee.filter(j=>{const p=Ze(Object.entries(j).filter(([q])=>!q.startsWith("_")).map(([,q])=>String(q||"")).join(" "));return I.every(q=>p.includes(q))})),C(U(ee,I,J))},Ge=(s,N)=>{window.KTM.clipboard.writeText(s).then(()=>{se(N),k("\u0110\xE3 copy!","success"),setTimeout(()=>se(null),1500)})},dt=async(s,N)=>{try{await window.KTM.clipboard.writeImageFromUrl(s),se(N+"-img"),k("\u0110\xE3 copy \u1EA3nh!","success"),setTimeout(()=>se(null),1500)}catch(I){Ge(s,N+"-img")}},Qe=s=>{let N=s.toLowerCase();const I=[],J=_.filter(p=>p._type==="product");if(N.includes("ty")||N.includes("xy lanh")){if(N.includes("gi\u1EEFa")||N.includes("giua")){const p=J.find(q=>{var te;return(te=q.name)==null?void 0:te.toLowerCase().includes("xy lanh gi\u1EEFa")});p&&!I.find(q=>q.id===p.id)&&I.push(p)}if(N.includes("nghi\xEAng")||N.includes("nghieng")){const p=J.find(q=>{var te;return(te=q.name)==null?void 0:te.toLowerCase().includes("xy lanh nghi\xEAng")});p&&!I.find(q=>q.id===p.id)&&I.push(p)}if(N.includes("\u1EE7i")||N.includes("ui")){const p=J.find(q=>{var te;return(te=q.name)==null?void 0:te.toLowerCase().includes("xy lanh \u1EE7i")});p&&!I.find(q=>q.id===p.id)&&I.push(p)}}const ee=N.match(/van\s*(\d+)\s*tay.*?(\d+)\s*ty/);if(ee){const p=ee[1],q=ee[2],te=J.find(ne=>{var be;const Q=((be=ne.name)==null?void 0:be.toLowerCase())||"";return Q.includes("combo")&&Q.includes(`${p} tay`)&&(Q.includes(`${q} xy`)||Q.includes(`${q} xylanh`))});if(te&&!I.find(ne=>ne.id===te.id))I.push(te);else{const ne=J.find(Q=>{var We;const be=((We=Q.name)==null?void 0:We.toLowerCase())||"";return be.includes("combo")&&be.includes(`${p} tay`)});ne&&!I.find(Q=>Q.id===ne.id)&&I.push(ne)}}if(N.includes("combo")&&!ee){const p=N.match(/combo.*?(\d+)\s*tay/);if(p){const q=p[1];J.filter(ne=>{var be;const Q=((be=ne.name)==null?void 0:be.toLowerCase())||"";return Q.includes("combo")&&Q.includes(`${q} tay`)}).forEach(ne=>{I.find(Q=>Q.id===ne.id)||I.push(ne)})}}const j=N.match(/van\s*(\d+)\s*tay/);if(j&&!N.includes("ty")&&!N.includes("combo")){const p=j[1],q=J.find(te=>{var Q;const ne=((Q=te.name)==null?void 0:Q.toLowerCase())||"";return ne.includes(`van ${p} tay`)&&!ne.includes("combo")});q&&!I.find(te=>te.id===q.id)&&I.push(q)}return I.slice(0,4)},ht=async s=>{if(!s.trim())return;const N={role:"user",content:s,attachments:[]};i(J=>[...J,N]),v(""),K(!0);const I=Qe(s);setTimeout(()=>{var J;return(J=Y.current)==null?void 0:J.scrollIntoView({behavior:"smooth"})},100);try{const ee=_.filter(Q=>Q._type==="product").map(Q=>{let be=`- ${Q.name}`;return Q.code&&(be+=` (M\xE3: ${Q.code})`),Q.price&&(be+=` - Gi\xE1: ${Q.price.replace(/[đ\s]/g,"")}\u0111`),Q.category&&(be+=` [${Q.category}]`),Q.note&&(be+=` (${Q.note})`),be}).join(`
`),p=M.slice(-6).map(Q=>`${Q.role==="user"?"Kh\xE1ch":"AI"}: ${Q.content}`).join(`
`),q=p?`L\u1ECACH S\u1EEC H\u1ED8I THO\u1EA0I:
${p}

DANH S\xC1CH S\u1EA2N PH\u1EA8M:
${ee}`:ee,ne=(await window.KTM.api.postJSON(`${API_BASE}/api/ai-chat`,{message:s,context:q,audience:"admin"},"API error")).response||"Xin l\u1ED7i, t\xF4i kh\xF4ng th\u1EC3 tr\u1EA3 l\u1EDDi l\xFAc n\xE0y.";i(Q=>[...Q,{role:"assistant",content:ne,attachments:I}])}catch(J){console.error("AI Error:",J);const ee=s.toLowerCase(),j=_.filter(q=>{const te=Object.values(q).join(" ").toLowerCase();return ee.split(" ").some(ne=>te.includes(ne))});let p="";j.length>0?(p=`T\xECm th\u1EA5y ${j.length} s\u1EA3n ph\u1EA9m li\xEAn quan:

`,j.slice(0,5).forEach(q=>{p+=`\u2022 ${q.name}`,q.price&&(p+=` - ${q.price.replace(/[đ\s]/g,"")}\u0111`),q.note&&(p+=` (${q.note})`),p+=`
`}),j.length>5&&(p+=`
...v\xE0 ${j.length-5} s\u1EA3n ph\u1EA9m kh\xE1c`)):p='Kh\xF4ng t\xECm th\u1EA5y s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p. H\xE3y th\u1EED t\u1EEB kh\xF3a kh\xE1c nh\u01B0 "van", "combo", "xy lanh"...',i(q=>[...q,{role:"assistant",content:p,attachments:j.slice(0,4)}])}K(!1),setTimeout(()=>{var J,ee;(J=Y.current)==null||J.scrollIntoView({behavior:"smooth"}),(ee=P.current)==null||ee.focus()},100)};function Vt({show:s,product:N,categories:I,onClose:J,onSave:ee}){const[j,p]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[q,te]=useState(!1),[ne,Q]=useState(!1),be=useRef(null),We=$=>window.KTM.money.formatVNDInputDigits($),Fe=$=>{const L=window.KTM.money.getDigits(String($!=null?$:"")),H=Number(L);return L&&Number.isFinite(H)?Math.trunc(H):0},at=($,L)=>{if($==null||$==="")return[];let H=$;if(typeof H=="string"){const oe=H.trim();if(!oe)return[];try{H=JSON.parse(oe)}catch(le){return[]}}if(!Array.isArray(H))return[];const E=Fe(L);return H.map(oe=>{var Me;if(!oe||typeof oe!="object")return null;const le=String((Me=oe.name)!=null?Me:"").trim(),Ne=(Array.isArray(oe.options)?oe.options:[]).map(Pe=>{var vt,yt,St,Nt,It,Dt,Wt;if(!Pe||typeof Pe!="object")return null;const Xe=String((vt=Pe.label)!=null?vt:"").trim();if(!Xe)return null;const ot=(It=(Nt=(St=(yt=Pe.price)!=null?yt:Pe.priceValue)!=null?St:Pe.unit_price)!=null?Nt:Pe.unitPrice)!=null?It:null,st=Number(ot);let $e=Number.isFinite(st)?Math.trunc(st):null;if($e==null){const ma=(Wt=(Dt=Pe.price_delta)!=null?Dt:Pe.priceDelta)!=null?Wt:null,Kt=Number(ma);Number.isFinite(Kt)&&($e=E+Math.trunc(Kt))}$e==null&&($e=E);const gt=String(Math.max(0,Math.trunc(Number($e)||0)));return{label:Xe,price:Math.max(0,Math.trunc(Number($e)||0)),priceDigits:gt}}).filter(Boolean);return{name:le||"Bi\u1EBFn th\u1EC3",options:Ne}}).filter(Boolean)},bt=$=>{if($==null||$==="")return[];let L=$;if(typeof L=="string"){const H=L.trim();if(!H)return[];try{L=JSON.parse(H)}catch(E){return[]}}return L&&typeof L=="object"&&!Array.isArray(L)&&(L=Object.entries(L).map(([H,E])=>({key:H,value:E}))),Array.isArray(L)?L.map(H=>{var Ne,Me,Pe,Xe,ot;if(!H||typeof H!="object")return null;const E=String((Pe=(Me=(Ne=H.key)!=null?Ne:H.name)!=null?Me:H.label)!=null?Pe:"").trim(),oe=String((Xe=H.value)!=null?Xe:"").trim(),le=String((ot=H.unit)!=null?ot:"").trim();return E?{key:E,value:oe,unit:le}:null}).filter(Boolean):[]};useEffect(()=>{var $,L;if(N)if(p({name:N.name||"",code:N.code||"",price:N.price||"",image:N.image||"",category:N.category||"",note:N.note||"",sort_order:N.sort_order||0,commission_percent:(L=($=N.commission_percent)!=null?$:N.commissionPercent)!=null?L:5,variants:at(N.variants,N.price),attributes:bt(N.attributes)}),N.price){const H=window.KTM.money.getDigits(N.price);_t(H),p(E=>({...E,price:We(H)}))}else _t("");else p({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),_t("")},[N,s]);const mt=$=>{p(L=>{var Ne;const H=Fe(L.price),E=String(H),oe=Array.isArray(L.variants)?[...L.variants]:[],le={...oe[$]||{},options:Array.isArray((Ne=oe[$])==null?void 0:Ne.options)?[...oe[$].options]:[]};return le.options=le.options.map(Me=>({label:String((Me==null?void 0:Me.label)||""),price:H,priceDigits:E})),oe[$]=le,{...L,variants:oe}})},ut=()=>{p($=>{const L=Fe($.price),H=String(L),oe=(Array.isArray($.variants)?[...$.variants]:[]).map(le=>{const Ne=(Array.isArray(le==null?void 0:le.options)?le.options:[]).map(Me=>({label:String((Me==null?void 0:Me.label)||""),price:L,priceDigits:H}));return{name:String((le==null?void 0:le.name)||"Bi\u1EBFn th\u1EC3"),options:Ne}});return{...$,variants:oe}})},[Be,la]=React.useState(""),[ca,_t]=React.useState(""),Bt=$=>{const L=window.KTM.money.nextPriceInputState($.target.value,ca);_t(L.digits),p({...j,price:L.price})},da=async($,L=2)=>{const H=L*1024*1024;if($.size<=H)return $;try{const E=await createImageBitmap($),oe=document.createElement("canvas");let le=E.width,Ne=E.height;const Me=1200;return(le>Me||Ne>Me)&&(le>Ne?(Ne=Math.round(Ne/le*Me),le=Me):(le=Math.round(le/Ne*Me),Ne=Me)),oe.width=le,oe.height=Ne,oe.getContext("2d").drawImage(E,0,0,le,Ne),E.close(),new Promise((Xe,ot)=>{oe.toBlob(st=>{st?Xe(new File([st],$.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):ot(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(E){throw console.error("Compress error:",E),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},zt=async $=>{var E;const L=$.target.files[0];if(!L)return;if(!(L.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp)$/i.test(L.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}Q(!0);try{const oe=await da(L),le=await window.KTM.cloudinary.uploadImage({file:oe,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-products"});if(!le.secure_url)throw console.error("Cloudinary error:",le),new Error(((E=le.error)==null?void 0:E.message)||"Upload failed");p(Ne=>({...Ne,image:le.secure_url}))}catch(oe){console.error("Upload error:",oe),alert("L\u1ED7i upload \u1EA3nh: "+oe.message)}Q(!1),$.target.value=""},Jt=async $=>{$.preventDefault(),te(!0);const L={...j,variants:at(j.variants,j.price),attributes:bt(j.attributes)};await ee(L),te(!1)};return s?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-lg"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,border:"none",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark"},React.createElement("i",{className:"fas fa-box me-2"}),N?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:J})),React.createElement("form",{onSubmit:Jt},React.createElement("div",{className:"modal-body",style:{maxHeight:"70vh",overflowY:"auto"}},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-8"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-tag me-1"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:j.name,onChange:$=>p({...j,name:$.target.value}),placeholder:"V\xED d\u1EE5: Xy lanh nghi\xEAng KTM",required:!0,style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-hashtag me-1"}),"M\xE3 s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:j.code,onChange:$=>p({...j,code:$.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1"}),"Gi\xE1 b\xE1n"),React.createElement("input",{type:"text",className:"form-control",value:j.price,onChange:Bt,placeholder:"1.950.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3 mt-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-percent me-1"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:j.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:$=>p({...j,commission_percent:$.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-list me-1"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:j.category,onChange:$=>p({...j,category:$.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),I.map($=>React.createElement("option",{key:$,value:$},$)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1"}),"Ghi ch\xFA"),React.createElement("textarea",{className:"form-control",rows:"2",value:j.note,onChange:$=>p({...j,note:$.target.value}),placeholder:"V\xED d\u1EE5: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(j.attributes)?j.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(j.attributes)?j.attributes:[]).map(($,L)=>React.createElement("div",{key:L,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:($==null?void 0:$.key)||"",onChange:H=>{const E=H.target.value;p(oe=>{const le=Array.isArray(oe.attributes)?[...oe.attributes]:[];return le[L]={...le[L]||{},key:E},{...oe,attributes:le}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:($==null?void 0:$.value)||"",onChange:H=>{const E=H.target.value;p(oe=>{const le=Array.isArray(oe.attributes)?[...oe.attributes]:[];return le[L]={...le[L]||{},value:E},{...oe,attributes:le}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:($==null?void 0:$.unit)||"",onChange:H=>{const E=H.target.value;p(oe=>{const le=Array.isArray(oe.attributes)?[...oe.attributes]:[];return le[L]={...le[L]||{},unit:E},{...oe,attributes:le}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{p(H=>{const E=Array.isArray(H.attributes)?[...H.attributes]:[];return E.splice(L,1),{...H,attributes:E}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{p($=>{const L=Array.isArray($.attributes)?[...$.attributes]:[];return L.push({key:"",value:"",unit:""}),{...$,attributes:L}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(j.variants)?j.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3. C\xF3 th\u1EC3 th\xEAm (v\xED d\u1EE5 Size: S/M/L)."):null,(Array.isArray(j.variants)?j.variants:[]).map(($,L)=>React.createElement("div",{key:L,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:($==null?void 0:$.name)||"",onChange:H=>{const E=H.target.value;p(oe=>{var Ne;const le=Array.isArray(oe.variants)?[...oe.variants]:[];return le[L]={...le[L]||{},name:E,options:Array.isArray((Ne=le[L])==null?void 0:Ne.options)?le[L].options:[]},{...oe,variants:le}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>mt(L),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray($==null?void 0:$.options)||$.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{p(H=>{const E=Array.isArray(H.variants)?[...H.variants]:[];return E.splice(L,1),{...H,variants:E}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray($==null?void 0:$.options)?$.options:[]).map((H,E)=>{var oe,le;return React.createElement("div",{key:E,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(H==null?void 0:H.label)||"",onChange:Ne=>{const Me=Ne.target.value;p(Pe=>{var gt,vt,yt,St,Nt;const Xe=Array.isArray(Pe.variants)?[...Pe.variants]:[],ot={...Xe[L]||{},options:Array.isArray((gt=Xe[L])==null?void 0:gt.options)?[...Xe[L].options]:[]},st=Number((yt=(vt=ot.options[E])==null?void 0:vt.price)!=null?yt:0)||0,$e=String((Nt=(St=ot.options[E])==null?void 0:St.priceDigits)!=null?Nt:Math.max(0,Math.trunc(st)));return ot.options[E]={...ot.options[E]||{},label:Me,price:Math.max(0,Math.trunc(st)),priceDigits:$e},Xe[L]=ot,{...Pe,variants:Xe}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:We(String((le=H==null?void 0:H.priceDigits)!=null?le:window.KTM.money.getDigits(String((oe=H==null?void 0:H.price)!=null?oe:"")))),onChange:Ne=>{p(Me=>{var yt,St,Nt,It,Dt;const Pe=String((St=H==null?void 0:H.priceDigits)!=null?St:window.KTM.money.getDigits(String((yt=H==null?void 0:H.price)!=null?yt:""))),Xe=window.KTM.money.nextPriceInputState(Ne.target.value,Pe),ot=String((Nt=Xe.digits)!=null?Nt:""),st=Number(ot),$e=Number.isFinite(st)?Math.max(0,Math.trunc(st)):0,gt=Array.isArray(Me.variants)?[...Me.variants]:[],vt={...gt[L]||{},options:Array.isArray((It=gt[L])==null?void 0:It.options)?[...gt[L].options]:[]};return vt.options[E]={...vt.options[E]||{},label:String(((Dt=vt.options[E])==null?void 0:Dt.label)||""),price:$e,priceDigits:ot},gt[L]=vt,{...Me,variants:gt}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{p(Ne=>{var Xe;const Me=Array.isArray(Ne.variants)?[...Ne.variants]:[],Pe={...Me[L]||{},options:Array.isArray((Xe=Me[L])==null?void 0:Xe.options)?[...Me[L].options]:[]};return Pe.options.splice(E,1),Me[L]=Pe,{...Ne,variants:Me}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{p(H=>{var Ne;const E=Array.isArray(H.variants)?[...H.variants]:[],oe={...E[L]||{},options:Array.isArray((Ne=E[L])==null?void 0:Ne.options)?[...E[L].options]:[]},le=Fe(H.price);return oe.options.push({label:"",price:le,priceDigits:String(le)}),E[L]=oe,{...H,variants:E}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{p($=>{const L=Fe($.price),H=Array.isArray($.variants)?[...$.variants]:[],E=String(L);return H.push({name:"Size",options:[{label:"S",price:L,priceDigits:E},{label:"M",price:L,priceDigits:E},{label:"L",price:L,priceDigits:E}]}),{...$,variants:H}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:ut,disabled:!Array.isArray(j.variants)||j.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111.")))),React.createElement("div",{className:"col-md-4"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-image me-1"}),"\u1EA2nh s\u1EA3n ph\u1EA9m"),React.createElement("div",{className:"mb-2"},j.image?React.createElement(React.Fragment,null,React.createElement("img",{src:j.image,alt:"Product",style:{width:"100%",height:150,objectFit:"cover",borderRadius:"12px",border:"2px solid #e9ecef"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger mt-2",onClick:()=>p({...j,image:""}),style:{borderRadius:"20px",fontSize:"0.75rem"}},React.createElement("i",{className:"fas fa-times me-1"}),"X\xF3a \u1EA3nh")):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:"100%",height:150,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd",cursor:"pointer"},onClick:()=>{var $;return($=be.current)==null?void 0:$.click()}},React.createElement("div",{className:"text-center"},React.createElement("i",{className:"fas fa-cloud-upload-alt fa-2x text-muted mb-2"}),React.createElement("div",{className:"small text-muted"},"Click \u0111\u1EC3 upload")))),React.createElement("input",{ref:be,type:"file",accept:"image/*",className:"d-none",onChange:zt}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100",onClick:()=>{var $;return($=be.current)==null?void 0:$.click()},disabled:ne,style:{borderRadius:"10px"}},ne?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh")),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"Ho\u1EB7c URL \u1EA3nh"),React.createElement("input",{type:"url",className:"form-control",value:j.image,onChange:$=>p({...j,image:$.target.value}),placeholder:"https://...",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"8px",fontSize:"0.875rem"}}))))),React.createElement("div",{className:"modal-footer",style:{border:"none",padding:"20px"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:J,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:q,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},q?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}const xt=s=>window.KTM.money.formatVND(s),$t=s=>{if(s==null||s==="")return[];let N=s;if(typeof N=="string"){const I=N.trim();if(!I)return[];try{N=JSON.parse(I)}catch(J){return[]}}return Array.isArray(N)?N:[]},Lt=s=>{if(s==null||s==="")return[];let N=s;if(typeof N=="string"){const I=N.trim();if(!I)return[];try{N=JSON.parse(I)}catch(J){return[]}}return N&&typeof N=="object"&&!Array.isArray(N)&&(N=Object.entries(N).map(([I,J])=>({key:I,value:J}))),Array.isArray(N)?N:[]},Tt=(s,N={})=>{var j;const I=Lt(s).map(p=>{var q,te,ne,Q,be;return{key:String((ne=(te=(q=p==null?void 0:p.key)!=null?q:p==null?void 0:p.name)!=null?te:p==null?void 0:p.label)!=null?ne:"").trim(),value:String((Q=p==null?void 0:p.value)!=null?Q:"").trim(),unit:String((be=p==null?void 0:p.unit)!=null?be:"").trim()}}).filter(p=>!!p.key);if(!I.length)return null;const J=!!N.compact,ee=String((j=N.className)!=null?j:"").trim();return React.createElement("div",{className:`ktm-variants-preview${J?" compact":""}${ee?" "+ee:""}`},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},I.map((p,q)=>{const te=p.key,ne=`${p.value||""}${p.unit?(p.value?" ":"")+p.unit:""}`.trim();return React.createElement("div",{key:`${te}-${q}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},te),ne?React.createElement("span",{className:"ktm-chip ktm-chip-option"},ne):null)})))},jt=(s,N={})=>{var te;const I=$t(s).map(ne=>{var Q;return{name:String((Q=ne==null?void 0:ne.name)!=null?Q:"").trim(),options:Array.isArray(ne==null?void 0:ne.options)?ne.options:[]}}).map(ne=>({...ne,options:ne.options.map(Q=>{var be;return{label:String((be=Q==null?void 0:Q.label)!=null?be:"").trim(),price:Number(Q==null?void 0:Q.price)}}).filter(Q=>!!Q.label)})).filter(ne=>ne.options.length>0);if(!I.length)return null;const J=Number.isFinite(N.maxGroups)?Math.max(1,Math.trunc(N.maxGroups)):I.length,ee=Number.isFinite(N.maxOptionsPerGroup)?Math.max(1,Math.trunc(N.maxOptionsPerGroup)):3,j=!!N.compact,p=String((te=N.className)!=null?te:"").trim(),q=I.slice(0,J);return React.createElement("div",{className:`ktm-variants-preview${j?" compact":""}${p?" "+p:""}`},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},q.map((ne,Q)=>{const be=ne.name||"Bi\u1EBFn th\u1EC3",We=ne.options.slice(0,ee),Fe=ne.options.length-We.length;return React.createElement("div",{key:`${be}-${Q}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},be),We.map((at,bt)=>{const mt=at.price,ut=Number.isFinite(mt)&&mt>=0?xt(Math.trunc(mt)):"",Be=ut?`${at.label} \xB7 ${ut}`:at.label;return React.createElement("span",{key:`${be}-${Q}-${bt}`,className:"ktm-chip ktm-chip-option"},Be)}),Fe>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",Fe))})))},qt=(s,N)=>{const I=s._type==="product",J=s._type==="album",ee=s._type==="video",j=s.note&&(s.note.toLowerCase().includes("free")||s.note.toLowerCase().includes("gi\u1EA3m")||s.note.toLowerCase().includes("sale")),p=I?Tt(s.attributes,{compact:he==="grid",className:he==="grid"?"meta text-muted":"text-muted"}):null,q=I?jt(s.variants,{compact:he==="grid",maxOptionsPerGroup:999,className:he==="grid"?"meta text-muted":"text-muted"}):null;return he==="grid"?React.createElement("div",{key:s.id||N,className:"grid-card"},React.createElement("div",{className:"thumb-wrap",onClick:()=>fe({url:s.image,name:s.name,price:s.price,note:s.note,item:s})},s.image?React.createElement("img",{src:s.image,alt:s.name,className:"thumb",loading:"lazy"}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${ee?"fa-video":"fa-image"} fa-2x text-muted`})),s.price&&React.createElement("div",{className:"price-overlay"},s.price.replace(/[đ\s]/g,""),"\u0111"),React.createElement("span",{className:`type-badge ${I?"product":J?"album":"video"}`},I?"SP":J?"\u1EA2nh":"Video"),j&&React.createElement("span",{className:"promo-badge"},"\u{1F525} \u01AFU \u0110\xC3I")),React.createElement("div",{className:"card-body"},React.createElement("div",{className:"name"},s.name),s.note&&React.createElement("div",{className:"meta text-info",style:{fontSize:10}},s.note),p&&React.createElement("div",{style:{marginTop:2}},p),q&&React.createElement("div",{style:{marginTop:2}},q),React.createElement("div",{className:"quick-copy"},React.createElement("button",{className:ce===s.id+"-img"?"copied":"",onClick:()=>dt(s.image,s.id)},React.createElement("i",{className:"fas fa-image"})),s.price&&React.createElement("button",{className:ce===s.id+"-price"?"copied":"",onClick:()=>Ge(s.price.replace(/[đ\s]/g,""),s.id+"-price")},React.createElement("i",{className:"fas fa-tag"}))))):React.createElement("div",{key:s.id||N,className:"product-card-mobile"},React.createElement("span",{className:`type-badge ${I?"product":J?"album":"video"}`},I?"S\u1EA3n ph\u1EA9m":J?"\u1EA2nh":"Video"),React.createElement("div",{className:"card-inner"},s.image?React.createElement("img",{src:s.image,alt:s.name,className:"thumb",loading:"lazy",onClick:()=>fe({url:s.image,name:s.name,price:s.price,note:s.note,item:s})}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${ee?"fa-video":"fa-image"} fa-2x text-muted`})),React.createElement("div",{className:"info"},React.createElement("div",null,React.createElement("div",{className:"name"},s.name),React.createElement("div",{className:"price-row"},s.price&&React.createElement("span",{className:"price"},s.price.replace(/[đ\s]/g,""),"\u0111"),j&&React.createElement("span",{className:"badge-promo"},"\u{1F525} \u01AFU \u0110\xC3I")),p&&React.createElement("div",{style:{marginTop:4}},p),q&&React.createElement("div",{style:{marginTop:4}},q)),React.createElement("div",{className:"meta"},s.code&&React.createElement("span",{className:"meta-tag"},"#",s.code),s.category&&React.createElement("span",{className:"meta-tag"},s.category),s.note&&React.createElement("span",{className:"meta-tag highlight"},s.note),s.folder&&React.createElement("span",{className:"meta-tag"},s.folder),ee&&React.createElement("span",{className:"meta-tag"},React.createElement("i",{className:"fab fa-youtube text-danger"})," Video")))),React.createElement("div",{className:"quick-actions"},I&&React.createElement("button",{onClick:()=>w&&w("orders","create",{productId:s.id})},React.createElement("i",{className:"fas fa-receipt"})," T\u1EA1o \u0111\u01A1n"),s.price&&React.createElement("button",{className:ce===s.id+"-price"?"copied":"",onClick:()=>Ge(s.price.replace(/[đ\s]/g,""),s.id+"-price")},React.createElement("i",{className:"fas fa-tag"})," Gi\xE1"),React.createElement("button",{className:ce===s.id+"-name"?"copied":"",onClick:()=>Ge(s.name,s.id+"-name")},React.createElement("i",{className:"fas fa-font"})," T\xEAn"),ee&&s.youtubeId&&React.createElement("button",{className:ce===s.id+"-yt"?"copied":"",onClick:()=>Ge(`https://www.youtube.com/watch?v=${s.youtubeId}`,s.id+"-yt")},React.createElement("i",{className:"fab fa-youtube"})),I&&React.createElement("button",{className:"action-edit",onClick:()=>ge(s)},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"action-delete",onClick:()=>A(s)},React.createElement("i",{className:"fas fa-trash"}))))},[Pt,Ot]=useState(!1);return React.createElement(React.Fragment,null,React.createElement("div",{className:"result-header"},React.createElement("span",null,React.createElement("strong",null,F.length)," k\u1EBFt qu\u1EA3",De&&O.length>=3&&React.createElement("span",{className:"ai-badge ms-2"},React.createElement("i",{className:"fas fa-robot"})," AI"),ue!=="all"&&React.createElement("span",{className:"ms-2 badge bg-warning text-dark"},ue==="product"?"S\u1EA3n ph\u1EA9m":ue==="album"?"\u1EA2nh":"Video")),React.createElement("div",{className:"d-flex gap-1 align-items-center"},React.createElement("button",{className:`btn btn-sm ${he==="list"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>He("list"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-list"})),React.createElement("button",{className:`btn btn-sm ${he==="grid"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>He("grid"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-th"})))),React.createElement("div",{className:"search-results-area"},me?React.createElement("div",null,[...Array(8)].map((s,N)=>React.createElement("div",{key:N,className:"product-card-mobile mb-2",style:{opacity:.7}},React.createElement("div",{className:"card-inner"},React.createElement("div",{className:"thumb bg-light",style:{width:80,height:80,borderRadius:8}}),React.createElement("div",{className:"info",style:{flex:1,minWidth:0}},React.createElement("div",{className:"skeleton-box mb-2",style:{height:16,width:"60%",background:"#eee",borderRadius:4}}),React.createElement("div",{className:"skeleton-box mb-1",style:{height:12,width:"40%",background:"#f3f3f3",borderRadius:4}}),React.createElement("div",{className:"skeleton-box",style:{height:10,width:"30%",background:"#f3f3f3",borderRadius:4}})))))):F.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-search"}),React.createElement("p",null,'Kh\xF4ng t\xECm th\u1EA5y "',O,'"'),React.createElement("button",{className:"btn btn-warning",onClick:()=>{G(""),Ue("")}},"Xem t\u1EA5t c\u1EA3")):he==="grid"?React.createElement("div",{className:"product-grid-mobile"},F.map((s,N)=>qt(s,N))):React.createElement("div",null,F.map((s,N)=>qt(s,N)))),Pt&&React.createElement("div",{className:"filter-dropdown"},React.createElement("div",{className:"filter-header"},React.createElement("strong",null,"L\u1ECDc theo lo\u1EA1i"),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>Ot(!1)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"filter-chips"},React.createElement("span",{className:`filter-chip ${ue==="all"?"active":""}`,onClick:()=>{et("all"),Ot(!1)}},"T\u1EA5t c\u1EA3"),React.createElement("span",{className:`filter-chip ${ue==="product"?"active":""}`,onClick:()=>{et("product"),Ot(!1)}},React.createElement("i",{className:"fas fa-box me-1"}),"S\u1EA3n ph\u1EA9m"),React.createElement("span",{className:`filter-chip ${ue==="album"?"active":""}`,onClick:()=>{et("album"),Ot(!1)}},React.createElement("i",{className:"fas fa-images me-1"}),"\u1EA2nh"),React.createElement("span",{className:`filter-chip ${ue==="video"?"active":""}`,onClick:()=>{et("video"),Ot(!1)}},React.createElement("i",{className:"fas fa-video me-1"}),"Video")),React.createElement("div",{className:"mt-3 pt-3 border-top d-flex align-items-center justify-content-between"},React.createElement("span",null,"AI Search th\xF4ng minh"),React.createElement("div",{className:"form-check form-switch m-0"},React.createElement("input",{type:"checkbox",className:"form-check-input",checked:De,onChange:s=>Ae(s.target.checked),style:{width:40,height:20}})))),React.createElement("div",{className:"search-bar-bottom"},React.createElement("div",{className:"search-input-wrap"},React.createElement("input",{ref:ye,type:"text",className:"search-input",placeholder:"\u{1F50D} T\xECm: van 3 tay, xylanh...",value:O,onChange:s=>Ue(s.target.value)}),React.createElement("button",{className:`filter-btn ${Pt||ue!=="all"?"active":""}`,onClick:()=>Ot(!Pt)},React.createElement("i",{className:"fas fa-filter"})))),React.createElement("button",{className:"btn btn-lg rounded-circle position-fixed shadow-lg",style:{bottom:x?320:130,right:16,width:56,height:56,zIndex:1050,transition:"bottom 0.2s ease",background:"linear-gradient(135deg, #667eea, #764ba2)",color:"#fff",border:"none",WebkitTapHighlightColor:"transparent",touchAction:"manipulation",cursor:"pointer",outline:"none"},onClick:()=>m(!0),onTouchStart:()=>m(!0)},React.createElement("i",{className:"fas fa-robot fa-lg"})),Re&&React.createElement("div",{className:"ai-chat-mobile"},React.createElement("div",{className:"chat-header"},React.createElement("button",{className:"back-btn",onClick:()=>m(!1)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("strong",null,"KTM AI Assistant"),React.createElement("div",{style:{fontSize:11,opacity:.8}},"H\u1ECFi v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3..."))),React.createElement("div",{className:"chat-messages"},M.map((s,N)=>React.createElement("div",{key:N,className:`mb-3 ${s.role==="user"?"d-flex justify-content-end":""}`},React.createElement("div",{className:`p-3 rounded-3 position-relative ${s.role==="user"?"text-white":"bg-white border"}`,style:{maxWidth:"85%",whiteSpace:"pre-wrap",background:s.role==="user"?"linear-gradient(135deg, #667eea, #764ba2)":void 0}},s.content,s.role==="assistant"&&React.createElement("button",{className:"btn btn-sm position-absolute",style:{top:4,right:4,padding:"2px 6px",fontSize:11,background:ce===`chat-${N}`?"#28a745":"rgba(0,0,0,0.1)",border:"none",borderRadius:4,color:ce===`chat-${N}`?"#fff":"#666"},onClick:()=>{window.KTM.clipboard.writeText(s.content),se(`chat-${N}`),setTimeout(()=>se(null),1500)}},React.createElement("i",{className:`fas ${ce===`chat-${N}`?"fa-check":"fa-copy"}`})),s.attachments&&s.attachments.length>0&&React.createElement("div",{className:"mt-2 d-flex flex-wrap gap-2"},s.attachments.map((I,J)=>React.createElement("div",{key:J,style:{width:70},className:"text-center"},I.image&&React.createElement("img",{src:I.image,className:"rounded",style:{width:70,height:50,objectFit:"cover",cursor:"pointer"},onClick:()=>fe({url:I.image,name:I.name,price:I.price})}),React.createElement("div",{style:{fontSize:9},className:"text-truncate"},I.name),I.price&&React.createElement("div",{style:{fontSize:10,color:"#dc3545",fontWeight:600}},I.price.replace(/[đ\s]/g,""),"\u0111"))))))),T&&React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"bg-white border p-3 rounded-3 d-inline-block"},React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang suy ngh\u0129...")),React.createElement("div",{ref:Y})),React.createElement("div",{className:"px-3 py-2 border-top d-flex gap-2 overflow-auto"},["Gi\xE1 van 2 tay?","Combo r\u1EBB nh\u1EA5t?","Freeship?","Van 3 tay?"].map(s=>React.createElement("button",{key:s,className:"btn btn-sm btn-outline-secondary flex-shrink-0",onClick:()=>ht(s),disabled:T,style:{whiteSpace:"nowrap"}},s))),React.createElement("div",{className:"chat-input-area"},React.createElement("form",{onSubmit:s=>{s.preventDefault(),ht(b)},className:"chat-input-wrap"},React.createElement("input",{ref:P,type:"text",className:"chat-input",placeholder:"Nh\u1EADp c\xE2u h\u1ECFi...",value:b,onChange:s=>v(s.target.value),disabled:T}),React.createElement("button",{type:"submit",className:"send-btn",disabled:T||!b.trim()},React.createElement("i",{className:"fas fa-paper-plane"}))))),B&&React.createElement("div",{className:"preview-modal",onClick:()=>fe(null)},React.createElement("div",{className:"preview-header"},React.createElement("div",null),React.createElement("button",{className:"close-btn",onClick:()=>fe(null)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"preview-body",onClick:s=>s.stopPropagation()},React.createElement("img",{src:B.url,alt:B.name})),React.createElement("div",{className:"preview-footer",onClick:s=>s.stopPropagation()},React.createElement("div",{className:"name"},B.name),B.price&&React.createElement("div",{className:"price"},B.price.replace(/[đ\s]/g,""),"\u0111"),B.note&&React.createElement("div",{className:"mb-2",style:{fontSize:14,color:"#17a2b8"}},B.note),React.createElement("div",{className:"action-btns"},React.createElement("button",{className:ce==="preview-img"?"btn-success text-white":"btn-outline-light text-white",style:{background:ce==="preview-img"?"#28a745":"rgba(255,255,255,0.2)"},onClick:()=>dt(B.url,"preview")},React.createElement("i",{className:`fas ${ce==="preview-img"?"fa-check":"fa-copy"}`}),"Copy \u1EA3nh"),B.price&&React.createElement("button",{className:ce==="preview-price"?"btn-success text-white":"btn-warning",onClick:()=>Ge(B.price.replace(/[đ\s]/g,""),"preview-price")},React.createElement("i",{className:`fas ${ce==="preview-price"?"fa-check":"fa-tag"}`}),"Copy gi\xE1")))),React.createElement(Vt,{show:W,product:je,categories:de,onClose:()=>{Te(!1),X(null)},onSave:ze}),React.createElement("div",{className:`fab-container mobile-only ${x?"open":""}`},React.createElement("div",{className:"fab-actions"},React.createElement("button",{className:"fab-action product",onClick:()=>{R(!1),Te(!0),X(null)}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",{className:"tooltip"},"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("button",{className:"fab-action product",onClick:()=>{R(!1),w&&w("orders","create")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",{className:"tooltip"},"T\u1EA1o order nhanh"))),React.createElement("button",{className:`fab-main ${x?"open":""}`,onClick:()=>R(!x)},React.createElement("i",{className:"fas fa-plus"}))),Ke&&g&&React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,maxHeight:"90vh"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none"}},React.createElement("h6",{className:"modal-title fw-bold"},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa nhanh"),React.createElement("button",{type:"button",className:"btn-close",onClick:()=>u(!1)})),React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"T\xEAn s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:Ee.name,onChange:s=>Ye({...Ee,name:s.target.value})})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:Ee.code,onChange:s=>Ye({...Ee,code:s.target.value})})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:Ee.price,onChange:s=>Ye({...Ee,price:s.target.value})}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:Ee.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:s=>Ye({...Ee,commission_percent:s.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:Ee.category,onChange:s=>Ye({...Ee,category:s.target.value})},React.createElement("option",{value:""},"-- Ch\u1ECDn danh m\u1EE5c --"),pt.map(s=>React.createElement("option",{key:s,value:s},s)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Ghi ch\xFA (\u01B0u \u0111\xE3i)"),React.createElement("input",{type:"text",className:"form-control",value:Ee.note,placeholder:"VD: Free ship, Gi\u1EA3m 10%...",onChange:s=>Ye({...Ee,note:s.target.value})}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>u(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-warning",onClick:Je},React.createElement("i",{className:"fas fa-save me-1"}),"L\u01B0u"))))))}function VideoList({onRefresh:k,showToast:w}){const[O,G]=useState([]),[F,C]=useState([]),[_,re]=useState(!0),[de,z]=useState(null),[ue,xe]=useState(!1),[ce,se]=useState(null),[he,He]=useState(!1),[me,ve]=useState(null),[we,Le]=useState(null),[Ie,_e]=useState([]);useEffect(()=>{ye()},[]);const ye=async(u=null)=>{re(!0);try{const g=u?`${API_BASE}/api/video-folders?withVideos=true&parent_id=${u}`:`${API_BASE}/api/video-folders?withVideos=true&parent_id=root`,pe=await window.KTM.api.getJSON(g,"L\u1ED7i t\u1EA3i danh s\xE1ch folder");G(Array.isArray(pe)?pe:[])}catch(g){console.error(g),w("L\u1ED7i t\u1EA3i danh s\xE1ch folder","danger")}re(!1)},De=async u=>{try{const g=await window.KTM.api.getJSON(`${API_BASE}/api/videos?folderId=${u}`,"L\u1ED7i t\u1EA3i video");C(Array.isArray(g)?g:[])}catch(g){console.error(g)}},Ae=async u=>{if(u===0)return;const g=[...O];[g[u-1],g[u]]=[g[u],g[u-1]],G(g),await Ce(g)},tt=async u=>{if(u===O.length-1)return;const g=[...O];[g[u],g[u+1]]=[g[u+1],g[u]],G(g),await Ce(g)},Ce=async u=>{try{await Promise.all(u.map((g,pe)=>window.KTM.api.putJSON(`${API_BASE}/api/video-folders/${g.id}`,{sortOrder:pe},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),w("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(g){w("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),ye(we==null?void 0:we.id)}},qe=async u=>{if(u===0)return;const g=[...F];[g[u-1],g[u]]=[g[u],g[u-1]],C(g),await m(g)},Re=async u=>{if(u===F.length-1)return;const g=[...F];[g[u],g[u+1]]=[g[u+1],g[u]],C(g),await m(g)},m=async u=>{try{await Promise.all(u.map((g,pe)=>window.KTM.api.putJSON(`${API_BASE}/api/videos/${g.id}`,{sort_order:pe},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),w("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(g){w("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),De(de.id)}},M=()=>{se(null),xe(!0)},i=u=>{se(u),xe(!0)},b=async u=>{try{!ce&&we&&(u.parent_id=we.id);const g=ce?`${API_BASE}/api/video-folders/${ce.id}`:`${API_BASE}/api/video-folders`;ce?await window.KTM.api.putJSON(g,u,"L\u1ED7i l\u01B0u folder"):await window.KTM.api.postJSON(g,u,"L\u1ED7i l\u01B0u folder"),w(ce?"\u0110\xE3 c\u1EADp nh\u1EADt folder!":"\u0110\xE3 t\u1EA1o folder m\u1EDBi!","success"),xe(!1),ye(we==null?void 0:we.id)}catch(g){w(g.message,"danger")}},v=async u=>{const g=u.subfolderCount>0?`X\xF3a folder "${u.name}"? T\u1EA5t c\u1EA3 subfolder v\xE0 videos b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`:`X\xF3a folder "${u.name}"? Videos trong folder s\u1EBD kh\xF4ng b\u1ECB x\xF3a.`;if(confirm(g))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/video-folders/${u.id}`,"L\u1ED7i x\xF3a folder"),w("\u0110\xE3 x\xF3a folder","success"),z(null),ye(we==null?void 0:we.id)}catch(pe){w("L\u1ED7i x\xF3a folder","danger")}},T=u=>{u.subfolderCount>0?(_e(g=>[...g,u]),Le(u),ye(u.id)):(z(u),C(u.videos||[]))},K=u=>{if(u==="root")_e([]),Le(null),ye(null);else if(u){const g=Ie.findIndex(pe=>pe.id===u.id);g>=0&&(_e(Ie.slice(0,g+1)),Le(u),ye(u.id))}else{const g=[...Ie];g.pop();const pe=g[g.length-1]||null;_e(g),Le(pe),ye(pe==null?void 0:pe.id)}},Y=()=>{ve(null),He(!0)},P=u=>{ve(u),He(!0)},B=async u=>{try{u.folder_id=de==null?void 0:de.id;const g=me?`${API_BASE}/api/videos/${me.id}`:`${API_BASE}/api/videos`;me?await window.KTM.api.putJSON(g,u,"L\u1ED7i l\u01B0u video"):await window.KTM.api.postJSON(g,u,"L\u1ED7i l\u01B0u video"),w(me?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm video th\xE0nh c\xF4ng!","success"),He(!1),ye(),de&&De(de.id)}catch(g){w(g.message,"danger")}},fe=async u=>{if(confirm(`X\xF3a video "${u.title}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/videos/${u.id}`,"L\u1ED7i x\xF3a video"),w("\u0110\xE3 x\xF3a video","success"),ye(),de&&De(de.id)}catch(g){w("L\u1ED7i x\xF3a video","danger")}},Ke=u=>{const g=`https://www.youtube.com/watch?v=${u.youtubeId}`;window.KTM.clipboard.writeText(g).then(()=>{w("\u0110\xE3 copy link!","success")}).catch(()=>{w("Kh\xF4ng th\u1EC3 copy link","danger")})};return de?React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>z(null)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:`fas fa-folder-open me-2 ${de.slug==="shorts"?"text-danger":"text-warning"}`}),de.name)),React.createElement("button",{className:"btn btn-warning",onClick:Y},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm Video")),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1 videos"),F.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-video fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},"Ch\u01B0a c\xF3 video trong folder n\xE0y")):React.createElement("div",{className:"row g-4"},F.map((u,g)=>React.createElement("div",{key:u.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>qe(g),disabled:g===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},g+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>Re(g),disabled:g===F.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"position-relative"},React.createElement("img",{src:u.thumb,className:"card-img-top",alt:u.title,style:{height:"120px",objectFit:"cover"}}),React.createElement("a",{href:`https://www.youtube.com/watch?v=${u.youtubeId}`,target:"_blank",className:"position-absolute top-50 start-50 translate-middle"},React.createElement("i",{className:"fas fa-play-circle fa-3x text-white",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"}}))),React.createElement("div",{className:"card-body py-2"},React.createElement("h6",{className:"card-title small mb-1 text-truncate",title:u.title},u.title),React.createElement("small",{className:"text-muted"},u.youtubeId)),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-primary",onClick:()=>Ke(u),title:"Copy link"},React.createElement("i",{className:"fas fa-link"})),React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>P(u),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-outline-danger",onClick:()=>fe(u),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))))),React.createElement(VideoModal,{show:he,video:me,onClose:()=>He(!1),onSave:B})):React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},we&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>K()},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-video me-2 text-warning"}),we?we.name:"Qu\u1EA3n l\xFD Video")),React.createElement("button",{className:"btn btn-warning",onClick:M},React.createElement("i",{className:"fas fa-folder-plus me-2"}),"T\u1EA1o Folder")),Ie.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:u=>{u.preventDefault(),K("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),Ie.map((u,g)=>React.createElement("li",{key:u.id,className:`breadcrumb-item ${g===Ie.length-1?"active":""}`},g===Ie.length-1?u.name:React.createElement("a",{href:"#",onClick:pe=>{pe.preventDefault(),K(u)},className:"text-warning"},u.name))))),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1. Click v\xE0o folder \u0111\u1EC3 v\xE0o b\xEAn trong."),_?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):O.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},we?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder video n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:M},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o folder",we?" con":" \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"row g-3"},O.map((u,g)=>{var pe,x,R,W;return React.createElement("div",{key:u.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-card"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Te=>{Te.stopPropagation(),Ae(g)},disabled:g===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},g+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Te=>{Te.stopPropagation(),tt(g)},disabled:g===O.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"card-body text-center py-3",onClick:()=>T(u),style:{cursor:"pointer"}},React.createElement("i",{className:`fas fa-folder fa-3x mb-3 ${u.slug==="shorts"?"text-danger":"text-warning"}`}),React.createElement("h5",{className:"card-title"},u.name),React.createElement("p",{className:"text-muted mb-0"},u.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),u.subfolderCount," folder"),u.subfolderCount>0&&(u.videoCount>0||((pe=u.videos)==null?void 0:pe.length)>0)&&" \u2022 ",(u.videoCount>0||((x=u.videos)==null?void 0:x.length)>0)&&React.createElement("span",null,React.createElement("i",{className:"fas fa-video me-1"}),u.videoCount||((R=u.videos)==null?void 0:R.length)||0," videos"),u.subfolderCount===0&&!u.videoCount&&!((W=u.videos)!=null&&W.length)&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:Te=>{Te.stopPropagation(),i(u)}},React.createElement("i",{className:"fas fa-edit"})," S\u1EEDa"),React.createElement("button",{className:"btn btn-outline-danger",onClick:Te=>{Te.stopPropagation(),v(u)}},React.createElement("i",{className:"fas fa-trash"})," X\xF3a")))))})),React.createElement(VideoFolderModal,{show:ue,folder:ce,onClose:()=>xe(!1),onSave:b}))}function VideoFolderModal({show:k,folder:w,onClose:O,onSave:G}){const[F,C]=useState({name:"",description:"",sortOrder:0,coverImage:""}),[_,re]=useState(!1),[de,z]=useState(!1);useEffect(()=>{C(w?{name:w.name||"",description:w.description||"",sortOrder:w.sortOrder||0,coverImage:w.coverImage||""}:{name:"",description:"",sortOrder:0,coverImage:""})},[w,k]);const ue=async ce=>{const se=ce.target.files[0];if(se){z(!0);try{const he=await window.KTM.cloudinary.uploadImage({file:se,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});he.secure_url&&C(He=>({...He,coverImage:he.secure_url})),window.KTM.cache.remove(CACHE_KEY),showToast("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),setShowQuickEdit(!1),setEditingItem(null),loadAllData()}catch(he){console.error("Cloudinary upload error:",he),alert("L\u1ED7i upload \u1EA3nh: "+(he.message||he))}finally{z(!1)}}},xe=async ce=>{ce.preventDefault(),re(!0);const se={...F,variants:normalizeVariants(F.variants,F.price),attributes:normalizeAttributes(F.attributes)};await G(se),re(!1)};return k?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},w?"S\u1EEDa Folder":"T\u1EA1o Folder m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:O})),React.createElement("form",{onSubmit:xe},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn folder *"),React.createElement("input",{type:"text",className:"form-control",value:F.name,onChange:ce=>C({...F,name:ce.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",value:F.description,onChange:ce=>C({...F,description:ce.target.value}),rows:"2"})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:F.sortOrder,onChange:ce=>C({...F,sortOrder:parseInt(ce.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex align-items-start gap-3"},F.coverImage?React.createElement("div",{className:"position-relative"},React.createElement("img",{src:F.coverImage,alt:"Cover",className:"rounded",style:{width:120,height:80,objectFit:"cover"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute top-0 end-0",onClick:()=>C({...F,coverImage:""}),style:{transform:"translate(30%, -30%)"}},React.createElement("i",{className:"fas fa-times"}))):React.createElement("div",{className:"bg-light rounded d-flex align-items-center justify-content-center text-muted",style:{width:120,height:80}},React.createElement("i",{className:"fas fa-image fa-2x"})),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{type:"file",className:"form-control form-control-sm",accept:"image/*,image/jpeg,image/png,image/gif,image/webp",onChange:ue,disabled:de}),de&&React.createElement("div",{className:"mt-1 text-muted small"},React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang upload..."),React.createElement("div",{className:"mt-1 text-muted small"},"Ho\u1EB7c d\xE1n URL:"),React.createElement("input",{type:"url",className:"form-control form-control-sm",placeholder:"https://...",value:F.coverImage,onChange:ce=>C({...F,coverImage:ce.target.value})}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:O},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:_},_?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function ProductManager({showToast:k,settings:w}){const[O,G]=useState([]),[F,C]=useState(!0),[_,re]=useState(!1),[de,z]=useState(null),[ue,xe]=useState(""),[ce,se]=useState(""),he=normalizeShipPercent(w==null?void 0:w.ship_percent),{parseMoney:He,formatVND:me}=window.KTM.money,ve=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"];useEffect(()=>{we()},[]);const we=async()=>{C(!0);try{const i=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");G(Array.isArray(i)?i:[])}catch(i){console.error(i),k("L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m","danger")}C(!1)},Le=()=>{z(null),re(!0)},Ie=i=>{z(i),re(!0)},_e=async i=>{if(!(!i||!i.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:i},"L\u1ED7i x\xF3a \u1EA3nh"),window.KTM.cache.remove(CACHE_KEY),k(`\u0110\xE3 x\xF3a ${typeName}`,"success"),loadAllData(),we()}catch(b){k("L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m","danger")}},ye=async i=>{try{const b=de?`${API_BASE}/api/products?id=${de.id}`:`${API_BASE}/api/products`;de?await window.KTM.api.putJSON(b,i,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(b,i,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),k(de?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),re(!1),we()}catch(b){k(b.message,"danger")}},De=async i=>{if(confirm(`B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n x\xF3a s\u1EA3n ph\u1EA9m "${i.name}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/products?id=${i.id}`,"L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m"),k("X\xF3a s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),we()}catch(b){k(b.message,"danger")}},Ae=O.filter(i=>{const b=!ue||i.name.toLowerCase().includes(ue.toLowerCase())||i.code&&i.code.toLowerCase().includes(ue.toLowerCase()),v=!ce||i.category===ce;return b&&v}),tt=i=>{var T;const b=(T=i==null?void 0:i.commission_percent)!=null?T:i==null?void 0:i.commissionPercent,v=b===""||b==null?NaN:Number(b);return Number.isFinite(v)?Math.max(0,Math.min(100,v)):5},Ce=i=>{const b=tt(i),v=Number.isInteger(b)?String(b):String(Math.round(b*100)/100),T=He(i==null?void 0:i.price);if(!Number.isFinite(T)||T<=0)return`${v}%`;const K=(Number(b)||0)/100,P=window.KTM.money.parseShipFeeFromNote(i==null?void 0:i.note)!=null?0:he>0?T*he/100:0,B=T*K-P*K,fe=Math.max(0,Math.round(B));return`${v}% - ${me(fe)}`},qe=i=>{if(i==null||i==="")return[];let b=i;if(typeof b=="string"){const v=b.trim();if(!v)return[];try{b=JSON.parse(v)}catch(T){return[]}}return Array.isArray(b)?b:[]},Re=i=>{if(i==null||i==="")return[];let b=i;if(typeof b=="string"){const v=b.trim();if(!v)return[];try{b=JSON.parse(v)}catch(T){return[]}}return b&&typeof b=="object"&&!Array.isArray(b)&&(b=Object.entries(b).map(([v,T])=>({key:v,value:T}))),Array.isArray(b)?b:[]},m=i=>{const b=Re(i).map(v=>{var T,K,Y,P,B;return{key:String((Y=(K=(T=v==null?void 0:v.key)!=null?T:v==null?void 0:v.name)!=null?K:v==null?void 0:v.label)!=null?Y:"").trim(),value:String((P=v==null?void 0:v.value)!=null?P:"").trim(),unit:String((B=v==null?void 0:v.unit)!=null?B:"").trim()}}).filter(v=>!!v.key);return b.length?React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},b.map((v,T)=>{const K=v.key,Y=`${v.value||""}${v.unit?(v.value?" ":"")+v.unit:""}`.trim();return React.createElement("div",{key:`${K}-${T}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},K),Y?React.createElement("span",{className:"ktm-chip ktm-chip-option"},Y):null)}))):null},M=(i,b={})=>{const v=qe(i).map(P=>{var B;return{name:String((B=P==null?void 0:P.name)!=null?B:"").trim(),options:Array.isArray(P==null?void 0:P.options)?P.options:[]}}).map(P=>({...P,options:P.options.map(B=>{var fe;return{label:String((fe=B==null?void 0:B.label)!=null?fe:"").trim(),price:Number(B==null?void 0:B.price)}}).filter(B=>!!B.label)})).filter(P=>P.options.length>0);if(!v.length)return null;const T=Number.isFinite(b.maxGroups)?Math.max(1,Math.trunc(b.maxGroups)):v.length,K=Number.isFinite(b.maxOptionsPerGroup)?Math.max(1,Math.trunc(b.maxOptionsPerGroup)):4,Y=v.slice(0,T);return React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},Y.map((P,B)=>{const fe=P.name||"Bi\u1EBFn th\u1EC3",Ke=P.options.slice(0,K),u=P.options.length-Ke.length;return React.createElement("div",{key:`${fe}-${B}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},fe),Ke.map((g,pe)=>{const x=g.price,R=Number.isFinite(x)&&x>=0?me(Math.trunc(x)):"",W=R?`${g.label} \xB7 ${R}`:g.label;return React.createElement("span",{key:`${fe}-${B}-${pe}`,className:"ktm-chip ktm-chip-option"},W)}),u>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",u))})))};return React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",null,React.createElement("i",{className:"fas fa-box me-2"}),"S\u1EA3n ph\u1EA9m"),React.createElement("button",{className:"btn-add-product",onClick:Le},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"d-flex gap-2 mb-2"},React.createElement("div",{className:"flex-grow-1 position-relative"},React.createElement("input",{type:"text",className:"form-control",placeholder:"\u{1F50D} T\xECm s\u1EA3n ph\u1EA9m...",value:ue,onChange:i=>xe(i.target.value)})),React.createElement("span",{className:"product-count"},Ae.length)),React.createElement("select",{className:"form-select",value:ce,onChange:i=>se(i.target.value)},React.createElement("option",{value:""},"\u{1F4C1} T\u1EA5t c\u1EA3 danh m\u1EE5c"),ve.map(i=>React.createElement("option",{key:i,value:i},i)))),F?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"2.5rem",height:"2.5rem"}}),React.createElement("p",{className:"text-muted mt-3 mb-0"},"\u0110ang t\u1EA3i...")):Ae.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-box-open"}),React.createElement("p",null,"Ch\u01B0a c\xF3 s\u1EA3n ph\u1EA9m n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:Le},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"product-list"},Ae.map(i=>React.createElement("div",{key:i.id,className:"product-item d-flex align-items-center gap-3"},i.image?React.createElement("img",{src:i.image,alt:"",className:"product-img"}):React.createElement("div",{className:"product-img-placeholder"},React.createElement("i",{className:"fas fa-image text-muted"})),React.createElement("div",{className:"flex-grow-1 min-width-0"},React.createElement("div",{className:"product-name"},i.name),React.createElement("div",{className:"d-flex flex-wrap gap-1 mb-1"},i.category&&React.createElement("span",{className:"product-badge bg-info bg-opacity-75"},i.category),i.code&&React.createElement("span",{className:"product-badge bg-secondary"},i.code),React.createElement("span",{className:"product-badge bg-warning text-dark",title:"Hoa h\u1ED3ng (%)"},React.createElement("i",{className:"fas fa-percent me-1"}),Ce(i))),React.createElement("div",{className:"product-price"},i.price?i.price.replace(/[đ\s]/g,"")+"\u0111":"Li\xEAn h\u1EC7"),i.note&&React.createElement("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"}},i.note),m(i.attributes)&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},m(i.attributes)),M(i.variants,{maxOptionsPerGroup:4})&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},M(i.variants,{maxOptionsPerGroup:4}))),React.createElement("div",{className:"product-actions"},React.createElement("button",{className:"btn btn-edit",onClick:()=>Ie(i),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"btn btn-delete",onClick:()=>De(i),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement(ProductModal,{show:_,product:de,categories:ve,onClose:()=>re(!1),onSave:ye}))}function ProductModal({show:k,product:w,categories:O,onClose:G,onSave:F}){const[C,_]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[re,de]=useState(!1),[z,ue]=useState(!1),xe=m=>{const M=window.KTM.money.getDigits(String(m!=null?m:"")),i=Number(M);return M&&Number.isFinite(i)?Math.trunc(i):0},ce=m=>{if(m==null||m==="")return[];let M=m;if(typeof M=="string"){const i=M.trim();if(!i)return[];try{M=JSON.parse(i)}catch(b){return[]}}return M&&typeof M=="object"&&!Array.isArray(M)&&(M=Object.entries(M).map(([i,b])=>({key:i,value:b}))),Array.isArray(M)?M.map(i=>{var K,Y,P,B,fe;if(!i||typeof i!="object")return null;const b=String((P=(Y=(K=i.key)!=null?K:i.name)!=null?Y:i.label)!=null?P:"").trim(),v=String((B=i.value)!=null?B:"").trim(),T=String((fe=i.unit)!=null?fe:"").trim();return b?{key:b,value:v,unit:T}:null}).filter(Boolean):[]},se=(m,M)=>{if(m==null||m==="")return[];let i=m;if(typeof i=="string"){const v=i.trim();if(!v)return[];try{i=JSON.parse(v)}catch(T){return[]}}if(!Array.isArray(i))return[];const b=xe(M);return i.map(v=>{var Y;if(!v||typeof v!="object")return null;const T=String((Y=v.name)!=null?Y:"").trim(),K=(Array.isArray(v.options)?v.options:[]).map(P=>{var pe,x,R,W,Te,je,X;if(!P||typeof P!="object")return null;const B=String((pe=P.label)!=null?pe:"").trim();if(!B)return null;const fe=(Te=(W=(R=(x=P.price)!=null?x:P.priceValue)!=null?R:P.unit_price)!=null?W:P.unitPrice)!=null?Te:null,Ke=Number(fe);let u=Number.isFinite(Ke)?Math.trunc(Ke):null;if(u==null){const Ee=(X=(je=P.price_delta)!=null?je:P.priceDelta)!=null?X:null,Ye=Number(Ee);Number.isFinite(Ye)&&(u=b+Math.trunc(Ye))}u==null&&(u=b);const g=String(Math.max(0,Math.trunc(Number(u)||0)));return{label:B,price:Math.max(0,Math.trunc(Number(u)||0)),priceDigits:g}}).filter(Boolean);return{name:T||"Bi\u1EBFn th\u1EC3",options:K}}).filter(Boolean)};useEffect(()=>{var m,M;_(w?{name:w.name||"",code:w.code||"",price:w.price||"",image:w.image||"",category:w.category||"",note:w.note||"",sort_order:w.sort_order||0,commission_percent:(M=(m=w.commission_percent)!=null?m:w.commissionPercent)!=null?M:5,variants:se(w.variants,w.price),attributes:ce(w.attributes)}:{name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]})},[w,k]);const he=m=>{_(M=>{var K;const i=xe(M.price),b=String(i),v=Array.isArray(M.variants)?[...M.variants]:[],T={...v[m]||{},options:Array.isArray((K=v[m])==null?void 0:K.options)?[...v[m].options]:[]};return T.options=T.options.map(Y=>({label:String((Y==null?void 0:Y.label)||""),price:i,priceDigits:b})),v[m]=T,{...M,variants:v}})},He=()=>{_(m=>{const M=xe(m.price),i=String(M),v=(Array.isArray(m.variants)?[...m.variants]:[]).map(T=>{const K=(Array.isArray(T==null?void 0:T.options)?T.options:[]).map(Y=>({label:String((Y==null?void 0:Y.label)||""),price:M,priceDigits:i}));return{name:String((T==null?void 0:T.name)||"Bi\u1EBFn th\u1EC3"),options:K}});return{...m,variants:v}})},[me,ve]=React.useState(""),we=m=>window.KTM.money.formatVNDInputDigits(m),[Le,Ie]=React.useState(""),_e=m=>{const M=window.KTM.money.nextPriceInputState(m.target.value,Le);Ie(M.digits),_({...C,price:M.price})},[ye,De]=React.useState("");React.useEffect(()=>{w!=null&&w.image&&De(w.image)},[w]);const Ae=async m=>{if(!(!m||!m.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:m},"L\u1ED7i x\xF3a \u1EA3nh")}catch(M){console.error("Delete cloudinary image error:",M)}},tt=async(m,M=2,i)=>{const b=M*1024*1024,v=m.type==="image/heic"||m.type==="image/heif"||/\.heic$/i.test(m.name);if(m.size<=b&&!v)return m;i==null||i("\u0110ang x\u1EED l\xFD \u1EA3nh...");try{const T=await createImageBitmap(m);i==null||i("\u0110ang n\xE9n \u1EA3nh...");const K=document.createElement("canvas");let Y=T.width,P=T.height;const B=1200;return(Y>B||P>B)&&(Y>P?(P=Math.round(P/Y*B),Y=B):(Y=Math.round(Y/P*B),P=B)),K.width=Y,K.height=P,K.getContext("2d").drawImage(T,0,0,Y,P),T.close(),new Promise((Ke,u)=>{K.toBlob(g=>{g?(i==null||i("Ho\xE0n t\u1EA5t!"),Ke(new File([g],m.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"}))):u(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(T){throw console.error("createImageBitmap error:",T),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},Ce=async m=>{var b,v;const M=(b=m.target.files)==null?void 0:b[0];if(!M)return;if(!(M.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(M.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}ue(!0),ve("\u0110ang chu\u1EA9n b\u1ECB...");try{const T=(M.size/1024/1024).toFixed(1);ve(`File ${T}MB - \u0110ang n\xE9n...`);const K=await tt(M,2,B=>{ve(B)}),Y=(K.size/1024/1024).toFixed(1);ve(`\u0110\xE3 n\xE9n: ${Y}MB - \u0110ang upload...`);const P=await window.KTM.cloudinary.uploadImage({file:K,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});P.secure_url?(C.image&&C.image!==ye&&Ae(C.image),_(B=>({...B,image:P.secure_url})),ve("")):(console.error("Cloudinary error:",P),alert("Upload th\u1EA5t b\u1EA1i: "+(((v=P.error)==null?void 0:v.message)||"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh")),ve(""))}catch(T){console.error("Upload error:",T),alert("L\u1ED7i: "+T.message),ve("")}ue(!1),m.target.value=""},qe=()=>{C.image&&(C.image!==ye&&Ae(C.image),_(m=>({...m,image:""})))},Re=async m=>{m.preventDefault(),de(!0),ye&&C.image&&ye!==C.image&&await Ae(ye),ye&&!C.image&&await Ae(ye),await F(C),de(!1)};return k?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down"},React.createElement("div",{className:"modal-content",style:{borderRadius:"16px",overflow:"hidden"}},React.createElement("div",{className:"modal-header border-0 py-3",style:{background:"linear-gradient(135deg, #ffc107 0%, #ffca2c 100%)"}},React.createElement("h6",{className:"modal-title fw-bold",style:{color:"#1a1a2e"}},React.createElement("i",{className:`fas ${w?"fa-edit":"fa-plus-circle"} me-2`}),w?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:G})),React.createElement("form",{onSubmit:Re},React.createElement("div",{className:"modal-body py-4",style:{maxHeight:"65vh",overflowY:"auto",background:"#f8f9fa"}},React.createElement("div",{className:"text-center mb-4"},React.createElement("div",{className:"position-relative d-inline-block"},C.image?React.createElement(React.Fragment,null,React.createElement("img",{src:C.image,alt:"",style:{width:110,height:110,objectFit:"cover",borderRadius:"12px",boxShadow:"0 4px 15px rgba(0,0,0,0.15)"}}),React.createElement("button",{type:"button",className:"btn btn-danger position-absolute",onClick:qe,style:{top:-10,right:-10,width:28,height:28,padding:0,borderRadius:"50%",boxShadow:"0 2px 8px rgba(220,53,69,0.4)"}},React.createElement("i",{className:"fas fa-times",style:{fontSize:"0.75rem"}}))):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:110,height:110,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd"}},React.createElement("i",{className:"fas fa-image fa-2x text-muted"}))),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"btn btn-warning btn-sm px-3",style:{borderRadius:"20px"}},React.createElement("i",{className:`fas ${z?"fa-spinner fa-spin":"fa-camera"} me-1`}),z?me||"\u0110ang x\u1EED l\xFD...":"Ch\u1ECDn \u1EA3nh",React.createElement("input",{type:"file",accept:"image/*",onChange:Ce,disabled:z,style:{position:"absolute",left:"-9999px",opacity:0,width:1,height:1}})),z&&me&&React.createElement("div",{className:"text-center mt-1",style:{fontSize:11,color:"#6c757d"}},me))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-tag me-1 text-warning"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:C.name,onChange:m=>_({...C,name:m.target.value}),required:!0,placeholder:"VD: Combo Van 3 tay + 2 xylanh",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-barcode me-1 text-info"}),"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:C.code,onChange:m=>_({...C,code:m.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1 text-success"}),"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:C.price,onChange:_e,placeholder:"1.950.000\u0111",inputMode:"numeric",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-percent me-1 text-secondary"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:C.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:m=>_({...C,commission_percent:m.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-folder me-1 text-primary"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:C.category,onChange:m=>_({...C,category:m.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),O.map(m=>React.createElement("option",{key:m,value:m},m)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1 text-secondary"}),"Ghi ch\xFA"),React.createElement("input",{type:"text",className:"form-control",value:C.note,onChange:m=>_({...C,note:m.target.value}),placeholder:"VD: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1 text-secondary"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(C.attributes)?C.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(C.attributes)?C.attributes:[]).map((m,M)=>React.createElement("div",{key:M,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(m==null?void 0:m.key)||"",onChange:i=>{const b=i.target.value;_(v=>{const T=Array.isArray(v.attributes)?[...v.attributes]:[];return T[M]={...T[M]||{},key:b},{...v,attributes:T}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(m==null?void 0:m.value)||"",onChange:i=>{const b=i.target.value;_(v=>{const T=Array.isArray(v.attributes)?[...v.attributes]:[];return T[M]={...T[M]||{},value:b},{...v,attributes:T}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(m==null?void 0:m.unit)||"",onChange:i=>{const b=i.target.value;_(v=>{const T=Array.isArray(v.attributes)?[...v.attributes]:[];return T[M]={...T[M]||{},unit:b},{...v,attributes:T}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{_(i=>{const b=Array.isArray(i.attributes)?[...i.attributes]:[];return b.splice(M,1),{...i,attributes:b}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{_(m=>{const M=Array.isArray(m.attributes)?[...m.attributes]:[];return M.push({key:"",value:"",unit:""}),{...m,attributes:M}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1 text-secondary"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(C.variants)?C.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3."):null,(Array.isArray(C.variants)?C.variants:[]).map((m,M)=>React.createElement("div",{key:M,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(m==null?void 0:m.name)||"",onChange:i=>{const b=i.target.value;_(v=>{var K;const T=Array.isArray(v.variants)?[...v.variants]:[];return T[M]={...T[M]||{},name:b,options:Array.isArray((K=T[M])==null?void 0:K.options)?T[M].options:[]},{...v,variants:T}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>he(M),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(m==null?void 0:m.options)||m.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{_(i=>{const b=Array.isArray(i.variants)?[...i.variants]:[];return b.splice(M,1),{...i,variants:b}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(m==null?void 0:m.options)?m.options:[]).map((i,b)=>{var v,T;return React.createElement("div",{key:b,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(i==null?void 0:i.label)||"",onChange:K=>{const Y=K.target.value;_(P=>{var g,pe,x,R,W;const B=Array.isArray(P.variants)?[...P.variants]:[],fe={...B[M]||{},options:Array.isArray((g=B[M])==null?void 0:g.options)?[...B[M].options]:[]},Ke=Number((x=(pe=fe.options[b])==null?void 0:pe.price)!=null?x:0)||0,u=String((W=(R=fe.options[b])==null?void 0:R.priceDigits)!=null?W:Math.max(0,Math.trunc(Ke)));return fe.options[b]={...fe.options[b]||{},label:Y,price:Math.max(0,Math.trunc(Ke)),priceDigits:u},B[M]=fe,{...P,variants:B}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:we(String((T=i==null?void 0:i.priceDigits)!=null?T:window.KTM.money.getDigits(String((v=i==null?void 0:i.price)!=null?v:"")))),onChange:K=>{_(Y=>{var x,R,W,Te,je;const P=String((R=i==null?void 0:i.priceDigits)!=null?R:window.KTM.money.getDigits(String((x=i==null?void 0:i.price)!=null?x:""))),B=window.KTM.money.nextPriceInputState(K.target.value,P),fe=String((W=B.digits)!=null?W:""),Ke=Number(fe),u=Number.isFinite(Ke)?Math.max(0,Math.trunc(Ke)):0,g=Array.isArray(Y.variants)?[...Y.variants]:[],pe={...g[M]||{},options:Array.isArray((Te=g[M])==null?void 0:Te.options)?[...g[M].options]:[]};return pe.options[b]={...pe.options[b]||{},label:String(((je=pe.options[b])==null?void 0:je.label)||""),price:u,priceDigits:fe},g[M]=pe,{...Y,variants:g}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{_(K=>{var B;const Y=Array.isArray(K.variants)?[...K.variants]:[],P={...Y[M]||{},options:Array.isArray((B=Y[M])==null?void 0:B.options)?[...Y[M].options]:[]};return P.options.splice(b,1),Y[M]=P,{...K,variants:Y}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{_(i=>{var K;const b=Array.isArray(i.variants)?[...i.variants]:[],v={...b[M]||{},options:Array.isArray((K=b[M])==null?void 0:K.options)?[...b[M].options]:[]},T=xe(i.price);return v.options.push({label:"",price:T,priceDigits:String(T)}),b[M]=v,{...i,variants:b}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{_(m=>{const M=xe(m.price),i=Array.isArray(m.variants)?[...m.variants]:[],b=String(M);return i.push({name:"Size",options:[{label:"S",price:M,priceDigits:b},{label:"M",price:M,priceDigits:b},{label:"L",price:M,priceDigits:b}]}),{...m,variants:i}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:He,disabled:!Array.isArray(C.variants)||C.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111."))),React.createElement("div",{className:"mb-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"URL \u1EA3nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",placeholder:"https://...",value:C.image,onChange:m=>_({...C,image:m.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"10px",fontSize:"0.9rem"}}))),React.createElement("div",{className:"modal-footer border-0 py-3",style:{background:"#fff"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:G,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:re,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},re?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}function VideoModal({show:k,video:w,onClose:O,onSave:G}){const[F,C]=useState({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),[_,re]=useState(!1),[de,z]=useState("");useEffect(()=>{w?(C({title:w.title||"",youtube_url:`https://www.youtube.com/watch?v=${w.youtubeId}`,thumbnail_url:w.thumb||"",sort_order:w.sortOrder||0}),z(w.thumb)):(C({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),z(""))},[w,k]);const ue=se=>{const he=se.match(/(?:youtube\.com\/(?:embed\/|watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return he?he[1]:null},xe=se=>{C({...F,youtube_url:se});const he=ue(se);he&&z(`https://img.youtube.com/vi/${he}/hqdefault.jpg`)},ce=async se=>{se.preventDefault(),re(!0),await G(F),re(!1)};return k?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},w?"S\u1EEDa Video":"Th\xEAm Video m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:O})),React.createElement("form",{onSubmit:ce},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Link YouTube *"),React.createElement("input",{type:"url",className:"form-control",value:F.youtube_url,onChange:se=>xe(se.target.value),placeholder:"https://www.youtube.com/watch?v=... ho\u1EB7c shorts/...",required:!0}),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3: youtube.com/watch, youtu.be, youtube.com/shorts")),de&&React.createElement("div",{className:"mb-3 text-center"},React.createElement("img",{src:de,alt:"Preview",className:"img-fluid rounded",style:{maxHeight:"150px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ti\xEAu \u0111\u1EC1 *"),React.createElement("input",{type:"text",className:"form-control",value:F.title,onChange:se=>C({...F,title:se.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:F.sort_order,onChange:se=>C({...F,sort_order:parseInt(se.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Thumbnail t\xF9y ch\u1EC9nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",value:F.thumbnail_url,onChange:se=>C({...F,thumbnail_url:se.target.value}),placeholder:"\u0110\u1EC3 tr\u1ED1ng s\u1EBD d\xF9ng thumbnail m\u1EB7c \u0111\u1ECBnh c\u1EE7a YouTube"}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:O},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:_},_?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function AdminApp(){const[k,w]=useState(!1),[O,G]=useState(""),[F,C]=useState(null),[_,re]=useState("search"),[de,z]=useState(null),[ue,xe]=useState(""),[ce,se]=useState([]),[he,He]=useState(null),[me,ve]=useState(!1),[we,Le]=useState(null),[Ie,_e]=useState(!0),[ye,De]=useState([]),[Ae,tt]=useState(()=>loadAdminSettings()),[Ce,qe]=useState(null),[Re,m]=useState([]);useEffect(()=>{const x=localStorage.getItem("ktm_admin_session");if(x)try{const R=JSON.parse(x);R.expiry>Date.now()?(w(!0),C(R.user)):localStorage.removeItem("ktm_admin_session")}catch(R){localStorage.removeItem("ktm_admin_session")}},[]),useEffect(()=>{k&&T()},[k]),useEffect(()=>{if(!k)return;let x=!1;return(async()=>{try{const R=await fetchAdminSettingsFromServer();if(x)return;tt(R),saveAdminSettings(R)}catch(R){}})(),()=>{x=!0}},[k]);const M=async(x,R)=>{G("");try{const W=await window.KTM.api.postJSON(`${API_BASE}/api/auth/login`,{username:x,password:R},"\u0110\u0103ng nh\u1EADp th\u1EA5t b\u1EA1i"),Te={user:W.user,token:W.token,expiry:Date.now()+100*365*24*60*60*1e3};localStorage.setItem("ktm_admin_session",JSON.stringify(Te)),C(W.user),w(!0)}catch(W){G(W.message)}},i=()=>{localStorage.removeItem("ktm_admin_session"),w(!1),C(null),se([]),He(null)},b=(x,R="success")=>{const W=Date.now();De(Te=>[...Te,{id:W,message:x,type:R}])},v=x=>{De(R=>R.filter(W=>W.id!==x))},T=async(x=null)=>{_e(!0);try{const R=x?`${API_BASE}/api/albums?parent_id=${x}`:`${API_BASE}/api/albums?parent_id=root`,W=await window.KTM.api.getJSON(R,"L\u1ED7i t\u1EA3i danh s\xE1ch album");se(Array.isArray(W)?W:[])}catch(R){console.error(R),b("L\u1ED7i t\u1EA3i danh s\xE1ch album","danger")}_e(!1)},K=()=>{Le(null),ve(!0)},Y=x=>{Le(x),ve(!0)},P=async x=>{try{const R=we&&we.uuid;!R&&Ce&&(x.parent_id=Ce.uuid);const W=R?`${API_BASE}/api/albums/${we.uuid||we.id}`:`${API_BASE}/api/albums`;R?await window.KTM.api.putJSON(W,x,"L\u1ED7i c\u1EADp nh\u1EADt"):await window.KTM.api.postJSON(W,x,"L\u1ED7i t\u1EA1o"),b(R?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"T\u1EA1o th\xE0nh c\xF4ng!","success"),ve(!1),T(Ce==null?void 0:Ce.uuid)}catch(R){b(R.message,"danger")}},B=x=>{He(x)},fe=x=>{if(x==="root")m([]),qe(null),T(null);else if(x){const R=Re.findIndex(W=>W.uuid===x.uuid);R>=0&&(m(Re.slice(0,R+1)),qe(x),T(x.uuid))}else{const R=[...Re];R.pop();const W=R[R.length-1]||null;m(R),qe(W),T(W==null?void 0:W.uuid)}},Ke=async x=>{const R=`X\xF3a folder "${x.title}"? T\u1EA5t c\u1EA3 folder con v\xE0 \u1EA3nh b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`;if(confirm(R))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${x.uuid||x.id}`,"L\u1ED7i x\xF3a album"),b("\u0110\xE3 x\xF3a","success"),T(Ce==null?void 0:Ce.uuid)}catch(W){b("L\u1ED7i x\xF3a album","danger")}};if(!k)return React.createElement(LoginPage,{onLogin:M,error:O});const u=()=>{const x=new Date,R=x.getFullYear(),W=String(x.getMonth()+1).padStart(2,"0");return`${R}-${W}`};function g(){const[x,R]=useState(()=>{var X;return String((X=Ae==null?void 0:Ae.ship_percent)!=null?X:DEFAULT_SHIP_PERCENT)}),[W,Te]=useState(!1);return useEffect(()=>{var X;R(String((X=Ae==null?void 0:Ae.ship_percent)!=null?X:DEFAULT_SHIP_PERCENT))},[Ae==null?void 0:Ae.ship_percent]),React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-cog me-2 text-warning"}),"C\xE0i \u0111\u1EB7t")),React.createElement("div",{className:"card p-3"},React.createElement("form",{onSubmit:async X=>{X.preventDefault(),Te(!0);const Ee=saveAdminSettings({ship_percent:x});try{const Ye=await saveAdminSettingsToServer(Ee);tt(Ye),saveAdminSettings(Ye),b("\u0110\xE3 l\u01B0u c\xE0i \u0111\u1EB7t v\xE0o DB","success")}catch(Ye){tt(Ee),b("Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c DB, \u0111\xE3 l\u01B0u t\u1EA1m tr\xEAn m\xE1y","warning")}finally{Te(!1)}}},React.createElement("div",{className:"mb-2 text-muted small"},"\xC1p d\u1EE5ng cho th\u1ED1ng k\xEA hoa h\u1ED3ng khi \u0111\u01A1n h\xE0ng kh\xF4ng ghi ph\xED ship trong ghi ch\xFA s\u1EA3n ph\u1EA9m."),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ph\xED ship (%) khi kh\xF4ng c\xF3 ship"),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",value:x,min:"0",max:"100",step:"0.01",onChange:X=>R(X.target.value)}),React.createElement("span",{className:"input-group-text"},"%")),React.createElement("div",{className:"form-text"},"M\u1EB7c \u0111\u1ECBnh: ",DEFAULT_SHIP_PERCENT,"%")),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:W},W?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u c\xE0i \u0111\u1EB7t"))))}function pe(){const[x,R]=useState(u()),[W,Te]=useState(!0),je=()=>({statusCounts:{draft:0,pending:0,processing:0,done:0,paid:0,canceled:0,other:0},activeOrders:0,totalQty:0,totalRevenue:0,doneRevenue:0,tempCommission:0,tempCommissionAll:0,products:[],customers:[],days:[],uniqueCustomers:0,avgOrderValue:0,avgQtyPerOrder:0}),[X,Ee]=useState(je),Ye=useRef(new Map),pt=normalizeShipPercent(Ae==null?void 0:Ae.ship_percent),{formatNumber:ge,formatVND:Je}=window.KTM.money,A=async(ae,lt=!1)=>{var et,Ge;const ct=String(ae||"").trim();if(!ct)return je();const Ze=`${ct}|${pt}`,ft=(et=Ye.current)==null?void 0:et.get(Ze);if(!lt&&ft)return ft;const h=`${API_BASE}/api/orders?resource=stats&month=${encodeURIComponent(ct)}&ship_percent=${encodeURIComponent(pt)}`,U=await window.KTM.api.getJSON(h,"L\u1ED7i t\u1EA3i th\u1ED1ng k\xEA"),ie=U!=null&&U.stats&&(U!=null&&U.meta)?U.stats:U,Ue=ie&&typeof ie=="object"?ie:je();return(Ge=Ye.current)==null||Ge.set(Ze,Ue),Ue},ze=async(ae=!1)=>{Te(!0);try{const lt=await A(x,ae);Ee(lt)}catch(lt){console.error("Load stats error:",lt),Ee(je())}finally{Te(!1)}};return useEffect(()=>{ze()},[x,pt]),React.createElement("div",{className:"product-manager pb-5 mb-4 stats-manager"},React.createElement(Loading,{show:W}),React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-chart-column me-2 text-warning"}),"Th\u1ED1ng k\xEA"),React.createElement("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>ze(!0),disabled:W},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"Ch\u1ECDn th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:x,onChange:ae=>R(ae.target.value),"aria-label":"Ch\u1ECDn th\xE1ng"}))),React.createElement("div",{className:"col-12 col-md-7 d-flex gap-2 justify-content-md-end"},React.createElement("div",{className:"d-flex flex-wrap gap-2 align-self-center"},React.createElement("span",{className:"badge rounded-pill bg-secondary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-truck me-1"}),"Ship \u01B0\u1EDBc t\xEDnh: ",pt,"%"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-receipt me-1"}),ge(X.activeOrders)," \u0111\u01A1n"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-user me-1"}),ge(X.uniqueCustomers)," kh\xE1ch"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-boxes-stacked me-1"}),ge(X.totalQty)," SL"),React.createElement("span",{className:"badge rounded-pill bg-primary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-hand-holding-dollar me-1"}),"\u0110\xE3 nh\u1EADn ti\u1EC1n: ",ge(X.statusCounts.paid),"/",ge(X.statusCounts.done)))))),React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng \u0111\u01A1n (kh\xF4ng t\xEDnh h\u1EE7y/nh\xE1p)"),React.createElement("i",{className:"fas fa-receipt text-dark"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},ge(X.activeOrders)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (t\u1EA1m t\xEDnh)"),React.createElement("i",{className:"fas fa-sack-dollar text-warning"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Je(X.totalRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (Ho\xE0n th\xE0nh)"),React.createElement("i",{className:"fas fa-circle-check text-success"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Je(X.doneRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-info bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng s\u1EBD nh\u1EADn (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-chart-line text-info"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Je(X.tempCommission)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng t\u1ED5ng (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-coins text-primary"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Je(X.tempCommissionAll))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-layer-group me-2 text-warning"}),"T\u1ED5ng quan tr\u1EA1ng th\xE1i"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},"SL TB/\u0111\u01A1n: ",X.avgQtyPerOrder?X.avgQtyPerOrder.toFixed(2):"0.00")),React.createElement("div",{className:"d-md-none mt-2"},React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-light bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Nh\xE1p"),React.createElement("div",{className:"fw-semibold"},ge(X.statusCounts.draft)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-secondary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("div",{className:"fw-semibold"},ge(X.statusCounts.pending)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("div",{className:"fw-semibold"},ge(X.statusCounts.processing)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-danger bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"H\u1EE7y \u0111\u01A1n"),React.createElement("div",{className:"fw-semibold"},ge(X.statusCounts.canceled)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh"),React.createElement("div",{className:"fw-semibold"},ge(X.statusCounts.done)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("div",{className:"fw-semibold"},ge(X.statusCounts.paid)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng SL"),React.createElement("div",{className:"fw-semibold"},ge(X.totalQty)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Nh\xE1p"),React.createElement("th",null,"Ch\u1EDD x\u1EED l\xFD"),React.createElement("th",null,"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("th",null,"H\u1EE7y \u0111\u01A1n"),React.createElement("th",null,"Ho\xE0n th\xE0nh"),React.createElement("th",null,"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("th",null,"Kh\xE1c"),React.createElement("th",null,"T\u1ED5ng SL"))),React.createElement("tbody",null,React.createElement("tr",null,React.createElement("td",null,ge(X.statusCounts.draft)),React.createElement("td",null,ge(X.statusCounts.pending)),React.createElement("td",null,ge(X.statusCounts.processing)),React.createElement("td",null,ge(X.statusCounts.canceled)),React.createElement("td",null,ge(X.statusCounts.done)),React.createElement("td",null,ge(X.statusCounts.paid)),React.createElement("td",null,ge(X.statusCounts.other)),React.createElement("td",null,ge(X.totalQty))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-box me-2 text-info"}),"Top s\u1EA3n ph\u1EA9m"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},X.products.slice(0,10).map(ae=>React.createElement("div",{key:ae.product_id,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-info"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},ae.product_name),React.createElement("div",{className:"text-muted small text-truncate"},ae.product_code?`#${ae.product_code} \u2022 `:"",ge(ae.orders)," \u0111\u01A1n \u2022 ",ge(ae.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},Je(ae.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"M\xE3"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,X.products.slice(0,10).map(ae=>React.createElement("tr",{key:ae.product_id},React.createElement("td",null,ae.product_name),React.createElement("td",null,ae.product_code||"\u2014"),React.createElement("td",null,ge(ae.orders)),React.createElement("td",null,ge(ae.quantity)),React.createElement("td",{className:"fw-semibold"},Je(ae.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-user-group me-2 text-warning"}),"Top kh\xE1ch h\xE0ng"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},X.customers.slice(0,10).map(ae=>React.createElement("div",{key:ae.key,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-warning"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},ae.customer_name||"\u2014"),React.createElement("div",{className:"text-muted small text-truncate"},ae.phone||"\u2014"," \u2022 ",ge(ae.orders)," \u0111\u01A1n \u2022 ",ge(ae.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},Je(ae.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,X.customers.slice(0,10).map(ae=>React.createElement("tr",{key:ae.key},React.createElement("td",null,ae.customer_name||"\u2014"),React.createElement("td",null,ae.phone||"\u2014"),React.createElement("td",null,ge(ae.orders)),React.createElement("td",null,ge(ae.quantity)),React.createElement("td",{className:"fw-semibold"},Je(ae.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3 mb-4"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-calendar-day me-2 text-success"}),"Theo ng\xE0y"),React.createElement("span",{className:"badge rounded-pill bg-success bg-opacity-10 text-dark"},"DT (t\u1EA1m t\xEDnh) & ho\xE0n th\xE0nh")),React.createElement("div",{className:"d-md-none mt-2"},X.days.map(ae=>React.createElement("div",{key:ae.day,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-success"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"fw-semibold"},ae.day),React.createElement("div",{className:"text-muted small"},ge(ae.orders)," \u0111\u01A1n \u2022 ",ge(ae.quantity)," SL"),React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh: ",ge(ae.doneOrders)," \u2022 ",Je(ae.doneRevenue))),React.createElement("div",{className:"fw-semibold text-nowrap"},Je(ae.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Ng\xE0y"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"DT (t\u1EA1m t\xEDnh)"),React.createElement("th",null,"\u0110\u01A1n ho\xE0n th\xE0nh"),React.createElement("th",null,"DT ho\xE0n th\xE0nh"))),React.createElement("tbody",null,X.days.map(ae=>React.createElement("tr",{key:ae.day},React.createElement("td",null,ae.day),React.createElement("td",null,ge(ae.orders)),React.createElement("td",null,ge(ae.quantity)),React.createElement("td",{className:"fw-semibold"},Je(ae.revenue)),React.createElement("td",null,ge(ae.doneOrders)),React.createElement("td",{className:"fw-semibold"},Je(ae.doneRevenue)))))))))}return React.createElement("div",null,React.createElement(Sidebar,{activeMenu:_,onMenuChange:x=>{re(x),x==="albums"&&(qe(null),m([]),T(null))},onLogout:i,currentUser:F}),React.createElement("div",{className:"main-content"},React.createElement("header",{className:"admin-topbar",role:"banner"},(()=>{const R={search:{title:"Tra c\u1EE9u",icon:"fa-search",sub:"T\xECm nhanh s\u1EA3n ph\u1EA9m/kh\xE1ch/\u0111\u01A1n"},albums:{title:"Album",icon:"fa-images",sub:"Qu\u1EA3n l\xFD \u1EA3nh & folder"},videos:{title:"Video",icon:"fa-video",sub:"Qu\u1EA3n l\xFD video & folder"},products:{title:"S\u1EA3n ph\u1EA9m",icon:"fa-box",sub:"Danh s\xE1ch, gi\xE1, m\xF4 t\u1EA3"},orders:{title:"\u0110\u01A1n h\xE0ng",icon:"fa-receipt",sub:"T\u1EA1o & theo d\xF5i tr\u1EA1ng th\xE1i"},stats:{title:"Th\u1ED1ng k\xEA",icon:"fa-chart-column",sub:"Doanh thu & hoa h\u1ED3ng"},settings:{title:"C\xE0i \u0111\u1EB7t",icon:"fa-cog",sub:"Tu\u1EF3 ch\u1EC9nh h\u1EC7 th\u1ED1ng"}}[_]||{title:"KTM Admin",icon:"fa-tractor",sub:""},W=(F==null?void 0:F.username)||(F==null?void 0:F.name)||(F==null?void 0:F.email)||"Admin",Te=(()=>{if(_!=="albums")return"";const je=[];return je.push("Root"),Array.isArray(Re)&&Re.length>0&&je.push(...Re.map(X=>X==null?void 0:X.title).filter(Boolean)),he!=null&&he.title&&je.push(he.title),je.length>0?je.join(" / "):""})();return React.createElement("div",{className:"admin-topbar-inner"},React.createElement("div",{className:"admin-topbar-left"},React.createElement("div",{className:"admin-page-icon","aria-hidden":"true"},React.createElement("i",{className:`fas ${R.icon}`})),React.createElement("div",{className:"admin-page-title"},React.createElement("div",{className:"admin-page-heading"},R.title),React.createElement("div",{className:"admin-page-subtitle"},Te||R.sub))),React.createElement("div",{className:"admin-topbar-right"},_==="albums"&&React.createElement("button",{className:"btn btn-warning btn-sm admin-topbar-action",onClick:K,title:"T\u1EA1o folder"},React.createElement("i",{className:"fas fa-plus me-2"}),React.createElement("span",{className:"d-none d-sm-inline"},"Folder")),React.createElement("a",{href:"/",className:"btn btn-outline-secondary btn-sm d-none d-md-inline-flex",title:"V\u1EC1 trang ch\u1EE7"},React.createElement("i",{className:"fas fa-home me-2"}),"Trang ch\u1EE7"),React.createElement("div",{className:"admin-user-chip",title:W},React.createElement("i",{className:"fas fa-user-circle"}),React.createElement("span",{className:"admin-user-chip-name"},W)),React.createElement("button",{className:"btn btn-outline-danger btn-sm d-md-none",onClick:i,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"}))))})()),React.createElement("div",{className:"admin-page-body"},_==="albums"&&!he&&React.createElement(AlbumList,{albums:ce,loading:Ie,currentFolder:Ce,breadcrumb:Re,onSelect:B,onCreate:K,onEdit:Y,onDelete:Ke,onBack:fe}),_==="search"&&React.createElement(SearchCenter,{showToast:b,onNavigate:(x,R,W)=>{re(x),x==="orders"&&R==="create"&&(z(Date.now()),xe((W==null?void 0:W.productId)||""))}}),_==="albums"&&he&&React.createElement(AlbumDetail,{album:he,parentAlbum:Re.length>0?Re[Re.length-1]:null,onBack:()=>{if(he.parentId){const x=Re.findIndex(R=>R.uuid===he.parentId);x>=0?He(Re[x]):He(null)}else He(null)},onRefresh:()=>T(Ce==null?void 0:Ce.uuid),showToast:b,onNavigateToFolder:x=>{m(R=>[...R,he]),He(x)},onEditSubfolder:x=>{Le(x),ve(!0)}}),_==="videos"&&React.createElement(VideoList,{showToast:b}),_==="products"&&React.createElement(ProductManager,{showToast:b,settings:Ae}),_==="orders"&&React.createElement(OrderManager,{autoOpenCreateToken:de,autoOpenCreateProductId:ue,showToast:b}),_==="stats"&&React.createElement(pe,null),_==="settings"&&React.createElement(g,null))),React.createElement("nav",{className:"mobile-bottom-nav"},React.createElement("div",{className:"nav-items"},React.createElement("a",{href:"#",className:`nav-item ${_==="search"?"active":""}`,onClick:x=>{x.preventDefault(),re("search")}},React.createElement("i",{className:"fas fa-search"}),React.createElement("span",null,"Tra c\u1EE9u")),React.createElement("a",{href:"#",className:`nav-item ${_==="albums"?"active":""}`,onClick:x=>{x.preventDefault(),re("albums"),He(null)}},React.createElement("i",{className:"fas fa-images"}),React.createElement("span",null,"Album")),React.createElement("a",{href:"#",className:`nav-item ${_==="videos"?"active":""}`,onClick:x=>{x.preventDefault(),re("videos")}},React.createElement("i",{className:"fas fa-video"}),React.createElement("span",null,"Video")),React.createElement("a",{href:"#",className:`nav-item ${_==="products"?"active":""}`,onClick:x=>{x.preventDefault(),re("products")}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",null,"S\u1EA3n ph\u1EA9m")),React.createElement("a",{href:"#",className:`nav-item ${_==="orders"?"active":""}`,onClick:x=>{x.preventDefault(),re("orders")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",null,"\u0110\u01A1n h\xE0ng")),React.createElement("a",{href:"#",className:`nav-item ${_==="stats"?"active":""}`,onClick:x=>{x.preventDefault(),re("stats")}},React.createElement("i",{className:"fas fa-chart-column"}),React.createElement("span",null,"Th\u1ED1ng k\xEA")))),React.createElement(AlbumModal,{show:me,album:we,parentId:Ce==null?void 0:Ce.uuid,onClose:()=>ve(!1),onSave:P}),React.createElement("div",{className:"toast-container"},ye.map(x=>React.createElement(Toast,{key:x.id,message:x.message,type:x.type,onClose:()=>v(x.id)}))))}ReactDOM.render(React.createElement(AdminApp,null),document.getElementById("root"));function OrderManager({autoOpenCreateToken:k,autoOpenCreateProductId:w,showToast:O}){const[G,F]=useState([]),[C,_]=useState(0),[re,de]=useState(!1),[z,ue]=useState(!1),[xe,ce]=useState([]),[se,he]=useState(!0),[He,me]=useState(!1),[ve,we]=useState([]),[Le,Ie]=useState(!1),[_e,ye]=useState(""),[De,Ae]=useState([]),[tt,Ce]=useState(!1),[qe,Re]=useState(""),[m,M]=useState(!1),[i,b]=useState(null),[v,T]=useState(null),[K,Y]=useState(!1),[P,B]=useState(()=>{const e=new Date,a=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0");return`${a}-${t}`}),[fe,Ke]=useState(""),[u,g]=useState(!1),[pe,x]=useState(!1),[R,W]=useState(null),[Te,je]=useState(!1),[X,Ee]=useState([]),[Ye,pt]=useState(!1),[ge,Je]=useState([]),[A,ze]=useState({customer_name:"",phone:"",address:"",note:"",items:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:[{amount:"",note:""}],adjustment_amount:0,adjustment_note:"",status:"pending"}),[ae,lt]=useState([""]),[ct,Ze]=useState(null),ft=useRef({}),[h,U]=useState([]),[ie,Ue]=useState(null),et=useRef(null),Ge=useRef(null),dt=useRef(0),Qe=useRef(null),ht=useRef(0),Vt=useRef(new Map),xt=useRef(null),$t=useRef(0),Lt=useRef(new Map),Tt=useRef(new Map),jt=useRef(""),qt=useRef(null),Pt=useRef(0),Ot=useRef(null),s=9,N=150,I=250,J=3*60*1e3,ee=24*60*60*1e3,j=5*60*1e3,p="ktm_customer_lookup_cache_v1",q=200,te=3,ne=3,Q=1,be=24*60*60*1e3,We=120,Fe=5*60*1e3,at=80,bt=2,mt=4,ut=60,Be=React.useMemo(()=>String(_e||"").trim().length>0,[_e]),la=e=>String(e||"").replace(/\s+/g," ").trim(),ca=e=>String(e||"").replace(/[^0-9]+/g,""),_t=e=>{try{const a=new Date(e==null?void 0:e.created_at).getTime();if(!Number.isFinite(a))return 0;const t=Date.now()-a;return!Number.isFinite(t)||t<=0?0:Math.floor(t/be)}catch(a){return 0}},Bt=e=>String((e==null?void 0:e.status)||"").trim()!=="pending"?!1:_t(e)>=te,da=e=>{const a=String(e!=null?e:"").trim().toLowerCase();return a==="cancelled"?"canceled":a},zt=e=>{if(da(e==null?void 0:e.status)!=="draft")return null;const t=ne-_t(e);return Number.isFinite(t)?t:null},Jt=e=>{const a=zt(e);return Number.isFinite(a)?a>0&&a<=Q:!1},$=e=>{ze({customer_name:"",phone:"",address:"",note:"",items:[{product_id:e||"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:[{amount:"",note:""}],adjustment_amount:0,adjustment_note:"",status:"pending"}),lt([""]),W(null),Ze(null)};useEffect(()=>{const e=a=>{var n;if(ct==null)return;const t=(n=ft.current)==null?void 0:n[ct];t&&!t.contains(a.target)&&Ze(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[ct]);const L=e=>window.KTM.money.parseMoney(e),H=e=>window.KTM.money.parseSignedMoney(e),E=e=>window.KTM.money.formatVND(e),oe=e=>{const t=(Array.isArray(e)?e:[]).map(n=>{var l,o;return{amount:String((l=n==null?void 0:n.amount)!=null?l:""),note:String((o=n==null?void 0:n.note)!=null?o:"")}});return t.length?t:[{amount:"",note:""}]},le=e=>{try{const a=window.KTM.orders.getOrderAdjustmentItems(e),t=(Array.isArray(a)?a:[]).map(n=>{var l,o;return{amount:(n==null?void 0:n.amount)===0?"":String((l=n==null?void 0:n.amount)!=null?l:""),note:String((o=n==null?void 0:n.note)!=null?o:"").trim()}}).filter(n=>String(n.amount||"").trim()||String(n.note||"").trim());return t.length?t:[{amount:"",note:""}]}catch(a){return[{amount:"",note:""}]}},Ne=e=>(Array.isArray(e)?e:[]).map(t=>({amount:H(t==null?void 0:t.amount),note:String((t==null?void 0:t.note)||"").trim()})).filter(t=>t.amount!==0||!!t.note),Me=e=>{const a=Array.isArray(e==null?void 0:e.adjustment_items)?e.adjustment_items:[],t=Ne(a),n=Pe(t),l=(()=>{if(!t.length)return"";const o=t.map(y=>String((y==null?void 0:y.note)||"").trim()).filter(Boolean);return o.length?o.join(" \u2022 "):t.length>1?`${t.length} m\u1EE5c`:""})();return{cleanAdjItems:t,amount:n,summaryText:l}},Pe=e=>(Array.isArray(e)?e:[]).reduce((t,n)=>t+(Number(n==null?void 0:n.amount)||0),0),Xe=e=>{const a=Array.isArray(e)?e:[];return a.length?JSON.stringify(a):""},ot=e=>window.KTM.money.parseShipFeeFromNote(e),st=e=>window.KTM.phone.isValid(e),$e=e=>window.KTM.phone.normalize(e),gt=async e=>{if(!e)return null;const a=await window.KTM.api.getJSON(`${API_BASE}/api/orders/${e}`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng");return a&&typeof a=="object"&&a.order&&typeof a.order=="object"?a.order:a},vt=(e,a)=>{var o;const t=Array.isArray(e)?e:[],n=Array.isArray(a)?a:[];if(!t.length)return n;if(!n.length)return t;const l=new Map(t.map(y=>{var c;return[String((c=y==null?void 0:y.id)!=null?c:""),y]}));for(const y of n){const c=String((o=y==null?void 0:y.id)!=null?o:"");c&&l.set(c,y)}return Array.from(l.values())},yt=async e=>{if(!(e!=null&&e.id)||Array.isArray(e.items)&&e.items.length)return e;try{const a=await gt(e.id);if(a&&typeof a=="object")return F(t=>Array.isArray(t)?t.map(n=>String(n==null?void 0:n.id)===String(e.id)?a:n):t),a}catch(a){console.error("Fetch order by id error:",a)}return e},St=()=>{var e;try{const a=localStorage.getItem(p);if(!a)return;const t=JSON.parse(a);if(!t||typeof t!="object")return;const n=Object.entries(t);for(const[l,o]of n)!l||!o||typeof o!="object"||(e=Tt.current)==null||e.set(String(l),o)}catch(a){}},Nt=()=>{try{const e=Tt.current;if(!e||typeof e.entries!="function")return;const a=Array.from(e.entries()).filter(([n,l])=>n&&l&&typeof l=="object"&&Number.isFinite(l.ts)).sort((n,l)=>(Number(l[1].ts)||0)-(Number(n[1].ts)||0)).slice(0,q),t={};for(const[n,l]of a)t[n]=l;localStorage.setItem(p,JSON.stringify(t))}catch(e){}};useEffect(()=>{St()},[]);const It=e=>{const a=$e(e);if(!a)return null;const t=Array.isArray(G)?G:[];let n=null,l=-1;for(const o of t){if(!o||$e(o.phone||"")!==a)continue;const y=new Date(o.created_at).getTime(),c=Number.isFinite(y)?y:0;c>=l&&(l=c,n=o)}return n?{name:String(n.customer_name||"").trim(),address:String(n.address||"").trim()}:null},Dt=(e,a)=>{e&&ze(t=>a&&$e(t.phone)!==a?t:{...t,customer_name:e.name||t.customer_name,address:e.address||t.address})},Wt=e=>{const a=It(e);if(!a)return;const t=$e(e);ze(n=>{if(t&&$e(n.phone)!==t)return n;const l={...n};return!String(n.customer_name||"").trim()&&a.name&&(l.customer_name=a.name),!String(n.address||"").trim()&&a.address&&(l.address=a.address),l})},ma=(e,a,t)=>{var n;try{const l=$e(e);if(!l)return;const o=String(a||"").trim(),y=String(t||"").trim();if(!o&&!y)return;(n=Tt.current)==null||n.set(l,{ts:Date.now(),status:"found",customer:{phone:l,name:o||null,address:y||null}}),Nt()}catch(l){}},Kt=async e=>{var l,o,y;const a=$e(e);if(!a)return;Wt(a);const t=(l=Tt.current)==null?void 0:l.get(a);if(t&&Number.isFinite(t.ts)){const c=Date.now()-t.ts,S=t.status==="found"?ee:j;if(c>=0&&c<=S){W({status:t.status,phone:a,customer:t.customer}),t.status==="found"&&t.customer&&Dt(t.customer,a);return}}const n=++dt.current;W({status:"loading",phone:a});try{const c=await window.KTM.api.getJSON(`${API_BASE}/api/customers?phone=${encodeURIComponent(a)}`,"L\u1ED7i tra c\u1EE9u kh\xE1ch");if(dt.current!==n)return;if(c&&c.exists&&c.customer){(o=Tt.current)==null||o.set(a,{ts:Date.now(),status:"found",customer:c.customer}),Nt(),W({status:"found",phone:a,customer:c.customer}),Dt(c.customer,a);return}(y=Tt.current)==null||y.set(a,{ts:Date.now(),status:"not-found",customer:null}),Nt(),W({status:"not-found",phone:a})}catch(c){if(dt.current!==n)return;console.error("Customer lookup error:",c),W({status:"error",phone:a})}},Ha=e=>{const a=$e(e),t=It(a);ze(l=>{const o={...l,phone:a};return t&&(!String(l.customer_name||"").trim()&&t.name&&(o.customer_name=t.name),!String(l.address||"").trim()&&t.address&&(o.address=t.address)),o}),je(!1),Ge.current&&(clearTimeout(Ge.current),Ge.current=null);const n=a;if(n.length<s){W(null);return}if(st(n)&&n!==jt.current){jt.current=n,Kt(n);return}Ge.current=setTimeout(()=>{const l=$e(a);st(l)&&l!==jt.current&&(jt.current=l,Kt(l))},N)},Va=()=>{const e=$e(A.phone);e.length<s||st(e)&&e!==jt.current&&(jt.current=e,Kt(e))};useEffect(()=>(pe?(document.body.classList.add("order-modal-open"),document.body.style.overflow="hidden"):(document.body.classList.remove("order-modal-open"),document.body.style.overflow=""),()=>{document.body.classList.remove("order-modal-open"),document.body.style.overflow=""}),[pe]);const Xt=Array.isArray(A.items)?A.items.length:0;useEffect(()=>{if(!pe){Pt.current=Xt;return}Xt>Pt.current&&setTimeout(()=>{const e=qt.current;e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},0),Pt.current=Xt},[pe,Xt]),useEffect(()=>()=>{Ge.current&&(clearTimeout(Ge.current),Ge.current=null),Qe.current&&(clearTimeout(Qe.current),Qe.current=null)},[]),useEffect(()=>{if(!pe)return;Qe.current&&(clearTimeout(Qe.current),Qe.current=null);const e=$e((A==null?void 0:A.phone)||"");if(!st(e)){Ee([]),pt(!1);return}return Qe.current=setTimeout(async()=>{var l;const a=String(e),t=(l=Vt.current)==null?void 0:l.get(a);if(t&&Number.isFinite(t.ts)&&Date.now()-t.ts<=J){Ee(Array.isArray(t.orders)?t.orders:[]),pt(!1);return}const n=++ht.current;pt(!0);try{const o=`${API_BASE}/api/orders?search=${encodeURIComponent(e)}`,y=await window.KTM.api.getJSON(o,"L\u1ED7i t\u1EA3i l\u1ECBch s\u1EED \u0111\u01A1n theo S\u0110T");if(ht.current!==n)return;const c=Array.isArray(y)?y:Array.isArray(y==null?void 0:y.orders)?y.orders:[];Ee(c);try{const S=Vt.current;if(S&&typeof S.set=="function"&&(S.set(a,{ts:Date.now(),orders:c}),S.size>100)){const r=Array.from(S.entries()).sort((f,D)=>{var Z,V;return(Number((Z=f==null?void 0:f[1])==null?void 0:Z.ts)||0)-(Number((V=D==null?void 0:D[1])==null?void 0:V.ts)||0)}),d=Math.max(0,r.length-100);for(let f=0;f<d;f++)S.delete(r[f][0])}}catch(S){}}catch(o){if(ht.current!==n)return;console.error("Phone history fetch error:",o),Ee([])}finally{if(ht.current!==n)return;pt(!1)}},I),()=>{Qe.current&&(clearTimeout(Qe.current),Qe.current=null)}},[pe,A==null?void 0:A.phone]),useEffect(()=>{qa()},[]),useEffect(()=>{Be||Ft()},[P,Be]),useEffect(()=>{fa()},[]),useEffect(()=>{k&&et.current!==k&&(et.current=k,ja(w))},[k]);const ua=e=>e==="draft"?"\u0110\u01A1n nh\xE1p":e==="pending"?"Ch\u1EDD x\u1EED l\xFD":e==="processing"?"\u0110ang v\u1EADn chuy\u1EC3n":e==="done"?"Ho\xE0n th\xE0nh":e==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":e==="cancelled"||e==="canceled"?"H\u1EE7y \u0111\u01A1n":e||"",pa=e=>e==="draft"?"bg-light text-dark":e==="pending"?"bg-secondary":e==="processing"?"bg-warning text-dark":e==="done"?"bg-success":e==="paid"?"bg-primary":e==="cancelled"||e==="canceled"?"bg-danger":"bg-light text-dark",_a=React.useMemo(()=>window.KTM.orders.sortOrders(G),[G]),ha=React.useMemo(()=>window.KTM.orders.sortOrders(xe),[xe]),Qt=React.useMemo(()=>{const a=(Array.isArray(ha)?ha:[]).filter(t=>Bt(t));return a.sort((t,n)=>{const l=new Date(t==null?void 0:t.created_at).getTime(),o=new Date(n==null?void 0:n.created_at).getTime();return(Number.isFinite(l)?l:0)-(Number.isFinite(o)?o:0)}),a},[ha]),Ma=React.useMemo(()=>{const a=(Array.isArray(ve)?ve:[]).filter(t=>Jt(t));return a.sort((t,n)=>{const l=new Date(t==null?void 0:t.created_at).getTime(),o=new Date(n==null?void 0:n.created_at).getTime();return(Number.isFinite(l)?l:0)-(Number.isFinite(o)?o:0)}),a},[ve]),Gt=React.useMemo(()=>u?Qt:_a,[u,Qt,_a]),Yt=React.useMemo(()=>{if(u)return Gt;const e=String(fe||"").trim();return e?(Array.isArray(Gt)?Gt:[]).filter(a=>String((a==null?void 0:a.status)||"").trim()===e):Gt},[Gt,fe,u]),$a=React.useMemo(()=>window.KTM.orders.sortOrders(De),[De]),Zt=React.useMemo(()=>Be?$a:Yt,[Yt,Be,$a]),ba=e=>window.KTM.date.formatDateTime(e),qa=async()=>{try{const e=await window.KTM.api.getJSON(`${API_BASE}/api/products?fields=order`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");U(Array.isArray(e)?e:[])}catch(e){console.error("Load products error:",e),U([])}},Ft=async()=>{he(!0),ue(!1);try{const a=new URLSearchParams;P&&a.set("month",String(P)),a.set("includeItems","0"),a.set("meta","1"),a.set("limit",String(ut)),a.set("offset","0");const t=`${API_BASE}/api/orders?${a.toString()}`,n=await window.KTM.api.getJSON(t,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),l=Array.isArray(n)?n:Array.isArray(n==null?void 0:n.orders)?n.orders:[],o=!Array.isArray(n)&&n&&typeof n=="object"&&n.meta||null;F(Array.isArray(l)?l:[]),_(Array.isArray(l)?l.length:0),de(!!(o!=null&&o.hasMore)),fa()}catch(a){console.error("Load orders error:",a),F([]),_(0),de(!1)}finally{he(!1),ue(!1)}},Ba=async()=>{if(!(se||z||Be)&&re){ue(!0);try{const e=new URLSearchParams;P&&e.set("month",String(P)),e.set("includeItems","0"),e.set("meta","1"),e.set("limit",String(ut)),e.set("offset",String(C));const a=`${API_BASE}/api/orders?${e.toString()}`,t=await window.KTM.api.getJSON(a,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),n=Array.isArray(t)?t:Array.isArray(t==null?void 0:t.orders)?t.orders:[],l=!Array.isArray(t)&&t&&typeof t=="object"&&t.meta||null;F(o=>vt(o,Array.isArray(n)?n:[])),_(o=>o+(Array.isArray(n)?n.length:0)),de(!!(l!=null&&l.hasMore))}catch(e){console.error("Load more orders error:",e)}finally{ue(!1)}}},Ta=async e=>{var l;const a=la(e);if(!a){Ae([]),Re(""),Ce(!1);return}const t=ca(a);if(a.length<bt&&t.length<mt){Ae([]),Re(`Nh\u1EADp \xEDt nh\u1EA5t ${bt} k\xFD t\u1EF1 (ho\u1EB7c ${mt} s\u1ED1) \u0111\u1EC3 search nhanh`),Ce(!1);return}try{const o=(l=Lt.current)==null?void 0:l.get(a);if(o&&Number.isFinite(o.ts)&&Date.now()-o.ts<=Fe){Ae(Array.isArray(o.results)?o.results:[]),Re(""),Ce(!1);return}}catch(o){}const n=++$t.current;Ce(!0),Re("");try{const o=`${API_BASE}/api/orders?search=${encodeURIComponent(a)}`,y=await window.KTM.api.getJSON(o,"L\u1ED7i search \u0111\u01A1n h\xE0ng");if($t.current!==n)return;const c=Array.isArray(y)?y:[];Ae(c);try{const S=Lt.current;if(S&&typeof S.set=="function"&&(S.set(a,{ts:Date.now(),results:c}),S.size>at)){const r=Array.from(S.entries()).sort((f,D)=>{var Z,V;return(Number((Z=f==null?void 0:f[1])==null?void 0:Z.ts)||0)-(Number((V=D==null?void 0:D[1])==null?void 0:V.ts)||0)}),d=Math.max(0,r.length-at);for(let f=0;f<d;f++)S.delete(r[f][0])}}catch(S){}}catch(o){if($t.current!==n)return;console.error("Order search error:",o),Ae([]),Re((o==null?void 0:o.message)||"Search l\u1ED7i")}finally{if($t.current!==n)return;Ce(!1)}};useEffect(()=>{xt.current&&(clearTimeout(xt.current),xt.current=null);const e=la(_e);if(!e){Ae([]),Re(""),Ce(!1);return}return u&&g(!1),xt.current=setTimeout(()=>{Ta(e)},We),()=>{xt.current&&(clearTimeout(xt.current),xt.current=null)}},[_e]);const fa=async()=>{me(!0),Ie(!0);try{const[e,a]=await Promise.all([window.KTM.api.getJSON(`${API_BASE}/api/orders?overdue=1&days=${encodeURIComponent(te)}&includeItems=0`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),window.KTM.api.getJSON(`${API_BASE}/api/orders?draftExpiring=1&remainingDays=${encodeURIComponent(Q)}&includeItems=0`,"L\u1ED7i t\u1EA3i \u0111\u01A1n nh\xE1p")]);ce(Array.isArray(e)?e:[]),we(Array.isArray(a)?a:[])}catch(e){console.error("Load all orders error:",e),ce([]),we([])}finally{me(!1),Ie(!1)}},ga=async e=>{const a=await yt(e);if(!a)return;Ue(a.id);const t=Array.isArray(a.items)&&a.items.length?a.items.map(c=>{var S,r,d,f;return{product_id:(c==null?void 0:c.product_id)||"",quantity:Number((S=c==null?void 0:c.quantity)!=null?S:1)||1,unit_price:(()=>{var V;const D=(V=c==null?void 0:c.unit_price)!=null?V:c==null?void 0:c.unitPrice,Z=D==null||D===""?NaN:Number(D);return Number.isFinite(Z)?Math.trunc(Z):null})(),variant:String((r=c==null?void 0:c.variant)!=null?r:"").trim(),variant_json:(f=(d=c==null?void 0:c.variant_json)!=null?d:c==null?void 0:c.variantJson)!=null?f:null}}).filter(c=>c.product_id):[{product_id:a.product_id||"",quantity:Number(a.quantity||1)||1,unit_price:null,variant:"",variant_json:null}],n=le(a),l=Ne(n),o=Pe(l),y=Xe(l);ze({customer_name:a.customer_name||"",phone:$e(a.phone||""),address:a.address||"",note:(a==null?void 0:a.note)||"",items:t.length?t:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:n,adjustment_amount:o,adjustment_note:y||(a==null?void 0:a.adjustment_note)||"",status:a.status||"pending"}),lt(new Array(t.length?t.length:1).fill("")),Je(new Array(t.length?t.length:1).fill(!0)),W(null),x(!0),a.phone&&Kt($e(a.phone))};function ja(e){Ue(null),$(e||""),je(!1),Je([]),x(!0)}const va=()=>{m||K||(x(!1),Ue(null),$(""),je(!1),Je([]))},za=async()=>{var c,S,r;if(!ie||K||m)return;const e=(Array.isArray(G)?G:[]).find(d=>String(d==null?void 0:d.id)===String(ie))||null,a=String((e==null?void 0:e.status)||(A==null?void 0:A.status)||"").trim();if(a==="done"||a==="paid"||a==="canceled"){const d="Kh\xF4ng th\u1EC3 t\xE1ch: \u0111\u01A1n \u0111\xE3 ho\xE0n th\xE0nh/\u0111\xE3 nh\u1EADn ti\u1EC1n/\u0111\xE3 h\u1EE7y.";typeof O=="function"?O(d,"warning"):alert(d);return}const t=$e(A.phone),l=(Array.isArray(A.items)?A.items:[]).map((d,f)=>{var D,Z;return{idx:f,product_id:String((d==null?void 0:d.product_id)||"").trim(),quantity:Number((D=d==null?void 0:d.quantity)!=null?D:0),variant:String((d==null?void 0:d.variant)||"").trim()||null,variant_json:(Z=d==null?void 0:d.variant_json)!=null?Z:null,unit_price:(()=>{const V=d==null?void 0:d.unit_price,Se=V===""||V==null?NaN:Number(V);if(Number.isFinite(Se))return Math.max(0,Math.trunc(Se));const ke=Ct(d==null?void 0:d.product_id),nt=d!=null&&d.variant_json&&typeof d.variant_json=="object"?d.variant_json:null;return ta(ke,nt)})()}}).filter(d=>d.product_id&&Number.isFinite(d.quantity)&&d.quantity>0);if(l.length<2){const d="C\u1EA7n \xEDt nh\u1EA5t 2 s\u1EA3n ph\u1EA9m \u0111\u1EC3 t\xE1ch \u0111\u01A1n.";typeof O=="function"?O(d,"warning"):alert(d);return}const o=[],y=[];for(const d of l){const f=!!ge[d.idx],D={product_id:d.product_id,quantity:d.quantity,unit_price:d.unit_price,variant:d.variant,variant_json:d.variant_json};f?o.push(D):y.push(D)}if(!o.length||!y.length){const d="Ch\u1ECDn m\u1ED9t s\u1ED1 s\u1EA3n ph\u1EA9m \u201CGiao \u0111\u1EE3t 1\u201D, v\xE0 \u0111\u1EC3 l\u1EA1i \xEDt nh\u1EA5t 1 s\u1EA3n ph\u1EA9m \u201CCh\u1EDD h\xE0ng\u201D.";typeof O=="function"?O(d,"warning"):alert(d);return}Y(!0);try{const d=Array.isArray(A==null?void 0:A.adjustment_items)?A.adjustment_items:[],f=Ne(d),D=Pe(f),Z=Xe(f),V={customer_name:A.customer_name,phone:t,address:A.address,note:(A.note||"").trim(),adjustment_amount:D,adjustment_note:Z,adjustment_items:f,status:"processing",items:o,product_id:o[0].product_id,quantity:o[0].quantity,split_seq:1},Se=await window.KTM.api.postJSON(`${API_BASE}/api/orders`,V,"L\u1ED7i t\xE1ch \u0111\u01A1n (t\u1EA1o \u0111\u01A1n giao ngay)"),ke=(r=(S=Se==null?void 0:Se.id)!=null?S:(c=Se==null?void 0:Se.order)==null?void 0:c.id)!=null?r:null;if(!ke)throw new Error("T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i: kh\xF4ng nh\u1EADn \u0111\u01B0\u1EE3c ID \u0111\u01A1n giao ngay");const nt={id:ie,customer_name:A.customer_name,phone:t,address:A.address,note:(A.note||"").trim(),adjustment_amount:0,adjustment_note:"",adjustment_items:[],status:"pending",items:y,product_id:y[0].product_id,quantity:y[0].quantity,parent_order_id:String(ke),split_seq:2};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${ie}`,nt,"L\u1ED7i t\xE1ch \u0111\u01A1n (c\u1EADp nh\u1EADt ph\u1EA7n ch\u1EDD h\xE0ng)"),va(),Ft();const it=ke?`\u0110\xE3 t\xE1ch \u0111\u01A1n. \u0110\u01A1n giao ngay: #${ke}`:"\u0110\xE3 t\xE1ch \u0111\u01A1n.";typeof O=="function"?O(it,"success"):alert(it)}catch(d){console.error(d);const f=(d==null?void 0:d.message)||"T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i";typeof O=="function"?O(f,"danger"):alert(f)}finally{Y(!1)}},Ja=e=>{if(!e)return"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --";const a=String(e),t=h.find(n=>String(n==null?void 0:n.id)===a);return t?`${t.name}${t.code?` (${t.code})`:""}`:"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"},kt=e=>{try{return String(e!=null?e:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(a){return String(e!=null?e:"").toLowerCase()}},Ga=e=>{const t=kt(e).trim().split(/\s+/).filter(Boolean),n=t.join(" ");return{contentTokens:t,cleanedQuery:n}},Oa=React.useMemo(()=>(Array.isArray(h)?h:[]).map((e,a)=>{var r,d,f,D,Z,V;const t=kt((r=e==null?void 0:e.name)!=null?r:""),n=kt((d=e==null?void 0:e.code)!=null?d:""),l=kt((f=e==null?void 0:e.category)!=null?f:""),o=kt((D=e==null?void 0:e.note)!=null?D:""),y=kt((Z=e==null?void 0:e.id)!=null?Z:""),c=kt((V=e==null?void 0:e.stt)!=null?V:""),S=`${t} ${n} ${l} ${o} ${y} ${c}`.trim();return{p:e,originalIndex:a,name:t,code:n,category:l,note:o,haystackAll:S}}),[h]),Ua=(e,a,t)=>{var f,D,Z,V,Se;const n=Array.isArray(a)?a:[],l=kt(t).trim();if(!n.length&&!l)return 0;const o=(f=e==null?void 0:e.name)!=null?f:"",y=(D=e==null?void 0:e.code)!=null?D:"",c=(Z=e==null?void 0:e.category)!=null?Z:"",S=(V=e==null?void 0:e.note)!=null?V:"";if(!((Se=e==null?void 0:e.haystackAll)!=null?Se:""))return 0;let d=0;l&&(o===l&&(d+=220),o.includes(l)&&(d+=140),o.startsWith(l)&&(d+=160),y&&y===l&&(d+=180),y&&y.includes(l)&&(d+=90));for(const ke of n){if(!ke)continue;const nt=new RegExp(`(?:^|\\s)${ke.replace(/[.*+?^${}()|[\[\]\\]/g,"\\$&")}`);o.includes(ke)&&(d+=35),nt.test(o)&&(d+=25),y&&y.includes(ke)&&(d+=20),y&&nt.test(y)&&(d+=10),c&&c.includes(ke)&&(d+=12),S&&S.includes(ke)&&(d+=6)}return d>0&&o&&(d+=Math.max(0,10-Math.min(10,Math.floor(o.length/10)))),d},ya=(e,a)=>{const t=String(e||""),n=String(a||"");if(t===n)return 0;if(!t)return n.length;if(!n)return t.length;const l=t.length,o=n.length;if(o>l)return ya(n,t);let y=new Array(o+1),c=new Array(o+1);for(let S=0;S<=o;S++)y[S]=S;for(let S=1;S<=l;S++){c[0]=S;const r=t.charCodeAt(S-1);for(let f=1;f<=o;f++){const D=r===n.charCodeAt(f-1)?0:1;c[f]=Math.min(y[f]+1,c[f-1]+1,y[f-1]+D)}const d=y;y=c,c=d}return y[o]},Wa=(e,a)=>{const t=String(e||"").trim(),n=String(a||"");if(!t||!n)return!1;if(n.includes(t))return!0;const l=n.split(/\s+/).filter(Boolean);if(!l.length)return!1;const o=t.length<=4?1:2;for(const y of l)if(!(Math.abs(y.length-t.length)>o)&&ya(t,y)<=o)return!0;return!1},ea=e=>{const a=kt(e).replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim();return a?a.split(" ").filter(Boolean):[]},Xa=(e,a)=>{const t=Array.isArray(a)?a:[];if(!t.length)return 0;const n=ea((e==null?void 0:e.name)||""),l=ea((e==null?void 0:e.code)||""),o=ea((e==null?void 0:e.category)||""),y=ea((e==null?void 0:e.note)||""),c=(r,d,f)=>{const D=String(r||"").trim();if(!D||!d.length)return 0;const Z=D.length<=4?1:2;let V=1/0,Se=-1;for(let it=0;it<d.length;it++){const wt=d[it];if(!wt||Math.abs(wt.length-D.length)>Z)continue;const Ve=ya(D,wt);if(Ve<V&&(V=Ve,Se=it,Ve===0))break}if(V===1/0||V>Z)return 0;let nt=Math.round(f*(V===0?1:V===1?.65:.45));return Se===0?nt+=Math.round(f*.25):Se===1&&(nt+=Math.round(f*.12)),nt};let S=0;for(const r of t){if(!r)continue;const d=c(r,n,180),f=c(r,l,120),D=c(r,o,60),Z=c(r,y,30);S+=Math.max(d,f,D,Z)}if(S>0){const r=((e==null?void 0:e.name)||"").length;S+=Math.max(0,60-Math.min(60,Math.floor(r/2)))}return S},Na=React.useRef(new Map);React.useEffect(()=>{Na.current=new Map},[h]);const Qa=e=>{var r,d;const a=String(ae[e]||"").trim();if(!a)return h;const{contentTokens:t,cleanedQuery:n}=Ga(a);if(t.length===0)return h;const l=kt(a).trim(),o=Na.current.get(l);if(o)return o;const y=[];for(const f of Oa){const D=f.haystackAll;D&&t.some(Z=>D.includes(Z))&&y.push(f)}let c=y;if(c.length<8&&t.length>0){const f=[],D=new Set(c.map(Z=>{var V,Se;return String((Se=(V=Z.p)==null?void 0:V.id)!=null?Se:"")+":"+String(Z.originalIndex)}));for(const Z of Oa){const V=String((d=(r=Z.p)==null?void 0:r.id)!=null?d:"")+":"+String(Z.originalIndex);if(D.has(V))continue;const Se=Z.haystackAll;Se&&t.some(ke=>Wa(ke,Se))&&(f.push(Z),D.add(V))}f.length&&(c=c.concat(f))}const S=c.map(f=>({entry:f,score:Ua(f,t,n)})).map(f=>{if(f.score>0)return f;const D=Xa(f.entry,t);return D>0?{...f,score:D}:f}).filter(f=>f.score>0).sort((f,D)=>D.score!==f.score?D.score-f.score:f.entry.originalIndex-D.entry.originalIndex).slice(0,40).map(f=>f.entry.p);return Na.current.set(l,S),S},Ct=e=>{if(!e)return null;const a=String(e);return h.find(t=>String(t==null?void 0:t.id)===a)||null},Ut=e=>{if(e==null||e==="")return[];let a=e;if(typeof a=="string"){const t=a.trim();if(!t)return[];try{a=JSON.parse(t)}catch(n){return[]}}return Array.isArray(a)?a.map((t,n)=>{var y;if(!t||typeof t!="object")return null;const l=String((y=t.name)!=null?y:"").trim()||`Bi\u1EBFn th\u1EC3 ${n+1}`,o=(Array.isArray(t.options)?t.options:[]).map(c=>{var Se,ke,nt,it,wt,Ve,At;if(!c||typeof c!="object")return null;const S=String((Se=c.label)!=null?Se:"").trim();if(!S)return null;const r=(wt=(it=(nt=(ke=c.price)!=null?ke:c.priceValue)!=null?nt:c.unit_price)!=null?it:c.unitPrice)!=null?wt:null,d=r==null||r===""?NaN:typeof r=="number"?r:typeof r=="string"?L(r):Number(r),f=Number.isFinite(d)?Math.trunc(d):null,D=(At=(Ve=c.price_delta)!=null?Ve:c.priceDelta)!=null?At:null,Z=Number(D),V=Number.isFinite(Z)?Math.trunc(Z):0;return{label:S,price:f,price_delta:V}}).filter(Boolean);return{name:l,options:o}}).filter(Boolean):[]},rn=e=>{const a=Ct(e);return Ut(a==null?void 0:a.variants)},Ia=e=>{if(!e||typeof e!="object")return"";const a=[];for(const[t,n]of Object.entries(e)){const l=String(t||"").trim(),o=String(n||"").trim();!l||!o||a.push(`${l}: ${o}`)}return a.join(", ")},ta=(e,a)=>{const t=L(e==null?void 0:e.price),n=Ut(e==null?void 0:e.variants);if(!n.length||!a||typeof a!="object")return t;let l=t,o=!1;for(const y of n){const c=String((y==null?void 0:y.name)||"").trim(),S=String((a==null?void 0:a[c])||"").trim();if(!c||!S)continue;const r=(Array.isArray(y.options)?y.options:[]).find(V=>String((V==null?void 0:V.label)||"").trim()===S);if(!r)continue;const d=r==null?void 0:r.price,f=d==null||d===""?NaN:Number(d);if(Number.isFinite(f)){l=Math.max(0,Math.trunc(f)),o=!0;continue}const D=r==null?void 0:r.price_delta,Z=D==null||D===""?NaN:Number(D);Number.isFinite(Z)&&(l+=Math.trunc(Z))}return l},wa=e=>window.KTM.orders.getOrderItems(e),Ya=e=>window.KTM.orders.getOrderTotalQty(e),aa=e=>window.KTM.orders.getOrderProductSummary(e,Ct),xa=e=>window.KTM.orders.getOrderItemRows(e,Ct),Sa=e=>window.KTM.orders.getOrderAdjustmentMoney(e),na=e=>window.KTM.orders.getOrderAdjustmentSummaryText(e),Za=e=>{const a=wa(e),t=xa(e),n=ia(a),l=sa(a),o=l.fee,y=Sa(e),c=n+o+y,S=d=>{const f=Number(d)||0;return f>0?`+${E(f)}`:E(f)},r=[];if(e!=null&&e.customer_name&&r.push(`KH\xC1CH: ${e.customer_name}`),e!=null&&e.phone&&r.push(`S\u0110T: ${e.phone}`),e!=null&&e.address&&r.push(`\u0110\u1ECAA CH\u1EC8: ${e.address}`),((e==null?void 0:e.note)||"").trim()&&r.push(`GHI CH\xDA: ${(e.note||"").trim()}`),r.push(""),r.push("S\u1EA2N PH\u1EA8M:"),t.length)for(const d of t)r.push(`- ${d.name} (SL: ${d.qty})`);else{const d=aa(e);d&&d!=="\u2014"&&r.push(`- ${d}`)}r.push(""),r.push(`T\u1EA0M T\xCDNH: ${E(n)}`),l.found&&o!==0&&r.push(`SHIP: ${E(o)}`);{const d=window.KTM.orders.getOrderAdjustmentItems(e),f=(Array.isArray(d)?d:[]).map(V=>{var Se;return{amount:Number((Se=V==null?void 0:V.amount)!=null?Se:0)||0,note:String((V==null?void 0:V.note)||"").trim()}}).filter(V=>V.amount!==0||!!V.note),D=na(e);if(y!==0||f.length>0||!!D)if(f.length===1){const V=f[0];r.push(`\u0110I\u1EC0U CH\u1EC8NH: ${S(y)}${V.note?` \u2014 ${V.note}`:""}`)}else{r.push(`\u0110I\u1EC0U CH\u1EC8NH: ${S(y)}${!f.length&&D?` \u2014 ${D}`:""}`);for(const V of f)r.push(`- ${S(V.amount)}${V.note?`: ${V.note}`:""}`)}}return r.push(`T\u1ED4NG: ${E(c)}`),r.filter(Boolean).join(`
`)},Da=async e=>{try{const a=await yt(e),t=Za(a);await window.KTM.clipboard.writeText(t),typeof O=="function"?O("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng","success"):alert("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng")}catch(a){console.error(a),typeof O=="function"?O("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)","danger"):alert("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)")}},sa=e=>window.KTM.orders.getOrderShipInfo(e,Ct),ia=e=>window.KTM.orders.getItemsSubtotal(e,Ct),ka=e=>{try{const a=e instanceof Date?e:new Date(e);if(!a||Number.isNaN(a.getTime()))return"";const t=a.getFullYear(),n=String(a.getMonth()+1).padStart(2,"0");return`${t}-${n}`}catch(a){return""}},Ca=()=>P?String(P):ka(new Date),Ra=e=>{const a=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),t=$e((e==null?void 0:e.phone)||""),n=String((e==null?void 0:e.address)||"").trim().toLowerCase(),l=Me(e).amount,y=(Array.isArray(e==null?void 0:e.items)?e.items:[]).map(c=>{var S;return{product_id:String((c==null?void 0:c.product_id)||"").trim(),quantity:Number((S=c==null?void 0:c.quantity)!=null?S:0),variant:String((c==null?void 0:c.variant)||"").trim()}}).filter(c=>c.product_id&&Number.isFinite(c.quantity)&&c.quantity>0).sort((c,S)=>c.product_id<S.product_id?-1:c.product_id>S.product_id?1:c.variant<S.variant?-1:c.variant>S.variant?1:c.quantity-S.quantity);return JSON.stringify({name:a,phone:t,address:n,items:y,adj:l})},Mt=React.useMemo(()=>{const e=$e((A==null?void 0:A.phone)||"");if(!e)return{count:0,orders:[],monthKey:Ca()};const a=Ca(),n=(Array.isArray(X)?X:[]).filter(l=>{if(!l||ie&&String(l.id)===String(ie)||$e(l.phone||"")!==e)return!1;const o=ka(l.created_at);return o&&o===a}).sort((l,o)=>{const y=new Date(l.created_at).getTime(),c=new Date(o.created_at).getTime();return(Number.isFinite(c)?c:0)-(Number.isFinite(y)?y:0)});return{count:n.length,orders:n,monthKey:a}},[X,A==null?void 0:A.phone,P,ie]),en=e=>{var c;const a=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),t=$e((e==null?void 0:e.phone)||""),n=String((e==null?void 0:e.address)||"").trim().toLowerCase(),l=H((c=e==null?void 0:e.adjustment_amount)!=null?c:0),o=wa(e),y=(Array.isArray(o)?o:[]).map(S=>{var r;return{product_id:String((S==null?void 0:S.product_id)||"").trim(),quantity:Number((r=S==null?void 0:S.quantity)!=null?r:0),variant:String((S==null?void 0:S.variant)||"").trim()}}).filter(S=>S.product_id&&Number.isFinite(S.quantity)&&S.quantity>0).sort((S,r)=>S.product_id<r.product_id?-1:S.product_id>r.product_id?1:S.variant<r.variant?-1:S.variant>r.variant?1:S.quantity-r.quantity);return JSON.stringify({name:a,phone:t,address:n,items:y,adj:l})},La=React.useMemo(()=>{if(ie)return"";const e=$e((A==null?void 0:A.phone)||"");if(!e)return"";const a=Ca(),t=Ra(A),n=Array.isArray(X)?X:[];for(const l of n){if(!l||ie&&String(l.id)===String(ie)||$e(l.phone||"")!==e)continue;const o=ka(l.created_at);if(!o||o!==a)continue;const y=en(l);if(y&&y===t)return`\u0110\u01A1n n\xE0y gi\u1ED1ng 100% m\u1ED9t \u0111\u01A1n trong th\xE1ng ${a}${l!=null&&l.id?` (#${l.id})`:""}`}return""},[X,A,P,ie]),Pa=e=>{var wt;const a=[],t=[],n=String((e==null?void 0:e.customer_name)||"").trim(),l=$e((e==null?void 0:e.phone)||""),o=String((e==null?void 0:e.address)||"").trim();n||a.push("Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng"),l||a.push("Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i"),l&&!st(l)&&a.push("S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)"),o||t.push("Thi\u1EBFu \u0111\u1ECBa ch\u1EC9");const c=(Array.isArray(e==null?void 0:e.items)?e.items:[]).filter(Ve=>Ve&&Ve.product_id);c.length===0&&a.push("Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m"),c.some(Ve=>{var Et;const At=Number((Et=Ve==null?void 0:Ve.quantity)!=null?Et:0);return!Number.isFinite(At)||At<=0})&&a.push("S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0");const r=new Set;let d=!1;for(const Ve of c){const At=String(Ve.product_id||"").trim(),Et=String((Ve==null?void 0:Ve.variant)||"").trim();if(!At)continue;const Oe=`${At}||${Et}`;if(r.has(Oe)){d=!0;break}r.add(Oe)}d&&t.push("S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)");const f=ia(c),D=sa(c),Z=D!=null&&D.found?Number((wt=D==null?void 0:D.fee)!=null?wt:0):0,V=Array.isArray(e==null?void 0:e.adjustment_items)?e.adjustment_items:[],Se=Ne(V),ke=Pe(Se),nt=Se.some(Ve=>(Number(Ve==null?void 0:Ve.amount)||0)!==0&&!String((Ve==null?void 0:Ve.note)||"").trim());D!=null&&D.found&&(Z>=2e5||f>0&&Z>f*.6)&&t.push(`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${E(Z)}`),nt&&t.push("C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh");const it=Math.abs(ke);return(it>=5e5||f>0&&it>f*.5)&&ke!==0&&t.push(`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${E(ke)}`),{errors:a,warnings:t,canSubmit:a.length===0}},on=React.useMemo(()=>Pa(A),[A,h]),rt=React.useMemo(()=>{var Et;const e=String((A==null?void 0:A.customer_name)||"").trim(),a=$e((A==null?void 0:A.phone)||""),t=String((A==null?void 0:A.address)||"").trim(),n=Array.isArray(A==null?void 0:A.items)?A.items:[],l=new Map;for(const Oe of n){const Ht=String((Oe==null?void 0:Oe.product_id)||"").trim(),ra=String((Oe==null?void 0:Oe.variant)||"").trim();if(!Ht)continue;const oa=`${Ht}||${ra}`;l.set(oa,(l.get(oa)||0)+1)}const o=n.map(Oe=>{var Fa;const Ht=String((Oe==null?void 0:Oe.product_id)||"").trim(),ra=Number((Fa=Oe==null?void 0:Oe.quantity)!=null?Fa:0),oa=Ht?"":"Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m",tn=Number.isFinite(ra)&&ra>0?"":"S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0",an=String((Oe==null?void 0:Oe.variant)||"").trim(),nn=`${Ht}||${an}`,sn=Ht&&(l.get(nn)||0)>1?"S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)":"";return{productError:oa,qtyError:tn,dupWarn:sn}}),y=n.filter(Oe=>Oe&&Oe.product_id),c=ia(y),S=sa(y),r=S!=null&&S.found?Number((Et=S==null?void 0:S.fee)!=null?Et:0):0,d=Array.isArray(A==null?void 0:A.adjustment_items)?A.adjustment_items:[],f=Ne(d),D=Pe(f),Z=f.some(Oe=>(Number(Oe==null?void 0:Oe.amount)||0)!==0&&!String((Oe==null?void 0:Oe.note)||"").trim()),V=Math.abs(D),Se=Z?"C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh":"",ke=D!==0&&(V>=5e5||c>0&&V>c*.5)?`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${E(D)}`:"",nt=S!=null&&S.found&&(r>=2e5||c>0&&r>c*.6)?`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${E(r)}`:"",it=e?"":"Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng",wt=a?st(a)?"":"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)":"Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",Ve=t?"":"Thi\u1EBFu \u0111\u1ECBa ch\u1EC9",At=!it&&!wt&&o.every(Oe=>!Oe.productError&&!Oe.qtyError);return{nameError:it,phoneError:wt,addressWarn:Ve,items:o,shipAbnormalWarn:nt,adjustmentNoteWarn:Se,adjustmentAbnormalWarn:ke,canSubmit:At}},[A,h]),Ka=async e=>{var y,c,S;const a=(e==null?void 0:e.mode)||"close",t=Pa(A);if(!t.canSubmit){const r=t.errors[0]||"Thi\u1EBFu d\u1EEF li\u1EC7u b\u1EAFt bu\u1ED9c";typeof O=="function"?O(r,"danger"):alert(r);return}if(!ie&&La){const r=`${La}

B\u1EA1n c\xF3 mu\u1ED1n ti\u1EBFp t\u1EE5c l\u01B0u kh\xF4ng?`;if(!window.confirm(r)){(Mt==null?void 0:Mt.count)>0&&je(!0),setTimeout(()=>{var D;const f=document.getElementById("order-phone-input");f&&typeof f.scrollIntoView=="function"&&(f.scrollIntoView({block:"center",behavior:"smooth"}),(D=f.focus)==null||D.call(f))},0);return}}const n=$e(A.phone),o=(Array.isArray(A.items)?A.items:[]).map(r=>{var d,f;return{product_id:(r==null?void 0:r.product_id)||"",quantity:Number((d=r==null?void 0:r.quantity)!=null?d:1),variant:String((r==null?void 0:r.variant)||"").trim()||null,variant_json:(f=r==null?void 0:r.variant_json)!=null?f:null,unit_price:(()=>{const D=r==null?void 0:r.unit_price,Z=D===""||D==null?NaN:Number(D);if(Number.isFinite(Z))return Math.max(0,Math.trunc(Z));const V=Ct(r==null?void 0:r.product_id),Se=r!=null&&r.variant_json&&typeof r.variant_json=="object"?r.variant_json:null;return ta(V,Se)})()}}).filter(r=>r.product_id&&Number.isFinite(r.quantity)&&r.quantity>0);M(!0);try{const r=ie?`${API_BASE}/api/orders/${ie}`:`${API_BASE}/api/orders`,d=o[0],f=Array.isArray(A==null?void 0:A.adjustment_items)?A.adjustment_items:[],D=Ne(f),Z=Pe(D),V=Xe(D),Se={customer_name:A.customer_name,phone:n,address:A.address,note:(A.note||"").trim(),adjustment_amount:Z,adjustment_note:V,adjustment_items:D,product_id:d.product_id,quantity:d.quantity,status:A.status,items:o,...ie?{id:ie}:{}};if(ie)await window.KTM.api.putJSON(r,Se,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");else{const ke=await window.KTM.api.postJSON(r,Se,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");Ot.current={id:(S=(c=ke==null?void 0:ke.id)!=null?c:(y=ke==null?void 0:ke.order)==null?void 0:y.id)!=null?S:null,fingerprint:Ra(A),ts:Date.now()}}ma(n,A.customer_name,A.address),a==="new"&&!ie?($(""),Ue(null),x(!0)):($(""),Ue(null),x(!1)),Ft()}catch(r){console.error(r),typeof O=="function"?O(r.message,"danger"):alert(r.message);return}finally{M(!1)}},Aa=e=>window.KTM.orders.getOrderTotalMoney(e,Ct),Ea=async e=>{if(confirm("X\xF3a \u0111\u01A1n h\xE0ng n\xE0y?")){b(e);try{await window.KTM.api.deleteJSON(`${API_BASE}/api/orders/${e}`,"L\u1ED7i x\xF3a \u0111\u01A1n h\xE0ng"),Ft(),fa()}catch(a){console.error(a),typeof O=="function"?O(a.message,"danger"):alert(a.message)}finally{b(null)}}},Rt=async(e,a)=>{var l;const t=await yt(e),n=t==null?void 0:t.id;if(!(!n||!a)){T(n);try{const o=wa(t),y=(Array.isArray(o)?o:[]).map(r=>{var d,f;return{product_id:(r==null?void 0:r.product_id)||"",quantity:Number((d=r==null?void 0:r.quantity)!=null?d:1),variant:String((r==null?void 0:r.variant)||"").trim()||null,variant_json:(f=r==null?void 0:r.variant_json)!=null?f:null,unit_price:(()=>{var V;const D=(V=r==null?void 0:r.unit_price)!=null?V:r==null?void 0:r.unitPrice,Z=Number(D);return Number.isFinite(Z)?Math.max(0,Math.trunc(Z)):null})()}}).filter(r=>r.product_id&&Number.isFinite(r.quantity)&&r.quantity>0);if(!y.length)throw new Error("Kh\xF4ng th\u1EC3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i: \u0111\u01A1n kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m h\u1EE3p l\u1EC7");const c=y[0],S={id:n,customer_name:(t==null?void 0:t.customer_name)||"",phone:$e((t==null?void 0:t.phone)||""),address:(t==null?void 0:t.address)||"",note:((t==null?void 0:t.note)||"").trim(),adjustment_amount:Number((l=t==null?void 0:t.adjustment_amount)!=null?l:0)||0,adjustment_note:(t==null?void 0:t.adjustment_note)||"",product_id:c.product_id,quantity:c.quantity,status:a,items:y};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${n}`,S,"L\u1ED7i c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i"),F(r=>Array.isArray(r)?r.map(d=>(d==null?void 0:d.id)===n?{...d,status:a}:d):r),ce(r=>Array.isArray(r)?r.map(d=>(d==null?void 0:d.id)===n?{...d,status:a}:d):r),typeof O=="function"&&O("\u0110\xE3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i","success")}catch(o){console.error(o),typeof O=="function"?O(o.message,"danger"):alert(o.message)}finally{T(null)}}};return React.createElement("div",{className:"product-manager"},React.createElement(Loading,{show:se&&!pe&&!Be||m||!!i||!!v}),React.createElement("div",{className:"product-header"},React.createElement("h5",null,"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"),React.createElement("button",{className:"btn btn-dark btn-sm",onClick:ja,disabled:m||!!i},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o \u0111\u01A1n")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-4"},React.createElement("label",{className:"form-label mb-1"},"L\u1ECDc theo th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:P,onChange:e=>B(e.target.value),"aria-label":"Ch\u1ECDn th\xE1ng",disabled:u||Be}),P&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{B("")},title:"B\u1ECF l\u1ECDc","aria-label":"B\u1ECF l\u1ECDc",disabled:se||Be},React.createElement("i",{className:"fas fa-times"})))),React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-filter"})),React.createElement("select",{className:"form-select",value:fe,onChange:e=>Ke(e.target.value),"aria-label":"L\u1ECDc theo tr\u1EA1ng th\xE1i",disabled:u||Be},React.createElement("option",{value:""},"T\u1EA5t c\u1EA3"),React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n")),fe&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>Ke(""),title:"B\u1ECF l\u1ECDc tr\u1EA1ng th\xE1i","aria-label":"B\u1ECF l\u1ECDc tr\u1EA1ng th\xE1i",disabled:se||Be},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"form-check mt-2"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"orders-overdue-only",checked:u,onChange:e=>{if(Be)return;const a=!!e.target.checked;g(a),a&&Ke("pending")},disabled:Be}),React.createElement("label",{className:"form-check-label",htmlFor:"orders-overdue-only"},"Ch\u1EC9 hi\u1EC7n \u0111\u01A1n ch\u1EADm > ",te," ng\xE0y (Ch\u1EDD x\u1EED l\xFD)"))),React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label mb-1"},"Search (t\xEAn / S\u0110T)"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-search"})),React.createElement("input",{type:"text",className:"form-control",value:_e,onChange:e=>ye(e.target.value),placeholder:"Nh\u1EADp t\xEAn ho\u1EB7c S\u0110T...","aria-label":"Search \u0111\u01A1n h\xE0ng theo t\xEAn ho\u1EB7c S\u0110T"}),String(_e||"").trim()&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>ye(""),title:"X\xF3a search","aria-label":"X\xF3a search",disabled:tt},React.createElement("i",{className:"fas fa-times"})),tt&&React.createElement("span",{className:"input-group-text",title:"\u0110ang search...","aria-label":"\u0110ang search"},React.createElement("span",{className:"spinner-border spinner-border-sm text-warning",role:"status","aria-hidden":"true"}))),React.createElement("div",{className:"text-muted small mt-1"},"Search s\u1EBD ra to\xE0n b\u1ED9 data, b\u1ECF qua filter")),React.createElement("div",{className:"col-12 col-md-2 d-flex gap-2 justify-content-md-end"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>Be?Ta(_e):Ft(),disabled:se||tt},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")))),React.createElement("div",{className:"card p-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},"Danh s\xE1ch \u0111\u01A1n h\xE0ng"),React.createElement("span",{className:"text-muted small"},Be?`${Zt.length} k\u1EBFt qu\u1EA3`:fe?`${Yt.length}/${G.length} \u0111\u01A1n`:`${G.length}${re?"+":""} \u0111\u01A1n`)),Be&&qe&&React.createElement("div",{className:"alert alert-danger mt-3 mb-0",role:"alert"},qe),Qt.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"C\xF3 ",React.createElement("strong",null,Qt.length)," \u0111\u01A1n ",React.createElement("strong",null,"Ch\u1EDD x\u1EED l\xFD")," qu\xE1 ",te," ng\xE0y.",He&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{g(!0),Ke("pending")}},"Xem ngay")),Ma.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-clock me-2"}),"C\xF3 ",React.createElement("strong",null,Ma.length)," \u0111\u01A1n ",React.createElement("strong",null,"Nh\xE1p")," s\u1EAFp t\u1EF1 x\xF3a (c\xF2n \u2264 ",Q," ng\xE0y).",Le&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{g(!1),Ke("draft"),B(""),Ft()}},"Xem ngay")),(Be?tt:se)?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):(Be?Zt.length===0:G.length===0)?React.createElement("div",{className:"text-center py-4 text-muted"},Be?"Kh\xF4ng c\xF3 k\u1EBFt qu\u1EA3":"Ch\u01B0a c\xF3 \u0111\u01A1n h\xE0ng"):!Be&&Yt.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},"Kh\xF4ng c\xF3 \u0111\u01A1n ph\xF9 h\u1EE3p"):React.createElement(React.Fragment,null,React.createElement("div",{className:"d-md-none mt-3"},Zt.map(e=>{var a;return React.createElement("div",{key:e.id,className:"card mb-2"},React.createElement("div",{className:"card-body p-3"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"flex-grow-1",style:{minWidth:0}},React.createElement("div",{className:"fw-semibold text-truncate"},e.customer_name),React.createElement("div",{className:"fw-bold font-monospace"},e.phone),Number((a=e==null?void 0:e.split_seq)!=null?a:0)>0&&React.createElement("div",{className:"text-muted small"},"\u0110\u1EE3t ",e.split_seq),e.address&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},e.address),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("div",{className:"d-flex align-items-start gap-1 flex-shrink-0"},React.createElement("span",{className:`badge ${pa(e.status)}`},ua(e.status)),Bt(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${te} ng\xE0y`},"\u26A0 Ch\u1EADm ",_t(e),"d"),Jt(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 x\xF3a sau ${ne} ng\xE0y`},"\u23F3 C\xF2n ",zt(e),"d"))),React.createElement("div",{className:"mt-2 small"},React.createElement("div",null,React.createElement("div",{className:"text-muted"},"S\u1EA3n ph\u1EA9m:"),(()=>{const t=xa(e);return t.length?React.createElement("div",{className:"mt-1"},t.map((n,l)=>React.createElement("div",{key:l,className:"d-flex justify-content-between gap-2",style:{lineHeight:1.25}},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,whiteSpace:"normal",wordBreak:"break-word",flex:1}},React.createElement("span",{className:"text-muted me-1"},l+1,"."),n.name),React.createElement("div",{className:"text-muted small text-end text-nowrap",style:{flexShrink:0}},"x",n.qty,Number(n.unitPrice)>0?` \u2022 ${E(n.unitPrice)}`:"")))):React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},aa(e))})()),(Sa(e)!==0||na(e))&&React.createElement("div",{style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh:")," ",React.createElement("span",{className:"fw-semibold"},E(Sa(e))),na(e)?React.createElement("span",{className:"text-muted"}," ","(",na(e),")"):null),React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng ti\u1EC1n"),React.createElement("span",{className:"fw-bold"},E(Aa(e)))),React.createElement("div",{className:"text-muted"},React.createElement("span",null,"Th\u1EDDi gian:")," ",ba(e.created_at))),React.createElement("div",{className:"mt-3 d-flex gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary flex-fill",onClick:()=>ga(e),disabled:m||!!i||v===e.id},"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary flex-fill",onClick:()=>Da(e),disabled:m||!!i||v===e.id},React.createElement("i",{className:"fas fa-copy me-1"}),"Copy"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger flex-fill",onClick:()=>Ea(e.id),disabled:m||i===e.id||v===e.id},i===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a")),React.createElement("div",{className:"mt-2 d-flex gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning flex-fill",onClick:()=>Rt(e,"processing"),disabled:m||!!i||v===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success flex-fill",onClick:()=>Rt(e,"done"),disabled:m||!!i||v===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary flex-fill",onClick:()=>Rt(e,"paid"),disabled:m||!!i||v===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger flex-fill",onClick:()=>Rt(e,"canceled"),disabled:m||!!i||v===e.id||e.status==="canceled",title:"H\u1EE7y \u0111\u01A1n"},"H\u1EE7y"))))})),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive orders-table-wrap mt-3"},React.createElement("table",{className:"table orders-table table-hover align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"SL"),React.createElement("th",null,"T\u1ED5ng ti\u1EC1n"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"),React.createElement("th",null,"Th\u1EDDi gian"),React.createElement("th",null))),React.createElement("tbody",null,Zt.map(e=>React.createElement("tr",{key:e.id},React.createElement("td",null,React.createElement("div",{className:"fw-semibold"},e.customer_name),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("td",null,e.phone),React.createElement("td",null,(()=>{const a=xa(e);return a.length?React.createElement("div",{className:"d-grid gap-1"},a.map((t,n)=>React.createElement("div",{key:n,className:"small",style:{whiteSpace:"normal",wordBreak:"break-word",lineHeight:1.2}},React.createElement("span",{className:"text-muted me-1"},n+1,"."),React.createElement("span",{className:"fw-semibold"},t.name)," ",React.createElement("span",{className:"text-muted"},"x",t.qty),Number(t.unitPrice)>0&&React.createElement("span",{className:"text-muted"}," ","\u2022 ",E(t.unitPrice))))):aa(e)})()),React.createElement("td",null,Ya(e)),React.createElement("td",{className:"fw-semibold"},E(Aa(e))),React.createElement("td",null,React.createElement("div",{className:"d-flex align-items-center gap-1 flex-wrap"},React.createElement("span",{className:`badge ${pa(e.status)}`},ua(e.status)),Bt(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${te} ng\xE0y`},"\u26A0 Ch\u1EADm ",_t(e),"d"),Jt(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 x\xF3a sau ${ne} ng\xE0y`},"\u23F3 C\xF2n ",zt(e),"d"))),React.createElement("td",null,ba(e.created_at)),React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-sm btn-primary me-1",onClick:()=>ga(e),disabled:m||!!i||v===e.id},"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary me-1",onClick:()=>Da(e),disabled:m||!!i||v===e.id},React.createElement("i",{className:"fas fa-copy"})),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning me-1",onClick:()=>Rt(e,"processing"),disabled:m||!!i||v===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success me-1",onClick:()=>Rt(e,"done"),disabled:m||!!i||v===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary me-1",onClick:()=>Rt(e,"paid"),disabled:m||!!i||v===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger me-1",onClick:()=>Rt(e,"canceled"),disabled:m||!!i||v===e.id||e.status==="canceled",title:"H\u1EE7y \u0111\u01A1n"},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>Ea(e.id),disabled:m||i===e.id},i===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a")))))))),!Be&&re&&!u&&React.createElement("div",{className:"d-flex justify-content-center mt-3"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:Ba,disabled:se||z},z?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2","aria-hidden":"true"}),"\u0110ang t\u1EA3i th\xEAm..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-angle-down me-2"}),"T\u1EA3i th\xEAm \u0111\u01A1n"))))),pe&&React.createElement("div",{className:"modal show d-block order-modal",style:{background:"rgba(0,0,0,0.6)"},role:"dialog","aria-modal":"true"},React.createElement("div",{className:"modal-dialog modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ffca2c)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark mb-0"},React.createElement("i",{className:"fas fa-receipt me-2"}),ie?"S\u1EEDa \u0111\u01A1n h\xE0ng":"T\u1EA1o \u0111\u01A1n h\xE0ng"),React.createElement("button",{type:"button",className:"btn-close",onClick:va})),React.createElement("form",{onSubmit:e=>{e.preventDefault(),Ka({mode:"close"})}},React.createElement("div",{className:"modal-body",ref:qt},React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"T\xEAn kh\xE1ch h\xE0ng *"),React.createElement("input",{className:"form-control",value:A.customer_name,onChange:e=>ze({...A,customer_name:e.target.value}),placeholder:"Nh\u1EADp t\xEAn kh\xE1ch h\xE0ng",required:!0,style:{borderRadius:10,padding:12}}),!!rt.nameError&&React.createElement("div",{className:"form-text text-danger"},rt.nameError)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i *"),React.createElement("input",{className:"form-control",type:"tel",inputMode:"numeric",pattern:"[0-9+\\s-]*",id:"order-phone-input",value:A.phone,onChange:e=>Ha(e.target.value),onBlur:Va,placeholder:"Nh\u1EADp s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",required:!0,style:{borderRadius:10,padding:12}}),!!rt.phoneError&&React.createElement("div",{className:"form-text text-danger"},rt.phoneError),!rt.phoneError&&Mt.count>0&&React.createElement("div",{className:"form-text text-warning d-flex align-items-center justify-content-between gap-2"},React.createElement("span",null,"Kh\xE1ch n\xE0y \u0111\xE3 c\xF3 ",Mt.count," \u0111\u01A1n trong th\xE1ng ",Mt.monthKey,"."),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>je(e=>!e)},Te?"\u1EA8n l\u1ECBch s\u1EED":"Xem l\u1ECBch s\u1EED")),Te&&Mt.orders.length>0&&React.createElement("div",{className:"mt-2 border rounded-3 p-2",style:{background:"#fff"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between gap-2 mb-2"},React.createElement("div",{className:"small fw-semibold"},"L\u1ECBch s\u1EED \u0111\u01A1n (c\xF9ng th\xE1ng)"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>je(!1)},"\u1EA8n")),React.createElement("div",{className:"d-grid gap-2"},Mt.orders.slice(0,5).map(e=>React.createElement("div",{key:e.id,className:"d-flex align-items-start justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"small fw-semibold",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},"#",e.id," \u2022 ",React.createElement("span",{className:`badge ${pa(e.status)}`},ua(e.status))),React.createElement("div",{className:"text-muted small"},ba(e.created_at)," \u2022 ",E(Aa(e))),React.createElement("div",{className:"text-muted small",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},aa(e))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{confirm(`M\u1EDF \u0111\u01A1n #${e.id}? D\u1EEF li\u1EC7u \u0111ang nh\u1EADp s\u1EBD m\u1EA5t.`)&&ga(e)}},"M\u1EDF")))),Mt.orders.length>5&&React.createElement("div",{className:"text-muted small mt-2"},"Ch\u1EC9 hi\u1EC3n th\u1ECB 5 \u0111\u01A1n g\u1EA7n nh\u1EA5t.")),(R==null?void 0:R.status)==="loading"&&React.createElement("div",{className:"form-text"},"\u0110ang t\xECm kh\xE1ch theo S\u0110T..."),(R==null?void 0:R.status)==="found"&&React.createElement("div",{className:"form-text text-success"},"\u0110\xE3 c\xF3 kh\xE1ch, t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n th\xF4ng tin."),(R==null?void 0:R.status)==="not-found"&&React.createElement("div",{className:"form-text text-muted"},"Ch\u01B0a c\xF3 kh\xE1ch, s\u1EBD t\u1EA1o m\u1EDBi khi l\u01B0u \u0111\u01A1n."),(R==null?void 0:R.status)==="error"&&React.createElement("div",{className:"form-text text-danger"},"Kh\xF4ng tra \u0111\u01B0\u1EE3c kh\xE1ch (l\u1ED7i m\u1EA1ng/server).")),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("select",{className:"form-select",value:A.status,onChange:e=>ze({...A,status:e.target.value}),style:{borderRadius:10,padding:12}},React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n"))),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("input",{className:"form-control",value:A.address,onChange:e=>ze({...A,address:e.target.value}),placeholder:"Nh\u1EADp \u0111\u1ECBa ch\u1EC9 (kh\xF4ng b\u1EAFt bu\u1ED9c)",style:{borderRadius:10,padding:12}}),!!rt.addressWarn&&React.createElement("div",{className:"form-text text-warning"},rt.addressWarn)),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111\u01A1n h\xE0ng"),React.createElement("textarea",{className:"form-control",value:A.note,onChange:e=>ze({...A,note:e.target.value}),placeholder:"V\xED d\u1EE5: Giao gi\u1EDD h\xE0nh ch\xEDnh / G\u1ECDi tr\u01B0\u1EDBc khi giao...",rows:2,style:{borderRadius:10,padding:12,resize:"vertical"}})),React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110i\u1EC1u ch\u1EC9nh gi\xE1 (th\xEAm/b\u1EDBt)"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{ze(e=>({...e,adjustment_items:[...Array.isArray(e.adjustment_items)?e.adjustment_items:[{amount:"",note:""}],{amount:"",note:""}]}))}},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm \u0111i\u1EC1u ch\u1EC9nh")),React.createElement("div",{className:"d-grid gap-2"},oe(A.adjustment_items).map((e,a)=>React.createElement("div",{key:a,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label small text-muted mb-1"},"S\u1ED1 ti\u1EC1n"),React.createElement("input",{type:"text",inputMode:"numeric",className:"form-control",value:e.amount,onChange:t=>{const n=t.target.value;ze(l=>{const o=oe(l.adjustment_items);return o[a]={...o[a],amount:n},{...l,adjustment_items:o}})},placeholder:"+500000 ho\u1EB7c -200000",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("label",{className:"form-label small text-muted mb-1"},"Ghi ch\xFA"),React.createElement("input",{className:"form-control",value:e.note,onChange:t=>{const n=t.target.value;ze(l=>{const o=oe(l.adjustment_items);return o[a]={...o[a],note:n},{...l,adjustment_items:o}})},placeholder:"V\xED d\u1EE5: th\xEAm van 1 tay / gi\u1EA3m gi\xE1...",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-1 d-flex"},React.createElement("button",{type:"button",className:"btn btn-outline-danger w-100",onClick:()=>{ze(t=>{const n=oe(t.adjustment_items);return n.splice(a,1),{...t,adjustment_items:n.length?n:[{amount:"",note:""}]}})},disabled:m||oe(A.adjustment_items).length<=1,title:"X\xF3a \u0111i\u1EC1u ch\u1EC9nh",style:{borderRadius:10,padding:12}},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement("div",{className:"form-text"},"\xC2m = gi\u1EA3m gi\xE1, d\u01B0\u01A1ng = c\u1ED9ng th\xEAm."),!!rt.adjustmentAbnormalWarn&&React.createElement("div",{className:"form-text text-warning"},rt.adjustmentAbnormalWarn),!!rt.adjustmentNoteWarn&&React.createElement("div",{className:"form-text text-warning"},rt.adjustmentNoteWarn)),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1EA3n ph\u1EA9m *"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{ze(e=>({...e,items:[...Array.isArray(e.items)?e.items:[],{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]})),lt(e=>[...Array.isArray(e)?e:[],""]),ie&&Je(e=>[...Array.isArray(e)?e:[],!0])},disabled:m},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(A.items)?A.items:[{product_id:"",quantity:1}]).map((e,a)=>React.createElement("div",{key:a,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"dropdown w-100",ref:t=>{ft.current[a]=t}},React.createElement("button",{type:"button",className:"form-control text-start d-flex align-items-center justify-content-between",style:{borderRadius:10,padding:12},onClick:()=>{Ze(t=>t===a?null:a),setTimeout(()=>{const t=document.getElementById(`order-product-search-${a}`);t&&t.focus()},0)}},React.createElement("span",{className:e.product_id?"":"text-muted",style:{minWidth:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},Ja(e.product_id)),React.createElement("i",{className:"fas fa-chevron-down text-muted",style:{marginLeft:8,flexShrink:0}})),ct===a&&React.createElement("div",{className:"dropdown-menu show w-100 p-2",style:{maxHeight:320,overflowY:"auto"}},React.createElement("input",{id:`order-product-search-${a}`,className:"form-control",value:ae[a]||"",onChange:t=>{const n=t.target.value;lt(l=>{const o=Array.isArray(l)?[...l]:[];return o[a]=n,o})},placeholder:"T\xECm theo t\xEAn / m\xE3...",style:{borderRadius:10,padding:10}}),React.createElement("div",{className:"mt-2"}),(()=>{const t=Qa(a);return t.length===0?React.createElement("div",{className:"text-muted small px-2 py-1"},"Kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p"):t.map(n=>React.createElement("button",{key:n.id,type:"button",className:"dropdown-item",onClick:()=>{const l=String(n.id),o=Ut(n==null?void 0:n.variants),y={};for(const r of o){const d=String((r==null?void 0:r.name)||"").trim(),f=Array.isArray(r==null?void 0:r.options)?r.options[0]:null,D=String((f==null?void 0:f.label)||"").trim();d&&D&&(y[d]=D)}const c=Ia(y),S=ta(n,y);ze(r=>{const d=Array.isArray(r.items)?[...r.items]:[];return d[a]={...d[a]||{quantity:1},product_id:l,variant_json:Object.keys(y).length?y:null,variant:c,unit_price:o.length?S:null},{...r,items:d}}),Ze(null)}},n.name,n.code?` (${n.code})`:""))})()),React.createElement("select",{className:"form-select",value:e.product_id,onChange:()=>{},required:!0,style:{position:"absolute",opacity:0,height:0,pointerEvents:"none"},tabIndex:-1,"aria-hidden":"true"},React.createElement("option",{value:""},"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"),h.map(t=>React.createElement("option",{key:t.id,value:t.id},t.name)))),(()=>{var n;const t=(n=rt.items)==null?void 0:n[a];return t?React.createElement(React.Fragment,null,!!t.productError&&React.createElement("div",{className:"form-text text-danger"},t.productError),!!t.dupWarn&&React.createElement("div",{className:"form-text text-warning"},t.dupWarn)):null})(),(()=>{if(!(e!=null&&e.product_id))return null;const t=Ct(e.product_id),n=Ut(t==null?void 0:t.variants);if(!n.length)return null;const l=e!=null&&e.variant_json&&typeof e.variant_json=="object"?e.variant_json:{};return React.createElement("div",{className:"mt-2 d-grid gap-2"},n.map((o,y)=>{const c=String((o==null?void 0:o.name)||`Bi\u1EBFn th\u1EC3 ${y+1}`).trim(),S=String((l==null?void 0:l[c])||"").trim();return React.createElement("div",{key:c},React.createElement("label",{className:"form-label small text-muted mb-1"},c),React.createElement("select",{className:"form-select",value:S,onChange:r=>{const d=String(r.target.value||"").trim();ze(f=>{const D=Array.isArray(f.items)?[...f.items]:[],Z={...D[a]||{}},V=Ct(Z.product_id),Se=Ut(V==null?void 0:V.variants),ke=Z!=null&&Z.variant_json&&typeof Z.variant_json=="object"?{...Z.variant_json}:{};d?ke[c]=d:delete ke[c];const nt=Ia(ke),it=ta(V,ke);return D[a]={...Z,variant_json:Object.keys(ke).length?ke:null,variant:nt,unit_price:it},{...f,items:D}})},style:{borderRadius:10,padding:12}},React.createElement("option",{value:""},"-- ch\u1ECDn ",c," --"),(Array.isArray(o==null?void 0:o.options)?o.options:[]).map(r=>React.createElement("option",{key:r.label,value:r.label},r.label,Number.isFinite(Number(r==null?void 0:r.price))?` (${E(Number(r.price))})`:Number(r==null?void 0:r.price_delta)?` (${r.price_delta>0?"+":""}${r.price_delta})`:""))))}))})(),ie&&React.createElement("div",{className:"form-check mt-1"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:`order-split-deliver-${a}`,checked:!!ge[a],onChange:t=>{const n=!!t.target.checked;Je(l=>{const o=Array.isArray(l)?[...l]:[],y=Array.isArray(A.items)?A.items.length:0;for(;o.length<y;)o.push(!0);return o[a]=n,o})},disabled:m||K}),React.createElement("label",{className:"form-check-label small text-muted",htmlFor:`order-split-deliver-${a}`},"Giao \u0111\u1EE3t 1"))),React.createElement("div",{className:"col-8 col-md-3"},React.createElement("input",{type:"number",className:"form-control",value:e.quantity,onChange:t=>{const n=t.target.value;ze(l=>{const o=Array.isArray(l.items)?[...l.items]:[];return o[a]={...o[a]||{product_id:""},quantity:n},{...l,items:o}})},min:"1",style:{borderRadius:10,padding:12}}),(()=>{var n;const t=(n=rt.items)==null?void 0:n[a];return t&&t.qtyError?React.createElement("div",{className:"form-text text-danger"},t.qtyError):null})()),React.createElement("div",{className:"col-4 col-md-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>{ze(t=>{const n=Array.isArray(t.items)?[...t.items]:[];return n.splice(a,1),{...t,items:n.length?n:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]}}),lt(t=>{const n=Array.isArray(t)?[...t]:[];return n.splice(a,1),n.length?n:[""]}),Je(t=>{const n=Array.isArray(t)?[...t]:[];return n.splice(a,1),n}),Ze(t=>t==null?t:t===a?null:t>a?t-1:t)},disabled:m||K||(Array.isArray(A.items)?A.items.length:1)<=1,title:"X\xF3a s\u1EA3n ph\u1EA9m",style:{borderRadius:10,padding:10}},React.createElement("i",{className:"fas fa-trash"}))))))),(()=>{const a=(Array.isArray(A.items)?A.items:[]).filter(c=>c==null?void 0:c.product_id),t=ia(a),n=sa(a),l=Me(A),o=l.amount,y=t+(n.found?n.fee:0)+o;return React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-column gap-1 small bg-light rounded-3 p-3"},React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1EA1m t\xEDnh"),React.createElement("span",{className:"fw-semibold"},E(t))),n.found&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"Ship"),React.createElement("span",{className:"fw-semibold"},E(n.fee))),!!rt.shipAbnormalWarn&&React.createElement("div",{className:"text-warning"},rt.shipAbnormalWarn),o!==0&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh"),React.createElement("span",{className:"fw-semibold"},E(o))),(A.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111\u01A1n: ",(A.note||"").trim()),!!l.summaryText&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh: ",l.summaryText),React.createElement("div",{className:"d-flex justify-content-between pt-1 border-top"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng"),React.createElement("span",{className:"fw-bold"},E(y)))))})())),React.createElement("div",{className:"modal-footer",style:{border:"none"}},React.createElement("button",{type:"button",className:"btn btn-light",onClick:va,disabled:m||K,style:{borderRadius:10}},"H\u1EE7y"),!!ie&&React.createElement("button",{type:"button",className:"btn btn-outline-primary fw-semibold",onClick:za,disabled:m||K,style:{borderRadius:10},title:"Ch\u1ECDn s\u1EA3n ph\u1EA9m giao \u0111\u1EE3t 1 v\xE0 t\xE1ch ph\u1EA7n c\xF2n l\u1EA1i sang \u0111\u01A1n ch\u1EDD h\xE0ng"},K?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang t\xE1ch..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-random me-2"}),"T\xE1ch \u0111\u01A1n giao ngay")),!ie&&React.createElement("button",{type:"button",className:"btn btn-outline-warning fw-semibold",onClick:()=>Ka({mode:"new"}),disabled:m||!rt.canSubmit,style:{borderRadius:10},title:"L\u01B0u xong gi\u1EEF form \u0111\u1EC3 t\u1EA1o \u0111\u01A1n m\u1EDBi"},React.createElement("i",{className:"fas fa-plus me-2"}),"L\u01B0u & t\u1EA1o \u0111\u01A1n m\u1EDBi"),React.createElement("button",{type:"submit",className:"btn btn-warning fw-semibold",disabled:m||K||!rt.canSubmit,style:{borderRadius:10,boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},m?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u"))))))))}

