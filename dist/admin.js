const{useState,useEffect,useRef}=React,CLOUDINARY_CLOUD_NAME="diwxfpt92",CLOUDINARY_UPLOAD_PRESET="ktm_unsigned",API_BASE="";function LoginPage({onLogin:x,error:u}){const[N,A]=useState(""),[I,d]=useState(""),[w,f]=useState(!1),[H,p]=useState(!1);return React.createElement("div",{className:"login-page"},React.createElement("div",{className:"login-box"},React.createElement("div",{className:"text-center mb-4"},React.createElement("i",{className:"fas fa-tractor fa-3x text-warning mb-3"}),React.createElement("h4",{className:"text-dark"},"KTM Admin"),React.createElement("p",{className:"text-muted small"},"\u0110\u0103ng nh\u1EADp \u0111\u1EC3 qu\u1EA3n l\xFD")),u&&React.createElement("div",{className:"alert alert-danger py-2 small"},React.createElement("i",{className:"fas fa-exclamation-circle me-2"}),u),React.createElement("form",{onSubmit:async z=>{z.preventDefault(),f(!0),await x(N,I),f(!1)}},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small"},"T\xEAn \u0111\u0103ng nh\u1EADp"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-user"})),React.createElement("input",{type:"text",className:"form-control",value:N,onChange:z=>A(z.target.value),placeholder:"admin",required:!0,autoFocus:!0}))),React.createElement("div",{className:"mb-4"},React.createElement("label",{className:"form-label small"},"M\u1EADt kh\u1EA9u"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-lock"})),React.createElement("input",{type:H?"text":"password",className:"form-control",value:I,onChange:z=>d(z.target.value),placeholder:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",required:!0}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>p(!H)},React.createElement("i",{className:`fas fa-eye${H?"-slash":""}`})))),React.createElement("button",{type:"submit",className:"btn btn-warning w-100",disabled:w},w?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang \u0111\u0103ng nh\u1EADp..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-sign-in-alt me-2"}),"\u0110\u0103ng nh\u1EADp"))),React.createElement("div",{className:"text-center mt-4"},React.createElement("a",{href:"/",className:"text-muted small text-decoration-none"},React.createElement("i",{className:"fas fa-arrow-left me-1"}),"V\u1EC1 trang ch\u1EE7"))))}function Toast({message:x,type:u,onClose:N}){return useEffect(()=>{const A=setTimeout(N,3e3);return()=>clearTimeout(A)},[]),React.createElement("div",{className:`toast show align-items-center text-white bg-${u} border-0`,role:"alert"},React.createElement("div",{className:"d-flex"},React.createElement("div",{className:"toast-body"},x),React.createElement("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto",onClick:N})))}function Loading({show:x}){return x?React.createElement("div",{className:"loading-overlay"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"3rem",height:"3rem"}},React.createElement("span",{className:"visually-hidden"},"\u0110ang t\u1EA3i..."))):null}function Sidebar({activeMenu:x,onMenuChange:u,onLogout:N,currentUser:A}){return React.createElement("div",{className:"sidebar d-none d-md-block"},React.createElement("div",{className:"logo"},React.createElement("i",{className:"fas fa-tractor me-2"})," KTM Admin"),React.createElement("nav",{className:"nav flex-column mt-3"},[{id:"search",icon:"fa-search",label:"Tra c\u1EE9u nhanh",highlight:!0},{id:"albums",icon:"fa-images",label:"Qu\u1EA3n l\xFD Album"},{id:"videos",icon:"fa-video",label:"Qu\u1EA3n l\xFD Video"},{id:"products",icon:"fa-box",label:"S\u1EA3n ph\u1EA9m"},{id:"orders",icon:"fa-receipt",label:"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"},{id:"stats",icon:"fa-chart-column",label:"Th\u1ED1ng k\xEA"},{id:"settings",icon:"fa-cog",label:"C\xE0i \u0111\u1EB7t",disabled:!0}].map(d=>React.createElement("a",{key:d.id,href:"#",className:`nav-link ${x===d.id?"active":""} ${d.disabled?"opacity-50":""} ${d.highlight?"text-warning":""}`,onClick:w=>{w.preventDefault(),d.disabled||u(d.id)}},React.createElement("i",{className:`fas ${d.icon}`})," ",d.label,d.disabled&&React.createElement("span",{className:"badge bg-secondary ms-2"},"Soon"),d.highlight&&React.createElement("span",{className:"badge bg-warning text-dark ms-2"},"HOT")))),React.createElement("div",{className:"position-absolute bottom-0 w-100 p-3 border-top border-secondary"},React.createElement("div",{className:"d-flex justify-content-between align-items-center"},React.createElement("a",{href:"/",className:"text-white-50 text-decoration-none small"},React.createElement("i",{className:"fas fa-home me-1"})," Trang ch\u1EE7"),N&&React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:N,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"})))))}function AlbumList({albums:x,onSelect:u,onCreate:N,onEdit:A,onDelete:I,loading:d,currentFolder:w,onBack:f,breadcrumb:H}){return React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},w&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:f},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),w?w.title:"Th\u01B0 vi\u1EC7n \u1EA3nh")),React.createElement("button",{className:"btn btn-warning",onClick:N},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder")),H&&H.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:p=>{p.preventDefault(),f("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),H.map((p,Q)=>React.createElement("li",{key:p.id,className:`breadcrumb-item ${Q===H.length-1?"active":""}`},Q===H.length-1?p.title:React.createElement("a",{href:"#",onClick:z=>{z.preventDefault(),f(p)},className:"text-warning"},p.title))))),d?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):x.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},w?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder n\xE0o. H\xE3y t\u1EA1o folder \u0111\u1EA7u ti\xEAn!")):React.createElement("div",{className:"row g-3"},x.map(p=>React.createElement("div",{key:p.uuid||p.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card album-card h-100",onClick:()=>u(p)},p.cover?React.createElement("img",{src:p.cover,className:"album-cover",alt:p.title}):React.createElement("div",{className:"card-body text-center py-4"},React.createElement("i",{className:"fas fa-folder fa-3x text-warning mb-2"})),React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"card-title mb-1"},p.title),React.createElement("small",{className:"text-muted"},p.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),p.subfolderCount),p.subfolderCount>0&&p.count>0&&" \u2022 ",p.count>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-image me-1"}),p.count),p.subfolderCount===0&&p.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-2",onClick:Q=>{Q.stopPropagation(),A(p)},title:"S\u1EEDa album"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:Q=>{Q.stopPropagation(),I(p)},title:"X\xF3a album"},React.createElement("i",{className:"fas fa-trash"}))))))))}function AlbumModal({show:x,album:u,onClose:N,onSave:A,parentId:I}){const[d,w]=useState({slug:"",title:"",description:"",cover_url:"",parent_id:null}),[f,H]=useState(!1),[p,Q]=useState(!1),z=useRef(null);useEffect(()=>{w(u?{slug:u.id||"",title:u.title||"",description:u.description||"",cover_url:u.cover||"",parent_id:u.parentId||null}:{slug:"",title:"",description:"",cover_url:"",parent_id:I||null})},[u,x,I]);const j=async F=>{F.preventDefault(),H(!0),await A(d),H(!1)},D=F=>F.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),te=async F=>{const se=F.type==="image/heic"||F.type==="image/heif"||/\.heic$/i.test(F.name);if(F.size<=2097152&&!se)return F;try{const Y=await createImageBitmap(F),ne=document.createElement("canvas");let v=Y.width,B=Y.height;const me=800;return(v>me||B>me)&&(v>B?(B=Math.round(B/v*me),v=me):(v=Math.round(v/B*me),B=me)),ne.width=v,ne.height=B,ne.getContext("2d").drawImage(Y,0,0,v,B),Y.close(),new Promise((c,W)=>{ne.toBlob(he=>{he?c(new File([he],F.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):W(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(Y){throw console.error("Compress cover error:",Y),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},oe=async F=>{var Y;const Z=F.target.files[0];if(!Z)return;if(!(Z.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(Z.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}Q(!0);try{const ne=await te(Z),v=await window.KTM.cloudinary.uploadImage({file:ne,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-albums/covers"});if(!v.secure_url)throw console.error("Cloudinary error:",v),new Error(((Y=v.error)==null?void 0:Y.message)||"Upload failed");w(B=>({...B,cover_url:v.secure_url}))}catch(ne){console.error("Cover upload error:",ne),alert("L\u1ED7i upload \u1EA3nh b\xECa: "+ne.message)}Q(!1),F.target.value=""};return x?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},u?"S\u1EEDa":"T\u1EA1o"," Folder"),React.createElement("button",{type:"button",className:"btn-close",onClick:N})),React.createElement("form",{onSubmit:j},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:d.title,onChange:F=>w({...d,title:F.target.value,slug:d.slug||D(F.target.value)}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Slug (URL) *"),React.createElement("input",{type:"text",className:"form-control",value:d.slug,onChange:F=>w({...d,slug:F.target.value}),required:!0,disabled:!!u}),React.createElement("small",{className:"text-muted"},"VD: may-cay-kubota-l1501")),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:d.description,onChange:F=>w({...d,description:F.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex gap-2 align-items-start"},d.cover_url&&React.createElement("div",{className:"position-relative",style:{width:80,height:80}},React.createElement("img",{src:d.cover_url,alt:"Cover",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:8}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute",style:{top:-8,right:-8,padding:"2px 6px",fontSize:10},onClick:()=>w(F=>({...F,cover_url:""}))},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{ref:z,type:"file",accept:"image/*",className:"d-none",onChange:oe}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100 mb-2",onClick:()=>{var F;return(F=z.current)==null?void 0:F.click()},disabled:p},p?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh b\xECa")),React.createElement("input",{type:"url",className:"form-control form-control-sm",value:d.cover_url,onChange:F=>w({...d,cover_url:F.target.value}),placeholder:"Ho\u1EB7c d\xE1n URL \u1EA3nh..."}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:N},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:f||p},f?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function FolderTreeItem({folder:x,allAlbums:u,currentAlbumId:N,targetAlbum:A,onSelect:I,level:d=0}){const[w,f]=useState(!0),H=x.uuid||x.id,p=H===N,Q=A===H,z=u.filter(D=>D.parentId===H),j=z.length>0;return React.createElement("div",{style:{marginLeft:d*16+"px"}},React.createElement("div",{className:`d-flex align-items-center p-2 rounded mb-1 ${Q?"bg-info text-white":p?"bg-light text-muted":"hover-bg"}`,style:{cursor:p?"not-allowed":"pointer",opacity:p?.5:1,transition:"background 0.2s"},onClick:()=>!p&&I(H)},j&&React.createElement("i",{className:`fas fa-chevron-${w?"down":"right"} me-2`,style:{fontSize:"10px",width:"12px",cursor:"pointer"},onClick:D=>{D.stopPropagation(),f(!w)}}),!j&&React.createElement("span",{style:{width:"20px"}}),React.createElement("i",{className:`fas fa-folder${Q?"-open":""} me-2 ${Q?"":"text-warning"}`}),React.createElement("span",{className:"small"},x.title),p&&React.createElement("span",{className:"ms-2 badge bg-secondary",style:{fontSize:"9px"}},"Hi\u1EC7n t\u1EA1i"),x.count>0&&!p&&React.createElement("span",{className:"ms-auto badge bg-light text-muted",style:{fontSize:"10px"}},x.count)),w&&j&&React.createElement("div",null,z.map(D=>React.createElement(FolderTreeItem,{key:D.uuid||D.id,folder:D,allAlbums:u,currentAlbumId:N,targetAlbum:A,onSelect:I,level:d+1}))))}function AlbumDetail({album:x,onBack:u,onRefresh:N,showToast:A,onNavigateToFolder:I,onEditSubfolder:d,parentAlbum:w}){const[f,H]=useState([]),[p,Q]=useState([]),[z,j]=useState(!0),[D,te]=useState(!1),[oe,F]=useState(""),[Z,se]=useState([]),[Y,ne]=useState([]),[v,B]=useState({}),[me,C]=useState(null),[c,W]=useState(!1),[he,Se]=useState(""),[be,ce]=useState(!1),Ne=useRef(null),ae=useRef(null),[we,ie]=useState(!1),[re,Me]=useState([]),[_e,Ce]=useState([]),[$e,Pe]=useState(""),[a,i]=useState(!1),O=async(o,T=2)=>{const le=T*1024*1024,Te=o.type==="image/heic"||o.type==="image/heif"||/\.heic$/i.test(o.name);if(o.size<=le&&!Te)return o;try{const ke=await createImageBitmap(o),Ie=document.createElement("canvas");let Ke=ke.width,Oe=ke.height;const ze=1200;return(Ke>ze||Oe>ze)&&(Ke>Oe?(Oe=Math.round(Oe/Ke*ze),Ke=ze):(Ke=Math.round(Ke/Oe*ze),Oe=ze)),Ie.width=Ke,Ie.height=Oe,Ie.getContext("2d").drawImage(ke,0,0,Ke,Oe),ke.close(),new Promise((st,Xe)=>{Ie.toBlob(X=>{X?st(new File([X],o.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):Xe(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(ke){throw console.error("Compress error:",ke),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh")}};useEffect(()=>{fe(),Ae()},[x.id,x.uuid]);const fe=async()=>{j(!0);try{const o=await window.KTM.api.getJSON(`${API_BASE}/api/albums/${x.uuid||x.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");H(o.images||[]);const T=await window.KTM.api.getJSON(`${API_BASE}/api/albums?parent_id=${x.uuid||x.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");Q(Array.isArray(T)?T:[])}catch(o){console.error(o),A("L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u","danger")}j(!1)},Ae=async()=>{try{const o=await window.KTM.api.getJSON(`${API_BASE}/api/albums`,"L\u1ED7i t\u1EA3i album");Ce(Array.isArray(o)?o:[])}catch(o){console.error("Error loading albums:",o)}},Qe=o=>{Me(T=>T.includes(o)?T.filter(le=>le!==o):[...T,o])},Le=async()=>{if(!$e||re.length===0){A("Vui l\xF2ng ch\u1ECDn folder \u0111\xEDch","warning");return}i(!0);let o=0;for(const T of re)try{await window.KTM.api.putJSON(`${API_BASE}/api/images/${T}`,{album_id:$e},"L\u1ED7i di chuy\u1EC3n \u1EA3nh"),o++}catch(le){console.error("Move error:",le)}i(!1),ie(!1),Me([]),Pe(""),o>0?(A("\u0110\xE3 di chuy\u1EC3n \u1EA3nh th\xE0nh c\xF4ng!","success"),fe(),N()):A("Di chuy\u1EC3n th\u1EA5t b\u1EA1i","danger")},[Fe,Ze]=useState(!1),U=async()=>{if(re.length===0||!confirm(`X\xF3a ${re.length} \u1EA3nh \u0111\xE3 ch\u1ECDn? H\xE0nh \u0111\u1ED9ng n\xE0y kh\xF4ng th\u1EC3 ho\xE0n t\xE1c!`))return;Ze(!0);let o=0;for(const T of re)try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${T}`,"L\u1ED7i x\xF3a \u1EA3nh"),o++}catch(le){console.error("Delete error:",le)}Ze(!1),Me([]),o>0?(A(`\u0110\xE3 x\xF3a ${o} \u1EA3nh!`,"success"),fe(),N()):A("X\xF3a th\u1EA5t b\u1EA1i","danger")},xe=()=>{re.length===f.length?Me([]):Me(f.map(o=>o.id))},qe=async()=>{if(he.trim()){ce(!0);try{const o=he.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");await window.KTM.api.postJSON(`${API_BASE}/api/albums`,{slug:o+"-"+Date.now(),title:he,parent_id:x.uuid||x.id},"L\u1ED7i t\u1EA1o folder"),A("T\u1EA1o folder th\xE0nh c\xF4ng!","success"),Se(""),W(!1),fe(),N()}catch(o){A(o.message,"danger")}ce(!1)}},J=async o=>{if(confirm(`X\xF3a folder "${o.title}"? T\u1EA5t c\u1EA3 n\u1ED9i dung b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${o.uuid||o.id}`,"L\u1ED7i x\xF3a folder"),A("\u0110\xE3 x\xF3a folder","success"),fe(),N()}catch(T){A("L\u1ED7i x\xF3a folder","danger")}},_=o=>{const T=Array.from(o).filter(le=>le.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(le.name));se(le=>[...le,...T]),T.forEach(le=>{const Te=new FileReader;Te.onload=ke=>{ne(Ie=>[...Ie,{file:le,preview:ke.target.result}])},Te.readAsDataURL(le)})},Ue=o=>{se(T=>T.filter((le,Te)=>Te!==o)),ne(T=>T.filter((le,Te)=>Te!==o))},ue=async o=>{var le;const T=await window.KTM.cloudinary.uploadImage({file:o,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:`ktm-albums/${x.id}`});if(!T.secure_url)throw console.error("Cloudinary error:",T),new Error(((le=T.error)==null?void 0:le.message)||"Upload failed");return T},et=async()=>{if(Z.length===0)return;te(!0);let o=0;for(let T=0;T<Z.length;T++)try{F(`\u0110ang x\u1EED l\xFD ${T+1}/${Z.length}...`);const le=await O(Z[T],2);F(`\u0110ang upload ${T+1}/${Z.length}...`);const Te=await ue(le);await window.KTM.api.postJSON(`${API_BASE}/api/albums/${x.id}`,{url:Te.secure_url,caption:v[T]||Z[T].name.replace(/\.[^/.]+$/,""),sort_order:f.length+T},"L\u1ED7i l\u01B0u \u1EA3nh"),o++}catch(le){console.error("Upload error:",le)}te(!1),F(""),se([]),ne([]),B({}),o>0?(A(`\u0110\xE3 upload ${o} \u1EA3nh th\xE0nh c\xF4ng!`,"success"),fe(),N()):A("Upload th\u1EA5t b\u1EA1i","danger")},it=async(o,T)=>{if(confirm("X\xF3a \u1EA3nh n\xE0y?"))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${o}`,"L\u1ED7i x\xF3a \u1EA3nh"),A("\u0110\xE3 x\xF3a \u1EA3nh","success"),fe(),N()}catch(le){A("L\u1ED7i x\xF3a \u1EA3nh","danger")}},Je=o=>{var T;o.preventDefault(),(T=ae.current)==null||T.classList.add("dragover")},De=()=>{var o;(o=ae.current)==null||o.classList.remove("dragover")},tt=o=>{var T;o.preventDefault(),(T=ae.current)==null||T.classList.remove("dragover"),_(o.dataTransfer.files)};return React.createElement("div",null,React.createElement("div",{className:"d-flex align-items-center justify-content-between mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:u},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("h4",{className:"m-0"},x.title),React.createElement("small",{className:"text-muted"},p.length>0&&React.createElement("span",null,p.length," folder \u2022 "),f.length," \u1EA3nh"))),React.createElement("button",{className:"btn btn-outline-warning btn-sm",onClick:()=>W(!0)},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder con")),c&&React.createElement("div",{className:"card mb-4 border-warning"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder-plus me-2 text-warning"}),"T\u1EA1o folder con"),React.createElement("div",{className:"d-flex gap-2"},React.createElement("input",{type:"text",className:"form-control",placeholder:"T\xEAn folder...",value:he,onChange:o=>Se(o.target.value),onKeyPress:o=>o.key==="Enter"&&qe(),autoFocus:!0}),React.createElement("button",{className:"btn btn-warning",onClick:qe,disabled:be||!he.trim()},be?React.createElement("span",{className:"spinner-border spinner-border-sm"}):"T\u1EA1o"),React.createElement("button",{className:"btn btn-secondary",onClick:()=>{W(!1),Se("")}},"H\u1EE7y")))),p.length>0&&React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),"Folder con"),React.createElement("div",{className:"row g-2"},p.map(o=>React.createElement("div",{key:o.uuid||o.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-item",style:{cursor:"pointer"},onClick:()=>I&&I(o)},React.createElement("div",{className:"card-body text-center py-3"},React.createElement("i",{className:"fas fa-folder fa-2x text-warning mb-2"}),React.createElement("div",{className:"small fw-bold text-truncate"},o.title),React.createElement("small",{className:"text-muted"},o.subfolderCount>0&&React.createElement("span",null,o.subfolderCount," folder"),o.subfolderCount>0&&o.count>0&&" \u2022 ",o.count>0&&React.createElement("span",null,o.count," \u1EA3nh"),o.subfolderCount===0&&o.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0 text-center"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-1",onClick:T=>{T.stopPropagation(),d&&d(o)},title:"S\u1EEDa folder"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:T=>{T.stopPropagation(),J(o)},title:"X\xF3a folder"},React.createElement("i",{className:"fas fa-trash"}))))))))),React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-cloud-upload-alt me-2"}),"Upload \u1EA3nh m\u1EDBi"),React.createElement("div",{ref:ae,className:"upload-zone",onClick:()=>{var o;return(o=Ne.current)==null?void 0:o.click()},onDragOver:Je,onDragLeave:De,onDrop:tt},React.createElement("i",{className:"fas fa-images fa-2x text-muted mb-2"}),React.createElement("p",{className:"mb-0"},"K\xE9o th\u1EA3 \u1EA3nh v\xE0o \u0111\xE2y ho\u1EB7c click \u0111\u1EC3 ch\u1ECDn"),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3 JPG, PNG, WebP"),React.createElement("input",{ref:Ne,type:"file",multiple:!0,accept:"image/*",onChange:o=>_(o.target.files)})),Y.length>0&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"upload-preview"},Y.map((o,T)=>React.createElement("div",{key:T,className:"upload-preview-item"},React.createElement("img",{src:o.preview,alt:""}),React.createElement("button",{className:"remove",onClick:()=>Ue(T)},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("div",{className:"mt-3"},React.createElement("button",{className:"btn btn-warning",onClick:et,disabled:D},D?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),oe||"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload ",Z.length," \u1EA3nh")))))),React.createElement("div",{className:"card"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("h6",{className:"m-0"},React.createElement("i",{className:"fas fa-th me-2"}),"\u1EA2nh (",f.length,")"),f.length>0&&React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:xe},re.length===f.length?"B\u1ECF ch\u1ECDn":"Ch\u1ECDn t\u1EA5t c\u1EA3")),re.length>0&&React.createElement("div",{className:"d-flex align-items-center gap-2 flex-wrap"},React.createElement("span",{className:"badge bg-primary"},re.length," \u0111\xE3 ch\u1ECDn"),React.createElement("button",{className:"btn btn-sm btn-info",onClick:()=>ie(!0)},React.createElement("i",{className:"fas fa-folder-open me-1"}),"Di chuy\u1EC3n"),React.createElement("button",{className:"btn btn-sm btn-danger",onClick:U,disabled:Fe},Fe?React.createElement("span",{className:"spinner-border spinner-border-sm"}):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-trash me-1"}),"X\xF3a")),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>Me([])},React.createElement("i",{className:"fas fa-times"})))),z?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):f.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},React.createElement("i",{className:"fas fa-image fa-2x mb-2"}),React.createElement("p",null,"Ch\u01B0a c\xF3 \u1EA3nh n\xE0o trong album n\xE0y")):React.createElement("div",{className:"image-grid"},f.map((o,T)=>React.createElement("div",{key:T,className:`image-item ${re.includes(o.id)?"selected":""}`,style:{position:"relative",cursor:"pointer"},onClick:()=>Qe(o.id)},React.createElement("div",{className:"select-checkbox",style:{position:"absolute",top:"6px",left:"6px",zIndex:10,width:"24px",height:"24px",borderRadius:"4px",background:re.includes(o.id)?"#0d6efd":"rgba(255,255,255,0.9)",border:re.includes(o.id)?"none":"2px solid #ccc",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"}},re.includes(o.id)&&React.createElement("i",{className:"fas fa-check",style:{color:"#fff",fontSize:"12px"}})),React.createElement("img",{src:o.src,alt:o.caption,style:{opacity:re.includes(o.id)?.7:1,border:re.includes(o.id)?"3px solid #0d6efd":"none",borderRadius:"8px"}}),React.createElement("div",{className:"actions"},React.createElement("button",{className:"btn btn-sm btn-danger",onClick:le=>{le.stopPropagation(),it(o.id,T)},title:"X\xF3a \u1EA3nh"},React.createElement("i",{className:"fas fa-trash"}))),o.caption&&React.createElement("div",{className:"p-2 bg-light small text-truncate"},o.caption)))))),we&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header bg-info text-white"},React.createElement("h5",{className:"modal-title"},React.createElement("i",{className:"fas fa-folder-open me-2"}),"Di chuy\u1EC3n ",re.length," \u1EA3nh"),React.createElement("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>ie(!1)})),React.createElement("div",{className:"modal-body",style:{maxHeight:"400px",overflowY:"auto"}},React.createElement("p",{className:"text-muted small mb-3"},"Ch\u1ECDn th\u01B0 m\u1EE5c \u0111\xEDch:"),React.createElement("div",{className:"folder-tree"},_e.filter(o=>!o.parentId).map(o=>React.createElement(FolderTreeItem,{key:o.uuid||o.id,folder:o,allAlbums:_e,currentAlbumId:x.uuid||x.id,targetAlbum:$e,onSelect:Pe})))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>ie(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-info",onClick:Le,disabled:!$e||a},a?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang chuy\u1EC3n..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-1"}),"Di chuy\u1EC3n \u0111\u1EBFn \u0111\xE2y")))))),me&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.9)"},onClick:()=>C(null)},React.createElement("div",{className:"modal-dialog modal-fullscreen d-flex align-items-center justify-content-center"},React.createElement("div",{className:"position-relative",style:{maxWidth:"95vw",maxHeight:"95vh"}},React.createElement("button",{className:"btn btn-light position-absolute",style:{top:"-50px",right:"0",borderRadius:"50%",width:"40px",height:"40px"},onClick:()=>C(null)},React.createElement("i",{className:"fas fa-times"})),React.createElement("img",{src:me.src,alt:me.caption,style:{maxWidth:"95vw",maxHeight:"90vh",objectFit:"contain"},onClick:o=>o.stopPropagation()}),me.caption&&React.createElement("div",{className:"text-white text-center mt-2"},me.caption)))))}function SearchCenter({showToast:x,onNavigate:u}){const[N,A]=useState(""),[I,d]=useState([]),[w,f]=useState([]),[H,p]=useState([]),[Q,z]=useState("all"),[j,D]=useState(null),[te,oe]=useState("list"),[F,Z]=useState(!0),[se,Y]=useState([]),[ne,v]=useState([]),B=useRef(null),[me,C]=useState(!0),[c,W]=useState(!1),he=useRef(null),[Se,be]=useState(!1),[ce,Ne]=useState([{role:"assistant",content:`Xin ch\xE0o! H\xE3y h\u1ECFi t\xF4i v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3... V\xED d\u1EE5:
\u2022 "Gi\xE1 van 2 tay?"
\u2022 "Combo r\u1EBB nh\u1EA5t?"
\u2022 "Freeship?"`,attachments:[]}]),[ae,we]=useState(""),[ie,re]=useState(!1),Me=useRef(null),_e=useRef(null),[Ce,$e]=useState(null),[Pe,a]=useState(!1),[i,O]=useState(null),[fe,Ae]=useState(!1),[Qe,Le]=useState(!1),[Fe,Ze]=useState(null),[U,xe]=useState({name:"",code:"",price:"",image:"",category:"",note:""}),qe=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"],J=t=>{t._type==="product"&&(O(t),xe({name:t.name||"",code:t.code||"",price:t.price||"",image:t.image||"",category:t.category||"",note:t.note||""}),a(!0))},_=async()=>{if(i)try{await window.KTM.api.putJSON(`${API_BASE}/api/products?id=${i.id}`,U,"L\u1ED7i c\u1EADp nh\u1EADt"),x("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),a(!1),O(null),Je()}catch(t){x(t.message,"danger")}},Ue=async t=>{const h=t._type==="product"?"s\u1EA3n ph\u1EA9m":t._type==="album"?"\u1EA3nh":"video";if(confirm(`X\xF3a ${h} "${t.name}"?`))try{let g="";t._type==="product"?g=`${API_BASE}/api/products?id=${t.id}`:t._type==="album"?g=`${API_BASE}/api/images/${t.id}`:t._type==="video"&&(g=`${API_BASE}/api/videos/${t.id}`),await window.KTM.api.deleteJSON(g,"L\u1ED7i x\xF3a"),x(`\u0110\xE3 x\xF3a ${h}`,"success"),Je()}catch(g){x(g.message,"danger")}},ue=async t=>{try{const h=Fe?`${API_BASE}/api/products?id=${Fe.id}`:`${API_BASE}/api/products`;Fe?await window.KTM.api.putJSON(h,t,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(h,t,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),x(Fe?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Le(!1),Ze(null),Je()}catch(h){x(h.message,"danger")}},et="ktm_admin_data_cache_v1",it=1e3*60*10,Je=async()=>{let t=null,h=!1;const g=window.KTM.cache.read(et,{ttlMs:it,validate:Array.isArray});g.hit?(t=g.value,console.log("[CACHE] Using cache, items:",t.length),f(t),d(t),Z(!1),h=!0):g.status==="miss"?console.log("[CACHE] No cache found"):g.status==="expired"||g.status==="invalid"?console.log("[CACHE] Cache expired or invalid"):g.status==="error"&&console.error("[CACHE] Error parsing cache"),h||Z(!0);try{const k=async(de,ye)=>{try{const je=await window.KTM.api.getJSON(de,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");return je!=null?je:ye}catch(je){return ye}},[M,b,m]=await Promise.all([k(`${API_BASE}/api/products`,[]),k(`${API_BASE}/api/albums`,[]),k(`${API_BASE}/api/video-folders?withVideos=true`,[])]),$=Array.isArray(M)?M.map(de=>({...de,_type:"product",_source:"database"})):[];Y(b);let P=[];Array.isArray(b)&&b.length>0&&(await Promise.all(b.map(ye=>k(`${API_BASE}/api/albums/${ye.id}`,{})))).forEach((ye,je)=>{const Ve=b[je];ye.images&&ye.images.length>0&&ye.images.forEach(ge=>{P.push({id:ge.id,name:ge.caption||"\u1EA2nh t\u1EEB "+Ve.title,image:ge.src,folder:Ve.title,_type:"album",_source:"database"})})}),v(m);let ee=[];Array.isArray(m)&&m.forEach(de=>{de.videos&&de.videos.forEach(ye=>{ee.push({id:ye.id,name:ye.title,folder:de.name,image:ye.thumb,youtubeId:ye.youtubeId,url:ye.url,_type:"video",_source:"database"})})});const q=[...$,...P,...ee];(!t||JSON.stringify(q)!==JSON.stringify(t))&&(f(q),d(q),window.KTM.cache.write(et,q))}catch(k){console.error("Song song fetch error:",k)}Z(!1)};useEffect(()=>{Je(),setTimeout(()=>{var t;return(t=B.current)==null?void 0:t.focus()},100)},[]);const De=t=>{try{return String(t!=null?t:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(h){return String(t!=null?t:"").toLowerCase()}},tt=t=>{const g=De(t).trim().split(/\s+/).filter(Boolean),k=g.includes("anh"),M=g.includes("video"),b=g.filter(P=>P!=="anh"&&P!=="video"),m=b.join(" "),$=new Set(["product"]);return k&&$.add("album"),M&&$.add("video"),{allowedTypes:$,includeAlbum:k,includeVideo:M,contentTokens:b,cleanedQuery:m}},o=(t,h,g)=>{var de,ye,je,Ve,ge;const k=Array.isArray(h)?h:[],M=De(g).trim();if(!k.length&&!M)return 0;const b=De((de=t==null?void 0:t.name)!=null?de:""),m=De((ye=t==null?void 0:t.code)!=null?ye:""),$=De((je=t==null?void 0:t.category)!=null?je:""),P=De((Ve=t==null?void 0:t.note)!=null?Ve:""),ee=De((ge=t==null?void 0:t.folder)!=null?ge:"");if(!`${b} ${m} ${$} ${P} ${ee}`.trim())return 0;let L=0;M&&(b===M&&(L+=220),b.includes(M)&&(L+=140),b.startsWith(M)&&(L+=160),m&&m===M&&(L+=180),m&&m.includes(M)&&(L+=90));for(const Ge of k){if(!Ge)continue;const ct=new RegExp(`(?:^|\\s)${Ge.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}`);b.includes(Ge)&&(L+=35),ct.test(b)&&(L+=25),m&&m.includes(Ge)&&(L+=20),m&&ct.test(m)&&(L+=10),$&&$.includes(Ge)&&(L+=12),ee&&ee.includes(Ge)&&(L+=12),P&&P.includes(Ge)&&(L+=6)}return L>0&&b&&(L+=Math.max(0,10-Math.min(10,Math.floor(b.length/10)))),L},T=(t,h,g)=>{const k=Array.isArray(t)?t:[];return k.length?k.map((b,m)=>({it:b,idx:m,score:o(b,h,g)})).sort((b,m)=>m.score!==b.score?m.score-b.score:b.idx-m.idx).map(b=>b.it):[]},le=async(t,h)=>{if(!(!me||h.length===0)){W(!0);try{const g=h.map(M=>({id:M.id,name:M.name,price:M.price,category:M.category,note:M.note,folder:M.folder,_type:M._type})),k=await window.KTM.api.postJSON(`${API_BASE}/api/ai-search`,{query:t,products:g},"AI Search error");if(k&&k.matchedIds&&k.matchedIds.length>0){const{contentTokens:M,cleanedQuery:b}=tt(t),m=new Set(k.matchedIds),$=h.filter(P=>m.has(P.id)).sort((P,ee)=>o(ee,M,b)-o(P,M,b));$.length>0&&d($)}else k&&k.matchedIds&&k.matchedIds.length===0&&d([])}catch(g){console.error("AI Search error:",g)}W(!1)}},Te=t=>{if(A(t),he.current&&clearTimeout(he.current),!t.trim()){ke(Q);return}const{allowedTypes:h,contentTokens:g,cleanedQuery:k}=tt(t),M=w.filter(m=>{if(!h.has(m==null?void 0:m._type))return!1;if(g.length===0)return!0;const $=De(Object.entries(m).filter(([P])=>!P.startsWith("_")).map(([,P])=>String(P||"")).join(" "));return g.some(P=>$.includes(P))});let b=M;Q!=="all"&&(b=M.filter(m=>(m.category||m._type)===Q)),d(T(b,g,k)),me&&k.length>=3&&(he.current=setTimeout(()=>{le(k,b)},500))},ke=t=>{z(t);const{allowedTypes:h,contentTokens:g}=tt(N),{cleanedQuery:k}=tt(N);let M=w.filter(b=>h.has(b==null?void 0:b._type));t!=="all"&&(M=M.filter(b=>(b.category||b._type)===t)),N.trim()&&g.length>0&&(M=M.filter(b=>{const m=De(Object.entries(b).filter(([$])=>!$.startsWith("_")).map(([,$])=>String($||"")).join(" "));return g.every($=>m.includes($))})),d(T(M,g,k))},Ie=(t,h)=>{window.KTM.clipboard.writeText(t).then(()=>{D(h),x("\u0110\xE3 copy!","success"),setTimeout(()=>D(null),1500)})},Ke=async(t,h)=>{try{await window.KTM.clipboard.writeImageFromUrl(t),D(h+"-img"),x("\u0110\xE3 copy \u1EA3nh!","success"),setTimeout(()=>D(null),1500)}catch(g){Ie(t,h+"-img")}},Oe=t=>{let h=t.toLowerCase();const g=[],k=w.filter(m=>m._type==="product");if(h.includes("ty")||h.includes("xy lanh")){if(h.includes("gi\u1EEFa")||h.includes("giua")){const m=k.find($=>{var P;return(P=$.name)==null?void 0:P.toLowerCase().includes("xy lanh gi\u1EEFa")});m&&!g.find($=>$.id===m.id)&&g.push(m)}if(h.includes("nghi\xEAng")||h.includes("nghieng")){const m=k.find($=>{var P;return(P=$.name)==null?void 0:P.toLowerCase().includes("xy lanh nghi\xEAng")});m&&!g.find($=>$.id===m.id)&&g.push(m)}if(h.includes("\u1EE7i")||h.includes("ui")){const m=k.find($=>{var P;return(P=$.name)==null?void 0:P.toLowerCase().includes("xy lanh \u1EE7i")});m&&!g.find($=>$.id===m.id)&&g.push(m)}}const M=h.match(/van\s*(\d+)\s*tay.*?(\d+)\s*ty/);if(M){const m=M[1],$=M[2],P=k.find(ee=>{var L;const q=((L=ee.name)==null?void 0:L.toLowerCase())||"";return q.includes("combo")&&q.includes(`${m} tay`)&&(q.includes(`${$} xy`)||q.includes(`${$} xylanh`))});if(P&&!g.find(ee=>ee.id===P.id))g.push(P);else{const ee=k.find(q=>{var de;const L=((de=q.name)==null?void 0:de.toLowerCase())||"";return L.includes("combo")&&L.includes(`${m} tay`)});ee&&!g.find(q=>q.id===ee.id)&&g.push(ee)}}if(h.includes("combo")&&!M){const m=h.match(/combo.*?(\d+)\s*tay/);if(m){const $=m[1];k.filter(ee=>{var L;const q=((L=ee.name)==null?void 0:L.toLowerCase())||"";return q.includes("combo")&&q.includes(`${$} tay`)}).forEach(ee=>{g.find(q=>q.id===ee.id)||g.push(ee)})}}const b=h.match(/van\s*(\d+)\s*tay/);if(b&&!h.includes("ty")&&!h.includes("combo")){const m=b[1],$=k.find(P=>{var q;const ee=((q=P.name)==null?void 0:q.toLowerCase())||"";return ee.includes(`van ${m} tay`)&&!ee.includes("combo")});$&&!g.find(P=>P.id===$.id)&&g.push($)}return g.slice(0,4)},ze=async t=>{if(!t.trim())return;const h={role:"user",content:t,attachments:[]};Ne(k=>[...k,h]),we(""),re(!0);const g=Oe(t);setTimeout(()=>{var k;return(k=Me.current)==null?void 0:k.scrollIntoView({behavior:"smooth"})},100);try{const M=w.filter(q=>q._type==="product").map(q=>{let L=`- ${q.name}`;return q.code&&(L+=` (M\xE3: ${q.code})`),q.price&&(L+=` - Gi\xE1: ${q.price.replace(/[đ\s]/g,"")}\u0111`),q.category&&(L+=` [${q.category}]`),q.note&&(L+=` (${q.note})`),L}).join(`
`),m=ce.slice(-6).map(q=>`${q.role==="user"?"Kh\xE1ch":"AI"}: ${q.content}`).join(`
`),$=m?`L\u1ECACH S\u1EEC H\u1ED8I THO\u1EA0I:
${m}

DANH S\xC1CH S\u1EA2N PH\u1EA8M:
${M}`:M,ee=(await window.KTM.api.postJSON(`${API_BASE}/api/ai-chat`,{message:t,context:$,audience:"admin"},"API error")).response||"Xin l\u1ED7i, t\xF4i kh\xF4ng th\u1EC3 tr\u1EA3 l\u1EDDi l\xFAc n\xE0y.";Ne(q=>[...q,{role:"assistant",content:ee,attachments:g}])}catch(k){console.error("AI Error:",k);const M=t.toLowerCase(),b=w.filter($=>{const P=Object.values($).join(" ").toLowerCase();return M.split(" ").some(ee=>P.includes(ee))});let m="";b.length>0?(m=`T\xECm th\u1EA5y ${b.length} s\u1EA3n ph\u1EA9m li\xEAn quan:

`,b.slice(0,5).forEach($=>{m+=`\u2022 ${$.name}`,$.price&&(m+=` - ${$.price.replace(/[đ\s]/g,"")}\u0111`),$.note&&(m+=` (${$.note})`),m+=`
`}),b.length>5&&(m+=`
...v\xE0 ${b.length-5} s\u1EA3n ph\u1EA9m kh\xE1c`)):m='Kh\xF4ng t\xECm th\u1EA5y s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p. H\xE3y th\u1EED t\u1EEB kh\xF3a kh\xE1c nh\u01B0 "van", "combo", "xy lanh"...',Ne($=>[...$,{role:"assistant",content:m,attachments:b.slice(0,4)}])}re(!1),setTimeout(()=>{var k,M;(k=Me.current)==null||k.scrollIntoView({behavior:"smooth"}),(M=_e.current)==null||M.focus()},100)};function at({show:t,product:h,categories:g,onClose:k,onSave:M}){const[b,m]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0}),[$,P]=useState(!1),[ee,q]=useState(!1),L=useRef(null),de=R=>window.KTM.money.formatVNDInputDigits(R);useEffect(()=>{if(h)if(m({name:h.name||"",code:h.code||"",price:h.price||"",image:h.image||"",category:h.category||"",note:h.note||"",sort_order:h.sort_order||0}),h.price){const R=window.KTM.money.getDigits(h.price);ge(R),m(He=>({...He,price:de(R)}))}else ge("");else m({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0}),ge("")},[h,t]);const[ye,je]=React.useState(""),[Ve,ge]=React.useState(""),Ge=R=>{const He=window.KTM.money.nextPriceInputState(R.target.value,Ve);ge(He.digits),m({...b,price:He.price})},ct=async(R,He=2)=>{const dt=He*1024*1024;if(R.size<=dt)return R;try{const Be=await createImageBitmap(R),Re=document.createElement("canvas");let e=Be.width,n=Be.height;const s=1200;return(e>s||n>s)&&(e>n?(n=Math.round(n/e*s),e=s):(e=Math.round(e/n*s),n=s)),Re.width=e,Re.height=n,Re.getContext("2d").drawImage(Be,0,0,e,n),Be.close(),new Promise((r,S)=>{Re.toBlob(G=>{G?r(new File([G],R.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):S(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(Be){throw console.error("Compress error:",Be),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},ht=async R=>{var Be;const He=R.target.files[0];if(!He)return;if(!(He.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp)$/i.test(He.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}q(!0);try{const Re=await ct(He),e=await window.KTM.cloudinary.uploadImage({file:Re,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-products"});if(!e.secure_url)throw console.error("Cloudinary error:",e),new Error(((Be=e.error)==null?void 0:Be.message)||"Upload failed");m(n=>({...n,image:e.secure_url}))}catch(Re){console.error("Upload error:",Re),alert("L\u1ED7i upload \u1EA3nh: "+Re.message)}q(!1),R.target.value=""},bt=async R=>{R.preventDefault(),P(!0),await M(b),P(!1)};return t?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-lg"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,border:"none",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark"},React.createElement("i",{className:"fas fa-box me-2"}),h?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:k})),React.createElement("form",{onSubmit:bt},React.createElement("div",{className:"modal-body",style:{maxHeight:"70vh",overflowY:"auto"}},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-8"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-tag me-1"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:b.name,onChange:R=>m({...b,name:R.target.value}),placeholder:"V\xED d\u1EE5: Xy lanh nghi\xEAng KTM",required:!0,style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-hashtag me-1"}),"M\xE3 s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:b.code,onChange:R=>m({...b,code:R.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1"}),"Gi\xE1 b\xE1n"),React.createElement("input",{type:"text",className:"form-control",value:b.price,onChange:Ge,placeholder:"1.950.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-list me-1"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:b.category,onChange:R=>m({...b,category:R.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),g.map(R=>React.createElement("option",{key:R,value:R},R)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1"}),"Ghi ch\xFA"),React.createElement("textarea",{className:"form-control",rows:"2",value:b.note,onChange:R=>m({...b,note:R.target.value}),placeholder:"V\xED d\u1EE5: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"col-md-4"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-image me-1"}),"\u1EA2nh s\u1EA3n ph\u1EA9m"),React.createElement("div",{className:"mb-2"},b.image?React.createElement(React.Fragment,null,React.createElement("img",{src:b.image,alt:"Product",style:{width:"100%",height:150,objectFit:"cover",borderRadius:"12px",border:"2px solid #e9ecef"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger mt-2",onClick:()=>m({...b,image:""}),style:{borderRadius:"20px",fontSize:"0.75rem"}},React.createElement("i",{className:"fas fa-times me-1"}),"X\xF3a \u1EA3nh")):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:"100%",height:150,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd",cursor:"pointer"},onClick:()=>{var R;return(R=L.current)==null?void 0:R.click()}},React.createElement("div",{className:"text-center"},React.createElement("i",{className:"fas fa-cloud-upload-alt fa-2x text-muted mb-2"}),React.createElement("div",{className:"small text-muted"},"Click \u0111\u1EC3 upload")))),React.createElement("input",{ref:L,type:"file",accept:"image/*",className:"d-none",onChange:ht}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100",onClick:()=>{var R;return(R=L.current)==null?void 0:R.click()},disabled:ee,style:{borderRadius:"10px"}},ee?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh")),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"Ho\u1EB7c URL \u1EA3nh"),React.createElement("input",{type:"url",className:"form-control",value:b.image,onChange:R=>m({...b,image:R.target.value}),placeholder:"https://...",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"8px",fontSize:"0.875rem"}}))))),React.createElement("div",{className:"modal-footer",style:{border:"none",padding:"20px"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:k,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:$,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},$?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}const st=(t,h)=>{const g=t._type==="product",k=t._type==="album",M=t._type==="video",b=t.note&&(t.note.toLowerCase().includes("free")||t.note.toLowerCase().includes("gi\u1EA3m")||t.note.toLowerCase().includes("sale"));return te==="grid"?React.createElement("div",{key:t.id||h,className:"grid-card"},React.createElement("div",{className:"thumb-wrap",onClick:()=>$e({url:t.image,name:t.name,price:t.price,note:t.note,item:t})},t.image?React.createElement("img",{src:t.image,alt:t.name,className:"thumb",loading:"lazy"}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${M?"fa-video":"fa-image"} fa-2x text-muted`})),t.price&&React.createElement("div",{className:"price-overlay"},t.price.replace(/[đ\s]/g,""),"\u0111"),React.createElement("span",{className:`type-badge ${g?"product":k?"album":"video"}`},g?"SP":k?"\u1EA2nh":"Video"),b&&React.createElement("span",{className:"promo-badge"},"\u{1F525} \u01AFU \u0110\xC3I")),React.createElement("div",{className:"card-body"},React.createElement("div",{className:"name"},t.name),t.note&&React.createElement("div",{className:"meta text-info",style:{fontSize:10}},t.note),React.createElement("div",{className:"quick-copy"},React.createElement("button",{className:j===t.id+"-img"?"copied":"",onClick:()=>Ke(t.image,t.id)},React.createElement("i",{className:"fas fa-image"})),t.price&&React.createElement("button",{className:j===t.id+"-price"?"copied":"",onClick:()=>Ie(t.price.replace(/[đ\s]/g,""),t.id+"-price")},React.createElement("i",{className:"fas fa-tag"}))))):React.createElement("div",{key:t.id||h,className:"product-card-mobile"},React.createElement("span",{className:`type-badge ${g?"product":k?"album":"video"}`},g?"S\u1EA3n ph\u1EA9m":k?"\u1EA2nh":"Video"),React.createElement("div",{className:"card-inner"},t.image?React.createElement("img",{src:t.image,alt:t.name,className:"thumb",loading:"lazy",onClick:()=>$e({url:t.image,name:t.name,price:t.price,note:t.note,item:t})}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${M?"fa-video":"fa-image"} fa-2x text-muted`})),React.createElement("div",{className:"info"},React.createElement("div",null,React.createElement("div",{className:"name"},t.name),React.createElement("div",{className:"price-row"},t.price&&React.createElement("span",{className:"price"},t.price.replace(/[đ\s]/g,""),"\u0111"),b&&React.createElement("span",{className:"badge-promo"},"\u{1F525} \u01AFU \u0110\xC3I"))),React.createElement("div",{className:"meta"},t.code&&React.createElement("span",{className:"meta-tag"},"#",t.code),t.category&&React.createElement("span",{className:"meta-tag"},t.category),t.note&&React.createElement("span",{className:"meta-tag highlight"},t.note),t.folder&&React.createElement("span",{className:"meta-tag"},t.folder),M&&React.createElement("span",{className:"meta-tag"},React.createElement("i",{className:"fab fa-youtube text-danger"})," Video")))),React.createElement("div",{className:"quick-actions"},g&&React.createElement("button",{onClick:()=>u&&u("orders","create",{productId:t.id})},React.createElement("i",{className:"fas fa-receipt"})," T\u1EA1o \u0111\u01A1n"),t.price&&React.createElement("button",{className:j===t.id+"-price"?"copied":"",onClick:()=>Ie(t.price.replace(/[đ\s]/g,""),t.id+"-price")},React.createElement("i",{className:"fas fa-tag"})," Gi\xE1"),React.createElement("button",{className:j===t.id+"-name"?"copied":"",onClick:()=>Ie(t.name,t.id+"-name")},React.createElement("i",{className:"fas fa-font"})," T\xEAn"),M&&t.youtubeId&&React.createElement("button",{className:j===t.id+"-yt"?"copied":"",onClick:()=>Ie(`https://www.youtube.com/watch?v=${t.youtubeId}`,t.id+"-yt")},React.createElement("i",{className:"fab fa-youtube"})),g&&React.createElement("button",{className:"action-edit",onClick:()=>J(t)},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"action-delete",onClick:()=>Ue(t)},React.createElement("i",{className:"fas fa-trash"}))))},[Xe,X]=useState(!1);return React.createElement(React.Fragment,null,React.createElement("div",{className:"result-header"},React.createElement("span",null,React.createElement("strong",null,I.length)," k\u1EBFt qu\u1EA3",me&&N.length>=3&&React.createElement("span",{className:"ai-badge ms-2"},React.createElement("i",{className:"fas fa-robot"})," AI"),Q!=="all"&&React.createElement("span",{className:"ms-2 badge bg-warning text-dark"},Q==="product"?"S\u1EA3n ph\u1EA9m":Q==="album"?"\u1EA2nh":"Video")),React.createElement("div",{className:"d-flex gap-1 align-items-center"},React.createElement("button",{className:`btn btn-sm ${te==="list"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>oe("list"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-list"})),React.createElement("button",{className:`btn btn-sm ${te==="grid"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>oe("grid"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-th"})))),React.createElement("div",{className:"search-results-area"},F?React.createElement("div",null,[...Array(8)].map((t,h)=>React.createElement("div",{key:h,className:"product-card-mobile mb-2",style:{opacity:.7}},React.createElement("div",{className:"card-inner"},React.createElement("div",{className:"thumb bg-light",style:{width:80,height:80,borderRadius:8}}),React.createElement("div",{className:"info",style:{flex:1,minWidth:0}},React.createElement("div",{className:"skeleton-box mb-2",style:{height:16,width:"60%",background:"#eee",borderRadius:4}}),React.createElement("div",{className:"skeleton-box mb-1",style:{height:12,width:"40%",background:"#f3f3f3",borderRadius:4}}),React.createElement("div",{className:"skeleton-box",style:{height:10,width:"30%",background:"#f3f3f3",borderRadius:4}})))))):I.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-search"}),React.createElement("p",null,'Kh\xF4ng t\xECm th\u1EA5y "',N,'"'),React.createElement("button",{className:"btn btn-warning",onClick:()=>{A(""),Te("")}},"Xem t\u1EA5t c\u1EA3")):te==="grid"?React.createElement("div",{className:"product-grid-mobile"},I.map((t,h)=>st(t,h))):React.createElement("div",null,I.map((t,h)=>st(t,h)))),Xe&&React.createElement("div",{className:"filter-dropdown"},React.createElement("div",{className:"filter-header"},React.createElement("strong",null,"L\u1ECDc theo lo\u1EA1i"),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>X(!1)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"filter-chips"},React.createElement("span",{className:`filter-chip ${Q==="all"?"active":""}`,onClick:()=>{ke("all"),X(!1)}},"T\u1EA5t c\u1EA3"),React.createElement("span",{className:`filter-chip ${Q==="product"?"active":""}`,onClick:()=>{ke("product"),X(!1)}},React.createElement("i",{className:"fas fa-box me-1"}),"S\u1EA3n ph\u1EA9m"),React.createElement("span",{className:`filter-chip ${Q==="album"?"active":""}`,onClick:()=>{ke("album"),X(!1)}},React.createElement("i",{className:"fas fa-images me-1"}),"\u1EA2nh"),React.createElement("span",{className:`filter-chip ${Q==="video"?"active":""}`,onClick:()=>{ke("video"),X(!1)}},React.createElement("i",{className:"fas fa-video me-1"}),"Video")),React.createElement("div",{className:"mt-3 pt-3 border-top d-flex align-items-center justify-content-between"},React.createElement("span",null,"AI Search th\xF4ng minh"),React.createElement("div",{className:"form-check form-switch m-0"},React.createElement("input",{type:"checkbox",className:"form-check-input",checked:me,onChange:t=>C(t.target.checked),style:{width:40,height:20}})))),React.createElement("div",{className:"search-bar-bottom"},React.createElement("div",{className:"search-input-wrap"},React.createElement("input",{ref:B,type:"text",className:"search-input",placeholder:"\u{1F50D} T\xECm: van 3 tay, xylanh...",value:N,onChange:t=>Te(t.target.value)}),React.createElement("button",{className:`filter-btn ${Xe||Q!=="all"?"active":""}`,onClick:()=>X(!Xe)},React.createElement("i",{className:"fas fa-filter"})))),React.createElement("button",{className:"btn btn-lg rounded-circle position-fixed shadow-lg",style:{bottom:fe?320:130,right:16,width:56,height:56,zIndex:1050,transition:"bottom 0.2s ease",background:"linear-gradient(135deg, #667eea, #764ba2)",color:"#fff",border:"none",WebkitTapHighlightColor:"transparent",touchAction:"manipulation",cursor:"pointer",outline:"none"},onClick:()=>be(!0),onTouchStart:()=>be(!0)},React.createElement("i",{className:"fas fa-robot fa-lg"})),Se&&React.createElement("div",{className:"ai-chat-mobile"},React.createElement("div",{className:"chat-header"},React.createElement("button",{className:"back-btn",onClick:()=>be(!1)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("strong",null,"KTM AI Assistant"),React.createElement("div",{style:{fontSize:11,opacity:.8}},"H\u1ECFi v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3..."))),React.createElement("div",{className:"chat-messages"},ce.map((t,h)=>React.createElement("div",{key:h,className:`mb-3 ${t.role==="user"?"d-flex justify-content-end":""}`},React.createElement("div",{className:`p-3 rounded-3 position-relative ${t.role==="user"?"text-white":"bg-white border"}`,style:{maxWidth:"85%",whiteSpace:"pre-wrap",background:t.role==="user"?"linear-gradient(135deg, #667eea, #764ba2)":void 0}},t.content,t.role==="assistant"&&React.createElement("button",{className:"btn btn-sm position-absolute",style:{top:4,right:4,padding:"2px 6px",fontSize:11,background:j===`chat-${h}`?"#28a745":"rgba(0,0,0,0.1)",border:"none",borderRadius:4,color:j===`chat-${h}`?"#fff":"#666"},onClick:()=>{window.KTM.clipboard.writeText(t.content),D(`chat-${h}`),setTimeout(()=>D(null),1500)}},React.createElement("i",{className:`fas ${j===`chat-${h}`?"fa-check":"fa-copy"}`})),t.attachments&&t.attachments.length>0&&React.createElement("div",{className:"mt-2 d-flex flex-wrap gap-2"},t.attachments.map((g,k)=>React.createElement("div",{key:k,style:{width:70},className:"text-center"},g.image&&React.createElement("img",{src:g.image,className:"rounded",style:{width:70,height:50,objectFit:"cover",cursor:"pointer"},onClick:()=>$e({url:g.image,name:g.name,price:g.price})}),React.createElement("div",{style:{fontSize:9},className:"text-truncate"},g.name),g.price&&React.createElement("div",{style:{fontSize:10,color:"#dc3545",fontWeight:600}},g.price.replace(/[đ\s]/g,""),"\u0111"))))))),ie&&React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"bg-white border p-3 rounded-3 d-inline-block"},React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang suy ngh\u0129...")),React.createElement("div",{ref:Me})),React.createElement("div",{className:"px-3 py-2 border-top d-flex gap-2 overflow-auto"},["Gi\xE1 van 2 tay?","Combo r\u1EBB nh\u1EA5t?","Freeship?","Van 3 tay?"].map(t=>React.createElement("button",{key:t,className:"btn btn-sm btn-outline-secondary flex-shrink-0",onClick:()=>ze(t),disabled:ie,style:{whiteSpace:"nowrap"}},t))),React.createElement("div",{className:"chat-input-area"},React.createElement("form",{onSubmit:t=>{t.preventDefault(),ze(ae)},className:"chat-input-wrap"},React.createElement("input",{ref:_e,type:"text",className:"chat-input",placeholder:"Nh\u1EADp c\xE2u h\u1ECFi...",value:ae,onChange:t=>we(t.target.value),disabled:ie}),React.createElement("button",{type:"submit",className:"send-btn",disabled:ie||!ae.trim()},React.createElement("i",{className:"fas fa-paper-plane"}))))),Ce&&React.createElement("div",{className:"preview-modal",onClick:()=>$e(null)},React.createElement("div",{className:"preview-header"},React.createElement("div",null),React.createElement("button",{className:"close-btn",onClick:()=>$e(null)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"preview-body",onClick:t=>t.stopPropagation()},React.createElement("img",{src:Ce.url,alt:Ce.name})),React.createElement("div",{className:"preview-footer",onClick:t=>t.stopPropagation()},React.createElement("div",{className:"name"},Ce.name),Ce.price&&React.createElement("div",{className:"price"},Ce.price.replace(/[đ\s]/g,""),"\u0111"),Ce.note&&React.createElement("div",{className:"mb-2",style:{fontSize:14,color:"#17a2b8"}},Ce.note),React.createElement("div",{className:"action-btns"},React.createElement("button",{className:j==="preview-img"?"btn-success text-white":"btn-outline-light text-white",style:{background:j==="preview-img"?"#28a745":"rgba(255,255,255,0.2)"},onClick:()=>Ke(Ce.url,"preview")},React.createElement("i",{className:`fas ${j==="preview-img"?"fa-check":"fa-copy"}`}),"Copy \u1EA3nh"),Ce.price&&React.createElement("button",{className:j==="preview-price"?"btn-success text-white":"btn-warning",onClick:()=>Ie(Ce.price.replace(/[đ\s]/g,""),"preview-price")},React.createElement("i",{className:`fas ${j==="preview-price"?"fa-check":"fa-tag"}`}),"Copy gi\xE1")))),React.createElement(at,{show:Qe,product:Fe,categories:H,onClose:()=>{Le(!1),Ze(null)},onSave:ue}),React.createElement("div",{className:`fab-container mobile-only ${fe?"open":""}`},React.createElement("div",{className:"fab-actions"},React.createElement("button",{className:"fab-action product",onClick:()=>{Ae(!1),Le(!0),Ze(null)}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",{className:"tooltip"},"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("button",{className:"fab-action product",onClick:()=>{Ae(!1),u&&u("orders","create")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",{className:"tooltip"},"T\u1EA1o order nhanh"))),React.createElement("button",{className:`fab-main ${fe?"open":""}`,onClick:()=>Ae(!fe)},React.createElement("i",{className:"fas fa-plus"}))),Pe&&i&&React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,maxHeight:"90vh"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none"}},React.createElement("h6",{className:"modal-title fw-bold"},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa nhanh"),React.createElement("button",{type:"button",className:"btn-close",onClick:()=>a(!1)})),React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"T\xEAn s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:U.name,onChange:t=>xe({...U,name:t.target.value})})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:U.code,onChange:t=>xe({...U,code:t.target.value})})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:U.price,onChange:t=>xe({...U,price:t.target.value})}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:U.category,onChange:t=>xe({...U,category:t.target.value})},React.createElement("option",{value:""},"-- Ch\u1ECDn danh m\u1EE5c --"),qe.map(t=>React.createElement("option",{key:t,value:t},t)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Ghi ch\xFA (\u01B0u \u0111\xE3i)"),React.createElement("input",{type:"text",className:"form-control",value:U.note,placeholder:"VD: Free ship, Gi\u1EA3m 10%...",onChange:t=>xe({...U,note:t.target.value})}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>a(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-warning",onClick:_},React.createElement("i",{className:"fas fa-save me-1"}),"L\u01B0u"))))))}function VideoList({onRefresh:x,showToast:u}){const[N,A]=useState([]),[I,d]=useState([]),[w,f]=useState(!0),[H,p]=useState(null),[Q,z]=useState(!1),[j,D]=useState(null),[te,oe]=useState(!1),[F,Z]=useState(null),[se,Y]=useState(null),[ne,v]=useState([]);useEffect(()=>{B()},[]);const B=async(a=null)=>{f(!0);try{const i=a?`${API_BASE}/api/video-folders?withVideos=true&parent_id=${a}`:`${API_BASE}/api/video-folders?withVideos=true&parent_id=root`,O=await window.KTM.api.getJSON(i,"L\u1ED7i t\u1EA3i danh s\xE1ch folder");A(Array.isArray(O)?O:[])}catch(i){console.error(i),u("L\u1ED7i t\u1EA3i danh s\xE1ch folder","danger")}f(!1)},me=async a=>{try{const i=await window.KTM.api.getJSON(`${API_BASE}/api/videos?folderId=${a}`,"L\u1ED7i t\u1EA3i video");d(Array.isArray(i)?i:[])}catch(i){console.error(i)}},C=async a=>{if(a===0)return;const i=[...N];[i[a-1],i[a]]=[i[a],i[a-1]],A(i),await W(i)},c=async a=>{if(a===N.length-1)return;const i=[...N];[i[a],i[a+1]]=[i[a+1],i[a]],A(i),await W(i)},W=async a=>{try{await Promise.all(a.map((i,O)=>window.KTM.api.putJSON(`${API_BASE}/api/video-folders/${i.id}`,{sortOrder:O},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),u("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(i){u("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),B(se==null?void 0:se.id)}},he=async a=>{if(a===0)return;const i=[...I];[i[a-1],i[a]]=[i[a],i[a-1]],d(i),await be(i)},Se=async a=>{if(a===I.length-1)return;const i=[...I];[i[a],i[a+1]]=[i[a+1],i[a]],d(i),await be(i)},be=async a=>{try{await Promise.all(a.map((i,O)=>window.KTM.api.putJSON(`${API_BASE}/api/videos/${i.id}`,{sort_order:O},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),u("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(i){u("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),me(H.id)}},ce=()=>{D(null),z(!0)},Ne=a=>{D(a),z(!0)},ae=async a=>{try{!j&&se&&(a.parent_id=se.id);const i=j?`${API_BASE}/api/video-folders/${j.id}`:`${API_BASE}/api/video-folders`;j?await window.KTM.api.putJSON(i,a,"L\u1ED7i l\u01B0u folder"):await window.KTM.api.postJSON(i,a,"L\u1ED7i l\u01B0u folder"),u(j?"\u0110\xE3 c\u1EADp nh\u1EADt folder!":"\u0110\xE3 t\u1EA1o folder m\u1EDBi!","success"),z(!1),B(se==null?void 0:se.id)}catch(i){u(i.message,"danger")}},we=async a=>{const i=a.subfolderCount>0?`X\xF3a folder "${a.name}"? T\u1EA5t c\u1EA3 subfolder v\xE0 videos b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`:`X\xF3a folder "${a.name}"? Videos trong folder s\u1EBD kh\xF4ng b\u1ECB x\xF3a.`;if(confirm(i))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/video-folders/${a.id}`,"L\u1ED7i x\xF3a folder"),u("\u0110\xE3 x\xF3a folder","success"),p(null),B(se==null?void 0:se.id)}catch(O){u("L\u1ED7i x\xF3a folder","danger")}},ie=a=>{a.subfolderCount>0?(v(i=>[...i,a]),Y(a),B(a.id)):(p(a),d(a.videos||[]))},re=a=>{if(a==="root")v([]),Y(null),B(null);else if(a){const i=ne.findIndex(O=>O.id===a.id);i>=0&&(v(ne.slice(0,i+1)),Y(a),B(a.id))}else{const i=[...ne];i.pop();const O=i[i.length-1]||null;v(i),Y(O),B(O==null?void 0:O.id)}},Me=()=>{Z(null),oe(!0)},_e=a=>{Z(a),oe(!0)},Ce=async a=>{try{a.folder_id=H==null?void 0:H.id;const i=F?`${API_BASE}/api/videos/${F.id}`:`${API_BASE}/api/videos`;F?await window.KTM.api.putJSON(i,a,"L\u1ED7i l\u01B0u video"):await window.KTM.api.postJSON(i,a,"L\u1ED7i l\u01B0u video"),u(F?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm video th\xE0nh c\xF4ng!","success"),oe(!1),B(),H&&me(H.id)}catch(i){u(i.message,"danger")}},$e=async a=>{if(confirm(`X\xF3a video "${a.title}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/videos/${a.id}`,"L\u1ED7i x\xF3a video"),u("\u0110\xE3 x\xF3a video","success"),B(),H&&me(H.id)}catch(i){u("L\u1ED7i x\xF3a video","danger")}},Pe=a=>{const i=`https://www.youtube.com/watch?v=${a.youtubeId}`;window.KTM.clipboard.writeText(i).then(()=>{u("\u0110\xE3 copy link!","success")}).catch(()=>{u("Kh\xF4ng th\u1EC3 copy link","danger")})};return H?React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>p(null)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:`fas fa-folder-open me-2 ${H.slug==="shorts"?"text-danger":"text-warning"}`}),H.name)),React.createElement("button",{className:"btn btn-warning",onClick:Me},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm Video")),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1 videos"),I.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-video fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},"Ch\u01B0a c\xF3 video trong folder n\xE0y")):React.createElement("div",{className:"row g-4"},I.map((a,i)=>React.createElement("div",{key:a.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>he(i),disabled:i===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},i+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>Se(i),disabled:i===I.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"position-relative"},React.createElement("img",{src:a.thumb,className:"card-img-top",alt:a.title,style:{height:"120px",objectFit:"cover"}}),React.createElement("a",{href:`https://www.youtube.com/watch?v=${a.youtubeId}`,target:"_blank",className:"position-absolute top-50 start-50 translate-middle"},React.createElement("i",{className:"fas fa-play-circle fa-3x text-white",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"}}))),React.createElement("div",{className:"card-body py-2"},React.createElement("h6",{className:"card-title small mb-1 text-truncate",title:a.title},a.title),React.createElement("small",{className:"text-muted"},a.youtubeId)),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-primary",onClick:()=>Pe(a),title:"Copy link"},React.createElement("i",{className:"fas fa-link"})),React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>_e(a),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-outline-danger",onClick:()=>$e(a),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))))),React.createElement(VideoModal,{show:te,video:F,onClose:()=>oe(!1),onSave:Ce})):React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},se&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>re()},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-video me-2 text-warning"}),se?se.name:"Qu\u1EA3n l\xFD Video")),React.createElement("button",{className:"btn btn-warning",onClick:ce},React.createElement("i",{className:"fas fa-folder-plus me-2"}),"T\u1EA1o Folder")),ne.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:a=>{a.preventDefault(),re("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),ne.map((a,i)=>React.createElement("li",{key:a.id,className:`breadcrumb-item ${i===ne.length-1?"active":""}`},i===ne.length-1?a.name:React.createElement("a",{href:"#",onClick:O=>{O.preventDefault(),re(a)},className:"text-warning"},a.name))))),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1. Click v\xE0o folder \u0111\u1EC3 v\xE0o b\xEAn trong."),w?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):N.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},se?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder video n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:ce},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o folder",se?" con":" \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"row g-3"},N.map((a,i)=>{var O,fe,Ae,Qe;return React.createElement("div",{key:a.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-card"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Le=>{Le.stopPropagation(),C(i)},disabled:i===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},i+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Le=>{Le.stopPropagation(),c(i)},disabled:i===N.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"card-body text-center py-3",onClick:()=>ie(a),style:{cursor:"pointer"}},React.createElement("i",{className:`fas fa-folder fa-3x mb-3 ${a.slug==="shorts"?"text-danger":"text-warning"}`}),React.createElement("h5",{className:"card-title"},a.name),React.createElement("p",{className:"text-muted mb-0"},a.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),a.subfolderCount," folder"),a.subfolderCount>0&&(a.videoCount>0||((O=a.videos)==null?void 0:O.length)>0)&&" \u2022 ",(a.videoCount>0||((fe=a.videos)==null?void 0:fe.length)>0)&&React.createElement("span",null,React.createElement("i",{className:"fas fa-video me-1"}),a.videoCount||((Ae=a.videos)==null?void 0:Ae.length)||0," videos"),a.subfolderCount===0&&!a.videoCount&&!((Qe=a.videos)!=null&&Qe.length)&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:Le=>{Le.stopPropagation(),Ne(a)}},React.createElement("i",{className:"fas fa-edit"})," S\u1EEDa"),React.createElement("button",{className:"btn btn-outline-danger",onClick:Le=>{Le.stopPropagation(),we(a)}},React.createElement("i",{className:"fas fa-trash"})," X\xF3a")))))})),React.createElement(VideoFolderModal,{show:Q,folder:j,onClose:()=>z(!1),onSave:ae}))}function VideoFolderModal({show:x,folder:u,onClose:N,onSave:A}){const[I,d]=useState({name:"",description:"",sortOrder:0,coverImage:""}),[w,f]=useState(!1),[H,p]=useState(!1);useEffect(()=>{d(u?{name:u.name||"",description:u.description||"",sortOrder:u.sortOrder||0,coverImage:u.coverImage||""}:{name:"",description:"",sortOrder:0,coverImage:""})},[u,x]);const Q=async j=>{const D=j.target.files[0];if(D){p(!0);try{const te=await window.KTM.cloudinary.uploadImage({file:D,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});te.secure_url&&d(oe=>({...oe,coverImage:te.secure_url})),window.KTM.cache.remove(CACHE_KEY),showToast("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),setShowQuickEdit(!1),setEditingItem(null),loadAllData()}catch(te){console.error("Cloudinary upload error:",te),alert("L\u1ED7i upload \u1EA3nh: "+(te.message||te))}finally{p(!1)}}},z=async j=>{j.preventDefault(),f(!0),await A(I),f(!1)};return x?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},u?"S\u1EEDa Folder":"T\u1EA1o Folder m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:N})),React.createElement("form",{onSubmit:z},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn folder *"),React.createElement("input",{type:"text",className:"form-control",value:I.name,onChange:j=>d({...I,name:j.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",value:I.description,onChange:j=>d({...I,description:j.target.value}),rows:"2"})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:I.sortOrder,onChange:j=>d({...I,sortOrder:parseInt(j.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex align-items-start gap-3"},I.coverImage?React.createElement("div",{className:"position-relative"},React.createElement("img",{src:I.coverImage,alt:"Cover",className:"rounded",style:{width:120,height:80,objectFit:"cover"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute top-0 end-0",onClick:()=>d({...I,coverImage:""}),style:{transform:"translate(30%, -30%)"}},React.createElement("i",{className:"fas fa-times"}))):React.createElement("div",{className:"bg-light rounded d-flex align-items-center justify-content-center text-muted",style:{width:120,height:80}},React.createElement("i",{className:"fas fa-image fa-2x"})),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{type:"file",className:"form-control form-control-sm",accept:"image/*,image/jpeg,image/png,image/gif,image/webp",onChange:Q,disabled:H}),H&&React.createElement("div",{className:"mt-1 text-muted small"},React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang upload..."),React.createElement("div",{className:"mt-1 text-muted small"},"Ho\u1EB7c d\xE1n URL:"),React.createElement("input",{type:"url",className:"form-control form-control-sm",placeholder:"https://...",value:I.coverImage,onChange:j=>d({...I,coverImage:j.target.value})}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:N},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:w},w?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function ProductManager({showToast:x}){const[u,N]=useState([]),[A,I]=useState(!0),[d,w]=useState(!1),[f,H]=useState(null),[p,Q]=useState(""),[z,j]=useState(""),D=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"];useEffect(()=>{te()},[]);const te=async()=>{I(!0);try{const v=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");N(Array.isArray(v)?v:[])}catch(v){console.error(v),x("L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m","danger")}I(!1)},oe=()=>{H(null),w(!0)},F=v=>{H(v),w(!0)},Z=async v=>{if(!(!v||!v.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:v},"L\u1ED7i x\xF3a \u1EA3nh"),window.KTM.cache.remove(CACHE_KEY),x(`\u0110\xE3 x\xF3a ${typeName}`,"success"),loadAllData(),te()}catch(B){x("L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m","danger")}},se=async v=>{try{const B=f?`${API_BASE}/api/products?id=${f.id}`:`${API_BASE}/api/products`;f?await window.KTM.api.putJSON(B,v,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(B,v,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),x(f?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),w(!1),te()}catch(B){x(B.message,"danger")}},Y=async v=>{if(confirm(`B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n x\xF3a s\u1EA3n ph\u1EA9m "${v.name}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/products?id=${v.id}`,"L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m"),x("X\xF3a s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),te()}catch(B){x(B.message,"danger")}},ne=u.filter(v=>{const B=!p||v.name.toLowerCase().includes(p.toLowerCase())||v.code&&v.code.toLowerCase().includes(p.toLowerCase()),me=!z||v.category===z;return B&&me});return React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",null,React.createElement("i",{className:"fas fa-box me-2"}),"S\u1EA3n ph\u1EA9m"),React.createElement("button",{className:"btn-add-product",onClick:oe},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"d-flex gap-2 mb-2"},React.createElement("div",{className:"flex-grow-1 position-relative"},React.createElement("input",{type:"text",className:"form-control",placeholder:"\u{1F50D} T\xECm s\u1EA3n ph\u1EA9m...",value:p,onChange:v=>Q(v.target.value)})),React.createElement("span",{className:"product-count"},ne.length)),React.createElement("select",{className:"form-select",value:z,onChange:v=>j(v.target.value)},React.createElement("option",{value:""},"\u{1F4C1} T\u1EA5t c\u1EA3 danh m\u1EE5c"),D.map(v=>React.createElement("option",{key:v,value:v},v)))),A?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"2.5rem",height:"2.5rem"}}),React.createElement("p",{className:"text-muted mt-3 mb-0"},"\u0110ang t\u1EA3i...")):ne.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-box-open"}),React.createElement("p",null,"Ch\u01B0a c\xF3 s\u1EA3n ph\u1EA9m n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:oe},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"product-list"},ne.map(v=>React.createElement("div",{key:v.id,className:"product-item d-flex align-items-center gap-3"},v.image?React.createElement("img",{src:v.image,alt:"",className:"product-img"}):React.createElement("div",{className:"product-img-placeholder"},React.createElement("i",{className:"fas fa-image text-muted"})),React.createElement("div",{className:"flex-grow-1 min-width-0"},React.createElement("div",{className:"product-name"},v.name),React.createElement("div",{className:"d-flex flex-wrap gap-1 mb-1"},v.category&&React.createElement("span",{className:"product-badge bg-info bg-opacity-75"},v.category),v.code&&React.createElement("span",{className:"product-badge bg-secondary"},v.code)),React.createElement("div",{className:"product-price"},v.price?v.price.replace(/[đ\s]/g,"")+"\u0111":"Li\xEAn h\u1EC7"),v.note&&React.createElement("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"}},v.note)),React.createElement("div",{className:"product-actions"},React.createElement("button",{className:"btn btn-edit",onClick:()=>F(v),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"btn btn-delete",onClick:()=>Y(v),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement(ProductModal,{show:d,product:f,categories:D,onClose:()=>w(!1),onSave:se}))}function ProductModal({show:x,product:u,categories:N,onClose:A,onSave:I}){const[d,w]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0}),[f,H]=useState(!1),[p,Q]=useState(!1);useEffect(()=>{w(u?{name:u.name||"",code:u.code||"",price:u.price||"",image:u.image||"",category:u.category||"",note:u.note||"",sort_order:u.sort_order||0}:{name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0})},[u,x]);const[z,j]=React.useState(""),D=C=>window.KTM.money.formatVNDInputDigits(C),[te,oe]=React.useState(""),F=C=>{const c=window.KTM.money.nextPriceInputState(C.target.value,te);oe(c.digits),w({...d,price:c.price})},[Z,se]=React.useState("");React.useEffect(()=>{u!=null&&u.image&&se(u.image)},[u]);const Y=async C=>{if(!(!C||!C.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:C},"L\u1ED7i x\xF3a \u1EA3nh")}catch(c){console.error("Delete cloudinary image error:",c)}},ne=async(C,c=2,W)=>{const he=c*1024*1024,Se=C.type==="image/heic"||C.type==="image/heif"||/\.heic$/i.test(C.name);if(C.size<=he&&!Se)return C;W==null||W("\u0110ang x\u1EED l\xFD \u1EA3nh...");try{const be=await createImageBitmap(C);W==null||W("\u0110ang n\xE9n \u1EA3nh...");const ce=document.createElement("canvas");let Ne=be.width,ae=be.height;const we=1200;return(Ne>we||ae>we)&&(Ne>ae?(ae=Math.round(ae/Ne*we),Ne=we):(Ne=Math.round(Ne/ae*we),ae=we)),ce.width=Ne,ce.height=ae,ce.getContext("2d").drawImage(be,0,0,Ne,ae),be.close(),new Promise((re,Me)=>{ce.toBlob(_e=>{_e?(W==null||W("Ho\xE0n t\u1EA5t!"),re(new File([_e],C.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"}))):Me(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(be){throw console.error("createImageBitmap error:",be),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},v=async C=>{var he,Se;const c=(he=C.target.files)==null?void 0:he[0];if(!c)return;if(!(c.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(c.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}Q(!0),j("\u0110ang chu\u1EA9n b\u1ECB...");try{const be=(c.size/1024/1024).toFixed(1);j(`File ${be}MB - \u0110ang n\xE9n...`);const ce=await ne(c,2,we=>{j(we)}),Ne=(ce.size/1024/1024).toFixed(1);j(`\u0110\xE3 n\xE9n: ${Ne}MB - \u0110ang upload...`);const ae=await window.KTM.cloudinary.uploadImage({file:ce,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});ae.secure_url?(d.image&&d.image!==Z&&Y(d.image),w(we=>({...we,image:ae.secure_url})),j("")):(console.error("Cloudinary error:",ae),alert("Upload th\u1EA5t b\u1EA1i: "+(((Se=ae.error)==null?void 0:Se.message)||"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh")),j(""))}catch(be){console.error("Upload error:",be),alert("L\u1ED7i: "+be.message),j("")}Q(!1),C.target.value=""},B=()=>{d.image&&(d.image!==Z&&Y(d.image),w(C=>({...C,image:""})))},me=async C=>{C.preventDefault(),H(!0),Z&&d.image&&Z!==d.image&&await Y(Z),Z&&!d.image&&await Y(Z),await I(d),H(!1)};return x?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down"},React.createElement("div",{className:"modal-content",style:{borderRadius:"16px",overflow:"hidden"}},React.createElement("div",{className:"modal-header border-0 py-3",style:{background:"linear-gradient(135deg, #ffc107 0%, #ffca2c 100%)"}},React.createElement("h6",{className:"modal-title fw-bold",style:{color:"#1a1a2e"}},React.createElement("i",{className:`fas ${u?"fa-edit":"fa-plus-circle"} me-2`}),u?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:A})),React.createElement("form",{onSubmit:me},React.createElement("div",{className:"modal-body py-4",style:{maxHeight:"65vh",overflowY:"auto",background:"#f8f9fa"}},React.createElement("div",{className:"text-center mb-4"},React.createElement("div",{className:"position-relative d-inline-block"},d.image?React.createElement(React.Fragment,null,React.createElement("img",{src:d.image,alt:"",style:{width:110,height:110,objectFit:"cover",borderRadius:"12px",boxShadow:"0 4px 15px rgba(0,0,0,0.15)"}}),React.createElement("button",{type:"button",className:"btn btn-danger position-absolute",onClick:B,style:{top:-10,right:-10,width:28,height:28,padding:0,borderRadius:"50%",boxShadow:"0 2px 8px rgba(220,53,69,0.4)"}},React.createElement("i",{className:"fas fa-times",style:{fontSize:"0.75rem"}}))):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:110,height:110,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd"}},React.createElement("i",{className:"fas fa-image fa-2x text-muted"}))),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"btn btn-warning btn-sm px-3",style:{borderRadius:"20px"}},React.createElement("i",{className:`fas ${p?"fa-spinner fa-spin":"fa-camera"} me-1`}),p?z||"\u0110ang x\u1EED l\xFD...":"Ch\u1ECDn \u1EA3nh",React.createElement("input",{type:"file",accept:"image/*",onChange:v,disabled:p,style:{position:"absolute",left:"-9999px",opacity:0,width:1,height:1}})),p&&z&&React.createElement("div",{className:"text-center mt-1",style:{fontSize:11,color:"#6c757d"}},z))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-tag me-1 text-warning"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:d.name,onChange:C=>w({...d,name:C.target.value}),required:!0,placeholder:"VD: Combo Van 3 tay + 2 xylanh",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-barcode me-1 text-info"}),"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:d.code,onChange:C=>w({...d,code:C.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1 text-success"}),"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:d.price,onChange:F,placeholder:"1.950.000\u0111",inputMode:"numeric",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-folder me-1 text-primary"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:d.category,onChange:C=>w({...d,category:C.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),N.map(C=>React.createElement("option",{key:C,value:C},C)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1 text-secondary"}),"Ghi ch\xFA"),React.createElement("input",{type:"text",className:"form-control",value:d.note,onChange:C=>w({...d,note:C.target.value}),placeholder:"VD: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"URL \u1EA3nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",placeholder:"https://...",value:d.image,onChange:C=>w({...d,image:C.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"10px",fontSize:"0.9rem"}}))),React.createElement("div",{className:"modal-footer border-0 py-3",style:{background:"#fff"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:A,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:f,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},f?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}function VideoModal({show:x,video:u,onClose:N,onSave:A}){const[I,d]=useState({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),[w,f]=useState(!1),[H,p]=useState("");useEffect(()=>{u?(d({title:u.title||"",youtube_url:`https://www.youtube.com/watch?v=${u.youtubeId}`,thumbnail_url:u.thumb||"",sort_order:u.sortOrder||0}),p(u.thumb)):(d({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),p(""))},[u,x]);const Q=D=>{const te=D.match(/(?:youtube\.com\/(?:embed\/|watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return te?te[1]:null},z=D=>{d({...I,youtube_url:D});const te=Q(D);te&&p(`https://img.youtube.com/vi/${te}/hqdefault.jpg`)},j=async D=>{D.preventDefault(),f(!0),await A(I),f(!1)};return x?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},u?"S\u1EEDa Video":"Th\xEAm Video m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:N})),React.createElement("form",{onSubmit:j},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Link YouTube *"),React.createElement("input",{type:"url",className:"form-control",value:I.youtube_url,onChange:D=>z(D.target.value),placeholder:"https://www.youtube.com/watch?v=... ho\u1EB7c shorts/...",required:!0}),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3: youtube.com/watch, youtu.be, youtube.com/shorts")),H&&React.createElement("div",{className:"mb-3 text-center"},React.createElement("img",{src:H,alt:"Preview",className:"img-fluid rounded",style:{maxHeight:"150px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ti\xEAu \u0111\u1EC1 *"),React.createElement("input",{type:"text",className:"form-control",value:I.title,onChange:D=>d({...I,title:D.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:I.sort_order,onChange:D=>d({...I,sort_order:parseInt(D.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Thumbnail t\xF9y ch\u1EC9nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",value:I.thumbnail_url,onChange:D=>d({...I,thumbnail_url:D.target.value}),placeholder:"\u0110\u1EC3 tr\u1ED1ng s\u1EBD d\xF9ng thumbnail m\u1EB7c \u0111\u1ECBnh c\u1EE7a YouTube"}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:N},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:w},w?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function AdminApp(){const[x,u]=useState(!1),[N,A]=useState(""),[I,d]=useState(null),[w,f]=useState("search"),[H,p]=useState(null),[Q,z]=useState(""),[j,D]=useState([]),[te,oe]=useState(null),[F,Z]=useState(!1),[se,Y]=useState(null),[ne,v]=useState(!0),[B,me]=useState([]),[C,c]=useState(null),[W,he]=useState([]);useEffect(()=>{const a=localStorage.getItem("ktm_admin_session");if(a)try{const i=JSON.parse(a);i.expiry>Date.now()?(u(!0),d(i.user)):localStorage.removeItem("ktm_admin_session")}catch(i){localStorage.removeItem("ktm_admin_session")}},[]),useEffect(()=>{x&&ae()},[x]);const Se=async(a,i)=>{A("");try{const O=await window.KTM.api.postJSON(`${API_BASE}/api/auth/login`,{username:a,password:i},"\u0110\u0103ng nh\u1EADp th\u1EA5t b\u1EA1i"),fe={user:O.user,token:O.token,expiry:Date.now()+100*365*24*60*60*1e3};localStorage.setItem("ktm_admin_session",JSON.stringify(fe)),d(O.user),u(!0)}catch(O){A(O.message)}},be=()=>{localStorage.removeItem("ktm_admin_session"),u(!1),d(null),D([]),oe(null)},ce=(a,i="success")=>{const O=Date.now();me(fe=>[...fe,{id:O,message:a,type:i}])},Ne=a=>{me(i=>i.filter(O=>O.id!==a))},ae=async(a=null)=>{v(!0);try{const i=a?`${API_BASE}/api/albums?parent_id=${a}`:`${API_BASE}/api/albums?parent_id=root`,O=await window.KTM.api.getJSON(i,"L\u1ED7i t\u1EA3i danh s\xE1ch album");D(Array.isArray(O)?O:[])}catch(i){console.error(i),ce("L\u1ED7i t\u1EA3i danh s\xE1ch album","danger")}v(!1)},we=()=>{Y(null),Z(!0)},ie=a=>{Y(a),Z(!0)},re=async a=>{try{const i=se&&se.uuid;!i&&C&&(a.parent_id=C.uuid);const O=i?`${API_BASE}/api/albums/${se.uuid||se.id}`:`${API_BASE}/api/albums`;i?await window.KTM.api.putJSON(O,a,"L\u1ED7i c\u1EADp nh\u1EADt"):await window.KTM.api.postJSON(O,a,"L\u1ED7i t\u1EA1o"),ce(i?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"T\u1EA1o th\xE0nh c\xF4ng!","success"),Z(!1),ae(C==null?void 0:C.uuid)}catch(i){ce(i.message,"danger")}},Me=a=>{oe(a)},_e=a=>{if(a==="root")he([]),c(null),ae(null);else if(a){const i=W.findIndex(O=>O.uuid===a.uuid);i>=0&&(he(W.slice(0,i+1)),c(a),ae(a.uuid))}else{const i=[...W];i.pop();const O=i[i.length-1]||null;he(i),c(O),ae(O==null?void 0:O.uuid)}},Ce=async a=>{const i=`X\xF3a folder "${a.title}"? T\u1EA5t c\u1EA3 folder con v\xE0 \u1EA3nh b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`;if(confirm(i))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${a.uuid||a.id}`,"L\u1ED7i x\xF3a album"),ce("\u0110\xE3 x\xF3a","success"),ae(C==null?void 0:C.uuid)}catch(O){ce("L\u1ED7i x\xF3a album","danger")}};if(!x)return React.createElement(LoginPage,{onLogin:Se,error:N});const $e=()=>{const a=new Date,i=a.getFullYear(),O=String(a.getMonth()+1).padStart(2,"0");return`${i}-${O}`};function Pe(){const[a,i]=useState($e()),[O,fe]=useState(!0),[Ae,Qe]=useState([]),{parseMoney:Le,parseShipFeeFromNote:Fe,getShipFeeForItems:Ze,formatNumber:U,formatVND:xe}=window.KTM.money,qe=async()=>{fe(!0);try{const _=await window.KTM.api.getJSON(`${API_BASE}/api/orders?month=${encodeURIComponent(a)}`,"L\u1ED7i t\u1EA3i th\u1ED1ng k\xEA");Qe(Array.isArray(_)?_:[])}catch(_){console.error("Load stats error:",_),Qe([])}finally{fe(!1)}};useEffect(()=>{qe()},[a]);const J=React.useMemo(()=>{var Xe;const _={pending:0,processing:0,done:0,paid:0,other:0};let Ue=0,ue=0,et=0,it=0,Je=0;const De=X=>X.customer_id||X.phone||"unknown",tt=X=>window.KTM.orders.getOrderItems(X),o=new Map,T=new Map,le=new Map;for(const X of Ae){const t=tt(X);let h=0,g=0;for(const L of t){const de=Number((L==null?void 0:L.quantity)||0)||0,ye=Le(L==null?void 0:L.product_price),je=de*ye;h+=de,g+=je;const Ve=(L==null?void 0:L.product_id)||"unknown",ge=o.get(Ve)||{product_id:Ve,product_name:(L==null?void 0:L.product_name)||"\u2014",product_code:(L==null?void 0:L.product_code)||"",orders:0,quantity:0,revenue:0};ge.orders+=1,ge.quantity+=de,ge.revenue+=je,o.set(Ve,ge)}const k=Ze(t),M=Number((Xe=X==null?void 0:X.adjustment_amount)!=null?Xe:0)||0,b=g+(k.found?k.fee:0)+M,m=g+M;Ue+=h,ue+=b,it+=m;const $=X.status==="done"||X.status==="paid";X.status==="pending"?_.pending+=1:X.status==="processing"?_.processing+=1:X.status==="paid"?(_.paid+=1,_.done+=1,et+=b,Je+=m):X.status==="done"?(_.done+=1,et+=b,Je+=m):_.other+=1;const P=De(X),ee=T.get(P)||{key:P,customer_name:X.customer_name||"",phone:X.phone||"",orders:0,quantity:0,revenue:0};ee.orders+=1,ee.quantity+=h,ee.revenue+=b,!ee.customer_name&&X.customer_name&&(ee.customer_name=X.customer_name),!ee.phone&&X.phone&&(ee.phone=X.phone),T.set(P,ee);const q=X.created_at?new Date(X.created_at):null;if(q&&!Number.isNaN(q.getTime())){const L=`${q.getFullYear()}-${String(q.getMonth()+1).padStart(2,"0")}-${String(q.getDate()).padStart(2,"0")}`,de=le.get(L)||{day:L,orders:0,quantity:0,revenue:0,doneOrders:0,doneRevenue:0};de.orders+=1,de.quantity+=h,de.revenue+=b,$&&(de.doneOrders+=1,de.doneRevenue+=b),le.set(L,de)}}const Te=Array.from(o.values()).sort((X,t)=>t.revenue-X.revenue),ke=Array.from(T.values()).sort((X,t)=>t.revenue-X.revenue),Ie=Array.from(le.values()).sort((X,t)=>X.day.localeCompare(t.day)),Ke=T.size,Oe=Ae.length?Math.round(ue/Ae.length):0,ze=Ae.length?Ue/Ae.length:0,at=Math.round(Je*.05),st=Math.round(it*.05);return{statusCounts:_,totalQty:Ue,totalRevenue:ue,doneRevenue:et,tempCommission:at,tempCommissionAll:st,products:Te,customers:ke,days:Ie,uniqueCustomers:Ke,avgOrderValue:Oe,avgQtyPerOrder:ze}},[Ae,a]);return React.createElement("div",{className:"product-manager pb-5 mb-4 stats-manager"},React.createElement(Loading,{show:O}),React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-chart-column me-2 text-warning"}),"Th\u1ED1ng k\xEA"),React.createElement("button",{className:"btn btn-outline-secondary btn-sm",onClick:qe,disabled:O},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"Ch\u1ECDn th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:a,onChange:_=>i(_.target.value),"aria-label":"Ch\u1ECDn th\xE1ng"}))),React.createElement("div",{className:"col-12 col-md-7 d-flex gap-2 justify-content-md-end"},React.createElement("div",{className:"d-flex flex-wrap gap-2 align-self-center"},React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-receipt me-1"}),U(Ae.length)," \u0111\u01A1n"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-user me-1"}),U(J.uniqueCustomers)," kh\xE1ch"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-boxes-stacked me-1"}),U(J.totalQty)," SL"),React.createElement("span",{className:"badge rounded-pill bg-primary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-hand-holding-dollar me-1"}),"\u0110\xE3 nh\u1EADn ti\u1EC1n: ",U(J.statusCounts.paid),"/",U(J.statusCounts.done)))))),React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng \u0111\u01A1n"),React.createElement("i",{className:"fas fa-receipt text-dark"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},U(Ae.length)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (t\u1EA1m t\xEDnh)"),React.createElement("i",{className:"fas fa-sack-dollar text-warning"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},xe(J.totalRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (Ho\xE0n th\xE0nh)"),React.createElement("i",{className:"fas fa-circle-check text-success"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},xe(J.doneRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-info bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng s\u1EBD nh\u1EADn (t\u1EA1m t\xEDnh 5% - kh\xF4ng g\u1ED3m ship)"),React.createElement("i",{className:"fas fa-chart-line text-info"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},xe(J.tempCommission)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng t\u1ED5ng (t\u1EA1m t\xEDnh 5% - kh\xF4ng g\u1ED3m ship)"),React.createElement("i",{className:"fas fa-coins text-primary"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},xe(J.tempCommissionAll))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-layer-group me-2 text-warning"}),"T\u1ED5ng quan tr\u1EA1ng th\xE1i"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},"SL TB/\u0111\u01A1n: ",J.avgQtyPerOrder?J.avgQtyPerOrder.toFixed(2):"0.00")),React.createElement("div",{className:"d-md-none mt-2"},React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-secondary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("div",{className:"fw-semibold"},U(J.statusCounts.pending)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("div",{className:"fw-semibold"},U(J.statusCounts.processing)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh"),React.createElement("div",{className:"fw-semibold"},U(J.statusCounts.done)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("div",{className:"fw-semibold"},U(J.statusCounts.paid)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng SL"),React.createElement("div",{className:"fw-semibold"},U(J.totalQty)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Ch\u1EDD x\u1EED l\xFD"),React.createElement("th",null,"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("th",null,"Ho\xE0n th\xE0nh"),React.createElement("th",null,"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("th",null,"Kh\xE1c"),React.createElement("th",null,"T\u1ED5ng SL"))),React.createElement("tbody",null,React.createElement("tr",null,React.createElement("td",null,U(J.statusCounts.pending)),React.createElement("td",null,U(J.statusCounts.processing)),React.createElement("td",null,U(J.statusCounts.done)),React.createElement("td",null,U(J.statusCounts.paid)),React.createElement("td",null,U(J.statusCounts.other)),React.createElement("td",null,U(J.totalQty))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-box me-2 text-info"}),"Top s\u1EA3n ph\u1EA9m"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},J.products.slice(0,10).map(_=>React.createElement("div",{key:_.product_id,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-info"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},_.product_name),React.createElement("div",{className:"text-muted small text-truncate"},_.product_code?`#${_.product_code} \u2022 `:"",U(_.orders)," \u0111\u01A1n \u2022 ",U(_.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},xe(_.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"M\xE3"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,J.products.slice(0,10).map(_=>React.createElement("tr",{key:_.product_id},React.createElement("td",null,_.product_name),React.createElement("td",null,_.product_code||"\u2014"),React.createElement("td",null,U(_.orders)),React.createElement("td",null,U(_.quantity)),React.createElement("td",{className:"fw-semibold"},xe(_.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-user-group me-2 text-warning"}),"Top kh\xE1ch h\xE0ng"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},J.customers.slice(0,10).map(_=>React.createElement("div",{key:_.key,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-warning"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},_.customer_name||"\u2014"),React.createElement("div",{className:"text-muted small text-truncate"},_.phone||"\u2014"," \u2022 ",U(_.orders)," \u0111\u01A1n \u2022 ",U(_.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},xe(_.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,J.customers.slice(0,10).map(_=>React.createElement("tr",{key:_.key},React.createElement("td",null,_.customer_name||"\u2014"),React.createElement("td",null,_.phone||"\u2014"),React.createElement("td",null,U(_.orders)),React.createElement("td",null,U(_.quantity)),React.createElement("td",{className:"fw-semibold"},xe(_.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3 mb-4"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-calendar-day me-2 text-success"}),"Theo ng\xE0y"),React.createElement("span",{className:"badge rounded-pill bg-success bg-opacity-10 text-dark"},"DT (t\u1EA1m t\xEDnh) & ho\xE0n th\xE0nh")),React.createElement("div",{className:"d-md-none mt-2"},J.days.map(_=>React.createElement("div",{key:_.day,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-success"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"fw-semibold"},_.day),React.createElement("div",{className:"text-muted small"},U(_.orders)," \u0111\u01A1n \u2022 ",U(_.quantity)," SL"),React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh: ",U(_.doneOrders)," \u2022 ",xe(_.doneRevenue))),React.createElement("div",{className:"fw-semibold text-nowrap"},xe(_.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Ng\xE0y"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"DT (t\u1EA1m t\xEDnh)"),React.createElement("th",null,"\u0110\u01A1n ho\xE0n th\xE0nh"),React.createElement("th",null,"DT ho\xE0n th\xE0nh"))),React.createElement("tbody",null,J.days.map(_=>React.createElement("tr",{key:_.day},React.createElement("td",null,_.day),React.createElement("td",null,U(_.orders)),React.createElement("td",null,U(_.quantity)),React.createElement("td",{className:"fw-semibold"},xe(_.revenue)),React.createElement("td",null,U(_.doneOrders)),React.createElement("td",{className:"fw-semibold"},xe(_.doneRevenue)))))))))}return React.createElement("div",null,React.createElement(Sidebar,{activeMenu:w,onMenuChange:a=>{f(a),a==="albums"&&(c(null),he([]),ae(null))},onLogout:be,currentUser:I}),React.createElement("div",{className:"main-content"},w==="albums"&&!te&&React.createElement(AlbumList,{albums:j,loading:ne,currentFolder:C,breadcrumb:W,onSelect:Me,onCreate:we,onEdit:ie,onDelete:Ce,onBack:_e}),w==="search"&&React.createElement(SearchCenter,{showToast:ce,onNavigate:(a,i,O)=>{f(a),a==="orders"&&i==="create"&&(p(Date.now()),z((O==null?void 0:O.productId)||""))}}),w==="albums"&&te&&React.createElement(AlbumDetail,{album:te,parentAlbum:W.length>0?W[W.length-1]:null,onBack:()=>{if(te.parentId){const a=W.findIndex(i=>i.uuid===te.parentId);a>=0?oe(W[a]):oe(null)}else oe(null)},onRefresh:()=>ae(C==null?void 0:C.uuid),showToast:ce,onNavigateToFolder:a=>{he(i=>[...i,te]),oe(a)},onEditSubfolder:a=>{Y(a),Z(!0)}}),w==="videos"&&React.createElement(VideoList,{showToast:ce}),w==="products"&&React.createElement(ProductManager,{showToast:ce}),w==="orders"&&React.createElement(OrderManager,{autoOpenCreateToken:H,autoOpenCreateProductId:Q,showToast:ce}),w==="stats"&&React.createElement(Pe,null)),React.createElement("nav",{className:"mobile-bottom-nav"},React.createElement("div",{className:"nav-items"},React.createElement("a",{href:"#",className:`nav-item ${w==="search"?"active":""}`,onClick:a=>{a.preventDefault(),f("search")}},React.createElement("i",{className:"fas fa-search"}),React.createElement("span",null,"Tra c\u1EE9u")),React.createElement("a",{href:"#",className:`nav-item ${w==="albums"?"active":""}`,onClick:a=>{a.preventDefault(),f("albums"),oe(null)}},React.createElement("i",{className:"fas fa-images"}),React.createElement("span",null,"Album")),React.createElement("a",{href:"#",className:`nav-item ${w==="videos"?"active":""}`,onClick:a=>{a.preventDefault(),f("videos")}},React.createElement("i",{className:"fas fa-video"}),React.createElement("span",null,"Video")),React.createElement("a",{href:"#",className:`nav-item ${w==="products"?"active":""}`,onClick:a=>{a.preventDefault(),f("products")}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",null,"S\u1EA3n ph\u1EA9m")),React.createElement("a",{href:"#",className:`nav-item ${w==="orders"?"active":""}`,onClick:a=>{a.preventDefault(),f("orders")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",null,"\u0110\u01A1n h\xE0ng")),React.createElement("a",{href:"#",className:`nav-item ${w==="stats"?"active":""}`,onClick:a=>{a.preventDefault(),f("stats")}},React.createElement("i",{className:"fas fa-chart-column"}),React.createElement("span",null,"Th\u1ED1ng k\xEA")))),React.createElement(AlbumModal,{show:F,album:se,parentId:C==null?void 0:C.uuid,onClose:()=>Z(!1),onSave:re}),React.createElement("div",{className:"toast-container"},B.map(a=>React.createElement(Toast,{key:a.id,message:a.message,type:a.type,onClose:()=>Ne(a.id)}))))}ReactDOM.render(React.createElement(AdminApp,null),document.getElementById("root"));function OrderManager({autoOpenCreateToken:x,autoOpenCreateProductId:u,showToast:N}){const[A,I]=useState([]),[d,w]=useState(!0),[f,H]=useState(!1),[p,Q]=useState(null),[z,j]=useState(null),[D,te]=useState(!1),[oe,F]=useState(""),[Z,se]=useState(!1),[Y,ne]=useState(null),[v,B]=useState(!1),[me,C]=useState([]),[c,W]=useState({customer_name:"",phone:"",address:"",items:[{product_id:"",quantity:1}],adjustment_amount:0,adjustment_note:"",status:"pending"}),[he,Se]=useState([""]),[be,ce]=useState(null),Ne=useRef({}),[ae,we]=useState([]),[ie,re]=useState(null),Me=useRef(null),_e=useRef(null),Ce=useRef(0),$e=useRef(new Map),Pe=useRef(""),a=useRef(null),i=useRef(0),O=useRef(null),fe=9,Ae=150,Qe=24*60*60*1e3,Le=5*60*1e3,Fe="ktm_customer_lookup_cache_v1",Ze=200,U=e=>{W({customer_name:"",phone:"",address:"",items:[{product_id:e||"",quantity:1}],adjustment_amount:0,adjustment_note:"",status:"pending"}),Se([""]),ne(null),ce(null)};useEffect(()=>{const e=n=>{var l;if(be==null)return;const s=(l=Ne.current)==null?void 0:l[be];s&&!s.contains(n.target)&&ce(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[be]);const xe=e=>window.KTM.money.parseMoney(e),qe=e=>window.KTM.money.parseSignedMoney(e),J=e=>window.KTM.money.formatVND(e),_=e=>window.KTM.money.parseShipFeeFromNote(e),Ue=e=>window.KTM.phone.isValid(e),ue=e=>window.KTM.phone.normalize(e),et=()=>{var e;try{const n=localStorage.getItem(Fe);if(!n)return;const s=JSON.parse(n);if(!s||typeof s!="object")return;const l=Object.entries(s);for(const[r,S]of l)!r||!S||typeof S!="object"||(e=$e.current)==null||e.set(String(r),S)}catch(n){}},it=()=>{try{const e=$e.current;if(!e||typeof e.entries!="function")return;const n=Array.from(e.entries()).filter(([l,r])=>l&&r&&typeof r=="object"&&Number.isFinite(r.ts)).sort((l,r)=>(Number(r[1].ts)||0)-(Number(l[1].ts)||0)).slice(0,Ze),s={};for(const[l,r]of n)s[l]=r;localStorage.setItem(Fe,JSON.stringify(s))}catch(e){}};useEffect(()=>{et()},[]);const Je=e=>{const n=ue(e);if(!n)return null;const s=Array.isArray(A)?A:[];let l=null,r=-1;for(const S of s){if(!S||ue(S.phone||"")!==n)continue;const G=new Date(S.created_at).getTime(),E=Number.isFinite(G)?G:0;E>=r&&(r=E,l=S)}return l?{name:String(l.customer_name||"").trim(),address:String(l.address||"").trim()}:null},De=(e,n)=>{e&&W(s=>n&&ue(s.phone)!==n?s:{...s,customer_name:e.name||s.customer_name,address:e.address||s.address})},tt=e=>{const n=Je(e);if(!n)return;const s=ue(e);W(l=>{if(s&&ue(l.phone)!==s)return l;const r={...l};return!String(l.customer_name||"").trim()&&n.name&&(r.customer_name=n.name),!String(l.address||"").trim()&&n.address&&(r.address=n.address),r})},o=async e=>{var r,S,G;const n=ue(e);if(!n)return;tt(n);const s=(r=$e.current)==null?void 0:r.get(n);if(s&&Number.isFinite(s.ts)){const E=Date.now()-s.ts,y=s.status==="found"?Qe:Le;if(E>=0&&E<=y){ne({status:s.status,phone:n,customer:s.customer}),s.status==="found"&&s.customer&&De(s.customer,n);return}}const l=++Ce.current;ne({status:"loading",phone:n});try{const E=await window.KTM.api.getJSON(`${API_BASE}/api/customers?phone=${encodeURIComponent(n)}`,"L\u1ED7i tra c\u1EE9u kh\xE1ch");if(Ce.current!==l)return;if(E&&E.exists&&E.customer){(S=$e.current)==null||S.set(n,{ts:Date.now(),status:"found",customer:E.customer}),it(),ne({status:"found",phone:n,customer:E.customer}),De(E.customer,n);return}(G=$e.current)==null||G.set(n,{ts:Date.now(),status:"not-found",customer:null}),it(),ne({status:"not-found",phone:n})}catch(E){if(Ce.current!==l)return;console.error("Customer lookup error:",E),ne({status:"error",phone:n})}},T=e=>{const n=ue(e),s=Je(n);W(r=>{const S={...r,phone:n};return s&&(!String(r.customer_name||"").trim()&&s.name&&(S.customer_name=s.name),!String(r.address||"").trim()&&s.address&&(S.address=s.address)),S}),B(!1),_e.current&&(clearTimeout(_e.current),_e.current=null);const l=n;if(l.length<fe){ne(null);return}if(Ue(l)&&l!==Pe.current){Pe.current=l,o(l);return}_e.current=setTimeout(()=>{const r=ue(n);Ue(r)&&r!==Pe.current&&(Pe.current=r,o(r))},Ae)},le=()=>{const e=ue(c.phone);e.length<fe||Ue(e)&&e!==Pe.current&&(Pe.current=e,o(e))};useEffect(()=>(Z?(document.body.classList.add("order-modal-open"),document.body.style.overflow="hidden"):(document.body.classList.remove("order-modal-open"),document.body.style.overflow=""),()=>{document.body.classList.remove("order-modal-open"),document.body.style.overflow=""}),[Z]);const Te=Array.isArray(c.items)?c.items.length:0;useEffect(()=>{if(!Z){i.current=Te;return}Te>i.current&&setTimeout(()=>{const e=a.current;e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},0),i.current=Te},[Z,Te]),useEffect(()=>()=>{_e.current&&(clearTimeout(_e.current),_e.current=null)},[]),useEffect(()=>{ze()},[]),useEffect(()=>{at()},[oe]),useEffect(()=>{x&&Me.current!==x&&(Me.current=x,Xe(u))},[x]);const ke=e=>e==="pending"?"Ch\u1EDD x\u1EED l\xFD":e==="processing"?"\u0110ang v\u1EADn chuy\u1EC3n":e==="done"?"Ho\xE0n th\xE0nh":e==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":e||"",Ie=e=>e==="pending"?"bg-secondary":e==="processing"?"bg-warning text-dark":e==="done"?"bg-success":e==="paid"?"bg-primary":"bg-light text-dark",Ke=React.useMemo(()=>window.KTM.orders.sortOrders(A),[A]),Oe=e=>window.KTM.date.formatDateTime(e),ze=async()=>{try{const e=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");we(Array.isArray(e)?e:[])}catch(e){console.error("Load products error:",e),we([])}},at=async()=>{w(!0);try{let e=`${API_BASE}/api/orders`;oe&&(e+=`?month=${oe}`);const n=await window.KTM.api.getJSON(e,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng");I(Array.isArray(n)?n:[])}catch(e){console.error("Load orders error:",e),I([])}finally{w(!1)}},st=e=>{var s;re(e.id);const n=Array.isArray(e.items)&&e.items.length?e.items.map(l=>{var r;return{product_id:(l==null?void 0:l.product_id)||"",quantity:Number((r=l==null?void 0:l.quantity)!=null?r:1)||1}}).filter(l=>l.product_id):[{product_id:e.product_id||"",quantity:Number(e.quantity||1)||1}];W({customer_name:e.customer_name||"",phone:ue(e.phone||""),address:e.address||"",items:n.length?n:[{product_id:"",quantity:1}],adjustment_amount:Number((s=e==null?void 0:e.adjustment_amount)!=null?s:0)||0,adjustment_note:(e==null?void 0:e.adjustment_note)||"",status:e.status||"pending"}),Se(new Array(n.length?n.length:1).fill("")),C(new Array(n.length?n.length:1).fill(!0)),ne(null),se(!0),e.phone&&o(ue(e.phone))};function Xe(e){re(null),U(e||""),B(!1),C([]),se(!0)}const X=()=>{f||D||(se(!1),re(null),U(""),B(!1),C([]))},t=async()=>{var E,y,V;if(!ie||D||f)return;const e=(Array.isArray(A)?A:[]).find(K=>String(K==null?void 0:K.id)===String(ie))||null,n=String((e==null?void 0:e.status)||(c==null?void 0:c.status)||"").trim();if(n==="done"||n==="paid"){const K="Kh\xF4ng th\u1EC3 t\xE1ch: \u0111\u01A1n \u0111\xE3 ho\xE0n th\xE0nh/\u0111\xE3 nh\u1EADn ti\u1EC1n.";typeof N=="function"?N(K,"warning"):alert(K);return}const s=ue(c.phone),r=(Array.isArray(c.items)?c.items:[]).map((K,ve)=>{var pe;return{idx:ve,product_id:String((K==null?void 0:K.product_id)||"").trim(),quantity:Number((pe=K==null?void 0:K.quantity)!=null?pe:0)}}).filter(K=>K.product_id&&Number.isFinite(K.quantity)&&K.quantity>0);if(r.length<2){const K="C\u1EA7n \xEDt nh\u1EA5t 2 s\u1EA3n ph\u1EA9m \u0111\u1EC3 t\xE1ch \u0111\u01A1n.";typeof N=="function"?N(K,"warning"):alert(K);return}const S=[],G=[];for(const K of r){const ve=!!me[K.idx],pe={product_id:K.product_id,quantity:K.quantity};ve?S.push(pe):G.push(pe)}if(!S.length||!G.length){const K="Ch\u1ECDn m\u1ED9t s\u1ED1 s\u1EA3n ph\u1EA9m \u201CGiao \u0111\u1EE3t 1\u201D, v\xE0 \u0111\u1EC3 l\u1EA1i \xEDt nh\u1EA5t 1 s\u1EA3n ph\u1EA9m \u201CCh\u1EDD h\xE0ng\u201D.";typeof N=="function"?N(K,"warning"):alert(K);return}te(!0);try{const K=qe(c.adjustment_amount),ve=(c.adjustment_note||"").trim(),pe={customer_name:c.customer_name,phone:s,address:c.address,adjustment_amount:K,adjustment_note:ve,status:"processing",items:S,product_id:S[0].product_id,quantity:S[0].quantity,split_seq:1},We=await window.KTM.api.postJSON(`${API_BASE}/api/orders`,pe,"L\u1ED7i t\xE1ch \u0111\u01A1n (t\u1EA1o \u0111\u01A1n giao ngay)"),Ye=(V=(y=We==null?void 0:We.id)!=null?y:(E=We==null?void 0:We.order)==null?void 0:E.id)!=null?V:null;if(!Ye)throw new Error("T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i: kh\xF4ng nh\u1EADn \u0111\u01B0\u1EE3c ID \u0111\u01A1n giao ngay");const mt={id:ie,customer_name:c.customer_name,phone:s,address:c.address,adjustment_amount:0,adjustment_note:"",status:"pending",items:G,product_id:G[0].product_id,quantity:G[0].quantity,parent_order_id:String(Ye),split_seq:2};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${ie}`,mt,"L\u1ED7i t\xE1ch \u0111\u01A1n (c\u1EADp nh\u1EADt ph\u1EA7n ch\u1EDD h\xE0ng)"),X(),at();const ot=Ye?`\u0110\xE3 t\xE1ch \u0111\u01A1n. \u0110\u01A1n giao ngay: #${Ye}`:"\u0110\xE3 t\xE1ch \u0111\u01A1n.";typeof N=="function"?N(ot,"success"):alert(ot)}catch(K){console.error(K);const ve=(K==null?void 0:K.message)||"T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i";typeof N=="function"?N(ve,"danger"):alert(ve)}finally{te(!1)}},h=e=>{if(!e)return"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --";const n=String(e),s=ae.find(l=>String(l==null?void 0:l.id)===n);return s?`${s.name}${s.code?` (${s.code})`:""}`:"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"},g=e=>{const n=String(he[e]||"").trim().toLowerCase();return n?ae.filter(s=>{const l=String((s==null?void 0:s.name)||"").toLowerCase(),r=String((s==null?void 0:s.code)||"").toLowerCase();return l.includes(n)||r.includes(n)}):ae},k=e=>{if(!e)return null;const n=String(e);return ae.find(s=>String(s==null?void 0:s.id)===n)||null},M=e=>window.KTM.orders.getOrderItems(e),b=e=>window.KTM.orders.getOrderTotalQty(e),m=e=>window.KTM.orders.getOrderProductSummary(e,k),$=e=>window.KTM.orders.getOrderItemRows(e,k),P=e=>window.KTM.orders.getOrderAdjustmentMoney(e),ee=e=>{var V;const n=M(e),s=$(e),l=de(n),r=L(n),S=r.fee,G=P(e),E=l+S+G,y=[];if(y.push(`\u0110\u01A0N H\xC0NG #${(V=e==null?void 0:e.id)!=null?V:""}`.trim()),e!=null&&e.customer_name&&y.push(`Kh\xE1ch: ${e.customer_name}`),e!=null&&e.phone&&y.push(`S\u0110T: ${e.phone}`),e!=null&&e.address&&y.push(`\u0110\u1ECBa ch\u1EC9: ${e.address}`),e!=null&&e.status&&y.push(`Tr\u1EA1ng th\xE1i: ${ke(e.status)}`),e!=null&&e.created_at&&y.push(`Th\u1EDDi gian: ${Oe(e.created_at)}`),y.push(""),y.push("S\u1EA3n ph\u1EA9m:"),s.length)for(const K of s)y.push(`- ${K.name} x${K.qty}`);else{const K=m(e);K&&K!=="\u2014"&&y.push(`- ${K}`)}return y.push(""),y.push(`T\u1EA1m t\xEDnh: ${J(l)}`),y.push(`Ship: ${J(r.found?S:0)}`),G!==0&&y.push(`\u0110i\u1EC1u ch\u1EC9nh: ${J(G)}`),e!=null&&e.adjustment_note&&y.push(`Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh: ${e.adjustment_note}`),y.push(`T\u1ED5ng: ${J(E)}`),y.filter(Boolean).join(`
`)},q=async e=>{try{const n=ee(e);await window.KTM.clipboard.writeText(n),typeof N=="function"?N("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng","success"):alert("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng")}catch(n){console.error(n),typeof N=="function"?N("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)","danger"):alert("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)")}},L=e=>window.KTM.orders.getOrderShipInfo(e,k),de=e=>window.KTM.orders.getItemsSubtotal(e,k),ye=e=>{try{const n=e instanceof Date?e:new Date(e);if(!n||Number.isNaN(n.getTime()))return"";const s=n.getFullYear(),l=String(n.getMonth()+1).padStart(2,"0");return`${s}-${l}`}catch(n){return""}},je=()=>oe?String(oe):ye(new Date),Ve=e=>{const n=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),s=ue((e==null?void 0:e.phone)||""),l=String((e==null?void 0:e.address)||"").trim().toLowerCase(),r=qe(e==null?void 0:e.adjustment_amount),G=(Array.isArray(e==null?void 0:e.items)?e.items:[]).map(E=>{var y;return{product_id:String((E==null?void 0:E.product_id)||"").trim(),quantity:Number((y=E==null?void 0:E.quantity)!=null?y:0)}}).filter(E=>E.product_id&&Number.isFinite(E.quantity)&&E.quantity>0).sort((E,y)=>E.product_id<y.product_id?-1:E.product_id>y.product_id?1:E.quantity-y.quantity);return JSON.stringify({name:n,phone:s,address:l,items:G,adj:r})},ge=React.useMemo(()=>{const e=ue((c==null?void 0:c.phone)||"");if(!e)return{count:0,orders:[],monthKey:je()};const n=je(),s=(Array.isArray(A)?A:[]).filter(l=>{if(!l||ie&&String(l.id)===String(ie)||ue(l.phone||"")!==e)return!1;const r=ye(l.created_at);return r&&r===n}).sort((l,r)=>{const S=new Date(l.created_at).getTime(),G=new Date(r.created_at).getTime();return(Number.isFinite(G)?G:0)-(Number.isFinite(S)?S:0)});return{count:s.length,orders:s,monthKey:n}},[A,c==null?void 0:c.phone,oe,ie]),Ge=e=>{var E;const n=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),s=ue((e==null?void 0:e.phone)||""),l=String((e==null?void 0:e.address)||"").trim().toLowerCase(),r=qe((E=e==null?void 0:e.adjustment_amount)!=null?E:0),S=M(e),G=(Array.isArray(S)?S:[]).map(y=>{var V;return{product_id:String((y==null?void 0:y.product_id)||"").trim(),quantity:Number((V=y==null?void 0:y.quantity)!=null?V:0)}}).filter(y=>y.product_id&&Number.isFinite(y.quantity)&&y.quantity>0).sort((y,V)=>y.product_id<V.product_id?-1:y.product_id>V.product_id?1:y.quantity-V.quantity);return JSON.stringify({name:n,phone:s,address:l,items:G,adj:r})},ct=React.useMemo(()=>{if(ie)return"";const e=ue((c==null?void 0:c.phone)||"");if(!e)return"";const n=je(),s=Ve(c),l=Array.isArray(A)?A:[];for(const r of l){if(!r||ie&&String(r.id)===String(ie)||ue(r.phone||"")!==e)continue;const S=ye(r.created_at);if(!S||S!==n)continue;const G=Ge(r);if(G&&G===s)return`\u0110\u01A1n n\xE0y gi\u1ED1ng 100% m\u1ED9t \u0111\u01A1n trong th\xE1ng ${n}${r!=null&&r.id?` (#${r.id})`:""}`}return""},[A,c,oe,ie]),ht=e=>{var ut;const n=[],s=[],l=String((e==null?void 0:e.customer_name)||"").trim(),r=ue((e==null?void 0:e.phone)||""),S=String((e==null?void 0:e.address)||"").trim();l||n.push("Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng"),r||n.push("Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i"),r&&!Ue(r)&&n.push("S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)"),S||s.push("Thi\u1EBFu \u0111\u1ECBa ch\u1EC9");const E=(Array.isArray(e==null?void 0:e.items)?e.items:[]).filter(nt=>nt&&nt.product_id);E.length===0&&n.push("Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m"),E.some(nt=>{var pt;const lt=Number((pt=nt==null?void 0:nt.quantity)!=null?pt:0);return!Number.isFinite(lt)||lt<=0})&&n.push("S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0");const V=new Set;let K=!1;for(const nt of E){const lt=String(nt.product_id||"").trim();if(lt){if(V.has(lt)){K=!0;break}V.add(lt)}}K&&s.push("S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)");const ve=de(E),pe=L(E),We=pe!=null&&pe.found?Number((ut=pe==null?void 0:pe.fee)!=null?ut:0):0,Ye=qe(e==null?void 0:e.adjustment_amount),mt=String((e==null?void 0:e.adjustment_note)||"").trim();pe!=null&&pe.found&&(We>=2e5||ve>0&&We>ve*.6)&&s.push(`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${J(We)}`),Ye!==0&&!mt&&s.push("C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh");const ot=Math.abs(Ye);return(ot>=5e5||ve>0&&ot>ve*.5)&&Ye!==0&&s.push(`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${J(Ye)}`),{errors:n,warnings:s,canSubmit:n.length===0}},bt=React.useMemo(()=>ht(c),[c,ae]),R=React.useMemo(()=>{var pt;const e=String((c==null?void 0:c.customer_name)||"").trim(),n=ue((c==null?void 0:c.phone)||""),s=String((c==null?void 0:c.address)||"").trim(),l=Array.isArray(c==null?void 0:c.items)?c.items:[],r=new Map;for(const Ee of l){const rt=String((Ee==null?void 0:Ee.product_id)||"").trim();rt&&r.set(rt,(r.get(rt)||0)+1)}const S=l.map(Ee=>{var ft;const rt=String((Ee==null?void 0:Ee.product_id)||"").trim(),gt=Number((ft=Ee==null?void 0:Ee.quantity)!=null?ft:0),vt=rt?"":"Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m",Nt=Number.isFinite(gt)&&gt>0?"":"S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0",yt=rt&&(r.get(rt)||0)>1?"S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)":"";return{productError:vt,qtyError:Nt,dupWarn:yt}}),G=l.filter(Ee=>Ee&&Ee.product_id),E=de(G),y=L(G),V=y!=null&&y.found?Number((pt=y==null?void 0:y.fee)!=null?pt:0):0,K=qe(c==null?void 0:c.adjustment_amount),ve=String((c==null?void 0:c.adjustment_note)||"").trim(),pe=Math.abs(K),We=K!==0&&!ve?"C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh":"",Ye=K!==0&&(pe>=5e5||E>0&&pe>E*.5)?`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${J(K)}`:"",mt=y!=null&&y.found&&(V>=2e5||E>0&&V>E*.6)?`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${J(V)}`:"",ot=e?"":"Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng",ut=n?Ue(n)?"":"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)":"Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",nt=s?"":"Thi\u1EBFu \u0111\u1ECBa ch\u1EC9",lt=!ot&&!ut&&S.every(Ee=>!Ee.productError&&!Ee.qtyError);return{nameError:ot,phoneError:ut,addressWarn:nt,items:S,shipAbnormalWarn:mt,adjustmentNoteWarn:We,adjustmentAbnormalWarn:Ye,canSubmit:lt}},[c,ae]),He=async e=>{var G,E,y;const n=(e==null?void 0:e.mode)||"close",s=ht(c);if(!s.canSubmit){const V=s.errors[0]||"Thi\u1EBFu d\u1EEF li\u1EC7u b\u1EAFt bu\u1ED9c";typeof N=="function"?N(V,"danger"):alert(V);return}if(!ie&&ct){const V=`${ct}

B\u1EA1n c\xF3 mu\u1ED1n ti\u1EBFp t\u1EE5c l\u01B0u kh\xF4ng?`;if(!window.confirm(V)){(ge==null?void 0:ge.count)>0&&B(!0),setTimeout(()=>{var pe;const ve=document.getElementById("order-phone-input");ve&&typeof ve.scrollIntoView=="function"&&(ve.scrollIntoView({block:"center",behavior:"smooth"}),(pe=ve.focus)==null||pe.call(ve))},0);return}}const l=ue(c.phone),S=(Array.isArray(c.items)?c.items:[]).map(V=>{var K;return{product_id:(V==null?void 0:V.product_id)||"",quantity:Number((K=V==null?void 0:V.quantity)!=null?K:1)}}).filter(V=>V.product_id&&Number.isFinite(V.quantity)&&V.quantity>0);H(!0);try{const V=ie?`${API_BASE}/api/orders/${ie}`:`${API_BASE}/api/orders`,K=S[0],ve={customer_name:c.customer_name,phone:l,address:c.address,adjustment_amount:qe(c.adjustment_amount),adjustment_note:(c.adjustment_note||"").trim(),product_id:K.product_id,quantity:K.quantity,status:c.status,items:S,...ie?{id:ie}:{}};if(ie)await window.KTM.api.putJSON(V,ve,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");else{const pe=await window.KTM.api.postJSON(V,ve,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");O.current={id:(y=(E=pe==null?void 0:pe.id)!=null?E:(G=pe==null?void 0:pe.order)==null?void 0:G.id)!=null?y:null,fingerprint:Ve(c),ts:Date.now()}}n==="new"&&!ie?(U(""),re(null),se(!0)):(U(""),re(null),se(!1)),at()}catch(V){console.error(V),typeof N=="function"?N(V.message,"danger"):alert(V.message);return}finally{H(!1)}},dt=e=>window.KTM.orders.getOrderTotalMoney(e,k),Be=async e=>{if(confirm("X\xF3a \u0111\u01A1n h\xE0ng n\xE0y?")){Q(e);try{await window.KTM.api.deleteJSON(`${API_BASE}/api/orders/${e}`,"L\u1ED7i x\xF3a \u0111\u01A1n h\xE0ng"),at()}catch(n){console.error(n),typeof N=="function"?N(n.message,"danger"):alert(n.message)}finally{Q(null)}}},Re=async(e,n)=>{var l;const s=e==null?void 0:e.id;if(!(!s||!n)){j(s);try{const r=M(e),S=(Array.isArray(r)?r:[]).map(y=>{var V;return{product_id:(y==null?void 0:y.product_id)||"",quantity:Number((V=y==null?void 0:y.quantity)!=null?V:1)}}).filter(y=>y.product_id&&Number.isFinite(y.quantity)&&y.quantity>0);if(!S.length)throw new Error("Kh\xF4ng th\u1EC3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i: \u0111\u01A1n kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m h\u1EE3p l\u1EC7");const G=S[0],E={id:s,customer_name:(e==null?void 0:e.customer_name)||"",phone:ue((e==null?void 0:e.phone)||""),address:(e==null?void 0:e.address)||"",adjustment_amount:Number((l=e==null?void 0:e.adjustment_amount)!=null?l:0)||0,adjustment_note:(e==null?void 0:e.adjustment_note)||"",product_id:G.product_id,quantity:G.quantity,status:n,items:S};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${s}`,E,"L\u1ED7i c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i"),I(y=>Array.isArray(y)?y.map(V=>(V==null?void 0:V.id)===s?{...V,status:n}:V):y),typeof N=="function"&&N("\u0110\xE3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i","success")}catch(r){console.error(r),typeof N=="function"?N(r.message,"danger"):alert(r.message)}finally{j(null)}}};return React.createElement("div",{className:"product-manager"},React.createElement(Loading,{show:d&&!Z||f||!!p||!!z}),React.createElement("div",{className:"product-header"},React.createElement("h5",null,"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"),React.createElement("button",{className:"btn btn-dark btn-sm",onClick:Xe,disabled:f||!!p},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o \u0111\u01A1n")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"L\u1ECDc theo th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:oe,onChange:e=>F(e.target.value),"aria-label":"Ch\u1ECDn th\xE1ng"}),oe&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{F("")},title:"B\u1ECF l\u1ECDc","aria-label":"B\u1ECF l\u1ECDc",disabled:d},React.createElement("i",{className:"fas fa-times"})))),React.createElement("div",{className:"col-12 col-md-7 d-flex gap-2 justify-content-md-end"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:at,disabled:d},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")))),React.createElement("div",{className:"card p-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},"Danh s\xE1ch \u0111\u01A1n h\xE0ng"),React.createElement("span",{className:"text-muted small"},A.length," \u0111\u01A1n")),d?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):A.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},"Ch\u01B0a c\xF3 \u0111\u01A1n h\xE0ng"):React.createElement(React.Fragment,null,React.createElement("div",{className:"d-md-none mt-3"},Ke.map(e=>{var n;return React.createElement("div",{key:e.id,className:"card mb-2"},React.createElement("div",{className:"card-body p-3"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"flex-grow-1",style:{minWidth:0}},React.createElement("div",{className:"fw-semibold text-truncate"},e.customer_name),React.createElement("div",{className:"fw-bold font-monospace"},e.phone),Number((n=e==null?void 0:e.split_seq)!=null?n:0)>0&&React.createElement("div",{className:"text-muted small"},"\u0110\u1EE3t ",e.split_seq),e.address&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},e.address)),React.createElement("span",{className:`badge ${Ie(e.status)}`},ke(e.status))),React.createElement("div",{className:"mt-2 small"},React.createElement("div",null,React.createElement("div",{className:"text-muted"},"S\u1EA3n ph\u1EA9m:"),(()=>{const s=$(e);return s.length?React.createElement("div",{className:"mt-1"},s.map((l,r)=>React.createElement("div",{key:r,className:"d-flex justify-content-between gap-2",style:{lineHeight:1.25}},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,whiteSpace:"normal",wordBreak:"break-word",flex:1}},React.createElement("span",{className:"text-muted me-1"},r+1,"."),l.name),React.createElement("div",{className:"text-muted small text-end text-nowrap",style:{flexShrink:0}},"x",l.qty,Number(l.unitPrice)>0?` \u2022 ${J(l.unitPrice)}`:"")))):React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},m(e))})()),(P(e)!==0||((e==null?void 0:e.adjustment_note)||"").trim())&&React.createElement("div",{style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh:")," ",React.createElement("span",{className:"fw-semibold"},J(P(e))),((e==null?void 0:e.adjustment_note)||"").trim()?React.createElement("span",{className:"text-muted"}," ","(",(e.adjustment_note||"").trim(),")"):null),React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng ti\u1EC1n"),React.createElement("span",{className:"fw-bold"},J(dt(e)))),React.createElement("div",{className:"text-muted"},React.createElement("span",null,"Th\u1EDDi gian:")," ",Oe(e.created_at))),React.createElement("div",{className:"mt-3 d-flex gap-2"},React.createElement("button",{className:"btn btn-sm btn-primary flex-fill",onClick:()=>st(e),disabled:f||!!p||z===e.id},"S\u1EEDa"),React.createElement("button",{className:"btn btn-sm btn-outline-secondary flex-fill",onClick:()=>q(e),disabled:f||!!p||z===e.id},React.createElement("i",{className:"fas fa-copy me-1"}),"Copy"),React.createElement("button",{className:"btn btn-sm btn-danger flex-fill",onClick:()=>Be(e.id),disabled:f||p===e.id||z===e.id},p===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a")),React.createElement("div",{className:"mt-2 d-flex gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning flex-fill",onClick:()=>Re(e,"processing"),disabled:f||!!p||z===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success flex-fill",onClick:()=>Re(e,"done"),disabled:f||!!p||z===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary flex-fill",onClick:()=>Re(e,"paid"),disabled:f||!!p||z===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"))))})),React.createElement("div",{className:"d-none d-md-block"},React.createElement("table",{className:"table table-bordered mt-3"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"SL"),React.createElement("th",null,"T\u1ED5ng ti\u1EC1n"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"),React.createElement("th",null,"Th\u1EDDi gian"),React.createElement("th",null))),React.createElement("tbody",null,Ke.map(e=>React.createElement("tr",{key:e.id},React.createElement("td",null,e.customer_name),React.createElement("td",null,e.phone),React.createElement("td",null,(()=>{const n=$(e);return n.length?React.createElement("div",{className:"d-grid gap-1"},n.map((s,l)=>React.createElement("div",{key:l,className:"small",style:{whiteSpace:"normal",wordBreak:"break-word",lineHeight:1.2}},React.createElement("span",{className:"text-muted me-1"},l+1,"."),React.createElement("span",{className:"fw-semibold"},s.name)," ",React.createElement("span",{className:"text-muted"},"x",s.qty),Number(s.unitPrice)>0&&React.createElement("span",{className:"text-muted"}," ","\u2022 ",J(s.unitPrice))))):m(e)})()),React.createElement("td",null,b(e)),React.createElement("td",{className:"fw-semibold"},J(dt(e))),React.createElement("td",null,React.createElement("span",{className:`badge ${Ie(e.status)}`},ke(e.status))),React.createElement("td",null,Oe(e.created_at)),React.createElement("td",null,React.createElement("button",{className:"btn btn-sm btn-primary me-1",onClick:()=>st(e),disabled:f||!!p||z===e.id},"S\u1EEDa"),React.createElement("button",{className:"btn btn-sm btn-outline-secondary me-1",onClick:()=>q(e),disabled:f||!!p||z===e.id},React.createElement("i",{className:"fas fa-copy"})),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning me-1",onClick:()=>Re(e,"processing"),disabled:f||!!p||z===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success me-1",onClick:()=>Re(e,"done"),disabled:f||!!p||z===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary me-1",onClick:()=>Re(e,"paid"),disabled:f||!!p||z===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"),React.createElement("button",{className:"btn btn-sm btn-danger",onClick:()=>Be(e.id),disabled:f||p===e.id},p===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a"))))))))),Z&&React.createElement("div",{className:"modal show d-block order-modal",style:{background:"rgba(0,0,0,0.6)"},role:"dialog","aria-modal":"true"},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ffca2c)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark mb-0"},React.createElement("i",{className:"fas fa-receipt me-2"}),ie?"S\u1EEDa \u0111\u01A1n h\xE0ng":"T\u1EA1o \u0111\u01A1n h\xE0ng"),React.createElement("button",{type:"button",className:"btn-close",onClick:X})),React.createElement("form",{onSubmit:e=>{e.preventDefault(),He({mode:"close"})}},React.createElement("div",{className:"modal-body",ref:a},React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"T\xEAn kh\xE1ch h\xE0ng *"),React.createElement("input",{className:"form-control",value:c.customer_name,onChange:e=>W({...c,customer_name:e.target.value}),placeholder:"Nh\u1EADp t\xEAn kh\xE1ch h\xE0ng",required:!0,style:{borderRadius:10,padding:12}}),!!R.nameError&&React.createElement("div",{className:"form-text text-danger"},R.nameError)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i *"),React.createElement("input",{className:"form-control",type:"tel",inputMode:"numeric",pattern:"[0-9+\\s-]*",id:"order-phone-input",value:c.phone,onChange:e=>T(e.target.value),onBlur:le,placeholder:"Nh\u1EADp s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",required:!0,style:{borderRadius:10,padding:12}}),!!R.phoneError&&React.createElement("div",{className:"form-text text-danger"},R.phoneError),!R.phoneError&&ge.count>0&&React.createElement("div",{className:"form-text text-warning d-flex align-items-center justify-content-between gap-2"},React.createElement("span",null,"Kh\xE1ch n\xE0y \u0111\xE3 c\xF3 ",ge.count," \u0111\u01A1n trong th\xE1ng ",ge.monthKey,"."),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>B(e=>!e)},v?"\u1EA8n l\u1ECBch s\u1EED":"Xem l\u1ECBch s\u1EED")),v&&ge.orders.length>0&&React.createElement("div",{className:"mt-2 border rounded-3 p-2",style:{background:"#fff"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between gap-2 mb-2"},React.createElement("div",{className:"small fw-semibold"},"L\u1ECBch s\u1EED \u0111\u01A1n (c\xF9ng th\xE1ng)"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>B(!1)},"\u1EA8n")),React.createElement("div",{className:"d-grid gap-2"},ge.orders.slice(0,5).map(e=>React.createElement("div",{key:e.id,className:"d-flex align-items-start justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"small fw-semibold",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},"#",e.id," \u2022 ",React.createElement("span",{className:`badge ${Ie(e.status)}`},ke(e.status))),React.createElement("div",{className:"text-muted small"},Oe(e.created_at)," \u2022 ",J(dt(e))),React.createElement("div",{className:"text-muted small",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},m(e))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{confirm(`M\u1EDF \u0111\u01A1n #${e.id}? D\u1EEF li\u1EC7u \u0111ang nh\u1EADp s\u1EBD m\u1EA5t.`)&&st(e)}},"M\u1EDF")))),ge.orders.length>5&&React.createElement("div",{className:"text-muted small mt-2"},"Ch\u1EC9 hi\u1EC3n th\u1ECB 5 \u0111\u01A1n g\u1EA7n nh\u1EA5t.")),(Y==null?void 0:Y.status)==="loading"&&React.createElement("div",{className:"form-text"},"\u0110ang t\xECm kh\xE1ch theo S\u0110T..."),(Y==null?void 0:Y.status)==="found"&&React.createElement("div",{className:"form-text text-success"},"\u0110\xE3 c\xF3 kh\xE1ch, t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n th\xF4ng tin."),(Y==null?void 0:Y.status)==="not-found"&&React.createElement("div",{className:"form-text text-muted"},"Ch\u01B0a c\xF3 kh\xE1ch, s\u1EBD t\u1EA1o m\u1EDBi khi l\u01B0u \u0111\u01A1n."),(Y==null?void 0:Y.status)==="error"&&React.createElement("div",{className:"form-text text-danger"},"Kh\xF4ng tra \u0111\u01B0\u1EE3c kh\xE1ch (l\u1ED7i m\u1EA1ng/server).")),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("select",{className:"form-select",value:c.status,onChange:e=>W({...c,status:e.target.value}),style:{borderRadius:10,padding:12}},React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"))),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("input",{className:"form-control",value:c.address,onChange:e=>W({...c,address:e.target.value}),placeholder:"Nh\u1EADp \u0111\u1ECBa ch\u1EC9 (kh\xF4ng b\u1EAFt bu\u1ED9c)",style:{borderRadius:10,padding:12}}),!!R.addressWarn&&React.createElement("div",{className:"form-text text-warning"},R.addressWarn)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110i\u1EC1u ch\u1EC9nh gi\xE1 (th\xEAm/b\u1EDBt)"),React.createElement("input",{type:"number",className:"form-control",value:c.adjustment_amount,onChange:e=>W({...c,adjustment_amount:e.target.value}),placeholder:"-20000 ho\u1EB7c 20000",step:"1000",style:{borderRadius:10,padding:12}}),React.createElement("div",{className:"form-text"},"\xC2m = gi\u1EA3m gi\xE1, d\u01B0\u01A1ng = c\u1ED9ng th\xEAm."),!!R.adjustmentAbnormalWarn&&React.createElement("div",{className:"form-text text-warning"},R.adjustmentAbnormalWarn)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh"),React.createElement("input",{className:"form-control",value:c.adjustment_note,onChange:e=>W({...c,adjustment_note:e.target.value}),placeholder:"V\xED d\u1EE5: Gi\u1EA3m gi\xE1 cho kh\xE1ch / B\xF9 ph\xED \u0111\xF3ng g\xF3i...",style:{borderRadius:10,padding:12}}),!!R.adjustmentNoteWarn&&React.createElement("div",{className:"form-text text-warning"},R.adjustmentNoteWarn)),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1EA3n ph\u1EA9m *"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{W(e=>({...e,items:[...Array.isArray(e.items)?e.items:[],{product_id:"",quantity:1}]})),Se(e=>[...Array.isArray(e)?e:[],""]),ie&&C(e=>[...Array.isArray(e)?e:[],!0])},disabled:f},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(c.items)?c.items:[{product_id:"",quantity:1}]).map((e,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"dropdown w-100",ref:s=>{Ne.current[n]=s}},React.createElement("button",{type:"button",className:"form-control text-start d-flex align-items-center justify-content-between",style:{borderRadius:10,padding:12},onClick:()=>{ce(s=>s===n?null:n),setTimeout(()=>{const s=document.getElementById(`order-product-search-${n}`);s&&s.focus()},0)}},React.createElement("span",{className:e.product_id?"":"text-muted",style:{minWidth:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},h(e.product_id)),React.createElement("i",{className:"fas fa-chevron-down text-muted",style:{marginLeft:8,flexShrink:0}})),be===n&&React.createElement("div",{className:"dropdown-menu show w-100 p-2",style:{maxHeight:320,overflowY:"auto"}},React.createElement("input",{id:`order-product-search-${n}`,className:"form-control",value:he[n]||"",onChange:s=>{const l=s.target.value;Se(r=>{const S=Array.isArray(r)?[...r]:[];return S[n]=l,S})},placeholder:"T\xECm theo t\xEAn / m\xE3...",style:{borderRadius:10,padding:10}}),React.createElement("div",{className:"mt-2"}),g(n).length===0?React.createElement("div",{className:"text-muted small px-2 py-1"},"Kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p"):g(n).map(s=>React.createElement("button",{key:s.id,type:"button",className:"dropdown-item",onClick:()=>{const l=String(s.id);W(r=>{const S=Array.isArray(r.items)?[...r.items]:[];return S[n]={...S[n]||{quantity:1},product_id:l},{...r,items:S}}),ce(null)}},s.name,s.code?` (${s.code})`:""))),React.createElement("select",{className:"form-select",value:e.product_id,onChange:()=>{},required:!0,style:{position:"absolute",opacity:0,height:0,pointerEvents:"none"},tabIndex:-1,"aria-hidden":"true"},React.createElement("option",{value:""},"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"),ae.map(s=>React.createElement("option",{key:s.id,value:s.id},s.name)))),(()=>{var l;const s=(l=R.items)==null?void 0:l[n];return s?React.createElement(React.Fragment,null,!!s.productError&&React.createElement("div",{className:"form-text text-danger"},s.productError),!!s.dupWarn&&React.createElement("div",{className:"form-text text-warning"},s.dupWarn)):null})(),ie&&React.createElement("div",{className:"form-check mt-1"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:`order-split-deliver-${n}`,checked:!!me[n],onChange:s=>{const l=!!s.target.checked;C(r=>{const S=Array.isArray(r)?[...r]:[],G=Array.isArray(c.items)?c.items.length:0;for(;S.length<G;)S.push(!0);return S[n]=l,S})},disabled:f||D}),React.createElement("label",{className:"form-check-label small text-muted",htmlFor:`order-split-deliver-${n}`},"Giao \u0111\u1EE3t 1"))),React.createElement("div",{className:"col-8 col-md-3"},React.createElement("input",{type:"number",className:"form-control",value:e.quantity,onChange:s=>{const l=s.target.value;W(r=>{const S=Array.isArray(r.items)?[...r.items]:[];return S[n]={...S[n]||{product_id:""},quantity:l},{...r,items:S}})},min:"1",style:{borderRadius:10,padding:12}}),(()=>{var l;const s=(l=R.items)==null?void 0:l[n];return s&&s.qtyError?React.createElement("div",{className:"form-text text-danger"},s.qtyError):null})()),React.createElement("div",{className:"col-4 col-md-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>{W(s=>{const l=Array.isArray(s.items)?[...s.items]:[];return l.splice(n,1),{...s,items:l.length?l:[{product_id:"",quantity:1}]}}),Se(s=>{const l=Array.isArray(s)?[...s]:[];return l.splice(n,1),l.length?l:[""]}),C(s=>{const l=Array.isArray(s)?[...s]:[];return l.splice(n,1),l}),ce(s=>s==null?s:s===n?null:s>n?s-1:s)},disabled:f||D||(Array.isArray(c.items)?c.items.length:1)<=1,title:"X\xF3a s\u1EA3n ph\u1EA9m",style:{borderRadius:10,padding:10}},React.createElement("i",{className:"fas fa-trash"}))))))),(()=>{const n=(Array.isArray(c.items)?c.items:[]).filter(G=>G==null?void 0:G.product_id),s=de(n),l=L(n),r=qe(c.adjustment_amount),S=s+(l.found?l.fee:0)+r;return React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-column gap-1 small bg-light rounded-3 p-3"},React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1EA1m t\xEDnh"),React.createElement("span",{className:"fw-semibold"},J(s))),l.found&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"Ship"),React.createElement("span",{className:"fw-semibold"},J(l.fee))),!!R.shipAbnormalWarn&&React.createElement("div",{className:"text-warning"},R.shipAbnormalWarn),r!==0&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh"),React.createElement("span",{className:"fw-semibold"},J(r))),(c.adjustment_note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA: ",(c.adjustment_note||"").trim()),React.createElement("div",{className:"d-flex justify-content-between pt-1 border-top"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng"),React.createElement("span",{className:"fw-bold"},J(S)))))})())),React.createElement("div",{className:"modal-footer",style:{border:"none"}},React.createElement("button",{type:"button",className:"btn btn-light",onClick:X,disabled:f||D,style:{borderRadius:10}},"H\u1EE7y"),!!ie&&React.createElement("button",{type:"button",className:"btn btn-outline-primary fw-semibold",onClick:t,disabled:f||D,style:{borderRadius:10},title:"Ch\u1ECDn s\u1EA3n ph\u1EA9m giao \u0111\u1EE3t 1 v\xE0 t\xE1ch ph\u1EA7n c\xF2n l\u1EA1i sang \u0111\u01A1n ch\u1EDD h\xE0ng"},D?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang t\xE1ch..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-random me-2"}),"T\xE1ch \u0111\u01A1n giao ngay")),!ie&&React.createElement("button",{type:"button",className:"btn btn-outline-warning fw-semibold",onClick:()=>He({mode:"new"}),disabled:f||!R.canSubmit,style:{borderRadius:10},title:"L\u01B0u xong gi\u1EEF form \u0111\u1EC3 t\u1EA1o \u0111\u01A1n m\u1EDBi"},React.createElement("i",{className:"fas fa-plus me-2"}),"L\u01B0u & t\u1EA1o \u0111\u01A1n m\u1EDBi"),React.createElement("button",{type:"submit",className:"btn btn-warning fw-semibold",disabled:f||D||!R.canSubmit,style:{borderRadius:10,boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},f?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u"))))))))}

