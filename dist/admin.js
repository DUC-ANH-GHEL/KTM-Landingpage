const{useState,useEffect,useRef}=React,CLOUDINARY_CLOUD_NAME="diwxfpt92",CLOUDINARY_UPLOAD_PRESET="ktm_unsigned",API_BASE="";function LoginPage({onLogin:S,error:y}){const[M,W]=useState(""),[U,v]=useState(""),[O,ae]=useState(!1),[re,B]=useState(!1);return React.createElement("div",{className:"login-page"},React.createElement("div",{className:"login-box"},React.createElement("div",{className:"text-center mb-4"},React.createElement("i",{className:"fas fa-tractor fa-3x text-warning mb-3"}),React.createElement("h4",{className:"text-dark"},"KTM Admin"),React.createElement("p",{className:"text-muted small"},"\u0110\u0103ng nh\u1EADp \u0111\u1EC3 qu\u1EA3n l\xFD")),y&&React.createElement("div",{className:"alert alert-danger py-2 small"},React.createElement("i",{className:"fas fa-exclamation-circle me-2"}),y),React.createElement("form",{onSubmit:async xe=>{xe.preventDefault(),ae(!0),await S(M,U),ae(!1)}},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small"},"T\xEAn \u0111\u0103ng nh\u1EADp"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-user"})),React.createElement("input",{type:"text",className:"form-control",value:M,onChange:xe=>W(xe.target.value),placeholder:"admin",required:!0,autoFocus:!0}))),React.createElement("div",{className:"mb-4"},React.createElement("label",{className:"form-label small"},"M\u1EADt kh\u1EA9u"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-lock"})),React.createElement("input",{type:re?"text":"password",className:"form-control",value:U,onChange:xe=>v(xe.target.value),placeholder:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",required:!0}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>B(!re)},React.createElement("i",{className:`fas fa-eye${re?"-slash":""}`})))),React.createElement("button",{type:"submit",className:"btn btn-warning w-100",disabled:O},O?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang \u0111\u0103ng nh\u1EADp..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-sign-in-alt me-2"}),"\u0110\u0103ng nh\u1EADp"))),React.createElement("div",{className:"text-center mt-4"},React.createElement("a",{href:"/",className:"text-muted small text-decoration-none"},React.createElement("i",{className:"fas fa-arrow-left me-1"}),"V\u1EC1 trang ch\u1EE7"))))}function Toast({message:S,type:y,onClose:M}){return useEffect(()=>{const W=setTimeout(M,3e3);return()=>clearTimeout(W)},[]),React.createElement("div",{className:`toast show align-items-center text-white bg-${y} border-0`,role:"alert"},React.createElement("div",{className:"d-flex"},React.createElement("div",{className:"toast-body"},S),React.createElement("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto",onClick:M})))}function Loading({show:S}){return S?React.createElement("div",{className:"loading-overlay"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"3rem",height:"3rem"}},React.createElement("span",{className:"visually-hidden"},"\u0110ang t\u1EA3i..."))):null}function Sidebar({activeMenu:S,onMenuChange:y,onLogout:M,currentUser:W}){return React.createElement("div",{className:"sidebar d-none d-md-block"},React.createElement("div",{className:"logo"},React.createElement("i",{className:"fas fa-tractor me-2"})," KTM Admin"),React.createElement("nav",{className:"nav flex-column mt-3"},[{id:"search",icon:"fa-search",label:"Tra c\u1EE9u nhanh",highlight:!0},{id:"albums",icon:"fa-images",label:"Qu\u1EA3n l\xFD Album"},{id:"videos",icon:"fa-video",label:"Qu\u1EA3n l\xFD Video"},{id:"products",icon:"fa-box",label:"S\u1EA3n ph\u1EA9m"},{id:"orders",icon:"fa-receipt",label:"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"},{id:"stats",icon:"fa-chart-column",label:"Th\u1ED1ng k\xEA"},{id:"settings",icon:"fa-cog",label:"C\xE0i \u0111\u1EB7t"}].map(v=>React.createElement("a",{key:v.id,href:"#",className:`nav-link ${S===v.id?"active":""} ${v.disabled?"opacity-50":""} ${v.highlight?"text-warning":""}`,onClick:O=>{O.preventDefault(),v.disabled||y(v.id)}},React.createElement("i",{className:`fas ${v.icon}`})," ",v.label,v.disabled&&React.createElement("span",{className:"badge bg-secondary ms-2"},"Soon"),v.highlight&&React.createElement("span",{className:"badge bg-warning text-dark ms-2"},"HOT")))),React.createElement("div",{className:"position-absolute bottom-0 w-100 p-3 border-top border-secondary"},React.createElement("div",{className:"d-flex justify-content-between align-items-center"},React.createElement("a",{href:"/",className:"text-white-50 text-decoration-none small"},React.createElement("i",{className:"fas fa-home me-1"})," Trang ch\u1EE7"),M&&React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:M,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"})))))}const ADMIN_SETTINGS_STORAGE_KEY="ktm_admin_settings_v1",DEFAULT_SHIP_PERCENT=1.64;function normalizeShipPercent(S){const y=typeof S=="number"?S:parseFloat(String(S!=null?S:"").trim());return Number.isFinite(y)?Math.max(0,Math.min(100,y)):DEFAULT_SHIP_PERCENT}function loadAdminSettings(){var S;try{const y=localStorage.getItem(ADMIN_SETTINGS_STORAGE_KEY);if(!y)return{ship_percent:DEFAULT_SHIP_PERCENT};const M=JSON.parse(y);return{ship_percent:normalizeShipPercent((S=M==null?void 0:M.ship_percent)!=null?S:M==null?void 0:M.shipPercent)}}catch(y){return{ship_percent:DEFAULT_SHIP_PERCENT}}}function saveAdminSettings(S){var y;try{const M={ship_percent:normalizeShipPercent((y=S==null?void 0:S.ship_percent)!=null?y:S==null?void 0:S.shipPercent)};return localStorage.setItem(ADMIN_SETTINGS_STORAGE_KEY,JSON.stringify(M)),M}catch(M){return{ship_percent:DEFAULT_SHIP_PERCENT}}}async function fetchAdminSettingsFromServer(){var y;const S=await window.KTM.api.getJSON(`${API_BASE}/api/settings`,"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t t\u1EEB DB");return{ship_percent:normalizeShipPercent((y=S==null?void 0:S.ship_percent)!=null?y:S==null?void 0:S.shipPercent)}}async function saveAdminSettingsToServer(S){var W,U,v;const y={ship_percent:normalizeShipPercent((W=S==null?void 0:S.ship_percent)!=null?W:S==null?void 0:S.shipPercent)},M=await window.KTM.api.putJSON(`${API_BASE}/api/settings`,y,"Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t v\xE0o DB");return{ship_percent:normalizeShipPercent((v=(U=M==null?void 0:M.ship_percent)!=null?U:M==null?void 0:M.shipPercent)!=null?v:y.ship_percent)}}function AlbumList({albums:S,onSelect:y,onCreate:M,onEdit:W,onDelete:U,loading:v,currentFolder:O,onBack:ae,breadcrumb:re}){return React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},O&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:ae},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),O?O.title:"Th\u01B0 vi\u1EC7n \u1EA3nh")),React.createElement("button",{className:"btn btn-warning",onClick:M},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder")),re&&re.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:B=>{B.preventDefault(),ae("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),re.map((B,pe)=>React.createElement("li",{key:B.id,className:`breadcrumb-item ${pe===re.length-1?"active":""}`},pe===re.length-1?B.title:React.createElement("a",{href:"#",onClick:xe=>{xe.preventDefault(),ae(B)},className:"text-warning"},B.title))))),v?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):S.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},O?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder n\xE0o. H\xE3y t\u1EA1o folder \u0111\u1EA7u ti\xEAn!")):React.createElement("div",{className:"row g-3"},S.map(B=>React.createElement("div",{key:B.uuid||B.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card album-card h-100",onClick:()=>y(B)},B.cover?React.createElement("img",{src:B.cover,className:"album-cover",alt:B.title}):React.createElement("div",{className:"card-body text-center py-4"},React.createElement("i",{className:"fas fa-folder fa-3x text-warning mb-2"})),React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"card-title mb-1"},B.title),React.createElement("small",{className:"text-muted"},B.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),B.subfolderCount),B.subfolderCount>0&&B.count>0&&" \u2022 ",B.count>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-image me-1"}),B.count),B.subfolderCount===0&&B.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-2",onClick:pe=>{pe.stopPropagation(),W(B)},title:"S\u1EEDa album"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:pe=>{pe.stopPropagation(),U(B)},title:"X\xF3a album"},React.createElement("i",{className:"fas fa-trash"}))))))))}function AlbumModal({show:S,album:y,onClose:M,onSave:W,parentId:U}){const[v,O]=useState({slug:"",title:"",description:"",cover_url:"",parent_id:null}),[ae,re]=useState(!1),[B,pe]=useState(!1),xe=useRef(null);useEffect(()=>{O(y?{slug:y.id||"",title:y.title||"",description:y.description||"",cover_url:y.cover||"",parent_id:y.parentId||null}:{slug:"",title:"",description:"",cover_url:"",parent_id:U||null})},[y,S,U]);const se=async de=>{de.preventDefault(),re(!0),await W(v),re(!1)},me=de=>de.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),ye=async de=>{const ke=de.type==="image/heic"||de.type==="image/heif"||/\.heic$/i.test(de.name);if(de.size<=2097152&&!ke)return de;try{const fe=await createImageBitmap(de),De=document.createElement("canvas");let Se=fe.width,Ne=fe.height;const Ce=800;return(Se>Ce||Ne>Ce)&&(Se>Ne?(Ne=Math.round(Ne/Se*Ce),Se=Ce):(Se=Math.round(Se/Ne*Ce),Ne=Ce)),De.width=Se,De.height=Ne,De.getContext("2d").drawImage(fe,0,0,Se,Ne),fe.close(),new Promise((et,_e)=>{De.toBlob(Oe=>{Oe?et(new File([Oe],de.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):_e(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(fe){throw console.error("Compress cover error:",fe),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},ce=async de=>{var fe;const ne=de.target.files[0];if(!ne)return;if(!(ne.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(ne.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}pe(!0);try{const De=await ye(ne),Se=await window.KTM.cloudinary.uploadImage({file:De,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-albums/covers"});if(!Se.secure_url)throw console.error("Cloudinary error:",Se),new Error(((fe=Se.error)==null?void 0:fe.message)||"Upload failed");O(Ne=>({...Ne,cover_url:Se.secure_url}))}catch(De){console.error("Cover upload error:",De),alert("L\u1ED7i upload \u1EA3nh b\xECa: "+De.message)}pe(!1),de.target.value=""};return S?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},y?"S\u1EEDa":"T\u1EA1o"," Folder"),React.createElement("button",{type:"button",className:"btn-close",onClick:M})),React.createElement("form",{onSubmit:se},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:v.title,onChange:de=>O({...v,title:de.target.value,slug:v.slug||me(de.target.value)}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Slug (URL) *"),React.createElement("input",{type:"text",className:"form-control",value:v.slug,onChange:de=>O({...v,slug:de.target.value}),required:!0,disabled:!!y}),React.createElement("small",{className:"text-muted"},"VD: may-cay-kubota-l1501")),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:v.description,onChange:de=>O({...v,description:de.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex gap-2 align-items-start"},v.cover_url&&React.createElement("div",{className:"position-relative",style:{width:80,height:80}},React.createElement("img",{src:v.cover_url,alt:"Cover",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:8}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute",style:{top:-8,right:-8,padding:"2px 6px",fontSize:10},onClick:()=>O(de=>({...de,cover_url:""}))},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{ref:xe,type:"file",accept:"image/*",className:"d-none",onChange:ce}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100 mb-2",onClick:()=>{var de;return(de=xe.current)==null?void 0:de.click()},disabled:B},B?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh b\xECa")),React.createElement("input",{type:"url",className:"form-control form-control-sm",value:v.cover_url,onChange:de=>O({...v,cover_url:de.target.value}),placeholder:"Ho\u1EB7c d\xE1n URL \u1EA3nh..."}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:M},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:ae||B},ae?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function FolderTreeItem({folder:S,allAlbums:y,currentAlbumId:M,targetAlbum:W,onSelect:U,level:v=0}){const[O,ae]=useState(!0),re=S.uuid||S.id,B=re===M,pe=W===re,xe=y.filter(me=>me.parentId===re),se=xe.length>0;return React.createElement("div",{style:{marginLeft:v*16+"px"}},React.createElement("div",{className:`d-flex align-items-center p-2 rounded mb-1 ${pe?"bg-info text-white":B?"bg-light text-muted":"hover-bg"}`,style:{cursor:B?"not-allowed":"pointer",opacity:B?.5:1,transition:"background 0.2s"},onClick:()=>!B&&U(re)},se&&React.createElement("i",{className:`fas fa-chevron-${O?"down":"right"} me-2`,style:{fontSize:"10px",width:"12px",cursor:"pointer"},onClick:me=>{me.stopPropagation(),ae(!O)}}),!se&&React.createElement("span",{style:{width:"20px"}}),React.createElement("i",{className:`fas fa-folder${pe?"-open":""} me-2 ${pe?"":"text-warning"}`}),React.createElement("span",{className:"small"},S.title),B&&React.createElement("span",{className:"ms-2 badge bg-secondary",style:{fontSize:"9px"}},"Hi\u1EC7n t\u1EA1i"),S.count>0&&!B&&React.createElement("span",{className:"ms-auto badge bg-light text-muted",style:{fontSize:"10px"}},S.count)),O&&se&&React.createElement("div",null,xe.map(me=>React.createElement(FolderTreeItem,{key:me.uuid||me.id,folder:me,allAlbums:y,currentAlbumId:M,targetAlbum:W,onSelect:U,level:v+1}))))}function AlbumDetail({album:S,onBack:y,onRefresh:M,showToast:W,onNavigateToFolder:U,onEditSubfolder:v,parentAlbum:O}){const[ae,re]=useState([]),[B,pe]=useState([]),[xe,se]=useState(!0),[me,ye]=useState(!1),[ce,de]=useState(""),[ne,ke]=useState([]),[fe,De]=useState([]),[Se,Ne]=useState({}),[Ce,$e]=useState(null),[et,_e]=useState(!1),[Oe,qe]=useState(""),[s,m]=useState(!1),b=useRef(null),A=useRef(null),[Y,L]=useState(!1),[P,E]=useState([]),[r,G]=useState([]),[Ae,Le]=useState(""),[l,h]=useState(!1),ge=async(p,$=2)=>{const k=$*1024*1024,Fe=p.type==="image/heic"||p.type==="image/heif"||/\.heic$/i.test(p.name);if(p.size<=k&&!Fe)return p;try{const Ve=await createImageBitmap(p),Je=document.createElement("canvas");let tt=Ve.width,at=Ve.height;const nt=1200;return(tt>nt||at>nt)&&(tt>at?(at=Math.round(at/tt*nt),tt=nt):(tt=Math.round(tt/at*nt),at=nt)),Je.width=tt,Je.height=at,Je.getContext("2d").drawImage(Ve,0,0,tt,at),Ve.close(),new Promise((Mt,ht)=>{Je.toBlob(He=>{He?Mt(new File([He],p.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):ht(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(Ve){throw console.error("Compress error:",Ve),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh")}};useEffect(()=>{g(),q()},[S.id,S.uuid]);const g=async()=>{se(!0);try{const p=await window.KTM.api.getJSON(`${API_BASE}/api/albums/${S.uuid||S.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");re(p.images||[]);const $=await window.KTM.api.getJSON(`${API_BASE}/api/albums?parent_id=${S.uuid||S.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");pe(Array.isArray($)?$:[])}catch(p){console.error(p),W("L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u","danger")}se(!1)},q=async()=>{try{const p=await window.KTM.api.getJSON(`${API_BASE}/api/albums`,"L\u1ED7i t\u1EA3i album");G(Array.isArray(p)?p:[])}catch(p){console.error("Error loading albums:",p)}},F=p=>{E($=>$.includes(p)?$.filter(k=>k!==p):[...$,p])},Me=async()=>{if(!Ae||P.length===0){W("Vui l\xF2ng ch\u1ECDn folder \u0111\xEDch","warning");return}h(!0);let p=0;for(const $ of P)try{await window.KTM.api.putJSON(`${API_BASE}/api/images/${$}`,{album_id:Ae},"L\u1ED7i di chuy\u1EC3n \u1EA3nh"),p++}catch(k){console.error("Move error:",k)}h(!1),L(!1),E([]),Le(""),p>0?(W("\u0110\xE3 di chuy\u1EC3n \u1EA3nh th\xE0nh c\xF4ng!","success"),g(),M()):W("Di chuy\u1EC3n th\u1EA5t b\u1EA1i","danger")},[Ye,Ie]=useState(!1),Pe=async()=>{if(P.length===0||!confirm(`X\xF3a ${P.length} \u1EA3nh \u0111\xE3 ch\u1ECDn? H\xE0nh \u0111\u1ED9ng n\xE0y kh\xF4ng th\u1EC3 ho\xE0n t\xE1c!`))return;Ie(!0);let p=0;for(const $ of P)try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${$}`,"L\u1ED7i x\xF3a \u1EA3nh"),p++}catch(k){console.error("Delete error:",k)}Ie(!1),E([]),p>0?(W(`\u0110\xE3 x\xF3a ${p} \u1EA3nh!`,"success"),g(),M()):W("X\xF3a th\u1EA5t b\u1EA1i","danger")},ze=()=>{P.length===ae.length?E([]):E(ae.map(p=>p.id))},ct=async()=>{if(Oe.trim()){m(!0);try{const p=Oe.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");await window.KTM.api.postJSON(`${API_BASE}/api/albums`,{slug:p+"-"+Date.now(),title:Oe,parent_id:S.uuid||S.id},"L\u1ED7i t\u1EA1o folder"),W("T\u1EA1o folder th\xE0nh c\xF4ng!","success"),qe(""),_e(!1),g(),M()}catch(p){W(p.message,"danger")}m(!1)}},At=async p=>{if(confirm(`X\xF3a folder "${p.title}"? T\u1EA5t c\u1EA3 n\u1ED9i dung b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${p.uuid||p.id}`,"L\u1ED7i x\xF3a folder"),W("\u0110\xE3 x\xF3a folder","success"),g(),M()}catch($){W("L\u1ED7i x\xF3a folder","danger")}},vt=p=>{const $=Array.from(p).filter(k=>k.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(k.name));ke(k=>[...k,...$]),$.forEach(k=>{const Fe=new FileReader;Fe.onload=Ve=>{De(Je=>[...Je,{file:k,preview:Ve.target.result}])},Fe.readAsDataURL(k)})},Rt=p=>{ke($=>$.filter((k,Fe)=>Fe!==p)),De($=>$.filter((k,Fe)=>Fe!==p))},Pt=async p=>{var k;const $=await window.KTM.cloudinary.uploadImage({file:p,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:`ktm-albums/${S.id}`});if(!$.secure_url)throw console.error("Cloudinary error:",$),new Error(((k=$.error)==null?void 0:k.message)||"Upload failed");return $},It=async()=>{if(ne.length===0)return;ye(!0);let p=0;for(let $=0;$<ne.length;$++)try{de(`\u0110ang x\u1EED l\xFD ${$+1}/${ne.length}...`);const k=await ge(ne[$],2);de(`\u0110ang upload ${$+1}/${ne.length}...`);const Fe=await Pt(k);await window.KTM.api.postJSON(`${API_BASE}/api/albums/${S.id}`,{url:Fe.secure_url,caption:Se[$]||ne[$].name.replace(/\.[^/.]+$/,""),sort_order:ae.length+$},"L\u1ED7i l\u01B0u \u1EA3nh"),p++}catch(k){console.error("Upload error:",k)}ye(!1),de(""),ke([]),De([]),Ne({}),p>0?(W(`\u0110\xE3 upload ${p} \u1EA3nh th\xE0nh c\xF4ng!`,"success"),g(),M()):W("Upload th\u1EA5t b\u1EA1i","danger")},we=async(p,$)=>{if(confirm("X\xF3a \u1EA3nh n\xE0y?"))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${p}`,"L\u1ED7i x\xF3a \u1EA3nh"),W("\u0110\xE3 x\xF3a \u1EA3nh","success"),g(),M()}catch(k){W("L\u1ED7i x\xF3a \u1EA3nh","danger")}},Ze=p=>{var $;p.preventDefault(),($=A.current)==null||$.classList.add("dragover")},lt=()=>{var p;(p=A.current)==null||p.classList.remove("dragover")},Ct=p=>{var $;p.preventDefault(),($=A.current)==null||$.classList.remove("dragover"),vt(p.dataTransfer.files)};return React.createElement("div",null,React.createElement("div",{className:"d-flex align-items-center justify-content-between mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:y},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("h4",{className:"m-0"},S.title),React.createElement("small",{className:"text-muted"},B.length>0&&React.createElement("span",null,B.length," folder \u2022 "),ae.length," \u1EA3nh"))),React.createElement("button",{className:"btn btn-outline-warning btn-sm",onClick:()=>_e(!0)},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder con")),et&&React.createElement("div",{className:"card mb-4 border-warning"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder-plus me-2 text-warning"}),"T\u1EA1o folder con"),React.createElement("div",{className:"d-flex gap-2"},React.createElement("input",{type:"text",className:"form-control",placeholder:"T\xEAn folder...",value:Oe,onChange:p=>qe(p.target.value),onKeyPress:p=>p.key==="Enter"&&ct(),autoFocus:!0}),React.createElement("button",{className:"btn btn-warning",onClick:ct,disabled:s||!Oe.trim()},s?React.createElement("span",{className:"spinner-border spinner-border-sm"}):"T\u1EA1o"),React.createElement("button",{className:"btn btn-secondary",onClick:()=>{_e(!1),qe("")}},"H\u1EE7y")))),B.length>0&&React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),"Folder con"),React.createElement("div",{className:"row g-2"},B.map(p=>React.createElement("div",{key:p.uuid||p.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-item",style:{cursor:"pointer"},onClick:()=>U&&U(p)},React.createElement("div",{className:"card-body text-center py-3"},React.createElement("i",{className:"fas fa-folder fa-2x text-warning mb-2"}),React.createElement("div",{className:"small fw-bold text-truncate"},p.title),React.createElement("small",{className:"text-muted"},p.subfolderCount>0&&React.createElement("span",null,p.subfolderCount," folder"),p.subfolderCount>0&&p.count>0&&" \u2022 ",p.count>0&&React.createElement("span",null,p.count," \u1EA3nh"),p.subfolderCount===0&&p.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0 text-center"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-1",onClick:$=>{$.stopPropagation(),v&&v(p)},title:"S\u1EEDa folder"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:$=>{$.stopPropagation(),At(p)},title:"X\xF3a folder"},React.createElement("i",{className:"fas fa-trash"}))))))))),React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-cloud-upload-alt me-2"}),"Upload \u1EA3nh m\u1EDBi"),React.createElement("div",{ref:A,className:"upload-zone",onClick:()=>{var p;return(p=b.current)==null?void 0:p.click()},onDragOver:Ze,onDragLeave:lt,onDrop:Ct},React.createElement("i",{className:"fas fa-images fa-2x text-muted mb-2"}),React.createElement("p",{className:"mb-0"},"K\xE9o th\u1EA3 \u1EA3nh v\xE0o \u0111\xE2y ho\u1EB7c click \u0111\u1EC3 ch\u1ECDn"),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3 JPG, PNG, WebP"),React.createElement("input",{ref:b,type:"file",multiple:!0,accept:"image/*",onChange:p=>vt(p.target.files)})),fe.length>0&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"upload-preview"},fe.map((p,$)=>React.createElement("div",{key:$,className:"upload-preview-item"},React.createElement("img",{src:p.preview,alt:""}),React.createElement("button",{className:"remove",onClick:()=>Rt($)},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("div",{className:"mt-3"},React.createElement("button",{className:"btn btn-warning",onClick:It,disabled:me},me?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),ce||"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload ",ne.length," \u1EA3nh")))))),React.createElement("div",{className:"card"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("h6",{className:"m-0"},React.createElement("i",{className:"fas fa-th me-2"}),"\u1EA2nh (",ae.length,")"),ae.length>0&&React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:ze},P.length===ae.length?"B\u1ECF ch\u1ECDn":"Ch\u1ECDn t\u1EA5t c\u1EA3")),P.length>0&&React.createElement("div",{className:"d-flex align-items-center gap-2 flex-wrap"},React.createElement("span",{className:"badge bg-primary"},P.length," \u0111\xE3 ch\u1ECDn"),React.createElement("button",{className:"btn btn-sm btn-info",onClick:()=>L(!0)},React.createElement("i",{className:"fas fa-folder-open me-1"}),"Di chuy\u1EC3n"),React.createElement("button",{className:"btn btn-sm btn-danger",onClick:Pe,disabled:Ye},Ye?React.createElement("span",{className:"spinner-border spinner-border-sm"}):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-trash me-1"}),"X\xF3a")),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>E([])},React.createElement("i",{className:"fas fa-times"})))),xe?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):ae.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},React.createElement("i",{className:"fas fa-image fa-2x mb-2"}),React.createElement("p",null,"Ch\u01B0a c\xF3 \u1EA3nh n\xE0o trong album n\xE0y")):React.createElement("div",{className:"image-grid"},ae.map((p,$)=>React.createElement("div",{key:$,className:`image-item ${P.includes(p.id)?"selected":""}`,style:{position:"relative",cursor:"pointer"},onClick:()=>F(p.id)},React.createElement("div",{className:"select-checkbox",style:{position:"absolute",top:"6px",left:"6px",zIndex:10,width:"24px",height:"24px",borderRadius:"4px",background:P.includes(p.id)?"#0d6efd":"rgba(255,255,255,0.9)",border:P.includes(p.id)?"none":"2px solid #ccc",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"}},P.includes(p.id)&&React.createElement("i",{className:"fas fa-check",style:{color:"#fff",fontSize:"12px"}})),React.createElement("img",{src:p.src,alt:p.caption,style:{opacity:P.includes(p.id)?.7:1,border:P.includes(p.id)?"3px solid #0d6efd":"none",borderRadius:"8px"}}),React.createElement("div",{className:"actions"},React.createElement("button",{className:"btn btn-sm btn-danger",onClick:k=>{k.stopPropagation(),we(p.id,$)},title:"X\xF3a \u1EA3nh"},React.createElement("i",{className:"fas fa-trash"}))),p.caption&&React.createElement("div",{className:"p-2 bg-light small text-truncate"},p.caption)))))),Y&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header bg-info text-white"},React.createElement("h5",{className:"modal-title"},React.createElement("i",{className:"fas fa-folder-open me-2"}),"Di chuy\u1EC3n ",P.length," \u1EA3nh"),React.createElement("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>L(!1)})),React.createElement("div",{className:"modal-body",style:{maxHeight:"400px",overflowY:"auto"}},React.createElement("p",{className:"text-muted small mb-3"},"Ch\u1ECDn th\u01B0 m\u1EE5c \u0111\xEDch:"),React.createElement("div",{className:"folder-tree"},r.filter(p=>!p.parentId).map(p=>React.createElement(FolderTreeItem,{key:p.uuid||p.id,folder:p,allAlbums:r,currentAlbumId:S.uuid||S.id,targetAlbum:Ae,onSelect:Le})))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>L(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-info",onClick:Me,disabled:!Ae||l},l?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang chuy\u1EC3n..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-1"}),"Di chuy\u1EC3n \u0111\u1EBFn \u0111\xE2y")))))),Ce&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.9)"},onClick:()=>$e(null)},React.createElement("div",{className:"modal-dialog modal-fullscreen d-flex align-items-center justify-content-center"},React.createElement("div",{className:"position-relative",style:{maxWidth:"95vw",maxHeight:"95vh"}},React.createElement("button",{className:"btn btn-light position-absolute",style:{top:"-50px",right:"0",borderRadius:"50%",width:"40px",height:"40px"},onClick:()=>$e(null)},React.createElement("i",{className:"fas fa-times"})),React.createElement("img",{src:Ce.src,alt:Ce.caption,style:{maxWidth:"95vw",maxHeight:"90vh",objectFit:"contain"},onClick:p=>p.stopPropagation()}),Ce.caption&&React.createElement("div",{className:"text-white text-center mt-2"},Ce.caption)))))}function SearchCenter({showToast:S,onNavigate:y}){const[M,W]=useState(""),[U,v]=useState([]),[O,ae]=useState([]),[re,B]=useState([]),[pe,xe]=useState("all"),[se,me]=useState(null),[ye,ce]=useState("list"),[de,ne]=useState(!0),[ke,fe]=useState([]),[De,Se]=useState([]),Ne=useRef(null),[Ce,$e]=useState(!0),[et,_e]=useState(!1),Oe=useRef(null),[qe,s]=useState(!1),[m,b]=useState([{role:"assistant",content:`Xin ch\xE0o! H\xE3y h\u1ECFi t\xF4i v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3... V\xED d\u1EE5:
\u2022 "Gi\xE1 van 2 tay?"
\u2022 "Combo r\u1EBB nh\u1EA5t?"
\u2022 "Freeship?"`,attachments:[]}]),[A,Y]=useState(""),[L,P]=useState(!1),E=useRef(null),r=useRef(null),[G,Ae]=useState(null),[Le,l]=useState(!1),[h,ge]=useState(null),[g,q]=useState(!1),[F,Me]=useState(!1),[Ye,Ie]=useState(null),[Pe,ze]=useState({name:"",code:"",price:"",image:"",category:"",note:"",commission_percent:""}),ct=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"],At=t=>{var C,D;t._type==="product"&&(ge(t),ze({name:t.name||"",code:t.code||"",price:t.price||"",image:t.image||"",category:t.category||"",note:t.note||"",commission_percent:(D=(C=t.commission_percent)!=null?C:t.commissionPercent)!=null?D:""}),l(!0))},vt=async()=>{if(h)try{await window.KTM.api.putJSON(`${API_BASE}/api/products?id=${h.id}`,Pe,"L\u1ED7i c\u1EADp nh\u1EADt"),S("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),l(!1),ge(null),Ze()}catch(t){S(t.message,"danger")}},Rt=async t=>{const C=t._type==="product"?"s\u1EA3n ph\u1EA9m":t._type==="album"?"\u1EA3nh":"video";if(confirm(`X\xF3a ${C} "${t.name}"?`))try{let D="";t._type==="product"?D=`${API_BASE}/api/products?id=${t.id}`:t._type==="album"?D=`${API_BASE}/api/images/${t.id}`:t._type==="video"&&(D=`${API_BASE}/api/videos/${t.id}`),await window.KTM.api.deleteJSON(D,"L\u1ED7i x\xF3a"),S(`\u0110\xE3 x\xF3a ${C}`,"success"),Ze()}catch(D){S(D.message,"danger")}},Pt=async t=>{try{const C=Ye?`${API_BASE}/api/products?id=${Ye.id}`:`${API_BASE}/api/products`;Ye?await window.KTM.api.putJSON(C,t,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(C,t,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),S(Ye?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Me(!1),Ie(null),Ze()}catch(C){S(C.message,"danger")}},It="ktm_admin_data_cache_v1",we=1e3*60*10,Ze=async()=>{let t=null,C=!1;const D=window.KTM.cache.read(It,{ttlMs:we,validate:Array.isArray});D.hit?(t=D.value,console.log("[CACHE] Using cache, items:",t.length),ae(t),v(t),ne(!1),C=!0):D.status==="miss"?console.log("[CACHE] No cache found"):D.status==="expired"||D.status==="invalid"?console.log("[CACHE] Cache expired or invalid"):D.status==="error"&&console.error("[CACHE] Error parsing cache"),C||ne(!0);try{const z=async(J,le)=>{try{const Ue=await window.KTM.api.getJSON(J,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");return Ue!=null?Ue:le}catch(Ue){return le}},[ee,_,w]=await Promise.all([z(`${API_BASE}/api/products`,[]),z(`${API_BASE}/api/albums`,[]),z(`${API_BASE}/api/video-folders?withVideos=true`,[])]),Z=Array.isArray(ee)?ee.map(J=>({...J,_type:"product",_source:"database"})):[];fe(_);let oe=[];Array.isArray(_)&&_.length>0&&(await Promise.all(_.map(le=>z(`${API_BASE}/api/albums/${le.id}`,{})))).forEach((le,Ue)=>{const st=_[Ue];le.images&&le.images.length>0&&le.images.forEach(Ge=>{oe.push({id:Ge.id,name:Ge.caption||"\u1EA2nh t\u1EEB "+st.title,image:Ge.src,folder:st.title,_type:"album",_source:"database"})})}),Se(w);let ie=[];Array.isArray(w)&&w.forEach(J=>{J.videos&&J.videos.forEach(le=>{ie.push({id:le.id,name:le.title,folder:J.name,image:le.thumb,youtubeId:le.youtubeId,url:le.url,_type:"video",_source:"database"})})});const Q=[...Z,...oe,...ie];(!t||JSON.stringify(Q)!==JSON.stringify(t))&&(ae(Q),v(Q),window.KTM.cache.write(It,Q))}catch(z){console.error("Song song fetch error:",z)}ne(!1)};useEffect(()=>{Ze(),setTimeout(()=>{var t;return(t=Ne.current)==null?void 0:t.focus()},100)},[]);const lt=t=>{try{return String(t!=null?t:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(C){return String(t!=null?t:"").toLowerCase()}},Ct=t=>{const D=lt(t).trim().split(/\s+/).filter(Boolean),z=D.includes("anh"),ee=D.includes("video"),_=D.filter(oe=>oe!=="anh"&&oe!=="video"),w=_.join(" "),Z=new Set(["product"]);return z&&Z.add("album"),ee&&Z.add("video"),{allowedTypes:Z,includeAlbum:z,includeVideo:ee,contentTokens:_,cleanedQuery:w}},p=(t,C,D)=>{var J,le,Ue,st,Ge;const z=Array.isArray(C)?C:[],ee=lt(D).trim();if(!z.length&&!ee)return 0;const _=lt((J=t==null?void 0:t.name)!=null?J:""),w=lt((le=t==null?void 0:t.code)!=null?le:""),Z=lt((Ue=t==null?void 0:t.category)!=null?Ue:""),oe=lt((st=t==null?void 0:t.note)!=null?st:""),ie=lt((Ge=t==null?void 0:t.folder)!=null?Ge:"");if(!`${_} ${w} ${Z} ${oe} ${ie}`.trim())return 0;let ue=0;ee&&(_===ee&&(ue+=220),_.includes(ee)&&(ue+=140),_.startsWith(ee)&&(ue+=160),w&&w===ee&&(ue+=180),w&&w.includes(ee)&&(ue+=90));for(const it of z){if(!it)continue;const yt=new RegExp(`(?:^|\\s)${it.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}`);_.includes(it)&&(ue+=35),yt.test(_)&&(ue+=25),w&&w.includes(it)&&(ue+=20),w&&yt.test(w)&&(ue+=10),Z&&Z.includes(it)&&(ue+=12),ie&&ie.includes(it)&&(ue+=12),oe&&oe.includes(it)&&(ue+=6)}return ue>0&&_&&(ue+=Math.max(0,10-Math.min(10,Math.floor(_.length/10)))),ue},$=(t,C,D)=>{const z=Array.isArray(t)?t:[];return z.length?z.map((_,w)=>({it:_,idx:w,score:p(_,C,D)})).sort((_,w)=>w.score!==_.score?w.score-_.score:_.idx-w.idx).map(_=>_.it):[]},k=async(t,C)=>{if(!(!Ce||C.length===0)){_e(!0);try{const D=C.map(ee=>({id:ee.id,name:ee.name,price:ee.price,category:ee.category,note:ee.note,folder:ee.folder,_type:ee._type})),z=await window.KTM.api.postJSON(`${API_BASE}/api/ai-search`,{query:t,products:D},"AI Search error");if(z&&z.matchedIds&&z.matchedIds.length>0){const{contentTokens:ee,cleanedQuery:_}=Ct(t),w=new Set(z.matchedIds),Z=C.filter(oe=>w.has(oe.id)).sort((oe,ie)=>p(ie,ee,_)-p(oe,ee,_));Z.length>0&&v(Z)}else z&&z.matchedIds&&z.matchedIds.length===0&&v([])}catch(D){console.error("AI Search error:",D)}_e(!1)}},Fe=t=>{if(W(t),Oe.current&&clearTimeout(Oe.current),!t.trim()){Ve(pe);return}const{allowedTypes:C,contentTokens:D,cleanedQuery:z}=Ct(t),ee=O.filter(w=>{if(!C.has(w==null?void 0:w._type))return!1;if(D.length===0)return!0;const Z=lt(Object.entries(w).filter(([oe])=>!oe.startsWith("_")).map(([,oe])=>String(oe||"")).join(" "));return D.some(oe=>Z.includes(oe))});let _=ee;pe!=="all"&&(_=ee.filter(w=>(w.category||w._type)===pe)),v($(_,D,z)),Ce&&z.length>=3&&(Oe.current=setTimeout(()=>{k(z,_)},500))},Ve=t=>{xe(t);const{allowedTypes:C,contentTokens:D}=Ct(M),{cleanedQuery:z}=Ct(M);let ee=O.filter(_=>C.has(_==null?void 0:_._type));t!=="all"&&(ee=ee.filter(_=>(_.category||_._type)===t)),M.trim()&&D.length>0&&(ee=ee.filter(_=>{const w=lt(Object.entries(_).filter(([Z])=>!Z.startsWith("_")).map(([,Z])=>String(Z||"")).join(" "));return D.every(Z=>w.includes(Z))})),v($(ee,D,z))},Je=(t,C)=>{window.KTM.clipboard.writeText(t).then(()=>{me(C),S("\u0110\xE3 copy!","success"),setTimeout(()=>me(null),1500)})},tt=async(t,C)=>{try{await window.KTM.clipboard.writeImageFromUrl(t),me(C+"-img"),S("\u0110\xE3 copy \u1EA3nh!","success"),setTimeout(()=>me(null),1500)}catch(D){Je(t,C+"-img")}},at=t=>{let C=t.toLowerCase();const D=[],z=O.filter(w=>w._type==="product");if(C.includes("ty")||C.includes("xy lanh")){if(C.includes("gi\u1EEFa")||C.includes("giua")){const w=z.find(Z=>{var oe;return(oe=Z.name)==null?void 0:oe.toLowerCase().includes("xy lanh gi\u1EEFa")});w&&!D.find(Z=>Z.id===w.id)&&D.push(w)}if(C.includes("nghi\xEAng")||C.includes("nghieng")){const w=z.find(Z=>{var oe;return(oe=Z.name)==null?void 0:oe.toLowerCase().includes("xy lanh nghi\xEAng")});w&&!D.find(Z=>Z.id===w.id)&&D.push(w)}if(C.includes("\u1EE7i")||C.includes("ui")){const w=z.find(Z=>{var oe;return(oe=Z.name)==null?void 0:oe.toLowerCase().includes("xy lanh \u1EE7i")});w&&!D.find(Z=>Z.id===w.id)&&D.push(w)}}const ee=C.match(/van\s*(\d+)\s*tay.*?(\d+)\s*ty/);if(ee){const w=ee[1],Z=ee[2],oe=z.find(ie=>{var ue;const Q=((ue=ie.name)==null?void 0:ue.toLowerCase())||"";return Q.includes("combo")&&Q.includes(`${w} tay`)&&(Q.includes(`${Z} xy`)||Q.includes(`${Z} xylanh`))});if(oe&&!D.find(ie=>ie.id===oe.id))D.push(oe);else{const ie=z.find(Q=>{var J;const ue=((J=Q.name)==null?void 0:J.toLowerCase())||"";return ue.includes("combo")&&ue.includes(`${w} tay`)});ie&&!D.find(Q=>Q.id===ie.id)&&D.push(ie)}}if(C.includes("combo")&&!ee){const w=C.match(/combo.*?(\d+)\s*tay/);if(w){const Z=w[1];z.filter(ie=>{var ue;const Q=((ue=ie.name)==null?void 0:ue.toLowerCase())||"";return Q.includes("combo")&&Q.includes(`${Z} tay`)}).forEach(ie=>{D.find(Q=>Q.id===ie.id)||D.push(ie)})}}const _=C.match(/van\s*(\d+)\s*tay/);if(_&&!C.includes("ty")&&!C.includes("combo")){const w=_[1],Z=z.find(oe=>{var Q;const ie=((Q=oe.name)==null?void 0:Q.toLowerCase())||"";return ie.includes(`van ${w} tay`)&&!ie.includes("combo")});Z&&!D.find(oe=>oe.id===Z.id)&&D.push(Z)}return D.slice(0,4)},nt=async t=>{if(!t.trim())return;const C={role:"user",content:t,attachments:[]};b(z=>[...z,C]),Y(""),P(!0);const D=at(t);setTimeout(()=>{var z;return(z=E.current)==null?void 0:z.scrollIntoView({behavior:"smooth"})},100);try{const ee=O.filter(Q=>Q._type==="product").map(Q=>{let ue=`- ${Q.name}`;return Q.code&&(ue+=` (M\xE3: ${Q.code})`),Q.price&&(ue+=` - Gi\xE1: ${Q.price.replace(/[đ\s]/g,"")}\u0111`),Q.category&&(ue+=` [${Q.category}]`),Q.note&&(ue+=` (${Q.note})`),ue}).join(`
`),w=m.slice(-6).map(Q=>`${Q.role==="user"?"Kh\xE1ch":"AI"}: ${Q.content}`).join(`
`),Z=w?`L\u1ECACH S\u1EEC H\u1ED8I THO\u1EA0I:
${w}

DANH S\xC1CH S\u1EA2N PH\u1EA8M:
${ee}`:ee,ie=(await window.KTM.api.postJSON(`${API_BASE}/api/ai-chat`,{message:t,context:Z,audience:"admin"},"API error")).response||"Xin l\u1ED7i, t\xF4i kh\xF4ng th\u1EC3 tr\u1EA3 l\u1EDDi l\xFAc n\xE0y.";b(Q=>[...Q,{role:"assistant",content:ie,attachments:D}])}catch(z){console.error("AI Error:",z);const ee=t.toLowerCase(),_=O.filter(Z=>{const oe=Object.values(Z).join(" ").toLowerCase();return ee.split(" ").some(ie=>oe.includes(ie))});let w="";_.length>0?(w=`T\xECm th\u1EA5y ${_.length} s\u1EA3n ph\u1EA9m li\xEAn quan:

`,_.slice(0,5).forEach(Z=>{w+=`\u2022 ${Z.name}`,Z.price&&(w+=` - ${Z.price.replace(/[đ\s]/g,"")}\u0111`),Z.note&&(w+=` (${Z.note})`),w+=`
`}),_.length>5&&(w+=`
...v\xE0 ${_.length-5} s\u1EA3n ph\u1EA9m kh\xE1c`)):w='Kh\xF4ng t\xECm th\u1EA5y s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p. H\xE3y th\u1EED t\u1EEB kh\xF3a kh\xE1c nh\u01B0 "van", "combo", "xy lanh"...',b(Z=>[...Z,{role:"assistant",content:w,attachments:_.slice(0,4)}])}P(!1),setTimeout(()=>{var z,ee;(z=E.current)==null||z.scrollIntoView({behavior:"smooth"}),(ee=r.current)==null||ee.focus()},100)};function St({show:t,product:C,categories:D,onClose:z,onSave:ee}){const[_,w]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[Z,oe]=useState(!1),[ie,Q]=useState(!1),ue=useRef(null),J=x=>window.KTM.money.formatVNDInputDigits(x),le=x=>{const I=window.KTM.money.getDigits(String(x!=null?x:"")),K=Number(I);return I&&Number.isFinite(K)?Math.trunc(K):0},Ue=(x,I)=>{if(x==null||x==="")return[];let K=x;if(typeof K=="string"){const H=K.trim();if(!H)return[];try{K=JSON.parse(H)}catch(X){return[]}}if(!Array.isArray(K))return[];const R=le(I);return K.map(H=>{var he;if(!H||typeof H!="object")return null;const X=String((he=H.name)!=null?he:"").trim(),be=(Array.isArray(H.options)?H.options:[]).map(Ke=>{var mt,xt,_t,gt,Tt,Dt,Ht;if(!Ke||typeof Ke!="object")return null;const Xe=String((mt=Ke.label)!=null?mt:"").trim();if(!Xe)return null;const Re=(Tt=(gt=(_t=(xt=Ke.price)!=null?xt:Ke.priceValue)!=null?_t:Ke.unit_price)!=null?gt:Ke.unitPrice)!=null?Tt:null,Qe=Number(Re);let kt=Number.isFinite(Qe)?Math.trunc(Qe):null;if(kt==null){const Bt=(Ht=(Dt=Ke.price_delta)!=null?Dt:Ke.priceDelta)!=null?Ht:null,Ft=Number(Bt);Number.isFinite(Ft)&&(kt=R+Math.trunc(Ft))}kt==null&&(kt=R);const ft=String(Math.max(0,Math.trunc(Number(kt)||0)));return{label:Xe,price:Math.max(0,Math.trunc(Number(kt)||0)),priceDigits:ft}}).filter(Boolean);return{name:X||"Bi\u1EBFn th\u1EC3",options:be}}).filter(Boolean)},st=x=>{if(x==null||x==="")return[];let I=x;if(typeof I=="string"){const K=I.trim();if(!K)return[];try{I=JSON.parse(K)}catch(R){return[]}}return I&&typeof I=="object"&&!Array.isArray(I)&&(I=Object.entries(I).map(([K,R])=>({key:K,value:R}))),Array.isArray(I)?I.map(K=>{var be,he,Ke,Xe,Re;if(!K||typeof K!="object")return null;const R=String((Ke=(he=(be=K.key)!=null?be:K.name)!=null?he:K.label)!=null?Ke:"").trim(),H=String((Xe=K.value)!=null?Xe:"").trim(),X=String((Re=K.unit)!=null?Re:"").trim();return R?{key:R,value:H,unit:X}:null}).filter(Boolean):[]};useEffect(()=>{var x,I;if(C)if(w({name:C.name||"",code:C.code||"",price:C.price||"",image:C.image||"",category:C.category||"",note:C.note||"",sort_order:C.sort_order||0,commission_percent:(I=(x=C.commission_percent)!=null?x:C.commissionPercent)!=null?I:5,variants:Ue(C.variants,C.price),attributes:st(C.attributes)}),C.price){const K=window.KTM.money.getDigits(C.price);Nt(K),w(R=>({...R,price:J(K)}))}else Nt("");else w({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),Nt("")},[C,t]);const Ge=x=>{w(I=>{var be;const K=le(I.price),R=String(K),H=Array.isArray(I.variants)?[...I.variants]:[],X={...H[x]||{},options:Array.isArray((be=H[x])==null?void 0:be.options)?[...H[x].options]:[]};return X.options=X.options.map(he=>({label:String((he==null?void 0:he.label)||""),price:K,priceDigits:R})),H[x]=X,{...I,variants:H}})},it=()=>{w(x=>{const I=le(x.price),K=String(I),H=(Array.isArray(x.variants)?[...x.variants]:[]).map(X=>{const be=(Array.isArray(X==null?void 0:X.options)?X.options:[]).map(he=>({label:String((he==null?void 0:he.label)||""),price:I,priceDigits:K}));return{name:String((X==null?void 0:X.name)||"Bi\u1EBFn th\u1EC3"),options:be}});return{...x,variants:H}})},[yt,dt]=React.useState(""),[$t,Nt]=React.useState(""),jt=x=>{const I=window.KTM.money.nextPriceInputState(x.target.value,$t);Nt(I.digits),w({..._,price:I.price})},wt=async(x,I=2)=>{const K=I*1024*1024;if(x.size<=K)return x;try{const R=await createImageBitmap(x),H=document.createElement("canvas");let X=R.width,be=R.height;const he=1200;return(X>he||be>he)&&(X>be?(be=Math.round(be/X*he),X=he):(X=Math.round(X/be*he),be=he)),H.width=X,H.height=be,H.getContext("2d").drawImage(R,0,0,X,be),R.close(),new Promise((Xe,Re)=>{H.toBlob(Qe=>{Qe?Xe(new File([Qe],x.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):Re(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(R){throw console.error("Compress error:",R),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},Et=async x=>{var R;const I=x.target.files[0];if(!I)return;if(!(I.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp)$/i.test(I.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}Q(!0);try{const H=await wt(I),X=await window.KTM.cloudinary.uploadImage({file:H,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-products"});if(!X.secure_url)throw console.error("Cloudinary error:",X),new Error(((R=X.error)==null?void 0:R.message)||"Upload failed");w(be=>({...be,image:X.secure_url}))}catch(H){console.error("Upload error:",H),alert("L\u1ED7i upload \u1EA3nh: "+H.message)}Q(!1),x.target.value=""},qt=async x=>{x.preventDefault(),oe(!0);const I={..._,variants:Ue(_.variants,_.price),attributes:st(_.attributes)};await ee(I),oe(!1)};return t?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-lg"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,border:"none",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark"},React.createElement("i",{className:"fas fa-box me-2"}),C?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:z})),React.createElement("form",{onSubmit:qt},React.createElement("div",{className:"modal-body",style:{maxHeight:"70vh",overflowY:"auto"}},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-8"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-tag me-1"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:_.name,onChange:x=>w({..._,name:x.target.value}),placeholder:"V\xED d\u1EE5: Xy lanh nghi\xEAng KTM",required:!0,style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-hashtag me-1"}),"M\xE3 s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:_.code,onChange:x=>w({..._,code:x.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1"}),"Gi\xE1 b\xE1n"),React.createElement("input",{type:"text",className:"form-control",value:_.price,onChange:jt,placeholder:"1.950.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3 mt-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-percent me-1"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:_.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:x=>w({..._,commission_percent:x.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-list me-1"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:_.category,onChange:x=>w({..._,category:x.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),D.map(x=>React.createElement("option",{key:x,value:x},x)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1"}),"Ghi ch\xFA"),React.createElement("textarea",{className:"form-control",rows:"2",value:_.note,onChange:x=>w({..._,note:x.target.value}),placeholder:"V\xED d\u1EE5: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(_.attributes)?_.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(_.attributes)?_.attributes:[]).map((x,I)=>React.createElement("div",{key:I,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(x==null?void 0:x.key)||"",onChange:K=>{const R=K.target.value;w(H=>{const X=Array.isArray(H.attributes)?[...H.attributes]:[];return X[I]={...X[I]||{},key:R},{...H,attributes:X}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(x==null?void 0:x.value)||"",onChange:K=>{const R=K.target.value;w(H=>{const X=Array.isArray(H.attributes)?[...H.attributes]:[];return X[I]={...X[I]||{},value:R},{...H,attributes:X}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(x==null?void 0:x.unit)||"",onChange:K=>{const R=K.target.value;w(H=>{const X=Array.isArray(H.attributes)?[...H.attributes]:[];return X[I]={...X[I]||{},unit:R},{...H,attributes:X}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{w(K=>{const R=Array.isArray(K.attributes)?[...K.attributes]:[];return R.splice(I,1),{...K,attributes:R}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{w(x=>{const I=Array.isArray(x.attributes)?[...x.attributes]:[];return I.push({key:"",value:"",unit:""}),{...x,attributes:I}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(_.variants)?_.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3. C\xF3 th\u1EC3 th\xEAm (v\xED d\u1EE5 Size: S/M/L)."):null,(Array.isArray(_.variants)?_.variants:[]).map((x,I)=>React.createElement("div",{key:I,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(x==null?void 0:x.name)||"",onChange:K=>{const R=K.target.value;w(H=>{var be;const X=Array.isArray(H.variants)?[...H.variants]:[];return X[I]={...X[I]||{},name:R,options:Array.isArray((be=X[I])==null?void 0:be.options)?X[I].options:[]},{...H,variants:X}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>Ge(I),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(x==null?void 0:x.options)||x.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{w(K=>{const R=Array.isArray(K.variants)?[...K.variants]:[];return R.splice(I,1),{...K,variants:R}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(x==null?void 0:x.options)?x.options:[]).map((K,R)=>{var H,X;return React.createElement("div",{key:R,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(K==null?void 0:K.label)||"",onChange:be=>{const he=be.target.value;w(Ke=>{var ft,mt,xt,_t,gt;const Xe=Array.isArray(Ke.variants)?[...Ke.variants]:[],Re={...Xe[I]||{},options:Array.isArray((ft=Xe[I])==null?void 0:ft.options)?[...Xe[I].options]:[]},Qe=Number((xt=(mt=Re.options[R])==null?void 0:mt.price)!=null?xt:0)||0,kt=String((gt=(_t=Re.options[R])==null?void 0:_t.priceDigits)!=null?gt:Math.max(0,Math.trunc(Qe)));return Re.options[R]={...Re.options[R]||{},label:he,price:Math.max(0,Math.trunc(Qe)),priceDigits:kt},Xe[I]=Re,{...Ke,variants:Xe}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:J(String((X=K==null?void 0:K.priceDigits)!=null?X:window.KTM.money.getDigits(String((H=K==null?void 0:K.price)!=null?H:"")))),onChange:be=>{w(he=>{var xt,_t,gt,Tt,Dt;const Ke=String((_t=K==null?void 0:K.priceDigits)!=null?_t:window.KTM.money.getDigits(String((xt=K==null?void 0:K.price)!=null?xt:""))),Xe=window.KTM.money.nextPriceInputState(be.target.value,Ke),Re=String((gt=Xe.digits)!=null?gt:""),Qe=Number(Re),kt=Number.isFinite(Qe)?Math.max(0,Math.trunc(Qe)):0,ft=Array.isArray(he.variants)?[...he.variants]:[],mt={...ft[I]||{},options:Array.isArray((Tt=ft[I])==null?void 0:Tt.options)?[...ft[I].options]:[]};return mt.options[R]={...mt.options[R]||{},label:String(((Dt=mt.options[R])==null?void 0:Dt.label)||""),price:kt,priceDigits:Re},ft[I]=mt,{...he,variants:ft}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{w(be=>{var Xe;const he=Array.isArray(be.variants)?[...be.variants]:[],Ke={...he[I]||{},options:Array.isArray((Xe=he[I])==null?void 0:Xe.options)?[...he[I].options]:[]};return Ke.options.splice(R,1),he[I]=Ke,{...be,variants:he}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{w(K=>{var be;const R=Array.isArray(K.variants)?[...K.variants]:[],H={...R[I]||{},options:Array.isArray((be=R[I])==null?void 0:be.options)?[...R[I].options]:[]},X=le(K.price);return H.options.push({label:"",price:X,priceDigits:String(X)}),R[I]=H,{...K,variants:R}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{w(x=>{const I=le(x.price),K=Array.isArray(x.variants)?[...x.variants]:[],R=String(I);return K.push({name:"Size",options:[{label:"S",price:I,priceDigits:R},{label:"M",price:I,priceDigits:R},{label:"L",price:I,priceDigits:R}]}),{...x,variants:K}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:it,disabled:!Array.isArray(_.variants)||_.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111.")))),React.createElement("div",{className:"col-md-4"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-image me-1"}),"\u1EA2nh s\u1EA3n ph\u1EA9m"),React.createElement("div",{className:"mb-2"},_.image?React.createElement(React.Fragment,null,React.createElement("img",{src:_.image,alt:"Product",style:{width:"100%",height:150,objectFit:"cover",borderRadius:"12px",border:"2px solid #e9ecef"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger mt-2",onClick:()=>w({..._,image:""}),style:{borderRadius:"20px",fontSize:"0.75rem"}},React.createElement("i",{className:"fas fa-times me-1"}),"X\xF3a \u1EA3nh")):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:"100%",height:150,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd",cursor:"pointer"},onClick:()=>{var x;return(x=ue.current)==null?void 0:x.click()}},React.createElement("div",{className:"text-center"},React.createElement("i",{className:"fas fa-cloud-upload-alt fa-2x text-muted mb-2"}),React.createElement("div",{className:"small text-muted"},"Click \u0111\u1EC3 upload")))),React.createElement("input",{ref:ue,type:"file",accept:"image/*",className:"d-none",onChange:Et}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100",onClick:()=>{var x;return(x=ue.current)==null?void 0:x.click()},disabled:ie,style:{borderRadius:"10px"}},ie?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh")),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"Ho\u1EB7c URL \u1EA3nh"),React.createElement("input",{type:"url",className:"form-control",value:_.image,onChange:x=>w({..._,image:x.target.value}),placeholder:"https://...",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"8px",fontSize:"0.875rem"}}))))),React.createElement("div",{className:"modal-footer",style:{border:"none",padding:"20px"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:z,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:Z,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},Z?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}const Mt=t=>window.KTM.money.formatVND(t),ht=t=>{if(t==null||t==="")return[];let C=t;if(typeof C=="string"){const D=C.trim();if(!D)return[];try{C=JSON.parse(D)}catch(z){return[]}}return Array.isArray(C)?C:[]},He=(t,C={})=>{var oe;const D=ht(t).map(ie=>{var Q;return{name:String((Q=ie==null?void 0:ie.name)!=null?Q:"").trim(),options:Array.isArray(ie==null?void 0:ie.options)?ie.options:[]}}).map(ie=>({...ie,options:ie.options.map(Q=>{var ue;return{label:String((ue=Q==null?void 0:Q.label)!=null?ue:"").trim(),price:Number(Q==null?void 0:Q.price)}}).filter(Q=>!!Q.label)})).filter(ie=>ie.options.length>0);if(!D.length)return null;const z=Number.isFinite(C.maxGroups)?Math.max(1,Math.trunc(C.maxGroups)):D.length,ee=Number.isFinite(C.maxOptionsPerGroup)?Math.max(1,Math.trunc(C.maxOptionsPerGroup)):3,_=!!C.compact,w=String((oe=C.className)!=null?oe:"").trim(),Z=D.slice(0,z);return React.createElement("div",{className:`ktm-variants-preview${_?" compact":""}${w?" "+w:""}`},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},Z.map((ie,Q)=>{const ue=ie.name||"Bi\u1EBFn th\u1EC3",J=ie.options.slice(0,ee),le=ie.options.length-J.length;return React.createElement("div",{key:`${ue}-${Q}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},ue),J.map((Ue,st)=>{const Ge=Ue.price,it=Number.isFinite(Ge)&&Ge>=0?Mt(Math.trunc(Ge)):"",yt=it?`${Ue.label} \xB7 ${it}`:Ue.label;return React.createElement("span",{key:`${ue}-${Q}-${st}`,className:"ktm-chip ktm-chip-option"},yt)}),le>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",le))})))},Kt=(t,C)=>{const D=t._type==="product",z=t._type==="album",ee=t._type==="video",_=t.note&&(t.note.toLowerCase().includes("free")||t.note.toLowerCase().includes("gi\u1EA3m")||t.note.toLowerCase().includes("sale")),w=D?He(t.variants,{compact:ye==="grid",maxOptionsPerGroup:999,className:ye==="grid"?"meta text-muted":"text-muted"}):null;return ye==="grid"?React.createElement("div",{key:t.id||C,className:"grid-card"},React.createElement("div",{className:"thumb-wrap",onClick:()=>Ae({url:t.image,name:t.name,price:t.price,note:t.note,item:t})},t.image?React.createElement("img",{src:t.image,alt:t.name,className:"thumb",loading:"lazy"}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${ee?"fa-video":"fa-image"} fa-2x text-muted`})),t.price&&React.createElement("div",{className:"price-overlay"},t.price.replace(/[đ\s]/g,""),"\u0111"),React.createElement("span",{className:`type-badge ${D?"product":z?"album":"video"}`},D?"SP":z?"\u1EA2nh":"Video"),_&&React.createElement("span",{className:"promo-badge"},"\u{1F525} \u01AFU \u0110\xC3I")),React.createElement("div",{className:"card-body"},React.createElement("div",{className:"name"},t.name),t.note&&React.createElement("div",{className:"meta text-info",style:{fontSize:10}},t.note),w&&React.createElement("div",{style:{marginTop:2}},w),React.createElement("div",{className:"quick-copy"},React.createElement("button",{className:se===t.id+"-img"?"copied":"",onClick:()=>tt(t.image,t.id)},React.createElement("i",{className:"fas fa-image"})),t.price&&React.createElement("button",{className:se===t.id+"-price"?"copied":"",onClick:()=>Je(t.price.replace(/[đ\s]/g,""),t.id+"-price")},React.createElement("i",{className:"fas fa-tag"}))))):React.createElement("div",{key:t.id||C,className:"product-card-mobile"},React.createElement("span",{className:`type-badge ${D?"product":z?"album":"video"}`},D?"S\u1EA3n ph\u1EA9m":z?"\u1EA2nh":"Video"),React.createElement("div",{className:"card-inner"},t.image?React.createElement("img",{src:t.image,alt:t.name,className:"thumb",loading:"lazy",onClick:()=>Ae({url:t.image,name:t.name,price:t.price,note:t.note,item:t})}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${ee?"fa-video":"fa-image"} fa-2x text-muted`})),React.createElement("div",{className:"info"},React.createElement("div",null,React.createElement("div",{className:"name"},t.name),React.createElement("div",{className:"price-row"},t.price&&React.createElement("span",{className:"price"},t.price.replace(/[đ\s]/g,""),"\u0111"),_&&React.createElement("span",{className:"badge-promo"},"\u{1F525} \u01AFU \u0110\xC3I")),w&&React.createElement("div",{style:{marginTop:4}},w)),React.createElement("div",{className:"meta"},t.code&&React.createElement("span",{className:"meta-tag"},"#",t.code),t.category&&React.createElement("span",{className:"meta-tag"},t.category),t.note&&React.createElement("span",{className:"meta-tag highlight"},t.note),t.folder&&React.createElement("span",{className:"meta-tag"},t.folder),ee&&React.createElement("span",{className:"meta-tag"},React.createElement("i",{className:"fab fa-youtube text-danger"})," Video")))),React.createElement("div",{className:"quick-actions"},D&&React.createElement("button",{onClick:()=>y&&y("orders","create",{productId:t.id})},React.createElement("i",{className:"fas fa-receipt"})," T\u1EA1o \u0111\u01A1n"),t.price&&React.createElement("button",{className:se===t.id+"-price"?"copied":"",onClick:()=>Je(t.price.replace(/[đ\s]/g,""),t.id+"-price")},React.createElement("i",{className:"fas fa-tag"})," Gi\xE1"),React.createElement("button",{className:se===t.id+"-name"?"copied":"",onClick:()=>Je(t.name,t.id+"-name")},React.createElement("i",{className:"fas fa-font"})," T\xEAn"),ee&&t.youtubeId&&React.createElement("button",{className:se===t.id+"-yt"?"copied":"",onClick:()=>Je(`https://www.youtube.com/watch?v=${t.youtubeId}`,t.id+"-yt")},React.createElement("i",{className:"fab fa-youtube"})),D&&React.createElement("button",{className:"action-edit",onClick:()=>At(t)},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"action-delete",onClick:()=>Rt(t)},React.createElement("i",{className:"fas fa-trash"}))))},[ut,Te]=useState(!1);return React.createElement(React.Fragment,null,React.createElement("div",{className:"result-header"},React.createElement("span",null,React.createElement("strong",null,U.length)," k\u1EBFt qu\u1EA3",Ce&&M.length>=3&&React.createElement("span",{className:"ai-badge ms-2"},React.createElement("i",{className:"fas fa-robot"})," AI"),pe!=="all"&&React.createElement("span",{className:"ms-2 badge bg-warning text-dark"},pe==="product"?"S\u1EA3n ph\u1EA9m":pe==="album"?"\u1EA2nh":"Video")),React.createElement("div",{className:"d-flex gap-1 align-items-center"},React.createElement("button",{className:`btn btn-sm ${ye==="list"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>ce("list"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-list"})),React.createElement("button",{className:`btn btn-sm ${ye==="grid"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>ce("grid"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-th"})))),React.createElement("div",{className:"search-results-area"},de?React.createElement("div",null,[...Array(8)].map((t,C)=>React.createElement("div",{key:C,className:"product-card-mobile mb-2",style:{opacity:.7}},React.createElement("div",{className:"card-inner"},React.createElement("div",{className:"thumb bg-light",style:{width:80,height:80,borderRadius:8}}),React.createElement("div",{className:"info",style:{flex:1,minWidth:0}},React.createElement("div",{className:"skeleton-box mb-2",style:{height:16,width:"60%",background:"#eee",borderRadius:4}}),React.createElement("div",{className:"skeleton-box mb-1",style:{height:12,width:"40%",background:"#f3f3f3",borderRadius:4}}),React.createElement("div",{className:"skeleton-box",style:{height:10,width:"30%",background:"#f3f3f3",borderRadius:4}})))))):U.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-search"}),React.createElement("p",null,'Kh\xF4ng t\xECm th\u1EA5y "',M,'"'),React.createElement("button",{className:"btn btn-warning",onClick:()=>{W(""),Fe("")}},"Xem t\u1EA5t c\u1EA3")):ye==="grid"?React.createElement("div",{className:"product-grid-mobile"},U.map((t,C)=>Kt(t,C))):React.createElement("div",null,U.map((t,C)=>Kt(t,C)))),ut&&React.createElement("div",{className:"filter-dropdown"},React.createElement("div",{className:"filter-header"},React.createElement("strong",null,"L\u1ECDc theo lo\u1EA1i"),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>Te(!1)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"filter-chips"},React.createElement("span",{className:`filter-chip ${pe==="all"?"active":""}`,onClick:()=>{Ve("all"),Te(!1)}},"T\u1EA5t c\u1EA3"),React.createElement("span",{className:`filter-chip ${pe==="product"?"active":""}`,onClick:()=>{Ve("product"),Te(!1)}},React.createElement("i",{className:"fas fa-box me-1"}),"S\u1EA3n ph\u1EA9m"),React.createElement("span",{className:`filter-chip ${pe==="album"?"active":""}`,onClick:()=>{Ve("album"),Te(!1)}},React.createElement("i",{className:"fas fa-images me-1"}),"\u1EA2nh"),React.createElement("span",{className:`filter-chip ${pe==="video"?"active":""}`,onClick:()=>{Ve("video"),Te(!1)}},React.createElement("i",{className:"fas fa-video me-1"}),"Video")),React.createElement("div",{className:"mt-3 pt-3 border-top d-flex align-items-center justify-content-between"},React.createElement("span",null,"AI Search th\xF4ng minh"),React.createElement("div",{className:"form-check form-switch m-0"},React.createElement("input",{type:"checkbox",className:"form-check-input",checked:Ce,onChange:t=>$e(t.target.checked),style:{width:40,height:20}})))),React.createElement("div",{className:"search-bar-bottom"},React.createElement("div",{className:"search-input-wrap"},React.createElement("input",{ref:Ne,type:"text",className:"search-input",placeholder:"\u{1F50D} T\xECm: van 3 tay, xylanh...",value:M,onChange:t=>Fe(t.target.value)}),React.createElement("button",{className:`filter-btn ${ut||pe!=="all"?"active":""}`,onClick:()=>Te(!ut)},React.createElement("i",{className:"fas fa-filter"})))),React.createElement("button",{className:"btn btn-lg rounded-circle position-fixed shadow-lg",style:{bottom:g?320:130,right:16,width:56,height:56,zIndex:1050,transition:"bottom 0.2s ease",background:"linear-gradient(135deg, #667eea, #764ba2)",color:"#fff",border:"none",WebkitTapHighlightColor:"transparent",touchAction:"manipulation",cursor:"pointer",outline:"none"},onClick:()=>s(!0),onTouchStart:()=>s(!0)},React.createElement("i",{className:"fas fa-robot fa-lg"})),qe&&React.createElement("div",{className:"ai-chat-mobile"},React.createElement("div",{className:"chat-header"},React.createElement("button",{className:"back-btn",onClick:()=>s(!1)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("strong",null,"KTM AI Assistant"),React.createElement("div",{style:{fontSize:11,opacity:.8}},"H\u1ECFi v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3..."))),React.createElement("div",{className:"chat-messages"},m.map((t,C)=>React.createElement("div",{key:C,className:`mb-3 ${t.role==="user"?"d-flex justify-content-end":""}`},React.createElement("div",{className:`p-3 rounded-3 position-relative ${t.role==="user"?"text-white":"bg-white border"}`,style:{maxWidth:"85%",whiteSpace:"pre-wrap",background:t.role==="user"?"linear-gradient(135deg, #667eea, #764ba2)":void 0}},t.content,t.role==="assistant"&&React.createElement("button",{className:"btn btn-sm position-absolute",style:{top:4,right:4,padding:"2px 6px",fontSize:11,background:se===`chat-${C}`?"#28a745":"rgba(0,0,0,0.1)",border:"none",borderRadius:4,color:se===`chat-${C}`?"#fff":"#666"},onClick:()=>{window.KTM.clipboard.writeText(t.content),me(`chat-${C}`),setTimeout(()=>me(null),1500)}},React.createElement("i",{className:`fas ${se===`chat-${C}`?"fa-check":"fa-copy"}`})),t.attachments&&t.attachments.length>0&&React.createElement("div",{className:"mt-2 d-flex flex-wrap gap-2"},t.attachments.map((D,z)=>React.createElement("div",{key:z,style:{width:70},className:"text-center"},D.image&&React.createElement("img",{src:D.image,className:"rounded",style:{width:70,height:50,objectFit:"cover",cursor:"pointer"},onClick:()=>Ae({url:D.image,name:D.name,price:D.price})}),React.createElement("div",{style:{fontSize:9},className:"text-truncate"},D.name),D.price&&React.createElement("div",{style:{fontSize:10,color:"#dc3545",fontWeight:600}},D.price.replace(/[đ\s]/g,""),"\u0111"))))))),L&&React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"bg-white border p-3 rounded-3 d-inline-block"},React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang suy ngh\u0129...")),React.createElement("div",{ref:E})),React.createElement("div",{className:"px-3 py-2 border-top d-flex gap-2 overflow-auto"},["Gi\xE1 van 2 tay?","Combo r\u1EBB nh\u1EA5t?","Freeship?","Van 3 tay?"].map(t=>React.createElement("button",{key:t,className:"btn btn-sm btn-outline-secondary flex-shrink-0",onClick:()=>nt(t),disabled:L,style:{whiteSpace:"nowrap"}},t))),React.createElement("div",{className:"chat-input-area"},React.createElement("form",{onSubmit:t=>{t.preventDefault(),nt(A)},className:"chat-input-wrap"},React.createElement("input",{ref:r,type:"text",className:"chat-input",placeholder:"Nh\u1EADp c\xE2u h\u1ECFi...",value:A,onChange:t=>Y(t.target.value),disabled:L}),React.createElement("button",{type:"submit",className:"send-btn",disabled:L||!A.trim()},React.createElement("i",{className:"fas fa-paper-plane"}))))),G&&React.createElement("div",{className:"preview-modal",onClick:()=>Ae(null)},React.createElement("div",{className:"preview-header"},React.createElement("div",null),React.createElement("button",{className:"close-btn",onClick:()=>Ae(null)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"preview-body",onClick:t=>t.stopPropagation()},React.createElement("img",{src:G.url,alt:G.name})),React.createElement("div",{className:"preview-footer",onClick:t=>t.stopPropagation()},React.createElement("div",{className:"name"},G.name),G.price&&React.createElement("div",{className:"price"},G.price.replace(/[đ\s]/g,""),"\u0111"),G.note&&React.createElement("div",{className:"mb-2",style:{fontSize:14,color:"#17a2b8"}},G.note),React.createElement("div",{className:"action-btns"},React.createElement("button",{className:se==="preview-img"?"btn-success text-white":"btn-outline-light text-white",style:{background:se==="preview-img"?"#28a745":"rgba(255,255,255,0.2)"},onClick:()=>tt(G.url,"preview")},React.createElement("i",{className:`fas ${se==="preview-img"?"fa-check":"fa-copy"}`}),"Copy \u1EA3nh"),G.price&&React.createElement("button",{className:se==="preview-price"?"btn-success text-white":"btn-warning",onClick:()=>Je(G.price.replace(/[đ\s]/g,""),"preview-price")},React.createElement("i",{className:`fas ${se==="preview-price"?"fa-check":"fa-tag"}`}),"Copy gi\xE1")))),React.createElement(St,{show:F,product:Ye,categories:re,onClose:()=>{Me(!1),Ie(null)},onSave:Pt}),React.createElement("div",{className:`fab-container mobile-only ${g?"open":""}`},React.createElement("div",{className:"fab-actions"},React.createElement("button",{className:"fab-action product",onClick:()=>{q(!1),Me(!0),Ie(null)}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",{className:"tooltip"},"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("button",{className:"fab-action product",onClick:()=>{q(!1),y&&y("orders","create")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",{className:"tooltip"},"T\u1EA1o order nhanh"))),React.createElement("button",{className:`fab-main ${g?"open":""}`,onClick:()=>q(!g)},React.createElement("i",{className:"fas fa-plus"}))),Le&&h&&React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,maxHeight:"90vh"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none"}},React.createElement("h6",{className:"modal-title fw-bold"},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa nhanh"),React.createElement("button",{type:"button",className:"btn-close",onClick:()=>l(!1)})),React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"T\xEAn s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:Pe.name,onChange:t=>ze({...Pe,name:t.target.value})})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:Pe.code,onChange:t=>ze({...Pe,code:t.target.value})})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:Pe.price,onChange:t=>ze({...Pe,price:t.target.value})}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:Pe.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:t=>ze({...Pe,commission_percent:t.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:Pe.category,onChange:t=>ze({...Pe,category:t.target.value})},React.createElement("option",{value:""},"-- Ch\u1ECDn danh m\u1EE5c --"),ct.map(t=>React.createElement("option",{key:t,value:t},t)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Ghi ch\xFA (\u01B0u \u0111\xE3i)"),React.createElement("input",{type:"text",className:"form-control",value:Pe.note,placeholder:"VD: Free ship, Gi\u1EA3m 10%...",onChange:t=>ze({...Pe,note:t.target.value})}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>l(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-warning",onClick:vt},React.createElement("i",{className:"fas fa-save me-1"}),"L\u01B0u"))))))}function VideoList({onRefresh:S,showToast:y}){const[M,W]=useState([]),[U,v]=useState([]),[O,ae]=useState(!0),[re,B]=useState(null),[pe,xe]=useState(!1),[se,me]=useState(null),[ye,ce]=useState(!1),[de,ne]=useState(null),[ke,fe]=useState(null),[De,Se]=useState([]);useEffect(()=>{Ne()},[]);const Ne=async(l=null)=>{ae(!0);try{const h=l?`${API_BASE}/api/video-folders?withVideos=true&parent_id=${l}`:`${API_BASE}/api/video-folders?withVideos=true&parent_id=root`,ge=await window.KTM.api.getJSON(h,"L\u1ED7i t\u1EA3i danh s\xE1ch folder");W(Array.isArray(ge)?ge:[])}catch(h){console.error(h),y("L\u1ED7i t\u1EA3i danh s\xE1ch folder","danger")}ae(!1)},Ce=async l=>{try{const h=await window.KTM.api.getJSON(`${API_BASE}/api/videos?folderId=${l}`,"L\u1ED7i t\u1EA3i video");v(Array.isArray(h)?h:[])}catch(h){console.error(h)}},$e=async l=>{if(l===0)return;const h=[...M];[h[l-1],h[l]]=[h[l],h[l-1]],W(h),await _e(h)},et=async l=>{if(l===M.length-1)return;const h=[...M];[h[l],h[l+1]]=[h[l+1],h[l]],W(h),await _e(h)},_e=async l=>{try{await Promise.all(l.map((h,ge)=>window.KTM.api.putJSON(`${API_BASE}/api/video-folders/${h.id}`,{sortOrder:ge},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),y("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(h){y("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),Ne(ke==null?void 0:ke.id)}},Oe=async l=>{if(l===0)return;const h=[...U];[h[l-1],h[l]]=[h[l],h[l-1]],v(h),await s(h)},qe=async l=>{if(l===U.length-1)return;const h=[...U];[h[l],h[l+1]]=[h[l+1],h[l]],v(h),await s(h)},s=async l=>{try{await Promise.all(l.map((h,ge)=>window.KTM.api.putJSON(`${API_BASE}/api/videos/${h.id}`,{sort_order:ge},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),y("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(h){y("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),Ce(re.id)}},m=()=>{me(null),xe(!0)},b=l=>{me(l),xe(!0)},A=async l=>{try{!se&&ke&&(l.parent_id=ke.id);const h=se?`${API_BASE}/api/video-folders/${se.id}`:`${API_BASE}/api/video-folders`;se?await window.KTM.api.putJSON(h,l,"L\u1ED7i l\u01B0u folder"):await window.KTM.api.postJSON(h,l,"L\u1ED7i l\u01B0u folder"),y(se?"\u0110\xE3 c\u1EADp nh\u1EADt folder!":"\u0110\xE3 t\u1EA1o folder m\u1EDBi!","success"),xe(!1),Ne(ke==null?void 0:ke.id)}catch(h){y(h.message,"danger")}},Y=async l=>{const h=l.subfolderCount>0?`X\xF3a folder "${l.name}"? T\u1EA5t c\u1EA3 subfolder v\xE0 videos b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`:`X\xF3a folder "${l.name}"? Videos trong folder s\u1EBD kh\xF4ng b\u1ECB x\xF3a.`;if(confirm(h))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/video-folders/${l.id}`,"L\u1ED7i x\xF3a folder"),y("\u0110\xE3 x\xF3a folder","success"),B(null),Ne(ke==null?void 0:ke.id)}catch(ge){y("L\u1ED7i x\xF3a folder","danger")}},L=l=>{l.subfolderCount>0?(Se(h=>[...h,l]),fe(l),Ne(l.id)):(B(l),v(l.videos||[]))},P=l=>{if(l==="root")Se([]),fe(null),Ne(null);else if(l){const h=De.findIndex(ge=>ge.id===l.id);h>=0&&(Se(De.slice(0,h+1)),fe(l),Ne(l.id))}else{const h=[...De];h.pop();const ge=h[h.length-1]||null;Se(h),fe(ge),Ne(ge==null?void 0:ge.id)}},E=()=>{ne(null),ce(!0)},r=l=>{ne(l),ce(!0)},G=async l=>{try{l.folder_id=re==null?void 0:re.id;const h=de?`${API_BASE}/api/videos/${de.id}`:`${API_BASE}/api/videos`;de?await window.KTM.api.putJSON(h,l,"L\u1ED7i l\u01B0u video"):await window.KTM.api.postJSON(h,l,"L\u1ED7i l\u01B0u video"),y(de?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm video th\xE0nh c\xF4ng!","success"),ce(!1),Ne(),re&&Ce(re.id)}catch(h){y(h.message,"danger")}},Ae=async l=>{if(confirm(`X\xF3a video "${l.title}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/videos/${l.id}`,"L\u1ED7i x\xF3a video"),y("\u0110\xE3 x\xF3a video","success"),Ne(),re&&Ce(re.id)}catch(h){y("L\u1ED7i x\xF3a video","danger")}},Le=l=>{const h=`https://www.youtube.com/watch?v=${l.youtubeId}`;window.KTM.clipboard.writeText(h).then(()=>{y("\u0110\xE3 copy link!","success")}).catch(()=>{y("Kh\xF4ng th\u1EC3 copy link","danger")})};return re?React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>B(null)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:`fas fa-folder-open me-2 ${re.slug==="shorts"?"text-danger":"text-warning"}`}),re.name)),React.createElement("button",{className:"btn btn-warning",onClick:E},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm Video")),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1 videos"),U.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-video fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},"Ch\u01B0a c\xF3 video trong folder n\xE0y")):React.createElement("div",{className:"row g-4"},U.map((l,h)=>React.createElement("div",{key:l.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>Oe(h),disabled:h===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},h+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>qe(h),disabled:h===U.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"position-relative"},React.createElement("img",{src:l.thumb,className:"card-img-top",alt:l.title,style:{height:"120px",objectFit:"cover"}}),React.createElement("a",{href:`https://www.youtube.com/watch?v=${l.youtubeId}`,target:"_blank",className:"position-absolute top-50 start-50 translate-middle"},React.createElement("i",{className:"fas fa-play-circle fa-3x text-white",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"}}))),React.createElement("div",{className:"card-body py-2"},React.createElement("h6",{className:"card-title small mb-1 text-truncate",title:l.title},l.title),React.createElement("small",{className:"text-muted"},l.youtubeId)),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-primary",onClick:()=>Le(l),title:"Copy link"},React.createElement("i",{className:"fas fa-link"})),React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>r(l),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-outline-danger",onClick:()=>Ae(l),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))))),React.createElement(VideoModal,{show:ye,video:de,onClose:()=>ce(!1),onSave:G})):React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},ke&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>P()},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-video me-2 text-warning"}),ke?ke.name:"Qu\u1EA3n l\xFD Video")),React.createElement("button",{className:"btn btn-warning",onClick:m},React.createElement("i",{className:"fas fa-folder-plus me-2"}),"T\u1EA1o Folder")),De.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:l=>{l.preventDefault(),P("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),De.map((l,h)=>React.createElement("li",{key:l.id,className:`breadcrumb-item ${h===De.length-1?"active":""}`},h===De.length-1?l.name:React.createElement("a",{href:"#",onClick:ge=>{ge.preventDefault(),P(l)},className:"text-warning"},l.name))))),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1. Click v\xE0o folder \u0111\u1EC3 v\xE0o b\xEAn trong."),O?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):M.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},ke?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder video n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:m},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o folder",ke?" con":" \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"row g-3"},M.map((l,h)=>{var ge,g,q,F;return React.createElement("div",{key:l.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-card"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Me=>{Me.stopPropagation(),$e(h)},disabled:h===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},h+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Me=>{Me.stopPropagation(),et(h)},disabled:h===M.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"card-body text-center py-3",onClick:()=>L(l),style:{cursor:"pointer"}},React.createElement("i",{className:`fas fa-folder fa-3x mb-3 ${l.slug==="shorts"?"text-danger":"text-warning"}`}),React.createElement("h5",{className:"card-title"},l.name),React.createElement("p",{className:"text-muted mb-0"},l.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),l.subfolderCount," folder"),l.subfolderCount>0&&(l.videoCount>0||((ge=l.videos)==null?void 0:ge.length)>0)&&" \u2022 ",(l.videoCount>0||((g=l.videos)==null?void 0:g.length)>0)&&React.createElement("span",null,React.createElement("i",{className:"fas fa-video me-1"}),l.videoCount||((q=l.videos)==null?void 0:q.length)||0," videos"),l.subfolderCount===0&&!l.videoCount&&!((F=l.videos)!=null&&F.length)&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:Me=>{Me.stopPropagation(),b(l)}},React.createElement("i",{className:"fas fa-edit"})," S\u1EEDa"),React.createElement("button",{className:"btn btn-outline-danger",onClick:Me=>{Me.stopPropagation(),Y(l)}},React.createElement("i",{className:"fas fa-trash"})," X\xF3a")))))})),React.createElement(VideoFolderModal,{show:pe,folder:se,onClose:()=>xe(!1),onSave:A}))}function VideoFolderModal({show:S,folder:y,onClose:M,onSave:W}){const[U,v]=useState({name:"",description:"",sortOrder:0,coverImage:""}),[O,ae]=useState(!1),[re,B]=useState(!1);useEffect(()=>{v(y?{name:y.name||"",description:y.description||"",sortOrder:y.sortOrder||0,coverImage:y.coverImage||""}:{name:"",description:"",sortOrder:0,coverImage:""})},[y,S]);const pe=async se=>{const me=se.target.files[0];if(me){B(!0);try{const ye=await window.KTM.cloudinary.uploadImage({file:me,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});ye.secure_url&&v(ce=>({...ce,coverImage:ye.secure_url})),window.KTM.cache.remove(CACHE_KEY),showToast("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),setShowQuickEdit(!1),setEditingItem(null),loadAllData()}catch(ye){console.error("Cloudinary upload error:",ye),alert("L\u1ED7i upload \u1EA3nh: "+(ye.message||ye))}finally{B(!1)}}},xe=async se=>{se.preventDefault(),ae(!0);const me={...U,variants:normalizeVariants(U.variants,U.price),attributes:normalizeAttributes(U.attributes)};await W(me),ae(!1)};return S?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},y?"S\u1EEDa Folder":"T\u1EA1o Folder m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:M})),React.createElement("form",{onSubmit:xe},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn folder *"),React.createElement("input",{type:"text",className:"form-control",value:U.name,onChange:se=>v({...U,name:se.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",value:U.description,onChange:se=>v({...U,description:se.target.value}),rows:"2"})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:U.sortOrder,onChange:se=>v({...U,sortOrder:parseInt(se.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex align-items-start gap-3"},U.coverImage?React.createElement("div",{className:"position-relative"},React.createElement("img",{src:U.coverImage,alt:"Cover",className:"rounded",style:{width:120,height:80,objectFit:"cover"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute top-0 end-0",onClick:()=>v({...U,coverImage:""}),style:{transform:"translate(30%, -30%)"}},React.createElement("i",{className:"fas fa-times"}))):React.createElement("div",{className:"bg-light rounded d-flex align-items-center justify-content-center text-muted",style:{width:120,height:80}},React.createElement("i",{className:"fas fa-image fa-2x"})),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{type:"file",className:"form-control form-control-sm",accept:"image/*,image/jpeg,image/png,image/gif,image/webp",onChange:pe,disabled:re}),re&&React.createElement("div",{className:"mt-1 text-muted small"},React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang upload..."),React.createElement("div",{className:"mt-1 text-muted small"},"Ho\u1EB7c d\xE1n URL:"),React.createElement("input",{type:"url",className:"form-control form-control-sm",placeholder:"https://...",value:U.coverImage,onChange:se=>v({...U,coverImage:se.target.value})}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:M},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:O},O?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function ProductManager({showToast:S,settings:y}){const[M,W]=useState([]),[U,v]=useState(!0),[O,ae]=useState(!1),[re,B]=useState(null),[pe,xe]=useState(""),[se,me]=useState(""),ye=normalizeShipPercent(y==null?void 0:y.ship_percent),{parseMoney:ce,formatVND:de}=window.KTM.money,ne=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"];useEffect(()=>{ke()},[]);const ke=async()=>{v(!0);try{const s=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");W(Array.isArray(s)?s:[])}catch(s){console.error(s),S("L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m","danger")}v(!1)},fe=()=>{B(null),ae(!0)},De=s=>{B(s),ae(!0)},Se=async s=>{if(!(!s||!s.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:s},"L\u1ED7i x\xF3a \u1EA3nh"),window.KTM.cache.remove(CACHE_KEY),S(`\u0110\xE3 x\xF3a ${typeName}`,"success"),loadAllData(),ke()}catch(m){S("L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m","danger")}},Ne=async s=>{try{const m=re?`${API_BASE}/api/products?id=${re.id}`:`${API_BASE}/api/products`;re?await window.KTM.api.putJSON(m,s,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(m,s,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),S(re?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),ae(!1),ke()}catch(m){S(m.message,"danger")}},Ce=async s=>{if(confirm(`B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n x\xF3a s\u1EA3n ph\u1EA9m "${s.name}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/products?id=${s.id}`,"L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m"),S("X\xF3a s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),ke()}catch(m){S(m.message,"danger")}},$e=M.filter(s=>{const m=!pe||s.name.toLowerCase().includes(pe.toLowerCase())||s.code&&s.code.toLowerCase().includes(pe.toLowerCase()),b=!se||s.category===se;return m&&b}),et=s=>{var A;const m=(A=s==null?void 0:s.commission_percent)!=null?A:s==null?void 0:s.commissionPercent,b=m===""||m==null?NaN:Number(m);return Number.isFinite(b)?Math.max(0,Math.min(100,b)):5},_e=s=>{const m=et(s),b=Number.isInteger(m)?String(m):String(Math.round(m*100)/100),A=ce(s==null?void 0:s.price);if(!Number.isFinite(A)||A<=0)return`${b}%`;const Y=(Number(m)||0)/100,P=window.KTM.money.parseShipFeeFromNote(s==null?void 0:s.note)!=null?0:ye>0?A*ye/100:0,E=A*Y-P*Y,r=Math.max(0,Math.round(E));return`${b}% - ${de(r)}`},Oe=s=>{if(s==null||s==="")return[];let m=s;if(typeof m=="string"){const b=m.trim();if(!b)return[];try{m=JSON.parse(b)}catch(A){return[]}}return Array.isArray(m)?m:[]},qe=(s,m={})=>{const b=Oe(s).map(P=>{var E;return{name:String((E=P==null?void 0:P.name)!=null?E:"").trim(),options:Array.isArray(P==null?void 0:P.options)?P.options:[]}}).map(P=>({...P,options:P.options.map(E=>{var r;return{label:String((r=E==null?void 0:E.label)!=null?r:"").trim(),price:Number(E==null?void 0:E.price)}}).filter(E=>!!E.label)})).filter(P=>P.options.length>0);if(!b.length)return null;const A=Number.isFinite(m.maxGroups)?Math.max(1,Math.trunc(m.maxGroups)):b.length,Y=Number.isFinite(m.maxOptionsPerGroup)?Math.max(1,Math.trunc(m.maxOptionsPerGroup)):4,L=b.slice(0,A);return React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},L.map((P,E)=>{const r=P.name||"Bi\u1EBFn th\u1EC3",G=P.options.slice(0,Y),Ae=P.options.length-G.length;return React.createElement("div",{key:`${r}-${E}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},r),G.map((Le,l)=>{const h=Le.price,ge=Number.isFinite(h)&&h>=0?de(Math.trunc(h)):"",g=ge?`${Le.label} \xB7 ${ge}`:Le.label;return React.createElement("span",{key:`${r}-${E}-${l}`,className:"ktm-chip ktm-chip-option"},g)}),Ae>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",Ae))})))};return React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",null,React.createElement("i",{className:"fas fa-box me-2"}),"S\u1EA3n ph\u1EA9m"),React.createElement("button",{className:"btn-add-product",onClick:fe},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"d-flex gap-2 mb-2"},React.createElement("div",{className:"flex-grow-1 position-relative"},React.createElement("input",{type:"text",className:"form-control",placeholder:"\u{1F50D} T\xECm s\u1EA3n ph\u1EA9m...",value:pe,onChange:s=>xe(s.target.value)})),React.createElement("span",{className:"product-count"},$e.length)),React.createElement("select",{className:"form-select",value:se,onChange:s=>me(s.target.value)},React.createElement("option",{value:""},"\u{1F4C1} T\u1EA5t c\u1EA3 danh m\u1EE5c"),ne.map(s=>React.createElement("option",{key:s,value:s},s)))),U?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"2.5rem",height:"2.5rem"}}),React.createElement("p",{className:"text-muted mt-3 mb-0"},"\u0110ang t\u1EA3i...")):$e.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-box-open"}),React.createElement("p",null,"Ch\u01B0a c\xF3 s\u1EA3n ph\u1EA9m n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:fe},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"product-list"},$e.map(s=>React.createElement("div",{key:s.id,className:"product-item d-flex align-items-center gap-3"},s.image?React.createElement("img",{src:s.image,alt:"",className:"product-img"}):React.createElement("div",{className:"product-img-placeholder"},React.createElement("i",{className:"fas fa-image text-muted"})),React.createElement("div",{className:"flex-grow-1 min-width-0"},React.createElement("div",{className:"product-name"},s.name),React.createElement("div",{className:"d-flex flex-wrap gap-1 mb-1"},s.category&&React.createElement("span",{className:"product-badge bg-info bg-opacity-75"},s.category),s.code&&React.createElement("span",{className:"product-badge bg-secondary"},s.code),React.createElement("span",{className:"product-badge bg-warning text-dark",title:"Hoa h\u1ED3ng (%)"},React.createElement("i",{className:"fas fa-percent me-1"}),_e(s))),React.createElement("div",{className:"product-price"},s.price?s.price.replace(/[đ\s]/g,"")+"\u0111":"Li\xEAn h\u1EC7"),s.note&&React.createElement("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"}},s.note),qe(s.variants,{maxOptionsPerGroup:4})&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},qe(s.variants,{maxOptionsPerGroup:4}))),React.createElement("div",{className:"product-actions"},React.createElement("button",{className:"btn btn-edit",onClick:()=>De(s),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"btn btn-delete",onClick:()=>Ce(s),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement(ProductModal,{show:O,product:re,categories:ne,onClose:()=>ae(!1),onSave:Ne}))}function ProductModal({show:S,product:y,categories:M,onClose:W,onSave:U}){const[v,O]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[ae,re]=useState(!1),[B,pe]=useState(!1),xe=s=>{const m=window.KTM.money.getDigits(String(s!=null?s:"")),b=Number(m);return m&&Number.isFinite(b)?Math.trunc(b):0},se=s=>{if(s==null||s==="")return[];let m=s;if(typeof m=="string"){const b=m.trim();if(!b)return[];try{m=JSON.parse(b)}catch(A){return[]}}return m&&typeof m=="object"&&!Array.isArray(m)&&(m=Object.entries(m).map(([b,A])=>({key:b,value:A}))),Array.isArray(m)?m.map(b=>{var P,E,r,G,Ae;if(!b||typeof b!="object")return null;const A=String((r=(E=(P=b.key)!=null?P:b.name)!=null?E:b.label)!=null?r:"").trim(),Y=String((G=b.value)!=null?G:"").trim(),L=String((Ae=b.unit)!=null?Ae:"").trim();return A?{key:A,value:Y,unit:L}:null}).filter(Boolean):[]},me=(s,m)=>{if(s==null||s==="")return[];let b=s;if(typeof b=="string"){const Y=b.trim();if(!Y)return[];try{b=JSON.parse(Y)}catch(L){return[]}}if(!Array.isArray(b))return[];const A=xe(m);return b.map(Y=>{var E;if(!Y||typeof Y!="object")return null;const L=String((E=Y.name)!=null?E:"").trim(),P=(Array.isArray(Y.options)?Y.options:[]).map(r=>{var ge,g,q,F,Me,Ye,Ie;if(!r||typeof r!="object")return null;const G=String((ge=r.label)!=null?ge:"").trim();if(!G)return null;const Ae=(Me=(F=(q=(g=r.price)!=null?g:r.priceValue)!=null?q:r.unit_price)!=null?F:r.unitPrice)!=null?Me:null,Le=Number(Ae);let l=Number.isFinite(Le)?Math.trunc(Le):null;if(l==null){const Pe=(Ie=(Ye=r.price_delta)!=null?Ye:r.priceDelta)!=null?Ie:null,ze=Number(Pe);Number.isFinite(ze)&&(l=A+Math.trunc(ze))}l==null&&(l=A);const h=String(Math.max(0,Math.trunc(Number(l)||0)));return{label:G,price:Math.max(0,Math.trunc(Number(l)||0)),priceDigits:h}}).filter(Boolean);return{name:L||"Bi\u1EBFn th\u1EC3",options:P}}).filter(Boolean)};useEffect(()=>{var s,m;O(y?{name:y.name||"",code:y.code||"",price:y.price||"",image:y.image||"",category:y.category||"",note:y.note||"",sort_order:y.sort_order||0,commission_percent:(m=(s=y.commission_percent)!=null?s:y.commissionPercent)!=null?m:5,variants:me(y.variants,y.price),attributes:se(y.attributes)}:{name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]})},[y,S]);const ye=s=>{O(m=>{var P;const b=xe(m.price),A=String(b),Y=Array.isArray(m.variants)?[...m.variants]:[],L={...Y[s]||{},options:Array.isArray((P=Y[s])==null?void 0:P.options)?[...Y[s].options]:[]};return L.options=L.options.map(E=>({label:String((E==null?void 0:E.label)||""),price:b,priceDigits:A})),Y[s]=L,{...m,variants:Y}})},ce=()=>{O(s=>{const m=xe(s.price),b=String(m),Y=(Array.isArray(s.variants)?[...s.variants]:[]).map(L=>{const P=(Array.isArray(L==null?void 0:L.options)?L.options:[]).map(E=>({label:String((E==null?void 0:E.label)||""),price:m,priceDigits:b}));return{name:String((L==null?void 0:L.name)||"Bi\u1EBFn th\u1EC3"),options:P}});return{...s,variants:Y}})},[de,ne]=React.useState(""),ke=s=>window.KTM.money.formatVNDInputDigits(s),[fe,De]=React.useState(""),Se=s=>{const m=window.KTM.money.nextPriceInputState(s.target.value,fe);De(m.digits),O({...v,price:m.price})},[Ne,Ce]=React.useState("");React.useEffect(()=>{y!=null&&y.image&&Ce(y.image)},[y]);const $e=async s=>{if(!(!s||!s.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:s},"L\u1ED7i x\xF3a \u1EA3nh")}catch(m){console.error("Delete cloudinary image error:",m)}},et=async(s,m=2,b)=>{const A=m*1024*1024,Y=s.type==="image/heic"||s.type==="image/heif"||/\.heic$/i.test(s.name);if(s.size<=A&&!Y)return s;b==null||b("\u0110ang x\u1EED l\xFD \u1EA3nh...");try{const L=await createImageBitmap(s);b==null||b("\u0110ang n\xE9n \u1EA3nh...");const P=document.createElement("canvas");let E=L.width,r=L.height;const G=1200;return(E>G||r>G)&&(E>r?(r=Math.round(r/E*G),E=G):(E=Math.round(E/r*G),r=G)),P.width=E,P.height=r,P.getContext("2d").drawImage(L,0,0,E,r),L.close(),new Promise((Le,l)=>{P.toBlob(h=>{h?(b==null||b("Ho\xE0n t\u1EA5t!"),Le(new File([h],s.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"}))):l(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(L){throw console.error("createImageBitmap error:",L),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},_e=async s=>{var A,Y;const m=(A=s.target.files)==null?void 0:A[0];if(!m)return;if(!(m.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(m.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}pe(!0),ne("\u0110ang chu\u1EA9n b\u1ECB...");try{const L=(m.size/1024/1024).toFixed(1);ne(`File ${L}MB - \u0110ang n\xE9n...`);const P=await et(m,2,G=>{ne(G)}),E=(P.size/1024/1024).toFixed(1);ne(`\u0110\xE3 n\xE9n: ${E}MB - \u0110ang upload...`);const r=await window.KTM.cloudinary.uploadImage({file:P,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});r.secure_url?(v.image&&v.image!==Ne&&$e(v.image),O(G=>({...G,image:r.secure_url})),ne("")):(console.error("Cloudinary error:",r),alert("Upload th\u1EA5t b\u1EA1i: "+(((Y=r.error)==null?void 0:Y.message)||"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh")),ne(""))}catch(L){console.error("Upload error:",L),alert("L\u1ED7i: "+L.message),ne("")}pe(!1),s.target.value=""},Oe=()=>{v.image&&(v.image!==Ne&&$e(v.image),O(s=>({...s,image:""})))},qe=async s=>{s.preventDefault(),re(!0),Ne&&v.image&&Ne!==v.image&&await $e(Ne),Ne&&!v.image&&await $e(Ne),await U(v),re(!1)};return S?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down"},React.createElement("div",{className:"modal-content",style:{borderRadius:"16px",overflow:"hidden"}},React.createElement("div",{className:"modal-header border-0 py-3",style:{background:"linear-gradient(135deg, #ffc107 0%, #ffca2c 100%)"}},React.createElement("h6",{className:"modal-title fw-bold",style:{color:"#1a1a2e"}},React.createElement("i",{className:`fas ${y?"fa-edit":"fa-plus-circle"} me-2`}),y?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:W})),React.createElement("form",{onSubmit:qe},React.createElement("div",{className:"modal-body py-4",style:{maxHeight:"65vh",overflowY:"auto",background:"#f8f9fa"}},React.createElement("div",{className:"text-center mb-4"},React.createElement("div",{className:"position-relative d-inline-block"},v.image?React.createElement(React.Fragment,null,React.createElement("img",{src:v.image,alt:"",style:{width:110,height:110,objectFit:"cover",borderRadius:"12px",boxShadow:"0 4px 15px rgba(0,0,0,0.15)"}}),React.createElement("button",{type:"button",className:"btn btn-danger position-absolute",onClick:Oe,style:{top:-10,right:-10,width:28,height:28,padding:0,borderRadius:"50%",boxShadow:"0 2px 8px rgba(220,53,69,0.4)"}},React.createElement("i",{className:"fas fa-times",style:{fontSize:"0.75rem"}}))):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:110,height:110,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd"}},React.createElement("i",{className:"fas fa-image fa-2x text-muted"}))),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"btn btn-warning btn-sm px-3",style:{borderRadius:"20px"}},React.createElement("i",{className:`fas ${B?"fa-spinner fa-spin":"fa-camera"} me-1`}),B?de||"\u0110ang x\u1EED l\xFD...":"Ch\u1ECDn \u1EA3nh",React.createElement("input",{type:"file",accept:"image/*",onChange:_e,disabled:B,style:{position:"absolute",left:"-9999px",opacity:0,width:1,height:1}})),B&&de&&React.createElement("div",{className:"text-center mt-1",style:{fontSize:11,color:"#6c757d"}},de))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-tag me-1 text-warning"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:v.name,onChange:s=>O({...v,name:s.target.value}),required:!0,placeholder:"VD: Combo Van 3 tay + 2 xylanh",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-barcode me-1 text-info"}),"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:v.code,onChange:s=>O({...v,code:s.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1 text-success"}),"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:v.price,onChange:Se,placeholder:"1.950.000\u0111",inputMode:"numeric",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-percent me-1 text-secondary"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:v.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:s=>O({...v,commission_percent:s.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-folder me-1 text-primary"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:v.category,onChange:s=>O({...v,category:s.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),M.map(s=>React.createElement("option",{key:s,value:s},s)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1 text-secondary"}),"Ghi ch\xFA"),React.createElement("input",{type:"text",className:"form-control",value:v.note,onChange:s=>O({...v,note:s.target.value}),placeholder:"VD: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1 text-secondary"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(v.attributes)?v.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(v.attributes)?v.attributes:[]).map((s,m)=>React.createElement("div",{key:m,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(s==null?void 0:s.key)||"",onChange:b=>{const A=b.target.value;O(Y=>{const L=Array.isArray(Y.attributes)?[...Y.attributes]:[];return L[m]={...L[m]||{},key:A},{...Y,attributes:L}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(s==null?void 0:s.value)||"",onChange:b=>{const A=b.target.value;O(Y=>{const L=Array.isArray(Y.attributes)?[...Y.attributes]:[];return L[m]={...L[m]||{},value:A},{...Y,attributes:L}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(s==null?void 0:s.unit)||"",onChange:b=>{const A=b.target.value;O(Y=>{const L=Array.isArray(Y.attributes)?[...Y.attributes]:[];return L[m]={...L[m]||{},unit:A},{...Y,attributes:L}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{O(b=>{const A=Array.isArray(b.attributes)?[...b.attributes]:[];return A.splice(m,1),{...b,attributes:A}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{O(s=>{const m=Array.isArray(s.attributes)?[...s.attributes]:[];return m.push({key:"",value:"",unit:""}),{...s,attributes:m}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1 text-secondary"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(v.variants)?v.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3."):null,(Array.isArray(v.variants)?v.variants:[]).map((s,m)=>React.createElement("div",{key:m,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(s==null?void 0:s.name)||"",onChange:b=>{const A=b.target.value;O(Y=>{var P;const L=Array.isArray(Y.variants)?[...Y.variants]:[];return L[m]={...L[m]||{},name:A,options:Array.isArray((P=L[m])==null?void 0:P.options)?L[m].options:[]},{...Y,variants:L}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>ye(m),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(s==null?void 0:s.options)||s.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{O(b=>{const A=Array.isArray(b.variants)?[...b.variants]:[];return A.splice(m,1),{...b,variants:A}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(s==null?void 0:s.options)?s.options:[]).map((b,A)=>{var Y,L;return React.createElement("div",{key:A,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(b==null?void 0:b.label)||"",onChange:P=>{const E=P.target.value;O(r=>{var h,ge,g,q,F;const G=Array.isArray(r.variants)?[...r.variants]:[],Ae={...G[m]||{},options:Array.isArray((h=G[m])==null?void 0:h.options)?[...G[m].options]:[]},Le=Number((g=(ge=Ae.options[A])==null?void 0:ge.price)!=null?g:0)||0,l=String((F=(q=Ae.options[A])==null?void 0:q.priceDigits)!=null?F:Math.max(0,Math.trunc(Le)));return Ae.options[A]={...Ae.options[A]||{},label:E,price:Math.max(0,Math.trunc(Le)),priceDigits:l},G[m]=Ae,{...r,variants:G}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:ke(String((L=b==null?void 0:b.priceDigits)!=null?L:window.KTM.money.getDigits(String((Y=b==null?void 0:b.price)!=null?Y:"")))),onChange:P=>{O(E=>{var g,q,F,Me,Ye;const r=String((q=b==null?void 0:b.priceDigits)!=null?q:window.KTM.money.getDigits(String((g=b==null?void 0:b.price)!=null?g:""))),G=window.KTM.money.nextPriceInputState(P.target.value,r),Ae=String((F=G.digits)!=null?F:""),Le=Number(Ae),l=Number.isFinite(Le)?Math.max(0,Math.trunc(Le)):0,h=Array.isArray(E.variants)?[...E.variants]:[],ge={...h[m]||{},options:Array.isArray((Me=h[m])==null?void 0:Me.options)?[...h[m].options]:[]};return ge.options[A]={...ge.options[A]||{},label:String(((Ye=ge.options[A])==null?void 0:Ye.label)||""),price:l,priceDigits:Ae},h[m]=ge,{...E,variants:h}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{O(P=>{var G;const E=Array.isArray(P.variants)?[...P.variants]:[],r={...E[m]||{},options:Array.isArray((G=E[m])==null?void 0:G.options)?[...E[m].options]:[]};return r.options.splice(A,1),E[m]=r,{...P,variants:E}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{O(b=>{var P;const A=Array.isArray(b.variants)?[...b.variants]:[],Y={...A[m]||{},options:Array.isArray((P=A[m])==null?void 0:P.options)?[...A[m].options]:[]},L=xe(b.price);return Y.options.push({label:"",price:L,priceDigits:String(L)}),A[m]=Y,{...b,variants:A}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{O(s=>{const m=xe(s.price),b=Array.isArray(s.variants)?[...s.variants]:[],A=String(m);return b.push({name:"Size",options:[{label:"S",price:m,priceDigits:A},{label:"M",price:m,priceDigits:A},{label:"L",price:m,priceDigits:A}]}),{...s,variants:b}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:ce,disabled:!Array.isArray(v.variants)||v.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111."))),React.createElement("div",{className:"mb-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"URL \u1EA3nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",placeholder:"https://...",value:v.image,onChange:s=>O({...v,image:s.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"10px",fontSize:"0.9rem"}}))),React.createElement("div",{className:"modal-footer border-0 py-3",style:{background:"#fff"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:W,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:ae,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},ae?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}function VideoModal({show:S,video:y,onClose:M,onSave:W}){const[U,v]=useState({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),[O,ae]=useState(!1),[re,B]=useState("");useEffect(()=>{y?(v({title:y.title||"",youtube_url:`https://www.youtube.com/watch?v=${y.youtubeId}`,thumbnail_url:y.thumb||"",sort_order:y.sortOrder||0}),B(y.thumb)):(v({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),B(""))},[y,S]);const pe=me=>{const ye=me.match(/(?:youtube\.com\/(?:embed\/|watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return ye?ye[1]:null},xe=me=>{v({...U,youtube_url:me});const ye=pe(me);ye&&B(`https://img.youtube.com/vi/${ye}/hqdefault.jpg`)},se=async me=>{me.preventDefault(),ae(!0),await W(U),ae(!1)};return S?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},y?"S\u1EEDa Video":"Th\xEAm Video m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:M})),React.createElement("form",{onSubmit:se},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Link YouTube *"),React.createElement("input",{type:"url",className:"form-control",value:U.youtube_url,onChange:me=>xe(me.target.value),placeholder:"https://www.youtube.com/watch?v=... ho\u1EB7c shorts/...",required:!0}),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3: youtube.com/watch, youtu.be, youtube.com/shorts")),re&&React.createElement("div",{className:"mb-3 text-center"},React.createElement("img",{src:re,alt:"Preview",className:"img-fluid rounded",style:{maxHeight:"150px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ti\xEAu \u0111\u1EC1 *"),React.createElement("input",{type:"text",className:"form-control",value:U.title,onChange:me=>v({...U,title:me.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:U.sort_order,onChange:me=>v({...U,sort_order:parseInt(me.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Thumbnail t\xF9y ch\u1EC9nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",value:U.thumbnail_url,onChange:me=>v({...U,thumbnail_url:me.target.value}),placeholder:"\u0110\u1EC3 tr\u1ED1ng s\u1EBD d\xF9ng thumbnail m\u1EB7c \u0111\u1ECBnh c\u1EE7a YouTube"}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:M},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:O},O?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function AdminApp(){const[S,y]=useState(!1),[M,W]=useState(""),[U,v]=useState(null),[O,ae]=useState("search"),[re,B]=useState(null),[pe,xe]=useState(""),[se,me]=useState([]),[ye,ce]=useState(null),[de,ne]=useState(!1),[ke,fe]=useState(null),[De,Se]=useState(!0),[Ne,Ce]=useState([]),[$e,et]=useState(()=>loadAdminSettings()),[_e,Oe]=useState(null),[qe,s]=useState([]);useEffect(()=>{const g=localStorage.getItem("ktm_admin_session");if(g)try{const q=JSON.parse(g);q.expiry>Date.now()?(y(!0),v(q.user)):localStorage.removeItem("ktm_admin_session")}catch(q){localStorage.removeItem("ktm_admin_session")}},[]),useEffect(()=>{S&&L()},[S]),useEffect(()=>{if(!S)return;let g=!1;return(async()=>{try{const q=await fetchAdminSettingsFromServer();if(g)return;et(q),saveAdminSettings(q)}catch(q){}})(),()=>{g=!0}},[S]);const m=async(g,q)=>{W("");try{const F=await window.KTM.api.postJSON(`${API_BASE}/api/auth/login`,{username:g,password:q},"\u0110\u0103ng nh\u1EADp th\u1EA5t b\u1EA1i"),Me={user:F.user,token:F.token,expiry:Date.now()+100*365*24*60*60*1e3};localStorage.setItem("ktm_admin_session",JSON.stringify(Me)),v(F.user),y(!0)}catch(F){W(F.message)}},b=()=>{localStorage.removeItem("ktm_admin_session"),y(!1),v(null),me([]),ce(null)},A=(g,q="success")=>{const F=Date.now();Ce(Me=>[...Me,{id:F,message:g,type:q}])},Y=g=>{Ce(q=>q.filter(F=>F.id!==g))},L=async(g=null)=>{Se(!0);try{const q=g?`${API_BASE}/api/albums?parent_id=${g}`:`${API_BASE}/api/albums?parent_id=root`,F=await window.KTM.api.getJSON(q,"L\u1ED7i t\u1EA3i danh s\xE1ch album");me(Array.isArray(F)?F:[])}catch(q){console.error(q),A("L\u1ED7i t\u1EA3i danh s\xE1ch album","danger")}Se(!1)},P=()=>{fe(null),ne(!0)},E=g=>{fe(g),ne(!0)},r=async g=>{try{const q=ke&&ke.uuid;!q&&_e&&(g.parent_id=_e.uuid);const F=q?`${API_BASE}/api/albums/${ke.uuid||ke.id}`:`${API_BASE}/api/albums`;q?await window.KTM.api.putJSON(F,g,"L\u1ED7i c\u1EADp nh\u1EADt"):await window.KTM.api.postJSON(F,g,"L\u1ED7i t\u1EA1o"),A(q?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"T\u1EA1o th\xE0nh c\xF4ng!","success"),ne(!1),L(_e==null?void 0:_e.uuid)}catch(q){A(q.message,"danger")}},G=g=>{ce(g)},Ae=g=>{if(g==="root")s([]),Oe(null),L(null);else if(g){const q=qe.findIndex(F=>F.uuid===g.uuid);q>=0&&(s(qe.slice(0,q+1)),Oe(g),L(g.uuid))}else{const q=[...qe];q.pop();const F=q[q.length-1]||null;s(q),Oe(F),L(F==null?void 0:F.uuid)}},Le=async g=>{const q=`X\xF3a folder "${g.title}"? T\u1EA5t c\u1EA3 folder con v\xE0 \u1EA3nh b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`;if(confirm(q))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${g.uuid||g.id}`,"L\u1ED7i x\xF3a album"),A("\u0110\xE3 x\xF3a","success"),L(_e==null?void 0:_e.uuid)}catch(F){A("L\u1ED7i x\xF3a album","danger")}};if(!S)return React.createElement(LoginPage,{onLogin:m,error:M});const l=()=>{const g=new Date,q=g.getFullYear(),F=String(g.getMonth()+1).padStart(2,"0");return`${q}-${F}`};function h(){const[g,q]=useState(()=>{var Ie;return String((Ie=$e==null?void 0:$e.ship_percent)!=null?Ie:DEFAULT_SHIP_PERCENT)}),[F,Me]=useState(!1);return useEffect(()=>{var Ie;q(String((Ie=$e==null?void 0:$e.ship_percent)!=null?Ie:DEFAULT_SHIP_PERCENT))},[$e==null?void 0:$e.ship_percent]),React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-cog me-2 text-warning"}),"C\xE0i \u0111\u1EB7t")),React.createElement("div",{className:"card p-3"},React.createElement("form",{onSubmit:async Ie=>{Ie.preventDefault(),Me(!0);const Pe=saveAdminSettings({ship_percent:g});try{const ze=await saveAdminSettingsToServer(Pe);et(ze),saveAdminSettings(ze),A("\u0110\xE3 l\u01B0u c\xE0i \u0111\u1EB7t v\xE0o DB","success")}catch(ze){et(Pe),A("Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c DB, \u0111\xE3 l\u01B0u t\u1EA1m tr\xEAn m\xE1y","warning")}finally{Me(!1)}}},React.createElement("div",{className:"mb-2 text-muted small"},"\xC1p d\u1EE5ng cho th\u1ED1ng k\xEA hoa h\u1ED3ng khi \u0111\u01A1n h\xE0ng kh\xF4ng ghi ph\xED ship trong ghi ch\xFA s\u1EA3n ph\u1EA9m."),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ph\xED ship (%) khi kh\xF4ng c\xF3 ship"),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",value:g,min:"0",max:"100",step:"0.01",onChange:Ie=>q(Ie.target.value)}),React.createElement("span",{className:"input-group-text"},"%")),React.createElement("div",{className:"form-text"},"M\u1EB7c \u0111\u1ECBnh: ",DEFAULT_SHIP_PERCENT,"%")),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:F},F?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u c\xE0i \u0111\u1EB7t"))))}function ge(){const[g,q]=useState(l()),[F,Me]=useState(!0),[Ye,Ie]=useState([]),[Pe,ze]=useState([]),ct=useRef(!1),At=useRef(new Map),vt=normalizeShipPercent($e==null?void 0:$e.ship_percent),{parseMoney:Rt,parseShipFeeFromNote:Pt,getShipFeeForItems:It,formatNumber:we,formatVND:Ze}=window.KTM.money,lt=async()=>{if(!ct.current)try{const k=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i danh s\xE1ch s\u1EA3n ph\u1EA9m");ze(Array.isArray(k)?k:[]),ct.current=!0}catch(k){console.error("Load products for stats error:",k),ze([]),ct.current=!0}},Ct=async k=>{var at,nt;const Fe=String(k||"").trim();if(!Fe)return[];const Ve=(at=At.current)==null?void 0:at.get(Fe);if(Ve&&Array.isArray(Ve))return Ve;const Je=await window.KTM.api.getJSON(`${API_BASE}/api/orders?month=${encodeURIComponent(Fe)}`,"L\u1ED7i t\u1EA3i th\u1ED1ng k\xEA"),tt=Array.isArray(Je)?Je:[];return(nt=At.current)==null||nt.set(Fe,tt),tt},p=async()=>{Me(!0);try{await lt();const k=await Ct(g);Ie(Array.isArray(k)?k:[])}catch(k){console.error("Load stats error:",k),Ie([])}finally{Me(!1)}};useEffect(()=>{p()},[g]);const $=React.useMemo(()=>{var ue;const k={draft:0,pending:0,processing:0,done:0,paid:0,canceled:0,other:0};let Fe=0,Ve=0,Je=0,tt=0,at=0,nt=0,St=0,Mt=0;const ht=J=>J.customer_id||J.phone||"unknown",He=J=>window.KTM.orders.getOrderItems(J),Kt=new Map,ut=new Map,Te=new Map,t=5,C=new Map((Array.isArray(Pe)?Pe:[]).map(J=>{var Ge;const le=(Ge=J==null?void 0:J.commission_percent)!=null?Ge:J==null?void 0:J.commissionPercent,Ue=Number(le),st=Number.isFinite(Ue)?Math.max(0,Math.min(100,Ue)):t;return[String(J==null?void 0:J.id),st]})),D=J=>{const le=String(J!=null?J:"").trim().toLowerCase();return le==="cancelled"?"canceled":le};for(const J of Ye){const le=D(J==null?void 0:J.status),Ge=le==="canceled"||le==="draft",it=He(J);let yt=0,dt=0,$t=0;for(const R of it){const H=Number((R==null?void 0:R.quantity)||0)||0,X=Rt(R==null?void 0:R.product_price),be=H*X,he=String((R==null?void 0:R.product_id)||""),Ke=C.has(he)?C.get(he):t,Xe=(Number(Ke)||0)/100;if(yt+=H,dt+=be,$t+=be*Xe,!Ge){const Re=(R==null?void 0:R.product_id)||"unknown",Qe=Kt.get(he)||{product_id:Re,product_name:(R==null?void 0:R.product_name)||"\u2014",product_code:(R==null?void 0:R.product_code)||"",orders:0,quantity:0,revenue:0};Qe.orders+=1,Qe.quantity+=H,Qe.revenue+=be,Kt.set(Re,Qe)}}const Nt=It(it),jt=Number((ue=J==null?void 0:J.adjustment_amount)!=null?ue:0)||0,wt=dt+(Nt.found?Nt.fee:0)+jt,Et=dt+jt,qt=!Nt.found&&vt>0&&dt>0?dt*vt/100:0,x=dt>0?$t/dt:t/100,I=$t+jt*x-qt*x,K=le==="done"||le==="paid";if(le==="draft"?k.draft+=1:le==="pending"?k.pending+=1:le==="processing"?k.processing+=1:le==="canceled"?k.canceled+=1:le==="paid"?(k.paid+=1,k.done+=1,tt+=wt,nt+=Et,Mt+=I):le==="done"?(k.done+=1,tt+=wt,nt+=Et,Mt+=I):k.other+=1,!Ge){Fe+=1,Ve+=yt,Je+=wt,at+=Et,St+=I;const R=ht(J),H=ut.get(R)||{key:R,customer_name:J.customer_name||"",phone:J.phone||"",orders:0,quantity:0,revenue:0};H.orders+=1,H.quantity+=yt,H.revenue+=wt,!H.customer_name&&J.customer_name&&(H.customer_name=J.customer_name),!H.phone&&J.phone&&(H.phone=J.phone),ut.set(R,H);const X=J.created_at?new Date(J.created_at):null;if(X&&!Number.isNaN(X.getTime())){const be=`${X.getFullYear()}-${String(X.getMonth()+1).padStart(2,"0")}-${String(X.getDate()).padStart(2,"0")}`,he=Te.get(be)||{day:be,orders:0,quantity:0,revenue:0,doneOrders:0,doneRevenue:0};he.orders+=1,he.quantity+=yt,he.revenue+=wt,K&&(he.doneOrders+=1,he.doneRevenue+=wt),Te.set(be,he)}}}const z=Array.from(Kt.values()).sort((J,le)=>le.revenue-J.revenue),ee=Array.from(ut.values()).sort((J,le)=>le.revenue-J.revenue),_=Array.from(Te.values()).sort((J,le)=>J.day.localeCompare(le.day)),w=ut.size,Z=Fe?Math.round(Je/Fe):0,oe=Fe?Ve/Fe:0,ie=Math.round(Mt),Q=Math.round(St);return{statusCounts:k,activeOrders:Fe,totalQty:Ve,totalRevenue:Je,doneRevenue:tt,tempCommission:ie,tempCommissionAll:Q,products:z,customers:ee,days:_,uniqueCustomers:w,avgOrderValue:Z,avgQtyPerOrder:oe}},[Ye,Pe,g]);return React.createElement("div",{className:"product-manager pb-5 mb-4 stats-manager"},React.createElement(Loading,{show:F}),React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-chart-column me-2 text-warning"}),"Th\u1ED1ng k\xEA"),React.createElement("button",{className:"btn btn-outline-secondary btn-sm",onClick:p,disabled:F},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"Ch\u1ECDn th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:g,onChange:k=>q(k.target.value),"aria-label":"Ch\u1ECDn th\xE1ng"}))),React.createElement("div",{className:"col-12 col-md-7 d-flex gap-2 justify-content-md-end"},React.createElement("div",{className:"d-flex flex-wrap gap-2 align-self-center"},React.createElement("span",{className:"badge rounded-pill bg-secondary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-truck me-1"}),"Ship \u01B0\u1EDBc t\xEDnh: ",vt,"%"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-receipt me-1"}),we($.activeOrders)," \u0111\u01A1n"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-user me-1"}),we($.uniqueCustomers)," kh\xE1ch"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-boxes-stacked me-1"}),we($.totalQty)," SL"),React.createElement("span",{className:"badge rounded-pill bg-primary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-hand-holding-dollar me-1"}),"\u0110\xE3 nh\u1EADn ti\u1EC1n: ",we($.statusCounts.paid),"/",we($.statusCounts.done)))))),React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng \u0111\u01A1n (kh\xF4ng t\xEDnh h\u1EE7y/nh\xE1p)"),React.createElement("i",{className:"fas fa-receipt text-dark"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},we($.activeOrders)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (t\u1EA1m t\xEDnh)"),React.createElement("i",{className:"fas fa-sack-dollar text-warning"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Ze($.totalRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (Ho\xE0n th\xE0nh)"),React.createElement("i",{className:"fas fa-circle-check text-success"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Ze($.doneRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-info bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng s\u1EBD nh\u1EADn (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-chart-line text-info"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Ze($.tempCommission)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng t\u1ED5ng (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-coins text-primary"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Ze($.tempCommissionAll))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-layer-group me-2 text-warning"}),"T\u1ED5ng quan tr\u1EA1ng th\xE1i"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},"SL TB/\u0111\u01A1n: ",$.avgQtyPerOrder?$.avgQtyPerOrder.toFixed(2):"0.00")),React.createElement("div",{className:"d-md-none mt-2"},React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-light bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Nh\xE1p"),React.createElement("div",{className:"fw-semibold"},we($.statusCounts.draft)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-secondary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("div",{className:"fw-semibold"},we($.statusCounts.pending)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("div",{className:"fw-semibold"},we($.statusCounts.processing)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-danger bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"H\u1EE7y \u0111\u01A1n"),React.createElement("div",{className:"fw-semibold"},we($.statusCounts.canceled)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh"),React.createElement("div",{className:"fw-semibold"},we($.statusCounts.done)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("div",{className:"fw-semibold"},we($.statusCounts.paid)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng SL"),React.createElement("div",{className:"fw-semibold"},we($.totalQty)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Nh\xE1p"),React.createElement("th",null,"Ch\u1EDD x\u1EED l\xFD"),React.createElement("th",null,"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("th",null,"H\u1EE7y \u0111\u01A1n"),React.createElement("th",null,"Ho\xE0n th\xE0nh"),React.createElement("th",null,"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("th",null,"Kh\xE1c"),React.createElement("th",null,"T\u1ED5ng SL"))),React.createElement("tbody",null,React.createElement("tr",null,React.createElement("td",null,we($.statusCounts.draft)),React.createElement("td",null,we($.statusCounts.pending)),React.createElement("td",null,we($.statusCounts.processing)),React.createElement("td",null,we($.statusCounts.canceled)),React.createElement("td",null,we($.statusCounts.done)),React.createElement("td",null,we($.statusCounts.paid)),React.createElement("td",null,we($.statusCounts.other)),React.createElement("td",null,we($.totalQty))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-box me-2 text-info"}),"Top s\u1EA3n ph\u1EA9m"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},$.products.slice(0,10).map(k=>React.createElement("div",{key:k.product_id,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-info"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},k.product_name),React.createElement("div",{className:"text-muted small text-truncate"},k.product_code?`#${k.product_code} \u2022 `:"",we(k.orders)," \u0111\u01A1n \u2022 ",we(k.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},Ze(k.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"M\xE3"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,$.products.slice(0,10).map(k=>React.createElement("tr",{key:k.product_id},React.createElement("td",null,k.product_name),React.createElement("td",null,k.product_code||"\u2014"),React.createElement("td",null,we(k.orders)),React.createElement("td",null,we(k.quantity)),React.createElement("td",{className:"fw-semibold"},Ze(k.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-user-group me-2 text-warning"}),"Top kh\xE1ch h\xE0ng"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},$.customers.slice(0,10).map(k=>React.createElement("div",{key:k.key,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-warning"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},k.customer_name||"\u2014"),React.createElement("div",{className:"text-muted small text-truncate"},k.phone||"\u2014"," \u2022 ",we(k.orders)," \u0111\u01A1n \u2022 ",we(k.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},Ze(k.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,$.customers.slice(0,10).map(k=>React.createElement("tr",{key:k.key},React.createElement("td",null,k.customer_name||"\u2014"),React.createElement("td",null,k.phone||"\u2014"),React.createElement("td",null,we(k.orders)),React.createElement("td",null,we(k.quantity)),React.createElement("td",{className:"fw-semibold"},Ze(k.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3 mb-4"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-calendar-day me-2 text-success"}),"Theo ng\xE0y"),React.createElement("span",{className:"badge rounded-pill bg-success bg-opacity-10 text-dark"},"DT (t\u1EA1m t\xEDnh) & ho\xE0n th\xE0nh")),React.createElement("div",{className:"d-md-none mt-2"},$.days.map(k=>React.createElement("div",{key:k.day,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-success"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"fw-semibold"},k.day),React.createElement("div",{className:"text-muted small"},we(k.orders)," \u0111\u01A1n \u2022 ",we(k.quantity)," SL"),React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh: ",we(k.doneOrders)," \u2022 ",Ze(k.doneRevenue))),React.createElement("div",{className:"fw-semibold text-nowrap"},Ze(k.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Ng\xE0y"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"DT (t\u1EA1m t\xEDnh)"),React.createElement("th",null,"\u0110\u01A1n ho\xE0n th\xE0nh"),React.createElement("th",null,"DT ho\xE0n th\xE0nh"))),React.createElement("tbody",null,$.days.map(k=>React.createElement("tr",{key:k.day},React.createElement("td",null,k.day),React.createElement("td",null,we(k.orders)),React.createElement("td",null,we(k.quantity)),React.createElement("td",{className:"fw-semibold"},Ze(k.revenue)),React.createElement("td",null,we(k.doneOrders)),React.createElement("td",{className:"fw-semibold"},Ze(k.doneRevenue)))))))))}return React.createElement("div",null,React.createElement(Sidebar,{activeMenu:O,onMenuChange:g=>{ae(g),g==="albums"&&(Oe(null),s([]),L(null))},onLogout:b,currentUser:U}),React.createElement("div",{className:"main-content"},O==="albums"&&!ye&&React.createElement(AlbumList,{albums:se,loading:De,currentFolder:_e,breadcrumb:qe,onSelect:G,onCreate:P,onEdit:E,onDelete:Le,onBack:Ae}),O==="search"&&React.createElement(SearchCenter,{showToast:A,onNavigate:(g,q,F)=>{ae(g),g==="orders"&&q==="create"&&(B(Date.now()),xe((F==null?void 0:F.productId)||""))}}),O==="albums"&&ye&&React.createElement(AlbumDetail,{album:ye,parentAlbum:qe.length>0?qe[qe.length-1]:null,onBack:()=>{if(ye.parentId){const g=qe.findIndex(q=>q.uuid===ye.parentId);g>=0?ce(qe[g]):ce(null)}else ce(null)},onRefresh:()=>L(_e==null?void 0:_e.uuid),showToast:A,onNavigateToFolder:g=>{s(q=>[...q,ye]),ce(g)},onEditSubfolder:g=>{fe(g),ne(!0)}}),O==="videos"&&React.createElement(VideoList,{showToast:A}),O==="products"&&React.createElement(ProductManager,{showToast:A,settings:$e}),O==="orders"&&React.createElement(OrderManager,{autoOpenCreateToken:re,autoOpenCreateProductId:pe,showToast:A}),O==="stats"&&React.createElement(ge,null),O==="settings"&&React.createElement(h,null)),React.createElement("nav",{className:"mobile-bottom-nav"},React.createElement("div",{className:"nav-items"},React.createElement("a",{href:"#",className:`nav-item ${O==="search"?"active":""}`,onClick:g=>{g.preventDefault(),ae("search")}},React.createElement("i",{className:"fas fa-search"}),React.createElement("span",null,"Tra c\u1EE9u")),React.createElement("a",{href:"#",className:`nav-item ${O==="albums"?"active":""}`,onClick:g=>{g.preventDefault(),ae("albums"),ce(null)}},React.createElement("i",{className:"fas fa-images"}),React.createElement("span",null,"Album")),React.createElement("a",{href:"#",className:`nav-item ${O==="videos"?"active":""}`,onClick:g=>{g.preventDefault(),ae("videos")}},React.createElement("i",{className:"fas fa-video"}),React.createElement("span",null,"Video")),React.createElement("a",{href:"#",className:`nav-item ${O==="products"?"active":""}`,onClick:g=>{g.preventDefault(),ae("products")}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",null,"S\u1EA3n ph\u1EA9m")),React.createElement("a",{href:"#",className:`nav-item ${O==="orders"?"active":""}`,onClick:g=>{g.preventDefault(),ae("orders")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",null,"\u0110\u01A1n h\xE0ng")),React.createElement("a",{href:"#",className:`nav-item ${O==="stats"?"active":""}`,onClick:g=>{g.preventDefault(),ae("stats")}},React.createElement("i",{className:"fas fa-chart-column"}),React.createElement("span",null,"Th\u1ED1ng k\xEA")))),React.createElement(AlbumModal,{show:de,album:ke,parentId:_e==null?void 0:_e.uuid,onClose:()=>ne(!1),onSave:r}),React.createElement("div",{className:"toast-container"},Ne.map(g=>React.createElement(Toast,{key:g.id,message:g.message,type:g.type,onClose:()=>Y(g.id)}))))}ReactDOM.render(React.createElement(AdminApp,null),document.getElementById("root"));function OrderManager({autoOpenCreateToken:S,autoOpenCreateProductId:y,showToast:M}){const[W,U]=useState([]),[v,O]=useState([]),[ae,re]=useState(!0),[B,pe]=useState(!1),[xe,se]=useState([]),[me,ye]=useState(!1),[ce,de]=useState(!1),[ne,ke]=useState(null),[fe,De]=useState(null),[Se,Ne]=useState(!1),[Ce,$e]=useState(()=>{const e=new Date,n=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0");return`${n}-${a}`}),[et,_e]=useState(""),[Oe,qe]=useState(!1),[s,m]=useState(!1),[b,A]=useState(null),[Y,L]=useState(!1),[P,E]=useState([]),[r,G]=useState({customer_name:"",phone:"",address:"",note:"",items:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_amount:0,adjustment_note:"",status:"pending"}),[Ae,Le]=useState([""]),[l,h]=useState(null),ge=useRef({}),[g,q]=useState([]),[F,Me]=useState(null),Ye=useRef(null),Ie=useRef(null),Pe=useRef(0),ze=useRef(new Map),ct=useRef(""),At=useRef(null),vt=useRef(0),Rt=useRef(null),Pt=9,It=150,we=24*60*60*1e3,Ze=5*60*1e3,lt="ktm_customer_lookup_cache_v1",Ct=200,p=3,$=7,k=3,Fe=24*60*60*1e3,Ve=e=>{try{const n=new Date(e==null?void 0:e.created_at).getTime();if(!Number.isFinite(n))return 0;const a=Date.now()-n;return!Number.isFinite(a)||a<=0?0:Math.floor(a/Fe)}catch(n){return 0}},Je=e=>String((e==null?void 0:e.status)||"").trim()!=="pending"?!1:Ve(e)>=p,tt=e=>{const n=String(e!=null?e:"").trim().toLowerCase();return n==="cancelled"?"canceled":n},at=e=>{if(tt(e==null?void 0:e.status)!=="draft")return null;const a=$-Ve(e);return Number.isFinite(a)?a:null},nt=e=>{const n=at(e);return Number.isFinite(n)?n>0&&n<=k:!1},St=e=>{G({customer_name:"",phone:"",address:"",note:"",items:[{product_id:e||"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_amount:0,adjustment_note:"",status:"pending"}),Le([""]),A(null),h(null)};useEffect(()=>{const e=n=>{var i;if(l==null)return;const a=(i=ge.current)==null?void 0:i[l];a&&!a.contains(n.target)&&h(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[l]);const Mt=e=>window.KTM.money.parseMoney(e),ht=e=>window.KTM.money.parseSignedMoney(e),He=e=>window.KTM.money.formatVND(e),Kt=e=>window.KTM.money.parseShipFeeFromNote(e),ut=e=>window.KTM.phone.isValid(e),Te=e=>window.KTM.phone.normalize(e),t=()=>{var e;try{const n=localStorage.getItem(lt);if(!n)return;const a=JSON.parse(n);if(!a||typeof a!="object")return;const i=Object.entries(a);for(const[c,f]of i)!c||!f||typeof f!="object"||(e=ze.current)==null||e.set(String(c),f)}catch(n){}},C=()=>{try{const e=ze.current;if(!e||typeof e.entries!="function")return;const n=Array.from(e.entries()).filter(([i,c])=>i&&c&&typeof c=="object"&&Number.isFinite(c.ts)).sort((i,c)=>(Number(c[1].ts)||0)-(Number(i[1].ts)||0)).slice(0,Ct),a={};for(const[i,c]of n)a[i]=c;localStorage.setItem(lt,JSON.stringify(a))}catch(e){}};useEffect(()=>{t()},[]);const D=e=>{const n=Te(e);if(!n)return null;const a=Array.isArray(W)?W:[];let i=null,c=-1;for(const f of a){if(!f||Te(f.phone||"")!==n)continue;const j=new Date(f.created_at).getTime(),N=Number.isFinite(j)?j:0;N>=c&&(c=N,i=f)}return i?{name:String(i.customer_name||"").trim(),address:String(i.address||"").trim()}:null},z=(e,n)=>{e&&G(a=>n&&Te(a.phone)!==n?a:{...a,customer_name:e.name||a.customer_name,address:e.address||a.address})},ee=e=>{const n=D(e);if(!n)return;const a=Te(e);G(i=>{if(a&&Te(i.phone)!==a)return i;const c={...i};return!String(i.customer_name||"").trim()&&n.name&&(c.customer_name=n.name),!String(i.address||"").trim()&&n.address&&(c.address=n.address),c})},_=async e=>{var c,f,j;const n=Te(e);if(!n)return;ee(n);const a=(c=ze.current)==null?void 0:c.get(n);if(a&&Number.isFinite(a.ts)){const N=Date.now()-a.ts,d=a.status==="found"?we:Ze;if(N>=0&&N<=d){A({status:a.status,phone:n,customer:a.customer}),a.status==="found"&&a.customer&&z(a.customer,n);return}}const i=++Pe.current;A({status:"loading",phone:n});try{const N=await window.KTM.api.getJSON(`${API_BASE}/api/customers?phone=${encodeURIComponent(n)}`,"L\u1ED7i tra c\u1EE9u kh\xE1ch");if(Pe.current!==i)return;if(N&&N.exists&&N.customer){(f=ze.current)==null||f.set(n,{ts:Date.now(),status:"found",customer:N.customer}),C(),A({status:"found",phone:n,customer:N.customer}),z(N.customer,n);return}(j=ze.current)==null||j.set(n,{ts:Date.now(),status:"not-found",customer:null}),C(),A({status:"not-found",phone:n})}catch(N){if(Pe.current!==i)return;console.error("Customer lookup error:",N),A({status:"error",phone:n})}},w=e=>{const n=Te(e),a=D(n);G(c=>{const f={...c,phone:n};return a&&(!String(c.customer_name||"").trim()&&a.name&&(f.customer_name=a.name),!String(c.address||"").trim()&&a.address&&(f.address=a.address)),f}),L(!1),Ie.current&&(clearTimeout(Ie.current),Ie.current=null);const i=n;if(i.length<Pt){A(null);return}if(ut(i)&&i!==ct.current){ct.current=i,_(i);return}Ie.current=setTimeout(()=>{const c=Te(n);ut(c)&&c!==ct.current&&(ct.current=c,_(c))},It)},Z=()=>{const e=Te(r.phone);e.length<Pt||ut(e)&&e!==ct.current&&(ct.current=e,_(e))};useEffect(()=>(s?(document.body.classList.add("order-modal-open"),document.body.style.overflow="hidden"):(document.body.classList.remove("order-modal-open"),document.body.style.overflow=""),()=>{document.body.classList.remove("order-modal-open"),document.body.style.overflow=""}),[s]);const oe=Array.isArray(r.items)?r.items.length:0;useEffect(()=>{if(!s){vt.current=oe;return}oe>vt.current&&setTimeout(()=>{const e=At.current;e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},0),vt.current=oe},[s,oe]),useEffect(()=>()=>{Ie.current&&(clearTimeout(Ie.current),Ie.current=null)},[]),useEffect(()=>{yt()},[]),useEffect(()=>{dt()},[Ce]),useEffect(()=>{$t()},[]),useEffect(()=>{S&&Ye.current!==S&&(Ye.current=S,jt(y))},[S]);const ie=e=>e==="draft"?"\u0110\u01A1n nh\xE1p":e==="pending"?"Ch\u1EDD x\u1EED l\xFD":e==="processing"?"\u0110ang v\u1EADn chuy\u1EC3n":e==="done"?"Ho\xE0n th\xE0nh":e==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":e==="cancelled"||e==="canceled"?"H\u1EE7y \u0111\u01A1n":e||"",Q=e=>e==="draft"?"bg-light text-dark":e==="pending"?"bg-secondary":e==="processing"?"bg-warning text-dark":e==="done"?"bg-success":e==="paid"?"bg-primary":e==="cancelled"||e==="canceled"?"bg-danger":"bg-light text-dark",ue=React.useMemo(()=>window.KTM.orders.sortOrders(W),[W]),J=React.useMemo(()=>window.KTM.orders.sortOrders(v),[v]),le=React.useMemo(()=>{const n=(Array.isArray(J)?J:[]).filter(a=>Je(a));return n.sort((a,i)=>{const c=new Date(a==null?void 0:a.created_at).getTime(),f=new Date(i==null?void 0:i.created_at).getTime();return(Number.isFinite(c)?c:0)-(Number.isFinite(f)?f:0)}),n},[J]),Ue=React.useMemo(()=>{const n=(Array.isArray(xe)?xe:[]).filter(a=>nt(a));return n.sort((a,i)=>{const c=new Date(a==null?void 0:a.created_at).getTime(),f=new Date(i==null?void 0:i.created_at).getTime();return(Number.isFinite(c)?c:0)-(Number.isFinite(f)?f:0)}),n},[xe]),st=React.useMemo(()=>Oe?le:ue,[Oe,le,ue]),Ge=React.useMemo(()=>{if(Oe)return st;const e=String(et||"").trim();return e?(Array.isArray(st)?st:[]).filter(n=>String((n==null?void 0:n.status)||"").trim()===e):st},[st,et,Oe]),it=e=>window.KTM.date.formatDateTime(e),yt=async()=>{try{const e=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");q(Array.isArray(e)?e:[])}catch(e){console.error("Load products error:",e),q([])}},dt=async()=>{re(!0);try{let e=`${API_BASE}/api/orders`;Ce&&(e+=`?month=${Ce}`);const n=await window.KTM.api.getJSON(e,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng");U(Array.isArray(n)?n:[]),$t()}catch(e){console.error("Load orders error:",e),U([])}finally{re(!1)}},$t=async()=>{pe(!0),ye(!0);try{const[e,n]=await Promise.all([window.KTM.api.getJSON(`${API_BASE}/api/orders?overdue=1&days=${encodeURIComponent(p)}`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),window.KTM.api.getJSON(`${API_BASE}/api/orders?draftExpiring=1&remainingDays=${encodeURIComponent(k)}`,"L\u1ED7i t\u1EA3i \u0111\u01A1n nh\xE1p")]);O(Array.isArray(e)?e:[]),se(Array.isArray(n)?n:[])}catch(e){console.error("Load all orders error:",e),O([]),se([])}finally{pe(!1),ye(!1)}},Nt=e=>{var a;Me(e.id);const n=Array.isArray(e.items)&&e.items.length?e.items.map(i=>{var c,f,j,N;return{product_id:(i==null?void 0:i.product_id)||"",quantity:Number((c=i==null?void 0:i.quantity)!=null?c:1)||1,unit_price:(()=>{var u;const d=(u=i==null?void 0:i.unit_price)!=null?u:i==null?void 0:i.unitPrice,o=Number(d);return Number.isFinite(o)?Math.trunc(o):null})(),variant:String((f=i==null?void 0:i.variant)!=null?f:"").trim(),variant_json:(N=(j=i==null?void 0:i.variant_json)!=null?j:i==null?void 0:i.variantJson)!=null?N:null}}).filter(i=>i.product_id):[{product_id:e.product_id||"",quantity:Number(e.quantity||1)||1,unit_price:null,variant:"",variant_json:null}];G({customer_name:e.customer_name||"",phone:Te(e.phone||""),address:e.address||"",note:(e==null?void 0:e.note)||"",items:n.length?n:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_amount:Number((a=e==null?void 0:e.adjustment_amount)!=null?a:0)||0,adjustment_note:(e==null?void 0:e.adjustment_note)||"",status:e.status||"pending"}),Le(new Array(n.length?n.length:1).fill("")),E(new Array(n.length?n.length:1).fill(!0)),A(null),m(!0),e.phone&&_(Te(e.phone))};function jt(e){Me(null),St(e||""),L(!1),E([]),m(!0)}const wt=()=>{ce||Se||(m(!1),Me(null),St(""),L(!1),E([]))},Et=async()=>{var N,d,o;if(!F||Se||ce)return;const e=(Array.isArray(W)?W:[]).find(u=>String(u==null?void 0:u.id)===String(F))||null,n=String((e==null?void 0:e.status)||(r==null?void 0:r.status)||"").trim();if(n==="done"||n==="paid"||n==="canceled"){const u="Kh\xF4ng th\u1EC3 t\xE1ch: \u0111\u01A1n \u0111\xE3 ho\xE0n th\xE0nh/\u0111\xE3 nh\u1EADn ti\u1EC1n/\u0111\xE3 h\u1EE7y.";typeof M=="function"?M(u,"warning"):alert(u);return}const a=Te(r.phone),c=(Array.isArray(r.items)?r.items:[]).map((u,T)=>{var V,te;return{idx:T,product_id:String((u==null?void 0:u.product_id)||"").trim(),quantity:Number((V=u==null?void 0:u.quantity)!=null?V:0),variant:String((u==null?void 0:u.variant)||"").trim()||null,variant_json:(te=u==null?void 0:u.variant_json)!=null?te:null,unit_price:(()=>{const ve=Number(u==null?void 0:u.unit_price);if(Number.isFinite(ve))return Math.max(0,Math.trunc(ve));const Be=Re(u==null?void 0:u.product_id),je=u!=null&&u.variant_json&&typeof u.variant_json=="object"?u.variant_json:null;return mt(Be,je)})()}}).filter(u=>u.product_id&&Number.isFinite(u.quantity)&&u.quantity>0);if(c.length<2){const u="C\u1EA7n \xEDt nh\u1EA5t 2 s\u1EA3n ph\u1EA9m \u0111\u1EC3 t\xE1ch \u0111\u01A1n.";typeof M=="function"?M(u,"warning"):alert(u);return}const f=[],j=[];for(const u of c){const T=!!P[u.idx],V={product_id:u.product_id,quantity:u.quantity,unit_price:u.unit_price,variant:u.variant,variant_json:u.variant_json};T?f.push(V):j.push(V)}if(!f.length||!j.length){const u="Ch\u1ECDn m\u1ED9t s\u1ED1 s\u1EA3n ph\u1EA9m \u201CGiao \u0111\u1EE3t 1\u201D, v\xE0 \u0111\u1EC3 l\u1EA1i \xEDt nh\u1EA5t 1 s\u1EA3n ph\u1EA9m \u201CCh\u1EDD h\xE0ng\u201D.";typeof M=="function"?M(u,"warning"):alert(u);return}Ne(!0);try{const u=ht(r.adjustment_amount),T=(r.adjustment_note||"").trim(),V={customer_name:r.customer_name,phone:a,address:r.address,note:(r.note||"").trim(),adjustment_amount:u,adjustment_note:T,status:"processing",items:f,product_id:f[0].product_id,quantity:f[0].quantity,split_seq:1},te=await window.KTM.api.postJSON(`${API_BASE}/api/orders`,V,"L\u1ED7i t\xE1ch \u0111\u01A1n (t\u1EA1o \u0111\u01A1n giao ngay)"),ve=(o=(d=te==null?void 0:te.id)!=null?d:(N=te==null?void 0:te.order)==null?void 0:N.id)!=null?o:null;if(!ve)throw new Error("T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i: kh\xF4ng nh\u1EADn \u0111\u01B0\u1EE3c ID \u0111\u01A1n giao ngay");const Be={id:F,customer_name:r.customer_name,phone:a,address:r.address,note:(r.note||"").trim(),adjustment_amount:0,adjustment_note:"",status:"pending",items:j,product_id:j[0].product_id,quantity:j[0].quantity,parent_order_id:String(ve),split_seq:2};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${F}`,Be,"L\u1ED7i t\xE1ch \u0111\u01A1n (c\u1EADp nh\u1EADt ph\u1EA7n ch\u1EDD h\xE0ng)"),wt(),dt();const je=ve?`\u0110\xE3 t\xE1ch \u0111\u01A1n. \u0110\u01A1n giao ngay: #${ve}`:"\u0110\xE3 t\xE1ch \u0111\u01A1n.";typeof M=="function"?M(je,"success"):alert(je)}catch(u){console.error(u);const T=(u==null?void 0:u.message)||"T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i";typeof M=="function"?M(T,"danger"):alert(T)}finally{Ne(!1)}},qt=e=>{if(!e)return"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --";const n=String(e),a=g.find(i=>String(i==null?void 0:i.id)===n);return a?`${a.name}${a.code?` (${a.code})`:""}`:"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"},x=e=>{try{return String(e!=null?e:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(n){return String(e!=null?e:"").toLowerCase()}},I=e=>{const a=x(e).trim().split(/\s+/).filter(Boolean),i=a.join(" ");return{contentTokens:a,cleanedQuery:i}},K=React.useMemo(()=>(Array.isArray(g)?g:[]).map((e,n)=>{var o,u,T,V,te,ve;const a=x((o=e==null?void 0:e.name)!=null?o:""),i=x((u=e==null?void 0:e.code)!=null?u:""),c=x((T=e==null?void 0:e.category)!=null?T:""),f=x((V=e==null?void 0:e.note)!=null?V:""),j=x((te=e==null?void 0:e.id)!=null?te:""),N=x((ve=e==null?void 0:e.stt)!=null?ve:""),d=`${a} ${i} ${c} ${f} ${j} ${N}`.trim();return{p:e,originalIndex:n,name:a,code:i,category:c,note:f,haystackAll:d}}),[g]),R=(e,n,a)=>{var T,V,te,ve,Be;const i=Array.isArray(n)?n:[],c=x(a).trim();if(!i.length&&!c)return 0;const f=(T=e==null?void 0:e.name)!=null?T:"",j=(V=e==null?void 0:e.code)!=null?V:"",N=(te=e==null?void 0:e.category)!=null?te:"",d=(ve=e==null?void 0:e.note)!=null?ve:"";if(!((Be=e==null?void 0:e.haystackAll)!=null?Be:""))return 0;let u=0;c&&(f===c&&(u+=220),f.includes(c)&&(u+=140),f.startsWith(c)&&(u+=160),j&&j===c&&(u+=180),j&&j.includes(c)&&(u+=90));for(const je of i){if(!je)continue;const ot=new RegExp(`(?:^|\\s)${je.replace(/[.*+?^${}()|[\[\]\\]/g,"\\$&")}`);f.includes(je)&&(u+=35),ot.test(f)&&(u+=25),j&&j.includes(je)&&(u+=20),j&&ot.test(j)&&(u+=10),N&&N.includes(je)&&(u+=12),d&&d.includes(je)&&(u+=6)}return u>0&&f&&(u+=Math.max(0,10-Math.min(10,Math.floor(f.length/10)))),u},H=(e,n)=>{const a=String(e||""),i=String(n||"");if(a===i)return 0;if(!a)return i.length;if(!i)return a.length;const c=a.length,f=i.length;if(f>c)return H(i,a);let j=new Array(f+1),N=new Array(f+1);for(let d=0;d<=f;d++)j[d]=d;for(let d=1;d<=c;d++){N[0]=d;const o=a.charCodeAt(d-1);for(let T=1;T<=f;T++){const V=o===i.charCodeAt(T-1)?0:1;N[T]=Math.min(j[T]+1,N[T-1]+1,j[T-1]+V)}const u=j;j=N,N=u}return j[f]},X=(e,n)=>{const a=String(e||"").trim(),i=String(n||"");if(!a||!i)return!1;if(i.includes(a))return!0;const c=i.split(/\s+/).filter(Boolean);if(!c.length)return!1;const f=a.length<=4?1:2;for(const j of c)if(!(Math.abs(j.length-a.length)>f)&&H(a,j)<=f)return!0;return!1},be=e=>{const n=x(e).replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim();return n?n.split(" ").filter(Boolean):[]},he=(e,n)=>{const a=Array.isArray(n)?n:[];if(!a.length)return 0;const i=be((e==null?void 0:e.name)||""),c=be((e==null?void 0:e.code)||""),f=be((e==null?void 0:e.category)||""),j=be((e==null?void 0:e.note)||""),N=(o,u,T)=>{const V=String(o||"").trim();if(!V||!u.length)return 0;const te=V.length<=4?1:2;let ve=1/0,Be=-1;for(let We=0;We<u.length;We++){const pt=u[We];if(!pt||Math.abs(pt.length-V.length)>te)continue;const bt=H(V,pt);if(bt<ve&&(ve=bt,Be=We,bt===0))break}if(ve===1/0||ve>te)return 0;let ot=Math.round(T*(ve===0?1:ve===1?.65:.45));return Be===0?ot+=Math.round(T*.25):Be===1&&(ot+=Math.round(T*.12)),ot};let d=0;for(const o of a){if(!o)continue;const u=N(o,i,180),T=N(o,c,120),V=N(o,f,60),te=N(o,j,30);d+=Math.max(u,T,V,te)}if(d>0){const o=((e==null?void 0:e.name)||"").length;d+=Math.max(0,60-Math.min(60,Math.floor(o/2)))}return d},Ke=React.useRef(new Map);React.useEffect(()=>{Ke.current=new Map},[g]);const Xe=e=>{var o,u;const n=String(Ae[e]||"").trim();if(!n)return g;const{contentTokens:a,cleanedQuery:i}=I(n);if(a.length===0)return g;const c=x(n).trim(),f=Ke.current.get(c);if(f)return f;const j=[];for(const T of K){const V=T.haystackAll;V&&a.some(te=>V.includes(te))&&j.push(T)}let N=j;if(N.length<8&&a.length>0){const T=[],V=new Set(N.map(te=>{var ve,Be;return String((Be=(ve=te.p)==null?void 0:ve.id)!=null?Be:"")+":"+String(te.originalIndex)}));for(const te of K){const ve=String((u=(o=te.p)==null?void 0:o.id)!=null?u:"")+":"+String(te.originalIndex);if(V.has(ve))continue;const Be=te.haystackAll;Be&&a.some(je=>X(je,Be))&&(T.push(te),V.add(ve))}T.length&&(N=N.concat(T))}const d=N.map(T=>({entry:T,score:R(T,a,i)})).map(T=>{if(T.score>0)return T;const V=he(T.entry,a);return V>0?{...T,score:V}:T}).filter(T=>T.score>0).sort((T,V)=>V.score!==T.score?V.score-T.score:T.entry.originalIndex-V.entry.originalIndex).slice(0,40).map(T=>T.entry.p);return Ke.current.set(c,d),d},Re=e=>{if(!e)return null;const n=String(e);return g.find(a=>String(a==null?void 0:a.id)===n)||null},Qe=e=>{if(e==null||e==="")return[];let n=e;if(typeof n=="string"){const a=n.trim();if(!a)return[];try{n=JSON.parse(a)}catch(i){return[]}}return Array.isArray(n)?n.map((a,i)=>{var j;if(!a||typeof a!="object")return null;const c=String((j=a.name)!=null?j:"").trim()||`Bi\u1EBFn th\u1EC3 ${i+1}`,f=(Array.isArray(a.options)?a.options:[]).map(N=>{var Be,je,ot,We,pt,bt,Ee;if(!N||typeof N!="object")return null;const d=String((Be=N.label)!=null?Be:"").trim();if(!d)return null;const o=(pt=(We=(ot=(je=N.price)!=null?je:N.priceValue)!=null?ot:N.unit_price)!=null?We:N.unitPrice)!=null?pt:null,u=Number(o),T=Number.isFinite(u)?Math.trunc(u):null,V=(Ee=(bt=N.price_delta)!=null?bt:N.priceDelta)!=null?Ee:null,te=Number(V),ve=Number.isFinite(te)?Math.trunc(te):0;return{label:d,price:T,price_delta:ve}}).filter(Boolean);return{name:c,options:f}}).filter(Boolean):[]},kt=e=>{const n=Re(e);return Qe(n==null?void 0:n.variants)},ft=e=>{if(!e||typeof e!="object")return"";const n=[];for(const[a,i]of Object.entries(e)){const c=String(a||"").trim(),f=String(i||"").trim();!c||!f||n.push(`${c}: ${f}`)}return n.join(", ")},mt=(e,n)=>{var j;const a=Mt(e==null?void 0:e.price),i=Qe(e==null?void 0:e.variants);if(!i.length||!n||typeof n!="object")return a;let c=a,f=!1;for(const N of i){const d=String((N==null?void 0:N.name)||"").trim(),o=String((n==null?void 0:n[d])||"").trim();if(!d||!o)continue;const u=(Array.isArray(N.options)?N.options:[]).find(te=>String((te==null?void 0:te.label)||"").trim()===o);if(!u)continue;const T=Number(u==null?void 0:u.price);if(Number.isFinite(T)){c=Math.max(0,Math.trunc(T)),f=!0;continue}const V=Number((j=u==null?void 0:u.price_delta)!=null?j:0);Number.isFinite(V)&&(c+=Math.trunc(V))}return c},xt=e=>window.KTM.orders.getOrderItems(e),_t=e=>window.KTM.orders.getOrderTotalQty(e),gt=e=>window.KTM.orders.getOrderProductSummary(e,Re),Tt=e=>window.KTM.orders.getOrderItemRows(e,Re),Dt=e=>window.KTM.orders.getOrderAdjustmentMoney(e),Ht=e=>{const n=xt(e),a=Tt(e),i=zt(n),c=Ft(n),f=c.fee,j=Dt(e),N=i+f+j,d=[];if(e!=null&&e.customer_name&&d.push(`KH\xC1CH: ${e.customer_name}`),e!=null&&e.phone&&d.push(`S\u0110T: ${e.phone}`),e!=null&&e.address&&d.push(`\u0110\u1ECAA CH\u1EC8: ${e.address}`),((e==null?void 0:e.note)||"").trim()&&d.push(`GHI CH\xDA: ${(e.note||"").trim()}`),d.push(""),d.push("S\u1EA2N PH\u1EA8M:"),a.length)for(const o of a)d.push(`- ${o.name} (SL: ${o.qty})`);else{const o=gt(e);o&&o!=="\u2014"&&d.push(`- ${o}`)}d.push(""),d.push(`T\u1EA0M T\xCDNH: ${He(i)}`),c.found&&f!==0&&d.push(`SHIP: ${He(f)}`);{const o=String((e==null?void 0:e.adjustment_note)||"").trim();(j!==0||o)&&d.push(`\u0110I\u1EC0U CH\u1EC8NH: ${He(j)}${o?` (${o})`:""}`)}return d.push(`T\u1ED4NG: ${He(N)}`),d.filter(Boolean).join(`
`)},Bt=async e=>{try{const n=Ht(e);await window.KTM.clipboard.writeText(n),typeof M=="function"?M("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng","success"):alert("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng")}catch(n){console.error(n),typeof M=="function"?M("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)","danger"):alert("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)")}},Ft=e=>window.KTM.orders.getOrderShipInfo(e,Re),zt=e=>window.KTM.orders.getItemsSubtotal(e,Re),Gt=e=>{try{const n=e instanceof Date?e:new Date(e);if(!n||Number.isNaN(n.getTime()))return"";const a=n.getFullYear(),i=String(n.getMonth()+1).padStart(2,"0");return`${a}-${i}`}catch(n){return""}},Wt=()=>Ce?String(Ce):Gt(new Date),Qt=e=>{const n=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),a=Te((e==null?void 0:e.phone)||""),i=String((e==null?void 0:e.address)||"").trim().toLowerCase(),c=ht(e==null?void 0:e.adjustment_amount),j=(Array.isArray(e==null?void 0:e.items)?e.items:[]).map(N=>{var d;return{product_id:String((N==null?void 0:N.product_id)||"").trim(),quantity:Number((d=N==null?void 0:N.quantity)!=null?d:0),variant:String((N==null?void 0:N.variant)||"").trim()}}).filter(N=>N.product_id&&Number.isFinite(N.quantity)&&N.quantity>0).sort((N,d)=>N.product_id<d.product_id?-1:N.product_id>d.product_id?1:N.variant<d.variant?-1:N.variant>d.variant?1:N.quantity-d.quantity);return JSON.stringify({name:n,phone:a,address:i,items:j,adj:c})},Ot=React.useMemo(()=>{const e=Te((r==null?void 0:r.phone)||"");if(!e)return{count:0,orders:[],monthKey:Wt()};const n=Wt(),a=(Array.isArray(W)?W:[]).filter(i=>{if(!i||F&&String(i.id)===String(F)||Te(i.phone||"")!==e)return!1;const c=Gt(i.created_at);return c&&c===n}).sort((i,c)=>{const f=new Date(i.created_at).getTime(),j=new Date(c.created_at).getTime();return(Number.isFinite(j)?j:0)-(Number.isFinite(f)?f:0)});return{count:a.length,orders:a,monthKey:n}},[W,r==null?void 0:r.phone,Ce,F]),na=e=>{var N;const n=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),a=Te((e==null?void 0:e.phone)||""),i=String((e==null?void 0:e.address)||"").trim().toLowerCase(),c=ht((N=e==null?void 0:e.adjustment_amount)!=null?N:0),f=xt(e),j=(Array.isArray(f)?f:[]).map(d=>{var o;return{product_id:String((d==null?void 0:d.product_id)||"").trim(),quantity:Number((o=d==null?void 0:d.quantity)!=null?o:0),variant:String((d==null?void 0:d.variant)||"").trim()}}).filter(d=>d.product_id&&Number.isFinite(d.quantity)&&d.quantity>0).sort((d,o)=>d.product_id<o.product_id?-1:d.product_id>o.product_id?1:d.variant<o.variant?-1:d.variant>o.variant?1:d.quantity-o.quantity);return JSON.stringify({name:n,phone:a,address:i,items:j,adj:c})},Yt=React.useMemo(()=>{if(F)return"";const e=Te((r==null?void 0:r.phone)||"");if(!e)return"";const n=Wt(),a=Qt(r),i=Array.isArray(W)?W:[];for(const c of i){if(!c||F&&String(c.id)===String(F)||Te(c.phone||"")!==e)continue;const f=Gt(c.created_at);if(!f||f!==n)continue;const j=na(c);if(j&&j===a)return`\u0110\u01A1n n\xE0y gi\u1ED1ng 100% m\u1ED9t \u0111\u01A1n trong th\xE1ng ${n}${c!=null&&c.id?` (#${c.id})`:""}`}return""},[W,r,Ce,F]),Zt=e=>{var ot;const n=[],a=[],i=String((e==null?void 0:e.customer_name)||"").trim(),c=Te((e==null?void 0:e.phone)||""),f=String((e==null?void 0:e.address)||"").trim();i||n.push("Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng"),c||n.push("Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i"),c&&!ut(c)&&n.push("S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)"),f||a.push("Thi\u1EBFu \u0111\u1ECBa ch\u1EC9");const N=(Array.isArray(e==null?void 0:e.items)?e.items:[]).filter(We=>We&&We.product_id);N.length===0&&n.push("Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m"),N.some(We=>{var bt;const pt=Number((bt=We==null?void 0:We.quantity)!=null?bt:0);return!Number.isFinite(pt)||pt<=0})&&n.push("S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0");const o=new Set;let u=!1;for(const We of N){const pt=String(We.product_id||"").trim(),bt=String((We==null?void 0:We.variant)||"").trim();if(!pt)continue;const Ee=`${pt}||${bt}`;if(o.has(Ee)){u=!0;break}o.add(Ee)}u&&a.push("S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)");const T=zt(N),V=Ft(N),te=V!=null&&V.found?Number((ot=V==null?void 0:V.fee)!=null?ot:0):0,ve=ht(e==null?void 0:e.adjustment_amount),Be=String((e==null?void 0:e.adjustment_note)||"").trim();V!=null&&V.found&&(te>=2e5||T>0&&te>T*.6)&&a.push(`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${He(te)}`),ve!==0&&!Be&&a.push("C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh");const je=Math.abs(ve);return(je>=5e5||T>0&&je>T*.5)&&ve!==0&&a.push(`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${He(ve)}`),{errors:n,warnings:a,canSubmit:n.length===0}},la=React.useMemo(()=>Zt(r),[r,g]),rt=React.useMemo(()=>{var bt;const e=String((r==null?void 0:r.customer_name)||"").trim(),n=Te((r==null?void 0:r.phone)||""),a=String((r==null?void 0:r.address)||"").trim(),i=Array.isArray(r==null?void 0:r.items)?r.items:[],c=new Map;for(const Ee of i){const Vt=String((Ee==null?void 0:Ee.product_id)||"").trim(),Jt=String((Ee==null?void 0:Ee.variant)||"").trim();if(!Vt)continue;const Ut=`${Vt}||${Jt}`;c.set(Ut,(c.get(Ut)||0)+1)}const f=i.map(Ee=>{var aa;const Vt=String((Ee==null?void 0:Ee.product_id)||"").trim(),Jt=Number((aa=Ee==null?void 0:Ee.quantity)!=null?aa:0),Ut=Vt?"":"Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m",sa=Number.isFinite(Jt)&&Jt>0?"":"S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0",ia=String((Ee==null?void 0:Ee.variant)||"").trim(),ra=`${Vt}||${ia}`,oa=Vt&&(c.get(ra)||0)>1?"S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)":"";return{productError:Ut,qtyError:sa,dupWarn:oa}}),j=i.filter(Ee=>Ee&&Ee.product_id),N=zt(j),d=Ft(j),o=d!=null&&d.found?Number((bt=d==null?void 0:d.fee)!=null?bt:0):0,u=ht(r==null?void 0:r.adjustment_amount),T=String((r==null?void 0:r.adjustment_note)||"").trim(),V=Math.abs(u),te=u!==0&&!T?"C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh":"",ve=u!==0&&(V>=5e5||N>0&&V>N*.5)?`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${He(u)}`:"",Be=d!=null&&d.found&&(o>=2e5||N>0&&o>N*.6)?`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${He(o)}`:"",je=e?"":"Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng",ot=n?ut(n)?"":"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)":"Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",We=a?"":"Thi\u1EBFu \u0111\u1ECBa ch\u1EC9",pt=!je&&!ot&&f.every(Ee=>!Ee.productError&&!Ee.qtyError);return{nameError:je,phoneError:ot,addressWarn:We,items:f,shipAbnormalWarn:Be,adjustmentNoteWarn:te,adjustmentAbnormalWarn:ve,canSubmit:pt}},[r,g]),ea=async e=>{var j,N,d;const n=(e==null?void 0:e.mode)||"close",a=Zt(r);if(!a.canSubmit){const o=a.errors[0]||"Thi\u1EBFu d\u1EEF li\u1EC7u b\u1EAFt bu\u1ED9c";typeof M=="function"?M(o,"danger"):alert(o);return}if(!F&&Yt){const o=`${Yt}

B\u1EA1n c\xF3 mu\u1ED1n ti\u1EBFp t\u1EE5c l\u01B0u kh\xF4ng?`;if(!window.confirm(o)){(Ot==null?void 0:Ot.count)>0&&L(!0),setTimeout(()=>{var V;const T=document.getElementById("order-phone-input");T&&typeof T.scrollIntoView=="function"&&(T.scrollIntoView({block:"center",behavior:"smooth"}),(V=T.focus)==null||V.call(T))},0);return}}const i=Te(r.phone),f=(Array.isArray(r.items)?r.items:[]).map(o=>{var u,T;return{product_id:(o==null?void 0:o.product_id)||"",quantity:Number((u=o==null?void 0:o.quantity)!=null?u:1),variant:String((o==null?void 0:o.variant)||"").trim()||null,variant_json:(T=o==null?void 0:o.variant_json)!=null?T:null,unit_price:(()=>{const V=o==null?void 0:o.unit_price,te=Number(V);if(Number.isFinite(te))return Math.max(0,Math.trunc(te));const ve=Re(o==null?void 0:o.product_id),Be=o!=null&&o.variant_json&&typeof o.variant_json=="object"?o.variant_json:null;return mt(ve,Be)})()}}).filter(o=>o.product_id&&Number.isFinite(o.quantity)&&o.quantity>0);de(!0);try{const o=F?`${API_BASE}/api/orders/${F}`:`${API_BASE}/api/orders`,u=f[0],T={customer_name:r.customer_name,phone:i,address:r.address,note:(r.note||"").trim(),adjustment_amount:ht(r.adjustment_amount),adjustment_note:(r.adjustment_note||"").trim(),product_id:u.product_id,quantity:u.quantity,status:r.status,items:f,...F?{id:F}:{}};if(F)await window.KTM.api.putJSON(o,T,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");else{const V=await window.KTM.api.postJSON(o,T,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");Rt.current={id:(d=(N=V==null?void 0:V.id)!=null?N:(j=V==null?void 0:V.order)==null?void 0:j.id)!=null?d:null,fingerprint:Qt(r),ts:Date.now()}}n==="new"&&!F?(St(""),Me(null),m(!0)):(St(""),Me(null),m(!1)),dt()}catch(o){console.error(o),typeof M=="function"?M(o.message,"danger"):alert(o.message);return}finally{de(!1)}},Xt=e=>window.KTM.orders.getOrderTotalMoney(e,Re),ta=async e=>{if(confirm("X\xF3a \u0111\u01A1n h\xE0ng n\xE0y?")){ke(e);try{await window.KTM.api.deleteJSON(`${API_BASE}/api/orders/${e}`,"L\u1ED7i x\xF3a \u0111\u01A1n h\xE0ng"),dt(),$t()}catch(n){console.error(n),typeof M=="function"?M(n.message,"danger"):alert(n.message)}finally{ke(null)}}},Lt=async(e,n)=>{var i;const a=e==null?void 0:e.id;if(!(!a||!n)){De(a);try{const c=xt(e),f=(Array.isArray(c)?c:[]).map(d=>{var o,u;return{product_id:(d==null?void 0:d.product_id)||"",quantity:Number((o=d==null?void 0:d.quantity)!=null?o:1),variant:String((d==null?void 0:d.variant)||"").trim()||null,variant_json:(u=d==null?void 0:d.variant_json)!=null?u:null,unit_price:(()=>{var te;const T=(te=d==null?void 0:d.unit_price)!=null?te:d==null?void 0:d.unitPrice,V=Number(T);return Number.isFinite(V)?Math.max(0,Math.trunc(V)):null})()}}).filter(d=>d.product_id&&Number.isFinite(d.quantity)&&d.quantity>0);if(!f.length)throw new Error("Kh\xF4ng th\u1EC3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i: \u0111\u01A1n kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m h\u1EE3p l\u1EC7");const j=f[0],N={id:a,customer_name:(e==null?void 0:e.customer_name)||"",phone:Te((e==null?void 0:e.phone)||""),address:(e==null?void 0:e.address)||"",note:((e==null?void 0:e.note)||"").trim(),adjustment_amount:Number((i=e==null?void 0:e.adjustment_amount)!=null?i:0)||0,adjustment_note:(e==null?void 0:e.adjustment_note)||"",product_id:j.product_id,quantity:j.quantity,status:n,items:f};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${a}`,N,"L\u1ED7i c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i"),U(d=>Array.isArray(d)?d.map(o=>(o==null?void 0:o.id)===a?{...o,status:n}:o):d),O(d=>Array.isArray(d)?d.map(o=>(o==null?void 0:o.id)===a?{...o,status:n}:o):d),typeof M=="function"&&M("\u0110\xE3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i","success")}catch(c){console.error(c),typeof M=="function"?M(c.message,"danger"):alert(c.message)}finally{De(null)}}};return React.createElement("div",{className:"product-manager"},React.createElement(Loading,{show:ae&&!s||ce||!!ne||!!fe}),React.createElement("div",{className:"product-header"},React.createElement("h5",null,"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"),React.createElement("button",{className:"btn btn-dark btn-sm",onClick:jt,disabled:ce||!!ne},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o \u0111\u01A1n")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"L\u1ECDc theo th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:Ce,onChange:e=>$e(e.target.value),"aria-label":"Ch\u1ECDn th\xE1ng",disabled:Oe}),Ce&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{$e("")},title:"B\u1ECF l\u1ECDc","aria-label":"B\u1ECF l\u1ECDc",disabled:ae},React.createElement("i",{className:"fas fa-times"})))),React.createElement("div",{className:"col-12 col-md-4"},React.createElement("label",{className:"form-label mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-filter"})),React.createElement("select",{className:"form-select",value:et,onChange:e=>_e(e.target.value),"aria-label":"L\u1ECDc theo tr\u1EA1ng th\xE1i",disabled:Oe},React.createElement("option",{value:""},"T\u1EA5t c\u1EA3"),React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n")),et&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>_e(""),title:"B\u1ECF l\u1ECDc tr\u1EA1ng th\xE1i","aria-label":"B\u1ECF l\u1ECDc tr\u1EA1ng th\xE1i",disabled:ae},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"form-check mt-2"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"orders-overdue-only",checked:Oe,onChange:e=>{const n=!!e.target.checked;qe(n),n&&_e("pending")}}),React.createElement("label",{className:"form-check-label",htmlFor:"orders-overdue-only"},"Ch\u1EC9 hi\u1EC7n \u0111\u01A1n ch\u1EADm > ",p," ng\xE0y (Ch\u1EDD x\u1EED l\xFD)"))),React.createElement("div",{className:"col-12 col-md-3 d-flex gap-2 justify-content-md-end"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:dt,disabled:ae},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")))),React.createElement("div",{className:"card p-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},"Danh s\xE1ch \u0111\u01A1n h\xE0ng"),React.createElement("span",{className:"text-muted small"},et?`${Ge.length}/${W.length} \u0111\u01A1n`:`${W.length} \u0111\u01A1n`)),le.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"C\xF3 ",React.createElement("strong",null,le.length)," \u0111\u01A1n ",React.createElement("strong",null,"Ch\u1EDD x\u1EED l\xFD")," qu\xE1 ",p," ng\xE0y.",B&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{qe(!0),_e("pending")}},"Xem ngay")),Ue.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-clock me-2"}),"C\xF3 ",React.createElement("strong",null,Ue.length)," \u0111\u01A1n ",React.createElement("strong",null,"Nh\xE1p")," s\u1EAFp t\u1EF1 x\xF3a (c\xF2n \u2264 ",k," ng\xE0y).",me&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{qe(!1),_e("draft"),$e(""),dt()}},"Xem ngay")),ae?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):W.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},"Ch\u01B0a c\xF3 \u0111\u01A1n h\xE0ng"):Ge.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},"Kh\xF4ng c\xF3 \u0111\u01A1n ph\xF9 h\u1EE3p"):React.createElement(React.Fragment,null,React.createElement("div",{className:"d-md-none mt-3"},Ge.map(e=>{var n;return React.createElement("div",{key:e.id,className:"card mb-2"},React.createElement("div",{className:"card-body p-3"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"flex-grow-1",style:{minWidth:0}},React.createElement("div",{className:"fw-semibold text-truncate"},e.customer_name),React.createElement("div",{className:"fw-bold font-monospace"},e.phone),Number((n=e==null?void 0:e.split_seq)!=null?n:0)>0&&React.createElement("div",{className:"text-muted small"},"\u0110\u1EE3t ",e.split_seq),e.address&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},e.address),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("div",{className:"d-flex align-items-start gap-1 flex-shrink-0"},React.createElement("span",{className:`badge ${Q(e.status)}`},ie(e.status)),Je(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${p} ng\xE0y`},"\u26A0 Ch\u1EADm ",Ve(e),"d"),nt(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 x\xF3a sau ${$} ng\xE0y`},"\u23F3 C\xF2n ",at(e),"d"))),React.createElement("div",{className:"mt-2 small"},React.createElement("div",null,React.createElement("div",{className:"text-muted"},"S\u1EA3n ph\u1EA9m:"),(()=>{const a=Tt(e);return a.length?React.createElement("div",{className:"mt-1"},a.map((i,c)=>React.createElement("div",{key:c,className:"d-flex justify-content-between gap-2",style:{lineHeight:1.25}},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,whiteSpace:"normal",wordBreak:"break-word",flex:1}},React.createElement("span",{className:"text-muted me-1"},c+1,"."),i.name),React.createElement("div",{className:"text-muted small text-end text-nowrap",style:{flexShrink:0}},"x",i.qty,Number(i.unitPrice)>0?` \u2022 ${He(i.unitPrice)}`:"")))):React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},gt(e))})()),(Dt(e)!==0||((e==null?void 0:e.adjustment_note)||"").trim())&&React.createElement("div",{style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh:")," ",React.createElement("span",{className:"fw-semibold"},He(Dt(e))),((e==null?void 0:e.adjustment_note)||"").trim()?React.createElement("span",{className:"text-muted"}," ","(",(e.adjustment_note||"").trim(),")"):null),React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng ti\u1EC1n"),React.createElement("span",{className:"fw-bold"},He(Xt(e)))),React.createElement("div",{className:"text-muted"},React.createElement("span",null,"Th\u1EDDi gian:")," ",it(e.created_at))),React.createElement("div",{className:"mt-3 d-flex gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary flex-fill",onClick:()=>Nt(e),disabled:ce||!!ne||fe===e.id},"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary flex-fill",onClick:()=>Bt(e),disabled:ce||!!ne||fe===e.id},React.createElement("i",{className:"fas fa-copy me-1"}),"Copy"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger flex-fill",onClick:()=>ta(e.id),disabled:ce||ne===e.id||fe===e.id},ne===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a")),React.createElement("div",{className:"mt-2 d-flex gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning flex-fill",onClick:()=>Lt(e,"processing"),disabled:ce||!!ne||fe===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success flex-fill",onClick:()=>Lt(e,"done"),disabled:ce||!!ne||fe===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary flex-fill",onClick:()=>Lt(e,"paid"),disabled:ce||!!ne||fe===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger flex-fill",onClick:()=>Lt(e,"canceled"),disabled:ce||!!ne||fe===e.id||e.status==="canceled",title:"H\u1EE7y \u0111\u01A1n"},"H\u1EE7y"))))})),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive orders-table-wrap mt-3"},React.createElement("table",{className:"table orders-table table-hover align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"SL"),React.createElement("th",null,"T\u1ED5ng ti\u1EC1n"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"),React.createElement("th",null,"Th\u1EDDi gian"),React.createElement("th",null))),React.createElement("tbody",null,Ge.map(e=>React.createElement("tr",{key:e.id},React.createElement("td",null,React.createElement("div",{className:"fw-semibold"},e.customer_name),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("td",null,e.phone),React.createElement("td",null,(()=>{const n=Tt(e);return n.length?React.createElement("div",{className:"d-grid gap-1"},n.map((a,i)=>React.createElement("div",{key:i,className:"small",style:{whiteSpace:"normal",wordBreak:"break-word",lineHeight:1.2}},React.createElement("span",{className:"text-muted me-1"},i+1,"."),React.createElement("span",{className:"fw-semibold"},a.name)," ",React.createElement("span",{className:"text-muted"},"x",a.qty),Number(a.unitPrice)>0&&React.createElement("span",{className:"text-muted"}," ","\u2022 ",He(a.unitPrice))))):gt(e)})()),React.createElement("td",null,_t(e)),React.createElement("td",{className:"fw-semibold"},He(Xt(e))),React.createElement("td",null,React.createElement("div",{className:"d-flex align-items-center gap-1 flex-wrap"},React.createElement("span",{className:`badge ${Q(e.status)}`},ie(e.status)),Je(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${p} ng\xE0y`},"\u26A0 Ch\u1EADm ",Ve(e),"d"),nt(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 x\xF3a sau ${$} ng\xE0y`},"\u23F3 C\xF2n ",at(e),"d"))),React.createElement("td",null,it(e.created_at)),React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-sm btn-primary me-1",onClick:()=>Nt(e),disabled:ce||!!ne||fe===e.id},"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary me-1",onClick:()=>Bt(e),disabled:ce||!!ne||fe===e.id},React.createElement("i",{className:"fas fa-copy"})),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning me-1",onClick:()=>Lt(e,"processing"),disabled:ce||!!ne||fe===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success me-1",onClick:()=>Lt(e,"done"),disabled:ce||!!ne||fe===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary me-1",onClick:()=>Lt(e,"paid"),disabled:ce||!!ne||fe===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger me-1",onClick:()=>Lt(e,"canceled"),disabled:ce||!!ne||fe===e.id||e.status==="canceled",title:"H\u1EE7y \u0111\u01A1n"},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>ta(e.id),disabled:ce||ne===e.id},ne===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a")))))))))),s&&React.createElement("div",{className:"modal show d-block order-modal",style:{background:"rgba(0,0,0,0.6)"},role:"dialog","aria-modal":"true"},React.createElement("div",{className:"modal-dialog modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ffca2c)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark mb-0"},React.createElement("i",{className:"fas fa-receipt me-2"}),F?"S\u1EEDa \u0111\u01A1n h\xE0ng":"T\u1EA1o \u0111\u01A1n h\xE0ng"),React.createElement("button",{type:"button",className:"btn-close",onClick:wt})),React.createElement("form",{onSubmit:e=>{e.preventDefault(),ea({mode:"close"})}},React.createElement("div",{className:"modal-body",ref:At},React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"T\xEAn kh\xE1ch h\xE0ng *"),React.createElement("input",{className:"form-control",value:r.customer_name,onChange:e=>G({...r,customer_name:e.target.value}),placeholder:"Nh\u1EADp t\xEAn kh\xE1ch h\xE0ng",required:!0,style:{borderRadius:10,padding:12}}),!!rt.nameError&&React.createElement("div",{className:"form-text text-danger"},rt.nameError)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i *"),React.createElement("input",{className:"form-control",type:"tel",inputMode:"numeric",pattern:"[0-9+\\s-]*",id:"order-phone-input",value:r.phone,onChange:e=>w(e.target.value),onBlur:Z,placeholder:"Nh\u1EADp s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",required:!0,style:{borderRadius:10,padding:12}}),!!rt.phoneError&&React.createElement("div",{className:"form-text text-danger"},rt.phoneError),!rt.phoneError&&Ot.count>0&&React.createElement("div",{className:"form-text text-warning d-flex align-items-center justify-content-between gap-2"},React.createElement("span",null,"Kh\xE1ch n\xE0y \u0111\xE3 c\xF3 ",Ot.count," \u0111\u01A1n trong th\xE1ng ",Ot.monthKey,"."),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>L(e=>!e)},Y?"\u1EA8n l\u1ECBch s\u1EED":"Xem l\u1ECBch s\u1EED")),Y&&Ot.orders.length>0&&React.createElement("div",{className:"mt-2 border rounded-3 p-2",style:{background:"#fff"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between gap-2 mb-2"},React.createElement("div",{className:"small fw-semibold"},"L\u1ECBch s\u1EED \u0111\u01A1n (c\xF9ng th\xE1ng)"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>L(!1)},"\u1EA8n")),React.createElement("div",{className:"d-grid gap-2"},Ot.orders.slice(0,5).map(e=>React.createElement("div",{key:e.id,className:"d-flex align-items-start justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"small fw-semibold",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},"#",e.id," \u2022 ",React.createElement("span",{className:`badge ${Q(e.status)}`},ie(e.status))),React.createElement("div",{className:"text-muted small"},it(e.created_at)," \u2022 ",He(Xt(e))),React.createElement("div",{className:"text-muted small",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},gt(e))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{confirm(`M\u1EDF \u0111\u01A1n #${e.id}? D\u1EEF li\u1EC7u \u0111ang nh\u1EADp s\u1EBD m\u1EA5t.`)&&Nt(e)}},"M\u1EDF")))),Ot.orders.length>5&&React.createElement("div",{className:"text-muted small mt-2"},"Ch\u1EC9 hi\u1EC3n th\u1ECB 5 \u0111\u01A1n g\u1EA7n nh\u1EA5t.")),(b==null?void 0:b.status)==="loading"&&React.createElement("div",{className:"form-text"},"\u0110ang t\xECm kh\xE1ch theo S\u0110T..."),(b==null?void 0:b.status)==="found"&&React.createElement("div",{className:"form-text text-success"},"\u0110\xE3 c\xF3 kh\xE1ch, t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n th\xF4ng tin."),(b==null?void 0:b.status)==="not-found"&&React.createElement("div",{className:"form-text text-muted"},"Ch\u01B0a c\xF3 kh\xE1ch, s\u1EBD t\u1EA1o m\u1EDBi khi l\u01B0u \u0111\u01A1n."),(b==null?void 0:b.status)==="error"&&React.createElement("div",{className:"form-text text-danger"},"Kh\xF4ng tra \u0111\u01B0\u1EE3c kh\xE1ch (l\u1ED7i m\u1EA1ng/server).")),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("select",{className:"form-select",value:r.status,onChange:e=>G({...r,status:e.target.value}),style:{borderRadius:10,padding:12}},React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n"))),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("input",{className:"form-control",value:r.address,onChange:e=>G({...r,address:e.target.value}),placeholder:"Nh\u1EADp \u0111\u1ECBa ch\u1EC9 (kh\xF4ng b\u1EAFt bu\u1ED9c)",style:{borderRadius:10,padding:12}}),!!rt.addressWarn&&React.createElement("div",{className:"form-text text-warning"},rt.addressWarn)),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111\u01A1n h\xE0ng"),React.createElement("textarea",{className:"form-control",value:r.note,onChange:e=>G({...r,note:e.target.value}),placeholder:"V\xED d\u1EE5: Giao gi\u1EDD h\xE0nh ch\xEDnh / G\u1ECDi tr\u01B0\u1EDBc khi giao...",rows:2,style:{borderRadius:10,padding:12,resize:"vertical"}})),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110i\u1EC1u ch\u1EC9nh gi\xE1 (th\xEAm/b\u1EDBt)"),React.createElement("input",{type:"number",className:"form-control",value:r.adjustment_amount,onChange:e=>G({...r,adjustment_amount:e.target.value}),placeholder:"-20000 ho\u1EB7c 20000",step:"1000",style:{borderRadius:10,padding:12}}),React.createElement("div",{className:"form-text"},"\xC2m = gi\u1EA3m gi\xE1, d\u01B0\u01A1ng = c\u1ED9ng th\xEAm."),!!rt.adjustmentAbnormalWarn&&React.createElement("div",{className:"form-text text-warning"},rt.adjustmentAbnormalWarn)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh"),React.createElement("input",{className:"form-control",value:r.adjustment_note,onChange:e=>G({...r,adjustment_note:e.target.value}),placeholder:"V\xED d\u1EE5: Gi\u1EA3m gi\xE1 cho kh\xE1ch / B\xF9 ph\xED \u0111\xF3ng g\xF3i...",style:{borderRadius:10,padding:12}}),!!rt.adjustmentNoteWarn&&React.createElement("div",{className:"form-text text-warning"},rt.adjustmentNoteWarn)),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1EA3n ph\u1EA9m *"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{G(e=>({...e,items:[...Array.isArray(e.items)?e.items:[],{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]})),Le(e=>[...Array.isArray(e)?e:[],""]),F&&E(e=>[...Array.isArray(e)?e:[],!0])},disabled:ce},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(r.items)?r.items:[{product_id:"",quantity:1}]).map((e,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"dropdown w-100",ref:a=>{ge.current[n]=a}},React.createElement("button",{type:"button",className:"form-control text-start d-flex align-items-center justify-content-between",style:{borderRadius:10,padding:12},onClick:()=>{h(a=>a===n?null:n),setTimeout(()=>{const a=document.getElementById(`order-product-search-${n}`);a&&a.focus()},0)}},React.createElement("span",{className:e.product_id?"":"text-muted",style:{minWidth:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},qt(e.product_id)),React.createElement("i",{className:"fas fa-chevron-down text-muted",style:{marginLeft:8,flexShrink:0}})),l===n&&React.createElement("div",{className:"dropdown-menu show w-100 p-2",style:{maxHeight:320,overflowY:"auto"}},React.createElement("input",{id:`order-product-search-${n}`,className:"form-control",value:Ae[n]||"",onChange:a=>{const i=a.target.value;Le(c=>{const f=Array.isArray(c)?[...c]:[];return f[n]=i,f})},placeholder:"T\xECm theo t\xEAn / m\xE3...",style:{borderRadius:10,padding:10}}),React.createElement("div",{className:"mt-2"}),(()=>{const a=Xe(n);return a.length===0?React.createElement("div",{className:"text-muted small px-2 py-1"},"Kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p"):a.map(i=>React.createElement("button",{key:i.id,type:"button",className:"dropdown-item",onClick:()=>{const c=String(i.id),f=Qe(i==null?void 0:i.variants),j={};for(const o of f){const u=String((o==null?void 0:o.name)||"").trim(),T=Array.isArray(o==null?void 0:o.options)?o.options[0]:null,V=String((T==null?void 0:T.label)||"").trim();u&&V&&(j[u]=V)}const N=ft(j),d=mt(i,j);G(o=>{const u=Array.isArray(o.items)?[...o.items]:[];return u[n]={...u[n]||{quantity:1},product_id:c,variant_json:Object.keys(j).length?j:null,variant:N,unit_price:f.length?d:null},{...o,items:u}}),h(null)}},i.name,i.code?` (${i.code})`:""))})()),React.createElement("select",{className:"form-select",value:e.product_id,onChange:()=>{},required:!0,style:{position:"absolute",opacity:0,height:0,pointerEvents:"none"},tabIndex:-1,"aria-hidden":"true"},React.createElement("option",{value:""},"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"),g.map(a=>React.createElement("option",{key:a.id,value:a.id},a.name)))),(()=>{var i;const a=(i=rt.items)==null?void 0:i[n];return a?React.createElement(React.Fragment,null,!!a.productError&&React.createElement("div",{className:"form-text text-danger"},a.productError),!!a.dupWarn&&React.createElement("div",{className:"form-text text-warning"},a.dupWarn)):null})(),(()=>{if(!(e!=null&&e.product_id))return null;const a=Re(e.product_id),i=Qe(a==null?void 0:a.variants);if(!i.length)return null;const c=e!=null&&e.variant_json&&typeof e.variant_json=="object"?e.variant_json:{};return React.createElement("div",{className:"mt-2 d-grid gap-2"},i.map((f,j)=>{const N=String((f==null?void 0:f.name)||`Bi\u1EBFn th\u1EC3 ${j+1}`).trim(),d=String((c==null?void 0:c[N])||"").trim();return React.createElement("div",{key:N},React.createElement("label",{className:"form-label small text-muted mb-1"},N),React.createElement("select",{className:"form-select",value:d,onChange:o=>{const u=String(o.target.value||"").trim();G(T=>{const V=Array.isArray(T.items)?[...T.items]:[],te={...V[n]||{}},ve=Re(te.product_id),Be=Qe(ve==null?void 0:ve.variants),je=te!=null&&te.variant_json&&typeof te.variant_json=="object"?{...te.variant_json}:{};u?je[N]=u:delete je[N];const ot=ft(je),We=mt(ve,je);return V[n]={...te,variant_json:Object.keys(je).length?je:null,variant:ot,unit_price:We},{...T,items:V}})},style:{borderRadius:10,padding:12}},React.createElement("option",{value:""},"-- ch\u1ECDn ",N," --"),(Array.isArray(f==null?void 0:f.options)?f.options:[]).map(o=>React.createElement("option",{key:o.label,value:o.label},o.label,Number.isFinite(Number(o==null?void 0:o.price))?` (${He(Number(o.price))})`:Number(o==null?void 0:o.price_delta)?` (${o.price_delta>0?"+":""}${o.price_delta})`:""))))}))})(),F&&React.createElement("div",{className:"form-check mt-1"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:`order-split-deliver-${n}`,checked:!!P[n],onChange:a=>{const i=!!a.target.checked;E(c=>{const f=Array.isArray(c)?[...c]:[],j=Array.isArray(r.items)?r.items.length:0;for(;f.length<j;)f.push(!0);return f[n]=i,f})},disabled:ce||Se}),React.createElement("label",{className:"form-check-label small text-muted",htmlFor:`order-split-deliver-${n}`},"Giao \u0111\u1EE3t 1"))),React.createElement("div",{className:"col-8 col-md-3"},React.createElement("input",{type:"number",className:"form-control",value:e.quantity,onChange:a=>{const i=a.target.value;G(c=>{const f=Array.isArray(c.items)?[...c.items]:[];return f[n]={...f[n]||{product_id:""},quantity:i},{...c,items:f}})},min:"1",style:{borderRadius:10,padding:12}}),(()=>{var i;const a=(i=rt.items)==null?void 0:i[n];return a&&a.qtyError?React.createElement("div",{className:"form-text text-danger"},a.qtyError):null})()),React.createElement("div",{className:"col-4 col-md-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>{G(a=>{const i=Array.isArray(a.items)?[...a.items]:[];return i.splice(n,1),{...a,items:i.length?i:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]}}),Le(a=>{const i=Array.isArray(a)?[...a]:[];return i.splice(n,1),i.length?i:[""]}),E(a=>{const i=Array.isArray(a)?[...a]:[];return i.splice(n,1),i}),h(a=>a==null?a:a===n?null:a>n?a-1:a)},disabled:ce||Se||(Array.isArray(r.items)?r.items.length:1)<=1,title:"X\xF3a s\u1EA3n ph\u1EA9m",style:{borderRadius:10,padding:10}},React.createElement("i",{className:"fas fa-trash"}))))))),(()=>{const n=(Array.isArray(r.items)?r.items:[]).filter(j=>j==null?void 0:j.product_id),a=zt(n),i=Ft(n),c=ht(r.adjustment_amount),f=a+(i.found?i.fee:0)+c;return React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-column gap-1 small bg-light rounded-3 p-3"},React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1EA1m t\xEDnh"),React.createElement("span",{className:"fw-semibold"},He(a))),i.found&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"Ship"),React.createElement("span",{className:"fw-semibold"},He(i.fee))),!!rt.shipAbnormalWarn&&React.createElement("div",{className:"text-warning"},rt.shipAbnormalWarn),c!==0&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh"),React.createElement("span",{className:"fw-semibold"},He(c))),(r.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111\u01A1n: ",(r.note||"").trim()),(r.adjustment_note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh: ",(r.adjustment_note||"").trim()),React.createElement("div",{className:"d-flex justify-content-between pt-1 border-top"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng"),React.createElement("span",{className:"fw-bold"},He(f)))))})())),React.createElement("div",{className:"modal-footer",style:{border:"none"}},React.createElement("button",{type:"button",className:"btn btn-light",onClick:wt,disabled:ce||Se,style:{borderRadius:10}},"H\u1EE7y"),!!F&&React.createElement("button",{type:"button",className:"btn btn-outline-primary fw-semibold",onClick:Et,disabled:ce||Se,style:{borderRadius:10},title:"Ch\u1ECDn s\u1EA3n ph\u1EA9m giao \u0111\u1EE3t 1 v\xE0 t\xE1ch ph\u1EA7n c\xF2n l\u1EA1i sang \u0111\u01A1n ch\u1EDD h\xE0ng"},Se?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang t\xE1ch..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-random me-2"}),"T\xE1ch \u0111\u01A1n giao ngay")),!F&&React.createElement("button",{type:"button",className:"btn btn-outline-warning fw-semibold",onClick:()=>ea({mode:"new"}),disabled:ce||!rt.canSubmit,style:{borderRadius:10},title:"L\u01B0u xong gi\u1EEF form \u0111\u1EC3 t\u1EA1o \u0111\u01A1n m\u1EDBi"},React.createElement("i",{className:"fas fa-plus me-2"}),"L\u01B0u & t\u1EA1o \u0111\u01A1n m\u1EDBi"),React.createElement("button",{type:"submit",className:"btn btn-warning fw-semibold",disabled:ce||Se||!rt.canSubmit,style:{borderRadius:10,boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},ce?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u"))))))))}

