const{useState,useEffect,useRef,useMemo}=React,CLOUDINARY_CLOUD_NAME="diwxfpt92",CLOUDINARY_UPLOAD_PRESET="ktm_unsigned",API_BASE="";function LoginPage({onLogin:_,error:D}){const[L,be]=useState(""),[te,X]=useState(""),[q,Oe]=useState(!1),[Fe,we]=useState(!1);return React.createElement("div",{className:"login-page"},React.createElement("div",{className:"login-box"},React.createElement("div",{className:"text-center mb-4"},React.createElement("i",{className:"fas fa-tractor fa-3x text-warning mb-3"}),React.createElement("h4",{className:"text-dark"},"KTM Admin"),React.createElement("p",{className:"text-muted small"},"\u0110\u0103ng nh\u1EADp \u0111\u1EC3 qu\u1EA3n l\xFD")),D&&React.createElement("div",{className:"alert alert-danger py-2 small"},React.createElement("i",{className:"fas fa-exclamation-circle me-2"}),D),React.createElement("form",{onSubmit:async st=>{st.preventDefault(),Oe(!0),await _(L,te),Oe(!1)}},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small"},"T\xEAn \u0111\u0103ng nh\u1EADp"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-user"})),React.createElement("input",{type:"text",className:"form-control",value:L,onChange:st=>be(st.target.value),placeholder:"admin",required:!0,autoFocus:!0}))),React.createElement("div",{className:"mb-4"},React.createElement("label",{className:"form-label small"},"M\u1EADt kh\u1EA9u"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-lock"})),React.createElement("input",{type:Fe?"text":"password",className:"form-control",value:te,onChange:st=>X(st.target.value),placeholder:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",required:!0}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>we(!Fe)},React.createElement("i",{className:`fas fa-eye${Fe?"-slash":""}`})))),React.createElement("button",{type:"submit",className:"btn btn-warning w-100",disabled:q},q?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang \u0111\u0103ng nh\u1EADp..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-sign-in-alt me-2"}),"\u0110\u0103ng nh\u1EADp"))),React.createElement("div",{className:"text-center mt-4"},React.createElement("a",{href:"/",className:"text-muted small text-decoration-none"},React.createElement("i",{className:"fas fa-arrow-left me-1"}),"V\u1EC1 trang ch\u1EE7"))))}function Toast({message:_,type:D,onClose:L,actionLabel:be,onAction:te,durationMs:X}){return useEffect(()=>{const q=Number(X),Oe=Number.isFinite(q)&&q>0?q:3e3,Fe=setTimeout(L,Oe);return()=>clearTimeout(Fe)},[L,X]),React.createElement("div",{className:`toast show align-items-center text-white bg-${D} border-0`,role:"alert"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("div",{className:"toast-body"},_),be&&typeof te=="function"&&React.createElement("button",{type:"button",className:"btn btn-sm btn-light toast-action",onClick:()=>{try{te()}finally{L()}}},be),React.createElement("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto",onClick:L})))}function Loading({show:_}){return _?React.createElement("div",{className:"loading-overlay"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"3rem",height:"3rem"}},React.createElement("span",{className:"visually-hidden"},"\u0110ang t\u1EA3i..."))):null}function AdminDrawer({open:_,title:D,subtitle:L,onClose:be,footer:te,children:X}){return useEffect(()=>{if(!_)return;const q=Oe=>{Oe.key==="Escape"&&(Oe.preventDefault(),typeof be=="function"&&be())};return document.addEventListener("keydown",q),()=>document.removeEventListener("keydown",q)},[_,be]),_?React.createElement("div",{className:`admin-drawer-root ${_?"open":""}`,role:"dialog","aria-modal":"true"},React.createElement("div",{className:"admin-drawer-backdrop",onClick:be,"aria-hidden":"true"}),React.createElement("aside",{className:"admin-drawer-panel"},React.createElement("div",{className:"admin-drawer-header"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"admin-drawer-title"},D),L?React.createElement("div",{className:"admin-drawer-subtitle"},L):null),React.createElement("button",{type:"button",className:"btn btn-sm btn-light",onClick:be,title:"\u0110\xF3ng","aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"admin-drawer-body"},X),te?React.createElement("div",{className:"admin-drawer-footer"},te):null)):null}const ADMIN_PINS_STORAGE_KEY="ktm_admin_pins_v1",ADMIN_RECENT_STORAGE_KEY="ktm_admin_recent_v1";function loadAdminMenuIdsFromStorage(_){try{const D=localStorage.getItem(_);if(!D)return[];const L=JSON.parse(D);return Array.isArray(L)?L.map(be=>String(be||"").trim()).filter(Boolean):[]}catch(D){return[]}}function saveAdminMenuIdsToStorage(_,D){try{localStorage.setItem(_,JSON.stringify(Array.isArray(D)?D:[]))}catch(L){}}function loadAdminPins(){return loadAdminMenuIdsFromStorage(ADMIN_PINS_STORAGE_KEY)}function saveAdminPins(_){return saveAdminMenuIdsToStorage(ADMIN_PINS_STORAGE_KEY,_),_}function loadAdminRecent(){return loadAdminMenuIdsFromStorage(ADMIN_RECENT_STORAGE_KEY)}function saveAdminRecent(_){return saveAdminMenuIdsToStorage(ADMIN_RECENT_STORAGE_KEY,_),_}function Sidebar({activeMenu:_,onMenuChange:D,onLogout:L,currentUser:be,pinnedMenus:te,recentMenus:X,onTogglePin:q}){const Oe=[{id:"search",icon:"fa-search",label:"Tra c\u1EE9u nhanh",highlight:!0},{id:"albums",icon:"fa-images",label:"Qu\u1EA3n l\xFD Album"},{id:"videos",icon:"fa-video",label:"Qu\u1EA3n l\xFD Video"},{id:"products",icon:"fa-box",label:"S\u1EA3n ph\u1EA9m"},{id:"orders",icon:"fa-receipt",label:"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"},{id:"recon",icon:"fa-file-excel",label:"\u0110\u1ED1i so\xE1t Excel"},{id:"stats",icon:"fa-chart-column",label:"Th\u1ED1ng k\xEA"},{id:"settings",icon:"fa-cog",label:"C\xE0i \u0111\u1EB7t"}],Fe=(be==null?void 0:be.username)||(be==null?void 0:be.name)||(be==null?void 0:be.email)||"Admin",we=useMemo(()=>{const Ee=new Map;for(const F of Oe)Ee.set(F.id,F);return Ee},[]),We=Array.isArray(te)?te:[],st=Array.isArray(X)?X:[],Be=We.map(Ee=>we.get(Ee)).filter(Boolean),Xe=st.filter(Ee=>Ee!==_).map(Ee=>we.get(Ee)).filter(Boolean).slice(0,5),ve=Ee=>We.includes(Ee);return React.createElement("div",{className:"sidebar d-none d-md-block"},React.createElement("div",{className:"logo"},React.createElement("i",{className:"fas fa-tractor me-2"})," KTM Admin"),React.createElement("div",{className:"sidebar-user","aria-label":"T\xE0i kho\u1EA3n"},React.createElement("div",{className:"sidebar-user-avatar","aria-hidden":"true"},React.createElement("i",{className:"fas fa-user"})),React.createElement("div",{className:"sidebar-user-meta"},React.createElement("div",{className:"sidebar-user-name"},Fe),React.createElement("div",{className:"sidebar-user-sub"},"Qu\u1EA3n tr\u1ECB"))),React.createElement("nav",{className:"nav flex-column mt-3"},Be.length>0&&React.createElement(React.Fragment,null,React.createElement("div",{className:"sidebar-section-title"},"Pinned"),React.createElement("div",{className:"sidebar-quicklist"},Be.map(Ee=>React.createElement("a",{key:`pin-${Ee.id}`,href:"#",className:`nav-link ${_===Ee.id?"active":""} sidebar-quicklink`,onClick:F=>{F.preventDefault(),D(Ee.id)}},React.createElement("i",{className:`fas ${Ee.icon}`})," ",Ee.label,React.createElement("button",{type:"button",className:"sidebar-pin-btn pinned",onClick:F=>{F.preventDefault(),F.stopPropagation(),q&&q(Ee.id)},title:"B\u1ECF ghim","aria-label":"B\u1ECF ghim"},React.createElement("i",{className:"fas fa-thumbtack"})))))),Xe.length>0&&React.createElement(React.Fragment,null,React.createElement("div",{className:"sidebar-section-title"},"Recent"),React.createElement("div",{className:"sidebar-quicklist"},Xe.map(Ee=>React.createElement("a",{key:`recent-${Ee.id}`,href:"#",className:`nav-link ${_===Ee.id?"active":""} sidebar-quicklink`,onClick:F=>{F.preventDefault(),D(Ee.id)}},React.createElement("i",{className:`fas ${Ee.icon}`})," ",Ee.label)))),React.createElement("div",{className:"sidebar-section-title"},"Menu"),Oe.map(Ee=>React.createElement("a",{key:Ee.id,href:"#",className:`nav-link ${_===Ee.id?"active":""} ${Ee.disabled?"opacity-50":""} ${Ee.highlight?"text-warning":""}`,onClick:F=>{F.preventDefault(),Ee.disabled||D(Ee.id)}},React.createElement("i",{className:`fas ${Ee.icon}`})," ",Ee.label,Ee.disabled&&React.createElement("span",{className:"badge bg-secondary ms-2"},"Soon"),Ee.highlight&&React.createElement("span",{className:"badge bg-warning text-dark ms-2"},"HOT"),React.createElement("button",{type:"button",className:`sidebar-pin-btn ${ve(Ee.id)?"pinned":""}`,onClick:F=>{F.preventDefault(),F.stopPropagation(),q&&q(Ee.id)},title:ve(Ee.id)?"B\u1ECF ghim":"Ghim","aria-label":ve(Ee.id)?"B\u1ECF ghim":"Ghim"},React.createElement("i",{className:"fas fa-thumbtack"}))))),React.createElement("div",{className:"position-absolute bottom-0 w-100 p-3 border-top border-secondary"},React.createElement("div",{className:"d-flex justify-content-between align-items-center"},React.createElement("a",{href:"/",className:"text-white-50 text-decoration-none small"},React.createElement("i",{className:"fas fa-home me-1"})," Trang ch\u1EE7"),L&&React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:L,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"})))))}const ADMIN_SETTINGS_STORAGE_KEY="ktm_admin_settings_v1",DEFAULT_SHIP_PERCENT=1.64;function normalizeShipPercent(_){const D=typeof _=="number"?_:parseFloat(String(_!=null?_:"").trim());return Number.isFinite(D)?Math.max(0,Math.min(100,D)):DEFAULT_SHIP_PERCENT}function loadAdminSettings(){var _;try{const D=localStorage.getItem(ADMIN_SETTINGS_STORAGE_KEY);if(!D)return{ship_percent:DEFAULT_SHIP_PERCENT};const L=JSON.parse(D);return{ship_percent:normalizeShipPercent((_=L==null?void 0:L.ship_percent)!=null?_:L==null?void 0:L.shipPercent)}}catch(D){return{ship_percent:DEFAULT_SHIP_PERCENT}}}function saveAdminSettings(_){var D;try{const L={ship_percent:normalizeShipPercent((D=_==null?void 0:_.ship_percent)!=null?D:_==null?void 0:_.shipPercent)};return localStorage.setItem(ADMIN_SETTINGS_STORAGE_KEY,JSON.stringify(L)),L}catch(L){return{ship_percent:DEFAULT_SHIP_PERCENT}}}async function fetchAdminSettingsFromServer(){var D;const _=await window.KTM.api.getJSON(`${API_BASE}/api/settings`,"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t t\u1EEB DB");return{ship_percent:normalizeShipPercent((D=_==null?void 0:_.ship_percent)!=null?D:_==null?void 0:_.shipPercent)}}async function saveAdminSettingsToServer(_){var be,te,X;const D={ship_percent:normalizeShipPercent((be=_==null?void 0:_.ship_percent)!=null?be:_==null?void 0:_.shipPercent)},L=await window.KTM.api.putJSON(`${API_BASE}/api/settings`,D,"Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t v\xE0o DB");return{ship_percent:normalizeShipPercent((X=(te=L==null?void 0:L.ship_percent)!=null?te:L==null?void 0:L.shipPercent)!=null?X:D.ship_percent)}}function AlbumList({albums:_,onSelect:D,onCreate:L,onEdit:be,onDelete:te,loading:X,currentFolder:q,onBack:Oe,breadcrumb:Fe}){return React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},q&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:Oe},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),q?q.title:"Th\u01B0 vi\u1EC7n \u1EA3nh")),React.createElement("button",{className:"btn btn-warning",onClick:L},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder")),Fe&&Fe.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:we=>{we.preventDefault(),Oe("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),Fe.map((we,We)=>React.createElement("li",{key:we.id,className:`breadcrumb-item ${We===Fe.length-1?"active":""}`},We===Fe.length-1?we.title:React.createElement("a",{href:"#",onClick:st=>{st.preventDefault(),Oe(we)},className:"text-warning"},we.title))))),X?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):_.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},q?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder n\xE0o. H\xE3y t\u1EA1o folder \u0111\u1EA7u ti\xEAn!")):React.createElement("div",{className:"row g-3"},_.map(we=>React.createElement("div",{key:we.uuid||we.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card album-card h-100",onClick:()=>D(we)},we.cover?React.createElement("img",{src:we.cover,className:"album-cover",alt:we.title}):React.createElement("div",{className:"card-body text-center py-4"},React.createElement("i",{className:"fas fa-folder fa-3x text-warning mb-2"})),React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"card-title mb-1"},we.title),React.createElement("small",{className:"text-muted"},we.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),we.subfolderCount),we.subfolderCount>0&&we.count>0&&" \u2022 ",we.count>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-image me-1"}),we.count),we.subfolderCount===0&&we.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-2",onClick:We=>{We.stopPropagation(),be(we)},title:"S\u1EEDa album"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:We=>{We.stopPropagation(),te(we)},title:"X\xF3a album"},React.createElement("i",{className:"fas fa-trash"}))))))))}function AlbumModal({show:_,album:D,onClose:L,onSave:be,parentId:te}){const[X,q]=useState({slug:"",title:"",description:"",cover_url:"",parent_id:null}),[Oe,Fe]=useState(!1),[we,We]=useState(!1),st=useRef(null);useEffect(()=>{q(D?{slug:D.id||"",title:D.title||"",description:D.description||"",cover_url:D.cover||"",parent_id:D.parentId||null}:{slug:"",title:"",description:"",cover_url:"",parent_id:te||null})},[D,_,te]);const Be=async F=>{F.preventDefault(),Fe(!0),await be(X),Fe(!1)},Xe=F=>F.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),ve=async F=>{const St=F.type==="image/heic"||F.type==="image/heif"||/\.heic$/i.test(F.name);if(F.size<=2097152&&!St)return F;try{const Ct=await createImageBitmap(F),Ve=document.createElement("canvas");let at=Ct.width,Re=Ct.height;const yt=800;return(at>yt||Re>yt)&&(at>Re?(Re=Math.round(Re/at*yt),at=yt):(at=Math.round(at/Re*yt),Re=yt)),Ve.width=at,Ve.height=Re,Ve.getContext("2d").drawImage(Ct,0,0,at,Re),Ct.close(),new Promise((an,et)=>{Ve.toBlob(Pt=>{Pt?an(new File([Pt],F.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):et(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(Ct){throw console.error("Compress cover error:",Ct),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},Ee=async F=>{var Ct;const ht=F.target.files[0];if(!ht)return;if(!(ht.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(ht.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}We(!0);try{const Ve=await ve(ht),at=await window.KTM.cloudinary.uploadImage({file:Ve,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-albums/covers"});if(!at.secure_url)throw console.error("Cloudinary error:",at),new Error(((Ct=at.error)==null?void 0:Ct.message)||"Upload failed");q(Re=>({...Re,cover_url:at.secure_url}))}catch(Ve){console.error("Cover upload error:",Ve),alert("L\u1ED7i upload \u1EA3nh b\xECa: "+Ve.message)}We(!1),F.target.value=""};return _?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},D?"S\u1EEDa":"T\u1EA1o"," Folder"),React.createElement("button",{type:"button",className:"btn-close",onClick:L})),React.createElement("form",{onSubmit:Be},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:X.title,onChange:F=>q({...X,title:F.target.value,slug:X.slug||Xe(F.target.value)}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Slug (URL) *"),React.createElement("input",{type:"text",className:"form-control",value:X.slug,onChange:F=>q({...X,slug:F.target.value}),required:!0,disabled:!!D}),React.createElement("small",{className:"text-muted"},"VD: may-cay-kubota-l1501")),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:X.description,onChange:F=>q({...X,description:F.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex gap-2 align-items-start"},X.cover_url&&React.createElement("div",{className:"position-relative",style:{width:80,height:80}},React.createElement("img",{src:X.cover_url,alt:"Cover",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:8}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute",style:{top:-8,right:-8,padding:"2px 6px",fontSize:10},onClick:()=>q(F=>({...F,cover_url:""}))},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{ref:st,type:"file",accept:"image/*",className:"d-none",onChange:Ee}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100 mb-2",onClick:()=>{var F;return(F=st.current)==null?void 0:F.click()},disabled:we},we?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh b\xECa")),React.createElement("input",{type:"url",className:"form-control form-control-sm",value:X.cover_url,onChange:F=>q({...X,cover_url:F.target.value}),placeholder:"Ho\u1EB7c d\xE1n URL \u1EA3nh..."}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:L},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:Oe||we},Oe?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function FolderTreeItem({folder:_,allAlbums:D,currentAlbumId:L,targetAlbum:be,onSelect:te,level:X=0}){const[q,Oe]=useState(!0),Fe=_.uuid||_.id,we=Fe===L,We=be===Fe,st=D.filter(Xe=>Xe.parentId===Fe),Be=st.length>0;return React.createElement("div",{style:{marginLeft:X*16+"px"}},React.createElement("div",{className:`d-flex align-items-center p-2 rounded mb-1 ${We?"bg-info text-white":we?"bg-light text-muted":"hover-bg"}`,style:{cursor:we?"not-allowed":"pointer",opacity:we?.5:1,transition:"background 0.2s"},onClick:()=>!we&&te(Fe)},Be&&React.createElement("i",{className:`fas fa-chevron-${q?"down":"right"} me-2`,style:{fontSize:"10px",width:"12px",cursor:"pointer"},onClick:Xe=>{Xe.stopPropagation(),Oe(!q)}}),!Be&&React.createElement("span",{style:{width:"20px"}}),React.createElement("i",{className:`fas fa-folder${We?"-open":""} me-2 ${We?"":"text-warning"}`}),React.createElement("span",{className:"small"},_.title),we&&React.createElement("span",{className:"ms-2 badge bg-secondary",style:{fontSize:"9px"}},"Hi\u1EC7n t\u1EA1i"),_.count>0&&!we&&React.createElement("span",{className:"ms-auto badge bg-light text-muted",style:{fontSize:"10px"}},_.count)),q&&Be&&React.createElement("div",null,st.map(Xe=>React.createElement(FolderTreeItem,{key:Xe.uuid||Xe.id,folder:Xe,allAlbums:D,currentAlbumId:L,targetAlbum:be,onSelect:te,level:X+1}))))}function AlbumDetail({album:_,onBack:D,onRefresh:L,showToast:be,onNavigateToFolder:te,onEditSubfolder:X,parentAlbum:q}){const[Oe,Fe]=useState([]),[we,We]=useState([]),[st,Be]=useState(!0),[Xe,ve]=useState(!1),[Ee,F]=useState(""),[ht,St]=useState([]),[Ct,Ve]=useState([]),[at,Re]=useState({}),[yt,Et]=useState(null),[an,et]=useState(!1),[Pt,Xt]=useState(""),[C,S]=useState(!1),B=useRef(null),fe=useRef(null),[ge,oe]=useState(!1),[le,Te]=useState([]),[N,j]=useState([]),[J,ae]=useState(""),[$e,ke]=useState(!1),Ze=async(P,m=2)=>{const z=m*1024*1024,Z=P.type==="image/heic"||P.type==="image/heif"||/\.heic$/i.test(P.name);if(P.size<=z&&!Z)return P;try{const Ke=await createImageBitmap(P),Pe=document.createElement("canvas");let Ge=Ke.width,vt=Ke.height;const nt=1200;return(Ge>nt||vt>nt)&&(Ge>vt?(vt=Math.round(vt/Ge*nt),Ge=nt):(Ge=Math.round(Ge/vt*nt),vt=nt)),Pe.width=Ge,Pe.height=vt,Pe.getContext("2d").drawImage(Ke,0,0,Ge,vt),Ke.close(),new Promise((Wt,sn)=>{Pe.toBlob(fn=>{fn?Wt(new File([fn],P.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):sn(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(Ke){throw console.error("Compress error:",Ke),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh")}};useEffect(()=>{Je(),At()},[_.id,_.uuid]);const Je=async()=>{Be(!0);try{const P=await window.KTM.api.getJSON(`${API_BASE}/api/albums/${_.uuid||_.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");Fe(P.images||[]);const m=await window.KTM.api.getJSON(`${API_BASE}/api/albums?parent_id=${_.uuid||_.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");We(Array.isArray(m)?m:[])}catch(P){console.error(P),be("L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u","danger")}Be(!1)},At=async()=>{try{const P=await window.KTM.api.getJSON(`${API_BASE}/api/albums`,"L\u1ED7i t\u1EA3i album");j(Array.isArray(P)?P:[])}catch(P){console.error("Error loading albums:",P)}},Kt=P=>{Te(m=>m.includes(P)?m.filter(z=>z!==P):[...m,P])},Me=async()=>{if(!J||le.length===0){be("Vui l\xF2ng ch\u1ECDn folder \u0111\xEDch","warning");return}ke(!0);let P=0;for(const m of le)try{await window.KTM.api.putJSON(`${API_BASE}/api/images/${m}`,{album_id:J},"L\u1ED7i di chuy\u1EC3n \u1EA3nh"),P++}catch(z){console.error("Move error:",z)}ke(!1),oe(!1),Te([]),ae(""),P>0?(be("\u0110\xE3 di chuy\u1EC3n \u1EA3nh th\xE0nh c\xF4ng!","success"),Je(),L()):be("Di chuy\u1EC3n th\u1EA5t b\u1EA1i","danger")},[ct,en]=useState(!1),_t=async()=>{if(le.length===0||!confirm(`X\xF3a ${le.length} \u1EA3nh \u0111\xE3 ch\u1ECDn? H\xE0nh \u0111\u1ED9ng n\xE0y kh\xF4ng th\u1EC3 ho\xE0n t\xE1c!`))return;en(!0);let P=0;for(const m of le)try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${m}`,"L\u1ED7i x\xF3a \u1EA3nh"),P++}catch(z){console.error("Delete error:",z)}en(!1),Te([]),P>0?(be(`\u0110\xE3 x\xF3a ${P} \u1EA3nh!`,"success"),Je(),L()):be("X\xF3a th\u1EA5t b\u1EA1i","danger")},ln=()=>{le.length===Oe.length?Te([]):Te(Oe.map(P=>P.id))},Ft=async()=>{if(Pt.trim()){S(!0);try{const P=Pt.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");await window.KTM.api.postJSON(`${API_BASE}/api/albums`,{slug:P+"-"+Date.now(),title:Pt,parent_id:_.uuid||_.id},"L\u1ED7i t\u1EA1o folder"),be("T\u1EA1o folder th\xE0nh c\xF4ng!","success"),Xt(""),et(!1),Je(),L()}catch(P){be(P.message,"danger")}S(!1)}},pn=async P=>{if(confirm(`X\xF3a folder "${P.title}"? T\u1EA5t c\u1EA3 n\u1ED9i dung b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${P.uuid||P.id}`,"L\u1ED7i x\xF3a folder"),be("\u0110\xE3 x\xF3a folder","success"),Je(),L()}catch(m){be("L\u1ED7i x\xF3a folder","danger")}},bn=P=>{const m=Array.from(P).filter(z=>z.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(z.name));St(z=>[...z,...m]),m.forEach(z=>{const Z=new FileReader;Z.onload=Ke=>{Ve(Pe=>[...Pe,{file:z,preview:Ke.target.result}])},Z.readAsDataURL(z)})},$=P=>{St(m=>m.filter((z,Z)=>Z!==P)),Ve(m=>m.filter((z,Z)=>Z!==P))},ne=async P=>{var z;const m=await window.KTM.cloudinary.uploadImage({file:P,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:`ktm-albums/${_.id}`});if(!m.secure_url)throw console.error("Cloudinary error:",m),new Error(((z=m.error)==null?void 0:z.message)||"Upload failed");return m},tt=async()=>{if(ht.length===0)return;ve(!0);let P=0;for(let m=0;m<ht.length;m++)try{F(`\u0110ang x\u1EED l\xFD ${m+1}/${ht.length}...`);const z=await Ze(ht[m],2);F(`\u0110ang upload ${m+1}/${ht.length}...`);const Z=await ne(z);await window.KTM.api.postJSON(`${API_BASE}/api/albums/${_.id}`,{url:Z.secure_url,caption:at[m]||ht[m].name.replace(/\.[^/.]+$/,""),sort_order:Oe.length+m},"L\u1ED7i l\u01B0u \u1EA3nh"),P++}catch(z){console.error("Upload error:",z)}ve(!1),F(""),St([]),Ve([]),Re({}),P>0?(be(`\u0110\xE3 upload ${P} \u1EA3nh th\xE0nh c\xF4ng!`,"success"),Je(),L()):be("Upload th\u1EA5t b\u1EA1i","danger")},Bt=async(P,m)=>{if(confirm("X\xF3a \u1EA3nh n\xE0y?"))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${P}`,"L\u1ED7i x\xF3a \u1EA3nh"),be("\u0110\xE3 x\xF3a \u1EA3nh","success"),Je(),L()}catch(z){be("L\u1ED7i x\xF3a \u1EA3nh","danger")}},hn=P=>{var m;P.preventDefault(),(m=fe.current)==null||m.classList.add("dragover")},Vt=()=>{var P;(P=fe.current)==null||P.classList.remove("dragover")},Ut=P=>{var m;P.preventDefault(),(m=fe.current)==null||m.classList.remove("dragover"),bn(P.dataTransfer.files)};return React.createElement("div",null,React.createElement("div",{className:"d-flex align-items-center justify-content-between mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:D},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("h4",{className:"m-0"},_.title),React.createElement("small",{className:"text-muted"},we.length>0&&React.createElement("span",null,we.length," folder \u2022 "),Oe.length," \u1EA3nh"))),React.createElement("button",{className:"btn btn-outline-warning btn-sm",onClick:()=>et(!0)},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder con")),an&&React.createElement("div",{className:"card mb-4 border-warning"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder-plus me-2 text-warning"}),"T\u1EA1o folder con"),React.createElement("div",{className:"d-flex gap-2"},React.createElement("input",{type:"text",className:"form-control",placeholder:"T\xEAn folder...",value:Pt,onChange:P=>Xt(P.target.value),onKeyPress:P=>P.key==="Enter"&&Ft(),autoFocus:!0}),React.createElement("button",{className:"btn btn-warning",onClick:Ft,disabled:C||!Pt.trim()},C?React.createElement("span",{className:"spinner-border spinner-border-sm"}):"T\u1EA1o"),React.createElement("button",{className:"btn btn-secondary",onClick:()=>{et(!1),Xt("")}},"H\u1EE7y")))),we.length>0&&React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),"Folder con"),React.createElement("div",{className:"row g-2"},we.map(P=>React.createElement("div",{key:P.uuid||P.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-item",style:{cursor:"pointer"},onClick:()=>te&&te(P)},React.createElement("div",{className:"card-body text-center py-3"},React.createElement("i",{className:"fas fa-folder fa-2x text-warning mb-2"}),React.createElement("div",{className:"small fw-bold text-truncate"},P.title),React.createElement("small",{className:"text-muted"},P.subfolderCount>0&&React.createElement("span",null,P.subfolderCount," folder"),P.subfolderCount>0&&P.count>0&&" \u2022 ",P.count>0&&React.createElement("span",null,P.count," \u1EA3nh"),P.subfolderCount===0&&P.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0 text-center"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-1",onClick:m=>{m.stopPropagation(),X&&X(P)},title:"S\u1EEDa folder"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:m=>{m.stopPropagation(),pn(P)},title:"X\xF3a folder"},React.createElement("i",{className:"fas fa-trash"}))))))))),React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-cloud-upload-alt me-2"}),"Upload \u1EA3nh m\u1EDBi"),React.createElement("div",{ref:fe,className:"upload-zone",onClick:()=>{var P;return(P=B.current)==null?void 0:P.click()},onDragOver:hn,onDragLeave:Vt,onDrop:Ut},React.createElement("i",{className:"fas fa-images fa-2x text-muted mb-2"}),React.createElement("p",{className:"mb-0"},"K\xE9o th\u1EA3 \u1EA3nh v\xE0o \u0111\xE2y ho\u1EB7c click \u0111\u1EC3 ch\u1ECDn"),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3 JPG, PNG, WebP"),React.createElement("input",{ref:B,type:"file",multiple:!0,accept:"image/*",onChange:P=>bn(P.target.files)})),Ct.length>0&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"upload-preview"},Ct.map((P,m)=>React.createElement("div",{key:m,className:"upload-preview-item"},React.createElement("img",{src:P.preview,alt:""}),React.createElement("button",{className:"remove",onClick:()=>$(m)},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("div",{className:"mt-3"},React.createElement("button",{className:"btn btn-warning",onClick:tt,disabled:Xe},Xe?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),Ee||"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload ",ht.length," \u1EA3nh")))))),React.createElement("div",{className:"card"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("h6",{className:"m-0"},React.createElement("i",{className:"fas fa-th me-2"}),"\u1EA2nh (",Oe.length,")"),Oe.length>0&&React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:ln},le.length===Oe.length?"B\u1ECF ch\u1ECDn":"Ch\u1ECDn t\u1EA5t c\u1EA3")),le.length>0&&React.createElement("div",{className:"d-flex align-items-center gap-2 flex-wrap"},React.createElement("span",{className:"badge bg-primary"},le.length," \u0111\xE3 ch\u1ECDn"),React.createElement("button",{className:"btn btn-sm btn-info",onClick:()=>oe(!0)},React.createElement("i",{className:"fas fa-folder-open me-1"}),"Di chuy\u1EC3n"),React.createElement("button",{className:"btn btn-sm btn-danger",onClick:_t,disabled:ct},ct?React.createElement("span",{className:"spinner-border spinner-border-sm"}):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-trash me-1"}),"X\xF3a")),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>Te([])},React.createElement("i",{className:"fas fa-times"})))),st?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):Oe.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},React.createElement("i",{className:"fas fa-image fa-2x mb-2"}),React.createElement("p",null,"Ch\u01B0a c\xF3 \u1EA3nh n\xE0o trong album n\xE0y")):React.createElement("div",{className:"image-grid"},Oe.map((P,m)=>React.createElement("div",{key:m,className:`image-item ${le.includes(P.id)?"selected":""}`,style:{position:"relative",cursor:"pointer"},onClick:()=>Kt(P.id)},React.createElement("div",{className:"select-checkbox",style:{position:"absolute",top:"6px",left:"6px",zIndex:10,width:"24px",height:"24px",borderRadius:"4px",background:le.includes(P.id)?"#0d6efd":"rgba(255,255,255,0.9)",border:le.includes(P.id)?"none":"2px solid #ccc",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"}},le.includes(P.id)&&React.createElement("i",{className:"fas fa-check",style:{color:"#fff",fontSize:"12px"}})),React.createElement("img",{src:P.src,alt:P.caption,style:{opacity:le.includes(P.id)?.7:1,border:le.includes(P.id)?"3px solid #0d6efd":"none",borderRadius:"8px"}}),React.createElement("div",{className:"actions"},React.createElement("button",{className:"btn btn-sm btn-danger",onClick:z=>{z.stopPropagation(),Bt(P.id,m)},title:"X\xF3a \u1EA3nh"},React.createElement("i",{className:"fas fa-trash"}))),P.caption&&React.createElement("div",{className:"p-2 bg-light small text-truncate"},P.caption)))))),ge&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header bg-info text-white"},React.createElement("h5",{className:"modal-title"},React.createElement("i",{className:"fas fa-folder-open me-2"}),"Di chuy\u1EC3n ",le.length," \u1EA3nh"),React.createElement("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>oe(!1)})),React.createElement("div",{className:"modal-body",style:{maxHeight:"400px",overflowY:"auto"}},React.createElement("p",{className:"text-muted small mb-3"},"Ch\u1ECDn th\u01B0 m\u1EE5c \u0111\xEDch:"),React.createElement("div",{className:"folder-tree"},N.filter(P=>!P.parentId).map(P=>React.createElement(FolderTreeItem,{key:P.uuid||P.id,folder:P,allAlbums:N,currentAlbumId:_.uuid||_.id,targetAlbum:J,onSelect:ae})))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>oe(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-info",onClick:Me,disabled:!J||$e},$e?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang chuy\u1EC3n..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-1"}),"Di chuy\u1EC3n \u0111\u1EBFn \u0111\xE2y")))))),yt&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.9)"},onClick:()=>Et(null)},React.createElement("div",{className:"modal-dialog modal-fullscreen d-flex align-items-center justify-content-center"},React.createElement("div",{className:"position-relative",style:{maxWidth:"95vw",maxHeight:"95vh"}},React.createElement("button",{className:"btn btn-light position-absolute",style:{top:"-50px",right:"0",borderRadius:"50%",width:"40px",height:"40px"},onClick:()=>Et(null)},React.createElement("i",{className:"fas fa-times"})),React.createElement("img",{src:yt.src,alt:yt.caption,style:{maxWidth:"95vw",maxHeight:"90vh",objectFit:"contain"},onClick:P=>P.stopPropagation()}),yt.caption&&React.createElement("div",{className:"text-white text-center mt-2"},yt.caption)))))}function SearchCenter({showToast:_,onNavigate:D}){const[L,be]=useState(""),[te,X]=useState([]),[q,Oe]=useState([]),[Fe,we]=useState([]),[We,st]=useState("all"),[Be,Xe]=useState(null),[ve,Ee]=useState("list"),[F,ht]=useState(!0),[St,Ct]=useState([]),[Ve,at]=useState([]),Re=useRef(null),[yt,Et]=useState(!0),[an,et]=useState(!1),Pt=useRef(null),Xt=useRef(null),C=useRef(null),[S,B]=useState(!1),[fe,ge]=useState([]),[oe,le]=useState([]),[Te,N]=useState(""),j=useRef(null),J=useRef(new Map),[ae,$e]=useState("auto"),[ke,Ze]=useState({start:0,end:20}),[Je,At]=useState(!1),[Kt,Me]=useState([{role:"assistant",content:`Xin ch\xE0o! H\xE3y h\u1ECFi t\xF4i v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3... V\xED d\u1EE5:
\u2022 "Gi\xE1 van 2 tay?"
\u2022 "Combo r\u1EBB nh\u1EA5t?"
\u2022 "Freeship?"`,attachments:[]}]),[ct,en]=useState(""),[_t,ln]=useState(!1),Ft=useRef(null),pn=useRef(null),bn=s=>s?String(s).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").trim():"",$=s=>s?String(s).replace(/\s+/g,"").replace(/[-()]/g,"").replace(/^\+84/,"0").trim():"",ne=(s,p)=>{if(!s||!p)return s;const l=new RegExp(`(${p.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return s.replace(l,'<mark style="background:#ffeb3b">$1</mark>')};useEffect(()=>{try{const s=JSON.parse(localStorage.getItem("ktm_search_history")||"[]"),p=JSON.parse(localStorage.getItem("ktm_saved_searches")||"[]");ge(Array.isArray(s)?s.slice(0,10):[]),le(Array.isArray(p)?p:[])}catch(s){}},[]);const tt=s=>{if(!s.trim())return;const p=[s,...fe.filter(l=>l!==s)].slice(0,10);ge(p);try{localStorage.setItem("ktm_search_history",JSON.stringify(p))}catch(l){}},Bt=s=>{if(!s.trim())return;const p=oe.includes(s)?oe.filter(l=>l!==s):[s,...oe].slice(0,5);le(p);try{localStorage.setItem("ktm_saved_searches",JSON.stringify(p))}catch(l){}},hn="ktm_search_query_stats_v1",Vt="ktm_search_product_stats_v1",Ut=(s,p)=>{try{const l=localStorage.getItem(s);if(!l)return p;const O=JSON.parse(l);return O!=null?O:p}catch(l){return p}},P=(s,p)=>{try{localStorage.setItem(s,JSON.stringify(p))}catch(l){}},[m,z]=useState(()=>Ut(hn,{})),[Z,Ke]=useState(()=>Ut(Vt,{})),Pe=useRef(!1),Ge=useRef(new Map);useEffect(()=>{const s=p=>{p&&(p.key===hn&&z(Ut(hn,{})),p.key===Vt&&Ke(Ut(Vt,{})))};return window.addEventListener("storage",s),()=>window.removeEventListener("storage",s)},[]);const vt=s=>{const p=String(s||"").trim();if(!p)return;const l=Ne(p).trim();if(l.length<3||l==="sdt:"||l==="#"||l.endsWith(":"))return;const O=Date.now(),W=Ut(hn,m&&typeof m=="object"?m:{}),K={...W&&typeof W=="object"?W:{}},w=K[l]&&typeof K[l]=="object"?K[l]:{};K[l]={q:p,count:(Number(w.count)||0)+1,lastAt:O},z(K),P(hn,K)},nt=(s,p)=>{if(!s||s._type!=="product")return;const l=String(s.id||"").trim();if(!l)return;const O=Date.now(),W=Ut(Vt,Z&&typeof Z=="object"?Z:{}),K={...W&&typeof W=="object"?W:{}},w=K[l]&&typeof K[l]=="object"?K[l]:{};K[l]={id:l,name:String(s.name||w.name||"").trim(),code:String(s.code||w.code||"").trim(),count:(Number(w.count)||0)+1,lastAt:O,action:String(p||w.action||"").trim()},Ke(K),P(Vt,K)},dn=(s,p)=>{const l=String(s||"").trim();if(!l)return;const O=Ne(l).trim();if(O.length<3||O==="sdt:"||O==="#"||O.endsWith(":"))return;const W=Date.now(),K=Number(Ge.current.get(O)||0);if(W-K<3e4)return;const Y=(Array.isArray(p)?p:[]).find(de=>de&&de._type==="product");Y&&(Ge.current.set(O,W),nt(Y,"search"))},Wt=useMemo(()=>Object.values(m&&typeof m=="object"?m:{}).map(l=>({q:String((l==null?void 0:l.q)||"").trim(),count:Number(l==null?void 0:l.count)||0,lastAt:Number(l==null?void 0:l.lastAt)||0})).filter(l=>l.q&&l.count>0).sort((l,O)=>O.count-l.count||O.lastAt-l.lastAt).slice(0,6),[m]),sn=useMemo(()=>Object.values(Z&&typeof Z=="object"?Z:{}).map(l=>({id:String((l==null?void 0:l.id)||"").trim(),name:String((l==null?void 0:l.name)||"").trim(),code:String((l==null?void 0:l.code)||"").trim(),count:Number(l==null?void 0:l.count)||0,lastAt:Number(l==null?void 0:l.lastAt)||0})).filter(l=>l.id&&l.count>0).sort((l,O)=>O.count-l.count||O.lastAt-l.lastAt).slice(0,8).map(l=>{const O=q.find(W=>W&&W._type==="product"&&String(W.id)===l.id);return O?{...l,item:O}:{...l,item:null}}),[Z,q]),fn=(s,p={})=>{const l=String(s||"");gt(l),p.addToHistory!==!1&&tt(l),B(!1),Yt(!1),x(!1),p.focus!==!1?(Pe.current=!0,setTimeout(()=>{var K;const W=Re.current;(K=W==null?void 0:W.focus)==null||K.call(W);try{if(p.caret==="end"&&W&&typeof W.setSelectionRange=="function"){const w=String(W.value||"").length;W.setSelectionRange(w,w)}}catch(w){}},0)):(Pe.current=!1,setTimeout(()=>{var W,K,w,Y;try{(K=(W=Re.current)==null?void 0:W.blur)==null||K.call(W),(Y=(w=document.activeElement)==null?void 0:w.blur)==null||Y.call(w)}catch(de){}},0))},[rt,mn]=useState(null),[_n,yn]=useState(!1),[ut,i]=useState(null),[c,x]=useState(!1),[g,A]=useState(!1),[H,E]=useState(null),[h,k]=useState({name:"",code:"",price:"",image:"",category:"",note:"",commission_percent:""}),T=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"],V=s=>{var p,l;s._type==="product"&&(i(s),k({name:s.name||"",code:s.code||"",price:s.price||"",image:s.image||"",category:s.category||"",note:s.note||"",commission_percent:(l=(p=s.commission_percent)!=null?p:s.commissionPercent)!=null?l:""}),yn(!0))},se=async()=>{if(ut)try{await window.KTM.api.putJSON(`${API_BASE}/api/products?id=${ut.id}`,h,"L\u1ED7i c\u1EADp nh\u1EADt"),_("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),yn(!1),i(null),Ue()}catch(s){_(s.message,"danger")}},xe=async s=>{const p=s._type==="product"?"s\u1EA3n ph\u1EA9m":s._type==="album"?"\u1EA3nh":"video";if(confirm(`X\xF3a ${p} "${s.name}"?`))try{let l="";s._type==="product"?l=`${API_BASE}/api/products?id=${s.id}`:s._type==="album"?l=`${API_BASE}/api/images/${s.id}`:s._type==="video"&&(l=`${API_BASE}/api/videos/${s.id}`),await window.KTM.api.deleteJSON(l,"L\u1ED7i x\xF3a"),_(`\u0110\xE3 x\xF3a ${p}`,"success"),Ue()}catch(l){_(l.message,"danger")}},me=async s=>{try{const p=H?`${API_BASE}/api/products?id=${H.id}`:`${API_BASE}/api/products`;H?await window.KTM.api.putJSON(p,s,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(p,s,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),_(H?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),A(!1),E(null),Ue()}catch(p){_(p.message,"danger")}},Ae="ktm_admin_data_cache_v1",Ie=1e3*60*10,Ue=async()=>{let s=null,p=!1;const l=window.KTM.cache.read(Ae,{ttlMs:Ie,validate:Array.isArray});l.hit?(s=l.value,console.log("[CACHE] Using cache, items:",s.length),Oe(s),X(s),ht(!1),p=!0):l.status==="miss"?console.log("[CACHE] No cache found"):l.status==="expired"||l.status==="invalid"?console.log("[CACHE] Cache expired or invalid"):l.status==="error"&&console.error("[CACHE] Error parsing cache"),p||ht(!0);try{const O=async(Qe,f)=>{try{const ye=await window.KTM.api.getJSON(Qe,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");return ye!=null?ye:f}catch(ye){return f}},[W,K,w]=await Promise.all([O(`${API_BASE}/api/products?fields=search`,[]),O(`${API_BASE}/api/albums`,[]),O(`${API_BASE}/api/video-folders?withVideos=true`,[])]),Y=Array.isArray(W)?W.map(Qe=>({...Qe,_type:"product",_source:"database"})):[];Ct(K);let de=[];Array.isArray(K)&&K.length>0&&(await Promise.all(K.map(f=>O(`${API_BASE}/api/albums/${f.id}`,{})))).forEach((f,ye)=>{const Tt=K[ye];f.images&&f.images.length>0&&f.images.forEach($t=>{de.push({id:$t.id,name:$t.caption||"\u1EA2nh t\u1EEB "+Tt.title,image:$t.src,folder:Tt.title,_type:"album",_source:"database"})})}),at(w);let Q=[];Array.isArray(w)&&w.forEach(Qe=>{Qe.videos&&Qe.videos.forEach(f=>{Q.push({id:f.id,name:f.title,folder:Qe.name,image:f.thumb,youtubeId:f.youtubeId,url:f.url,_type:"video",_source:"database"})})});const re=[...Y,...de,...Q];(!s||JSON.stringify(re)!==JSON.stringify(s))&&(Oe(re),X(re),window.KTM.cache.write(Ae,re))}catch(O){console.error("Song song fetch error:",O)}ht(!1)};useEffect(()=>{Ue(),setTimeout(()=>{var p;return(p=Re.current)==null?void 0:p.focus()},100);const s=p=>{var l,O;(p.ctrlKey||p.metaKey)&&p.key==="k"&&(p.preventDefault(),B(!0),setTimeout(()=>{var W;return(W=j.current)==null?void 0:W.focus()},0)),p.key==="/"&&!S&&((l=document.activeElement)==null?void 0:l.tagName)!=="INPUT"&&(p.preventDefault(),(O=Re.current)==null||O.focus()),p.key==="Escape"&&S&&B(!1)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[S]);const Ne=s=>{try{return String(s!=null?s:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(p){return String(s!=null?s:"").toLowerCase()}},lt=s=>{const l=Ne(s).trim().split(/\s+/).filter(Boolean).map(de=>{const Q=String(de||"").trim();return Q?Q.startsWith("#")?Q.slice(1):Q.startsWith("sdt:")?Q.slice(4):Q.startsWith("phone:")?Q.slice(6):Q:""}).filter(Boolean),O=l.includes("anh"),W=l.includes("video"),K=l.filter(de=>de!=="anh"&&de!=="video"),w=K.join(" "),Y=new Set(["product"]);return O&&Y.add("album"),W&&Y.add("video"),{allowedTypes:Y,includeAlbum:O,includeVideo:W,contentTokens:K,cleanedQuery:w}},ce=(s,p,l)=>{var ye,Tt,$t,Ot,qt;const O=Array.isArray(p)?p:[],W=Ne(l).trim();if(!O.length&&!W)return 0;const K=Ne((ye=s==null?void 0:s.name)!=null?ye:""),w=Ne((Tt=s==null?void 0:s.code)!=null?Tt:""),Y=Ne(($t=s==null?void 0:s.category)!=null?$t:""),de=Ne((Ot=s==null?void 0:s.note)!=null?Ot:""),Q=Ne((qt=s==null?void 0:s.folder)!=null?qt:"");if(!`${K} ${w} ${Y} ${de} ${Q}`.trim())return 0;const He=K.replace(/\s+/g,""),Qe=W.replace(/\s+/g,"");let f=0;W&&(K===W&&(f+=220),K.includes(W)&&(f+=140),K.startsWith(W)&&(f+=160),Qe&&(He===Qe?f+=280:He.startsWith(Qe)?f+=180:He.includes(Qe)&&(f+=110)),w&&w===W&&(f+=180),w&&w.includes(W)&&(f+=90));for(const Qt of O){if(!Qt)continue;const Ht=new RegExp(`(?:^|\\s)${Qt.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}`),Gt=String(Qt).replace(/\s+/g,"");K.includes(Qt)&&(f+=35),Ht.test(K)&&(f+=25),Gt&&(He===Gt?f+=90:He.startsWith(Gt)?f+=50:He.includes(Gt)&&(f+=28)),w&&w.includes(Qt)&&(f+=20),w&&Ht.test(w)&&(f+=10),Y&&Y.includes(Qt)&&(f+=12),Q&&Q.includes(Qt)&&(f+=12),de&&de.includes(Qt)&&(f+=6)}return f>0&&K&&(f+=Math.max(0,10-Math.min(10,Math.floor(K.length/10)))),f},qe=(s,p,l)=>{const O=Array.isArray(s)?s:[];return O.length?O.map((K,w)=>({it:K,idx:w,score:ce(K,p,l)})).sort((K,w)=>w.score!==K.score?w.score-K.score:K.idx-w.idx).map(K=>K.it):[]},xt=async(s,p)=>{if(!(!yt||p.length===0)){et(!0);try{const l=p.map(W=>({id:W.id,name:W.name,price:W.price,category:W.category,note:W.note,folder:W.folder,_type:W._type})),O=await window.KTM.api.postJSON(`${API_BASE}/api/ai-search`,{query:s,products:l},"AI Search error");if(O&&O.matchedIds&&O.matchedIds.length>0){const{contentTokens:W,cleanedQuery:K}=lt(s),w=new Set(O.matchedIds),Y=p.filter(de=>w.has(de.id)).sort((de,Q)=>ce(Q,W,K)-ce(de,W,K));Y.length>0&&X(Y)}else O&&O.matchedIds&&O.matchedIds.length===0&&X([])}catch(l){console.error("AI Search error:",l)}et(!1)}},gt=s=>{if(be(s),N(s),Xt.current&&clearTimeout(Xt.current),Pt.current&&clearTimeout(Pt.current),C.current&&C.current.abort(),!s.trim()){Nt(We);return}const l=`v2|${Ne(s).trim().replace(/\s+/g,"")}|${We}`;if(J.current.has(l)){X(J.current.get(l));return}const{allowedTypes:O,contentTokens:W,cleanedQuery:K}=lt(s);Xt.current=setTimeout(()=>{const w=q.filter(Q=>{if(!O.has(Q==null?void 0:Q._type))return!1;if(W.length===0)return!0;const re=bn(Object.entries(Q).filter(([ye])=>!ye.startsWith("_")).map(([,ye])=>String(ye||"")).join(" ")),He=Q.phone?$(Q.phone):"",Qe=`${re} ${He}`.trim(),f=Qe.replace(/\s+/g,"");return W.every(ye=>{const Tt=String(ye||"").trim();return Tt?Qe.includes(Tt)||f.includes(Tt.replace(/\s+/g,"")):!0})});let Y=w;We!=="all"&&(Y=w.filter(Q=>(Q==null?void 0:Q._type)===We));const de=qe(Y,W,K);if(vt(s),dn(s,de),J.current.size>20){const Q=J.current.keys().next().value;J.current.delete(Q)}J.current.set(l,de),X(de),yt&&K.length>=3&&(Pt.current=setTimeout(()=>{xt(K,Y)},500))},200)},Nt=s=>{st(s);const{allowedTypes:p,contentTokens:l}=lt(L),{cleanedQuery:O}=lt(L);let W=q.filter(K=>p.has(K==null?void 0:K._type));s!=="all"&&(W=W.filter(K=>(K==null?void 0:K._type)===s)),L.trim()&&l.length>0&&(W=W.filter(K=>{const w=Ne(Object.entries(K).filter(([re])=>!re.startsWith("_")).map(([,re])=>String(re||"")).join(" ")),Y=K.phone?$(K.phone):"",de=`${w} ${Y}`.trim(),Q=de.replace(/\s+/g,"");return l.every(re=>{const He=String(re||"").trim();return He?de.includes(He)||Q.includes(He.replace(/\s+/g,"")):!0})})),X(qe(W,l,O))},Le=(s,p,l)=>{l&&l.item&&nt(l.item,l.action||"copy"),window.KTM.clipboard.writeText(s).then(()=>{Xe(p),_("\u0110\xE3 copy!","success"),setTimeout(()=>Xe(null),1500)})},M=async(s,p,l)=>{try{l&&l.item&&nt(l.item,l.action||"copy_image"),await window.KTM.clipboard.writeImageFromUrl(s),Xe(p+"-img"),_("\u0110\xE3 copy \u1EA3nh!","success"),setTimeout(()=>Xe(null),1500)}catch(O){Le(s,p+"-img",l)}},ie=s=>{let p=s.toLowerCase();const l=[],O=q.filter(w=>w._type==="product");if(p.includes("ty")||p.includes("xy lanh")){if(p.includes("gi\u1EEFa")||p.includes("giua")){const w=O.find(Y=>{var de;return(de=Y.name)==null?void 0:de.toLowerCase().includes("xy lanh gi\u1EEFa")});w&&!l.find(Y=>Y.id===w.id)&&l.push(w)}if(p.includes("nghi\xEAng")||p.includes("nghieng")){const w=O.find(Y=>{var de;return(de=Y.name)==null?void 0:de.toLowerCase().includes("xy lanh nghi\xEAng")});w&&!l.find(Y=>Y.id===w.id)&&l.push(w)}if(p.includes("\u1EE7i")||p.includes("ui")){const w=O.find(Y=>{var de;return(de=Y.name)==null?void 0:de.toLowerCase().includes("xy lanh \u1EE7i")});w&&!l.find(Y=>Y.id===w.id)&&l.push(w)}}const W=p.match(/van\s*(\d+)\s*tay.*?(\d+)\s*ty/);if(W){const w=W[1],Y=W[2],de=O.find(Q=>{var He;const re=((He=Q.name)==null?void 0:He.toLowerCase())||"";return re.includes("combo")&&re.includes(`${w} tay`)&&(re.includes(`${Y} xy`)||re.includes(`${Y} xylanh`))});if(de&&!l.find(Q=>Q.id===de.id))l.push(de);else{const Q=O.find(re=>{var Qe;const He=((Qe=re.name)==null?void 0:Qe.toLowerCase())||"";return He.includes("combo")&&He.includes(`${w} tay`)});Q&&!l.find(re=>re.id===Q.id)&&l.push(Q)}}if(p.includes("combo")&&!W){const w=p.match(/combo.*?(\d+)\s*tay/);if(w){const Y=w[1];O.filter(Q=>{var He;const re=((He=Q.name)==null?void 0:He.toLowerCase())||"";return re.includes("combo")&&re.includes(`${Y} tay`)}).forEach(Q=>{l.find(re=>re.id===Q.id)||l.push(Q)})}}const K=p.match(/van\s*(\d+)\s*tay/);if(K&&!p.includes("ty")&&!p.includes("combo")){const w=K[1],Y=O.find(de=>{var re;const Q=((re=de.name)==null?void 0:re.toLowerCase())||"";return Q.includes(`van ${w} tay`)&&!Q.includes("combo")});Y&&!l.find(de=>de.id===Y.id)&&l.push(Y)}return l.slice(0,4)},ze=async s=>{if(!s.trim())return;const p={role:"user",content:s,attachments:[]};Me(O=>[...O,p]),en(""),ln(!0);const l=ie(s);setTimeout(()=>{var O;return(O=Ft.current)==null?void 0:O.scrollIntoView({behavior:"smooth"})},100);try{const W=q.filter(re=>re._type==="product").map(re=>{let He=`- ${re.name}`;return re.code&&(He+=` (M\xE3: ${re.code})`),re.price&&(He+=` - Gi\xE1: ${re.price.replace(/[đ\s]/g,"")}\u0111`),re.category&&(He+=` [${re.category}]`),re.note&&(He+=` (${re.note})`),He}).join(`
`),w=Kt.slice(-6).map(re=>`${re.role==="user"?"Kh\xE1ch":"AI"}: ${re.content}`).join(`
`),Y=w?`L\u1ECACH S\u1EEC H\u1ED8I THO\u1EA0I:
${w}

DANH S\xC1CH S\u1EA2N PH\u1EA8M:
${W}`:W,Q=(await window.KTM.api.postJSON(`${API_BASE}/api/ai-chat`,{message:s,context:Y,audience:"admin"},"API error")).response||"Xin l\u1ED7i, t\xF4i kh\xF4ng th\u1EC3 tr\u1EA3 l\u1EDDi l\xFAc n\xE0y.";Me(re=>[...re,{role:"assistant",content:Q,attachments:l}])}catch(O){console.error("AI Error:",O);const W=s.toLowerCase(),K=q.filter(Y=>{const de=Object.values(Y).join(" ").toLowerCase();return W.split(" ").some(Q=>de.includes(Q))});let w="";K.length>0?(w=`T\xECm th\u1EA5y ${K.length} s\u1EA3n ph\u1EA9m li\xEAn quan:

`,K.slice(0,5).forEach(Y=>{w+=`\u2022 ${Y.name}`,Y.price&&(w+=` - ${Y.price.replace(/[đ\s]/g,"")}\u0111`),Y.note&&(w+=` (${Y.note})`),w+=`
`}),K.length>5&&(w+=`
...v\xE0 ${K.length-5} s\u1EA3n ph\u1EA9m kh\xE1c`)):w='Kh\xF4ng t\xECm th\u1EA5y s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p. H\xE3y th\u1EED t\u1EEB kh\xF3a kh\xE1c nh\u01B0 "van", "combo", "xy lanh"...',Me(Y=>[...Y,{role:"assistant",content:w,attachments:K.slice(0,4)}])}ln(!1),setTimeout(()=>{var O,W;(O=Ft.current)==null||O.scrollIntoView({behavior:"smooth"}),(W=pn.current)==null||W.focus()},100)};function ee({show:s,product:p,categories:l,onClose:O,onSave:W}){const[K,w]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[Y,de]=useState(!1),[Q,re]=useState(!1),He=useRef(null),Qe=G=>window.KTM.money.formatVNDInputDigits(G),f=G=>{const U=window.KTM.money.getDigits(String(G!=null?G:"")),he=Number(U);return U&&Number.isFinite(he)?Math.trunc(he):0},ye=(G,U)=>{if(G==null||G==="")return[];let he=G;if(typeof he=="string"){const _e=he.trim();if(!_e)return[];try{he=JSON.parse(_e)}catch(Se){return[]}}if(!Array.isArray(he))return[];const je=f(U);return he.map(_e=>{var dt;if(!_e||typeof _e!="object")return null;const Se=String((dt=_e.name)!=null?dt:"").trim(),pt=(Array.isArray(_e.options)?_e.options:[]).map(kt=>{var kn,$n,In,Rn,qn,Ln,fa;if(!kt||typeof kt!="object")return null;const Zt=String((kn=kt.label)!=null?kn:"").trim();if(!Zt)return null;const cn=(qn=(Rn=(In=($n=kt.price)!=null?$n:kt.priceValue)!=null?In:kt.unit_price)!=null?Rn:kt.unitPrice)!=null?qn:null,vn=Number(cn);let xn=Number.isFinite(vn)?Math.trunc(vn):null;if(xn==null){const Dn=(fa=(Ln=kt.price_delta)!=null?Ln:kt.priceDelta)!=null?fa:null,Hn=Number(Dn);Number.isFinite(Hn)&&(xn=je+Math.trunc(Hn))}xn==null&&(xn=je);const Sn=String(Math.max(0,Math.trunc(Number(xn)||0)));return{label:Zt,price:Math.max(0,Math.trunc(Number(xn)||0)),priceDigits:Sn}}).filter(Boolean);return{name:Se||"Bi\u1EBFn th\u1EC3",options:pt}}).filter(Boolean)},Tt=G=>{if(G==null||G==="")return[];let U=G;if(typeof U=="string"){const he=U.trim();if(!he)return[];try{U=JSON.parse(he)}catch(je){return[]}}return U&&typeof U=="object"&&!Array.isArray(U)&&(U=Object.entries(U).map(([he,je])=>({key:he,value:je}))),Array.isArray(U)?U.map(he=>{var pt,dt,kt,Zt,cn;if(!he||typeof he!="object")return null;const je=String((kt=(dt=(pt=he.key)!=null?pt:he.name)!=null?dt:he.label)!=null?kt:"").trim(),_e=String((Zt=he.value)!=null?Zt:"").trim(),Se=String((cn=he.unit)!=null?cn:"").trim();return je?{key:je,value:_e,unit:Se}:null}).filter(Boolean):[]};useEffect(()=>{var G,U;if(p)if(w({name:p.name||"",code:p.code||"",price:p.price||"",image:p.image||"",category:p.category||"",note:p.note||"",sort_order:p.sort_order||0,commission_percent:(U=(G=p.commission_percent)!=null?G:p.commissionPercent)!=null?U:5,variants:ye(p.variants,p.price),attributes:Tt(p.attributes)}),p.price){const he=window.KTM.money.getDigits(p.price);Gt(he),w(je=>({...je,price:Qe(he)}))}else Gt("");else w({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),Gt("")},[p,s]);const $t=G=>{w(U=>{var pt;const he=f(U.price),je=String(he),_e=Array.isArray(U.variants)?[...U.variants]:[],Se={..._e[G]||{},options:Array.isArray((pt=_e[G])==null?void 0:pt.options)?[..._e[G].options]:[]};return Se.options=Se.options.map(dt=>({label:String((dt==null?void 0:dt.label)||""),price:he,priceDigits:je})),_e[G]=Se,{...U,variants:_e}})},Ot=()=>{w(G=>{const U=f(G.price),he=String(U),_e=(Array.isArray(G.variants)?[...G.variants]:[]).map(Se=>{const pt=(Array.isArray(Se==null?void 0:Se.options)?Se.options:[]).map(dt=>({label:String((dt==null?void 0:dt.label)||""),price:U,priceDigits:he}));return{name:String((Se==null?void 0:Se.name)||"Bi\u1EBFn th\u1EC3"),options:pt}});return{...G,variants:_e}})},[qt,Qt]=React.useState(""),[Ht,Gt]=React.useState(""),bt=G=>{const U=window.KTM.money.nextPriceInputState(G.target.value,Ht);Gt(U.digits),w({...K,price:U.price})},rn=async(G,U=2)=>{const he=U*1024*1024;if(G.size<=he)return G;try{const je=await createImageBitmap(G),_e=document.createElement("canvas");let Se=je.width,pt=je.height;const dt=1200;return(Se>dt||pt>dt)&&(Se>pt?(pt=Math.round(pt/Se*dt),Se=dt):(Se=Math.round(Se/pt*dt),pt=dt)),_e.width=Se,_e.height=pt,_e.getContext("2d").drawImage(je,0,0,Se,pt),je.close(),new Promise((Zt,cn)=>{_e.toBlob(vn=>{vn?Zt(new File([vn],G.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):cn(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(je){throw console.error("Compress error:",je),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},un=async G=>{var je;const U=G.target.files[0];if(!U)return;if(!(U.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp)$/i.test(U.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}re(!0);try{const _e=await rn(U),Se=await window.KTM.cloudinary.uploadImage({file:_e,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-products"});if(!Se.secure_url)throw console.error("Cloudinary error:",Se),new Error(((je=Se.error)==null?void 0:je.message)||"Upload failed");w(pt=>({...pt,image:Se.secure_url}))}catch(_e){console.error("Upload error:",_e),alert("L\u1ED7i upload \u1EA3nh: "+_e.message)}re(!1),G.target.value=""},on=async G=>{G.preventDefault(),de(!0);const U={...K,variants:ye(K.variants,K.price),attributes:Tt(K.attributes)};await W(U),de(!1)};return s?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-lg"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,border:"none",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark"},React.createElement("i",{className:"fas fa-box me-2"}),p?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:O})),React.createElement("form",{onSubmit:on},React.createElement("div",{className:"modal-body",style:{maxHeight:"70vh",overflowY:"auto"}},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-8"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-tag me-1"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:K.name,onChange:G=>w({...K,name:G.target.value}),placeholder:"V\xED d\u1EE5: Xy lanh nghi\xEAng KTM",required:!0,style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-hashtag me-1"}),"M\xE3 s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:K.code,onChange:G=>w({...K,code:G.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1"}),"Gi\xE1 b\xE1n"),React.createElement("input",{type:"text",className:"form-control",value:K.price,onChange:bt,placeholder:"1.950.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3 mt-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-percent me-1"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:K.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:G=>w({...K,commission_percent:G.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-list me-1"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:K.category,onChange:G=>w({...K,category:G.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),l.map(G=>React.createElement("option",{key:G,value:G},G)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1"}),"Ghi ch\xFA"),React.createElement("textarea",{className:"form-control",rows:"2",value:K.note,onChange:G=>w({...K,note:G.target.value}),placeholder:"V\xED d\u1EE5: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(K.attributes)?K.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(K.attributes)?K.attributes:[]).map((G,U)=>React.createElement("div",{key:U,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(G==null?void 0:G.key)||"",onChange:he=>{const je=he.target.value;w(_e=>{const Se=Array.isArray(_e.attributes)?[..._e.attributes]:[];return Se[U]={...Se[U]||{},key:je},{..._e,attributes:Se}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(G==null?void 0:G.value)||"",onChange:he=>{const je=he.target.value;w(_e=>{const Se=Array.isArray(_e.attributes)?[..._e.attributes]:[];return Se[U]={...Se[U]||{},value:je},{..._e,attributes:Se}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(G==null?void 0:G.unit)||"",onChange:he=>{const je=he.target.value;w(_e=>{const Se=Array.isArray(_e.attributes)?[..._e.attributes]:[];return Se[U]={...Se[U]||{},unit:je},{..._e,attributes:Se}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{w(he=>{const je=Array.isArray(he.attributes)?[...he.attributes]:[];return je.splice(U,1),{...he,attributes:je}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{w(G=>{const U=Array.isArray(G.attributes)?[...G.attributes]:[];return U.push({key:"",value:"",unit:""}),{...G,attributes:U}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(K.variants)?K.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3. C\xF3 th\u1EC3 th\xEAm (v\xED d\u1EE5 Size: S/M/L)."):null,(Array.isArray(K.variants)?K.variants:[]).map((G,U)=>React.createElement("div",{key:U,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(G==null?void 0:G.name)||"",onChange:he=>{const je=he.target.value;w(_e=>{var pt;const Se=Array.isArray(_e.variants)?[..._e.variants]:[];return Se[U]={...Se[U]||{},name:je,options:Array.isArray((pt=Se[U])==null?void 0:pt.options)?Se[U].options:[]},{..._e,variants:Se}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>$t(U),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(G==null?void 0:G.options)||G.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{w(he=>{const je=Array.isArray(he.variants)?[...he.variants]:[];return je.splice(U,1),{...he,variants:je}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(G==null?void 0:G.options)?G.options:[]).map((he,je)=>{var _e,Se;return React.createElement("div",{key:je,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(he==null?void 0:he.label)||"",onChange:pt=>{const dt=pt.target.value;w(kt=>{var Sn,kn,$n,In,Rn;const Zt=Array.isArray(kt.variants)?[...kt.variants]:[],cn={...Zt[U]||{},options:Array.isArray((Sn=Zt[U])==null?void 0:Sn.options)?[...Zt[U].options]:[]},vn=Number(($n=(kn=cn.options[je])==null?void 0:kn.price)!=null?$n:0)||0,xn=String((Rn=(In=cn.options[je])==null?void 0:In.priceDigits)!=null?Rn:Math.max(0,Math.trunc(vn)));return cn.options[je]={...cn.options[je]||{},label:dt,price:Math.max(0,Math.trunc(vn)),priceDigits:xn},Zt[U]=cn,{...kt,variants:Zt}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:Qe(String((Se=he==null?void 0:he.priceDigits)!=null?Se:window.KTM.money.getDigits(String((_e=he==null?void 0:he.price)!=null?_e:"")))),onChange:pt=>{w(dt=>{var $n,In,Rn,qn,Ln;const kt=String((In=he==null?void 0:he.priceDigits)!=null?In:window.KTM.money.getDigits(String(($n=he==null?void 0:he.price)!=null?$n:""))),Zt=window.KTM.money.nextPriceInputState(pt.target.value,kt),cn=String((Rn=Zt.digits)!=null?Rn:""),vn=Number(cn),xn=Number.isFinite(vn)?Math.max(0,Math.trunc(vn)):0,Sn=Array.isArray(dt.variants)?[...dt.variants]:[],kn={...Sn[U]||{},options:Array.isArray((qn=Sn[U])==null?void 0:qn.options)?[...Sn[U].options]:[]};return kn.options[je]={...kn.options[je]||{},label:String(((Ln=kn.options[je])==null?void 0:Ln.label)||""),price:xn,priceDigits:cn},Sn[U]=kn,{...dt,variants:Sn}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{w(pt=>{var Zt;const dt=Array.isArray(pt.variants)?[...pt.variants]:[],kt={...dt[U]||{},options:Array.isArray((Zt=dt[U])==null?void 0:Zt.options)?[...dt[U].options]:[]};return kt.options.splice(je,1),dt[U]=kt,{...pt,variants:dt}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{w(he=>{var pt;const je=Array.isArray(he.variants)?[...he.variants]:[],_e={...je[U]||{},options:Array.isArray((pt=je[U])==null?void 0:pt.options)?[...je[U].options]:[]},Se=f(he.price);return _e.options.push({label:"",price:Se,priceDigits:String(Se)}),je[U]=_e,{...he,variants:je}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{w(G=>{const U=f(G.price),he=Array.isArray(G.variants)?[...G.variants]:[],je=String(U);return he.push({name:"Size",options:[{label:"S",price:U,priceDigits:je},{label:"M",price:U,priceDigits:je},{label:"L",price:U,priceDigits:je}]}),{...G,variants:he}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:Ot,disabled:!Array.isArray(K.variants)||K.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111.")))),React.createElement("div",{className:"col-md-4"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-image me-1"}),"\u1EA2nh s\u1EA3n ph\u1EA9m"),React.createElement("div",{className:"mb-2"},K.image?React.createElement(React.Fragment,null,React.createElement("img",{src:K.image,alt:"Product",style:{width:"100%",height:150,objectFit:"cover",borderRadius:"12px",border:"2px solid #e9ecef"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger mt-2",onClick:()=>w({...K,image:""}),style:{borderRadius:"20px",fontSize:"0.75rem"}},React.createElement("i",{className:"fas fa-times me-1"}),"X\xF3a \u1EA3nh")):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:"100%",height:150,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd",cursor:"pointer"},onClick:()=>{var G;return(G=He.current)==null?void 0:G.click()}},React.createElement("div",{className:"text-center"},React.createElement("i",{className:"fas fa-cloud-upload-alt fa-2x text-muted mb-2"}),React.createElement("div",{className:"small text-muted"},"Click \u0111\u1EC3 upload")))),React.createElement("input",{ref:He,type:"file",accept:"image/*",className:"d-none",onChange:un}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100",onClick:()=>{var G;return(G=He.current)==null?void 0:G.click()},disabled:Q,style:{borderRadius:"10px"}},Q?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh")),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"Ho\u1EB7c URL \u1EA3nh"),React.createElement("input",{type:"url",className:"form-control",value:K.image,onChange:G=>w({...K,image:G.target.value}),placeholder:"https://...",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"8px",fontSize:"0.875rem"}}))))),React.createElement("div",{className:"modal-footer",style:{border:"none",padding:"20px"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:O,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:Y,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},Y?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}const Ce=s=>window.KTM.money.formatVND(s),it=s=>{if(s==null||s==="")return[];let p=s;if(typeof p=="string"){const l=p.trim();if(!l)return[];try{p=JSON.parse(l)}catch(O){return[]}}return Array.isArray(p)?p:[]},De=s=>{if(s==null||s==="")return[];let p=s;if(typeof p=="string"){const l=p.trim();if(!l)return[];try{p=JSON.parse(l)}catch(O){return[]}}return p&&typeof p=="object"&&!Array.isArray(p)&&(p=Object.entries(p).map(([l,O])=>({key:l,value:O}))),Array.isArray(p)?p:[]},wt=(s,p={})=>{var K;const l=De(s).map(w=>{var Y,de,Q,re,He;return{key:String((Q=(de=(Y=w==null?void 0:w.key)!=null?Y:w==null?void 0:w.name)!=null?de:w==null?void 0:w.label)!=null?Q:"").trim(),value:String((re=w==null?void 0:w.value)!=null?re:"").trim(),unit:String((He=w==null?void 0:w.unit)!=null?He:"").trim()}}).filter(w=>!!w.key);if(!l.length)return null;const O=!!p.compact,W=String((K=p.className)!=null?K:"").trim();return React.createElement("div",{className:`ktm-variants-preview${O?" compact":""}${W?" "+W:""}`},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},l.map((w,Y)=>{const de=w.key,Q=`${w.value||""}${w.unit?(w.value?" ":"")+w.unit:""}`.trim();return React.createElement("div",{key:`${de}-${Y}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},de),Q?React.createElement("span",{className:"ktm-chip ktm-chip-option"},Q):null)})))},Lt=(s,p={})=>{var de;const l=it(s).map(Q=>{var re;return{name:String((re=Q==null?void 0:Q.name)!=null?re:"").trim(),options:Array.isArray(Q==null?void 0:Q.options)?Q.options:[]}}).map(Q=>({...Q,options:Q.options.map(re=>{var He;return{label:String((He=re==null?void 0:re.label)!=null?He:"").trim(),price:Number(re==null?void 0:re.price)}}).filter(re=>!!re.label)})).filter(Q=>Q.options.length>0);if(!l.length)return null;const O=Number.isFinite(p.maxGroups)?Math.max(1,Math.trunc(p.maxGroups)):l.length,W=Number.isFinite(p.maxOptionsPerGroup)?Math.max(1,Math.trunc(p.maxOptionsPerGroup)):3,K=!!p.compact,w=String((de=p.className)!=null?de:"").trim(),Y=l.slice(0,O);return React.createElement("div",{className:`ktm-variants-preview${K?" compact":""}${w?" "+w:""}`},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},Y.map((Q,re)=>{const He=Q.name||"Bi\u1EBFn th\u1EC3",Qe=Q.options.slice(0,W),f=Q.options.length-Qe.length;return React.createElement("div",{key:`${He}-${re}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},He),Qe.map((ye,Tt)=>{const $t=ye.price,Ot=Number.isFinite($t)&&$t>=0?Ce(Math.trunc($t)):"",qt=Ot?`${ye.label} \xB7 ${Ot}`:ye.label;return React.createElement("span",{key:`${He}-${re}-${Tt}`,className:"ktm-chip ktm-chip-option"},qt)}),f>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",f))})))},Ye=(s,p)=>{const l=s._type==="product",O=s._type==="album",W=s._type==="video",K=s.note&&(s.note.toLowerCase().includes("free")||s.note.toLowerCase().includes("gi\u1EA3m")||s.note.toLowerCase().includes("sale")),w=l?wt(s.attributes,{compact:ve==="grid",className:ve==="grid"?"meta text-muted":"text-muted"}):null,Y=l?Lt(s.variants,{compact:ve==="grid",maxOptionsPerGroup:999,className:ve==="grid"?"meta text-muted":"text-muted"}):null;return ve==="grid"?React.createElement("div",{key:s.id||p,className:"grid-card"},React.createElement("div",{className:"thumb-wrap",onClick:()=>{nt(s,"preview"),mn({url:s.image,name:s.name,price:s.price,note:s.note,item:s})}},s.image?React.createElement("img",{src:s.image,alt:s.name,className:"thumb",loading:"lazy"}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${W?"fa-video":"fa-image"} fa-2x text-muted`})),s.price&&React.createElement("div",{className:"price-overlay"},s.price.replace(/[đ\s]/g,""),"\u0111"),React.createElement("span",{className:`type-badge ${l?"product":O?"album":"video"}`},l?"SP":O?"\u1EA2nh":"Video"),K&&React.createElement("span",{className:"promo-badge"},"\u{1F525} \u01AFU \u0110\xC3I")),React.createElement("div",{className:"card-body"},React.createElement("div",{className:"name"},s.name),s.note&&React.createElement("div",{className:"meta text-info",style:{fontSize:10}},s.note),w&&React.createElement("div",{style:{marginTop:2}},w),Y&&React.createElement("div",{style:{marginTop:2}},Y),React.createElement("div",{className:"quick-copy"},React.createElement("button",{className:Be===s.id+"-img"?"copied":"",onClick:()=>M(s.image,s.id,{item:s,action:"copy_image"})},React.createElement("i",{className:"fas fa-image"})),s.price&&React.createElement("button",{className:Be===s.id+"-price"?"copied":"",onClick:()=>Le(s.price.replace(/[đ\s]/g,""),s.id+"-price",{item:s,action:"copy_price"})},React.createElement("i",{className:"fas fa-tag"}))))):React.createElement("div",{key:s.id||p,className:"product-card-mobile"},React.createElement("span",{className:`type-badge ${l?"product":O?"album":"video"}`},l?"S\u1EA3n ph\u1EA9m":O?"\u1EA2nh":"Video"),React.createElement("div",{className:"card-inner"},s.image?React.createElement("img",{src:s.image,alt:s.name,className:"thumb",loading:"lazy",onClick:()=>{nt(s,"preview"),mn({url:s.image,name:s.name,price:s.price,note:s.note,item:s})}}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${W?"fa-video":"fa-image"} fa-2x text-muted`})),React.createElement("div",{className:"info"},React.createElement("div",null,React.createElement("div",{className:"name"},s.name),React.createElement("div",{className:"price-row"},s.price&&React.createElement("span",{className:"price"},s.price.replace(/[đ\s]/g,""),"\u0111"),K&&React.createElement("span",{className:"badge-promo"},"\u{1F525} \u01AFU \u0110\xC3I")),w&&React.createElement("div",{style:{marginTop:4}},w),Y&&React.createElement("div",{style:{marginTop:4}},Y)),React.createElement("div",{className:"meta"},s.code&&React.createElement("span",{className:"meta-tag"},"#",s.code),s.category&&React.createElement("span",{className:"meta-tag"},s.category),s.note&&React.createElement("span",{className:"meta-tag highlight"},s.note),s.folder&&React.createElement("span",{className:"meta-tag"},s.folder),W&&React.createElement("span",{className:"meta-tag"},React.createElement("i",{className:"fab fa-youtube text-danger"})," Video")))),React.createElement("div",{className:"quick-actions"},l&&React.createElement("button",{onClick:()=>{nt(s,"create_order"),D&&D("orders","create",{productId:s.id})}},React.createElement("i",{className:"fas fa-receipt"})," T\u1EA1o \u0111\u01A1n"),s.price&&React.createElement("button",{className:Be===s.id+"-price"?"copied":"",onClick:()=>Le(s.price.replace(/[đ\s]/g,""),s.id+"-price",{item:s,action:"copy_price"})},React.createElement("i",{className:"fas fa-tag"})," Gi\xE1"),React.createElement("button",{className:Be===s.id+"-name"?"copied":"",onClick:()=>Le(s.name,s.id+"-name",{item:s,action:"copy_name"})},React.createElement("i",{className:"fas fa-font"})," T\xEAn"),W&&s.youtubeId&&React.createElement("button",{className:Be===s.id+"-yt"?"copied":"",onClick:()=>Le(`https://www.youtube.com/watch?v=${s.youtubeId}`,s.id+"-yt")},React.createElement("i",{className:"fab fa-youtube"})),l&&React.createElement("button",{className:"action-edit",onClick:()=>V(s)},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"action-delete",onClick:()=>xe(s)},React.createElement("i",{className:"fas fa-trash"}))))},[Rt,Yt]=useState(!1);return React.createElement(React.Fragment,null,React.createElement("div",{className:"search-suggestions mobile-only"},React.createElement("div",{className:"search-suggestions-section"},React.createElement("div",{className:"search-suggestions-label"},"G\u1EE3i \xFD nhanh"),React.createElement("div",{className:"search-suggestions-row"},[{label:"van 2 tay",query:"van 2 tay"},{label:"combo r\u1EBB",query:"combo r\u1EBB"},{label:"xylanh",query:"xylanh"},{label:"sdt:\u2026",query:"sdt:",caret:"end",addToHistory:!1},{label:"#m\xE3\u2026",query:"#",caret:"end",addToHistory:!1}].map(s=>React.createElement("button",{key:s.label,type:"button",className:"suggestion-chip",onClick:()=>fn(s.query,{caret:s.caret,addToHistory:s.addToHistory,focus:!1})},s.label)))),sn.length>0&&React.createElement("div",{className:"search-suggestions-section"},React.createElement("div",{className:"search-suggestions-label"},"S\u1EA3n ph\u1EA9m hay t\xECm"),React.createElement("div",{className:"search-suggestions-row"},sn.map(s=>{var W,K;const p=(((W=s.item)==null?void 0:W.name)||s.name||"").trim();if(!p)return null;const l=String(((K=s.item)==null?void 0:K.code)||s.code||"").trim(),O=l?`#${l}`:p;return React.createElement("button",{key:s.id,type:"button",className:"suggestion-chip suggestion-chip-popular",onClick:()=>{s.item&&nt(s.item,"suggestion"),fn(O,{caret:"end",focus:!1})},title:l?`#${l}`:p},p)}))),Wt.length>0&&React.createElement("div",{className:"search-suggestions-section"},React.createElement("div",{className:"search-suggestions-label"},"T\xECm g\u1EA7n \u0111\xE2y / hay d\xF9ng"),React.createElement("div",{className:"search-suggestions-row"},Wt.map(s=>React.createElement("button",{key:s.q,type:"button",className:"suggestion-chip suggestion-chip-query",onClick:()=>fn(s.q,{caret:"end",focus:!1}),title:`${s.q} (${s.count})`},s.q))))),React.createElement("div",{className:"result-header"},React.createElement("span",null,React.createElement("strong",null,te.length)," k\u1EBFt qu\u1EA3",yt&&L.length>=3&&React.createElement("span",{className:"ai-badge ms-2"},React.createElement("i",{className:"fas fa-robot"})," AI"),We!=="all"&&React.createElement("span",{className:"ms-2 badge bg-warning text-dark"},We==="product"?"S\u1EA3n ph\u1EA9m":We==="album"?"\u1EA2nh":"Video")),React.createElement("div",{className:"d-flex gap-1 align-items-center"},React.createElement("button",{className:`btn btn-sm ${ve==="list"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>Ee("list"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-list"})),React.createElement("button",{className:`btn btn-sm ${ve==="grid"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>Ee("grid"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-th"})))),React.createElement("div",{className:"search-results-area"},F?React.createElement("div",null,[...Array(8)].map((s,p)=>React.createElement("div",{key:p,className:"product-card-mobile mb-2",style:{opacity:.7}},React.createElement("div",{className:"card-inner"},React.createElement("div",{className:"thumb bg-light",style:{width:80,height:80,borderRadius:8}}),React.createElement("div",{className:"info",style:{flex:1,minWidth:0}},React.createElement("div",{className:"skeleton-box mb-2",style:{height:16,width:"60%",background:"#eee",borderRadius:4}}),React.createElement("div",{className:"skeleton-box mb-1",style:{height:12,width:"40%",background:"#f3f3f3",borderRadius:4}}),React.createElement("div",{className:"skeleton-box",style:{height:10,width:"30%",background:"#f3f3f3",borderRadius:4}})))))):te.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-search"}),React.createElement("p",null,'Kh\xF4ng t\xECm th\u1EA5y "',L,'"'),React.createElement("button",{className:"btn btn-warning",onClick:()=>{be(""),gt("")}},"Xem t\u1EA5t c\u1EA3")):ve==="grid"?React.createElement("div",{className:"product-grid-mobile"},te.map((s,p)=>Ye(s,p))):React.createElement("div",null,te.map((s,p)=>Ye(s,p)))),Rt&&React.createElement("div",{className:"filter-dropdown"},React.createElement("div",{className:"filter-header"},React.createElement("strong",null,"L\u1ECDc theo lo\u1EA1i"),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>Yt(!1)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"filter-chips"},React.createElement("span",{className:`filter-chip ${We==="all"?"active":""}`,onClick:()=>{Nt("all"),Yt(!1)}},"T\u1EA5t c\u1EA3"),React.createElement("span",{className:`filter-chip ${We==="product"?"active":""}`,onClick:()=>{Nt("product"),Yt(!1)}},React.createElement("i",{className:"fas fa-box me-1"}),"S\u1EA3n ph\u1EA9m"),React.createElement("span",{className:`filter-chip ${We==="album"?"active":""}`,onClick:()=>{Nt("album"),Yt(!1)}},React.createElement("i",{className:"fas fa-images me-1"}),"\u1EA2nh"),React.createElement("span",{className:`filter-chip ${We==="video"?"active":""}`,onClick:()=>{Nt("video"),Yt(!1)}},React.createElement("i",{className:"fas fa-video me-1"}),"Video")),React.createElement("div",{className:"mt-3 pt-3 border-top d-flex align-items-center justify-content-between"},React.createElement("span",null,"AI Search th\xF4ng minh"),React.createElement("div",{className:"form-check form-switch m-0"},React.createElement("input",{type:"checkbox",className:"form-check-input",checked:yt,onChange:s=>Et(s.target.checked),style:{width:40,height:20}})))),React.createElement("div",{className:"search-bar-bottom"},React.createElement("div",{className:"search-input-wrap"},React.createElement("input",{ref:Re,type:"text",className:"search-input",placeholder:"\u{1F50D} T\xECm: van 3 tay, xylanh... (/ \u0111\u1EC3 focus, Ctrl+K palette)",value:L,onChange:s=>gt(s.target.value)}),React.createElement("button",{className:`filter-btn ${Rt||We!=="all"?"active":""}`,onClick:()=>Yt(!Rt)},React.createElement("i",{className:"fas fa-filter"})))),S&&React.createElement("div",{className:"search-palette-overlay",onClick:()=>B(!1)},React.createElement("div",{className:"search-palette",onClick:s=>s.stopPropagation()},React.createElement("div",{className:"palette-header"},React.createElement("input",{ref:j,type:"text",className:"palette-input",placeholder:"\u{1F50D} T\xECm ki\u1EBFm n\xE2ng cao... (filter: \u1EA3nh, video; t\u1EEB kh\xF3a...)",value:Te,onChange:s=>gt(s.target.value),onKeyDown:s=>{s.key==="Enter"&&te.length>0?(tt(Te),B(!1)):s.key==="Escape"&&B(!1)}}),React.createElement("button",{className:"palette-close",onClick:()=>B(!1)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"palette-body"},React.createElement("div",{className:"palette-section"},React.createElement("div",{className:"section-label"},"Lo\u1EA1i"),React.createElement("div",{className:"filter-chips-row"},["T\u1EA5t c\u1EA3","S\u1EA3n ph\u1EA9m","\u1EA2nh","Video"].map((s,p)=>React.createElement("span",{key:s,className:`filter-chip ${We===["all","product","album","video"][p]?"active":""}`,onClick:()=>{Nt(["all","product","album","video"][p])}},s)))),oe.length>0&&!Te.trim()&&React.createElement("div",{className:"palette-section"},React.createElement("div",{className:"section-label"},React.createElement("i",{className:"fas fa-star me-1"}),"T\xECm ki\u1EBFm \u0111\xE3 l\u01B0u"),React.createElement("div",{className:"palette-items"},oe.map((s,p)=>React.createElement("div",{key:p,className:"palette-item",onClick:()=>{gt(s),tt(s)}},React.createElement("i",{className:"fas fa-star"}),React.createElement("span",null,s),React.createElement("button",{className:"unsave-btn",onClick:l=>{l.stopPropagation(),Bt(s)}},React.createElement("i",{className:"fas fa-trash-alt"})))))),fe.length>0&&!Te.trim()&&React.createElement("div",{className:"palette-section"},React.createElement("div",{className:"section-label"},React.createElement("i",{className:"fas fa-clock me-1"}),"L\u1ECBch s\u1EED t\xECm ki\u1EBFm"),React.createElement("div",{className:"palette-items"},fe.map((s,p)=>React.createElement("div",{key:p,className:"palette-item",onClick:()=>{gt(s)}},React.createElement("i",{className:"fas fa-history"}),React.createElement("span",null,s),React.createElement("button",{className:"save-btn",onClick:l=>{l.stopPropagation(),Bt(s)}},React.createElement("i",{className:`fas fa-star${oe.includes(s)?"":"-o"}`})))))),Te.trim()&&te.length>0&&React.createElement("div",{className:"palette-section"},React.createElement("div",{className:"section-label"},"K\u1EBFt qu\u1EA3 (",te.length,")"),React.createElement("div",{className:"palette-items",style:{maxHeight:300,overflowY:"auto"}},te.slice(0,8).map((s,p)=>React.createElement("div",{key:s.id||p,className:"palette-result-item",onClick:()=>{tt(Te),B(!1)}},s.image&&React.createElement("img",{src:s.image,alt:s.name,className:"result-thumb"}),React.createElement("div",{className:"result-text"},React.createElement("div",{className:"result-name"},s.name),s.price&&React.createElement("div",{className:"result-meta"},s.price.replace(/[đ\s]/g,""),"\u0111")),React.createElement("button",{className:"save-btn",onClick:l=>{l.stopPropagation(),Bt(Te)}},React.createElement("i",{className:`fas fa-star${oe.includes(Te)?"":"-o"}`})))))),Te.trim()&&te.length===0&&React.createElement("div",{className:"palette-empty"},React.createElement("i",{className:"fas fa-search"}),React.createElement("p",null,'Kh\xF4ng t\xECm th\u1EA5y k\u1EBFt qu\u1EA3 cho "',Te,'"'))),React.createElement("div",{className:"palette-footer"},React.createElement("span",null,React.createElement("kbd",null,"Esc")," \u0111\u1EC3 \u0111\xF3ng"),React.createElement("span",null,React.createElement("kbd",null,"Enter")," \u0111\u1EC3 l\u01B0u v\xE0o l\u1ECBch s\u1EED")))),React.createElement("button",{className:"btn btn-lg rounded-circle position-fixed shadow-lg",style:{bottom:c?320:130,right:16,width:56,height:56,zIndex:1050,transition:"bottom 0.2s ease",background:"linear-gradient(135deg, #667eea, #764ba2)",color:"#fff",border:"none",WebkitTapHighlightColor:"transparent",touchAction:"manipulation",cursor:"pointer",outline:"none"},onClick:()=>At(!0),onTouchStart:()=>At(!0)},React.createElement("i",{className:"fas fa-robot fa-lg"})),Je&&React.createElement("div",{className:"ai-chat-mobile"},React.createElement("div",{className:"chat-header"},React.createElement("button",{className:"back-btn",onClick:()=>At(!1)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("strong",null,"KTM AI Assistant"),React.createElement("div",{style:{fontSize:11,opacity:.8}},"H\u1ECFi v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3..."))),React.createElement("div",{className:"chat-messages"},Kt.map((s,p)=>React.createElement("div",{key:p,className:`mb-3 ${s.role==="user"?"d-flex justify-content-end":""}`},React.createElement("div",{className:`p-3 rounded-3 position-relative ${s.role==="user"?"text-white":"bg-white border"}`,style:{maxWidth:"85%",whiteSpace:"pre-wrap",background:s.role==="user"?"linear-gradient(135deg, #667eea, #764ba2)":void 0}},s.content,s.role==="assistant"&&React.createElement("button",{className:"btn btn-sm position-absolute",style:{top:4,right:4,padding:"2px 6px",fontSize:11,background:Be===`chat-${p}`?"#28a745":"rgba(0,0,0,0.1)",border:"none",borderRadius:4,color:Be===`chat-${p}`?"#fff":"#666"},onClick:()=>{window.KTM.clipboard.writeText(s.content),Xe(`chat-${p}`),setTimeout(()=>Xe(null),1500)}},React.createElement("i",{className:`fas ${Be===`chat-${p}`?"fa-check":"fa-copy"}`})),s.attachments&&s.attachments.length>0&&React.createElement("div",{className:"mt-2 d-flex flex-wrap gap-2"},s.attachments.map((l,O)=>React.createElement("div",{key:O,style:{width:70},className:"text-center"},l.image&&React.createElement("img",{src:l.image,className:"rounded",style:{width:70,height:50,objectFit:"cover",cursor:"pointer"},onClick:()=>mn({url:l.image,name:l.name,price:l.price})}),React.createElement("div",{style:{fontSize:9},className:"text-truncate"},l.name),l.price&&React.createElement("div",{style:{fontSize:10,color:"#dc3545",fontWeight:600}},l.price.replace(/[đ\s]/g,""),"\u0111"))))))),_t&&React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"bg-white border p-3 rounded-3 d-inline-block"},React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang suy ngh\u0129...")),React.createElement("div",{ref:Ft})),React.createElement("div",{className:"px-3 py-2 border-top d-flex gap-2 overflow-auto"},["Gi\xE1 van 2 tay?","Combo r\u1EBB nh\u1EA5t?","Freeship?","Van 3 tay?"].map(s=>React.createElement("button",{key:s,className:"btn btn-sm btn-outline-secondary flex-shrink-0",onClick:()=>ze(s),disabled:_t,style:{whiteSpace:"nowrap"}},s))),React.createElement("div",{className:"chat-input-area"},React.createElement("form",{onSubmit:s=>{s.preventDefault(),ze(ct)},className:"chat-input-wrap"},React.createElement("input",{ref:pn,type:"text",className:"chat-input",placeholder:"Nh\u1EADp c\xE2u h\u1ECFi...",value:ct,onChange:s=>en(s.target.value),disabled:_t}),React.createElement("button",{type:"submit",className:"send-btn",disabled:_t||!ct.trim()},React.createElement("i",{className:"fas fa-paper-plane"}))))),rt&&React.createElement("div",{className:"preview-modal",onClick:()=>mn(null)},React.createElement("div",{className:"preview-header"},React.createElement("div",null),React.createElement("button",{className:"close-btn",onClick:()=>mn(null)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"preview-body",onClick:s=>s.stopPropagation()},React.createElement("img",{src:rt.url,alt:rt.name})),React.createElement("div",{className:"preview-footer",onClick:s=>s.stopPropagation()},React.createElement("div",{className:"name"},rt.name),rt.price&&React.createElement("div",{className:"price"},rt.price.replace(/[đ\s]/g,""),"\u0111"),rt.note&&React.createElement("div",{className:"mb-2",style:{fontSize:14,color:"#17a2b8"}},rt.note),React.createElement("div",{className:"action-btns"},React.createElement("button",{className:Be==="preview-img"?"btn-success text-white":"btn-outline-light text-white",style:{background:Be==="preview-img"?"#28a745":"rgba(255,255,255,0.2)"},onClick:()=>M(rt.url,"preview")},React.createElement("i",{className:`fas ${Be==="preview-img"?"fa-check":"fa-copy"}`}),"Copy \u1EA3nh"),rt.price&&React.createElement("button",{className:Be==="preview-price"?"btn-success text-white":"btn-warning",onClick:()=>Le(rt.price.replace(/[đ\s]/g,""),"preview-price")},React.createElement("i",{className:`fas ${Be==="preview-price"?"fa-check":"fa-tag"}`}),"Copy gi\xE1")))),React.createElement(ee,{show:g,product:H,categories:Fe,onClose:()=>{A(!1),E(null)},onSave:me}),React.createElement("div",{className:`fab-container mobile-only ${c?"open":""}`},React.createElement("div",{className:"fab-actions"},React.createElement("button",{className:"fab-action product",onClick:()=>{x(!1),A(!0),E(null)}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",{className:"tooltip"},"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("button",{className:"fab-action product",onClick:()=>{x(!1),D&&D("orders","create")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",{className:"tooltip"},"T\u1EA1o order nhanh"))),React.createElement("button",{className:`fab-main ${c?"open":""}`,onClick:()=>x(!c)},React.createElement("i",{className:"fas fa-plus"}))),_n&&ut&&React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,maxHeight:"90vh"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none"}},React.createElement("h6",{className:"modal-title fw-bold"},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa nhanh"),React.createElement("button",{type:"button",className:"btn-close",onClick:()=>yn(!1)})),React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"T\xEAn s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:h.name,onChange:s=>k({...h,name:s.target.value})})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:h.code,onChange:s=>k({...h,code:s.target.value})})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:h.price,onChange:s=>k({...h,price:s.target.value})}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:h.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:s=>k({...h,commission_percent:s.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:h.category,onChange:s=>k({...h,category:s.target.value})},React.createElement("option",{value:""},"-- Ch\u1ECDn danh m\u1EE5c --"),T.map(s=>React.createElement("option",{key:s,value:s},s)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Ghi ch\xFA (\u01B0u \u0111\xE3i)"),React.createElement("input",{type:"text",className:"form-control",value:h.note,placeholder:"VD: Free ship, Gi\u1EA3m 10%...",onChange:s=>k({...h,note:s.target.value})}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>yn(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-warning",onClick:se},React.createElement("i",{className:"fas fa-save me-1"}),"L\u01B0u"))))))}function VideoList({onRefresh:_,showToast:D}){const[L,be]=useState([]),[te,X]=useState([]),[q,Oe]=useState(!0),[Fe,we]=useState(null),[We,st]=useState(!1),[Be,Xe]=useState(null),[ve,Ee]=useState(!1),[F,ht]=useState(null),[St,Ct]=useState(!1),[Ve,at]=useState(null),[Re,yt]=useState(!1),[Et,an]=useState(!1),[et,Pt]=useState(null),[Xt,C]=useState(!1),[S,B]=useState(null),[fe,ge]=useState([]);useEffect(()=>{oe()},[]);const oe=async($=null)=>{Oe(!0);try{const ne=$?`${API_BASE}/api/video-folders?withVideos=true&parent_id=${$}`:`${API_BASE}/api/video-folders?withVideos=true&parent_id=root`,tt=await window.KTM.api.getJSON(ne,"L\u1ED7i t\u1EA3i danh s\xE1ch folder");be(Array.isArray(tt)?tt:[])}catch(ne){console.error(ne),D("L\u1ED7i t\u1EA3i danh s\xE1ch folder","danger")}Oe(!1)},le=async $=>{try{const ne=await window.KTM.api.getJSON(`${API_BASE}/api/videos?folderId=${$}`,"L\u1ED7i t\u1EA3i video");X(Array.isArray(ne)?ne:[])}catch(ne){console.error(ne)}},Te=async $=>{if($===0)return;const ne=[...L];[ne[$-1],ne[$]]=[ne[$],ne[$-1]],be(ne),await j(ne)},N=async $=>{if($===L.length-1)return;const ne=[...L];[ne[$],ne[$+1]]=[ne[$+1],ne[$]],be(ne),await j(ne)},j=async $=>{try{await Promise.all($.map((ne,tt)=>window.KTM.api.putJSON(`${API_BASE}/api/video-folders/${ne.id}`,{sortOrder:tt},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),D("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(ne){D("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),oe(S==null?void 0:S.id)}},J=async $=>{if($===0)return;const ne=[...te];[ne[$-1],ne[$]]=[ne[$],ne[$-1]],X(ne),await $e(ne)},ae=async $=>{if($===te.length-1)return;const ne=[...te];[ne[$],ne[$+1]]=[ne[$+1],ne[$]],X(ne),await $e(ne)},$e=async $=>{try{await Promise.all($.map((ne,tt)=>window.KTM.api.putJSON(`${API_BASE}/api/videos/${ne.id}`,{sort_order:tt},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),D("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(ne){D("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),le(Fe.id)}},ke=()=>{Xe(null),st(!0)},Ze=$=>{Pt($),an(!0),C(!0)},Je=async($,ne="modal")=>{try{!Be&&S&&($.parent_id=S.id);const tt=Be?`${API_BASE}/api/video-folders/${Be.id}`:`${API_BASE}/api/video-folders`;Be?await window.KTM.api.putJSON(tt,$,"L\u1ED7i l\u01B0u folder"):await window.KTM.api.postJSON(tt,$,"L\u1ED7i l\u01B0u folder"),D(Be?"\u0110\xE3 c\u1EADp nh\u1EADt folder!":"\u0110\xE3 t\u1EA1o folder m\u1EDBi!","success"),ne==="drawer"?(C(!1),Xe(null),oe(S==null?void 0:S.id),Be&&et&&Pt({...et,...$})):(st(!1),Xe(null),oe(S==null?void 0:S.id))}catch(tt){D(tt.message,"danger")}},At=async $=>{const ne=$.subfolderCount>0?`X\xF3a folder "${$.name}"? T\u1EA5t c\u1EA3 subfolder v\xE0 videos b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`:`X\xF3a folder "${$.name}"? Videos trong folder s\u1EBD kh\xF4ng b\u1ECB x\xF3a.`;if(confirm(ne))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/video-folders/${$.id}`,"L\u1ED7i x\xF3a folder"),D("\u0110\xE3 x\xF3a folder","success"),we(null),oe(S==null?void 0:S.id)}catch(tt){D("L\u1ED7i x\xF3a folder","danger")}},Kt=$=>{$.subfolderCount>0?(ge(ne=>[...ne,$]),B($),oe($.id)):(we($),X($.videos||[]))},Me=$=>{if($==="root")ge([]),B(null),oe(null);else if($){const ne=fe.findIndex(tt=>tt.id===$.id);ne>=0&&(ge(fe.slice(0,ne+1)),B($),oe($.id))}else{const ne=[...fe];ne.pop();const tt=ne[ne.length-1]||null;ge(ne),B(tt),oe(tt==null?void 0:tt.id)}},ct=()=>{an(!1),C(!1),Pt(null)},en=()=>{Ct(!1),yt(!1),at(null)},_t=()=>{ht(null),Ee(!0)},ln=$=>{at($),Ct(!0),yt(!0)},Ft=async($,ne="modal")=>{try{$.folder_id=Fe==null?void 0:Fe.id;const tt=F?`${API_BASE}/api/videos/${F.id}`:`${API_BASE}/api/videos`;F?await window.KTM.api.putJSON(tt,$,"L\u1ED7i l\u01B0u video"):await window.KTM.api.postJSON(tt,$,"L\u1ED7i l\u01B0u video"),D(F?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm video th\xE0nh c\xF4ng!","success"),ne==="drawer"?(yt(!1),ht(null),oe(),Fe&&le(Fe.id),F&&Ve&&at({...Ve,...$})):(Ee(!1),ht(null),oe(),Fe&&le(Fe.id))}catch(tt){D(tt.message,"danger")}},pn=async $=>{if(confirm(`X\xF3a video "${$.title}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/videos/${$.id}`,"L\u1ED7i x\xF3a video"),D("\u0110\xE3 x\xF3a video","success"),oe(),Fe&&le(Fe.id)}catch(ne){D("L\u1ED7i x\xF3a video","danger")}},bn=$=>{const ne=`https://www.youtube.com/watch?v=${$.youtubeId}`;window.KTM.clipboard.writeText(ne).then(()=>{D("\u0110\xE3 copy link!","success")}).catch(()=>{D("Kh\xF4ng th\u1EC3 copy link","danger")})};return Fe?React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>we(null)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:`fas fa-folder-open me-2 ${Fe.slug==="shorts"?"text-danger":"text-warning"}`}),Fe.name)),React.createElement("button",{className:"btn btn-warning",onClick:_t},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm Video")),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1 videos"),te.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-video fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},"Ch\u01B0a c\xF3 video trong folder n\xE0y")):React.createElement("div",{className:"row g-4"},te.map(($,ne)=>React.createElement("div",{key:$.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>J(ne),disabled:ne===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},ne+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>ae(ne),disabled:ne===te.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"position-relative"},React.createElement("img",{src:$.thumb,className:"card-img-top",alt:$.title,style:{height:"120px",objectFit:"cover"}}),React.createElement("a",{href:`https://www.youtube.com/watch?v=${$.youtubeId}`,target:"_blank",className:"position-absolute top-50 start-50 translate-middle"},React.createElement("i",{className:"fas fa-play-circle fa-3x text-white",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"}}))),React.createElement("div",{className:"card-body py-2"},React.createElement("h6",{className:"card-title small mb-1 text-truncate",title:$.title},$.title),React.createElement("small",{className:"text-muted"},$.youtubeId)),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-primary",onClick:()=>bn($),title:"Copy link"},React.createElement("i",{className:"fas fa-link"})),React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>ln($),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-outline-danger",onClick:()=>pn($),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))))),React.createElement(VideoModal,{show:ve,video:F,onClose:()=>Ee(!1),onSave:Ft}),React.createElement(AdminDrawer,{open:Et,title:et?et.name:"Folder",subtitle:et?`${et.subfolderCount||0} subfolder \u2022 ${et.videoCount||0} videos`:"",onClose:ct,footer:Xt?React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:ct},React.createElement("i",{className:"fas fa-xmark me-2"}),"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-warning fw-semibold",onClick:()=>{et&&Je({name:et.name||"",description:et.description||"",sortOrder:et.sortOrder||0},"drawer")}},React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u")):et?React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{window.KTM.clipboard.writeText(et.name),D("\u0110\xE3 copy t\xEAn folder","success")}},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy"),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>{C(!0)}},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>{confirm(`X\xF3a folder "${et.name}"?`)&&(At(et),ct())}},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a"))):null},Xt&&et?React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-pen me-2 text-warning"}),"Ch\u1EC9nh s\u1EEDa"),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:et.name||"",onChange:$=>Pt({...et,name:$.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:et.description||"",onChange:$=>Pt({...et,description:$.target.value})}))):et?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"Th\xF4ng tin"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"T\xEAn"),React.createElement("div",{className:"v"},et.name),React.createElement("div",{className:"k"},"Slug"),React.createElement("div",{className:"v font-monospace"},et.id),React.createElement("div",{className:"k"},"Subfolder"),React.createElement("div",{className:"v"},et.subfolderCount||0),React.createElement("div",{className:"k"},"Video"),React.createElement("div",{className:"v"},et.videoCount||0))),et.description&&React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-note-sticky me-2 text-secondary"}),"M\xF4 t\u1EA3"),React.createElement("p",null,et.description))):React.createElement("div",{className:"text-muted"},"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u")),React.createElement(AdminDrawer,{open:St,title:Ve?Ve.title:"Video",subtitle:Ve?`${Ve.youtubeId}`:"",onClose:en,footer:Re?React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:en},React.createElement("i",{className:"fas fa-xmark me-2"}),"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-warning fw-semibold",onClick:()=>{Ve&&Ft({youtube_url:`https://www.youtube.com/watch?v=${Ve.youtubeId}`,title:Ve.title||"",thumbnail_url:Ve.thumb||"",sort_order:Ve.sortOrder||0},"drawer")}},React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u")):Ve?React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{const $=`https://www.youtube.com/watch?v=${Ve.youtubeId}`;window.KTM.clipboard.writeText($).then(()=>{D("\u0110\xE3 copy link!","success")})}},React.createElement("i",{className:"fas fa-link me-2"}),"Copy"),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>{yt(!0)}},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>{confirm(`X\xF3a video "${Ve.title}"?`)&&(pn(Ve),en())}},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a"))):null},Re&&Ve?React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-pen me-2 text-warning"}),"Ch\u1EC9nh s\u1EEDa"),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ti\xEAu \u0111\u1EC1 *"),React.createElement("input",{type:"text",className:"form-control",value:Ve.title||"",onChange:$=>at({...Ve,title:$.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"YouTube ID"),React.createElement("input",{type:"text",className:"form-control",value:Ve.youtubeId||"",onChange:$=>at({...Ve,youtubeId:$.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:Ve.sortOrder||0,onChange:$=>at({...Ve,sortOrder:parseInt($.target.value)||0})}))):Ve?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"Th\xF4ng tin"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"Ti\xEAu \u0111\u1EC1"),React.createElement("div",{className:"v"},Ve.title),React.createElement("div",{className:"k"},"YouTube ID"),React.createElement("div",{className:"v font-monospace"},Ve.youtubeId),React.createElement("div",{className:"k"},"Th\u1EE9 t\u1EF1"),React.createElement("div",{className:"v"},Ve.sortOrder||0))),Ve.thumb&&React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-image me-2 text-info"}),"Thumbnail"),React.createElement("img",{src:Ve.thumb,alt:Ve.title,className:"rounded w-100",style:{maxHeight:200,objectFit:"cover"}}))):React.createElement("div",{className:"text-muted"},"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u"))):React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},S&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>Me()},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-video me-2 text-warning"}),S?S.name:"Qu\u1EA3n l\xFD Video")),React.createElement("button",{className:"btn btn-warning",onClick:ke},React.createElement("i",{className:"fas fa-folder-plus me-2"}),"T\u1EA1o Folder")),fe.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:$=>{$.preventDefault(),Me("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),fe.map(($,ne)=>React.createElement("li",{key:$.id,className:`breadcrumb-item ${ne===fe.length-1?"active":""}`},ne===fe.length-1?$.name:React.createElement("a",{href:"#",onClick:tt=>{tt.preventDefault(),Me($)},className:"text-warning"},$.name))))),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1. Click v\xE0o folder \u0111\u1EC3 v\xE0o b\xEAn trong."),q?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):L.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},S?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder video n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:ke},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o folder",S?" con":" \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"row g-3"},L.map(($,ne)=>{var tt,Bt,hn,Vt;return React.createElement("div",{key:$.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-card"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Ut=>{Ut.stopPropagation(),Te(ne)},disabled:ne===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},ne+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Ut=>{Ut.stopPropagation(),N(ne)},disabled:ne===L.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"card-body text-center py-3",onClick:()=>Kt($),style:{cursor:"pointer"}},React.createElement("i",{className:`fas fa-folder fa-3x mb-3 ${$.slug==="shorts"?"text-danger":"text-warning"}`}),React.createElement("h5",{className:"card-title"},$.name),React.createElement("p",{className:"text-muted mb-0"},$.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),$.subfolderCount," folder"),$.subfolderCount>0&&($.videoCount>0||((tt=$.videos)==null?void 0:tt.length)>0)&&" \u2022 ",($.videoCount>0||((Bt=$.videos)==null?void 0:Bt.length)>0)&&React.createElement("span",null,React.createElement("i",{className:"fas fa-video me-1"}),$.videoCount||((hn=$.videos)==null?void 0:hn.length)||0," videos"),$.subfolderCount===0&&!$.videoCount&&!((Vt=$.videos)!=null&&Vt.length)&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:Ut=>{Ut.stopPropagation(),Ze($)}},React.createElement("i",{className:"fas fa-edit"})," S\u1EEDa"),React.createElement("button",{className:"btn btn-outline-danger",onClick:Ut=>{Ut.stopPropagation(),At($)}},React.createElement("i",{className:"fas fa-trash"})," X\xF3a")))))})),React.createElement(VideoFolderModal,{show:We,folder:Be,onClose:()=>st(!1),onSave:Je}))}function VideoFolderModal({show:_,folder:D,onClose:L,onSave:be}){const[te,X]=useState({name:"",description:"",sortOrder:0,coverImage:""}),[q,Oe]=useState(!1),[Fe,we]=useState(!1);useEffect(()=>{X(D?{name:D.name||"",description:D.description||"",sortOrder:D.sortOrder||0,coverImage:D.coverImage||""}:{name:"",description:"",sortOrder:0,coverImage:""})},[D,_]);const We=async Be=>{const Xe=Be.target.files[0];if(Xe){we(!0);try{const ve=await window.KTM.cloudinary.uploadImage({file:Xe,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});ve.secure_url&&X(Ee=>({...Ee,coverImage:ve.secure_url})),window.KTM.cache.remove(CACHE_KEY),showToast("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),setShowQuickEdit(!1),setEditingItem(null),loadAllData()}catch(ve){console.error("Cloudinary upload error:",ve),alert("L\u1ED7i upload \u1EA3nh: "+(ve.message||ve))}finally{we(!1)}}},st=async Be=>{Be.preventDefault(),Oe(!0);const Xe={...te,variants:normalizeVariants(te.variants,te.price),attributes:normalizeAttributes(te.attributes)};await be(Xe),Oe(!1)};return _?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},D?"S\u1EEDa Folder":"T\u1EA1o Folder m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:L})),React.createElement("form",{onSubmit:st},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn folder *"),React.createElement("input",{type:"text",className:"form-control",value:te.name,onChange:Be=>X({...te,name:Be.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",value:te.description,onChange:Be=>X({...te,description:Be.target.value}),rows:"2"})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:te.sortOrder,onChange:Be=>X({...te,sortOrder:parseInt(Be.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex align-items-start gap-3"},te.coverImage?React.createElement("div",{className:"position-relative"},React.createElement("img",{src:te.coverImage,alt:"Cover",className:"rounded",style:{width:120,height:80,objectFit:"cover"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute top-0 end-0",onClick:()=>X({...te,coverImage:""}),style:{transform:"translate(30%, -30%)"}},React.createElement("i",{className:"fas fa-times"}))):React.createElement("div",{className:"bg-light rounded d-flex align-items-center justify-content-center text-muted",style:{width:120,height:80}},React.createElement("i",{className:"fas fa-image fa-2x"})),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{type:"file",className:"form-control form-control-sm",accept:"image/*,image/jpeg,image/png,image/gif,image/webp",onChange:We,disabled:Fe}),Fe&&React.createElement("div",{className:"mt-1 text-muted small"},React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang upload..."),React.createElement("div",{className:"mt-1 text-muted small"},"Ho\u1EB7c d\xE1n URL:"),React.createElement("input",{type:"url",className:"form-control form-control-sm",placeholder:"https://...",value:te.coverImage,onChange:Be=>X({...te,coverImage:Be.target.value})}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:L},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:q},q?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function ProductManager({showToast:_,settings:D}){const[L,be]=useState([]),[te,X]=useState(!0),[q,Oe]=useState(!1),[Fe,we]=useState(null),[We,st]=useState(""),[Be,Xe]=useState(""),[ve,Ee]=useState(!1),[F,ht]=useState(null),St=normalizeShipPercent(D==null?void 0:D.ship_percent),{parseMoney:Ct,formatVND:Ve}=window.KTM.money,at=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"];useEffect(()=>{Re()},[]);const Re=async()=>{X(!0);try{const N=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");be(Array.isArray(N)?N:[])}catch(N){console.error(N),_("L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m","danger")}X(!1)},yt=()=>{we(null),Oe(!0)},Et=N=>{we(N),Oe(!0)},an=N=>{N&&(ht(N),Ee(!0))},et=()=>{Ee(!1)},Pt=async N=>{if(!(!N||!N.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:N},"L\u1ED7i x\xF3a \u1EA3nh"),window.KTM.cache.remove(CACHE_KEY),_(`\u0110\xE3 x\xF3a ${typeName}`,"success"),loadAllData(),Re()}catch(j){_("L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m","danger")}},Xt=async N=>{try{const j=Fe?`${API_BASE}/api/products?id=${Fe.id}`:`${API_BASE}/api/products`;Fe?await window.KTM.api.putJSON(j,N,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(j,N,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),_(Fe?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Oe(!1),Re()}catch(j){_(j.message,"danger")}},C=async N=>{if(confirm(`B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n x\xF3a s\u1EA3n ph\u1EA9m "${N.name}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/products?id=${N.id}`,"L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m"),_("X\xF3a s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Re()}catch(j){_(j.message,"danger")}},S=L.filter(N=>{const j=!We||N.name.toLowerCase().includes(We.toLowerCase())||N.code&&N.code.toLowerCase().includes(We.toLowerCase()),J=!Be||N.category===Be;return j&&J}),B=N=>{var ae;const j=(ae=N==null?void 0:N.commission_percent)!=null?ae:N==null?void 0:N.commissionPercent,J=j===""||j==null?NaN:Number(j);return Number.isFinite(J)?Math.max(0,Math.min(100,J)):5},fe=N=>{const j=B(N),J=Number.isInteger(j)?String(j):String(Math.round(j*100)/100),ae=Ct(N==null?void 0:N.price);if(!Number.isFinite(ae)||ae<=0)return`${J}%`;const $e=(Number(j)||0)/100,Ze=window.KTM.money.parseShipFeeFromNote(N==null?void 0:N.note)!=null?0:St>0?ae*St/100:0,Je=ae*$e-Ze*$e,At=Math.max(0,Math.round(Je));return`${J}% - ${Ve(At)}`},ge=N=>{if(N==null||N==="")return[];let j=N;if(typeof j=="string"){const J=j.trim();if(!J)return[];try{j=JSON.parse(J)}catch(ae){return[]}}return Array.isArray(j)?j:[]},oe=N=>{if(N==null||N==="")return[];let j=N;if(typeof j=="string"){const J=j.trim();if(!J)return[];try{j=JSON.parse(J)}catch(ae){return[]}}return j&&typeof j=="object"&&!Array.isArray(j)&&(j=Object.entries(j).map(([J,ae])=>({key:J,value:ae}))),Array.isArray(j)?j:[]},le=N=>{const j=oe(N).map(J=>{var ae,$e,ke,Ze,Je;return{key:String((ke=($e=(ae=J==null?void 0:J.key)!=null?ae:J==null?void 0:J.name)!=null?$e:J==null?void 0:J.label)!=null?ke:"").trim(),value:String((Ze=J==null?void 0:J.value)!=null?Ze:"").trim(),unit:String((Je=J==null?void 0:J.unit)!=null?Je:"").trim()}}).filter(J=>!!J.key);return j.length?React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},j.map((J,ae)=>{const $e=J.key,ke=`${J.value||""}${J.unit?(J.value?" ":"")+J.unit:""}`.trim();return React.createElement("div",{key:`${$e}-${ae}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},$e),ke?React.createElement("span",{className:"ktm-chip ktm-chip-option"},ke):null)}))):null},Te=(N,j={})=>{const J=ge(N).map(Ze=>{var Je;return{name:String((Je=Ze==null?void 0:Ze.name)!=null?Je:"").trim(),options:Array.isArray(Ze==null?void 0:Ze.options)?Ze.options:[]}}).map(Ze=>({...Ze,options:Ze.options.map(Je=>{var At;return{label:String((At=Je==null?void 0:Je.label)!=null?At:"").trim(),price:Number(Je==null?void 0:Je.price)}}).filter(Je=>!!Je.label)})).filter(Ze=>Ze.options.length>0);if(!J.length)return null;const ae=Number.isFinite(j.maxGroups)?Math.max(1,Math.trunc(j.maxGroups)):J.length,$e=Number.isFinite(j.maxOptionsPerGroup)?Math.max(1,Math.trunc(j.maxOptionsPerGroup)):4,ke=J.slice(0,ae);return React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},ke.map((Ze,Je)=>{const At=Ze.name||"Bi\u1EBFn th\u1EC3",Kt=Ze.options.slice(0,$e),Me=Ze.options.length-Kt.length;return React.createElement("div",{key:`${At}-${Je}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},At),Kt.map((ct,en)=>{const _t=ct.price,ln=Number.isFinite(_t)&&_t>=0?Ve(Math.trunc(_t)):"",Ft=ln?`${ct.label} \xB7 ${ln}`:ct.label;return React.createElement("span",{key:`${At}-${Je}-${en}`,className:"ktm-chip ktm-chip-option"},Ft)}),Me>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",Me))})))};return React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",null,React.createElement("i",{className:"fas fa-box me-2"}),"S\u1EA3n ph\u1EA9m"),React.createElement("button",{className:"btn-add-product",onClick:yt},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"d-flex gap-2 mb-2"},React.createElement("div",{className:"flex-grow-1 position-relative"},React.createElement("input",{type:"text",className:"form-control",placeholder:"\u{1F50D} T\xECm s\u1EA3n ph\u1EA9m...",value:We,onChange:N=>st(N.target.value)})),React.createElement("span",{className:"product-count"},S.length)),React.createElement("select",{className:"form-select",value:Be,onChange:N=>Xe(N.target.value)},React.createElement("option",{value:""},"\u{1F4C1} T\u1EA5t c\u1EA3 danh m\u1EE5c"),at.map(N=>React.createElement("option",{key:N,value:N},N)))),te?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"2.5rem",height:"2.5rem"}}),React.createElement("p",{className:"text-muted mt-3 mb-0"},"\u0110ang t\u1EA3i...")):S.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-box-open"}),React.createElement("p",null,"Ch\u01B0a c\xF3 s\u1EA3n ph\u1EA9m n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:yt},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"product-list"},S.map(N=>React.createElement("div",{key:N.id,className:"product-item d-flex align-items-center gap-3",role:"button",tabIndex:0,onClick:()=>an(N),onKeyDown:j=>{(j.key==="Enter"||j.key===" ")&&(j.preventDefault(),an(N))},title:"Xem chi ti\u1EBFt"},N.image?React.createElement("img",{src:N.image,alt:"",className:"product-img"}):React.createElement("div",{className:"product-img-placeholder"},React.createElement("i",{className:"fas fa-image text-muted"})),React.createElement("div",{className:"flex-grow-1 min-width-0"},React.createElement("div",{className:"product-name"},N.name),React.createElement("div",{className:"d-flex flex-wrap gap-1 mb-1"},N.category&&React.createElement("span",{className:"product-badge bg-info bg-opacity-75"},N.category),N.code&&React.createElement("span",{className:"product-badge bg-secondary"},N.code),React.createElement("span",{className:"product-badge bg-warning text-dark",title:"Hoa h\u1ED3ng (%)"},React.createElement("i",{className:"fas fa-percent me-1"}),fe(N))),React.createElement("div",{className:"product-price"},N.price?N.price.replace(/[đ\s]/g,"")+"\u0111":"Li\xEAn h\u1EC7"),N.note&&React.createElement("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"}},N.note),le(N.attributes)&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},le(N.attributes)),Te(N.variants,{maxOptionsPerGroup:4})&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},Te(N.variants,{maxOptionsPerGroup:4}))),React.createElement("div",{className:"product-actions"},React.createElement("button",{className:"btn btn-edit",onClick:j=>{j.stopPropagation(),Et(N)},title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"btn btn-delete",onClick:j=>{j.stopPropagation(),C(N)},title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement(AdminDrawer,{open:ve,title:String((F==null?void 0:F.name)||"S\u1EA3n ph\u1EA9m"),subtitle:[String((F==null?void 0:F.code)||"").trim()||null,String((F==null?void 0:F.category)||"").trim()||null].filter(Boolean).join(" \u2022 "),onClose:et,footer:React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{const N=String((F==null?void 0:F.code)||"").trim();N&&window.KTM.clipboard.writeText(N).then(()=>_("\u0110\xE3 copy m\xE3 s\u1EA3n ph\u1EA9m","success"))},disabled:!String((F==null?void 0:F.code)||"").trim(),title:"Copy m\xE3"},React.createElement("i",{className:"fas fa-barcode me-2"}),"Copy m\xE3"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{const N=String((F==null?void 0:F.price)||"").trim();N&&window.KTM.clipboard.writeText(N).then(()=>_("\u0110\xE3 copy gi\xE1","success"))},disabled:!String((F==null?void 0:F.price)||"").trim(),title:"Copy gi\xE1"},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy gi\xE1")),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>F&&Et(F),disabled:!F},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>F&&C(F),disabled:!F},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a")))},F?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"T\u1ED5ng quan"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"Gi\xE1"),React.createElement("div",{className:"v"},(()=>{const N=String((F==null?void 0:F.price)||"").trim(),j=Ct(N);return Number.isFinite(j)&&j>0?Ve(Math.trunc(j)):N||"Li\xEAn h\u1EC7"})()),React.createElement("div",{className:"k"},"Hoa h\u1ED3ng"),React.createElement("div",{className:"v"},fe(F)),React.createElement("div",{className:"k"},"Danh m\u1EE5c"),React.createElement("div",{className:"v"},F.category||"\u2014"),React.createElement("div",{className:"k"},"M\xE3"),React.createElement("div",{className:"v"},React.createElement("span",{className:"font-monospace"},F.code||"\u2014")))),React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-image me-2 text-info"}),"H\xECnh \u1EA3nh"),F.image?React.createElement("img",{src:F.image,alt:"",className:"rounded",style:{width:"100%",maxHeight:260,objectFit:"cover"}}):React.createElement("div",{className:"text-muted"},"Ch\u01B0a c\xF3 \u1EA3nh")),(String(F.note||"").trim()||F.attributes||F.variants)&&React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-sliders-h me-2 text-primary"}),"Chi ti\u1EBFt"),String(F.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",String(F.note||"").trim()),le(F.attributes)?React.createElement("div",{className:"mt-2"},le(F.attributes)):null,Te(F.variants,{maxGroups:99,maxOptionsPerGroup:8})?React.createElement("div",{className:"mt-2"},Te(F.variants,{maxGroups:99,maxOptionsPerGroup:8})):null)):React.createElement("div",{className:"text-muted"},"Ch\u01B0a c\xF3 d\u1EEF li\u1EC7u")),React.createElement(ProductModal,{show:q,product:Fe,categories:at,onClose:()=>Oe(!1),onSave:Xt}))}function ProductModal({show:_,product:D,categories:L,onClose:be,onSave:te}){const[X,q]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[Oe,Fe]=useState(!1),[we,We]=useState(!1),st=C=>{const S=window.KTM.money.getDigits(String(C!=null?C:"")),B=Number(S);return S&&Number.isFinite(B)?Math.trunc(B):0},Be=C=>{if(C==null||C==="")return[];let S=C;if(typeof S=="string"){const B=S.trim();if(!B)return[];try{S=JSON.parse(B)}catch(fe){return[]}}return S&&typeof S=="object"&&!Array.isArray(S)&&(S=Object.entries(S).map(([B,fe])=>({key:B,value:fe}))),Array.isArray(S)?S.map(B=>{var le,Te,N,j,J;if(!B||typeof B!="object")return null;const fe=String((N=(Te=(le=B.key)!=null?le:B.name)!=null?Te:B.label)!=null?N:"").trim(),ge=String((j=B.value)!=null?j:"").trim(),oe=String((J=B.unit)!=null?J:"").trim();return fe?{key:fe,value:ge,unit:oe}:null}).filter(Boolean):[]},Xe=(C,S)=>{if(C==null||C==="")return[];let B=C;if(typeof B=="string"){const ge=B.trim();if(!ge)return[];try{B=JSON.parse(ge)}catch(oe){return[]}}if(!Array.isArray(B))return[];const fe=st(S);return B.map(ge=>{var Te;if(!ge||typeof ge!="object")return null;const oe=String((Te=ge.name)!=null?Te:"").trim(),le=(Array.isArray(ge.options)?ge.options:[]).map(N=>{var Ze,Je,At,Kt,Me,ct,en;if(!N||typeof N!="object")return null;const j=String((Ze=N.label)!=null?Ze:"").trim();if(!j)return null;const J=(Me=(Kt=(At=(Je=N.price)!=null?Je:N.priceValue)!=null?At:N.unit_price)!=null?Kt:N.unitPrice)!=null?Me:null,ae=Number(J);let $e=Number.isFinite(ae)?Math.trunc(ae):null;if($e==null){const _t=(en=(ct=N.price_delta)!=null?ct:N.priceDelta)!=null?en:null,ln=Number(_t);Number.isFinite(ln)&&($e=fe+Math.trunc(ln))}$e==null&&($e=fe);const ke=String(Math.max(0,Math.trunc(Number($e)||0)));return{label:j,price:Math.max(0,Math.trunc(Number($e)||0)),priceDigits:ke}}).filter(Boolean);return{name:oe||"Bi\u1EBFn th\u1EC3",options:le}}).filter(Boolean)};useEffect(()=>{var C,S;q(D?{name:D.name||"",code:D.code||"",price:D.price||"",image:D.image||"",category:D.category||"",note:D.note||"",sort_order:D.sort_order||0,commission_percent:(S=(C=D.commission_percent)!=null?C:D.commissionPercent)!=null?S:5,variants:Xe(D.variants,D.price),attributes:Be(D.attributes)}:{name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]})},[D,_]);const ve=C=>{q(S=>{var le;const B=st(S.price),fe=String(B),ge=Array.isArray(S.variants)?[...S.variants]:[],oe={...ge[C]||{},options:Array.isArray((le=ge[C])==null?void 0:le.options)?[...ge[C].options]:[]};return oe.options=oe.options.map(Te=>({label:String((Te==null?void 0:Te.label)||""),price:B,priceDigits:fe})),ge[C]=oe,{...S,variants:ge}})},Ee=()=>{q(C=>{const S=st(C.price),B=String(S),ge=(Array.isArray(C.variants)?[...C.variants]:[]).map(oe=>{const le=(Array.isArray(oe==null?void 0:oe.options)?oe.options:[]).map(Te=>({label:String((Te==null?void 0:Te.label)||""),price:S,priceDigits:B}));return{name:String((oe==null?void 0:oe.name)||"Bi\u1EBFn th\u1EC3"),options:le}});return{...C,variants:ge}})},[F,ht]=React.useState(""),St=C=>window.KTM.money.formatVNDInputDigits(C),[Ct,Ve]=React.useState(""),at=C=>{const S=window.KTM.money.nextPriceInputState(C.target.value,Ct);Ve(S.digits),q({...X,price:S.price})},[Re,yt]=React.useState("");React.useEffect(()=>{D!=null&&D.image&&yt(D.image)},[D]);const Et=async C=>{if(!(!C||!C.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:C},"L\u1ED7i x\xF3a \u1EA3nh")}catch(S){console.error("Delete cloudinary image error:",S)}},an=async(C,S=2,B)=>{const fe=S*1024*1024,ge=C.type==="image/heic"||C.type==="image/heif"||/\.heic$/i.test(C.name);if(C.size<=fe&&!ge)return C;B==null||B("\u0110ang x\u1EED l\xFD \u1EA3nh...");try{const oe=await createImageBitmap(C);B==null||B("\u0110ang n\xE9n \u1EA3nh...");const le=document.createElement("canvas");let Te=oe.width,N=oe.height;const j=1200;return(Te>j||N>j)&&(Te>N?(N=Math.round(N/Te*j),Te=j):(Te=Math.round(Te/N*j),N=j)),le.width=Te,le.height=N,le.getContext("2d").drawImage(oe,0,0,Te,N),oe.close(),new Promise((ae,$e)=>{le.toBlob(ke=>{ke?(B==null||B("Ho\xE0n t\u1EA5t!"),ae(new File([ke],C.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"}))):$e(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(oe){throw console.error("createImageBitmap error:",oe),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},et=async C=>{var fe,ge;const S=(fe=C.target.files)==null?void 0:fe[0];if(!S)return;if(!(S.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(S.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}We(!0),ht("\u0110ang chu\u1EA9n b\u1ECB...");try{const oe=(S.size/1024/1024).toFixed(1);ht(`File ${oe}MB - \u0110ang n\xE9n...`);const le=await an(S,2,j=>{ht(j)}),Te=(le.size/1024/1024).toFixed(1);ht(`\u0110\xE3 n\xE9n: ${Te}MB - \u0110ang upload...`);const N=await window.KTM.cloudinary.uploadImage({file:le,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});N.secure_url?(X.image&&X.image!==Re&&Et(X.image),q(j=>({...j,image:N.secure_url})),ht("")):(console.error("Cloudinary error:",N),alert("Upload th\u1EA5t b\u1EA1i: "+(((ge=N.error)==null?void 0:ge.message)||"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh")),ht(""))}catch(oe){console.error("Upload error:",oe),alert("L\u1ED7i: "+oe.message),ht("")}We(!1),C.target.value=""},Pt=()=>{X.image&&(X.image!==Re&&Et(X.image),q(C=>({...C,image:""})))},Xt=async C=>{C.preventDefault(),Fe(!0),Re&&X.image&&Re!==X.image&&await Et(Re),Re&&!X.image&&await Et(Re),await te(X),Fe(!1)};return _?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down"},React.createElement("div",{className:"modal-content",style:{borderRadius:"16px",overflow:"hidden"}},React.createElement("div",{className:"modal-header border-0 py-3",style:{background:"linear-gradient(135deg, #ffc107 0%, #ffca2c 100%)"}},React.createElement("h6",{className:"modal-title fw-bold",style:{color:"#1a1a2e"}},React.createElement("i",{className:`fas ${D?"fa-edit":"fa-plus-circle"} me-2`}),D?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:be})),React.createElement("form",{onSubmit:Xt},React.createElement("div",{className:"modal-body py-4",style:{maxHeight:"65vh",overflowY:"auto",background:"#f8f9fa"}},React.createElement("div",{className:"text-center mb-4"},React.createElement("div",{className:"position-relative d-inline-block"},X.image?React.createElement(React.Fragment,null,React.createElement("img",{src:X.image,alt:"",style:{width:110,height:110,objectFit:"cover",borderRadius:"12px",boxShadow:"0 4px 15px rgba(0,0,0,0.15)"}}),React.createElement("button",{type:"button",className:"btn btn-danger position-absolute",onClick:Pt,style:{top:-10,right:-10,width:28,height:28,padding:0,borderRadius:"50%",boxShadow:"0 2px 8px rgba(220,53,69,0.4)"}},React.createElement("i",{className:"fas fa-times",style:{fontSize:"0.75rem"}}))):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:110,height:110,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd"}},React.createElement("i",{className:"fas fa-image fa-2x text-muted"}))),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"btn btn-warning btn-sm px-3",style:{borderRadius:"20px"}},React.createElement("i",{className:`fas ${we?"fa-spinner fa-spin":"fa-camera"} me-1`}),we?F||"\u0110ang x\u1EED l\xFD...":"Ch\u1ECDn \u1EA3nh",React.createElement("input",{type:"file",accept:"image/*",onChange:et,disabled:we,style:{position:"absolute",left:"-9999px",opacity:0,width:1,height:1}})),we&&F&&React.createElement("div",{className:"text-center mt-1",style:{fontSize:11,color:"#6c757d"}},F))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-tag me-1 text-warning"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:X.name,onChange:C=>q({...X,name:C.target.value}),required:!0,placeholder:"VD: Combo Van 3 tay + 2 xylanh",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-barcode me-1 text-info"}),"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:X.code,onChange:C=>q({...X,code:C.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1 text-success"}),"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:X.price,onChange:at,placeholder:"1.950.000\u0111",inputMode:"numeric",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-percent me-1 text-secondary"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:X.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:C=>q({...X,commission_percent:C.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-folder me-1 text-primary"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:X.category,onChange:C=>q({...X,category:C.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),L.map(C=>React.createElement("option",{key:C,value:C},C)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1 text-secondary"}),"Ghi ch\xFA"),React.createElement("input",{type:"text",className:"form-control",value:X.note,onChange:C=>q({...X,note:C.target.value}),placeholder:"VD: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1 text-secondary"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(X.attributes)?X.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(X.attributes)?X.attributes:[]).map((C,S)=>React.createElement("div",{key:S,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(C==null?void 0:C.key)||"",onChange:B=>{const fe=B.target.value;q(ge=>{const oe=Array.isArray(ge.attributes)?[...ge.attributes]:[];return oe[S]={...oe[S]||{},key:fe},{...ge,attributes:oe}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(C==null?void 0:C.value)||"",onChange:B=>{const fe=B.target.value;q(ge=>{const oe=Array.isArray(ge.attributes)?[...ge.attributes]:[];return oe[S]={...oe[S]||{},value:fe},{...ge,attributes:oe}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(C==null?void 0:C.unit)||"",onChange:B=>{const fe=B.target.value;q(ge=>{const oe=Array.isArray(ge.attributes)?[...ge.attributes]:[];return oe[S]={...oe[S]||{},unit:fe},{...ge,attributes:oe}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{q(B=>{const fe=Array.isArray(B.attributes)?[...B.attributes]:[];return fe.splice(S,1),{...B,attributes:fe}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{q(C=>{const S=Array.isArray(C.attributes)?[...C.attributes]:[];return S.push({key:"",value:"",unit:""}),{...C,attributes:S}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1 text-secondary"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(X.variants)?X.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3."):null,(Array.isArray(X.variants)?X.variants:[]).map((C,S)=>React.createElement("div",{key:S,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(C==null?void 0:C.name)||"",onChange:B=>{const fe=B.target.value;q(ge=>{var le;const oe=Array.isArray(ge.variants)?[...ge.variants]:[];return oe[S]={...oe[S]||{},name:fe,options:Array.isArray((le=oe[S])==null?void 0:le.options)?oe[S].options:[]},{...ge,variants:oe}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>ve(S),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(C==null?void 0:C.options)||C.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{q(B=>{const fe=Array.isArray(B.variants)?[...B.variants]:[];return fe.splice(S,1),{...B,variants:fe}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(C==null?void 0:C.options)?C.options:[]).map((B,fe)=>{var ge,oe;return React.createElement("div",{key:fe,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(B==null?void 0:B.label)||"",onChange:le=>{const Te=le.target.value;q(N=>{var ke,Ze,Je,At,Kt;const j=Array.isArray(N.variants)?[...N.variants]:[],J={...j[S]||{},options:Array.isArray((ke=j[S])==null?void 0:ke.options)?[...j[S].options]:[]},ae=Number((Je=(Ze=J.options[fe])==null?void 0:Ze.price)!=null?Je:0)||0,$e=String((Kt=(At=J.options[fe])==null?void 0:At.priceDigits)!=null?Kt:Math.max(0,Math.trunc(ae)));return J.options[fe]={...J.options[fe]||{},label:Te,price:Math.max(0,Math.trunc(ae)),priceDigits:$e},j[S]=J,{...N,variants:j}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:St(String((oe=B==null?void 0:B.priceDigits)!=null?oe:window.KTM.money.getDigits(String((ge=B==null?void 0:B.price)!=null?ge:"")))),onChange:le=>{q(Te=>{var Je,At,Kt,Me,ct;const N=String((At=B==null?void 0:B.priceDigits)!=null?At:window.KTM.money.getDigits(String((Je=B==null?void 0:B.price)!=null?Je:""))),j=window.KTM.money.nextPriceInputState(le.target.value,N),J=String((Kt=j.digits)!=null?Kt:""),ae=Number(J),$e=Number.isFinite(ae)?Math.max(0,Math.trunc(ae)):0,ke=Array.isArray(Te.variants)?[...Te.variants]:[],Ze={...ke[S]||{},options:Array.isArray((Me=ke[S])==null?void 0:Me.options)?[...ke[S].options]:[]};return Ze.options[fe]={...Ze.options[fe]||{},label:String(((ct=Ze.options[fe])==null?void 0:ct.label)||""),price:$e,priceDigits:J},ke[S]=Ze,{...Te,variants:ke}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{q(le=>{var j;const Te=Array.isArray(le.variants)?[...le.variants]:[],N={...Te[S]||{},options:Array.isArray((j=Te[S])==null?void 0:j.options)?[...Te[S].options]:[]};return N.options.splice(fe,1),Te[S]=N,{...le,variants:Te}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{q(B=>{var le;const fe=Array.isArray(B.variants)?[...B.variants]:[],ge={...fe[S]||{},options:Array.isArray((le=fe[S])==null?void 0:le.options)?[...fe[S].options]:[]},oe=st(B.price);return ge.options.push({label:"",price:oe,priceDigits:String(oe)}),fe[S]=ge,{...B,variants:fe}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{q(C=>{const S=st(C.price),B=Array.isArray(C.variants)?[...C.variants]:[],fe=String(S);return B.push({name:"Size",options:[{label:"S",price:S,priceDigits:fe},{label:"M",price:S,priceDigits:fe},{label:"L",price:S,priceDigits:fe}]}),{...C,variants:B}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:Ee,disabled:!Array.isArray(X.variants)||X.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111."))),React.createElement("div",{className:"mb-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"URL \u1EA3nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",placeholder:"https://...",value:X.image,onChange:C=>q({...X,image:C.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"10px",fontSize:"0.9rem"}}))),React.createElement("div",{className:"modal-footer border-0 py-3",style:{background:"#fff"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:be,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:Oe,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},Oe?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}function VideoModal({show:_,video:D,onClose:L,onSave:be}){const[te,X]=useState({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),[q,Oe]=useState(!1),[Fe,we]=useState("");useEffect(()=>{D?(X({title:D.title||"",youtube_url:`https://www.youtube.com/watch?v=${D.youtubeId}`,thumbnail_url:D.thumb||"",sort_order:D.sortOrder||0}),we(D.thumb)):(X({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),we(""))},[D,_]);const We=Xe=>{const ve=Xe.match(/(?:youtube\.com\/(?:embed\/|watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return ve?ve[1]:null},st=Xe=>{X({...te,youtube_url:Xe});const ve=We(Xe);ve&&we(`https://img.youtube.com/vi/${ve}/hqdefault.jpg`)},Be=async Xe=>{Xe.preventDefault(),Oe(!0),await be(te),Oe(!1)};return _?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},D?"S\u1EEDa Video":"Th\xEAm Video m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:L})),React.createElement("form",{onSubmit:Be},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Link YouTube *"),React.createElement("input",{type:"url",className:"form-control",value:te.youtube_url,onChange:Xe=>st(Xe.target.value),placeholder:"https://www.youtube.com/watch?v=... ho\u1EB7c shorts/...",required:!0}),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3: youtube.com/watch, youtu.be, youtube.com/shorts")),Fe&&React.createElement("div",{className:"mb-3 text-center"},React.createElement("img",{src:Fe,alt:"Preview",className:"img-fluid rounded",style:{maxHeight:"150px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ti\xEAu \u0111\u1EC1 *"),React.createElement("input",{type:"text",className:"form-control",value:te.title,onChange:Xe=>X({...te,title:Xe.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:te.sort_order,onChange:Xe=>X({...te,sort_order:parseInt(Xe.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Thumbnail t\xF9y ch\u1EC9nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",value:te.thumbnail_url,onChange:Xe=>X({...te,thumbnail_url:Xe.target.value}),placeholder:"\u0110\u1EC3 tr\u1ED1ng s\u1EBD d\xF9ng thumbnail m\u1EB7c \u0111\u1ECBnh c\u1EE7a YouTube"}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:L},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:q},q?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function getCurrentMonth(){const _=new Date,D=_.getFullYear(),L=String(_.getMonth()+1).padStart(2,"0");return`${D}-${L}`}function ReconExcelManager({showToast:_}){var ut;const D=typeof _=="function"?_:()=>{},[L,be]=useState(getCurrentMonth()),te=L,X=be,[q,Oe]=useState(!1),[Fe,we]=useState(""),[We,st]=useState(""),[Be,Xe]=useState(""),[ve,Ee]=useState(null),[F,ht]=useState("all"),[St,Ct]=useState(""),[Ve,at]=useState(!0),[Re,yt]=useState(!0),[Et,an]=useState(!1),[et,Pt]=useState("created_at"),[Xt,C]=useState(!1),[S,B]=useState(0),[fe,ge]=useState(!1),[oe,le]=useState(""),[Te,N]=useState(()=>new Set),[j,J]=useState(!1),[ae,$e]=useState(null),ke=useRef(new Map),Ze=useRef(new Map),Je=useRef(null),[At,Kt]=useState(()=>{var i;return(i=window==null?void 0:window.XLSX)!=null&&i.read?"ready":"loading"}),Me=i=>new Promise((c,x)=>{var g;try{if(!i)return c();const A=String(i),H=document.querySelector(`script[data-ktm-src="${A}"]`)||document.querySelector(`script[src="${A}"]`);if(H){if(H.getAttribute("data-ktm-loaded")==="1"||(g=window==null?void 0:window.XLSX)!=null&&g.read)return c();H.addEventListener("load",()=>c(),{once:!0}),H.addEventListener("error",()=>x(new Error(`Failed to load ${A}`)),{once:!0});return}const E=document.createElement("script");E.src=A,E.async=!0,E.defer=!0,E.setAttribute("data-ktm-src",A),E.addEventListener("load",()=>{E.setAttribute("data-ktm-loaded","1"),c()},{once:!0}),E.addEventListener("error",()=>x(new Error(`Failed to load ${A}`)),{once:!0}),document.head.appendChild(E)}catch(A){x(A)}}),ct=()=>!!(window!=null&&window.XLSX&&typeof window.XLSX.read=="function"),en=async()=>{if(ct())return Kt("ready"),!0;if(Je.current)return Je.current;const i=["https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js","https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js","https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"],c=async x=>{const g=Date.now();for(;Date.now()-g<x;){if(ct())return!0;await new Promise(A=>setTimeout(A,50))}return ct()};return Kt("loading"),Je.current=(async()=>{try{for(const x of i)try{if(await Me(x),await c(1500))return Kt("ready"),!0}catch(g){}return Kt("failed"),!1}finally{Je.current=null}})(),Je.current};useEffect(()=>{if(ct()){Kt("ready");return}en()},[]);const _t=i=>{const c=[],x=String(i!=null?i:"").split(/\s+/g);for(const g of x){const A=String(g||"").trim();A&&c.push(A)}return c.join(" ").replace(/\s+/g," ").trim()},ln=i=>{try{return String(i!=null?i:"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,c=>c==="\u0111"?"d":"D")}catch(c){return String(i!=null?i:"").replace(/[đĐ]/g,x=>x==="\u0111"?"d":"D")}},Ft=i=>{const c=_t(String(i!=null?i:""));return c?ln(c).toLowerCase().replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim():""},pn=i=>{const c=Ft(i);return c?c.replace(/\b(combo|set|sp|san\s*pham|sanpham|hang|ship|freeship|free\s*ship)\b/g," ").replace(/\s+/g," ").trim():""},bn=i=>{var H,E;if(i==null||i==="")return"";if(typeof i=="number"&&Number.isFinite(i)&&((E=(H=window==null?void 0:window.XLSX)==null?void 0:H.SSF)!=null&&E.parse_date_code))try{const h=window.XLSX.SSF.parse_date_code(i);return!h||!h.y||!h.m?"":`${String(h.y).padStart(4,"0")}-${String(h.m).padStart(2,"0")}`}catch(h){}const c=String(i).trim(),x=c.match(/^(\d{1,2})[\.\/\-](\d{1,2})[\.\/\-](\d{4})$/);if(x){const h=String(Number(x[2])||0).padStart(2,"0");return`${x[3]}-${h}`}const g=c.match(/^(\d{4})-(\d{2})-(\d{2})/);if(g)return`${g[1]}-${g[2]}`;const A=new Date(c);return Number.isNaN(A.getTime())?"":`${A.getFullYear()}-${String(A.getMonth()+1).padStart(2,"0")}`},$=i=>{var H,E;if(i==null||i==="")return"";if(typeof i=="number"&&Number.isFinite(i)&&((E=(H=window==null?void 0:window.XLSX)==null?void 0:H.SSF)!=null&&E.parse_date_code))try{const h=window.XLSX.SSF.parse_date_code(i);return!h||!h.y||!h.m||!h.d?"":`${String(h.y).padStart(4,"0")}-${String(h.m).padStart(2,"0")}-${String(h.d).padStart(2,"0")}`}catch(h){}const c=String(i).trim(),x=c.match(/^(\d{1,2})[\.\/\-](\d{1,2})[\.\/\-](\d{4})$/);if(x){const h=String(Number(x[1])||0).padStart(2,"0"),k=String(Number(x[2])||0).padStart(2,"0");return`${x[3]}-${k}-${h}`}const g=c.match(/^(\d{4})-(\d{2})-(\d{2})/);if(g)return`${g[1]}-${g[2]}-${g[3]}`;const A=new Date(c);return Number.isNaN(A.getTime())?"":`${A.getFullYear()}-${String(A.getMonth()+1).padStart(2,"0")}-${String(A.getDate()).padStart(2,"0")}`},ne=i=>{if(i==null||i==="")return 0;if(typeof i=="number"&&Number.isFinite(i))return Math.trunc(i);const c=String(i!=null?i:"").trim();if(!c)return 0;try{const H=window.KTM.money.parseMoney(c);if(Number.isFinite(H)&&H>0)return Math.trunc(H)}catch(H){}const g=c.toLowerCase().replace(/vnd|đ|d/g," ").replace(/\s+/g," ").trim().replace(/[^0-9]/g,"");if(!g)return 0;const A=Number(g);return Number.isFinite(A)?Math.trunc(A):0},tt=i=>{var x,g;let c="";try{(g=(x=window==null?void 0:window.KTM)==null?void 0:x.phone)!=null&&g.normalize&&(c=window.KTM.phone.normalize(i))}catch(A){}return c||(c=String(i!=null?i:"").replace(/[^0-9]/g,"")),c=String(c||"").replace(/[^0-9]/g,""),c?(c.startsWith("840")?c=`0${c.slice(3)}`:c.startsWith("84")&&(c.length===11?c=`0${c.slice(2)}`:c.length===12&&c[2]!=="0"&&(c=`0${c.slice(2)}`)),c.length===9&&(c=`0${c}`),c):""},Bt=(i,c)=>{try{const x=Array.isArray(c)?c:[],g=k=>{const T=String(k!=null?k:"");return/[\n\r",]/.test(T)?`"${T.replace(/"/g,'""')}"`:T},A=x.map(k=>Array.isArray(k)?k.map(g).join(","):"").join(`
`),H=new Blob([`\uFEFF${A}`],{type:"text/csv;charset=utf-8"}),E=URL.createObjectURL(H),h=document.createElement("a");h.href=E,h.download=i,document.body.appendChild(h),h.click(),setTimeout(()=>{try{URL.revokeObjectURL(E)}catch(k){}try{h.remove()}catch(k){}},0)}catch(x){}},hn=i=>{const c=String(i!=null?i:"");if(!c.trim())return{phone:"",phoneNorm:"",cleanedText:String(i!=null?i:"").trim()};const x=/(?:\+?84|0)\s*[0-9\s\-.()]{8,16}/g;let g=null,A;for(;(A=x.exec(c))!=null;){const k=A[0],T=tt(k);T&&(T.length<9||T.length>12||(g={raw:k,digits:T}))}if(!g){const k=tt(c);if(k.length>=9){const T=k.slice(-12);T.length>=9&&(g={raw:T,digits:T})}}if(!g)return{phone:"",phoneNorm:"",cleanedText:c.trim()};const H=g.digits,E=H;let h=c;return g.raw&&c.includes(g.raw)?h=h.replace(g.raw," "):h=h.replace(new RegExp(`${g.digits}$`)," "),h=h.replace(/[\-–—•|]+\s*$/g," ").replace(/\s+[\-–—•|]+\s*/g," ").replace(/\s+/g," ").trim(),{phone:E,phoneNorm:H,cleanedText:h}},Vt=async()=>{var c;const i=ke.current;if(i&&i.size>0)return i;try{const x=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m"),g=Array.isArray(x==null?void 0:x.products)?x.products:Array.isArray(x)?x:[],A=new Map;for(const H of g){const E=String((c=H==null?void 0:H.id)!=null?c:"").trim();E&&A.set(E,H)}return ke.current=A,A}catch(x){return ke.current=new Map,ke.current}},Ut=i=>{var x;const c=String(i!=null?i:"").trim();return c&&((x=ke.current)==null?void 0:x.get(c))||null},P=async i=>{var k,T,V;if(!i)throw new Error("Ch\u01B0a ch\u1ECDn file");const c=await i.arrayBuffer(),x=Number(i.size||0)||0;if(!!!(window!=null&&window.Worker&&typeof Blob!="undefined"&&typeof URL!="undefined")||x<450*1024){if(!((k=window==null?void 0:window.XLSX)!=null&&k.read))try{await en()}catch(Ae){}if(!((T=window==null?void 0:window.XLSX)!=null&&T.read))throw new Error("Thi\u1EBFu th\u01B0 vi\u1EC7n \u0111\u1ECDc Excel (XLSX). Vui l\xF2ng t\u1EA3i l\u1EA1i trang admin.");const se=window.XLSX.read(c,{type:"array"}),xe=(V=se==null?void 0:se.SheetNames)==null?void 0:V[0],me=xe?se.Sheets[xe]:null;if(!me)throw new Error("Kh\xF4ng \u0111\u1ECDc \u0111\u01B0\u1EE3c sheet trong file");return window.XLSX.utils.sheet_to_json(me,{header:1,raw:!0,defval:""})}const A=`
					const sources = [
						'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
						'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
						'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js',
					];

					const hasXlsx = () => Boolean(self.XLSX && typeof self.XLSX.read === 'function');
					const ensureXlsx = async () => {
						if (hasXlsx()) return true;
						for (const src of sources) {
							try {
								self.importScripts(src);
								if (hasXlsx()) return true;
							} catch (e) {
								// try next
							}
						}
						return hasXlsx();
					};

					self.onmessage = async (ev) => {
						try {
							const data = ev && ev.data;
							const buf = data && data.buf;
							const ok = await ensureXlsx();
							if (!ok) throw new Error('XLSX not available');
							const wb = self.XLSX.read(buf, { type: 'array' });
							const sheetName = wb && wb.SheetNames && wb.SheetNames[0];
							const ws = sheetName ? wb.Sheets[sheetName] : null;
							if (!ws) throw new Error('No sheet');
							const grid = self.XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: '' });
							self.postMessage({ ok: true, grid });
						} catch (e) {
							self.postMessage({ ok: false, error: String((e && e.message) || e || 'worker error') });
						}
					};
				`,H=new Blob([A],{type:"application/javascript"}),E=URL.createObjectURL(H),h=new Worker(E);try{return await new Promise((xe,me)=>{const Ae=setTimeout(()=>{try{h.terminate()}catch(Ie){}me(new Error("Worker timeout"))},12e3);h.onmessage=Ie=>{const Ue=Ie&&Ie.data;Ue&&Ue.ok?(clearTimeout(Ae),xe(Ue.grid)):Ue&&Ue.ok===!1&&(clearTimeout(Ae),me(new Error(Ue.error||"Worker failed")))},h.onerror=()=>{clearTimeout(Ae),me(new Error("Worker error"))};try{h.postMessage({buf:c},[c])}catch(Ie){h.postMessage({buf:c})}})}finally{try{h.terminate()}catch(se){}try{URL.revokeObjectURL(E)}catch(se){}}},m=async i=>{var T,V;if(!i)throw new Error("Ch\u01B0a ch\u1ECDn file");const c=await P(i),x=Array.isArray(c)?c:[];if(!x.length)throw new Error("File r\u1ED7ng");const g={product:["ten san pham","tensanpham","san pham","t\xEAn s\u1EA3n ph\u1EA9m"],cod:["tong tien thu ho","t\u1ED5ng ti\u1EC1n thu h\u1ED9","thu ho","thu h\u1ED9","tong thu ho","t\u1ED5ng thu h\u1ED9"],date:["ngay","ng\xE0y","date"],phone:["sdt","s\u0111t","so dien thoai","s\u1ED1 \u0111i\u1EC7n tho\u1EA1i","dien thoai","\u0111i\u1EC7n tho\u1EA1i","phone"],qty:["sl","so luong","s\u1ED1 l\u01B0\u1EE3ng","qty","quantity"]},H=(()=>{const se=Math.min(30,x.length);for(let xe=0;xe<se;xe++){const Ae=(Array.isArray(x[xe])?x[xe]:[]).map(lt=>Ft(lt)),Ie=lt=>{for(let ce=0;ce<Ae.length;ce++){const qe=Ae[ce];if(qe&&lt.some(xt=>qe.includes(Ft(xt))))return ce}return-1},Ue=Ie(g.product),Ne=Ie(g.cod);if(Ne>=0){const lt=Ie(g.date),ce=Ie(g.phone),qe=Ie(g.qty);return{headerRow:xe,productCol:Ue,codCol:Ne,dateCol:lt,phoneCol:ce,qtyCol:qe}}}return null})();if(!H)throw new Error('Kh\xF4ng t\xECm th\u1EA5y header c\u1ED9t "T\u1ED5ng ti\u1EC1n thu h\u1ED9"');const E=[],h=new Set,k=se=>{const xe=String(se!=null?se:"").trim();if(!xe)return{text:"",qty:null};let me=xe.match(/^\s*x\s*(\d{1,3})\s+(.+)$/i);return me?{text:String(me[2]||"").trim(),qty:Number(me[1])}:(me=xe.match(/^\s*(\d{1,3})\s*(?:x|\*|×)?\s+(.+)$/i),me?{text:String(me[2]||"").trim(),qty:Number(me[1])}:{text:xe,qty:null})};for(let se=H.headerRow+1;se<x.length;se++){const xe=Array.isArray(x[se])?x[se]:[],me=H.productCol>=0?String((T=xe[H.productCol])!=null?T:"").trim():"",Ae=k(me),Ie=Ae.text,Ue=ne(xe[H.codCol]),Ne=H.qtyCol>=0?xe[H.qtyCol]:"",lt=(()=>{if(Ne!=null&&Ne!==""){if(typeof Ne=="number"&&Number.isFinite(Ne))return{qty:Math.max(1,Math.trunc(Ne)),source:"cell"};const Lt=String(Ne).trim(),Ye=Number(Lt.replace(/[^0-9]/g,""));if(Number.isFinite(Ye)&&Ye>0)return{qty:Math.max(1,Math.trunc(Ye)),source:"cell"}}const wt=Number(Ae.qty);return Number.isFinite(wt)&&wt>1?{qty:Math.max(1,Math.trunc(wt)),source:"text"}:{qty:1,source:"default"}})(),ce=lt.qty,qe=lt.source,xt=qe==="cell"&&ce>1&&Ue>0&&ce<=50?Ue*ce:0,gt=Array.from(new Set([Ue,xt].filter(wt=>Number(wt||0)>0))),Nt=Ue;if(!Ie&&!Nt)continue;const Le=H.phoneCol>=0?String((V=xe[H.phoneCol])!=null?V:"").trim():"",M=tt(Le);let ie=hn(Ie);if(M&&(ie={...ie,phone:M,phoneNorm:M}),!ie.phoneNorm){const wt=xe.map(Ye=>String(Ye!=null?Ye:"")).join(" | "),Lt=hn(wt);Lt.phoneNorm&&(ie={...ie,phone:Lt.phone,phoneNorm:Lt.phoneNorm})}const ze=ie.cleanedText||Ie||"",ee=Ft(ze);if(ee&&(ee.includes("tong tien")||ee.includes("tong")||ee.includes("thanh toan")||ee.includes("thanh to\xE1n")))continue;const Ce=H.dateCol>=0?xe[H.dateCol]:"",it=Ce?bn(Ce):"";it&&h.add(it);const De=Ce?$(Ce):"";E.push({rowIndex:se+1,dateRaw:Ce,monthKey:it,dayKey:De,product:ze,productNorm:pn(ze),productCompact:pn(ze).replace(/\s+/g,""),phone:ie.phone,phoneNorm:ie.phoneNorm,cod:Nt,codRaw:Ue,qty:ce,qtySource:qe,codAlt:xt,codCandidates:gt})}return{rows:E,monthKeys:Array.from(h.values()).sort()}},z=i=>{const c=new Map,x=(h,k)=>{const T=c.get(h)||{key:h,rows:[],phoneNorm:"",phone:"",monthKey:"",dayKey:""};T.rows.push(k),!T.phoneNorm&&k.phoneNorm&&(T.phoneNorm=k.phoneNorm,T.phone=k.phone||k.phoneNorm),!T.monthKey&&k.monthKey&&(T.monthKey=k.monthKey),!T.dayKey&&k.dayKey&&(T.dayKey=k.dayKey),c.set(h,T)};for(const h of Array.isArray(i)?i:[]){const k=String((h==null?void 0:h.phoneNorm)||"").trim(),T=String((h==null?void 0:h.dayKey)||"").trim(),V=String((h==null?void 0:h.monthKey)||"").trim();if(k){const se=T?`p:${k}:d:${T}`:V?`p:${k}:m:${V}`:`p:${k}`;x(se,h)}else x(`r:${h==null?void 0:h.rowIndex}`,h)}const g=h=>{const k=Number((h==null?void 0:h.cod)||0)||0;if(k>0)return k;const T=Number((h==null?void 0:h.codAlt)||0)||0;return T>0?T:0},A=h=>{var se;const k=((h==null?void 0:h.rows)||[]).slice().filter(Boolean);if(k.length<=1)return[{key:h.key,rows:k,phoneNorm:h.phoneNorm,phone:h.phone,monthKey:h.monthKey}];const T=k.map(g).filter(xe=>xe>0),V=Array.from(new Set(T));if(h.phoneNorm&&h.dayKey&&V.length>1&&V.length<=8){const xe=new Map;for(const Ae of V)xe.set(String(Ae),{key:`${h.key}:t:${Ae}`,rows:[],phoneNorm:h.phoneNorm,phone:h.phone,monthKey:h.monthKey});const me=[];for(const Ae of k){const Ie=g(Ae);Ie>0?xe.get(String(Ie)).rows.push(Ae):me.push(Ae)}if(me.length){const Ae=Array.from(xe.values()).map(Ie=>{const Ue=Ie.rows.find(Ne=>String((Ne==null?void 0:Ne.productNorm)||"").trim())||null;return{group:Ie,seedNorm:String((Ue==null?void 0:Ue.productNorm)||"")}});for(const Ie of me){const Ue=String((Ie==null?void 0:Ie.productNorm)||"");let Ne=null,lt=-1;for(const ce of Ae){const qe=Pe(Ue,ce.seedNorm);qe>lt&&(lt=qe,Ne=ce.group)}(Ne||((se=Ae[0])==null?void 0:se.group)).rows.push(Ie)}}return Array.from(xe.values()).filter(Ae=>Ae.rows.length>0)}return[{key:h.key,rows:k,phoneNorm:h.phoneNorm,phone:h.phone,monthKey:h.monthKey}]},H=[];for(const h of c.values())H.push(...A(h));const E=h=>{var xt,gt,Nt;const k=h.rows.slice().filter(Boolean),T=k.map(Le=>Le.rowIndex).filter(Boolean),V=[],se=new Set;for(const Le of k){const M=String((Le==null?void 0:Le.productNorm)||"").trim();M&&(se.has(M)||(se.add(M),V.push(String((Le==null?void 0:Le.product)||"").trim())))}const xe=V.filter(Boolean).join(" + "),me=Ft(xe),Ae=[];for(const Le of k){const M=Array.isArray(Le==null?void 0:Le.codCandidates)?Le.codCandidates:[];for(const ie of M){const ze=Number(ie||0)||0;ze>0&&Ae.push(ze)}}const Ie=Array.from(new Set(Ae)).sort((Le,M)=>Le-M),Ue=k.map(Le=>g(Le)).filter(Le=>Le>0);let Ne=0;if(!Ue.length)Ne=0;else{const Le=new Map;for(const ie of Ue)Le.set(ie,(Le.get(ie)||0)+1);const M=Array.from(Le.keys());if(M.length===1)Ne=M[0];else{let ie=null,ze=0;for(const[ee,Ce]of Le.entries())Ce>ze&&(ze=Ce,ie=ee);ie!=null&&ze>=2?Ne=ie:Ne=Ue.reduce((ee,Ce)=>ee+Ce,0)}}const lt=h.monthKey||((xt=k.find(Le=>Le==null?void 0:Le.monthKey))==null?void 0:xt.monthKey)||"",ce=((gt=k.find(Le=>Le==null?void 0:Le.dayKey))==null?void 0:gt.dayKey)||"",qe=((Nt=k.find(Le=>Le==null?void 0:Le.dateRaw))==null?void 0:Nt.dateRaw)||"";return{key:h.key,phoneNorm:h.phoneNorm||"",phone:h.phone||h.phoneNorm||"",monthKey:lt,dayKey:ce,dateRaw:qe,rowIndices:T,rowIndexFirst:T.length?Math.min(...T):null,rowCount:k.length,productDisplay:xe,productNorm:me,productCompact:String(me||"").replace(/\s+/g,""),cod:Ne,codCandidates:Ie,rows:k}};return H.map(E)},Z=async i=>{const c=`${API_BASE}/api/orders?month=${encodeURIComponent(i)}&includeItems=1`,x=await window.KTM.api.getJSON(c,"L\u1ED7i t\u1EA3i danh s\xE1ch \u0111\u01A1n");return Array.isArray(x==null?void 0:x.orders)?x.orders:Array.isArray(x)?x:[]},Ke=async i=>{var k,T;const c=Array.isArray(i)&&i.length?i:[L],x=[],g=5*60*1e3;for(let V=0;V<c.length;V++){const se=c[V],xe=(k=Ze.current)==null?void 0:k.get(se);if(xe&&Date.now()-Number(xe.at||0)<g&&Array.isArray(xe.records)){x.push(...xe.records);continue}st(`\u0110ang t\u1EA3i \u0111\u01A1n h\u1EC7 th\u1ED1ng th\xE1ng ${se} (${V+1}/${c.length})...`);const me=await Z(se);(T=Ze.current)==null||T.set(se,{at:Date.now(),records:me}),x.push(...me)}const A=V=>String(V||"").trim().toLowerCase(),H=x.filter(V=>{const se=A(V==null?void 0:V.status);return!(Ve&&se==="draft"||Re&&se==="canceled"||Et&&se==="paid")}),E=V=>{var xe,me,Ae;return String(et||"created_at")==="updated_at"?(me=(xe=V==null?void 0:V.updated_at)!=null?xe:V==null?void 0:V.created_at)!=null?me:null:(Ae=V==null?void 0:V.created_at)!=null?Ae:null};return H.map(V=>{var Ne,lt,ce,qe,xt,gt;const se=window.KTM.orders.getOrderProductSummary(V,Ut),xe=window.KTM.orders.getOrderTotalMoney(V,Ut),me=pn(se),Ae=tt((Ne=V==null?void 0:V.phone)!=null?Ne:""),Ie=E(V),Ue=(()=>{if(!Ie)return"";const Nt=new Date(Ie);return Number.isNaN(Nt.getTime())?"":`${Nt.getFullYear()}-${String(Nt.getMonth()+1).padStart(2,"0")}-${String(Nt.getDate()).padStart(2,"0")}`})();return{id:String((lt=V==null?void 0:V.id)!=null?lt:""),created_at:(ce=V==null?void 0:V.created_at)!=null?ce:null,updated_at:(qe=V==null?void 0:V.updated_at)!=null?qe:null,dayKey:Ue,status:String((xt=V==null?void 0:V.status)!=null?xt:""),phone:String((gt=V==null?void 0:V.phone)!=null?gt:""),phoneNorm:Ae,productSummary:se,productNorm:me,productCompact:me.replace(/\s+/g,""),cod:Number(xe||0)||0,raw:V}}).filter(V=>V.id&&V.cod>0)},Pe=(i,c)=>{const x=String(i||"").trim(),g=String(c||"").trim();if(!x||!g)return 0;if(x===g)return 1;const A=x.replace(/\s+/g,""),H=g.replace(/\s+/g,"");if(A&&H&&A===H)return 1;if(A&&H&&(H.includes(A)||A.includes(H)))return .92;const E=Ne=>String(Ne||"").replace(/[\+]/g," ").replace(/[()\[\]{},.;:!?]/g," ").replace(/\s+/g," ").trim().split(" ").map(qe=>qe.trim()).filter(Boolean).map(qe=>qe.replace(/[^a-z0-9]/g,"")).filter(Boolean).filter(qe=>qe.length>1),h=E(x),k=E(g);if(!h.length||!k.length)return 0;const T=new Set(k),V=(Ne,lt)=>{if(Ne===lt)return 0;const ce=Ne.length,qe=lt.length;if(Math.abs(ce-qe)>1)return 2;let xt=0,gt=0,Nt=0;for(;xt<ce&&gt<qe;){if(Ne[xt]===lt[gt]){xt+=1,gt+=1;continue}if(Nt+=1,Nt>1)return Nt;ce>qe?xt+=1:(qe>ce||(xt+=1),gt+=1)}return(xt<ce||gt<qe)&&(Nt+=1),Nt},se=Ne=>/[0-9]/.test(Ne)?2:1;let xe=0,me=0;for(const Ne of h){const lt=se(Ne);if(me+=lt,T.has(Ne)||H&&H.includes(Ne)){xe+=lt;continue}if(Ne.length>=4){let ce=!1;for(const qe of k){if(qe===Ne){ce=!0;break}if(qe.includes(Ne)||Ne.includes(qe)){ce=!0;break}if(H&&H.includes(Ne)){ce=!0;break}if(V(Ne,qe)<=1){ce=!0;break}}ce&&(xe+=lt*.8)}}const Ae=xe/Math.max(1,me),Ie=Math.min(.12,Math.abs(x.length-g.length)/Math.max(1,Math.max(x.length,g.length))),Ue=(()=>{const Ne=h.filter(ce=>/[0-9]/.test(ce)&&ce.length>=3);if(!Ne.length)return 0;let lt=0;for(const ce of Ne)(T.has(ce)||H&&H.includes(ce))&&(lt+=1);return Math.min(.08,.04*lt)})();return Math.max(0,Math.min(1,Ae-Ie+Ue))},Ge=i=>{const x=String(i||"").trim().match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!x)return null;const g=new Date(Number(x[1]),Number(x[2])-1,Number(x[3]));return Number.isNaN(g.getTime())?null:g.getTime()},vt=(i,c)=>{const x=Array.isArray(i==null?void 0:i.codCandidates)&&i.codCandidates.length?i.codCandidates:[Number((i==null?void 0:i.cod)||0)||0],g=Number((c==null?void 0:c.cod)||0)||0;let A=1/0,H=0;for(const E of x){const h=Number(E||0)||0;if(h<=0)continue;const k=Math.abs(g-h);k<A&&(A=k,H=h)}return Number.isFinite(A)||(A=1/0),{bestDiff:A,bestCand:H,oCod:g}},nt=(i,c,x)=>{const g=String((i==null?void 0:i.phoneNorm)||"").trim(),A=!!(g&&String((c==null?void 0:c.phoneNorm)||"")===g),H=Math.max(0,Number((x==null?void 0:x.codTolerance)||0)||0),{bestDiff:E,bestCand:h}=vt(i,c),k=E===0,T=Number.isFinite(E)&&H>0&&E>0&&E<=H,V=String((i==null?void 0:i.dayKey)||"").trim(),se=String((c==null?void 0:c.dayKey)||"").trim(),xe=!!(V&&se&&V===se),me=(()=>{if(!V||!se)return!1;const xt=Ge(V),gt=Ge(se);if(xt==null||gt==null)return!1;const Nt=Math.abs(xt-gt)/(24*60*60*1e3);return Nt>0&&Nt<=1.01})(),Ie=!!g?{phone:.65,cod:.27,day:.08}:{phone:0,cod:.85,day:.15},Ue=A?Ie.phone:0,Ne=k?Ie.cod:T?Ie.cod*(1-E/Math.max(1,H)):0,lt=xe?Ie.day:me?Ie.day*.6:0,ce=Ue+Ne+lt,qe=[];return A&&qe.push("S\u0110T tr\xF9ng"),k?qe.push("COD tr\xF9ng"):T?qe.push(`COD l\u1EC7ch ${window.KTM.money.formatNumber(E)} (<= ${window.KTM.money.formatNumber(H)})`):h>0&&Number.isFinite(E)&&E!==1/0&&qe.push(`COD l\u1EC7ch ${window.KTM.money.formatNumber(E)}`),xe?qe.push("C\xF9ng ng\xE0y"):me&&qe.push("Ng\xE0y g\u1EA7n \u0111\xFAng (\xB11)"),{score:ce,reasons:qe,nameSim:null,phoneMatch:A,codExact:k,codWithin:T,codDiff:E,bestCand:h}},dn=i=>{let c=String(i!=null?i:"");return c=c.replace(/^\s*(?:x\s*)?(\d{1,3})\s*(?:x|\*|×)?\s*/i," "),c=c.replace(/\s+/g," ").trim(),pn(c)},Wt=i=>{var H;const c=new Map,x=new Map,g=Array.isArray(i==null?void 0:i.rows)?i.rows:[],A=g.length>1||g.some(E=>String((E==null?void 0:E.qtySource)||"default")!=="default");for(const E of g){const h=String((E==null?void 0:E.product)||"").trim(),k=dn(h);if(!k)continue;const T=Math.max(1,Number((H=E==null?void 0:E.qty)!=null?H:1)||1),V=A?T:1;c.set(k,(c.get(k)||0)+V),x.has(k)||x.set(k,h)}return{qtyByKey:c,labelByKey:x,qtyReliable:A}},sn=i=>{var h;const c=new Map,x=new Map,g=(i==null?void 0:i.raw)||null,A=Array.isArray(g==null?void 0:g.items)?g.items:[];if(A.length){for(const k of A){const T=k==null?void 0:k.product_id,V=T?Ut(T):null,se=String((V==null?void 0:V.name)||(k==null?void 0:k.product_name)||"").trim(),xe=String((k==null?void 0:k.variant)||"").trim(),me=(se||(i==null?void 0:i.productSummary)||"").trim()+(xe?` (${xe})`:""),Ae=dn(me);if(!Ae)continue;const Ie=Math.max(1,Number((h=k==null?void 0:k.quantity)!=null?h:1)||1);c.set(Ae,(c.get(Ae)||0)+Ie),x.has(Ae)||x.set(Ae,se||me)}return{qtyByKey:c,labelByKey:x}}const H=String((i==null?void 0:i.productSummary)||"").trim();if(!H)return{qtyByKey:c,labelByKey:x};const E=H.split("+").map(k=>String(k||"").trim()).filter(Boolean);for(const k of E){const T=k.match(/\bx\s*(\d{1,3})\b/i),V=T?Math.max(1,Number(T[1])||1):1,se=k.replace(/\bx\s*\d{1,3}\b/ig," ").replace(/\s+/g," ").trim(),xe=dn(se);xe&&(c.set(xe,(c.get(xe)||0)+V),x.has(xe)||x.set(xe,se))}return{qtyByKey:c,labelByKey:x}},fn=(i,c)=>{const x=Wt(i),g=sn(c),A=Array.from(x.qtyByKey.keys()),H=Array.from(g.qtyByKey.keys()),E=[];for(const me of A)for(const Ae of H){const Ie=Pe(me,Ae);Ie>=.9&&E.push({ek:me,sk:Ae,sc:Ie})}E.sort((me,Ae)=>Ae.sc-me.sc);const h=new Map,k=new Set,T=new Set;for(const me of E)k.has(me.ek)||T.has(me.sk)||(h.set(me.ek,me.sk),k.add(me.ek),T.add(me.sk));const V=[],se=[];for(const[me,Ae]of x.qtyByKey.entries()){const Ie=h.get(me)||me,Ue=g.qtyByKey.get(Ie)||0;Ue<Ae&&V.push({name:x.labelByKey.get(me)||me,qty:Ae-Ue})}for(const[me,Ae]of g.qtyByKey.entries()){let Ie=x.qtyByKey.get(me)||0;if(!Ie){for(const[Ue,Ne]of h.entries())if(Ne===me){Ie=x.qtyByKey.get(Ue)||0;break}}Ie<Ae&&se.push({name:g.labelByKey.get(me)||me,qty:Ae-Ie})}return{hasDiff:V.length>0||se.length>0,missingInSystem:V,missingInExcel:se}},rt=i=>{if(!(i!=null&&i.hasDiff))return"";const c=g=>g.slice(0,4).map(A=>`${A.name} x${A.qty}`).join(", ")+(g.length>4?` (+${g.length-4})`:""),x=[];return Array.isArray(i.missingInExcel)&&i.missingInExcel.length&&x.push(`Thi\u1EBFu trong Excel: ${c(i.missingInExcel)}`),Array.isArray(i.missingInSystem)&&i.missingInSystem.length&&x.push(`Thi\u1EBFu trong h\u1EC7 th\u1ED1ng: ${c(i.missingInSystem)}`),x.join(" \xB7 ")},mn=async i=>{we(""),Ee(null),Xe((i==null?void 0:i.name)||""),Oe(!0),st("\u0110ang \u0111\u1ECDc file Excel...");try{await Vt();const c=await m(i),x=Array.isArray(c.rows)?c.rows:[],g=String(L||"").trim()||getCurrentMonth(),A=ee=>{const Ce=String(ee||"").match(/^(\d{4})-(\d{2})$/);if(!Ce)return NaN;const it=Number(Ce[1]),De=Number(Ce[2]);return!Number.isFinite(it)||!Number.isFinite(De)||De<1||De>12?NaN:it*12+(De-1)},H=ee=>{if(!Number.isFinite(ee))return"";const Ce=Math.floor(ee/12),it=ee%12+1;return!Number.isFinite(Ce)||!Number.isFinite(it)||it<1||it>12?"":`${String(Ce).padStart(4,"0")}-${String(it).padStart(2,"0")}`},E=A(g),h=Number.isFinite(E)?E-2:NaN,k=ee=>{const Ce=A(ee);return!Number.isFinite(Ce)||!Number.isFinite(E)||!Number.isFinite(h)?!1:Ce>=h&&Ce<=E},T=(()=>{if(!Number.isFinite(E)||!Number.isFinite(h))return[g];const ee=[];for(let Ce=h;Ce<=E;Ce++){const it=H(Ce);it&&ee.push(it)}return ee.length?ee:[g]})(),V=x.filter(ee=>{const Ce=String((ee==null?void 0:ee.monthKey)||"").trim();return Ce?k(Ce):!0}),se=x.filter(ee=>{const Ce=String((ee==null?void 0:ee.monthKey)||"").trim();return Ce?!k(Ce):!1});if(!V.length)throw new Error(`File kh\xF4ng c\xF3 d\u1EEF li\u1EC7u trong 3 th\xE1ng g\u1EA7n nh\u1EA5t quanh ${g}.`);const xe=T,me=await Ke(xe),Ae=ee=>{const Ce=Number(ee);return Number.isFinite(Ce)?Math.trunc(Ce):0},Ie=(ee,Ce)=>{const it=String(ee||"").trim(),De=Ae(Ce);return!it||!De?"":`${it}|${De}`},Ue=new Set(me.map(ee=>Ie(ee==null?void 0:ee.phoneNorm,ee==null?void 0:ee.cod)).filter(Boolean)),Ne=(()=>{var Ce,it,De,wt,Lt;const ee=new Map;for(const Ye of se){const Rt=Ie(Ye==null?void 0:Ye.phoneNorm,Ye==null?void 0:Ye.cod);if(!Rt||!Ue.has(Rt))continue;const Yt=ee.get(Rt)||[];Yt.push({rowIndex:(Ce=Ye==null?void 0:Ye.rowIndex)!=null?Ce:null,dateRaw:(it=Ye==null?void 0:Ye.dateRaw)!=null?it:"",monthKey:(De=Ye==null?void 0:Ye.monthKey)!=null?De:"",dayKey:(wt=Ye==null?void 0:Ye.dayKey)!=null?wt:"",product:(Lt=Ye==null?void 0:Ye.product)!=null?Lt:""}),ee.set(Rt,Yt)}return ee})(),lt=V,ce=z(lt);st(`\u0110\u1ECDc \u0111\u01B0\u1EE3c ${lt.length} d\xF2ng (${ce.length} c\u1EE5m) trong 3 th\xE1ng g\u1EA7n nh\u1EA5t. \u0110ang chu\u1EA9n b\u1ECB \u0111\u1ED1i so\xE1t...`),st(`\u0110ang \u0111\u1ED1i so\xE1t (${ce.length} c\u1EE5m Excel vs ${me.length} \u0111\u01A1n h\u1EC7 th\u1ED1ng)...`);const qe=new Map,xt=new Map;for(const ee of ce){const Ce=String(ee.phoneNorm||"").trim();if(!Ce)continue;const it=qe.get(Ce)||[];it.push(ee),qe.set(Ce,it);const De=Ie(Ce,ee.cod);if(De){const wt=xt.get(De)||[];wt.push(ee),xt.set(De,wt)}}const gt=new Set,Nt=[],Le=[],M=[],ie=ee=>{const Ce=Array.isArray(ee)?ee.filter(Boolean):[];return Ce.length?`C\xF3 d\xF2ng Excel ngo\xE0i 3 th\xE1ng tr\xF9ng S\u0110T+COD: ${Ce.slice(0,2).map(De=>{const wt=String((De==null?void 0:De.dateRaw)||(De==null?void 0:De.dayKey)||(De==null?void 0:De.monthKey)||"").trim(),Lt=De!=null&&De.rowIndex?`d\xF2ng ${De.rowIndex}`:"";return[wt,Lt].filter(Boolean).join(" \xB7 ")}).join(" | ")}`:""};for(const ee of me){const Ce=String(ee.phoneNorm||"").trim(),it=Ae(ee.cod);if(!Ce||!it){M.push(ee);continue}const De=Ie(Ce,it);let wt=De?xt.get(De)||[]:[];if(wt.length){const s=String(ee.dayKey||"").trim(),p=wt.filter(O=>!gt.has(String(O==null?void 0:O.key)));let l=null;if(p.length&&(s&&(l=p.find(O=>String(O.dayKey||"").trim()===s)||null),l||(l=p[0]||null)),l){gt.add(String(l.key)),Nt.push({group:l,order:ee,score:1,reasons:["S\u0110T tr\xF9ng","COD tr\xF9ng",...l.dayKey&&s&&l.dayKey===s?["C\xF9ng ng\xE0y"]:[]]});continue}}const Lt=qe.get(Ce)||[];if(!Lt.length){const s=Ne.get(De)||[];M.push(s.length?{...ee,excelOutsideHints:s,excelOutsideHintText:ie(s)}:ee);continue}const Ye=String(ee.dayKey||"").trim();let Rt=Lt.filter(s=>!gt.has(String(s==null?void 0:s.key)));if(Rt.length||(Rt=Lt),Ye){const s=Rt.filter(p=>String(p.dayKey||"").trim()===Ye);s.length&&(Rt=s)}let Yt=null,wn=Number.POSITIVE_INFINITY;for(const s of Rt){const p=Ae(s.cod);if(!p)continue;const l=Math.abs(p-it);l<wn&&(wn=l,Yt=s)}if(!Yt){const s=Ne.get(De)||[];M.push(s.length?{...ee,excelOutsideHints:s,excelOutsideHintText:ie(s)}:ee);continue}Le.push({group:Yt,order:ee,score:0,diff:Ae(Yt.cod)-it,reason:Ye&&String(Yt.dayKey||"").trim()===Ye?"S\u0110T tr\xF9ng \xB7 C\xF9ng ng\xE0y":"S\u0110T tr\xF9ng",suggestions:Rt.slice(0,3).map(s=>({key:s.key,cod:Ae(s.cod),productSummary:String(s.product||"").trim(),score:0,reasons:["Excel c\xF9ng S\u0110T"]}))})}const ze=M.length===0&&Le.length===0;Ee({ok:ze,monthKeys:xe,excelCount:lt.length,excelGroupCount:ce.length,systemCount:me.length,matches:Nt,systemOnly:M,moneyMismatch:Le}),N(new Set),st(ze?"OK \u2705":"\u0110\xE3 \u0111\u1ED1i so\xE1t xong")}catch(c){we(String((c==null?void 0:c.message)||c||"L\u1ED7i \u0111\u1ED1i so\xE1t")),st("")}finally{Oe(!1)}},_n=(i,c)=>{var T,V,se,xe,me,Ae,Ie,Ue,Ne,lt;const x=ce=>String(ce||"").replace(/[^0-9]/g,""),g=(i==null?void 0:i.raw)||{},A=String((V=(T=i==null?void 0:i.id)!=null?T:g==null?void 0:g.id)!=null?V:"").trim(),H=x((xe=(se=g==null?void 0:g.phone)!=null?se:i==null?void 0:i.phone)!=null?xe:"");if(!A||!H)return null;let h=(Array.isArray(g==null?void 0:g.items)?g.items:[]).map(ce=>{var qe,xt;return{product_id:(ce==null?void 0:ce.product_id)||"",quantity:Number((qe=ce==null?void 0:ce.quantity)!=null?qe:1),variant:String((ce==null?void 0:ce.variant)||"").trim()||null,variant_json:(xt=ce==null?void 0:ce.variant_json)!=null?xt:null,unit_price:(()=>{var Le;const gt=(Le=ce==null?void 0:ce.unit_price)!=null?Le:ce==null?void 0:ce.unitPrice,Nt=gt==null||gt===""?NaN:Number(gt);return Number.isFinite(Nt)?Math.max(0,Math.trunc(Nt)):null})()}}).filter(ce=>ce.product_id&&Number.isFinite(ce.quantity)&&ce.quantity>0);if(!h.length&&(g!=null&&g.product_id)){const ce=Number((me=g==null?void 0:g.quantity)!=null?me:1);h=[{product_id:g.product_id,quantity:Number.isFinite(ce)&&ce>0?ce:1,variant:null,variant_json:null,unit_price:null}]}if(!h.length)return null;const k=h[0];return{id:A,customer_name:String((Ae=g==null?void 0:g.customer_name)!=null?Ae:"").trim(),phone:H,address:String((Ie=g==null?void 0:g.address)!=null?Ie:"").trim(),note:String((Ue=g==null?void 0:g.note)!=null?Ue:"").trim(),adjustment_amount:Number((Ne=g==null?void 0:g.adjustment_amount)!=null?Ne:0)||0,adjustment_note:String((lt=g==null?void 0:g.adjustment_note)!=null?lt:"").trim(),product_id:k.product_id,quantity:k.quantity,status:c,items:h}},yn=async()=>{if(!ve||fe)return;const i=Array.from(Te.values()).map(g=>String(g||"").trim()).filter(Boolean);if(!i.length||!confirm(`\u0110\xE1nh d\u1EA5u \u0111\xE3 nh\u1EADn ti\u1EC1n cho ${i.length} \u0111\u01A1n?`))return;ge(!0),le("\u0110ang c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i...");let c=0;const x=[];try{for(let g=0;g<i.length;g++){const A=i[g];le(`\u0110ang c\u1EADp nh\u1EADt (${g+1}/${i.length})...`);const H=(Array.isArray(ve==null?void 0:ve.matches)?ve.matches:[]).find(h=>{var k;return String(((k=h==null?void 0:h.order)==null?void 0:k.id)||"")===A}),E=_n(H==null?void 0:H.order,"paid");if(!E){x.push({id:A,error:"Thi\u1EBFu d\u1EEF li\u1EC7u (phone/items)"});continue}try{await window.KTM.api.putJSON(`${API_BASE}/api/orders/${encodeURIComponent(A)}`,E,"L\u1ED7i c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i"),c+=1}catch(h){x.push({id:A,error:String((h==null?void 0:h.message)||h||"L\u1ED7i")})}}}finally{ge(!1),le("")}if(c>0){D(`\u0110\xE3 c\u1EADp nh\u1EADt ${c} \u0111\u01A1n sang \u0110\xE3 nh\u1EADn ti\u1EC1n`,"success");const g=new Set(i);Ee(A=>{if(!A)return A;const H=E=>{if(!E||!g.has(String(E.id)))return E;const h=E.raw?{...E.raw,status:"paid"}:E.raw;return{...E,status:"paid",raw:h}};return{...A,matches:Array.isArray(A.matches)?A.matches.map(E=>({...E,order:H(E==null?void 0:E.order)})):A.matches,systemOnly:Array.isArray(A.systemOnly)?A.systemOnly.map(H):A.systemOnly,moneyMismatch:Array.isArray(A.moneyMismatch)?A.moneyMismatch.map(E=>({...E,order:H(E==null?void 0:E.order)})):A.moneyMismatch}}),N(new Set)}x.length&&(D(`C\xF3 ${x.length} \u0111\u01A1n c\u1EADp nh\u1EADt l\u1ED7i (xem console)`,"warning"),console.warn("Recon paid update failures:",x))};return React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-file-excel me-2 text-success"}),"\u0110\u1ED1i so\xE1t Excel")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"Th\xE1ng m\u1EB7c \u0111\u1ECBnh (n\u1EBFu Excel kh\xF4ng c\xF3 c\u1ED9t ng\xE0y)"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:te,onChange:i=>X(i.target.value),"aria-label":"Ch\u1ECDn th\xE1ng",disabled:q}))))),React.createElement("div",{className:"card border-0 shadow-sm mb-3"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-2"},React.createElement("div",{className:"fw-semibold"},React.createElement("i",{className:"fas fa-file-excel me-2 text-success"}),"\u0110\u1ED1i so\xE1t c\xF4ng n\u1EE3 (Excel)"),React.createElement("div",{className:"d-flex flex-wrap gap-2 align-items-center"},React.createElement("span",{className:"text-muted small"},"\u0110\u1ED1i so\xE1t theo: ",React.createElement("span",{className:"fw-semibold"},"S\u0110T")," + ",React.createElement("span",{className:"fw-semibold"},"T\u1ED5ng ti\u1EC1n thu h\u1ED9")))),At==="loading"&&React.createElement("div",{className:"alert alert-info mt-3 mb-0"},"\u0110ang t\u1EA3i th\u01B0 vi\u1EC7n \u0111\u1ECDc Excel (XLSX)..."),At==="failed"&&React.createElement("div",{className:"alert alert-warning mt-3 mb-0"},"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c th\u01B0 vi\u1EC7n \u0111\u1ECDc Excel (XLSX). H\xE3y ki\u1EC3m tra m\u1EA1ng / ch\u1EB7n CDN (AdBlock) ho\u1EB7c refresh l\u1EA1i trang."),React.createElement("div",{className:"row g-2 align-items-end mt-2"},React.createElement("div",{className:"col-12 col-md-7"},React.createElement("label",{className:"form-label mb-1"},"Upload file Excel"),React.createElement("input",{type:"file",className:"form-control",accept:".xlsx,.xls,.csv",disabled:q,onChange:async i=>{const c=i.target.files&&i.target.files[0];c&&await mn(c)}}),React.createElement("div",{className:"form-text"},Be?`File: ${Be}`:'Header c\u1EA7n c\xF3: "T\u1ED5ng Ti\u1EC1n Thu H\u1ED9". "T\xEAn s\u1EA3n ph\u1EA9m" (n\u1EBFu c\xF3) s\u1EBD gi\xFAp g\u1EE3i \xFD kh\u1EDBp t\u1ED1t h\u01A1n. C\xF3 c\u1ED9t "Ng\xE0y" th\xEC s\u1EBD t\u1EF1 t\u1EA3i \u0111\xFAng th\xE1ng trong file.')),React.createElement("div",{className:"col-12 col-md-5"},React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-md-end"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("label",{className:"form-label mb-0 small text-muted"},"Ng\xE0y theo"),React.createElement("select",{className:"form-select form-select-sm",style:{width:150},value:et,disabled:q,onChange:i=>Pt(i.target.value)},React.createElement("option",{value:"created_at"},"created_at"),React.createElement("option",{value:"updated_at"},"updated_at"))),React.createElement("div",{className:"form-check"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"recon-exc-draft",checked:Ve,disabled:q,onChange:i=>at(!!i.target.checked)}),React.createElement("label",{className:"form-check-label small",htmlFor:"recon-exc-draft"},"B\u1ECF nh\xE1p")),React.createElement("div",{className:"form-check"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"recon-exc-canceled",checked:Re,disabled:q,onChange:i=>yt(!!i.target.checked)}),React.createElement("label",{className:"form-check-label small",htmlFor:"recon-exc-canceled"},"B\u1ECF h\u1EE7y")),React.createElement("div",{className:"form-check"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"recon-exc-paid",checked:Et,disabled:q,onChange:i=>an(!!i.target.checked)}),React.createElement("label",{className:"form-check-label small",htmlFor:"recon-exc-paid"},"B\u1ECF \u0111\xE3 nh\u1EADn ti\u1EC1n")),React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("div",{className:"form-check mb-0"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"recon-cod-tol",checked:Xt,disabled:q,onChange:i=>C(!!i.target.checked)}),React.createElement("label",{className:"form-check-label small",htmlFor:"recon-cod-tol"},"Cho l\u1EC7ch COD")),React.createElement("input",{type:"number",className:"form-control form-control-sm",style:{width:110},value:S,min:"0",step:"1000",disabled:q||!Xt,onChange:i=>B(i.target.value)})))),React.createElement("div",{className:"col-12 d-flex gap-2 justify-content-md-end"},React.createElement("button",{className:"btn btn-outline-secondary",disabled:q,onClick:()=>{we(""),st(""),Ee(null),Xe(""),ht("all"),Ct(""),D("\u0110\xE3 reset \u0111\u1ED1i so\xE1t","info")}},React.createElement("i",{className:"fas fa-rotate-left me-2"}),"Reset"))),We&&React.createElement("div",{className:"mt-2 small text-muted"},We),Fe&&React.createElement("div",{className:"alert alert-danger mt-3 mb-0"},Fe),ve&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:`alert ${ve.ok?"alert-success":"alert-warning"} mb-3`},ve.ok?React.createElement("div",{className:"fw-semibold"},"OK \u2014 Kh\xF4ng th\u1EA5y \u0111\u01A1n h\u1EC7 th\u1ED1ng b\u1ECB thi\u1EBFu trong Excel ho\u1EB7c l\u1EC7ch ti\u1EC1n."):React.createElement("div",{className:"fw-semibold"},"CH\u01AFA KH\u1EDAP \u2014 C\xF3 \u0111\u01A1n h\u1EC7 th\u1ED1ng thi\u1EBFu trong Excel ho\u1EB7c l\u1EC7ch ti\u1EC1n."),React.createElement("div",{className:"small mt-1"},"Th\xE1ng \u0111\u1ED1i so\xE1t: ",Array.isArray(ve.monthKeys)?ve.monthKeys.join(", "):""," \xB7 Excel: ",ve.excelCount," d\xF2ng",Number(ve.excelGroupCount||0)?` (${ve.excelGroupCount} c\u1EE5m)`:""," \xB7 H\u1EC7 th\u1ED1ng: ",ve.systemCount," \u0111\u01A1n")),!ve.ok&&React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-wrap gap-2 align-items-center justify-content-between mb-2"},React.createElement("div",{className:"btn-group btn-group-sm",role:"group","aria-label":"Recon view"},React.createElement("button",{type:"button",className:`btn ${F==="all"?"btn-dark":"btn-outline-dark"}`,onClick:()=>ht("all")},"T\u1EA5t c\u1EA3"),React.createElement("button",{type:"button",className:`btn ${F==="systemOnly"?"btn-warning":"btn-outline-warning"}`,onClick:()=>ht("systemOnly")},"H\u1EC7 th\u1ED1ng thi\u1EBFu Excel"),React.createElement("button",{type:"button",className:`btn ${F==="moneyMismatch"?"btn-danger":"btn-outline-danger"}`,onClick:()=>ht("moneyMismatch")},"Sai l\u1EC7ch ti\u1EC1n")),React.createElement("div",{className:"d-flex flex-wrap gap-2 align-items-center"},React.createElement("input",{type:"text",className:"form-control form-control-sm",style:{width:220},placeholder:"L\u1ECDc theo S\u0110T...",value:St,onChange:i=>Ct(i.target.value)}),React.createElement("div",{className:"btn-group btn-group-sm",role:"group","aria-label":"Export CSV"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{var x,g,A,H,E,h,k;const i=tt(St),c=[["type","order_id","date","phone","product","cod_excel","cod_system","diff","reason"]];for(const T of Array.isArray(ve.moneyMismatch)?ve.moneyMismatch:[])i&&String(((x=T==null?void 0:T.group)==null?void 0:x.phoneNorm)||"").indexOf(i)<0||c.push(["moneyMismatch",((g=T==null?void 0:T.order)==null?void 0:g.id)||"",String(((A=T==null?void 0:T.group)==null?void 0:A.dateRaw)||""),((H=T==null?void 0:T.group)==null?void 0:H.phone)||"",((E=T==null?void 0:T.group)==null?void 0:E.productDisplay)||"",Number(((h=T==null?void 0:T.group)==null?void 0:h.cod)||0),Number(((k=T==null?void 0:T.order)==null?void 0:k.cod)||0),Number((T==null?void 0:T.diff)||0),String((T==null?void 0:T.reason)||"")]);for(const T of Array.isArray(ve.systemOnly)?ve.systemOnly:[])i&&String((T==null?void 0:T.phoneNorm)||"").indexOf(i)<0||c.push(["systemOnly",(T==null?void 0:T.id)||"",window.KTM.date.formatDateTime(T==null?void 0:T.created_at),(T==null?void 0:T.phone)||"",(T==null?void 0:T.productSummary)||"","",Number((T==null?void 0:T.cod)||0),"",String((T==null?void 0:T.excelOutsideHintText)||"")]);Bt(`recon_${String(L||"").replace(/[^0-9\-]/g,"")}.csv`,c)}},"Export CSV")))),Array.isArray(ve.moneyMismatch)&&ve.moneyMismatch.length>0&&React.createElement("div",{className:"card border-0 shadow-sm mb-2",style:{display:F==="all"||F==="moneyMismatch"?"block":"none"}},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"fw-semibold mb-2 text-danger"},"Sai l\u1EC7ch s\u1ED1 ti\u1EC1n"),React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Excel (d\xF2ng)"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"T\xEAn s\u1EA3n ph\u1EA9m (Excel)"),React.createElement("th",{className:"text-end"},"Thu h\u1ED9 (Excel)"),React.createElement("th",null,"Order ID"),React.createElement("th",null,"T\xEAn SP (H\u1EC7 th\u1ED1ng)"),React.createElement("th",{className:"text-end"},"Thu h\u1ED9 (H\u1EC7 th\u1ED1ng)"),React.createElement("th",{className:"text-end"},"L\u1EC7ch"),React.createElement("th",null,"L\xFD do"))),React.createElement("tbody",null,ve.moneyMismatch.filter(i=>{var x;const c=tt(St);return c?String(((x=i==null?void 0:i.group)==null?void 0:x.phoneNorm)||"").includes(c):!0}).slice(0,30).map(i=>{var c,x,g,A,H,E,h,k,T,V;return React.createElement("tr",{key:`mm-${String(((c=i==null?void 0:i.group)==null?void 0:c.key)||((x=i==null?void 0:i.order)==null?void 0:x.id)||Math.random())}`,className:"table-danger"},React.createElement("td",null,((g=i==null?void 0:i.group)==null?void 0:g.rowIndexFirst)||"\u2014",Number(((A=i==null?void 0:i.group)==null?void 0:A.rowCount)||0)>1?` (+${Number(i.group.rowCount)-1})`:""),React.createElement("td",{className:"text-muted"},((H=i==null?void 0:i.group)==null?void 0:H.phone)||"\u2014"),React.createElement("td",{style:{minWidth:260}},((E=i==null?void 0:i.group)==null?void 0:E.productDisplay)||"\u2014"),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(Number(((h=i==null?void 0:i.group)==null?void 0:h.cod)||0))),React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",onClick:()=>{$e((i==null?void 0:i.order)||null),J(!0)}},(k=i==null?void 0:i.order)==null?void 0:k.id)),React.createElement("td",{style:{minWidth:240}},(T=i==null?void 0:i.order)==null?void 0:T.productSummary),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber((V=i==null?void 0:i.order)==null?void 0:V.cod)),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(i==null?void 0:i.diff)),React.createElement("td",{className:"text-muted",style:{minWidth:220}},(i==null?void 0:i.reason)||""))})))),ve.moneyMismatch.length>30&&React.createElement("div",{className:"text-muted small mt-2"},"\u0110ang hi\u1EC3n th\u1ECB 30/",ve.moneyMismatch.length," d\xF2ng."))),Array.isArray(ve.systemOnly)&&ve.systemOnly.length>0&&React.createElement("div",{className:"card border-0 shadow-sm mb-2",style:{display:F==="all"||F==="systemOnly"?"block":"none"}},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"fw-semibold mb-2 text-warning"},"C\xF3 trong h\u1EC7 th\u1ED1ng nh\u01B0ng thi\u1EBFu trong Excel"),React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Order ID"),React.createElement("th",null,"Ng\xE0y t\u1EA1o"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"T\xEAn s\u1EA3n ph\u1EA9m"),React.createElement("th",{className:"text-end"},"Thu h\u1ED9"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"))),React.createElement("tbody",null,ve.systemOnly.filter(i=>{const c=tt(St);return c?String((i==null?void 0:i.phoneNorm)||"").includes(c):!0}).slice(0,30).map(i=>React.createElement("tr",{key:`so-${i.id}`,className:"table-warning"},React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",onClick:()=>{$e(i||null),J(!0)}},i.id)),React.createElement("td",{className:"text-muted"},window.KTM.date.formatDateTime(i.created_at)),React.createElement("td",{className:"text-muted"},i.phone||"\u2014"),React.createElement("td",{style:{minWidth:280}},i.productSummary),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(i.cod)),React.createElement("td",{className:"text-muted"},i.status),i!=null&&i.excelOutsideHintText?React.createElement("div",{className:"small text-muted mt-1"},i.excelOutsideHintText):null))))),ve.systemOnly.length>30&&React.createElement("div",{className:"text-muted small mt-2"},"\u0110ang hi\u1EC3n th\u1ECB 30/",ve.systemOnly.length," \u0111\u01A1n."))))),Array.isArray(ve.matches)&&ve.matches.length>0&&React.createElement("div",{className:"card border-0 shadow-sm mt-3"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2"},React.createElement("div",{className:"fw-semibold"},"\u0110\u01A1n \u0111\xE3 kh\u1EDBp"),React.createElement("div",{className:"d-flex flex-wrap align-items-center gap-2"},oe?React.createElement("span",{className:"text-muted small"},oe):null,React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",disabled:fe||!(Te&&Te.size),onClick:yn},"\u0110\xE1nh d\u1EA5u \u0111\xE3 nh\u1EADn ti\u1EC1n"))),React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",{style:{width:34}},React.createElement("input",{type:"checkbox",checked:(()=>{var x;const i=tt(St),c=(ve.matches||[]).filter(g=>{var E;const A=g==null?void 0:g.order;if(!(A!=null&&A.id))return!1;const H=String((A==null?void 0:A.status)||((E=A==null?void 0:A.raw)==null?void 0:E.status)||"").toLowerCase();return!(Et&&H==="paid"||i&&!String((A==null?void 0:A.phoneNorm)||"").includes(i))});if(!c.length)return!1;for(const g of c)if(!Te.has(String(((x=g==null?void 0:g.order)==null?void 0:x.id)||"")))return!1;return!0})(),onChange:i=>{const c=!!i.target.checked;N(x=>{var E;const g=new Set(x),A=tt(St),H=(ve.matches||[]).filter(h=>{var V;const k=h==null?void 0:h.order;if(!(k!=null&&k.id))return!1;const T=String((k==null?void 0:k.status)||((V=k==null?void 0:k.raw)==null?void 0:V.status)||"").toLowerCase();return!(Et&&T==="paid"||A&&!String((k==null?void 0:k.phoneNorm)||"").includes(A))});for(const h of H){const k=String(((E=h==null?void 0:h.order)==null?void 0:E.id)||"").trim();k&&(c?g.add(k):g.delete(k))}return g})}})),React.createElement("th",null,"Order ID"),React.createElement("th",null,"Ng\xE0y"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"Excel"),React.createElement("th",null,"H\u1EC7 th\u1ED1ng"),React.createElement("th",{className:"text-end"},"Thu h\u1ED9"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"))),React.createElement("tbody",null,(ve.matches||[]).filter(i=>{var A;const c=i==null?void 0:i.order;if(!(c!=null&&c.id))return!1;const x=String((c==null?void 0:c.status)||((A=c==null?void 0:c.raw)==null?void 0:A.status)||"").toLowerCase();if(Et&&x==="paid")return!1;const g=tt(St);return!(g&&!String((c==null?void 0:c.phoneNorm)||"").includes(g))}).slice(0,50).map(i=>{var g,A,H,E;const c=i.order,x=String(c.id);return React.createElement("tr",{key:`match-${x}`},React.createElement("td",null,React.createElement("input",{type:"checkbox",checked:Te.has(x),onChange:h=>{const k=!!h.target.checked;N(T=>{const V=new Set(T);return k?V.add(x):V.delete(x),V})}})),React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",onClick:()=>{$e(c||null),J(!0)}},x)),React.createElement("td",{className:"text-muted"},window.KTM.date.formatDateTime(c.created_at)),React.createElement("td",{className:"text-muted"},c.phone||"\u2014"),React.createElement("td",{style:{minWidth:240}},((g=i==null?void 0:i.group)==null?void 0:g.productDisplay)||"\u2014"),React.createElement("td",{style:{minWidth:240}},c.productSummary||"\u2014"),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(c.cod)),React.createElement("td",null,React.createElement("span",{className:`badge ${String((c==null?void 0:c.status)||((A=c==null?void 0:c.raw)==null?void 0:A.status)||"").toLowerCase()==="paid"?"bg-primary":"bg-secondary"}`},String((c==null?void 0:c.status)||((H=c==null?void 0:c.raw)==null?void 0:H.status)||"").toLowerCase()==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":(c==null?void 0:c.status)||((E=c==null?void 0:c.raw)==null?void 0:E.status)||"\u2014")))})))),React.createElement("div",{className:"text-muted small mt-2"},"Hi\u1EC3n th\u1ECB t\u1ED1i \u0111a 50 \u0111\u01A1n. D\xF9ng l\u1ECDc S\u0110T \u0111\u1EC3 thu h\u1EB9p.")))))),React.createElement(AdminDrawer,{open:j,title:ae?`Order #${ae.id}`:"Order",subtitle:ae?`${ae.phone||""} \u2022 ${window.KTM.money.formatNumber(Number(ae.cod||0))}`:"",onClose:()=>{J(!1),$e(null)}},ae?React.createElement("div",{className:"small"},React.createElement("div",{className:"mb-2"},React.createElement("div",null,React.createElement("span",{className:"text-muted"},"Tr\u1EA1ng th\xE1i:")," ",ae.status||"\u2014"),React.createElement("div",null,React.createElement("span",{className:"text-muted"},"created_at:")," ",window.KTM.date.formatDateTime(ae.created_at)),React.createElement("div",null,React.createElement("span",{className:"text-muted"},"updated_at:")," ",ae.updated_at?window.KTM.date.formatDateTime(ae.updated_at):"\u2014"),React.createElement("div",null,React.createElement("span",{className:"text-muted"},"S\u1EA3n ph\u1EA9m:")," ",ae.productSummary||"\u2014")),React.createElement("div",{className:"fw-semibold mb-1"},"Line items"),React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"#"),React.createElement("th",null,"product_id"),React.createElement("th",{className:"text-end"},"qty"),React.createElement("th",{className:"text-end"},"price"),React.createElement("th",{className:"text-end"},"total"))),React.createElement("tbody",null,(Array.isArray((ut=ae==null?void 0:ae.raw)==null?void 0:ut.items)?ae.raw.items:[]).map((i,c)=>{var E,h,k,T,V,se;const x=String((h=(E=i==null?void 0:i.product_id)!=null?E:i==null?void 0:i.id)!=null?h:"").trim(),g=Number((T=(k=i==null?void 0:i.qty)!=null?k:i==null?void 0:i.quantity)!=null?T:0)||0,A=Number((se=(V=i==null?void 0:i.price)!=null?V:i==null?void 0:i.unit_price)!=null?se:0)||0,H=g*A;return React.createElement("tr",{key:`li-${c}-${x}`},React.createElement("td",{className:"text-muted"},c+1),React.createElement("td",{className:"text-muted"},x||"\u2014"),React.createElement("td",{className:"text-end"},g),React.createElement("td",{className:"text-end"},window.KTM.money.formatNumber(A)),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(H)))}))))):null))}function AdminApp(){const[_,D]=useState(!1),[L,be]=useState(""),[te,X]=useState(null),[q,Oe]=useState("search"),[Fe,we]=useState(()=>loadAdminPins()),[We,st]=useState(()=>loadAdminRecent()),[Be,Xe]=useState(null),[ve,Ee]=useState(""),[F,ht]=useState([]),[St,Ct]=useState(null),[Ve,at]=useState(!1),[Re,yt]=useState(null),[Et,an]=useState(!0),[et,Pt]=useState([]),[Xt,C]=useState(!1),[S,B]=useState(null),[fe,ge]=useState(!1),[oe,le]=useState(!1),[Te,N]=useState(""),[j,J]=useState(()=>loadAdminSettings()),[ae,$e]=useState(null),[ke,Ze]=useState([]);useEffect(()=>{const m=localStorage.getItem("ktm_admin_session");if(m)try{const z=JSON.parse(m);z.expiry>Date.now()?(D(!0),X(z.user)):localStorage.removeItem("ktm_admin_session")}catch(z){localStorage.removeItem("ktm_admin_session")}},[]),useEffect(()=>{_&&_t()},[_]),useEffect(()=>{const m=()=>{try{const Z=document.querySelector(".admin-topbar");if(!Z)return;const Ke=Z.getBoundingClientRect(),Pe=Math.max(0,Math.round(Ke.height));document.documentElement.style.setProperty("--ktm-admin-sticky-top",`${Pe+10}px`)}catch(Z){}};m(),window.addEventListener("resize",m);const z=setTimeout(m,0);return()=>{clearTimeout(z),window.removeEventListener("resize",m)}},[_,q]),useEffect(()=>{var Z,Ke;const m=window.visualViewport,z=()=>{try{const Pe=Number(window.innerHeight)||0,Ge=Number(m==null?void 0:m.height)||Pe,vt=Number(m==null?void 0:m.offsetTop)||0,nt=Math.max(0,Math.round(Pe-Ge-vt));document.documentElement.style.setProperty("--ktm-visual-inset-bottom",`${nt}px`)}catch(Pe){}};z(),window.addEventListener("resize",z);try{(Z=m==null?void 0:m.addEventListener)==null||Z.call(m,"resize",z),(Ke=m==null?void 0:m.addEventListener)==null||Ke.call(m,"scroll",z)}catch(Pe){}return()=>{var Pe,Ge;window.removeEventListener("resize",z);try{(Pe=m==null?void 0:m.removeEventListener)==null||Pe.call(m,"resize",z),(Ge=m==null?void 0:m.removeEventListener)==null||Ge.call(m,"scroll",z)}catch(vt){}}},[]),useEffect(()=>{if(!_)return;const m=Z=>{if(!Z)return!1;const Ke=String(Z.tagName||"").toLowerCase();return!!(Ke==="input"||Ke==="textarea"||Ke==="select"||Z.isContentEditable)},z=Z=>{if(!Z||Z.ctrlKey||Z.metaKey||Z.altKey||m(Z.target))return;const Ke=Z.key;(Ke==="/"||Ke==="N"||Ke==="n"||Ke==="Escape"||Ke==="j"||Ke==="J"||Ke==="k"||Ke==="K")&&(Ke==="/"&&Z.preventDefault(),window.dispatchEvent(new CustomEvent("ktm-admin-hotkey",{detail:{key:Ke}})))};return document.addEventListener("keydown",z),()=>document.removeEventListener("keydown",z)},[_]),useEffect(()=>{_&&st(m=>{const z=Array.isArray(m)?m:[],Z=[q,...z.filter(Ke=>Ke!==q)].slice(0,8);return saveAdminRecent(Z),Z})},[_]);const Je=m=>{const z=String(m||"").trim();z&&st(Z=>{const Ke=Array.isArray(Z)?Z:[],Pe=[z,...Ke.filter(Ge=>Ge!==z)].slice(0,8);return saveAdminRecent(Pe),Pe})},At=m=>{const z=String(m||"").trim();z&&we(Z=>{const Ke=Array.isArray(Z)?Z:[],Ge=Ke.includes(z)?Ke.filter(vt=>vt!==z):[z,...Ke].slice(0,10);return saveAdminPins(Ge),Ge})};useEffect(()=>{if(!_)return;let m=!1;return(async()=>{try{const z=await fetchAdminSettingsFromServer();if(m)return;J(z),saveAdminSettings(z)}catch(z){}})(),()=>{m=!0}},[_]);const Kt=async(m,z)=>{be("");try{const Z=await window.KTM.api.postJSON(`${API_BASE}/api/auth/login`,{username:m,password:z},"\u0110\u0103ng nh\u1EADp th\u1EA5t b\u1EA1i"),Ke={user:Z.user,token:Z.token,expiry:Date.now()+100*365*24*60*60*1e3};localStorage.setItem("ktm_admin_session",JSON.stringify(Ke)),X(Z.user),D(!0)}catch(Z){be(Z.message)}},Me=()=>{localStorage.removeItem("ktm_admin_session"),D(!1),X(null),ht([]),Ct(null)},ct=(m,z="success",Z=null)=>{const Ke=Date.now()+Math.floor(Math.random()*1e3);if(m&&typeof m=="object"){const Ge=m;Pt(vt=>[...vt,{id:Ke,message:String(Ge.message||""),type:String(Ge.type||z||"success"),actionLabel:Ge.actionLabel||null,onAction:typeof Ge.onAction=="function"?Ge.onAction:null,durationMs:Ge.durationMs||null}]);return}const Pe=Z&&typeof Z=="object"?Z:null;Pt(Ge=>[...Ge,{id:Ke,message:String(m||""),type:String(z||"success"),actionLabel:(Pe==null?void 0:Pe.actionLabel)||null,onAction:typeof(Pe==null?void 0:Pe.onAction)=="function"?Pe.onAction:null,durationMs:(Pe==null?void 0:Pe.durationMs)||null}])},en=m=>{Pt(z=>z.filter(Z=>Z.id!==m))},_t=async(m=null)=>{an(!0);try{const z=m?`${API_BASE}/api/albums?parent_id=${m}`:`${API_BASE}/api/albums?parent_id=root`,Z=await window.KTM.api.getJSON(z,"L\u1ED7i t\u1EA3i danh s\xE1ch album");ht(Array.isArray(Z)?Z:[])}catch(z){console.error(z),ct("L\u1ED7i t\u1EA3i danh s\xE1ch album","danger")}an(!1)},ln=()=>{yt(null),at(!0)},Ft=m=>{tt(m),ge(!0)},pn=async(m,z="modal")=>{try{const Z=Re&&Re.uuid;!Z&&ae&&(m.parent_id=ae.uuid);const Ke=Z?`${API_BASE}/api/albums/${Re.uuid||Re.id}`:`${API_BASE}/api/albums`;Z?await window.KTM.api.putJSON(Ke,m,"L\u1ED7i c\u1EADp nh\u1EADt"):await window.KTM.api.postJSON(Ke,m,"L\u1ED7i t\u1EA1o"),ct(Z?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"T\u1EA1o th\xE0nh c\xF4ng!","success"),z==="drawer"?(ge(!1),yt(null),_t(ae==null?void 0:ae.uuid),Z&&S&&B({...S,...m})):(at(!1),yt(null),_t(ae==null?void 0:ae.uuid))}catch(Z){ct(Z.message,"danger")}},bn=m=>{Ct(m)},$=m=>{if(m==="root")Ze([]),$e(null),_t(null);else if(m){const z=ke.findIndex(Z=>Z.uuid===m.uuid);z>=0&&(Ze(ke.slice(0,z+1)),$e(m),_t(m.uuid))}else{const z=[...ke];z.pop();const Z=z[z.length-1]||null;Ze(z),$e(Z),_t(Z==null?void 0:Z.uuid)}},ne=async m=>{const z=`X\xF3a folder "${m.title}"? T\u1EA5t c\u1EA3 folder con v\xE0 \u1EA3nh b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`;if(confirm(z))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${m.uuid||m.id}`,"L\u1ED7i x\xF3a album"),ct("\u0110\xE3 x\xF3a","success"),_t(ae==null?void 0:ae.uuid)}catch(Z){ct("L\u1ED7i x\xF3a album","danger")}},tt=async m=>{m&&(C(!0),N(""),le(!1),ge(!1),B(m))},Bt=()=>{C(!1),le(!1),N(""),ge(!1),B(null)},hn=m=>{ge(!0)};if(!_)return React.createElement(LoginPage,{onLogin:Kt,error:L});const Vt=()=>{const m=new Date,z=m.getFullYear(),Z=String(m.getMonth()+1).padStart(2,"0");return`${z}-${Z}`};function Ut(){const[m,z]=useState(()=>{var Ge;return String((Ge=j==null?void 0:j.ship_percent)!=null?Ge:DEFAULT_SHIP_PERCENT)}),[Z,Ke]=useState(!1);return useEffect(()=>{var Ge;z(String((Ge=j==null?void 0:j.ship_percent)!=null?Ge:DEFAULT_SHIP_PERCENT))},[j==null?void 0:j.ship_percent]),React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-cog me-2 text-warning"}),"C\xE0i \u0111\u1EB7t")),React.createElement("div",{className:"card p-3"},React.createElement("form",{onSubmit:async Ge=>{Ge.preventDefault(),Ke(!0);const vt=saveAdminSettings({ship_percent:m});try{const nt=await saveAdminSettingsToServer(vt);J(nt),saveAdminSettings(nt),ct("\u0110\xE3 l\u01B0u c\xE0i \u0111\u1EB7t v\xE0o DB","success")}catch(nt){J(vt),ct("Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c DB, \u0111\xE3 l\u01B0u t\u1EA1m tr\xEAn m\xE1y","warning")}finally{Ke(!1)}}},React.createElement("div",{className:"mb-2 text-muted small"},"\xC1p d\u1EE5ng cho th\u1ED1ng k\xEA hoa h\u1ED3ng khi \u0111\u01A1n h\xE0ng kh\xF4ng ghi ph\xED ship trong ghi ch\xFA s\u1EA3n ph\u1EA9m."),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ph\xED ship (%) khi kh\xF4ng c\xF3 ship"),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",value:m,min:"0",max:"100",step:"0.01",onChange:Ge=>z(Ge.target.value)}),React.createElement("span",{className:"input-group-text"},"%")),React.createElement("div",{className:"form-text"},"M\u1EB7c \u0111\u1ECBnh: ",DEFAULT_SHIP_PERCENT,"%")),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:Z},Z?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u c\xE0i \u0111\u1EB7t"))))}function P(){const[m,z]=useState(Vt()),[Z,Ke]=useState(!0),Pe=useRef(null),Ge=useRef(null),[vt,nt]=useState(0),[dn,Wt]=useState(!1),sn=useRef(0),fn=()=>({statusCounts:{draft:0,pending:0,processing:0,done:0,paid:0,canceled:0,other:0},activeOrders:0,totalQty:0,totalRevenue:0,doneRevenue:0,tempCommission:0,tempCommissionAll:0,products:[],customers:[],days:[],uniqueCustomers:0,avgOrderValue:0,avgQtyPerOrder:0}),[rt,mn]=useState(fn),_n=useRef(new Map),yn=normalizeShipPercent(j==null?void 0:j.ship_percent),{formatNumber:ut,formatVND:i}=window.KTM.money,c=async(M,ie=!1)=>{var Ye,Rt;const ze=String(M||"").trim();if(!ze)return fn();const ee=`${ze}|${yn}`,Ce=(Ye=_n.current)==null?void 0:Ye.get(ee);if(!ie&&Ce)return Ce;const it=`${API_BASE}/api/orders?resource=stats&month=${encodeURIComponent(ze)}&ship_percent=${encodeURIComponent(yn)}`,De=await window.KTM.api.getJSON(it,"L\u1ED7i t\u1EA3i th\u1ED1ng k\xEA"),wt=De!=null&&De.stats&&(De!=null&&De.meta)?De.stats:De,Lt=wt&&typeof wt=="object"?wt:fn();return(Rt=_n.current)==null||Rt.set(ee,Lt),Lt},x=async(M=!1)=>{Ke(!0);try{const ie=await c(m,M);mn(ie)}catch(ie){console.error("Load stats error:",ie),mn(fn())}finally{Ke(!1)}};useEffect(()=>{x()},[m,yn]);const g=(M,ie)=>{const ze=String(M||"").trim(),ee=ze.match(/^(\d{4})-(\d{2})$/);if(!ee)return ze;const Ce=Number(ee[1]),it=Number(ee[2])-1,De=new Date(Ce,it,1);De.setMonth(De.getMonth()+Number(ie||0));const wt=De.getFullYear(),Lt=String(De.getMonth()+1).padStart(2,"0");return`${wt}-${Lt}`},A=Vt(),H=g(A,-5),E=M=>{const ie=String(M||"").trim();return ie?ie>=H&&ie<=A:!1},h=M=>{const ie=String(M||"").trim();return ie&&(ie<H?H:ie>A?A:ie)},k=M=>{const ie=Date.now();ie-Number(sn.current||0)<1200||(sn.current=ie,ct(M==="future"?"Kh\xF4ng xem \u0111\u01B0\u1EE3c th\xE1ng t\u01B0\u01A1ng lai":"Ch\u1EC9 xem t\u1ED1i \u0111a 5 th\xE1ng g\u1EA7n nh\u1EA5t","warning"))},T=(M,ie,ze)=>Math.max(ie,Math.min(ze,M)),V=()=>{var M;return Math.max(320,Number((M=Ge.current)==null?void 0:M.clientWidth)||360)},se=()=>{const M=V();return T(Math.floor(M*.35),110,180)},xe=()=>{const M=V();return T(Math.floor(M*.22),70,140)},me=M=>{try{if(!(M!=null&&M.touches)||M.touches.length!==1||dn)return;const ie=M.target;if(ie&&typeof ie.closest=="function"&&ie.closest('input, textarea, select, button, a, [role="button"], [contenteditable="true"], .dropdown-menu, .modal')){Pe.current=null;return}const ze=M.touches[0];Pe.current={x:ze.clientX,y:ze.clientY,at:Date.now(),swiping:!1}}catch(ie){Pe.current=null}},Ae=M=>{const ie=Pe.current;if(!ie||dn)return;const ze=(M==null?void 0:M.touches)&&M.touches[0];if(!ze)return;const ee=ze.clientX-ie.x,Ce=ze.clientY-ie.y,it=Math.abs(ee),De=Math.abs(Ce);if(!ie.swiping)if(it>12&&it>De*1.2)ie.swiping=!0,Wt(!1);else return;const wt=se();nt(T(ee,-wt,wt))},Ie=M=>{const ie=Pe.current;if(Pe.current=null,!ie||dn||!ie.swiping){nt(0);return}const ze=(M==null?void 0:M.changedTouches)&&M.changedTouches[0];if(!ze)return;const ee=ze.clientX-ie.x,Ce=ze.clientY-ie.y,it=Date.now()-ie.at,De=Math.abs(ee),wt=Math.abs(Ce);if(it>1e3)return;if(De<30){nt(0);return}if(De<wt*1.5)return;const Lt=xe(),Ye=De>=Lt,Rt=ee>0?1:-1;if(!Ye){Wt(!0),nt(0),setTimeout(()=>Wt(!1),220);return}const Yt=Rt>0?-1:1,wn=g(m,Yt);if(!E(wn)){Wt(!0),nt(Rt*Math.floor(se()*.55)),setTimeout(()=>{nt(0),setTimeout(()=>Wt(!1),200)},140),k(wn>A?"future":"past");return}Wt(!0),nt(Rt*se()),setTimeout(()=>{z(s=>g(s,Yt)),nt(-Rt*se()),requestAnimationFrame(()=>{requestAnimationFrame(()=>{nt(0),setTimeout(()=>Wt(!1),220)})})},140)},Ue=()=>{Pe.current=null,nt(0)},Ne=M=>{var ie,ze;try{if(!M||M.pointerType==="touch"||typeof M.button=="number"&&M.button!==0||dn)return;const ee=M.target;if(ee&&typeof ee.closest=="function"&&ee.closest('input, textarea, select, button, a, [role="button"], [contenteditable="true"], .dropdown-menu, .modal')){Pe.current=null;return}Pe.current={x:M.clientX,y:M.clientY,at:Date.now(),swiping:!1};try{(ze=(ie=M.currentTarget)==null?void 0:ie.setPointerCapture)==null||ze.call(ie,M.pointerId)}catch(Ce){}}catch(ee){Pe.current=null}},lt=M=>{try{if(!M||M.pointerType==="touch")return;const ie=Pe.current;if(!ie||dn)return;const ze=M.clientX-ie.x,ee=M.clientY-ie.y,Ce=Math.abs(ze),it=Math.abs(ee);if(!ie.swiping)if(Ce>12&&Ce>it*1.2)ie.swiping=!0,Wt(!1);else return;const De=se();nt(T(ze,-De,De))}catch(ie){}},ce=M=>{try{if(!M||M.pointerType==="touch")return;const ie=Pe.current;if(Pe.current=null,!ie||dn||!ie.swiping){nt(0);return}const ze=M.clientX-ie.x,ee=M.clientY-ie.y,Ce=Date.now()-ie.at,it=Math.abs(ze),De=Math.abs(ee);if(Ce>1e3)return;if(it<30){nt(0);return}if(it<De*1.5)return;const wt=xe(),Lt=it>=wt,Ye=ze>0?1:-1;if(!Lt){Wt(!0),nt(0),setTimeout(()=>Wt(!1),220);return}const Rt=Ye>0?-1:1,Yt=g(m,Rt);if(!E(Yt)){Wt(!0),nt(Ye*Math.floor(se()*.55)),setTimeout(()=>{nt(0),setTimeout(()=>Wt(!1),200)},140),k(Yt>A?"future":"past");return}Wt(!0),nt(Ye*se()),setTimeout(()=>{z(wn=>g(wn,Rt)),nt(-Ye*se()),requestAnimationFrame(()=>{requestAnimationFrame(()=>{nt(0),setTimeout(()=>Wt(!1),220)})})},140)}catch(ie){Pe.current=null}},qe=()=>{Pe.current=null,nt(0)},xt=vt>0?"Th\xE1ng tr\u01B0\u1EDBc":vt<0?"Th\xE1ng sau":"",gt=vt>0?g(m,-1):vt<0?g(m,1):"",Nt=gt&&E(gt)?gt:"",Le=Math.min(1,Math.abs(vt)/Math.max(1,xe()));return React.createElement("div",{className:"product-manager pb-5 mb-4 stats-manager",ref:Ge,style:{touchAction:"pan-y",transform:`translateX(${vt}px)`,transition:dn?"transform 220ms ease":"none",willChange:"transform"},onTouchStartCapture:me,onTouchMoveCapture:Ae,onTouchEndCapture:Ie,onTouchCancelCapture:Ue,onPointerDown:Ne,onPointerMove:lt,onPointerUp:ce,onPointerCancel:qe},!!xt&&React.createElement("div",{"aria-hidden":"true",style:{position:"fixed",left:0,right:0,top:84,zIndex:1060,pointerEvents:"none",opacity:.15+.55*Le,transform:"translateZ(0)"}},React.createElement("div",{className:"d-flex justify-content-center"},React.createElement("div",{className:"px-3 py-2 rounded-pill bg-dark text-white shadow-sm",style:{fontSize:13}},vt>0?"\u2190":"\u2192"," ",xt," \xB7 ",Nt))),React.createElement(Loading,{show:Z}),React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-chart-column me-2 text-warning"}),"Th\u1ED1ng k\xEA"),React.createElement("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>x(!0),disabled:Z},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"Ch\u1ECDn th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:m,onChange:M=>z(M.target.value),"aria-label":"Ch\u1ECDn th\xE1ng"}))),React.createElement("div",{className:"col-12 col-md-7 d-flex gap-2 justify-content-md-end"},React.createElement("div",{className:"d-flex flex-wrap gap-2 align-self-center"},React.createElement("span",{className:"badge rounded-pill bg-secondary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-truck me-1"}),"Ship \u01B0\u1EDBc t\xEDnh: ",yn,"%"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-receipt me-1"}),ut(rt.activeOrders)," \u0111\u01A1n"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-user me-1"}),ut(rt.uniqueCustomers)," kh\xE1ch"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-boxes-stacked me-1"}),ut(rt.totalQty)," SL"),React.createElement("span",{className:"badge rounded-pill bg-primary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-hand-holding-dollar me-1"}),"\u0110\xE3 nh\u1EADn ti\u1EC1n: ",ut(rt.statusCounts.paid),"/",ut(rt.statusCounts.done)))))),React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng \u0111\u01A1n (kh\xF4ng t\xEDnh h\u1EE7y/nh\xE1p)"),React.createElement("i",{className:"fas fa-receipt text-dark"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},ut(rt.activeOrders)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (t\u1EA1m t\xEDnh)"),React.createElement("i",{className:"fas fa-sack-dollar text-warning"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},i(rt.totalRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (Ho\xE0n th\xE0nh)"),React.createElement("i",{className:"fas fa-circle-check text-success"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},i(rt.doneRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-info bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng s\u1EBD nh\u1EADn (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-chart-line text-info"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},i(rt.tempCommission)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng t\u1ED5ng (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-coins text-primary"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},i(rt.tempCommissionAll))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-layer-group me-2 text-warning"}),"T\u1ED5ng quan tr\u1EA1ng th\xE1i"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},"SL TB/\u0111\u01A1n: ",rt.avgQtyPerOrder?rt.avgQtyPerOrder.toFixed(2):"0.00")),React.createElement("div",{className:"d-md-none mt-2"},React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-light bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Nh\xE1p"),React.createElement("div",{className:"fw-semibold"},ut(rt.statusCounts.draft)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-secondary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("div",{className:"fw-semibold"},ut(rt.statusCounts.pending)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("div",{className:"fw-semibold"},ut(rt.statusCounts.processing)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-danger bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"H\u1EE7y \u0111\u01A1n"),React.createElement("div",{className:"fw-semibold"},ut(rt.statusCounts.canceled)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh"),React.createElement("div",{className:"fw-semibold"},ut(rt.statusCounts.done)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("div",{className:"fw-semibold"},ut(rt.statusCounts.paid)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng SL"),React.createElement("div",{className:"fw-semibold"},ut(rt.totalQty)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Nh\xE1p"),React.createElement("th",null,"Ch\u1EDD x\u1EED l\xFD"),React.createElement("th",null,"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("th",null,"H\u1EE7y \u0111\u01A1n"),React.createElement("th",null,"Ho\xE0n th\xE0nh"),React.createElement("th",null,"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("th",null,"Kh\xE1c"),React.createElement("th",null,"T\u1ED5ng SL"))),React.createElement("tbody",null,React.createElement("tr",null,React.createElement("td",null,ut(rt.statusCounts.draft)),React.createElement("td",null,ut(rt.statusCounts.pending)),React.createElement("td",null,ut(rt.statusCounts.processing)),React.createElement("td",null,ut(rt.statusCounts.canceled)),React.createElement("td",null,ut(rt.statusCounts.done)),React.createElement("td",null,ut(rt.statusCounts.paid)),React.createElement("td",null,ut(rt.statusCounts.other)),React.createElement("td",null,ut(rt.totalQty))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-box me-2 text-info"}),"Top s\u1EA3n ph\u1EA9m"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},rt.products.slice(0,10).map(M=>React.createElement("div",{key:M.product_id,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-info"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},M.product_name),React.createElement("div",{className:"text-muted small text-truncate"},M.product_code?`#${M.product_code} \u2022 `:"",ut(M.orders)," \u0111\u01A1n \u2022 ",ut(M.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},i(M.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"M\xE3"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,rt.products.slice(0,10).map(M=>React.createElement("tr",{key:M.product_id},React.createElement("td",null,M.product_name),React.createElement("td",null,M.product_code||"\u2014"),React.createElement("td",null,ut(M.orders)),React.createElement("td",null,ut(M.quantity)),React.createElement("td",{className:"fw-semibold"},i(M.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-user-group me-2 text-warning"}),"Top kh\xE1ch h\xE0ng"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},rt.customers.slice(0,10).map(M=>React.createElement("div",{key:M.key,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-warning"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},M.customer_name||"\u2014"),React.createElement("div",{className:"text-muted small text-truncate"},M.phone||"\u2014"," \u2022 ",ut(M.orders)," \u0111\u01A1n \u2022 ",ut(M.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},i(M.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,rt.customers.slice(0,10).map(M=>React.createElement("tr",{key:M.key},React.createElement("td",null,M.customer_name||"\u2014"),React.createElement("td",null,M.phone||"\u2014"),React.createElement("td",null,ut(M.orders)),React.createElement("td",null,ut(M.quantity)),React.createElement("td",{className:"fw-semibold"},i(M.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3 mb-4"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-calendar-day me-2 text-success"}),"Theo ng\xE0y"),React.createElement("span",{className:"badge rounded-pill bg-success bg-opacity-10 text-dark"},"DT (t\u1EA1m t\xEDnh) & ho\xE0n th\xE0nh")),React.createElement("div",{className:"d-md-none mt-2"},rt.days.map(M=>React.createElement("div",{key:M.day,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-success"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"fw-semibold"},M.day),React.createElement("div",{className:"text-muted small"},ut(M.orders)," \u0111\u01A1n \u2022 ",ut(M.quantity)," SL"),React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh: ",ut(M.doneOrders)," \u2022 ",i(M.doneRevenue))),React.createElement("div",{className:"fw-semibold text-nowrap"},i(M.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Ng\xE0y"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"DT (t\u1EA1m t\xEDnh)"),React.createElement("th",null,"\u0110\u01A1n ho\xE0n th\xE0nh"),React.createElement("th",null,"DT ho\xE0n th\xE0nh"))),React.createElement("tbody",null,rt.days.map(M=>React.createElement("tr",{key:M.day},React.createElement("td",null,M.day),React.createElement("td",null,ut(M.orders)),React.createElement("td",null,ut(M.quantity)),React.createElement("td",{className:"fw-semibold"},i(M.revenue)),React.createElement("td",null,ut(M.doneOrders)),React.createElement("td",{className:"fw-semibold"},i(M.doneRevenue)))))))))}return React.createElement("div",null,React.createElement(Sidebar,{activeMenu:q,onMenuChange:m=>{Je(m),Oe(m),m==="albums"&&($e(null),Ze([]),_t(null))},onLogout:Me,currentUser:te,pinnedMenus:Fe,recentMenus:We,onTogglePin:At}),React.createElement("div",{className:"main-content"},React.createElement("header",{className:"admin-topbar",role:"banner"},(()=>{const z={search:{title:"Tra c\u1EE9u",icon:"fa-search",sub:"T\xECm nhanh s\u1EA3n ph\u1EA9m/kh\xE1ch/\u0111\u01A1n"},albums:{title:"Album",icon:"fa-images",sub:"Qu\u1EA3n l\xFD \u1EA3nh & folder"},videos:{title:"Video",icon:"fa-video",sub:"Qu\u1EA3n l\xFD video & folder"},products:{title:"S\u1EA3n ph\u1EA9m",icon:"fa-box",sub:"Danh s\xE1ch, gi\xE1, m\xF4 t\u1EA3"},orders:{title:"\u0110\u01A1n h\xE0ng",icon:"fa-receipt",sub:"T\u1EA1o & theo d\xF5i tr\u1EA1ng th\xE1i"},recon:{title:"\u0110\u1ED1i so\xE1t Excel",icon:"fa-file-excel",sub:"\u0110\u1ED1i so\xE1t c\xF4ng n\u1EE3 t\u1EEB Excel"},stats:{title:"Th\u1ED1ng k\xEA",icon:"fa-chart-column",sub:"Doanh thu & hoa h\u1ED3ng"},settings:{title:"C\xE0i \u0111\u1EB7t",icon:"fa-cog",sub:"Tu\u1EF3 ch\u1EC9nh h\u1EC7 th\u1ED1ng"}}[q]||{title:"KTM Admin",icon:"fa-tractor",sub:""},Z=(te==null?void 0:te.username)||(te==null?void 0:te.name)||(te==null?void 0:te.email)||"Admin",Ke=(()=>{if(q!=="albums")return"";const Pe=[];return Pe.push("Root"),Array.isArray(ke)&&ke.length>0&&Pe.push(...ke.map(Ge=>Ge==null?void 0:Ge.title).filter(Boolean)),St!=null&&St.title&&Pe.push(St.title),Pe.length>0?Pe.join(" / "):""})();return React.createElement("div",{className:"admin-topbar-inner"},React.createElement("div",{className:"admin-topbar-left"},React.createElement("div",{className:"admin-page-icon","aria-hidden":"true"},React.createElement("i",{className:`fas ${z.icon}`})),React.createElement("div",{className:"admin-page-title"},React.createElement("div",{className:"admin-page-heading"},z.title),React.createElement("div",{className:"admin-page-subtitle"},Ke||z.sub))),React.createElement("div",{className:"admin-topbar-right"},q==="albums"&&React.createElement("button",{className:"btn btn-warning btn-sm admin-topbar-action",onClick:ln,title:"T\u1EA1o folder"},React.createElement("i",{className:"fas fa-plus me-2"}),React.createElement("span",{className:"d-none d-sm-inline"},"Folder")),React.createElement("a",{href:"/",className:"btn btn-outline-secondary btn-sm d-none d-md-inline-flex",title:"V\u1EC1 trang ch\u1EE7"},React.createElement("i",{className:"fas fa-home me-2"}),"Trang ch\u1EE7"),React.createElement("div",{className:"admin-user-chip",title:Z},React.createElement("i",{className:"fas fa-user-circle"}),React.createElement("span",{className:"admin-user-chip-name"},Z)),React.createElement("button",{className:"btn btn-outline-danger btn-sm d-md-none",onClick:Me,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"}))))})()),React.createElement("div",{className:"admin-page-body"},q==="albums"&&!St&&React.createElement(AlbumList,{albums:F,loading:Et,currentFolder:ae,breadcrumb:ke,onSelect:bn,onCreate:ln,onEdit:Ft,onDelete:ne,onBack:$}),q==="search"&&React.createElement(SearchCenter,{showToast:ct,onNavigate:(m,z,Z)=>{Oe(m),m==="orders"&&z==="create"&&(Xe(Date.now()),Ee((Z==null?void 0:Z.productId)||""))}}),q==="albums"&&St&&React.createElement(AlbumDetail,{album:St,parentAlbum:ke.length>0?ke[ke.length-1]:null,onBack:()=>{if(St.parentId){const m=ke.findIndex(z=>z.uuid===St.parentId);m>=0?Ct(ke[m]):Ct(null)}else Ct(null)},onRefresh:()=>_t(ae==null?void 0:ae.uuid),showToast:ct,onNavigateToFolder:m=>{Ze(z=>[...z,St]),Ct(m)},onEditSubfolder:m=>{yt(m),at(!0)}}),q==="videos"&&React.createElement(VideoList,{showToast:ct}),q==="products"&&React.createElement(ProductManager,{showToast:ct,settings:j}),q==="orders"&&React.createElement(OrderManager,{autoOpenCreateToken:Be,autoOpenCreateProductId:ve,showToast:ct}),q==="recon"&&React.createElement(ReconExcelManager,{showToast:ct}),q==="stats"&&React.createElement(P,null),q==="settings"&&React.createElement(Ut,null))),React.createElement("nav",{className:"mobile-bottom-nav"},React.createElement("div",{className:"nav-items"},React.createElement("a",{href:"#",className:`nav-item ${q==="search"?"active":""}`,onClick:m=>{m.preventDefault(),Oe("search")}},React.createElement("i",{className:"fas fa-search"}),React.createElement("span",null,"Tra c\u1EE9u")),React.createElement("a",{href:"#",className:`nav-item ${q==="albums"?"active":""}`,onClick:m=>{m.preventDefault(),Oe("albums"),Ct(null)}},React.createElement("i",{className:"fas fa-images"}),React.createElement("span",null,"Album")),React.createElement("a",{href:"#",className:`nav-item ${q==="videos"?"active":""}`,onClick:m=>{m.preventDefault(),Oe("videos")}},React.createElement("i",{className:"fas fa-video"}),React.createElement("span",null,"Video")),React.createElement("a",{href:"#",className:`nav-item ${q==="products"?"active":""}`,onClick:m=>{m.preventDefault(),Oe("products")}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",null,"S\u1EA3n ph\u1EA9m")),React.createElement("a",{href:"#",className:`nav-item ${q==="orders"?"active":""}`,onClick:m=>{m.preventDefault(),Oe("orders")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",null,"\u0110\u01A1n h\xE0ng")),React.createElement("a",{href:"#",className:`nav-item ${q==="recon"?"active":""}`,onClick:m=>{m.preventDefault(),Oe("recon")}},React.createElement("i",{className:"fas fa-file-excel"}),React.createElement("span",null,"\u0110\u1ED1i so\xE1t")),React.createElement("a",{href:"#",className:`nav-item ${q==="stats"?"active":""}`,onClick:m=>{m.preventDefault(),Oe("stats")}},React.createElement("i",{className:"fas fa-chart-column"}),React.createElement("span",null,"Th\u1ED1ng k\xEA")))),React.createElement(AlbumModal,{show:Ve,album:Re,parentId:ae==null?void 0:ae.uuid,onClose:()=>at(!1),onSave:pn}),React.createElement(AdminDrawer,{open:Xt,title:S?S.title:"Album",subtitle:S?`${S.subfolderCount||0} subfolder \u2022 ${S.count||0} \u1EA3nh`:"",onClose:Bt,footer:fe?React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{ge(!1)}},React.createElement("i",{className:"fas fa-xmark me-2"}),"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-warning fw-semibold",onClick:()=>{S&&(yt(S),pn({slug:S.id||"",title:S.title||"",description:S.description||"",cover_url:S.cover||"",parent_id:S.parentId||null},"drawer"))}},React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u")):S?React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{window.KTM.clipboard.writeText(S.title),ct("\u0110\xE3 copy t\xEAn folder","success")}},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy"),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>hn(S)},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>{S&&confirm(`X\xF3a folder "${S.title}"?`)&&(ne(S),Bt())}},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a"))):null},fe&&S?React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-pen me-2 text-warning"}),"Ch\u1EC9nh s\u1EEDa"),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:S.title,onChange:m=>B({...S,title:m.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:S.description,onChange:m=>B({...S,description:m.target.value})}))):S?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"Th\xF4ng tin"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"T\xEAn"),React.createElement("div",{className:"v"},S.title),React.createElement("div",{className:"k"},"Slug"),React.createElement("div",{className:"v font-monospace"},S.id),React.createElement("div",{className:"k"},"Subfolder"),React.createElement("div",{className:"v"},S.subfolderCount||0),React.createElement("div",{className:"k"},"\u1EA2nh"),React.createElement("div",{className:"v"},S.count||0))),S.description&&React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-note-sticky me-2 text-secondary"}),"M\xF4 t\u1EA3"),React.createElement("p",null,S.description))):React.createElement("div",{className:"text-muted"},"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u")),React.createElement("div",{className:"toast-container"},et.map(m=>React.createElement(Toast,{key:m.id,message:m.message,type:m.type,actionLabel:m.actionLabel,onAction:m.onAction,durationMs:m.durationMs,onClose:()=>en(m.id)}))))}ReactDOM.render(React.createElement(AdminApp,null),document.getElementById("root"));function OrderManager({autoOpenCreateToken:_,autoOpenCreateProductId:D,showToast:L}){const[be,te]=useState([]),[X,q]=useState(0),[Oe,Fe]=useState(!1),[we,We]=useState(!1),[st,Be]=useState([]),[Xe,ve]=useState(!0),[Ee,F]=useState(!1),[ht,St]=useState([]),[Ct,Ve]=useState(!1),[at,Re]=useState(""),[yt,Et]=useState([]),[an,et]=useState(!1),[Pt,Xt]=useState(""),[C,S]=useState(!1),[B,fe]=useState(null),[ge,oe]=useState(null),[le,Te]=useState(!1),[N,j]=useState(()=>{const e=new Date,n=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0");return`${n}-${t}`}),[J,ae]=useState(""),[$e,ke]=useState(!1),[Ze,Je]=useState(!1),[At,Kt]=useState(!1),[Me,ct]=useState(null),[en,_t]=useState(!1),[ln,Ft]=useState(""),[pn,bn]=useState(!1),$=useRef(0),[ne,tt]=useState(!1),[Bt,hn]=useState(null),[Vt,Ut]=useState(!1),[P,m]=useState(null),[z,Z]=useState(()=>({left:12,top:12,placement:"bottom"})),Ke=useRef(null),Pe=useRef(!1),Ge=useRef({active:!1,id:null,startX:0,startY:0,dx:0,dy:0,lock:null,pointerId:null,captured:!1}),[vt,nt]=useState(()=>({id:null,dir:null})),dn=useRef(!1),Wt=useRef(new Map),sn=useRef(null),fn=useRef(null),rt="ktm_orders_status_sync_queue_v1",mn=useRef([]),_n=useRef(!1),[yn,ut]=useState(()=>({})),[i,c]=useState(!1),[x,g]=useState(!1),[A,H]=useState(!1),[E,h]=useState(()=>new Set),[k,T]=useState(()=>({})),V="ktm_orders_pinned_v1",[se,xe]=useState(()=>new Set),[me,Ae]=useState(!1),[Ie,Ue]=useState(!1),[Ne,lt]=useState(!1),[ce,qe]=useState(""),[xt,gt]=useState(()=>[]),Nt=useRef(null),Le=useRef(null),M=useRef(!1),ie=useRef({active:!1,startY:0,startX:0,fired:!1}),[ze,ee]=useState(()=>{try{return((window==null?void 0:window.innerWidth)||1024)<768}catch(e){return!1}}),Ce=24,it=20,[De,wt]=useState(Ce),Lt=useRef(null),Ye=useRef(null),Rt=useRef(!1),Yt=useRef(new Map),wn=useRef({timer:null,events:[]}),s=useRef(null),p="ktm_orders_phone_tip_v1",l="ktm_orders_search_history_v1",[O,W]=useState(null),[K,w]=useState(!1),[Y,de]=useState([]),[Q,re]=useState(!1),[He,Qe]=useState([]),[f,ye]=useState({customer_name:"",phone:"",address:"",note:"",items:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:[{amount:"",note:""}],adjustment_amount:0,adjustment_note:"",status:"pending"}),[Tt,$t]=useState([""]),[Ot,qt]=useState(null),Qt=useRef({}),[Ht,Gt]=useState([]),[bt,rn]=useState(null),un=useRef(null),on=useRef(null),G=useRef(0),U=useRef(null),he=useRef(0),je=useRef(new Map),_e=useRef(null),Se=useRef(0),pt=useRef(new Map),dt=useRef(new Map),kt=useRef(""),Zt=useRef(null),cn=useRef(null),vn=useRef(0),xn=useRef(null),Sn=9,kn=150,$n=250,In=3*60*1e3,Rn=24*60*60*1e3,qn=5*60*1e3,Ln="ktm_customer_lookup_cache_v1",fa=200,Dn=3,Hn=3,Ea=1,Rs=24*60*60*1e3,Ds=120,Ks=5*60*1e3,Ya=80,Qa=2,Za=4,es=60,ot=React.useMemo(()=>String(at||"").trim().length>0,[at]),ia=React.useMemo(()=>[{value:"draft",label:"\u0110\u01A1n nh\xE1p"},{value:"pending",label:"Ch\u1EDD x\u1EED l\xFD"},{value:"processing",label:"\u0110ang v\u1EADn chuy\u1EC3n"},{value:"done",label:"Ho\xE0n th\xE0nh"},{value:"paid",label:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},{value:"canceled",label:"H\u1EE7y \u0111\u01A1n"}],[]),ts=e=>{hn(e),tt(!0)},ns=(e,n)=>{var t,a,r,o;try{const b=(t=n==null?void 0:n.getBoundingClientRect)==null?void 0:t.call(n),u=window.innerWidth||360,I=window.innerHeight||640,y=230,d=280,v=Math.min(Math.max(10,Math.round((a=b==null?void 0:b.left)!=null?a:10)),Math.max(10,u-y-10));let R=Math.round(((r=b==null?void 0:b.bottom)!=null?r:10)+8),ue="bottom";R+d>I-10&&(R=Math.max(10,Math.round(((o=b==null?void 0:b.top)!=null?o:10)-8-d)),ue="top"),Z({left:v,top:R,placement:ue})}catch(b){Z({left:12,top:12,placement:"bottom"})}m(e),Ut(!0)},zn=()=>{Ut(!1),setTimeout(()=>m(null),120)};useEffect(()=>{if(!Vt)return;const e=n=>{n.key==="Escape"&&zn()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[Vt]);const Xn=()=>{tt(!1),setTimeout(()=>hn(null),180)},Os=()=>{c(!0)},ba=()=>{c(!1)},as=e=>{const n=String(e||"").trim();n&&h(t=>{const a=new Set(t);return a.has(n)?a.delete(n):a.add(n),a})};useEffect(()=>{try{const e=localStorage.getItem(V);if(!e)return;const n=JSON.parse(e);if(!Array.isArray(n))return;xe(new Set(n.map(t=>String(t||"").trim()).filter(Boolean)))}catch(e){}},[]),useEffect(()=>{try{const e=Array.from(se||[]).map(n=>String(n||"").trim()).filter(Boolean);localStorage.setItem(V,JSON.stringify(e))}catch(e){}},[se]);const Es=e=>{const n=String(e||"").trim();n&&xe(t=>{const a=new Set(t);return a.has(n)?a.delete(n):a.add(n),a})};useEffect(()=>{try{const e=localStorage.getItem(l);if(!e)return;const n=JSON.parse(e);if(!Array.isArray(n))return;gt(n.map(t=>String(t||"").trim()).filter(Boolean).slice(0,10))}catch(e){}},[]);const Ps=e=>{try{localStorage.setItem(l,JSON.stringify(e))}catch(n){}},oa=e=>{const n=String(e||"").trim();n&&gt(t=>{const a=Array.isArray(t)?t:[],r=[n,...a.filter(o=>String(o||"").trim().toLowerCase()!==n.toLowerCase())].slice(0,10);return Ps(r),r})},ss=e=>{var t;const n=String((t=e!=null?e:at)!=null?t:"").trim();qe(n),lt(!0),setTimeout(()=>{var a,r;try{(r=(a=Nt.current)==null?void 0:a.focus)==null||r.call(a)}catch(o){}},0)},Tn=()=>{lt(!1)};useEffect(()=>{if(!Ne)return;const e=n=>{n.key==="Escape"&&Tn()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[Ne]),useEffect(()=>{if(!ze)return;const e=a=>{if(Ne||(window.scrollY||0)>6)return;const r=a.touches&&a.touches[0];r&&(ie.current={active:!0,startY:r.clientY,startX:r.clientX,fired:!1})},n=a=>{const r=ie.current;if(!(r!=null&&r.active)||r.fired||(window.scrollY||0)>6)return;const o=a.touches&&a.touches[0];if(!o)return;const b=o.clientY-r.startY,u=o.clientX-r.startX;Math.abs(u)>24||b>92&&(r.fired=!0,ss(at))},t=()=>{ie.current={active:!1,startY:0,startX:0,fired:!1}};return window.addEventListener("touchstart",e,{passive:!0}),window.addEventListener("touchmove",n,{passive:!0}),window.addEventListener("touchend",t,{passive:!0}),window.addEventListener("touchcancel",t,{passive:!0}),()=>{window.removeEventListener("touchstart",e),window.removeEventListener("touchmove",n),window.removeEventListener("touchend",t),window.removeEventListener("touchcancel",t)}},[ze,Ne,at]);const rs=e=>{try{const n=gn(e==null?void 0:e.status);if(!(n==="pending"||n==="processing"))return!1;const t=new Date(e==null?void 0:e.created_at);if(!Number.isFinite(t.getTime()))return!1;const a=new Date;return t.getFullYear()===a.getFullYear()&&t.getMonth()===a.getMonth()&&t.getDate()===a.getDate()}catch(n){return!1}};useEffect(()=>{var t;let e;const n=()=>{try{ee(e?!!e.matches:((window==null?void 0:window.innerWidth)||1024)<768)}catch(a){ee(!1)}};try{e=(t=window.matchMedia)==null?void 0:t.call(window,"(max-width: 767.98px)"),e!=null&&e.addEventListener?e.addEventListener("change",n):e!=null&&e.addListener&&e.addListener(n)}catch(a){e=null}return window.addEventListener("resize",n),n(),()=>{try{e!=null&&e.removeEventListener?e.removeEventListener("change",n):e!=null&&e.removeListener&&e.removeListener(n)}catch(a){}window.removeEventListener("resize",n)}},[]),useEffect(()=>{const e="admin-sheet-open";return ne||i||Vt?document.body.classList.add(e):document.body.classList.remove(e),()=>document.body.classList.remove(e)},[ne,i,Vt]),useEffect(()=>{if(!ne&&!i&&!Vt)return;const e=n=>{n.key==="Escape"&&(ne&&Xn(),i&&ba(),Vt&&zn())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[ne,i,Vt]);const Ls=()=>{try{if(localStorage.getItem(p))return;localStorage.setItem(p,"1"),typeof L=="function"&&L("Tip: Ch\u1EA1m S\u0110T \u0111\u1EC3 g\u1ECDi \u2022 Gi\u1EEF \u0111\u1EC3 copy","info",{durationMs:7e3})}catch(e){}},is=e=>String((e==null?void 0:e.address)||"").replace(/\s*\n+\s*/g,", ").replace(/\s+/g," ").trim(),os=e=>String((e==null?void 0:e.note)||"").replace(/\s*\n+\s*/g," \u2014 ").replace(/\s+/g," ").trim(),cs=e=>{const n=Jt(String(e||"")).replace(/[^0-9+]/g,"");if(n)try{window.location.href=`tel:${n}`}catch(t){}},js=async e=>{var t,a,r;const n=Jt(String(e||"")).replace(/[^0-9+]/g,"");if(n)try{await((r=(a=(t=navigator.clipboard)==null?void 0:t.writeText)==null?void 0:a.call(t,n))!=null?r:Promise.reject(new Error("Clipboard not available"))),typeof L=="function"&&L("\u0110\xE3 copy S\u0110T","success")}catch(o){typeof L=="function"&&L("Kh\xF4ng copy \u0111\u01B0\u1EE3c S\u0110T","danger")}},Fs=()=>{try{const e=localStorage.getItem(rt),n=e?JSON.parse(e):[];return Array.isArray(n)?n:[]}catch(e){return[]}},ls=e=>{try{localStorage.setItem(rt,JSON.stringify(Array.isArray(e)?e:[]))}catch(n){}},ga=(e,n)=>{const t=String(e||"").trim();t&&ut(a=>{const r={...a||{}};return n?r[t]=!0:delete r[t],r})},Bs=(e,n,t)=>{const a=String(e||"").trim(),r=gn(n),o=gn(t);if(!a||!r)return;const b=Array.isArray(mn.current)?mn.current:[],u=new Map(b.map(y=>[String((y==null?void 0:y.orderId)||""),y]));u.set(a,{orderId:a,nextStatus:r,prevStatus:o,ts:Date.now()});const I=Array.from(u.values()).sort((y,d)=>(Number(y.ts)||0)-(Number(d.ts)||0));mn.current=I,ls(I),ga(a,!0)},Pa=async()=>{if(_n.current||!navigator.onLine)return;const e=Array.isArray(mn.current)?mn.current.slice():[];if(e.length){_n.current=!0;try{for(const n of e){const t=String((n==null?void 0:n.orderId)||"").trim(),a=gn(n==null?void 0:n.nextStatus);if(!(!t||!a)){ga(t,!0);try{await Jn({id:t,status:(n==null?void 0:n.prevStatus)||""},a,{silentToast:!0,skipToastBatch:!0,fromSync:!0});const r=(Array.isArray(mn.current)?mn.current:[]).filter(o=>String((o==null?void 0:o.orderId)||"")!==t);mn.current=r,ls(r),ga(t,!1)}catch(r){if(!navigator.onLine)break}}}}finally{_n.current=!1}}};useEffect(()=>{const e=Fs();mn.current=e;try{const n={};for(const t of e){const a=String((t==null?void 0:t.orderId)||"").trim();a&&(n[a]=!0)}ut(n)}catch(n){}setTimeout(()=>Pa(),600)},[]),useEffect(()=>{const e=()=>Pa();window.addEventListener("online",e);const n=setInterval(()=>Pa(),8e3);return()=>{clearInterval(n),window.removeEventListener("online",e)}},[]);const qs=(e,n)=>{var t;(t=e==null?void 0:e.stopPropagation)==null||t.call(e),Rt.current=!1,Ls();try{Ye.current&&clearTimeout(Ye.current)}catch(a){}Ye.current=setTimeout(()=>{Rt.current=!0,js(n)},520)},ya=e=>{var n;(n=e==null?void 0:e.stopPropagation)==null||n.call(e);try{Ye.current&&clearTimeout(Ye.current)}catch(t){}Ye.current=null},Hs=e=>{const n=String(e||"").trim();if(!n)return;T(r=>({...r,[n]:Date.now()}));const t=Yt.current;try{const r=t.get(n);r&&clearTimeout(r)}catch(r){}const a=setTimeout(()=>{T(r=>{const o={...r||{}};return delete o[n],o});try{t.delete(n)}catch(r){}},9e3);t.set(n,a)},ds=e=>String(e||"").replace(/\s+/g," ").trim(),zs=e=>String(e||"").replace(/[^0-9]+/g,""),ca=e=>{try{const n=new Date(e==null?void 0:e.created_at).getTime();if(!Number.isFinite(n))return 0;const t=Date.now()-n;return!Number.isFinite(t)||t<=0?0:Math.floor(t/Rs)}catch(n){return 0}},va=e=>String((e==null?void 0:e.status)||"").trim()!=="pending"?!1:ca(e)>=Dn,gn=e=>{const n=String(e!=null?e:"").trim().toLowerCase();return n==="cancelled"?"canceled":n},La=React.useMemo(()=>["draft","pending","processing","done","paid"],[]),Yn=(e,n)=>{const t=gn(e);if(!t||t==="canceled")return null;const a=La.indexOf(t);return a<0?null:n==="left"?La[a+1]||null:n==="right"&&La[a-1]||null},ms=e=>{var r;const n=gn(e);if(!n)return{label:"",icon:"fa-circle"};const t=((r=ia.find(o=>gn(o==null?void 0:o.value)===n))==null?void 0:r.label)||"",a=(()=>{switch(n){case"draft":return"fa-file-lines";case"pending":return"fa-hourglass-half";case"processing":return"fa-truck";case"done":return"fa-check";case"paid":return"fa-money-bill-wave";case"canceled":return"fa-ban";default:return"fa-circle"}})();return{label:t,icon:a}},Na=e=>{if(gn(e==null?void 0:e.status)!=="draft")return null;const t=Hn-ca(e);return Number.isFinite(t)?t:null},wa=e=>{const n=Na(e);return Number.isFinite(n)?n>0&&n<=Ea:!1},Vn=e=>{ye({customer_name:"",phone:"",address:"",note:"",items:[{product_id:e||"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:[{amount:"",note:""}],adjustment_amount:0,adjustment_note:"",status:"pending"}),$t([""]),W(null),qt(null)};useEffect(()=>{const e=n=>{var a;if(Ot==null)return;const t=(a=Qt.current)==null?void 0:a[Ot];t&&!t.contains(n.target)&&qt(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[Ot]);const us=e=>window.KTM.money.parseMoney(e),ps=e=>window.KTM.money.parseSignedMoney(e),jt=e=>window.KTM.money.formatVND(e),Kn=e=>{const t=(Array.isArray(e)?e:[]).map(a=>{var r,o;return{amount:String((r=a==null?void 0:a.amount)!=null?r:""),note:String((o=a==null?void 0:a.note)!=null?o:"")}});return t.length?t:[{amount:"",note:""}]},Xs=e=>{try{const n=window.KTM.orders.getOrderAdjustmentItems(e),t=(Array.isArray(n)?n:[]).map(a=>{var r,o;return{amount:(a==null?void 0:a.amount)===0?"":String((r=a==null?void 0:a.amount)!=null?r:""),note:String((o=a==null?void 0:a.note)!=null?o:"").trim()}}).filter(a=>String(a.amount||"").trim()||String(a.note||"").trim());return t.length?t:[{amount:"",note:""}]}catch(n){return[{amount:"",note:""}]}},Qn=e=>(Array.isArray(e)?e:[]).map(t=>({amount:ps(t==null?void 0:t.amount),note:String((t==null?void 0:t.note)||"").trim()})).filter(t=>t.amount!==0||!!t.note),ja=e=>{const n=Array.isArray(e==null?void 0:e.adjustment_items)?e.adjustment_items:[],t=Qn(n),a=Zn(t),r=(()=>{if(!t.length)return"";const o=t.map(b=>String((b==null?void 0:b.note)||"").trim()).filter(Boolean);return o.length?o.join(" \u2022 "):t.length>1?`${t.length} m\u1EE5c`:""})();return{cleanAdjItems:t,amount:a,summaryText:r}},Zn=e=>(Array.isArray(e)?e:[]).reduce((t,a)=>t+(Number(a==null?void 0:a.amount)||0),0),Fa=e=>{const n=Array.isArray(e)?e:[];return n.length?JSON.stringify(n):""},hr=e=>window.KTM.money.parseShipFeeFromNote(e),ea=e=>window.KTM.phone.isValid(e),Jt=e=>window.KTM.phone.normalize(e),Ba=async e=>{if(!e)return null;const n=await window.KTM.api.getJSON(`${API_BASE}/api/orders/${e}`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng");return n&&typeof n=="object"&&n.order&&typeof n.order=="object"?n.order:n},Vs=(e,n)=>{var o;const t=Array.isArray(e)?e:[],a=Array.isArray(n)?n:[];if(!t.length)return a;if(!a.length)return t;const r=new Map(t.map(b=>{var u;return[String((u=b==null?void 0:b.id)!=null?u:""),b]}));for(const b of a){const u=String((o=b==null?void 0:b.id)!=null?o:"");u&&r.set(u,b)}return Array.from(r.values())},Sa=async e=>{var n,t,a,r;if(!(e!=null&&e.id)||Array.isArray(e.items)&&e.items.length)return e;try{const o=(t=(n=Wt.current)==null?void 0:n.get)==null?void 0:t.call(n,String(e.id));if(o&&typeof o=="object"&&Array.isArray(o.items)&&o.items.length)return o}catch(o){}try{const o=await Ba(e.id);if(o&&typeof o=="object"){try{(r=(a=Wt.current)==null?void 0:a.set)==null||r.call(a,String(e.id),o)}catch(b){}return te(b=>Array.isArray(b)?b.map(u=>String(u==null?void 0:u.id)===String(e.id)?o:u):b),o}}catch(o){console.error("Fetch order by id error:",o)}return e},Ws=()=>{var e;try{const n=localStorage.getItem(Ln);if(!n)return;const t=JSON.parse(n);if(!t||typeof t!="object")return;const a=Object.entries(t);for(const[r,o]of a)!r||!o||typeof o!="object"||(e=dt.current)==null||e.set(String(r),o)}catch(n){}},qa=()=>{try{const e=dt.current;if(!e||typeof e.entries!="function")return;const n=Array.from(e.entries()).filter(([a,r])=>a&&r&&typeof r=="object"&&Number.isFinite(r.ts)).sort((a,r)=>(Number(r[1].ts)||0)-(Number(a[1].ts)||0)).slice(0,fa),t={};for(const[a,r]of n)t[a]=r;localStorage.setItem(Ln,JSON.stringify(t))}catch(e){}};useEffect(()=>{Ws()},[]);const hs=e=>{const n=Jt(e);if(!n)return null;const t=Array.isArray(be)?be:[];let a=null,r=-1;for(const o of t){if(!o||Jt(o.phone||"")!==n)continue;const b=new Date(o.created_at).getTime(),u=Number.isFinite(b)?b:0;u>=r&&(r=u,a=o)}return a?{name:String(a.customer_name||"").trim(),address:String(a.address||"").trim()}:null},fs=(e,n)=>{e&&ye(t=>n&&Jt(t.phone)!==n?t:{...t,customer_name:e.name||t.customer_name,address:e.address||t.address})},Gs=e=>{const n=hs(e);if(!n)return;const t=Jt(e);ye(a=>{if(t&&Jt(a.phone)!==t)return a;const r={...a};return!String(a.customer_name||"").trim()&&n.name&&(r.customer_name=n.name),!String(a.address||"").trim()&&n.address&&(r.address=n.address),r})},Js=(e,n,t)=>{var a;try{const r=Jt(e);if(!r)return;const o=String(n||"").trim(),b=String(t||"").trim();if(!o&&!b)return;(a=dt.current)==null||a.set(r,{ts:Date.now(),status:"found",customer:{phone:r,name:o||null,address:b||null}}),qa()}catch(r){}},xa=async e=>{var r,o,b;const n=Jt(e);if(!n)return;Gs(n);const t=(r=dt.current)==null?void 0:r.get(n);if(t&&Number.isFinite(t.ts)){const u=Date.now()-t.ts,I=t.status==="found"?Rn:qn;if(u>=0&&u<=I){W({status:t.status,phone:n,customer:t.customer}),t.status==="found"&&t.customer&&fs(t.customer,n);return}}const a=++G.current;W({status:"loading",phone:n});try{const u=await window.KTM.api.getJSON(`${API_BASE}/api/customers?phone=${encodeURIComponent(n)}`,"L\u1ED7i tra c\u1EE9u kh\xE1ch");if(G.current!==a)return;if(u&&u.exists&&u.customer){(o=dt.current)==null||o.set(n,{ts:Date.now(),status:"found",customer:u.customer}),qa(),W({status:"found",phone:n,customer:u.customer}),fs(u.customer,n);return}(b=dt.current)==null||b.set(n,{ts:Date.now(),status:"not-found",customer:null}),qa(),W({status:"not-found",phone:n})}catch(u){if(G.current!==a)return;console.error("Customer lookup error:",u),W({status:"error",phone:n})}},bs=e=>{const n=Jt(e),t=hs(n);ye(r=>{const o={...r,phone:n};return t&&(!String(r.customer_name||"").trim()&&t.name&&(o.customer_name=t.name),!String(r.address||"").trim()&&t.address&&(o.address=t.address)),o}),w(!1),on.current&&(clearTimeout(on.current),on.current=null);const a=n;if(a.length<Sn){W(null);return}if(ea(a)&&a!==kt.current){kt.current=a,xa(a);return}on.current=setTimeout(()=>{const r=Jt(n);ea(r)&&r!==kt.current&&(kt.current=r,xa(r))},kn)},gs=()=>{const e=Jt(f.phone);e.length<Sn||ea(e)&&e!==kt.current&&(kt.current=e,xa(e))};useEffect(()=>(Ze?(document.body.classList.add("order-modal-open"),document.body.style.overflow="hidden"):(document.body.classList.remove("order-modal-open"),document.body.style.overflow=""),()=>{document.body.classList.remove("order-modal-open"),document.body.style.overflow=""}),[Ze]);const ka=Array.isArray(f.items)?f.items.length:0;useEffect(()=>{if(!Ze){vn.current=ka;return}ka>vn.current&&setTimeout(()=>{const e=Zt.current;e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},0),vn.current=ka},[Ze,ka]),useEffect(()=>()=>{on.current&&(clearTimeout(on.current),on.current=null),U.current&&(clearTimeout(U.current),U.current=null)},[]),useEffect(()=>{if(!Ze)return;U.current&&(clearTimeout(U.current),U.current=null);const e=Jt((f==null?void 0:f.phone)||"");if(!ea(e)){de([]),re(!1);return}return U.current=setTimeout(async()=>{var r;const n=String(e),t=(r=je.current)==null?void 0:r.get(n);if(t&&Number.isFinite(t.ts)&&Date.now()-t.ts<=In){de(Array.isArray(t.orders)?t.orders:[]),re(!1);return}const a=++he.current;re(!0);try{const o=`${API_BASE}/api/orders?search=${encodeURIComponent(e)}`,b=await window.KTM.api.getJSON(o,"L\u1ED7i t\u1EA3i l\u1ECBch s\u1EED \u0111\u01A1n theo S\u0110T");if(he.current!==a)return;const u=Array.isArray(b)?b:Array.isArray(b==null?void 0:b.orders)?b.orders:[];de(u);try{const I=je.current;if(I&&typeof I.set=="function"&&(I.set(n,{ts:Date.now(),orders:u}),I.size>100)){const y=Array.from(I.entries()).sort((v,R)=>{var ue,pe;return(Number((ue=v==null?void 0:v[1])==null?void 0:ue.ts)||0)-(Number((pe=R==null?void 0:R[1])==null?void 0:pe.ts)||0)}),d=Math.max(0,y.length-100);for(let v=0;v<d;v++)I.delete(y[v][0])}}catch(I){}}catch(o){if(he.current!==a)return;console.error("Phone history fetch error:",o),de([])}finally{if(he.current!==a)return;re(!1)}},$n),()=>{U.current&&(clearTimeout(U.current),U.current=null)}},[Ze,f==null?void 0:f.phone]),useEffect(()=>{Qs()},[]),useEffect(()=>{ot||Wn()},[N,ot]),useEffect(()=>{Ta()},[]),useEffect(()=>{_&&un.current!==_&&(un.current=_,Ma(D))},[_]);const Mn=e=>e==="draft"?"\u0110\u01A1n nh\xE1p":e==="pending"?"Ch\u1EDD x\u1EED l\xFD":e==="processing"?"\u0110ang v\u1EADn chuy\u1EC3n":e==="done"?"Ho\xE0n th\xE0nh":e==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":e==="cancelled"||e==="canceled"?"H\u1EE7y \u0111\u01A1n":e||"",ta=e=>e==="draft"?"bg-light text-dark":e==="pending"?"bg-secondary":e==="processing"?"bg-warning text-dark":e==="done"?"bg-success":e==="paid"?"bg-primary":e==="cancelled"||e==="canceled"?"bg-danger":"bg-light text-dark",jn=React.useMemo(()=>{const e=window.KTM.orders.sortOrders(be),n=se;if(!n||!(n instanceof Set)||n.size===0)return e;const t=Array.isArray(e)?e.slice():[];return t.sort((a,r)=>{var u,I;const o=n.has(String((u=a==null?void 0:a.id)!=null?u:""))?1:0;return(n.has(String((I=r==null?void 0:r.id)!=null?I:""))?1:0)-o}),t},[be,se]),Ha=React.useMemo(()=>window.KTM.orders.sortOrders(st),[st]),Ca=React.useMemo(()=>{const n=(Array.isArray(Ha)?Ha:[]).filter(t=>va(t));return n.sort((t,a)=>{const r=new Date(t==null?void 0:t.created_at).getTime(),o=new Date(a==null?void 0:a.created_at).getTime();return(Number.isFinite(r)?r:0)-(Number.isFinite(o)?o:0)}),n},[Ha]),ys=React.useMemo(()=>{const n=(Array.isArray(ht)?ht:[]).filter(t=>wa(t));return n.sort((t,a)=>{const r=new Date(t==null?void 0:t.created_at).getTime(),o=new Date(a==null?void 0:a.created_at).getTime();return(Number.isFinite(r)?r:0)-(Number.isFinite(o)?o:0)}),n},[ht]),la=React.useMemo(()=>{if($e)return Ca;let e=jn;if(me){const n=se;e=(Array.isArray(e)?e:[]).filter(t=>{var a,r;return(r=n==null?void 0:n.has)==null?void 0:r.call(n,String((a=t==null?void 0:t.id)!=null?a:""))})}return Ie&&(e=(Array.isArray(e)?e:[]).filter(n=>rs(n))),e},[$e,Ca,jn,me,se,Ie]),Aa=React.useMemo(()=>{if($e)return la;const e=String(J||"").trim();return e?(Array.isArray(la)?la:[]).filter(n=>String((n==null?void 0:n.status)||"").trim()===e):la},[la,J,$e]),vs=React.useMemo(()=>window.KTM.orders.sortOrders(yt),[yt]),nn=React.useMemo(()=>ot?vs:Aa,[Aa,ot,vs]),Ns=React.useMemo(()=>{const e=Array.isArray(nn)?nn:[];return ze?e.slice(0,Math.max(0,Number(De)||0)):e},[ze,De,nn]);useEffect(()=>{ze&&wt(Ce)},[ze,J,$e,N,at]),useEffect(()=>{if(!ze)return;const e=Array.isArray(nn)?nn.length:0;if(De>=e)return;const n=Lt.current;if(!n)return;const t=new IntersectionObserver(a=>{Array.isArray(a)&&a.some(o=>o==null?void 0:o.isIntersecting)&&wt(o=>Math.min((Number(o)||0)+it,e))},{root:null,rootMargin:"520px 0px",threshold:0});return t.observe(n),()=>t.disconnect()},[ze,De,nn]),useEffect(()=>{if(!ze){g(!1),H(!1);return}const e=()=>{s.current||(s.current=window.requestAnimationFrame(()=>{s.current=null;const n=window.scrollY||document.documentElement.scrollTop||0;g(n>140),H(n>60)}))};return window.addEventListener("scroll",e,{passive:!0}),e(),()=>{window.removeEventListener("scroll",e),s.current&&(window.cancelAnimationFrame(s.current),s.current=null)}},[ze]),useEffect(()=>{if(!ze){try{document.documentElement.style.removeProperty("--ktm-mobile-bottom-nav-h")}catch(n){}return}const e=()=>{try{const n=document.querySelector(".mobile-bottom-nav"),t=n&&n.offsetHeight?n.offsetHeight:0;document.documentElement.style.setProperty("--ktm-mobile-bottom-nav-h",`${t}px`)}catch(n){}};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[ze]);const Fn=React.useMemo(()=>{const e=Array.isArray(nn)?nn:[],n={all:e.length,draft:0,pending:0,processing:0,done:0,paid:0,canceled:0,other:0};for(const t of e){const a=gn(t==null?void 0:t.status);a==="draft"?n.draft+=1:a==="pending"?n.pending+=1:a==="processing"?n.processing+=1:a==="done"?n.done+=1:a==="paid"?n.paid+=1:a==="canceled"?n.canceled+=1:n.other+=1}return n},[nn]),Us=React.useMemo(()=>{const e=se;return!e||e.size===0?0:(Array.isArray(jn)?jn:[]).reduce((n,t)=>{var a;return n+(e.has(String((a=t==null?void 0:t.id)!=null?a:""))?1:0)},0)},[se,jn]),Ys=React.useMemo(()=>(Array.isArray(jn)?jn:[]).filter(e=>rs(e)).length,[jn]),ws=React.useMemo(()=>{const e=new Date,n=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0");return`${n}-${t}`},[]),Pn=e=>{if(ot&&Re(""),e==="thisMonth"){ke(!1),ae(""),j(ws);return}if(e==="overduePending"){j(""),ke(!0),ae("pending");return}if(e==="draftExpiring"){ke(!1),ae("draft"),j(""),Ta();return}if(e==="all"){ke(!1),ae(""),j(ws);return}},na=e=>window.KTM.date.formatDateTime(e),Qs=async()=>{try{const e=await window.KTM.api.getJSON(`${API_BASE}/api/products?fields=order`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");Gt(Array.isArray(e)?e:[])}catch(e){console.error("Load products error:",e),Gt([])}},Wn=async()=>{ve(!0),We(!1);try{const n=new URLSearchParams;N&&n.set("month",String(N)),n.set("includeItems","0"),n.set("meta","1"),n.set("limit",String(es)),n.set("offset","0");const t=`${API_BASE}/api/orders?${n.toString()}`,a=await window.KTM.api.getJSON(t,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),r=Array.isArray(a)?a:Array.isArray(a==null?void 0:a.orders)?a.orders:[],o=!Array.isArray(a)&&a&&typeof a=="object"&&a.meta||null;te(Array.isArray(r)?r:[]),q(Array.isArray(r)?r.length:0),Fe(!!(o!=null&&o.hasMore)),Ta()}catch(n){console.error("Load orders error:",n),te([]),q(0),Fe(!1)}finally{ve(!1),We(!1)}},Zs=async()=>{if(!(Xe||we||ot)&&Oe){We(!0);try{const e=new URLSearchParams;N&&e.set("month",String(N)),e.set("includeItems","0"),e.set("meta","1"),e.set("limit",String(es)),e.set("offset",String(X));const n=`${API_BASE}/api/orders?${e.toString()}`,t=await window.KTM.api.getJSON(n,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),a=Array.isArray(t)?t:Array.isArray(t==null?void 0:t.orders)?t.orders:[],r=!Array.isArray(t)&&t&&typeof t=="object"&&t.meta||null;te(o=>Vs(o,Array.isArray(a)?a:[])),q(o=>o+(Array.isArray(a)?a.length:0)),Fe(!!(r!=null&&r.hasMore))}catch(e){console.error("Load more orders error:",e)}finally{We(!1)}}},Ss=async e=>{var r;const n=ds(e);if(!n){Et([]),Xt(""),et(!1);return}const t=zs(n);if(n.length<Qa&&t.length<Za){Et([]),Xt(`Nh\u1EADp \xEDt nh\u1EA5t ${Qa} k\xFD t\u1EF1 (ho\u1EB7c ${Za} s\u1ED1) \u0111\u1EC3 search nhanh`),et(!1);return}try{const o=(r=pt.current)==null?void 0:r.get(n);if(o&&Number.isFinite(o.ts)&&Date.now()-o.ts<=Ks){Et(Array.isArray(o.results)?o.results:[]),Xt(""),et(!1);return}}catch(o){}const a=++Se.current;et(!0),Xt("");try{const o=`${API_BASE}/api/orders?search=${encodeURIComponent(n)}`,b=await window.KTM.api.getJSON(o,"L\u1ED7i search \u0111\u01A1n h\xE0ng");if(Se.current!==a)return;const u=Array.isArray(b)?b:[];Et(u);try{const I=pt.current;if(I&&typeof I.set=="function"&&(I.set(n,{ts:Date.now(),results:u}),I.size>Ya)){const y=Array.from(I.entries()).sort((v,R)=>{var ue,pe;return(Number((ue=v==null?void 0:v[1])==null?void 0:ue.ts)||0)-(Number((pe=R==null?void 0:R[1])==null?void 0:pe.ts)||0)}),d=Math.max(0,y.length-Ya);for(let v=0;v<d;v++)I.delete(y[v][0])}}catch(I){}}catch(o){if(Se.current!==a)return;console.error("Order search error:",o),Et([]),Xt((o==null?void 0:o.message)||"Search l\u1ED7i")}finally{if(Se.current!==a)return;et(!1)}};useEffect(()=>{_e.current&&(clearTimeout(_e.current),_e.current=null);const e=ds(at);if(!e){Et([]),Xt(""),et(!1);return}return $e&&ke(!1),_e.current=setTimeout(()=>{Ss(e)},Ds),()=>{_e.current&&(clearTimeout(_e.current),_e.current=null)}},[at]);const Ta=async()=>{F(!0),Ve(!0);try{const[e,n]=await Promise.all([window.KTM.api.getJSON(`${API_BASE}/api/orders?overdue=1&days=${encodeURIComponent(Dn)}&includeItems=0`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),window.KTM.api.getJSON(`${API_BASE}/api/orders?draftExpiring=1&remainingDays=${encodeURIComponent(Ea)}&includeItems=0`,"L\u1ED7i t\u1EA3i \u0111\u01A1n nh\xE1p")]);Be(Array.isArray(e)?e:[]),St(Array.isArray(n)?n:[])}catch(e){console.error("Load all orders error:",e),Be([]),St([])}finally{F(!1),Ve(!1)}},za=async e=>{const n=await Sa(e);if(!n)return;rn(n.id);const t=Array.isArray(n.items)&&n.items.length?n.items.map(u=>{var I,y,d,v;return{product_id:(u==null?void 0:u.product_id)||"",quantity:Number((I=u==null?void 0:u.quantity)!=null?I:1)||1,unit_price:(()=>{var pe;const R=(pe=u==null?void 0:u.unit_price)!=null?pe:u==null?void 0:u.unitPrice,ue=R==null||R===""?NaN:Number(R);return Number.isFinite(ue)?Math.trunc(ue):null})(),variant:String((y=u==null?void 0:u.variant)!=null?y:"").trim(),variant_json:(v=(d=u==null?void 0:u.variant_json)!=null?d:u==null?void 0:u.variantJson)!=null?v:null}}).filter(u=>u.product_id):[{product_id:n.product_id||"",quantity:Number(n.quantity||1)||1,unit_price:null,variant:"",variant_json:null}],a=Xs(n),r=Qn(a),o=Zn(r),b=Fa(r);ye({customer_name:n.customer_name||"",phone:Jt(n.phone||""),address:n.address||"",note:(n==null?void 0:n.note)||"",items:t.length?t:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:a,adjustment_amount:o,adjustment_note:b||(n==null?void 0:n.adjustment_note)||"",status:n.status||"pending"}),$t(new Array(t.length?t.length:1).fill("")),Qe(new Array(t.length?t.length:1).fill(!0)),W(null),Je(!1),ct(n),Kt(!0),Ft(""),_t(!1),bn(!0),n.phone&&xa(Jt(n.phone))},da=async e=>{if(!e)return;Kt(!0),Ft(""),_t(!0),bn(!1),ct(e);const n=++$.current;try{const t=await Sa(e);if($.current!==n)return;ct(t||e)}catch(t){if($.current!==n)return;Ft((t==null?void 0:t.message)||"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c chi ti\u1EBFt \u0111\u01A1n")}finally{if($.current!==n)return;_t(!1)}},er=()=>{C||le||(Kt(!1),_t(!1),Ft(""),bn(!1),rn(null),Vn(""),w(!1),Qe([]))};function Ma(e){Kt(!1),bn(!1),_t(!1),Ft(""),rn(null),Vn(e||""),w(!1),Qe([]),Je(!0)}const Xa=()=>{C||le||(Je(!1),rn(null),Vn(""),w(!1),Qe([]))},xs=async()=>{var u,I,y;if(!bt||le||C)return;const e=(Array.isArray(be)?be:[]).find(d=>String(d==null?void 0:d.id)===String(bt))||null,n=String((e==null?void 0:e.status)||(f==null?void 0:f.status)||"").trim();if(n==="done"||n==="paid"||n==="canceled"){const d="Kh\xF4ng th\u1EC3 t\xE1ch: \u0111\u01A1n \u0111\xE3 ho\xE0n th\xE0nh/\u0111\xE3 nh\u1EADn ti\u1EC1n/\u0111\xE3 h\u1EE7y.";typeof L=="function"?L(d,"warning"):alert(d);return}const t=Jt(f.phone),r=(Array.isArray(f.items)?f.items:[]).map((d,v)=>{var R,ue;return{idx:v,product_id:String((d==null?void 0:d.product_id)||"").trim(),quantity:Number((R=d==null?void 0:d.quantity)!=null?R:0),variant:String((d==null?void 0:d.variant)||"").trim()||null,variant_json:(ue=d==null?void 0:d.variant_json)!=null?ue:null,unit_price:(()=>{const pe=d==null?void 0:d.unit_price,ft=pe===""||pe==null?NaN:Number(pe);if(Number.isFinite(ft))return Math.max(0,Math.trunc(ft));const mt=Cn(d==null?void 0:d.product_id),tn=d!=null&&d.variant_json&&typeof d.variant_json=="object"?d.variant_json:null;return aa(mt,tn)})()}}).filter(d=>d.product_id&&Number.isFinite(d.quantity)&&d.quantity>0);if(r.length<2){const d="C\u1EA7n \xEDt nh\u1EA5t 2 s\u1EA3n ph\u1EA9m \u0111\u1EC3 t\xE1ch \u0111\u01A1n.";typeof L=="function"?L(d,"warning"):alert(d);return}const o=[],b=[];for(const d of r){const v=!!He[d.idx],R={product_id:d.product_id,quantity:d.quantity,unit_price:d.unit_price,variant:d.variant,variant_json:d.variant_json};v?o.push(R):b.push(R)}if(!o.length||!b.length){const d="Ch\u1ECDn m\u1ED9t s\u1ED1 s\u1EA3n ph\u1EA9m \u201CGiao \u0111\u1EE3t 1\u201D, v\xE0 \u0111\u1EC3 l\u1EA1i \xEDt nh\u1EA5t 1 s\u1EA3n ph\u1EA9m \u201CCh\u1EDD h\xE0ng\u201D.";typeof L=="function"?L(d,"warning"):alert(d);return}Te(!0);try{const d=Array.isArray(f==null?void 0:f.adjustment_items)?f.adjustment_items:[],v=Qn(d),R=Zn(v),ue=Fa(v),pe={customer_name:f.customer_name,phone:t,address:f.address,note:(f.note||"").trim(),adjustment_amount:R,adjustment_note:ue,adjustment_items:v,status:"processing",items:o,product_id:o[0].product_id,quantity:o[0].quantity,split_seq:1},ft=await window.KTM.api.postJSON(`${API_BASE}/api/orders`,pe,"L\u1ED7i t\xE1ch \u0111\u01A1n (t\u1EA1o \u0111\u01A1n giao ngay)"),mt=(y=(I=ft==null?void 0:ft.id)!=null?I:(u=ft==null?void 0:ft.order)==null?void 0:u.id)!=null?y:null;if(!mt)throw new Error("T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i: kh\xF4ng nh\u1EADn \u0111\u01B0\u1EE3c ID \u0111\u01A1n giao ngay");const tn={id:bt,customer_name:f.customer_name,phone:t,address:f.address,note:(f.note||"").trim(),adjustment_amount:0,adjustment_note:"",adjustment_items:[],status:"pending",items:b,product_id:b[0].product_id,quantity:b[0].quantity,parent_order_id:String(mt),split_seq:2};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${bt}`,tn,"L\u1ED7i t\xE1ch \u0111\u01A1n (c\u1EADp nh\u1EADt ph\u1EA7n ch\u1EDD h\xE0ng)"),Xa(),Wn();const Mt=mt?`\u0110\xE3 t\xE1ch \u0111\u01A1n. \u0110\u01A1n giao ngay: #${mt}`:"\u0110\xE3 t\xE1ch \u0111\u01A1n.";typeof L=="function"?L(Mt,"success"):alert(Mt)}catch(d){console.error(d);const v=(d==null?void 0:d.message)||"T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i";typeof L=="function"?L(v,"danger"):alert(v)}finally{Te(!1)}},ks=e=>{if(!e)return"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --";const n=String(e),t=Ht.find(a=>String(a==null?void 0:a.id)===n);return t?`${t.name}${t.code?` (${t.code})`:""}`:"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"},On=e=>{try{return String(e!=null?e:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(n){return String(e!=null?e:"").toLowerCase()}},tr=e=>{const t=On(e).trim().split(/\s+/).filter(Boolean),a=t.join(" ");return{contentTokens:t,cleanedQuery:a}},Cs=React.useMemo(()=>(Array.isArray(Ht)?Ht:[]).map((e,n)=>{var y,d,v,R,ue,pe;const t=On((y=e==null?void 0:e.name)!=null?y:""),a=On((d=e==null?void 0:e.code)!=null?d:""),r=On((v=e==null?void 0:e.category)!=null?v:""),o=On((R=e==null?void 0:e.note)!=null?R:""),b=On((ue=e==null?void 0:e.id)!=null?ue:""),u=On((pe=e==null?void 0:e.stt)!=null?pe:""),I=`${t} ${a} ${r} ${o} ${b} ${u}`.trim();return{p:e,originalIndex:n,name:t,code:a,category:r,note:o,haystackAll:I}}),[Ht]),nr=(e,n,t)=>{var v,R,ue,pe,ft;const a=Array.isArray(n)?n:[],r=On(t).trim();if(!a.length&&!r)return 0;const o=(v=e==null?void 0:e.name)!=null?v:"",b=(R=e==null?void 0:e.code)!=null?R:"",u=(ue=e==null?void 0:e.category)!=null?ue:"",I=(pe=e==null?void 0:e.note)!=null?pe:"";if(!((ft=e==null?void 0:e.haystackAll)!=null?ft:""))return 0;let d=0;r&&(o===r&&(d+=220),o.includes(r)&&(d+=140),o.startsWith(r)&&(d+=160),b&&b===r&&(d+=180),b&&b.includes(r)&&(d+=90));for(const mt of a){if(!mt)continue;const tn=new RegExp(`(?:^|\\s)${mt.replace(/[.*+?^${}()|[\[\]\\]/g,"\\$&")}`);o.includes(mt)&&(d+=35),tn.test(o)&&(d+=25),b&&b.includes(mt)&&(d+=20),b&&tn.test(b)&&(d+=10),u&&u.includes(mt)&&(d+=12),I&&I.includes(mt)&&(d+=6)}return d>0&&o&&(d+=Math.max(0,10-Math.min(10,Math.floor(o.length/10)))),d},Va=(e,n)=>{const t=String(e||""),a=String(n||"");if(t===a)return 0;if(!t)return a.length;if(!a)return t.length;const r=t.length,o=a.length;if(o>r)return Va(a,t);let b=new Array(o+1),u=new Array(o+1);for(let I=0;I<=o;I++)b[I]=I;for(let I=1;I<=r;I++){u[0]=I;const y=t.charCodeAt(I-1);for(let v=1;v<=o;v++){const R=y===a.charCodeAt(v-1)?0:1;u[v]=Math.min(b[v]+1,u[v-1]+1,b[v-1]+R)}const d=b;b=u,u=d}return b[o]},ar=(e,n)=>{const t=String(e||"").trim(),a=String(n||"");if(!t||!a)return!1;if(a.includes(t))return!0;const r=a.split(/\s+/).filter(Boolean);if(!r.length)return!1;const o=t.length<=4?1:2;for(const b of r)if(!(Math.abs(b.length-t.length)>o)&&Va(t,b)<=o)return!0;return!1},_a=e=>{const n=On(e).replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim();return n?n.split(" ").filter(Boolean):[]},sr=(e,n)=>{const t=Array.isArray(n)?n:[];if(!t.length)return 0;const a=_a((e==null?void 0:e.name)||""),r=_a((e==null?void 0:e.code)||""),o=_a((e==null?void 0:e.category)||""),b=_a((e==null?void 0:e.note)||""),u=(y,d,v)=>{const R=String(y||"").trim();if(!R||!d.length)return 0;const ue=R.length<=4?1:2;let pe=1/0,ft=-1;for(let Mt=0;Mt<d.length;Mt++){const An=d[Mt];if(!An||Math.abs(An.length-R.length)>ue)continue;const zt=Va(R,An);if(zt<pe&&(pe=zt,ft=Mt,zt===0))break}if(pe===1/0||pe>ue)return 0;let tn=Math.round(v*(pe===0?1:pe===1?.65:.45));return ft===0?tn+=Math.round(v*.25):ft===1&&(tn+=Math.round(v*.12)),tn};let I=0;for(const y of t){if(!y)continue;const d=u(y,a,180),v=u(y,r,120),R=u(y,o,60),ue=u(y,b,30);I+=Math.max(d,v,R,ue)}if(I>0){const y=((e==null?void 0:e.name)||"").length;I+=Math.max(0,60-Math.min(60,Math.floor(y/2)))}return I},Wa=React.useRef(new Map);React.useEffect(()=>{Wa.current=new Map},[Ht]);const As=e=>{var y,d;const n=String(Tt[e]||"").trim();if(!n)return Ht;const{contentTokens:t,cleanedQuery:a}=tr(n);if(t.length===0)return Ht;const r=On(n).trim(),o=Wa.current.get(r);if(o)return o;const b=[];for(const v of Cs){const R=v.haystackAll;R&&t.some(ue=>R.includes(ue))&&b.push(v)}let u=b;if(u.length<8&&t.length>0){const v=[],R=new Set(u.map(ue=>{var pe,ft;return String((ft=(pe=ue.p)==null?void 0:pe.id)!=null?ft:"")+":"+String(ue.originalIndex)}));for(const ue of Cs){const pe=String((d=(y=ue.p)==null?void 0:y.id)!=null?d:"")+":"+String(ue.originalIndex);if(R.has(pe))continue;const ft=ue.haystackAll;ft&&t.some(mt=>ar(mt,ft))&&(v.push(ue),R.add(pe))}v.length&&(u=u.concat(v))}const I=u.map(v=>({entry:v,score:nr(v,t,a)})).map(v=>{if(v.score>0)return v;const R=sr(v.entry,t);return R>0?{...v,score:R}:v}).filter(v=>v.score>0).sort((v,R)=>R.score!==v.score?R.score-v.score:v.entry.originalIndex-R.entry.originalIndex).slice(0,40).map(v=>v.entry.p);return Wa.current.set(r,I),I},Cn=e=>{if(!e)return null;const n=String(e);return Ht.find(t=>String(t==null?void 0:t.id)===n)||null},Bn=e=>{if(e==null||e==="")return[];let n=e;if(typeof n=="string"){const t=n.trim();if(!t)return[];try{n=JSON.parse(t)}catch(a){return[]}}return Array.isArray(n)?n.map((t,a)=>{var b;if(!t||typeof t!="object")return null;const r=String((b=t.name)!=null?b:"").trim()||`Bi\u1EBFn th\u1EC3 ${a+1}`,o=(Array.isArray(t.options)?t.options:[]).map(u=>{var ft,mt,tn,Mt,An,zt,En;if(!u||typeof u!="object")return null;const I=String((ft=u.label)!=null?ft:"").trim();if(!I)return null;const y=(An=(Mt=(tn=(mt=u.price)!=null?mt:u.priceValue)!=null?tn:u.unit_price)!=null?Mt:u.unitPrice)!=null?An:null,d=y==null||y===""?NaN:typeof y=="number"?y:typeof y=="string"?us(y):Number(y),v=Number.isFinite(d)?Math.trunc(d):null,R=(En=(zt=u.price_delta)!=null?zt:u.priceDelta)!=null?En:null,ue=Number(R),pe=Number.isFinite(ue)?Math.trunc(ue):0;return{label:I,price:v,price_delta:pe}}).filter(Boolean);return{name:r,options:o}}).filter(Boolean):[]},fr=e=>{const n=Cn(e);return Bn(n==null?void 0:n.variants)},$a=e=>{if(!e||typeof e!="object")return"";const n=[];for(const[t,a]of Object.entries(e)){const r=String(t||"").trim(),o=String(a||"").trim();!r||!o||n.push(`${r}: ${o}`)}return n.join(", ")},aa=(e,n)=>{const t=us(e==null?void 0:e.price),a=Bn(e==null?void 0:e.variants);if(!a.length||!n||typeof n!="object")return t;let r=t,o=!1;for(const b of a){const u=String((b==null?void 0:b.name)||"").trim(),I=String((n==null?void 0:n[u])||"").trim();if(!u||!I)continue;const y=(Array.isArray(b.options)?b.options:[]).find(pe=>String((pe==null?void 0:pe.label)||"").trim()===I);if(!y)continue;const d=y==null?void 0:y.price,v=d==null||d===""?NaN:Number(d);if(Number.isFinite(v)){r=Math.max(0,Math.trunc(v)),o=!0;continue}const R=y==null?void 0:y.price_delta,ue=R==null||R===""?NaN:Number(R);Number.isFinite(ue)&&(r+=Math.trunc(ue))}return r},Ga=e=>window.KTM.orders.getOrderItems(e),Ts=e=>window.KTM.orders.getOrderTotalQty(e),sa=e=>window.KTM.orders.getOrderProductSummary(e,Cn),Ia=e=>window.KTM.orders.getOrderItemRows(e,Cn),ma=e=>window.KTM.orders.getOrderAdjustmentMoney(e),Gn=e=>window.KTM.orders.getOrderAdjustmentSummaryText(e),rr=e=>{const n=Ga(e),t=Ia(e),a=pa(n),r=ua(n),o=r.fee,b=ma(e),u=a+o+b,I=d=>{const v=Number(d)||0;return v>0?`+${jt(v)}`:jt(v)},y=[];if(e!=null&&e.customer_name&&y.push(`KH\xC1CH: ${e.customer_name}`),e!=null&&e.phone&&y.push(`S\u0110T: ${e.phone}`),e!=null&&e.address&&y.push(`\u0110\u1ECAA CH\u1EC8: ${e.address}`),((e==null?void 0:e.note)||"").trim()&&y.push(`GHI CH\xDA: ${(e.note||"").trim()}`),y.push(""),y.push("S\u1EA2N PH\u1EA8M:"),t.length)for(const d of t)y.push(`- ${d.name} (SL: ${d.qty})`);else{const d=sa(e);d&&d!=="\u2014"&&y.push(`- ${d}`)}y.push(""),y.push(`T\u1EA0M T\xCDNH: ${jt(a)}`),r.found&&o!==0&&y.push(`SHIP: ${jt(o)}`);{const d=window.KTM.orders.getOrderAdjustmentItems(e),v=(Array.isArray(d)?d:[]).map(pe=>{var ft;return{amount:Number((ft=pe==null?void 0:pe.amount)!=null?ft:0)||0,note:String((pe==null?void 0:pe.note)||"").trim()}}).filter(pe=>pe.amount!==0||!!pe.note),R=Gn(e);if(b!==0||v.length>0||!!R)if(v.length===1){const pe=v[0];y.push(`\u0110I\u1EC0U CH\u1EC8NH: ${I(b)}${pe.note?` \u2014 ${pe.note}`:""}`)}else{y.push(`\u0110I\u1EC0U CH\u1EC8NH: ${I(b)}${!v.length&&R?` \u2014 ${R}`:""}`);for(const pe of v)y.push(`- ${I(pe.amount)}${pe.note?`: ${pe.note}`:""}`)}}return y.push(`T\u1ED4NG: ${jt(u)}`),y.filter(Boolean).join(`
`)},Ra=async e=>{try{const n=await Sa(e),t=rr(n);await window.KTM.clipboard.writeText(t),typeof L=="function"?L("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng","success"):alert("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng")}catch(n){console.error(n),typeof L=="function"?L("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)","danger"):alert("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)")}},ua=e=>window.KTM.orders.getOrderShipInfo(e,Cn),pa=e=>window.KTM.orders.getItemsSubtotal(e,Cn),Ja=e=>{try{const n=e instanceof Date?e:new Date(e);if(!n||Number.isNaN(n.getTime()))return"";const t=n.getFullYear(),a=String(n.getMonth()+1).padStart(2,"0");return`${t}-${a}`}catch(n){return""}},Ua=()=>N?String(N):Ja(new Date),Ms=e=>{const n=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),t=Jt((e==null?void 0:e.phone)||""),a=String((e==null?void 0:e.address)||"").trim().toLowerCase(),r=ja(e).amount,b=(Array.isArray(e==null?void 0:e.items)?e.items:[]).map(u=>{var I;return{product_id:String((u==null?void 0:u.product_id)||"").trim(),quantity:Number((I=u==null?void 0:u.quantity)!=null?I:0),variant:String((u==null?void 0:u.variant)||"").trim()}}).filter(u=>u.product_id&&Number.isFinite(u.quantity)&&u.quantity>0).sort((u,I)=>u.product_id<I.product_id?-1:u.product_id>I.product_id?1:u.variant<I.variant?-1:u.variant>I.variant?1:u.quantity-I.quantity);return JSON.stringify({name:n,phone:t,address:a,items:b,adj:r})},Nn=React.useMemo(()=>{const e=Jt((f==null?void 0:f.phone)||"");if(!e)return{count:0,orders:[],monthKey:Ua()};const n=Ua(),a=(Array.isArray(Y)?Y:[]).filter(r=>{if(!r||bt&&String(r.id)===String(bt)||Jt(r.phone||"")!==e)return!1;const o=Ja(r.created_at);return o&&o===n}).sort((r,o)=>{const b=new Date(r.created_at).getTime(),u=new Date(o.created_at).getTime();return(Number.isFinite(u)?u:0)-(Number.isFinite(b)?b:0)});return{count:a.length,orders:a,monthKey:n}},[Y,f==null?void 0:f.phone,N,bt]),ir=e=>{var u;const n=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),t=Jt((e==null?void 0:e.phone)||""),a=String((e==null?void 0:e.address)||"").trim().toLowerCase(),r=ps((u=e==null?void 0:e.adjustment_amount)!=null?u:0),o=Ga(e),b=(Array.isArray(o)?o:[]).map(I=>{var y;return{product_id:String((I==null?void 0:I.product_id)||"").trim(),quantity:Number((y=I==null?void 0:I.quantity)!=null?y:0),variant:String((I==null?void 0:I.variant)||"").trim()}}).filter(I=>I.product_id&&Number.isFinite(I.quantity)&&I.quantity>0).sort((I,y)=>I.product_id<y.product_id?-1:I.product_id>y.product_id?1:I.variant<y.variant?-1:I.variant>y.variant?1:I.quantity-y.quantity);return JSON.stringify({name:n,phone:t,address:a,items:b,adj:r})},_s=React.useMemo(()=>{if(bt)return"";const e=Jt((f==null?void 0:f.phone)||"");if(!e)return"";const n=Ua(),t=Ms(f),a=Array.isArray(Y)?Y:[];for(const r of a){if(!r||bt&&String(r.id)===String(bt)||Jt(r.phone||"")!==e)continue;const o=Ja(r.created_at);if(!o||o!==n)continue;const b=ir(r);if(b&&b===t)return`\u0110\u01A1n n\xE0y gi\u1ED1ng 100% m\u1ED9t \u0111\u01A1n trong th\xE1ng ${n}${r!=null&&r.id?` (#${r.id})`:""}`}return""},[Y,f,N,bt]),$s=e=>{var An;const n=[],t=[],a=String((e==null?void 0:e.customer_name)||"").trim(),r=Jt((e==null?void 0:e.phone)||""),o=String((e==null?void 0:e.address)||"").trim();a||n.push("Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng"),r||n.push("Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i"),r&&!ea(r)&&n.push("S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)"),o||t.push("Thi\u1EBFu \u0111\u1ECBa ch\u1EC9");const u=(Array.isArray(e==null?void 0:e.items)?e.items:[]).filter(zt=>zt&&zt.product_id);u.length===0&&n.push("Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m"),u.some(zt=>{var Un;const En=Number((Un=zt==null?void 0:zt.quantity)!=null?Un:0);return!Number.isFinite(En)||En<=0})&&n.push("S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0");const y=new Set;let d=!1;for(const zt of u){const En=String(zt.product_id||"").trim(),Un=String((zt==null?void 0:zt.variant)||"").trim();if(!En)continue;const Dt=`${En}||${Un}`;if(y.has(Dt)){d=!0;break}y.add(Dt)}d&&t.push("S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)");const v=pa(u),R=ua(u),ue=R!=null&&R.found?Number((An=R==null?void 0:R.fee)!=null?An:0):0,pe=Array.isArray(e==null?void 0:e.adjustment_items)?e.adjustment_items:[],ft=Qn(pe),mt=Zn(ft),tn=ft.some(zt=>(Number(zt==null?void 0:zt.amount)||0)!==0&&!String((zt==null?void 0:zt.note)||"").trim());R!=null&&R.found&&(ue>=2e5||v>0&&ue>v*.6)&&t.push(`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${jt(ue)}`),tn&&t.push("C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh");const Mt=Math.abs(mt);return(Mt>=5e5||v>0&&Mt>v*.5)&&mt!==0&&t.push(`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${jt(mt)}`),{errors:n,warnings:t,canSubmit:n.length===0}},br=React.useMemo(()=>$s(f),[f,Ht]),It=React.useMemo(()=>{var Un;const e=String((f==null?void 0:f.customer_name)||"").trim(),n=Jt((f==null?void 0:f.phone)||""),t=String((f==null?void 0:f.address)||"").trim(),a=Array.isArray(f==null?void 0:f.items)?f.items:[],r=new Map;for(const Dt of a){const ra=String((Dt==null?void 0:Dt.product_id)||"").trim(),Ka=String((Dt==null?void 0:Dt.variant)||"").trim();if(!ra)continue;const Oa=`${ra}||${Ka}`;r.set(Oa,(r.get(Oa)||0)+1)}const o=a.map(Dt=>{var Is;const ra=String((Dt==null?void 0:Dt.product_id)||"").trim(),Ka=Number((Is=Dt==null?void 0:Dt.quantity)!=null?Is:0),Oa=ra?"":"Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m",dr=Number.isFinite(Ka)&&Ka>0?"":"S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0",mr=String((Dt==null?void 0:Dt.variant)||"").trim(),ur=`${ra}||${mr}`,pr=ra&&(r.get(ur)||0)>1?"S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)":"";return{productError:Oa,qtyError:dr,dupWarn:pr}}),b=a.filter(Dt=>Dt&&Dt.product_id),u=pa(b),I=ua(b),y=I!=null&&I.found?Number((Un=I==null?void 0:I.fee)!=null?Un:0):0,d=Array.isArray(f==null?void 0:f.adjustment_items)?f.adjustment_items:[],v=Qn(d),R=Zn(v),ue=v.some(Dt=>(Number(Dt==null?void 0:Dt.amount)||0)!==0&&!String((Dt==null?void 0:Dt.note)||"").trim()),pe=Math.abs(R),ft=ue?"C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh":"",mt=R!==0&&(pe>=5e5||u>0&&pe>u*.5)?`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${jt(R)}`:"",tn=I!=null&&I.found&&(y>=2e5||u>0&&y>u*.6)?`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${jt(y)}`:"",Mt=e?"":"Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng",An=n?ea(n)?"":"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)":"Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",zt=t?"":"Thi\u1EBFu \u0111\u1ECBa ch\u1EC9",En=!Mt&&!An&&o.every(Dt=>!Dt.productError&&!Dt.qtyError);return{nameError:Mt,phoneError:An,addressWarn:zt,items:o,shipAbnormalWarn:tn,adjustmentNoteWarn:ft,adjustmentAbnormalWarn:mt,canSubmit:En}},[f,Ht]),Da=async e=>{var u,I,y;const n=(e==null?void 0:e.mode)||"close",t=(e==null?void 0:e.origin)||"modal",a=$s(f);if(!a.canSubmit){const d=a.errors[0]||"Thi\u1EBFu d\u1EEF li\u1EC7u b\u1EAFt bu\u1ED9c";typeof L=="function"?L(d,"danger"):alert(d);return}if(!bt&&_s){const d=`${_s}

B\u1EA1n c\xF3 mu\u1ED1n ti\u1EBFp t\u1EE5c l\u01B0u kh\xF4ng?`;if(!window.confirm(d)){(Nn==null?void 0:Nn.count)>0&&w(!0),setTimeout(()=>{var ue;const R=document.getElementById("order-phone-input");R&&typeof R.scrollIntoView=="function"&&(R.scrollIntoView({block:"center",behavior:"smooth"}),(ue=R.focus)==null||ue.call(R))},0);return}}const r=Jt(f.phone),b=(Array.isArray(f.items)?f.items:[]).map(d=>{var v,R;return{product_id:(d==null?void 0:d.product_id)||"",quantity:Number((v=d==null?void 0:d.quantity)!=null?v:1),variant:String((d==null?void 0:d.variant)||"").trim()||null,variant_json:(R=d==null?void 0:d.variant_json)!=null?R:null,unit_price:(()=>{const ue=d==null?void 0:d.unit_price,pe=ue===""||ue==null?NaN:Number(ue);if(Number.isFinite(pe))return Math.max(0,Math.trunc(pe));const ft=Cn(d==null?void 0:d.product_id),mt=d!=null&&d.variant_json&&typeof d.variant_json=="object"?d.variant_json:null;return aa(ft,mt)})()}}).filter(d=>d.product_id&&Number.isFinite(d.quantity)&&d.quantity>0);S(!0);try{const d=bt,v=bt?`${API_BASE}/api/orders/${bt}`:`${API_BASE}/api/orders`,R=b[0],ue=Array.isArray(f==null?void 0:f.adjustment_items)?f.adjustment_items:[],pe=Qn(ue),ft=Zn(pe),mt=Fa(pe),tn={customer_name:f.customer_name,phone:r,address:f.address,note:(f.note||"").trim(),adjustment_amount:ft,adjustment_note:mt,adjustment_items:pe,product_id:R.product_id,quantity:R.quantity,status:f.status,items:b,...bt?{id:bt}:{}};if(bt)await window.KTM.api.putJSON(v,tn,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");else{const Mt=await window.KTM.api.postJSON(v,tn,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");xn.current={id:(y=(I=Mt==null?void 0:Mt.id)!=null?I:(u=Mt==null?void 0:Mt.order)==null?void 0:u.id)!=null?y:null,fingerprint:Ms(f),ts:Date.now()}}if(Js(r,f.customer_name,f.address),t==="drawer"){if(Vn(""),rn(null),Je(!1),bn(!1),w(!1),Qe([]),Wn(),d){_t(!0),Ft("");try{const Mt=await Ba(d);Mt&&typeof Mt=="object"&&ct(Mt)}catch(Mt){Ft((Mt==null?void 0:Mt.message)||"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c chi ti\u1EBFt \u0111\u01A1n")}finally{_t(!1)}}}else n==="new"&&!bt?(Vn(""),rn(null),Je(!0)):(Vn(""),rn(null),Je(!1)),Wn()}catch(d){console.error(d),typeof L=="function"?L(d.message,"danger"):alert(d.message);return}finally{S(!1)}},ha=e=>window.KTM.orders.getOrderTotalMoney(e,Cn),gr=async e=>{if(confirm("X\xF3a \u0111\u01A1n h\xE0ng n\xE0y?")){fe(e);try{await window.KTM.api.deleteJSON(`${API_BASE}/api/orders/${e}`,"L\u1ED7i x\xF3a \u0111\u01A1n h\xE0ng"),Wn(),Ta()}catch(n){console.error(n),typeof L=="function"?L(n.message,"danger"):alert(n.message)}finally{fe(null)}}},or=()=>{const e=wn.current;if(!e)return;if(e.timer){try{clearTimeout(e.timer)}catch(o){}e.timer=null}const n=Array.isArray(e.events)?e.events.splice(0):[];if(!n.length||typeof L!="function")return;const t=new Map;for(const o of n){const b=String((o==null?void 0:o.orderId)||"").trim();b&&t.set(b,o)}const a=Array.from(t.values());if(!a.length)return;const r=o=>async()=>{try{for(const b of o)!(b!=null&&b.prevStatus)||!(b!=null&&b.orderId)||await Jn({id:b.orderId,status:b.nextStatus},b.prevStatus,{silentToast:!0,skipToastBatch:!0,fromUndo:!0});L(o.length>1?`\u0110\xE3 ho\xE0n t\xE1c ${o.length} \u0111\u01A1n`:"\u0110\xE3 ho\xE0n t\xE1c","info")}catch(b){L("Ho\xE0n t\xE1c th\u1EA5t b\u1EA1i","danger")}};if(a.length===1){const o=a[0],b=`${Mn(o.prevStatus)} \u2192 ${Mn(o.nextStatus)}`.trim();L(`\u0110\xE3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i: ${b}`,"success",{actionLabel:"Undo",durationMs:8500,onAction:r([o])});return}L(`\u0110\xE3 c\u1EADp nh\u1EADt ${a.length} \u0111\u01A1n`,"success",{actionLabel:"Undo",durationMs:9500,onAction:r(a)})},cr=e=>{const n=wn.current;n&&(Array.isArray(n.events)||(n.events=[]),n.events.push(e),!n.timer&&(n.timer=setTimeout(()=>or(),320)))};useEffect(()=>()=>{try{const e=wn.current;e!=null&&e.timer&&clearTimeout(e.timer)}catch(e){}},[]);const Jn=async(e,n,t={})=>{var b;const a=await Sa(e),r=a==null?void 0:a.id;if(!r||!n)return;const o=gn(a==null?void 0:a.status);oe(r);try{const u=Ga(a),I=(Array.isArray(u)?u:[]).map(v=>{var R,ue;return{product_id:(v==null?void 0:v.product_id)||"",quantity:Number((R=v==null?void 0:v.quantity)!=null?R:1),variant:String((v==null?void 0:v.variant)||"").trim()||null,variant_json:(ue=v==null?void 0:v.variant_json)!=null?ue:null,unit_price:(()=>{var mt;const pe=(mt=v==null?void 0:v.unit_price)!=null?mt:v==null?void 0:v.unitPrice,ft=Number(pe);return Number.isFinite(ft)?Math.max(0,Math.trunc(ft)):null})()}}).filter(v=>v.product_id&&Number.isFinite(v.quantity)&&v.quantity>0);if(!I.length)throw new Error("Kh\xF4ng th\u1EC3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i: \u0111\u01A1n kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m h\u1EE3p l\u1EC7");const y=I[0],d={id:r,customer_name:(a==null?void 0:a.customer_name)||"",phone:Jt((a==null?void 0:a.phone)||""),address:(a==null?void 0:a.address)||"",note:((a==null?void 0:a.note)||"").trim(),adjustment_amount:Number((b=a==null?void 0:a.adjustment_amount)!=null?b:0)||0,adjustment_note:(a==null?void 0:a.adjustment_note)||"",product_id:y.product_id,quantity:y.quantity,status:n,items:I};if(await window.KTM.api.putJSON(`${API_BASE}/api/orders/${r}`,d,"L\u1ED7i c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i"),te(v=>Array.isArray(v)?v.map(R=>(R==null?void 0:R.id)===r?{...R,status:n}:R):v),Be(v=>Array.isArray(v)?v.map(R=>(R==null?void 0:R.id)===r?{...R,status:n}:R):v),ga(r,!1),Hs(r),t!=null&&t.silentToast)return;if(t!=null&&t.skipToastBatch){typeof L=="function"&&L("\u0110\xE3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i","success",{durationMs:4500});return}cr({orderId:r,prevStatus:o,nextStatus:gn(n)})}catch(u){if(console.error(u),(!navigator.onLine||(u==null?void 0:u.name)==="TypeError"||String((u==null?void 0:u.message)||"").toLowerCase().includes("failed to fetch"))&&!(t!=null&&t.fromSync)){te(y=>Array.isArray(y)?y.map(d=>(d==null?void 0:d.id)===r?{...d,status:n}:d):y),Be(y=>Array.isArray(y)?y.map(d=>(d==null?void 0:d.id)===r?{...d,status:n}:d):y),Bs(r,n,o),typeof L=="function"&&L("M\u1EA5t m\u1EA1ng/timeout \u2022 \u0110\xE3 x\u1EBFp h\xE0ng \u0111\u1ED3ng b\u1ED9","info",{durationMs:6500});return}typeof L=="function"?L(u.message,"danger"):alert(u.message)}finally{oe(null)}};useEffect(()=>{const e=n=>{var a;const t=(a=n==null?void 0:n.detail)==null?void 0:a.key;if(t){if(t==="/"){setTimeout(()=>{var r,o;(o=(r=cn.current)==null?void 0:r.focus)==null||o.call(r)},0);return}if(t==="N"||t==="n"){Ma();return}if((t==="j"||t==="J"||t==="k"||t==="K")&&At&&(Me!=null&&Me.id)){const r=Array.isArray(nn)?nn:[],o=r.findIndex(I=>String(I==null?void 0:I.id)===String(Me==null?void 0:Me.id));if(o<0)return;const u=r[o+(t==="j"||t==="J"?-1:1)];u&&da(u)}}};return window.addEventListener("ktm-admin-hotkey",e),()=>window.removeEventListener("ktm-admin-hotkey",e)},[nn,At,Me]);const lr=()=>React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"T\xEAn kh\xE1ch h\xE0ng *"),React.createElement("input",{className:"form-control",value:f.customer_name,onChange:e=>ye({...f,customer_name:e.target.value}),placeholder:"Nh\u1EADp t\xEAn kh\xE1ch h\xE0ng",required:!0,style:{borderRadius:10,padding:12}}),!!It.nameError&&React.createElement("div",{className:"form-text text-danger"},It.nameError)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i *"),React.createElement("input",{className:"form-control",type:"tel",inputMode:"numeric",pattern:"[0-9+\\s-]*",id:"order-phone-input",value:f.phone,onChange:e=>bs(e.target.value),onBlur:gs,placeholder:"Nh\u1EADp s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",required:!0,style:{borderRadius:10,padding:12}}),!!It.phoneError&&React.createElement("div",{className:"form-text text-danger"},It.phoneError),!It.phoneError&&Nn.count>0&&React.createElement("div",{className:"form-text text-warning d-flex align-items-center justify-content-between gap-2"},React.createElement("span",null,"Kh\xE1ch n\xE0y \u0111\xE3 c\xF3 ",Nn.count," \u0111\u01A1n trong th\xE1ng ",Nn.monthKey,"."),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>w(e=>!e)},K?"\u1EA8n l\u1ECBch s\u1EED":"Xem l\u1ECBch s\u1EED")),K&&Nn.orders.length>0&&React.createElement("div",{className:"mt-2 border rounded-3 p-2",style:{background:"#fff"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between gap-2 mb-2"},React.createElement("div",{className:"small fw-semibold"},"L\u1ECBch s\u1EED \u0111\u01A1n (c\xF9ng th\xE1ng)"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>w(!1)},"\u1EA8n")),React.createElement("div",{className:"d-grid gap-2"},Nn.orders.slice(0,5).map(e=>React.createElement("div",{key:e.id,className:"d-flex align-items-start justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"small fw-semibold",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},"#",e.id," \u2022 ",React.createElement("span",{className:`badge ${ta(e.status)}`},Mn(e.status))),React.createElement("div",{className:"text-muted small"},na(e.created_at)," \u2022 ",jt(ha(e))),React.createElement("div",{className:"text-muted small",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},sa(e))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{confirm(`M\u1EDF \u0111\u01A1n #${e.id}? D\u1EEF li\u1EC7u \u0111ang nh\u1EADp s\u1EBD m\u1EA5t.`)&&za(e)}},"M\u1EDF")))),Nn.orders.length>5&&React.createElement("div",{className:"text-muted small mt-2"},"Ch\u1EC9 hi\u1EC3n th\u1ECB 5 \u0111\u01A1n g\u1EA7n nh\u1EA5t.")),(O==null?void 0:O.status)==="loading"&&React.createElement("div",{className:"form-text"},"\u0110ang t\xECm kh\xE1ch theo S\u0110T..."),(O==null?void 0:O.status)==="found"&&React.createElement("div",{className:"form-text text-success"},"\u0110\xE3 c\xF3 kh\xE1ch, t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n th\xF4ng tin."),(O==null?void 0:O.status)==="not-found"&&React.createElement("div",{className:"form-text text-muted"},"Ch\u01B0a c\xF3 kh\xE1ch, s\u1EBD t\u1EA1o m\u1EDBi khi l\u01B0u \u0111\u01A1n."),(O==null?void 0:O.status)==="error"&&React.createElement("div",{className:"form-text text-danger"},"Kh\xF4ng tra \u0111\u01B0\u1EE3c kh\xE1ch (l\u1ED7i m\u1EA1ng/server).")),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("select",{className:"form-select",value:f.status,onChange:e=>ye({...f,status:e.target.value}),style:{borderRadius:10,padding:12}},React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n"))),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("input",{className:"form-control",value:f.address,onChange:e=>ye({...f,address:e.target.value}),placeholder:"Nh\u1EADp \u0111\u1ECBa ch\u1EC9 (kh\xF4ng b\u1EAFt bu\u1ED9c)",style:{borderRadius:10,padding:12}}),!!It.addressWarn&&React.createElement("div",{className:"form-text text-warning"},It.addressWarn)),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111\u01A1n h\xE0ng"),React.createElement("textarea",{className:"form-control",value:f.note,onChange:e=>ye({...f,note:e.target.value}),placeholder:"V\xED d\u1EE5: Giao gi\u1EDD h\xE0nh ch\xEDnh / G\u1ECDi tr\u01B0\u1EDBc khi giao...",rows:2,style:{borderRadius:10,padding:12,resize:"vertical"}})),React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110i\u1EC1u ch\u1EC9nh gi\xE1 (th\xEAm/b\u1EDBt)"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{ye(e=>({...e,adjustment_items:[...Array.isArray(e.adjustment_items)?e.adjustment_items:[{amount:"",note:""}],{amount:"",note:""}]}))}},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm \u0111i\u1EC1u ch\u1EC9nh")),React.createElement("div",{className:"d-grid gap-2"},Kn(f.adjustment_items).map((e,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label small text-muted mb-1"},"S\u1ED1 ti\u1EC1n"),React.createElement("input",{type:"text",inputMode:"numeric",className:"form-control",value:e.amount,onChange:t=>{const a=t.target.value;ye(r=>{const o=Kn(r.adjustment_items);return o[n]={...o[n],amount:a},{...r,adjustment_items:o}})},placeholder:"+500000 ho\u1EB7c -200000",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("label",{className:"form-label small text-muted mb-1"},"Ghi ch\xFA"),React.createElement("input",{className:"form-control",value:e.note,onChange:t=>{const a=t.target.value;ye(r=>{const o=Kn(r.adjustment_items);return o[n]={...o[n],note:a},{...r,adjustment_items:o}})},placeholder:"V\xED d\u1EE5: th\xEAm van 1 tay / gi\u1EA3m gi\xE1...",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-1 d-flex"},React.createElement("button",{type:"button",className:"btn btn-outline-danger w-100",onClick:()=>{ye(t=>{const a=Kn(t.adjustment_items);return a.splice(n,1),{...t,adjustment_items:a.length?a:[{amount:"",note:""}]}})},disabled:C||Kn(f.adjustment_items).length<=1,title:"X\xF3a \u0111i\u1EC1u ch\u1EC9nh",style:{borderRadius:10,padding:12}},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement("div",{className:"form-text"},"\xC2m = gi\u1EA3m gi\xE1, d\u01B0\u01A1ng = c\u1ED9ng th\xEAm."),!!It.adjustmentAbnormalWarn&&React.createElement("div",{className:"form-text text-warning"},It.adjustmentAbnormalWarn),!!It.adjustmentNoteWarn&&React.createElement("div",{className:"form-text text-warning"},It.adjustmentNoteWarn)),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1EA3n ph\u1EA9m *"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{ye(e=>({...e,items:[...Array.isArray(e.items)?e.items:[],{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]})),$t(e=>[...Array.isArray(e)?e:[],""]),bt&&Qe(e=>[...Array.isArray(e)?e:[],!0])},disabled:C},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(f.items)?f.items:[{product_id:"",quantity:1}]).map((e,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"dropdown w-100",ref:t=>{Qt.current[n]=t}},React.createElement("button",{type:"button",className:"form-control text-start d-flex align-items-center justify-content-between",style:{borderRadius:10,padding:12},onClick:()=>{qt(t=>t===n?null:n),setTimeout(()=>{const t=document.getElementById(`order-product-search-${n}`);t&&t.focus()},0)}},React.createElement("span",{className:e.product_id?"":"text-muted",style:{minWidth:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},ks(e.product_id)),React.createElement("i",{className:"fas fa-chevron-down text-muted",style:{marginLeft:8,flexShrink:0}})),Ot===n&&React.createElement("div",{className:"dropdown-menu show w-100 p-2",style:{maxHeight:320,overflowY:"auto"}},React.createElement("input",{id:`order-product-search-${n}`,className:"form-control",value:Tt[n]||"",onChange:t=>{const a=t.target.value;$t(r=>{const o=Array.isArray(r)?[...r]:[];return o[n]=a,o})},placeholder:"T\xECm theo t\xEAn / m\xE3...",style:{borderRadius:10,padding:10}}),React.createElement("div",{className:"mt-2"}),(()=>{const t=As(n);return t.length===0?React.createElement("div",{className:"text-muted small px-2 py-1"},"Kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p"):t.map(a=>React.createElement("button",{key:a.id,type:"button",className:"dropdown-item",onClick:()=>{const r=String(a.id),o=Bn(a==null?void 0:a.variants),b={};for(const y of o){const d=String((y==null?void 0:y.name)||"").trim(),v=Array.isArray(y==null?void 0:y.options)?y.options[0]:null,R=String((v==null?void 0:v.label)||"").trim();d&&R&&(b[d]=R)}const u=$a(b),I=aa(a,b);ye(y=>{const d=Array.isArray(y.items)?[...y.items]:[];return d[n]={...d[n]||{quantity:1},product_id:r,variant_json:Object.keys(b).length?b:null,variant:u,unit_price:o.length?I:null},{...y,items:d}}),qt(null)}},a.name,a.code?` (${a.code})`:""))})()),React.createElement("select",{className:"form-select",value:e.product_id,onChange:()=>{},required:!0,style:{position:"absolute",opacity:0,height:0,pointerEvents:"none"},tabIndex:-1,"aria-hidden":"true"},React.createElement("option",{value:""},"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"),Ht.map(t=>React.createElement("option",{key:t.id,value:t.id},t.name)))),(()=>{var a;const t=(a=It.items)==null?void 0:a[n];return t?React.createElement(React.Fragment,null,!!t.productError&&React.createElement("div",{className:"form-text text-danger"},t.productError),!!t.dupWarn&&React.createElement("div",{className:"form-text text-warning"},t.dupWarn)):null})(),(()=>{if(!(e!=null&&e.product_id))return null;const t=Cn(e.product_id),a=Bn(t==null?void 0:t.variants);if(!a.length)return null;const r=e!=null&&e.variant_json&&typeof e.variant_json=="object"?e.variant_json:{};return React.createElement("div",{className:"mt-2 d-grid gap-2"},a.map((o,b)=>{const u=String((o==null?void 0:o.name)||`Bi\u1EBFn th\u1EC3 ${b+1}`).trim(),I=String((r==null?void 0:r[u])||"").trim();return React.createElement("div",{key:u},React.createElement("label",{className:"form-label small text-muted mb-1"},u),React.createElement("select",{className:"form-select",value:I,onChange:y=>{const d=String(y.target.value||"").trim();ye(v=>{const R=Array.isArray(v.items)?[...v.items]:[],ue={...R[n]||{}},pe=Cn(ue.product_id),ft=Bn(pe==null?void 0:pe.variants),mt=ue!=null&&ue.variant_json&&typeof ue.variant_json=="object"?{...ue.variant_json}:{};d?mt[u]=d:delete mt[u];const tn=$a(mt),Mt=aa(pe,mt);return R[n]={...ue,variant_json:Object.keys(mt).length?mt:null,variant:tn,unit_price:Mt},{...v,items:R}})},style:{borderRadius:10,padding:12}},React.createElement("option",{value:""},"-- ch\u1ECDn ",u," --"),(Array.isArray(o==null?void 0:o.options)?o.options:[]).map(y=>React.createElement("option",{key:y.label,value:y.label},y.label,Number.isFinite(Number(y==null?void 0:y.price))?` (${jt(Number(y.price))})`:Number(y==null?void 0:y.price_delta)?` (${y.price_delta>0?"+":""}${y.price_delta})`:""))))}))})(),bt&&React.createElement("div",{className:"form-check mt-1"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:`order-split-deliver-${n}`,checked:!!He[n],onChange:t=>{const a=!!t.target.checked;Qe(r=>{const o=Array.isArray(r)?[...r]:[],b=Array.isArray(f.items)?f.items.length:0;for(;o.length<b;)o.push(!0);return o[n]=a,o})},disabled:C||le}),React.createElement("label",{className:"form-check-label small text-muted",htmlFor:`order-split-deliver-${n}`},"Giao \u0111\u1EE3t 1"))),React.createElement("div",{className:"col-8 col-md-3"},React.createElement("input",{type:"number",className:"form-control",value:e.quantity,onChange:t=>{const a=t.target.value;ye(r=>{const o=Array.isArray(r.items)?[...r.items]:[];return o[n]={...o[n]||{product_id:""},quantity:a},{...r,items:o}})},min:"1",style:{borderRadius:10,padding:12}}),(()=>{var a;const t=(a=It.items)==null?void 0:a[n];return t&&t.qtyError?React.createElement("div",{className:"form-text text-danger"},t.qtyError):null})()),React.createElement("div",{className:"col-4 col-md-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>{ye(t=>{const a=Array.isArray(t.items)?[...t.items]:[];return a.splice(n,1),{...t,items:a.length?a:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]}}),$t(t=>{const a=Array.isArray(t)?[...t]:[];return a.splice(n,1),a.length?a:[""]}),Qe(t=>{const a=Array.isArray(t)?[...t]:[];return a.splice(n,1),a}),qt(t=>t==null?t:t===n?null:t>n?t-1:t)},disabled:C||le||(Array.isArray(f.items)?f.items.length:1)<=1,title:"X\xF3a s\u1EA3n ph\u1EA9m",style:{borderRadius:10,padding:10}},React.createElement("i",{className:"fas fa-trash"}))))))),(()=>{const n=(Array.isArray(f.items)?f.items:[]).filter(u=>u==null?void 0:u.product_id),t=pa(n),a=ua(n),r=ja(f),o=r.amount,b=t+(a.found?a.fee:0)+o;return React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-column gap-1 small bg-light rounded-3 p-3"},React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1EA1m t\xEDnh"),React.createElement("span",{className:"fw-semibold"},jt(t))),a.found&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"Ship"),React.createElement("span",{className:"fw-semibold"},jt(a.fee))),!!It.shipAbnormalWarn&&React.createElement("div",{className:"text-warning"},It.shipAbnormalWarn),o!==0&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh"),React.createElement("span",{className:"fw-semibold"},jt(o))),(f.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111\u01A1n: ",(f.note||"").trim()),!!r.summaryText&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh: ",r.summaryText),React.createElement("div",{className:"d-flex justify-content-between pt-1 border-top"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng"),React.createElement("span",{className:"fw-bold"},jt(b)))))})());return React.createElement("div",{className:"product-manager"},React.createElement(Loading,{show:C||!!B||!!ge}),React.createElement("div",{className:"orders-ops-toolbar card p-3"},React.createElement("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0}},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("h5",{className:"mb-0"},"\u0110\u01A1n h\xE0ng"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},Fn.all," \u0111\u01A1n"),ot&&React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-25 text-dark"},"Search mode")),React.createElement("div",{className:"text-muted small mt-1"},"Hotkeys: ",React.createElement("span",{className:"fw-semibold"},"/")," search \u2022 ",React.createElement("span",{className:"fw-semibold"},"N")," t\u1EA1o \u0111\u01A1n \u2022 ",React.createElement("span",{className:"fw-semibold"},"Esc")," \u0111\xF3ng drawer")),React.createElement("div",{className:"d-flex gap-2"},React.createElement("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>ot?Ss(at):Wn(),disabled:an,title:"L\xE0m m\u1EDBi"},React.createElement("i",{className:"fas fa-rotate"})),React.createElement("button",{className:"btn btn-dark btn-sm",onClick:()=>Ma(),disabled:C||!!B},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o \u0111\u01A1n"))),React.createElement("div",{className:"orders-chip-row mt-3"},React.createElement("button",{type:"button",className:`orders-chip d-md-none ${me&&!$e&&!ot?"active":""}`,onClick:()=>{ot&&Re(""),ke(!1),Ue(!1),Ae(e=>!e)},title:"\u0110\u01A1n \u01B0u ti\xEAn (\u0111\xE3 ghim)"},React.createElement("i",{className:"fas fa-star me-1"}),"\u01AFu ti\xEAn"," ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Us)),React.createElement("button",{type:"button",className:`orders-chip d-md-none ${Ie&&!$e&&!ot?"active":""}`,onClick:()=>{ot&&Re(""),ke(!1),Ae(!1),Ue(e=>!e)},title:"\u0110\u01A1n c\u1EA7n x\u1EED l\xFD h\xF4m nay"},React.createElement("i",{className:"fas fa-calendar me-1"}),"H\xF4m nay"," ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Ys)),React.createElement("button",{type:"button",className:`orders-chip ${!J&&!$e&&!ot?"active":""}`,onClick:()=>{ot&&Re(""),ke(!1),ae("")}},"T\u1EA5t c\u1EA3 ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Fn.all)),React.createElement("button",{type:"button",className:`orders-chip ${J==="draft"&&!$e&&!ot?"active":""}`,onClick:()=>{ot&&Re(""),ke(!1),ae("draft"),j("")}},"Nh\xE1p ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Fn.draft)),React.createElement("button",{type:"button",className:`orders-chip ${J==="pending"&&!$e&&!ot?"active":""}`,onClick:()=>{ot&&Re(""),ke(!1),ae("pending")}},"Ch\u1EDD x\u1EED l\xFD ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Fn.pending)),React.createElement("button",{type:"button",className:`orders-chip ${J==="processing"&&!$e&&!ot?"active":""}`,onClick:()=>{ot&&Re(""),ke(!1),ae("processing")}},"V\u1EADn chuy\u1EC3n ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Fn.processing)),React.createElement("button",{type:"button",className:`orders-chip ${J==="done"&&!$e&&!ot?"active":""}`,onClick:()=>{ot&&Re(""),ke(!1),ae("done")}},"Ho\xE0n th\xE0nh ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Fn.done)),React.createElement("button",{type:"button",className:`orders-chip ${J==="paid"&&!$e&&!ot?"active":""}`,onClick:()=>{ot&&Re(""),ke(!1),ae("paid")}},"\u0110\xE3 nh\u1EADn ti\u1EC1n ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Fn.paid)),React.createElement("button",{type:"button",className:`orders-chip ${J==="canceled"&&!$e&&!ot?"active":""}`,onClick:()=>{ot&&Re(""),ke(!1),ae("canceled")}},"H\u1EE7y ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Fn.canceled))),React.createElement("div",{className:"orders-presets mt-2 d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>Pn("thisMonth"),disabled:ot},React.createElement("i",{className:"fas fa-calendar me-2"}),"Th\xE1ng n\xE0y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger",onClick:()=>Pn("overduePending"),disabled:ot},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"Ch\u1EADm > ",Dn," ng\xE0y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>Pn("draftExpiring"),disabled:ot},React.createElement("i",{className:"fas fa-clock me-2"}),"Nh\xE1p s\u1EAFp h\u1EE7y"),(J||$e||!N&&!ot)&&React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>Pn("all")},"Clear")),React.createElement("div",{className:"orders-filterbar mt-3 d-flex flex-wrap gap-2 align-items-center"},React.createElement("div",{className:"input-group input-group-sm orders-search"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-search"})),React.createElement("input",{ref:cn,type:"text",className:"form-control",value:at,onChange:e=>Re(e.target.value),placeholder:"Search t\xEAn / S\u0110T\u2026 (nh\u1EA5n /)","aria-label":"Search \u0111\u01A1n h\xE0ng theo t\xEAn ho\u1EB7c S\u0110T"}),String(at||"").trim()&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>Re(""),disabled:an},React.createElement("i",{className:"fas fa-times"})),an&&React.createElement("span",{className:"input-group-text",title:"\u0110ang search...","aria-label":"\u0110ang search"},React.createElement("span",{className:"spinner-border spinner-border-sm text-warning",role:"status","aria-hidden":"true"}))),React.createElement("div",{className:"input-group input-group-sm orders-month"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:N,onChange:e=>j(e.target.value),"aria-label":"Ch\u1ECDn th\xE1ng",disabled:$e||ot})),React.createElement("div",{className:"text-muted small ms-auto"},ot?"Search b\u1ECF qua filter":$e?"\u0110ang xem \u0111\u01A1n ch\u1EADm":J?`L\u1ECDc: ${Mn(J)}`:""))),React.createElement("div",{className:`orders-context-header d-md-none ${A?"visible":""}`},React.createElement("div",{className:"orders-context-text"},(()=>{if(ot){const e=String(at||"").trim();return`Search: ${e?`"${e}"`:""} \u2022 ${nn.length} k\u1EBFt qu\u1EA3`}return $e?`\u0110\u01A1n ch\u1EADm \u2022 ${nn.length} \u0111\u01A1n`:me?`\u01AFu ti\xEAn \u2022 ${nn.length} \u0111\u01A1n`:Ie?`H\xF4m nay \u2022 ${nn.length} \u0111\u01A1n`:J?`L\u1ECDc: ${Mn(J)} \u2022 ${nn.length} \u0111\u01A1n`:`T\u1EA5t c\u1EA3 \u2022 ${nn.length} \u0111\u01A1n`})()),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{Re(""),Ae(!1),Ue(!1),Pn("all")},"aria-label":"Clear"},"Clear")),React.createElement("div",{className:"card p-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},"Danh s\xE1ch \u0111\u01A1n h\xE0ng"),React.createElement("span",{className:"text-muted small"},ot?`${nn.length} k\u1EBFt qu\u1EA3`:J?`${Aa.length}/${be.length} \u0111\u01A1n`:`${be.length}${Oe?"+":""} \u0111\u01A1n`)),ot&&Pt&&React.createElement("div",{className:"alert alert-danger mt-3 mb-0",role:"alert"},Pt),Ca.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"C\xF3 ",React.createElement("strong",null,Ca.length)," \u0111\u01A1n ",React.createElement("strong",null,"Ch\u1EDD x\u1EED l\xFD")," qu\xE1 ",Dn," ng\xE0y.",Ee&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{ke(!0),ae("pending")}},"Xem ngay")),ys.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-clock me-2"}),"C\xF3 ",React.createElement("strong",null,ys.length)," \u0111\u01A1n ",React.createElement("strong",null,"Nh\xE1p")," s\u1EAFp t\u1EF1 h\u1EE7y (c\xF2n \u2264 ",Ea," ng\xE0y).",Ct&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{ke(!1),ae("draft"),j(""),Wn()}},"Xem ngay")),(ot?an:Xe)?React.createElement("div",{className:"orders-skeleton-wrap mt-3"},React.createElement("div",{className:"d-md-none"},new Array(6).fill(0).map((e,n)=>React.createElement("div",{key:n,className:"card mb-2"},React.createElement("div",{className:"card-body p-3"},React.createElement("div",{className:"admin-skeleton-line w-50 mb-2"}),React.createElement("div",{className:"admin-skeleton-line w-75 mb-2"}),React.createElement("div",{className:"admin-skeleton-line w-35"}))))),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive orders-table-wrap mt-3"},React.createElement("table",{className:"table orders-table align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"SL"),React.createElement("th",null,"T\u1ED5ng ti\u1EC1n"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"),React.createElement("th",null,"Th\u1EDDi gian"),React.createElement("th",null))),React.createElement("tbody",null,new Array(10).fill(0).map((e,n)=>React.createElement("tr",{key:n},React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-60"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-70"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-85"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-30"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-50"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-40"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-55"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-40"}))))))))):(ot?nn.length===0:be.length===0)?React.createElement("div",{className:"text-center py-4 text-muted"},ot?"Kh\xF4ng c\xF3 k\u1EBFt qu\u1EA3":"Ch\u01B0a c\xF3 \u0111\u01A1n h\xE0ng"):!ot&&Aa.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},"Kh\xF4ng c\xF3 \u0111\u01A1n ph\xF9 h\u1EE3p"):React.createElement(React.Fragment,null,React.createElement("div",{className:"d-md-none mt-3"},Ns.map(e=>{var n;return React.createElement("div",{key:e.id,className:`orders-mobile-swipe-shell mb-2 ${(vt==null?void 0:vt.id)===String(e.id)?`swipe-preview swipe-${(vt==null?void 0:vt.dir)||""}`:""}`,role:"button",tabIndex:0,onClick:()=>{if(dn.current){dn.current=!1;return}da(e)},onPointerDown:t=>{if(ne||i||Vt||t.button!=null&&t.button!==0)return;const a=String(e.id);dn.current=!1,Ge.current={active:!0,id:a,startX:t.clientX,startY:t.clientY,dx:0,dy:0,lock:null,pointerId:t.pointerId,captured:!1},nt(r=>(r==null?void 0:r.id)===a?r:{id:a,dir:null});try{t.currentTarget.classList.remove("swiping"),t.currentTarget.style.setProperty("--swipe-x","0px"),t.currentTarget.style.setProperty("--swipe-p","0"),t.currentTarget.style.setProperty("--swipe-l","0"),t.currentTarget.style.setProperty("--swipe-r","0")}catch(r){}try{sn.current&&clearTimeout(sn.current)}catch(r){}fn.current=a,sn.current=setTimeout(async()=>{var o,b,u,I;const r=fn.current;if(r)try{if((b=(o=Wt.current)==null?void 0:o.has)!=null&&b.call(o,r))return;const y=await Ba(r);y&&typeof y=="object"&&((I=(u=Wt.current)==null?void 0:u.set)==null||I.call(u,r,y))}catch(y){}},150)},onPointerMove:t=>{const a=Ge.current;if(!(a!=null&&a.active)||String(a.id)!==String(e.id))return;const r=t.clientX-a.startX,o=t.clientY-a.startY;if(a.dx=r,a.dy=o,Math.abs(r)>14||Math.abs(o)>14){try{sn.current&&clearTimeout(sn.current)}catch(R){}sn.current=null,fn.current=null}if(!a.lock){const R=Math.abs(r),ue=Math.abs(o);if((R>10||ue>10)&&(a.lock=R>ue*1.2?"x":"y",a.lock==="x"&&!a.captured))try{t.currentTarget.setPointerCapture(t.pointerId),a.captured=!0}catch(pe){}}if(a.lock!=="x"){try{t.currentTarget.classList.remove("swiping"),t.currentTarget.style.setProperty("--swipe-x","0px"),t.currentTarget.style.setProperty("--swipe-p","0"),t.currentTarget.style.setProperty("--swipe-l","0"),t.currentTarget.style.setProperty("--swipe-r","0")}catch(R){}Math.abs(o)>24&&nt(R=>(R==null?void 0:R.id)===a.id?{id:a.id,dir:null}:R);return}const b=!!Yn(e==null?void 0:e.status,"right"),u=!!Yn(e==null?void 0:e.status,"left"),I=(R,ue,pe)=>Math.max(ue,Math.min(pe,R)),y=I(r,-140,140),d=y>0&&!b||y<0&&!u?y*.35:y,v=I(Math.abs(d)/88,0,1);try{t.currentTarget.classList.add("swiping"),t.currentTarget.style.setProperty("--swipe-x",`${d}px`),t.currentTarget.style.setProperty("--swipe-p",String(v)),t.currentTarget.style.setProperty("--swipe-l",d>0&&b?String(v):"0"),t.currentTarget.style.setProperty("--swipe-r",d<0&&u?String(v):"0")}catch(R){}Math.abs(d)>12&&(dn.current=!0),r>72&&b?nt({id:a.id,dir:"right"}):r<-72&&u?nt({id:a.id,dir:"left"}):nt({id:a.id,dir:null})},onPointerCancel:t=>{try{sn.current&&clearTimeout(sn.current)}catch(r){}sn.current=null,fn.current=null;const a=Ge.current;try{a!=null&&a.captured&&(a==null?void 0:a.pointerId)!=null&&t.currentTarget.releasePointerCapture(a.pointerId)}catch(r){}Ge.current={active:!1,id:null,startX:0,startY:0,dx:0,dy:0,lock:null,pointerId:null,captured:!1},nt({id:null,dir:null});try{t.currentTarget.classList.remove("swiping"),t.currentTarget.style.setProperty("--swipe-x","0px"),t.currentTarget.style.setProperty("--swipe-p","0"),t.currentTarget.style.setProperty("--swipe-l","0"),t.currentTarget.style.setProperty("--swipe-r","0")}catch(r){}},onPointerUp:t=>{try{sn.current&&clearTimeout(sn.current)}catch(d){}sn.current=null,fn.current=null;const a=Ge.current;if(!(a!=null&&a.active)||String(a.id)!==String(e.id)){nt({id:null,dir:null});return}try{a!=null&&a.captured&&(a==null?void 0:a.pointerId)!=null&&t.currentTarget.releasePointerCapture(a.pointerId)}catch(d){}Ge.current={active:!1,id:null,startX:0,startY:0,dx:0,dy:0,lock:null,pointerId:null,captured:!1};const r=Number(a.dx)||0,o=Math.abs(r),b=a.lock==="x",u=gn(e==null?void 0:e.status);nt({id:null,dir:null});try{t.currentTarget.classList.remove("swiping"),t.currentTarget.style.setProperty("--swipe-x","0px"),t.currentTarget.style.setProperty("--swipe-p","0"),t.currentTarget.style.setProperty("--swipe-l","0"),t.currentTarget.style.setProperty("--swipe-r","0")}catch(d){}if(b&&o>12&&(dn.current=!0),!b||o<88)return;t.preventDefault(),t.stopPropagation();const I=r>0?Yn(e==null?void 0:e.status,"right"):Yn(e==null?void 0:e.status,"left"),y=gn(I);!y||y===u||Jn(e,y)},onKeyDown:t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),da(e))},title:"Xem chi ti\u1EBFt"},React.createElement("div",{className:"orders-mobile-swipe-bg","aria-hidden":"true"},React.createElement("div",{className:"orders-mobile-swipe-bg-left"},React.createElement("div",{className:"orders-mobile-swipe-label"},(()=>{const t=Yn(e==null?void 0:e.status,"right"),a=ms(t),r=(a==null?void 0:a.label)||String(t||"").trim();return r?React.createElement(React.Fragment,null,React.createElement("i",{className:`fas ${a.icon||"fa-circle"}`}),r):null})())),React.createElement("div",{className:"orders-mobile-swipe-bg-right"},React.createElement("div",{className:"orders-mobile-swipe-label"},(()=>{const t=Yn(e==null?void 0:e.status,"left"),a=ms(t),r=(a==null?void 0:a.label)||String(t||"").trim();return r?React.createElement(React.Fragment,null,React.createElement("i",{className:`fas ${a.icon||"fa-circle"}`}),r):null})()))),React.createElement("div",{className:`card orders-mobile-card ${k!=null&&k[String(e.id)]?"order-recent-updated":""}`},React.createElement("div",{className:"card-body p-3 order-card-mobile"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"flex-grow-1",style:{minWidth:0}},React.createElement("div",{className:"fw-semibold order-customer-name"},e.customer_name),React.createElement("div",{className:"fw-bold font-monospace order-phone",role:"button",tabIndex:0,onPointerDown:t=>qs(t,e.phone),onPointerMove:ya,onPointerUp:ya,onPointerCancel:ya,onPointerLeave:ya,onClick:t=>{if(t.stopPropagation(),Rt.current){Rt.current=!1;return}cs(e.phone)},onKeyDown:t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),t.stopPropagation(),cs(e.phone))},title:"Ch\u1EA1m \u0111\u1EC3 g\u1ECDi \u2022 Gi\u1EEF \u0111\u1EC3 copy"},e.phone),Number((n=e==null?void 0:e.split_seq)!=null?n:0)>0&&React.createElement("div",{className:"text-muted small"},"\u0110\u1EE3t ",e.split_seq),(()=>{const t=is(e);if(!t)return null;const a=E.has(String(e.id)),r=t.length>84||os(e).length>84;return React.createElement(React.Fragment,null,React.createElement("div",{className:`text-muted small order-address ${a?"":"order-text-collapsed"}`},t),r&&React.createElement("button",{type:"button",className:"btn btn-link p-0 order-expand-btn",onClick:o=>{o.stopPropagation(),as(e.id)}},a?"Thu g\u1ECDn":"Xem th\xEAm"))})(),(()=>{const t=os(e);if(!t)return null;const a=E.has(String(e.id)),r=is(e).length,o=r>84||t.length>84;return React.createElement(React.Fragment,null,React.createElement("div",{className:`text-muted small order-note ${a?"":"order-text-collapsed"}`},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",t),o&&r<=0&&React.createElement("button",{type:"button",className:"btn btn-link p-0 order-expand-btn",onClick:b=>{b.stopPropagation(),as(e.id)}},a?"Thu g\u1ECDn":"Xem th\xEAm"))})()),React.createElement("div",{className:"d-flex align-items-start gap-1 flex-shrink-0"},React.createElement("button",{type:"button",className:`btn btn-sm btn-link order-pin-btn ${se.has(String(e.id))?"active":""}`,onClick:t=>{t.stopPropagation(),Es(e.id)},title:se.has(String(e.id))?"B\u1ECF ghim":"Ghim","aria-label":se.has(String(e.id))?"B\u1ECF ghim":"Ghim"},React.createElement("i",{className:se.has(String(e.id))?"fas fa-star":"far fa-star"})),!!(yn!=null&&yn[String(e.id)])&&React.createElement("span",{className:"badge bg-info text-dark orders-sync-badge",title:"\u0110ang \u0111\u1ED3ng b\u1ED9","aria-label":"\u0110ang \u0111\u1ED3ng b\u1ED9"},React.createElement("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}),"Sync"),React.createElement("button",{type:"button",className:`badge ${ta(e.status)} order-status-badge-btn`,onPointerDown:t=>{t.stopPropagation(),Pe.current=!1;try{Ke.current&&clearTimeout(Ke.current)}catch(a){}Ke.current=setTimeout(()=>{Pe.current=!0,ns(e,t.currentTarget)},420)},onPointerUp:t=>{t.stopPropagation();try{Ke.current&&clearTimeout(Ke.current)}catch(a){}Ke.current=null},onPointerCancel:t=>{t.stopPropagation();try{Ke.current&&clearTimeout(Ke.current)}catch(a){}Ke.current=null},onClick:t=>{if(t.stopPropagation(),Pe.current){Pe.current=!1;return}Vt&&String(P==null?void 0:P.id)===String(e.id)?zn():ns(e,t.currentTarget)},title:"\u0110\u1ED5i tr\u1EA1ng th\xE1i nhanh"},Mn(e.status)),va(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${Dn} ng\xE0y`},"\u26A0 Ch\u1EADm ",ca(e),"d"),wa(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 h\u1EE7y sau ${Hn} ng\xE0y`},"\u23F3 C\xF2n ",Na(e),"d"))),React.createElement("div",{className:"mt-2 small"},React.createElement("div",null,React.createElement("div",{className:"text-muted"},"S\u1EA3n ph\u1EA9m:"),(()=>{const t=Ia(e);return t.length?React.createElement("div",{className:"mt-1"},t.map((a,r)=>React.createElement("div",{key:r,className:"d-flex justify-content-between gap-2",style:{lineHeight:1.25}},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,whiteSpace:"normal",wordBreak:"break-word",flex:1}},React.createElement("span",{className:"text-muted me-1"},r+1,"."),a.name),React.createElement("div",{className:"text-muted small text-end text-nowrap",style:{flexShrink:0}},"x",a.qty,Number(a.unitPrice)>0?` \u2022 ${jt(a.unitPrice)}`:"")))):React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},sa(e))})()),(ma(e)!==0||Gn(e))&&React.createElement("div",{style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh:")," ",React.createElement("span",{className:"fw-semibold"},jt(ma(e))),Gn(e)?React.createElement("span",{className:"text-muted"}," ","(",Gn(e),")"):null),React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng ti\u1EC1n"),React.createElement("span",{className:"fw-bold"},jt(ha(e)))),React.createElement("div",{className:"text-muted"},React.createElement("span",null,"Th\u1EDDi gian:")," ",na(e.created_at))),React.createElement("div",{className:"mt-3 d-flex gap-2 align-items-center order-card-actions"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:t=>{t.stopPropagation(),Ra(e)},disabled:C||!!B||ge===e.id},React.createElement("i",{className:"fas fa-copy me-1"}),"Copy"),React.createElement("button",{type:"button",className:"btn btn-sm btn-dark orders-mobile-action",onClick:t=>{t.stopPropagation(),ts(e)},disabled:C||!!B||ge===e.id,"aria-label":"M\u1EDF thao t\xE1c nhanh"},React.createElement("i",{className:"fas fa-bolt me-1"}),"Thao t\xE1c")))))}),React.createElement("div",{ref:Lt,className:"orders-mobile-sentinel","aria-hidden":"true"}),Array.isArray(nn)&&Ns.length<nn.length&&React.createElement("div",{className:"text-center text-muted small py-2"},"\u0110ang t\u1EA3i th\xEAm\u2026")),Vt&&P&&React.createElement("div",{className:"orders-status-popover-root",role:"dialog","aria-modal":"true",onClick:()=>zn()},React.createElement("div",{className:`orders-status-popover ${(z==null?void 0:z.placement)||""}`,style:{left:z.left,top:z.top},onClick:e=>e.stopPropagation()},React.createElement("div",{className:"orders-status-popover-title"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0}},P.customer_name||"\u0110\u01A1n h\xE0ng"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>zn(),"aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"orders-status-popover-grid"},ia.map(e=>{const n=gn(P.status)===gn(e.value),t=C||!!B||ge===P.id;return React.createElement("button",{key:e.value,type:"button",className:`orders-status-chip ${n?"active":""}`,onClick:()=>{n||(Jn(P,e.value),zn())},disabled:t},e.label)})),React.createElement("div",{className:"orders-status-popover-footer"},React.createElement("button",{type:"button",className:"btn btn-sm btn-dark",onClick:()=>{ts(P),zn()}},React.createElement("i",{className:"fas fa-bolt me-2"}),"Thao t\xE1c")))),ne&&Bt&&React.createElement("div",{className:"admin-sheet-root",role:"dialog","aria-modal":"true",onClick:()=>Xn()},React.createElement("div",{className:"admin-sheet",onClick:e=>e.stopPropagation()},React.createElement("div",{className:"admin-sheet-handle"}),React.createElement("div",{className:"admin-sheet-header"},React.createElement("div",{style:{minWidth:0}},React.createElement("div",{className:"fw-semibold admin-sheet-title"},Bt.customer_name||"\u0110\u01A1n h\xE0ng"),React.createElement("div",{className:"text-muted small d-flex align-items-center gap-2",style:{flexWrap:"wrap"}},React.createElement("span",{className:"font-monospace"},Bt.phone||""),React.createElement("span",{className:`badge ${ta(Bt.status)}`},Mn(Bt.status)))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>Xn(),"aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"admin-sheet-actions"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{Ra(Bt),Xn()},disabled:C||!!B||ge===Bt.id},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy"),!!String(Bt.phone||"").trim()&&React.createElement("a",{className:"btn btn-outline-secondary",href:`tel:${String(Bt.phone||"").trim()}`,onClick:()=>Xn()},React.createElement("i",{className:"fas fa-phone me-2"}),"G\u1ECDi"),React.createElement("button",{type:"button",className:"btn btn-dark",onClick:()=>{da(Bt),Xn()}},React.createElement("i",{className:"fas fa-eye me-2"}),"M\u1EDF chi ti\u1EBFt")),React.createElement("div",{className:"admin-sheet-section-title"},"\u0110\u1ED5i tr\u1EA1ng th\xE1i"),React.createElement("div",{className:"orders-status-grid"},ia.map(e=>{const n=gn(Bt.status)===gn(e.value),t=C||!!B||ge===Bt.id;return React.createElement("button",{key:e.value,type:"button",className:`orders-status-chip ${n?"active":""}`,onClick:()=>{n||(Jn(Bt,e.value),Xn())},disabled:t},e.label)})))),i&&React.createElement("div",{className:"admin-sheet-root",role:"dialog","aria-modal":"true",onClick:()=>ba()},React.createElement("div",{className:"admin-sheet",onClick:e=>e.stopPropagation()},React.createElement("div",{className:"admin-sheet-handle"}),React.createElement("div",{className:"admin-sheet-header"},React.createElement("div",{style:{minWidth:0}},React.createElement("div",{className:"fw-semibold admin-sheet-title"},"L\u1ECDc \u0111\u01A1n h\xE0ng"),React.createElement("div",{className:"text-muted small"},"T\u1ED1i \u01B0u cho thao t\xE1c m\u1ED9t tay")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>ba(),"aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"p-3"},React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>Pn("thisMonth"),disabled:ot},React.createElement("i",{className:"fas fa-calendar me-2"}),"Th\xE1ng n\xE0y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger",onClick:()=>Pn("overduePending"),disabled:ot},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"Ch\u1EADm"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>Pn("draftExpiring"),disabled:ot},React.createElement("i",{className:"fas fa-clock me-2"}),"Nh\xE1p s\u1EAFp h\u1EE7y")),React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"fw-semibold mb-2"},"Tr\u1EA1ng th\xE1i"),React.createElement("div",{className:"orders-filter-chip-grid"},React.createElement("button",{type:"button",className:`orders-filter-chip ${!J&&!$e?"active":""}`,onClick:()=>{ot&&Re(""),ke(!1),ae("")}},"T\u1EA5t c\u1EA3"),ia.map(e=>React.createElement("button",{key:e.value,type:"button",className:`orders-filter-chip ${J===e.value&&!$e?"active":""}`,onClick:()=>{ot&&Re(""),ke(!1),ae(e.value),e.value==="draft"&&j("")}},e.label)))),React.createElement("div",{className:"mt-3"},React.createElement("label",{className:"form-label small text-muted mb-1"},"Th\xE1ng"),React.createElement("input",{type:"month",className:"form-control",value:N,onChange:e=>j(e.target.value),disabled:$e||ot}),React.createElement("div",{className:"form-text"},"B\u1EADt \u201CCh\u1EADm\u201D s\u1EBD b\u1ECF qua th\xE1ng.")),React.createElement("div",{className:"form-check mt-3"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"ordersOverdueOnly",checked:$e,onChange:e=>{ot&&Re("");const n=!!e.target.checked;ke(n),n&&(j(""),ae("pending"))},disabled:ot}),React.createElement("label",{className:"form-check-label",htmlFor:"ordersOverdueOnly"},"Ch\u1EC9 xem \u0111\u01A1n ch\u1EADm > ",Dn," ng\xE0y")),React.createElement("div",{className:"d-flex gap-2 mt-4"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>Pn("all"),disabled:ot},"Reset"),React.createElement("button",{type:"button",className:"btn btn-dark flex-grow-1",onClick:()=>ba()},"Xong"))))),React.createElement("div",{className:`orders-mobile-toolbar d-md-none ${x?"visible":""}`},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onPointerDown:e=>{if(!(e.button!=null&&e.button!==0)){M.current=!1;try{Le.current&&clearTimeout(Le.current)}catch(n){}Le.current=setTimeout(()=>{M.current=!0,ss(at)},460)}},onPointerUp:()=>{try{Le.current&&clearTimeout(Le.current)}catch(e){}Le.current=null},onPointerCancel:()=>{try{Le.current&&clearTimeout(Le.current)}catch(e){}Le.current=null},onClick:()=>{if(M.current){M.current=!1;return}try{window.scrollTo({top:0,behavior:"smooth"})}catch(e){}setTimeout(()=>{var e,n;return(n=(e=cn.current)==null?void 0:e.focus)==null?void 0:n.call(e)},120)},"aria-label":"Search"},React.createElement("i",{className:"fas fa-search me-2"}),"Search"),React.createElement("button",{type:"button",className:"btn btn-dark",onClick:()=>Ma(),disabled:C||!!B,"aria-label":"T\u1EA1o \u0111\u01A1n"},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o \u0111\u01A1n"),React.createElement("button",{type:"button",className:"btn btn-outline-dark",onClick:()=>Os(),"aria-label":"L\u1ECDc"},React.createElement("i",{className:"fas fa-sliders me-2"}),"L\u1ECDc")),Ne&&React.createElement("div",{className:"orders-search-palette-root",role:"dialog","aria-modal":"true",onClick:()=>{oa(ce),Tn()}},React.createElement("div",{className:"orders-search-palette",onClick:e=>e.stopPropagation(),onTouchStart:e=>{const n=e.touches&&e.touches[0];n&&(ie.current={active:!0,startY:n.clientY,startX:n.clientX,fired:!1})},onTouchMove:e=>{const n=ie.current;if(!(n!=null&&n.active)||n.fired)return;const t=e.touches&&e.touches[0];if(!t)return;const a=t.clientY-n.startY,r=t.clientX-n.startX;Math.abs(r)>24||a>90&&(n.fired=!0,oa(ce),Tn())},onTouchEnd:()=>{ie.current={active:!1,startY:0,startX:0,fired:!1}}},React.createElement("div",{className:"orders-search-palette-header"},React.createElement("div",{className:"fw-semibold"},"T\xECm nhanh"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{oa(ce),Tn()},"aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"orders-search-palette-body"},React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-search"})),React.createElement("input",{ref:Nt,type:"text",className:"form-control",value:ce,onChange:e=>{const n=e.target.value;qe(n),Re(n)},placeholder:"Nh\u1EADp t\xEAn / S\u0110T\u2026",onKeyDown:e=>{e.key==="Enter"&&(oa(ce),Tn())}}),!!String(ce||"").trim()&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{qe(""),Re("")}},React.createElement("i",{className:"fas fa-times"}))),Array.isArray(xt)&&xt.length>0&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"text-muted small mb-2"},"G\u1EA7n \u0111\xE2y"),React.createElement("div",{className:"orders-chip-row",style:{marginTop:0}},xt.slice(0,8).map(e=>React.createElement("button",{key:e,type:"button",className:"orders-chip",onClick:()=>{qe(e),Re(e),oa(e),Tn()}},e)))),React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"text-muted small mb-2"},"Filter nhanh"),React.createElement("div",{className:"orders-filter-chip-grid"},React.createElement("button",{type:"button",className:`orders-filter-chip ${me?"active":""}`,onClick:()=>{Re(""),qe(""),ke(!1),Ue(!1),Ae(e=>!e),Tn()}},React.createElement("i",{className:"fas fa-star me-2"}),"\u01AFu ti\xEAn"),React.createElement("button",{type:"button",className:`orders-filter-chip ${Ie?"active":""}`,onClick:()=>{Re(""),qe(""),ke(!1),Ae(!1),Ue(e=>!e),Tn()}},React.createElement("i",{className:"fas fa-calendar me-2"}),"H\xF4m nay"),React.createElement("button",{type:"button",className:`orders-filter-chip ${$e?"active":""}`,onClick:()=>{Re(""),qe(""),ke(e=>!e),$e||(j(""),ae("pending")),Tn()}},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"Ch\u1EADm"),React.createElement("button",{type:"button",className:`orders-filter-chip ${!J&&!$e&&!me&&!Ie?"active":""}`,onClick:()=>{Re(""),qe(""),ke(!1),Ae(!1),Ue(!1),ae(""),Tn()}},"T\u1EA5t c\u1EA3"),ia.map(e=>React.createElement("button",{key:e.value,type:"button",className:`orders-filter-chip ${J===e.value&&!$e?"active":""}`,onClick:()=>{Re(""),qe(""),ke(!1),Ae(!1),Ue(!1),ae(e.value),e.value==="draft"&&j(""),Tn()}},e.label))))),React.createElement("div",{className:"orders-search-palette-hint text-muted small"},"Tip: Gi\u1EEF n\xFAt Search \u0111\u1EC3 m\u1EDF \u2022 Vu\u1ED1t xu\u1ED1ng \u0111\u1EC3 \u0111\xF3ng"))),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive orders-table-wrap mt-3"},React.createElement("table",{className:"table orders-table table-hover align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"SL"),React.createElement("th",null,"T\u1ED5ng ti\u1EC1n"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"),React.createElement("th",null,"Th\u1EDDi gian"),React.createElement("th",null))),React.createElement("tbody",null,nn.map(e=>React.createElement("tr",{key:e.id,style:{cursor:"pointer"},onClick:()=>da(e),title:"Xem chi ti\u1EBFt"},React.createElement("td",null,React.createElement("div",{className:"fw-semibold"},e.customer_name),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("td",null,e.phone),React.createElement("td",null,(()=>{const n=Ia(e);return n.length?React.createElement("div",{className:"d-grid gap-1"},n.map((t,a)=>React.createElement("div",{key:a,className:"small",style:{whiteSpace:"normal",wordBreak:"break-word",lineHeight:1.2}},React.createElement("span",{className:"text-muted me-1"},a+1,"."),React.createElement("span",{className:"fw-semibold"},t.name)," ",React.createElement("span",{className:"text-muted"},"x",t.qty),Number(t.unitPrice)>0&&React.createElement("span",{className:"text-muted"}," ","\u2022 ",jt(t.unitPrice))))):sa(e)})()),React.createElement("td",null,Ts(e)),React.createElement("td",{className:"fw-semibold"},jt(ha(e))),React.createElement("td",null,React.createElement("div",{className:"d-flex align-items-center gap-1 flex-wrap"},React.createElement("span",{className:`badge ${ta(e.status)}`},Mn(e.status)),va(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${Dn} ng\xE0y`},"\u26A0 Ch\u1EADm ",ca(e),"d"),wa(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 h\u1EE7y sau ${Hn} ng\xE0y`},"\u23F3 C\xF2n ",Na(e),"d"))),React.createElement("td",null,na(e.created_at)),React.createElement("td",null,React.createElement("div",{className:"d-flex gap-2 justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:n=>{n.stopPropagation(),Ra(e)},disabled:C||!!B||ge===e.id},React.createElement("i",{className:"fas fa-copy"})),React.createElement("select",{className:"form-select form-select-sm orders-status-quick",defaultValue:"",onClick:n=>n.stopPropagation(),onChange:n=>{n.stopPropagation();const t=String(n.target.value||"").trim();n.target.value="",t&&Jn(e,t)},disabled:C||!!B||ge===e.id,"aria-label":"\u0110\u1ED5i tr\u1EA1ng th\xE1i"},React.createElement("option",{value:""},"Status\u2026"),React.createElement("option",{value:"pending"},"Pending"),React.createElement("option",{value:"processing"},"Processing"),React.createElement("option",{value:"done"},"Done"),React.createElement("option",{value:"paid"},"Paid"),React.createElement("option",{value:"canceled"},"H\u1EE7y")))))))))),!ot&&Oe&&!$e&&React.createElement("div",{className:"d-flex justify-content-center mt-3"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:Zs,disabled:Xe||we},we?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2","aria-hidden":"true"}),"\u0110ang t\u1EA3i th\xEAm..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-angle-down me-2"}),"T\u1EA3i th\xEAm \u0111\u01A1n"))))),React.createElement(AdminDrawer,{open:At,title:(()=>{const e=Me,n=e!=null&&e.id?`#${e.id}`:"",t=e!=null&&e.status?`\u2022 ${Mn(e.status)}`:"";return`\u0110\u01A1n h\xE0ng ${n} ${t}`.trim()})(),subtitle:(()=>{const e=Me,n=String((e==null?void 0:e.customer_name)||"").trim(),t=String((e==null?void 0:e.phone)||"").trim(),a=e!=null&&e.created_at?na(e.created_at):"";return[n||t||null,a||null].filter(Boolean).join(" \u2022 ")})(),onClose:er,footer:React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},pn?React.createElement(React.Fragment,null,React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{bn(!1),rn(null),Vn(""),w(!1),Qe([])},disabled:C||le},React.createElement("i",{className:"fas fa-xmark me-2"}),"H\u1EE7y s\u1EEDa"),!!bt&&React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary fw-semibold",onClick:xs,disabled:C||le,title:"Ch\u1ECDn s\u1EA3n ph\u1EA9m giao \u0111\u1EE3t 1 v\xE0 t\xE1ch ph\u1EA7n c\xF2n l\u1EA1i sang \u0111\u01A1n ch\u1EDD h\xE0ng"},le?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang t\xE1ch..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-random me-2"}),"T\xE1ch giao ngay"))),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-warning fw-semibold",onClick:()=>Da({mode:"close",origin:"drawer"}),disabled:C||le||!It.canSubmit,style:{boxShadow:"0 4px 12px rgba(255,193,7,0.25)"}},C?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u")))):React.createElement(React.Fragment,null,React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>Me&&Ra(Me),disabled:!Me||en||C||!!B},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy"),React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>Me&&za(Me),disabled:!Me||en||C||!!B},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa")),React.createElement("div",{className:"d-flex flex-wrap gap-2 align-items-center"},React.createElement("select",{className:"form-select form-select-sm",defaultValue:"",onChange:e=>{const n=String(e.target.value||"").trim();e.target.value="",n&&Me&&Jn(Me,n)},disabled:!Me||en||C||!!B||ge===(Me==null?void 0:Me.id),"aria-label":"\u0110\u1ED5i tr\u1EA1ng th\xE1i",style:{minWidth:140}},React.createElement("option",{value:""},"Status\u2026"),React.createElement("option",{value:"pending"},"Pending"),React.createElement("option",{value:"processing"},"Processing"),React.createElement("option",{value:"done"},"Done"),React.createElement("option",{value:"paid"},"Paid"),React.createElement("option",{value:"canceled"},"H\u1EE7y")))))},pn?React.createElement("form",{onSubmit:e=>{e.preventDefault(),Da({mode:"close",origin:"drawer"})}},React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-pen me-2 text-warning"}),"Ch\u1EC9nh s\u1EEDa"),lr())):en?React.createElement("div",{className:"admin-drawer-section"},React.createElement("div",{className:"text-muted small mb-2"},"\u0110ang t\u1EA3i chi ti\u1EBFt\u2026"),React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("span",{className:"spinner-border spinner-border-sm text-warning","aria-hidden":"true"}),React.createElement("span",{className:"text-muted"},"Vui l\xF2ng ch\u1EDD"))):ln?React.createElement("div",{className:"alert alert-danger",role:"alert"},ln):Me?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"T\u1ED5ng quan"),React.createElement("div",{className:"d-flex flex-wrap gap-2 mb-2"},React.createElement("span",{className:`badge ${ta(Me.status)}`},Mn(Me.status)),va(Me)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${Dn} ng\xE0y`},"\u26A0 Ch\u1EADm ",ca(Me),"d"),wa(Me)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 h\u1EE7y sau ${Hn} ng\xE0y`},"\u23F3 C\xF2n ",Na(Me),"d")),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"T\u1ED5ng ti\u1EC1n"),React.createElement("div",{className:"v"},jt(ha(Me))),React.createElement("div",{className:"k"},"S\u1ED1 l\u01B0\u1EE3ng"),React.createElement("div",{className:"v"},Ts(Me)),React.createElement("div",{className:"k"},"Th\u1EDDi gian"),React.createElement("div",{className:"v"},na(Me.created_at)))),React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-user me-2 text-info"}),"Kh\xE1ch h\xE0ng"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"T\xEAn"),React.createElement("div",{className:"v"},Me.customer_name||"\u2014"),React.createElement("div",{className:"k"},"S\u0110T"),React.createElement("div",{className:"v",style:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}},React.createElement("span",{className:"font-monospace"},Me.phone||"\u2014"),!!String(Me.phone||"").trim()&&React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>window.KTM.clipboard.writeText(String(Me.phone||"").trim()),title:"Copy S\u0110T"},React.createElement("i",{className:"fas fa-copy"}))),React.createElement("div",{className:"k"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("div",{className:"v"},Me.address||"\u2014")),((Me==null?void 0:Me.note)||"").trim()&&React.createElement("div",{className:"mt-2 text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(Me.note||"").trim())),React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-boxes-stacked me-2 text-primary"}),"S\u1EA3n ph\u1EA9m"),(()=>{const e=Ia(Me);return e.length?React.createElement("div",{className:"d-grid gap-2"},e.map((n,t)=>React.createElement("div",{key:t,className:"d-flex justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted me-1"},t+1,"."),n.name),n.variant?React.createElement("div",{className:"text-muted small"},n.variant):null),React.createElement("div",{className:"text-muted small text-end text-nowrap",style:{flexShrink:0}},"x",n.qty,Number(n.unitPrice)>0?` \u2022 ${jt(n.unitPrice)}`:"")))):React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},sa(Me)||"\u2014")})(),(ma(Me)!==0||Gn(Me))&&React.createElement("div",{className:"mt-2",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh:")," ",React.createElement("span",{className:"fw-semibold"},jt(ma(Me))),Gn(Me)?React.createElement("span",{className:"text-muted"}," ","(",Gn(Me),")"):null))):React.createElement("div",{className:"text-muted"},"Ch\u01B0a c\xF3 d\u1EEF li\u1EC7u")),Ze&&React.createElement("div",{className:"modal show d-block order-modal",style:{background:"rgba(0,0,0,0.6)"},role:"dialog","aria-modal":"true"},React.createElement("div",{className:"modal-dialog modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ffca2c)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark mb-0"},React.createElement("i",{className:"fas fa-receipt me-2"}),bt?"S\u1EEDa \u0111\u01A1n h\xE0ng":"T\u1EA1o \u0111\u01A1n h\xE0ng"),React.createElement("button",{type:"button",className:"btn-close",onClick:Xa})),React.createElement("form",{onSubmit:e=>{e.preventDefault(),Da({mode:"close",origin:"modal"})}},React.createElement("div",{className:"modal-body",ref:Zt},React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"T\xEAn kh\xE1ch h\xE0ng *"),React.createElement("input",{className:"form-control",value:f.customer_name,onChange:e=>ye({...f,customer_name:e.target.value}),placeholder:"Nh\u1EADp t\xEAn kh\xE1ch h\xE0ng",required:!0,style:{borderRadius:10,padding:12}}),!!It.nameError&&React.createElement("div",{className:"form-text text-danger"},It.nameError)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i *"),React.createElement("input",{className:"form-control",type:"tel",inputMode:"numeric",pattern:"[0-9+\\s-]*",id:"order-phone-input",value:f.phone,onChange:e=>bs(e.target.value),onBlur:gs,placeholder:"Nh\u1EADp s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",required:!0,style:{borderRadius:10,padding:12}}),!!It.phoneError&&React.createElement("div",{className:"form-text text-danger"},It.phoneError),!It.phoneError&&Nn.count>0&&React.createElement("div",{className:"form-text text-warning d-flex align-items-center justify-content-between gap-2"},React.createElement("span",null,"Kh\xE1ch n\xE0y \u0111\xE3 c\xF3 ",Nn.count," \u0111\u01A1n trong th\xE1ng ",Nn.monthKey,"."),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>w(e=>!e)},K?"\u1EA8n l\u1ECBch s\u1EED":"Xem l\u1ECBch s\u1EED")),K&&Nn.orders.length>0&&React.createElement("div",{className:"mt-2 border rounded-3 p-2",style:{background:"#fff"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between gap-2 mb-2"},React.createElement("div",{className:"small fw-semibold"},"L\u1ECBch s\u1EED \u0111\u01A1n (c\xF9ng th\xE1ng)"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>w(!1)},"\u1EA8n")),React.createElement("div",{className:"d-grid gap-2"},Nn.orders.slice(0,5).map(e=>React.createElement("div",{key:e.id,className:"d-flex align-items-start justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"small fw-semibold",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},"#",e.id," \u2022 ",React.createElement("span",{className:`badge ${ta(e.status)}`},Mn(e.status))),React.createElement("div",{className:"text-muted small"},na(e.created_at)," \u2022 ",jt(ha(e))),React.createElement("div",{className:"text-muted small",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},sa(e))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{confirm(`M\u1EDF \u0111\u01A1n #${e.id}? D\u1EEF li\u1EC7u \u0111ang nh\u1EADp s\u1EBD m\u1EA5t.`)&&za(e)}},"M\u1EDF")))),Nn.orders.length>5&&React.createElement("div",{className:"text-muted small mt-2"},"Ch\u1EC9 hi\u1EC3n th\u1ECB 5 \u0111\u01A1n g\u1EA7n nh\u1EA5t.")),(O==null?void 0:O.status)==="loading"&&React.createElement("div",{className:"form-text"},"\u0110ang t\xECm kh\xE1ch theo S\u0110T..."),(O==null?void 0:O.status)==="found"&&React.createElement("div",{className:"form-text text-success"},"\u0110\xE3 c\xF3 kh\xE1ch, t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n th\xF4ng tin."),(O==null?void 0:O.status)==="not-found"&&React.createElement("div",{className:"form-text text-muted"},"Ch\u01B0a c\xF3 kh\xE1ch, s\u1EBD t\u1EA1o m\u1EDBi khi l\u01B0u \u0111\u01A1n."),(O==null?void 0:O.status)==="error"&&React.createElement("div",{className:"form-text text-danger"},"Kh\xF4ng tra \u0111\u01B0\u1EE3c kh\xE1ch (l\u1ED7i m\u1EA1ng/server).")),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("select",{className:"form-select",value:f.status,onChange:e=>ye({...f,status:e.target.value}),style:{borderRadius:10,padding:12}},React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n"))),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("input",{className:"form-control",value:f.address,onChange:e=>ye({...f,address:e.target.value}),placeholder:"Nh\u1EADp \u0111\u1ECBa ch\u1EC9 (kh\xF4ng b\u1EAFt bu\u1ED9c)",style:{borderRadius:10,padding:12}}),!!It.addressWarn&&React.createElement("div",{className:"form-text text-warning"},It.addressWarn)),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111\u01A1n h\xE0ng"),React.createElement("textarea",{className:"form-control",value:f.note,onChange:e=>ye({...f,note:e.target.value}),placeholder:"V\xED d\u1EE5: Giao gi\u1EDD h\xE0nh ch\xEDnh / G\u1ECDi tr\u01B0\u1EDBc khi giao...",rows:2,style:{borderRadius:10,padding:12,resize:"vertical"}})),React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110i\u1EC1u ch\u1EC9nh gi\xE1 (th\xEAm/b\u1EDBt)"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{ye(e=>({...e,adjustment_items:[...Array.isArray(e.adjustment_items)?e.adjustment_items:[{amount:"",note:""}],{amount:"",note:""}]}))}},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm \u0111i\u1EC1u ch\u1EC9nh")),React.createElement("div",{className:"d-grid gap-2"},Kn(f.adjustment_items).map((e,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label small text-muted mb-1"},"S\u1ED1 ti\u1EC1n"),React.createElement("input",{type:"text",inputMode:"numeric",className:"form-control",value:e.amount,onChange:t=>{const a=t.target.value;ye(r=>{const o=Kn(r.adjustment_items);return o[n]={...o[n],amount:a},{...r,adjustment_items:o}})},placeholder:"+500000 ho\u1EB7c -200000",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("label",{className:"form-label small text-muted mb-1"},"Ghi ch\xFA"),React.createElement("input",{className:"form-control",value:e.note,onChange:t=>{const a=t.target.value;ye(r=>{const o=Kn(r.adjustment_items);return o[n]={...o[n],note:a},{...r,adjustment_items:o}})},placeholder:"V\xED d\u1EE5: th\xEAm van 1 tay / gi\u1EA3m gi\xE1...",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-1 d-flex"},React.createElement("button",{type:"button",className:"btn btn-outline-danger w-100",onClick:()=>{ye(t=>{const a=Kn(t.adjustment_items);return a.splice(n,1),{...t,adjustment_items:a.length?a:[{amount:"",note:""}]}})},disabled:C||Kn(f.adjustment_items).length<=1,title:"X\xF3a \u0111i\u1EC1u ch\u1EC9nh",style:{borderRadius:10,padding:12}},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement("div",{className:"form-text"},"\xC2m = gi\u1EA3m gi\xE1, d\u01B0\u01A1ng = c\u1ED9ng th\xEAm."),!!It.adjustmentAbnormalWarn&&React.createElement("div",{className:"form-text text-warning"},It.adjustmentAbnormalWarn),!!It.adjustmentNoteWarn&&React.createElement("div",{className:"form-text text-warning"},It.adjustmentNoteWarn)),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1EA3n ph\u1EA9m *"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{ye(e=>({...e,items:[...Array.isArray(e.items)?e.items:[],{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]})),$t(e=>[...Array.isArray(e)?e:[],""]),bt&&Qe(e=>[...Array.isArray(e)?e:[],!0])},disabled:C},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(f.items)?f.items:[{product_id:"",quantity:1}]).map((e,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"dropdown w-100",ref:t=>{Qt.current[n]=t}},React.createElement("button",{type:"button",className:"form-control text-start d-flex align-items-center justify-content-between",style:{borderRadius:10,padding:12},onClick:()=>{qt(t=>t===n?null:n),setTimeout(()=>{const t=document.getElementById(`order-product-search-${n}`);t&&t.focus()},0)}},React.createElement("span",{className:e.product_id?"":"text-muted",style:{minWidth:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},ks(e.product_id)),React.createElement("i",{className:"fas fa-chevron-down text-muted",style:{marginLeft:8,flexShrink:0}})),Ot===n&&React.createElement("div",{className:"dropdown-menu show w-100 p-2",style:{maxHeight:320,overflowY:"auto"}},React.createElement("input",{id:`order-product-search-${n}`,className:"form-control",value:Tt[n]||"",onChange:t=>{const a=t.target.value;$t(r=>{const o=Array.isArray(r)?[...r]:[];return o[n]=a,o})},placeholder:"T\xECm theo t\xEAn / m\xE3...",style:{borderRadius:10,padding:10}}),React.createElement("div",{className:"mt-2"}),(()=>{const t=As(n);return t.length===0?React.createElement("div",{className:"text-muted small px-2 py-1"},"Kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p"):t.map(a=>React.createElement("button",{key:a.id,type:"button",className:"dropdown-item",onClick:()=>{const r=String(a.id),o=Bn(a==null?void 0:a.variants),b={};for(const y of o){const d=String((y==null?void 0:y.name)||"").trim(),v=Array.isArray(y==null?void 0:y.options)?y.options[0]:null,R=String((v==null?void 0:v.label)||"").trim();d&&R&&(b[d]=R)}const u=$a(b),I=aa(a,b);ye(y=>{const d=Array.isArray(y.items)?[...y.items]:[];return d[n]={...d[n]||{quantity:1},product_id:r,variant_json:Object.keys(b).length?b:null,variant:u,unit_price:o.length?I:null},{...y,items:d}}),qt(null)}},a.name,a.code?` (${a.code})`:""))})()),React.createElement("select",{className:"form-select",value:e.product_id,onChange:()=>{},required:!0,style:{position:"absolute",opacity:0,height:0,pointerEvents:"none"},tabIndex:-1,"aria-hidden":"true"},React.createElement("option",{value:""},"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"),Ht.map(t=>React.createElement("option",{key:t.id,value:t.id},t.name)))),(()=>{var a;const t=(a=It.items)==null?void 0:a[n];return t?React.createElement(React.Fragment,null,!!t.productError&&React.createElement("div",{className:"form-text text-danger"},t.productError),!!t.dupWarn&&React.createElement("div",{className:"form-text text-warning"},t.dupWarn)):null})(),(()=>{if(!(e!=null&&e.product_id))return null;const t=Cn(e.product_id),a=Bn(t==null?void 0:t.variants);if(!a.length)return null;const r=e!=null&&e.variant_json&&typeof e.variant_json=="object"?e.variant_json:{};return React.createElement("div",{className:"mt-2 d-grid gap-2"},a.map((o,b)=>{const u=String((o==null?void 0:o.name)||`Bi\u1EBFn th\u1EC3 ${b+1}`).trim(),I=String((r==null?void 0:r[u])||"").trim();return React.createElement("div",{key:u},React.createElement("label",{className:"form-label small text-muted mb-1"},u),React.createElement("select",{className:"form-select",value:I,onChange:y=>{const d=String(y.target.value||"").trim();ye(v=>{const R=Array.isArray(v.items)?[...v.items]:[],ue={...R[n]||{}},pe=Cn(ue.product_id),ft=Bn(pe==null?void 0:pe.variants),mt=ue!=null&&ue.variant_json&&typeof ue.variant_json=="object"?{...ue.variant_json}:{};d?mt[u]=d:delete mt[u];const tn=$a(mt),Mt=aa(pe,mt);return R[n]={...ue,variant_json:Object.keys(mt).length?mt:null,variant:tn,unit_price:Mt},{...v,items:R}})},style:{borderRadius:10,padding:12}},React.createElement("option",{value:""},"-- ch\u1ECDn ",u," --"),(Array.isArray(o==null?void 0:o.options)?o.options:[]).map(y=>React.createElement("option",{key:y.label,value:y.label},y.label,Number.isFinite(Number(y==null?void 0:y.price))?` (${jt(Number(y.price))})`:Number(y==null?void 0:y.price_delta)?` (${y.price_delta>0?"+":""}${y.price_delta})`:""))))}))})(),bt&&React.createElement("div",{className:"form-check mt-1"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:`order-split-deliver-${n}`,checked:!!He[n],onChange:t=>{const a=!!t.target.checked;Qe(r=>{const o=Array.isArray(r)?[...r]:[],b=Array.isArray(f.items)?f.items.length:0;for(;o.length<b;)o.push(!0);return o[n]=a,o})},disabled:C||le}),React.createElement("label",{className:"form-check-label small text-muted",htmlFor:`order-split-deliver-${n}`},"Giao \u0111\u1EE3t 1"))),React.createElement("div",{className:"col-8 col-md-3"},React.createElement("input",{type:"number",className:"form-control",value:e.quantity,onChange:t=>{const a=t.target.value;ye(r=>{const o=Array.isArray(r.items)?[...r.items]:[];return o[n]={...o[n]||{product_id:""},quantity:a},{...r,items:o}})},min:"1",style:{borderRadius:10,padding:12}}),(()=>{var a;const t=(a=It.items)==null?void 0:a[n];return t&&t.qtyError?React.createElement("div",{className:"form-text text-danger"},t.qtyError):null})()),React.createElement("div",{className:"col-4 col-md-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>{ye(t=>{const a=Array.isArray(t.items)?[...t.items]:[];return a.splice(n,1),{...t,items:a.length?a:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]}}),$t(t=>{const a=Array.isArray(t)?[...t]:[];return a.splice(n,1),a.length?a:[""]}),Qe(t=>{const a=Array.isArray(t)?[...t]:[];return a.splice(n,1),a}),qt(t=>t==null?t:t===n?null:t>n?t-1:t)},disabled:C||le||(Array.isArray(f.items)?f.items.length:1)<=1,title:"X\xF3a s\u1EA3n ph\u1EA9m",style:{borderRadius:10,padding:10}},React.createElement("i",{className:"fas fa-trash"}))))))),(()=>{const n=(Array.isArray(f.items)?f.items:[]).filter(u=>u==null?void 0:u.product_id),t=pa(n),a=ua(n),r=ja(f),o=r.amount,b=t+(a.found?a.fee:0)+o;return React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-column gap-1 small bg-light rounded-3 p-3"},React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1EA1m t\xEDnh"),React.createElement("span",{className:"fw-semibold"},jt(t))),a.found&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"Ship"),React.createElement("span",{className:"fw-semibold"},jt(a.fee))),!!It.shipAbnormalWarn&&React.createElement("div",{className:"text-warning"},It.shipAbnormalWarn),o!==0&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh"),React.createElement("span",{className:"fw-semibold"},jt(o))),(f.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111\u01A1n: ",(f.note||"").trim()),!!r.summaryText&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh: ",r.summaryText),React.createElement("div",{className:"d-flex justify-content-between pt-1 border-top"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng"),React.createElement("span",{className:"fw-bold"},jt(b)))))})())),React.createElement("div",{className:"modal-footer",style:{border:"none"}},React.createElement("button",{type:"button",className:"btn btn-light",onClick:Xa,disabled:C||le,style:{borderRadius:10}},"H\u1EE7y"),!!bt&&React.createElement("button",{type:"button",className:"btn btn-outline-primary fw-semibold",onClick:xs,disabled:C||le,style:{borderRadius:10},title:"Ch\u1ECDn s\u1EA3n ph\u1EA9m giao \u0111\u1EE3t 1 v\xE0 t\xE1ch ph\u1EA7n c\xF2n l\u1EA1i sang \u0111\u01A1n ch\u1EDD h\xE0ng"},le?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang t\xE1ch..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-random me-2"}),"T\xE1ch \u0111\u01A1n giao ngay")),!bt&&React.createElement("button",{type:"button",className:"btn btn-outline-warning fw-semibold",onClick:()=>Da({mode:"new",origin:"modal"}),disabled:C||!It.canSubmit,style:{borderRadius:10},title:"L\u01B0u xong gi\u1EEF form \u0111\u1EC3 t\u1EA1o \u0111\u01A1n m\u1EDBi"},React.createElement("i",{className:"fas fa-plus me-2"}),"L\u01B0u & t\u1EA1o \u0111\u01A1n m\u1EDBi"),React.createElement("button",{type:"submit",className:"btn btn-warning fw-semibold",disabled:C||le||!It.canSubmit,style:{borderRadius:10,boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},C?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u"))))))))}

