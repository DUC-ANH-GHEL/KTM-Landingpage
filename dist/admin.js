const{useState,useEffect,useRef,useMemo}=React,CLOUDINARY_CLOUD_NAME="diwxfpt92",CLOUDINARY_UPLOAD_PRESET="ktm_unsigned",API_BASE="";function LoginPage({onLogin:P,error:j}){const[F,wt]=useState(""),[ot,J]=useState(""),[V,Et]=useState(!1),[Ht,Ct]=useState(!1);return React.createElement("div",{className:"login-page"},React.createElement("div",{className:"login-box"},React.createElement("div",{className:"text-center mb-4"},React.createElement("i",{className:"fas fa-tractor fa-3x text-warning mb-3"}),React.createElement("h4",{className:"text-dark"},"KTM Admin"),React.createElement("p",{className:"text-muted small"},"\u0110\u0103ng nh\u1EADp \u0111\u1EC3 qu\u1EA3n l\xFD")),j&&React.createElement("div",{className:"alert alert-danger py-2 small"},React.createElement("i",{className:"fas fa-exclamation-circle me-2"}),j),React.createElement("form",{onSubmit:async re=>{re.preventDefault(),Et(!0),await P(F,ot),Et(!1)}},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small"},"T\xEAn \u0111\u0103ng nh\u1EADp"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-user"})),React.createElement("input",{type:"text",className:"form-control",value:F,onChange:re=>wt(re.target.value),placeholder:"admin",required:!0,autoFocus:!0}))),React.createElement("div",{className:"mb-4"},React.createElement("label",{className:"form-label small"},"M\u1EADt kh\u1EA9u"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-lock"})),React.createElement("input",{type:Ht?"text":"password",className:"form-control",value:ot,onChange:re=>J(re.target.value),placeholder:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",required:!0}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>Ct(!Ht)},React.createElement("i",{className:`fas fa-eye${Ht?"-slash":""}`})))),React.createElement("button",{type:"submit",className:"btn btn-warning w-100",disabled:V},V?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang \u0111\u0103ng nh\u1EADp..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-sign-in-alt me-2"}),"\u0110\u0103ng nh\u1EADp"))),React.createElement("div",{className:"text-center mt-4"},React.createElement("a",{href:"/",className:"text-muted small text-decoration-none"},React.createElement("i",{className:"fas fa-arrow-left me-1"}),"V\u1EC1 trang ch\u1EE7"))))}function Toast({message:P,type:j,onClose:F,actionLabel:wt,onAction:ot,durationMs:J}){return useEffect(()=>{const V=Number(J),Et=Number.isFinite(V)&&V>0?V:3e3,Ht=setTimeout(F,Et);return()=>clearTimeout(Ht)},[F,J]),React.createElement("div",{className:`toast show align-items-center text-white bg-${j} border-0`,role:"alert"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("div",{className:"toast-body"},P),wt&&typeof ot=="function"&&React.createElement("button",{type:"button",className:"btn btn-sm btn-light toast-action",onClick:()=>{try{ot()}finally{F()}}},wt),React.createElement("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto",onClick:F})))}function Loading({show:P}){return P?React.createElement("div",{className:"loading-overlay"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"3rem",height:"3rem"}},React.createElement("span",{className:"visually-hidden"},"\u0110ang t\u1EA3i..."))):null}function AdminDrawer({open:P,title:j,subtitle:F,onClose:wt,footer:ot,children:J}){return useEffect(()=>{if(!P)return;const V=Et=>{Et.key==="Escape"&&(Et.preventDefault(),typeof wt=="function"&&wt())};return document.addEventListener("keydown",V),()=>document.removeEventListener("keydown",V)},[P,wt]),P?React.createElement("div",{className:`admin-drawer-root ${P?"open":""}`,role:"dialog","aria-modal":"true"},React.createElement("div",{className:"admin-drawer-backdrop",onClick:wt,"aria-hidden":"true"}),React.createElement("aside",{className:"admin-drawer-panel"},React.createElement("div",{className:"admin-drawer-header"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"admin-drawer-title"},j),F?React.createElement("div",{className:"admin-drawer-subtitle"},F):null),React.createElement("button",{type:"button",className:"btn btn-sm btn-light",onClick:wt,title:"\u0110\xF3ng","aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"admin-drawer-body"},J),ot?React.createElement("div",{className:"admin-drawer-footer"},ot):null)):null}const ADMIN_PINS_STORAGE_KEY="ktm_admin_pins_v1",ADMIN_RECENT_STORAGE_KEY="ktm_admin_recent_v1";function loadAdminMenuIdsFromStorage(P){try{const j=localStorage.getItem(P);if(!j)return[];const F=JSON.parse(j);return Array.isArray(F)?F.map(wt=>String(wt||"").trim()).filter(Boolean):[]}catch(j){return[]}}function saveAdminMenuIdsToStorage(P,j){try{localStorage.setItem(P,JSON.stringify(Array.isArray(j)?j:[]))}catch(F){}}function loadAdminPins(){return loadAdminMenuIdsFromStorage(ADMIN_PINS_STORAGE_KEY)}function saveAdminPins(P){return saveAdminMenuIdsToStorage(ADMIN_PINS_STORAGE_KEY,P),P}function loadAdminRecent(){return loadAdminMenuIdsFromStorage(ADMIN_RECENT_STORAGE_KEY)}function saveAdminRecent(P){return saveAdminMenuIdsToStorage(ADMIN_RECENT_STORAGE_KEY,P),P}function Sidebar({activeMenu:P,onMenuChange:j,onLogout:F,currentUser:wt,pinnedMenus:ot,recentMenus:J,onTogglePin:V}){const Et=[{id:"search",icon:"fa-search",label:"Tra c\u1EE9u nhanh",highlight:!0},{id:"albums",icon:"fa-images",label:"Qu\u1EA3n l\xFD Album"},{id:"videos",icon:"fa-video",label:"Qu\u1EA3n l\xFD Video"},{id:"products",icon:"fa-box",label:"S\u1EA3n ph\u1EA9m"},{id:"orders",icon:"fa-receipt",label:"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"},{id:"recon",icon:"fa-file-excel",label:"\u0110\u1ED1i so\xE1t Excel"},{id:"stats",icon:"fa-chart-column",label:"Th\u1ED1ng k\xEA"},{id:"settings",icon:"fa-cog",label:"C\xE0i \u0111\u1EB7t"}],Ht=(wt==null?void 0:wt.username)||(wt==null?void 0:wt.name)||(wt==null?void 0:wt.email)||"Admin",Ct=useMemo(()=>{const Lt=new Map;for(const X of Et)Lt.set(X.id,X);return Lt},[]),Jt=Array.isArray(ot)?ot:[],re=Array.isArray(J)?J:[],Ft=Jt.map(Lt=>Ct.get(Lt)).filter(Boolean),Vt=re.filter(Lt=>Lt!==P).map(Lt=>Ct.get(Lt)).filter(Boolean).slice(0,2),it=Lt=>Jt.includes(Lt);return React.createElement("div",{className:"sidebar d-none d-md-block"},React.createElement("div",{className:"logo"},React.createElement("i",{className:"fas fa-tractor me-2"})," KTM Admin"),React.createElement("div",{className:"sidebar-user","aria-label":"T\xE0i kho\u1EA3n"},React.createElement("div",{className:"sidebar-user-avatar","aria-hidden":"true"},React.createElement("i",{className:"fas fa-user"})),React.createElement("div",{className:"sidebar-user-meta"},React.createElement("div",{className:"sidebar-user-name"},Ht),React.createElement("div",{className:"sidebar-user-sub"},"Qu\u1EA3n tr\u1ECB"))),React.createElement("nav",{className:"nav flex-column mt-3 sidebar-nav"},Ft.length>0&&React.createElement(React.Fragment,null,React.createElement("div",{className:"sidebar-section-title"},"Pinned"),React.createElement("div",{className:"sidebar-quicklist"},Ft.map(Lt=>React.createElement("a",{key:`pin-${Lt.id}`,href:"#",className:`nav-link ${P===Lt.id?"active":""} sidebar-quicklink`,onClick:X=>{X.preventDefault(),j(Lt.id)}},React.createElement("i",{className:`fas ${Lt.icon}`})," ",Lt.label,React.createElement("button",{type:"button",className:"sidebar-pin-btn pinned",onClick:X=>{X.preventDefault(),X.stopPropagation(),V&&V(Lt.id)},title:"B\u1ECF ghim","aria-label":"B\u1ECF ghim"},React.createElement("i",{className:"fas fa-thumbtack"})))))),Vt.length>0&&React.createElement(React.Fragment,null,React.createElement("div",{className:"sidebar-section-title"},"Recent"),React.createElement("div",{className:"sidebar-quicklist"},Vt.map(Lt=>React.createElement("a",{key:`recent-${Lt.id}`,href:"#",className:`nav-link ${P===Lt.id?"active":""} sidebar-quicklink`,onClick:X=>{X.preventDefault(),j(Lt.id)}},React.createElement("i",{className:`fas ${Lt.icon}`})," ",Lt.label)))),React.createElement("div",{className:"sidebar-section-title"},"Menu"),React.createElement("div",{className:"sidebar-menu-scroll","aria-label":"Danh s\xE1ch menu"},Et.map(Lt=>React.createElement("a",{key:Lt.id,href:"#",className:`nav-link ${P===Lt.id?"active":""} ${Lt.disabled?"opacity-50":""} ${Lt.highlight?"text-warning":""}`,onClick:X=>{X.preventDefault(),Lt.disabled||j(Lt.id)}},React.createElement("i",{className:`fas ${Lt.icon}`})," ",Lt.label,Lt.disabled&&React.createElement("span",{className:"badge bg-secondary ms-2"},"Soon"),Lt.highlight&&React.createElement("span",{className:"badge bg-warning text-dark ms-2"},"HOT"),React.createElement("button",{type:"button",className:`sidebar-pin-btn ${it(Lt.id)?"pinned":""}`,onClick:X=>{X.preventDefault(),X.stopPropagation(),V&&V(Lt.id)},title:it(Lt.id)?"B\u1ECF ghim":"Ghim","aria-label":it(Lt.id)?"B\u1ECF ghim":"Ghim"},React.createElement("i",{className:"fas fa-thumbtack"})))))),React.createElement("div",{className:"sidebar-footer w-100 p-3 border-top border-secondary"},React.createElement("div",{className:"d-flex justify-content-between align-items-center"},React.createElement("a",{href:"/",className:"text-white-50 text-decoration-none small"},React.createElement("i",{className:"fas fa-home me-1"})," Trang ch\u1EE7"),F&&React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:F,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"})))))}const ADMIN_SETTINGS_STORAGE_KEY="ktm_admin_settings_v1",DEFAULT_SHIP_PERCENT=1.64;function normalizeShipPercent(P){const j=typeof P=="number"?P:parseFloat(String(P!=null?P:"").trim());return Number.isFinite(j)?Math.max(0,Math.min(100,j)):DEFAULT_SHIP_PERCENT}function loadAdminSettings(){var P;try{const j=localStorage.getItem(ADMIN_SETTINGS_STORAGE_KEY);if(!j)return{ship_percent:DEFAULT_SHIP_PERCENT};const F=JSON.parse(j);return{ship_percent:normalizeShipPercent((P=F==null?void 0:F.ship_percent)!=null?P:F==null?void 0:F.shipPercent)}}catch(j){return{ship_percent:DEFAULT_SHIP_PERCENT}}}function saveAdminSettings(P){var j;try{const F={ship_percent:normalizeShipPercent((j=P==null?void 0:P.ship_percent)!=null?j:P==null?void 0:P.shipPercent)};return localStorage.setItem(ADMIN_SETTINGS_STORAGE_KEY,JSON.stringify(F)),F}catch(F){return{ship_percent:DEFAULT_SHIP_PERCENT}}}async function fetchAdminSettingsFromServer(){var j;const P=await window.KTM.api.getJSON(`${API_BASE}/api/settings`,"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t t\u1EEB DB");return{ship_percent:normalizeShipPercent((j=P==null?void 0:P.ship_percent)!=null?j:P==null?void 0:P.shipPercent)}}async function saveAdminSettingsToServer(P){var wt,ot,J;const j={ship_percent:normalizeShipPercent((wt=P==null?void 0:P.ship_percent)!=null?wt:P==null?void 0:P.shipPercent)},F=await window.KTM.api.putJSON(`${API_BASE}/api/settings`,j,"Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t v\xE0o DB");return{ship_percent:normalizeShipPercent((J=(ot=F==null?void 0:F.ship_percent)!=null?ot:F==null?void 0:F.shipPercent)!=null?J:j.ship_percent)}}function AlbumList({albums:P,onSelect:j,onCreate:F,onEdit:wt,onDelete:ot,loading:J,currentFolder:V,onBack:Et,breadcrumb:Ht}){return React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},V&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:Et},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),V?V.title:"Th\u01B0 vi\u1EC7n \u1EA3nh")),React.createElement("button",{className:"btn btn-warning",onClick:F},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder")),Ht&&Ht.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:Ct=>{Ct.preventDefault(),Et("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),Ht.map((Ct,Jt)=>React.createElement("li",{key:Ct.id,className:`breadcrumb-item ${Jt===Ht.length-1?"active":""}`},Jt===Ht.length-1?Ct.title:React.createElement("a",{href:"#",onClick:re=>{re.preventDefault(),Et(Ct)},className:"text-warning"},Ct.title))))),J?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):P.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},V?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder n\xE0o. H\xE3y t\u1EA1o folder \u0111\u1EA7u ti\xEAn!")):React.createElement("div",{className:"row g-3"},P.map(Ct=>React.createElement("div",{key:Ct.uuid||Ct.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card album-card h-100",onClick:()=>j(Ct)},Ct.cover?React.createElement("img",{src:Ct.cover,className:"album-cover",alt:Ct.title}):React.createElement("div",{className:"card-body text-center py-4"},React.createElement("i",{className:"fas fa-folder fa-3x text-warning mb-2"})),React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"card-title mb-1"},Ct.title),React.createElement("small",{className:"text-muted"},Ct.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),Ct.subfolderCount),Ct.subfolderCount>0&&Ct.count>0&&" \u2022 ",Ct.count>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-image me-1"}),Ct.count),Ct.subfolderCount===0&&Ct.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-2",onClick:Jt=>{Jt.stopPropagation(),wt(Ct)},title:"S\u1EEDa album"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:Jt=>{Jt.stopPropagation(),ot(Ct)},title:"X\xF3a album"},React.createElement("i",{className:"fas fa-trash"}))))))))}function AlbumModal({show:P,album:j,onClose:F,onSave:wt,parentId:ot}){const[J,V]=useState({slug:"",title:"",description:"",cover_url:"",parent_id:null}),[Et,Ht]=useState(!1),[Ct,Jt]=useState(!1),re=useRef(null);useEffect(()=>{V(j?{slug:j.id||"",title:j.title||"",description:j.description||"",cover_url:j.cover||"",parent_id:j.parentId||null}:{slug:"",title:"",description:"",cover_url:"",parent_id:ot||null})},[j,P,ot]);const Ft=async X=>{X.preventDefault(),Ht(!0),await wt(J),Ht(!1)},Vt=X=>X.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),it=async X=>{const ge=X.type==="image/heic"||X.type==="image/heif"||/\.heic$/i.test(X.name);if(X.size<=2097152&&!ge)return X;try{const _e=await createImageBitmap(X),Gt=document.createElement("canvas");let se=_e.width,Kt=_e.height;const ye=800;return(se>ye||Kt>ye)&&(se>Kt?(Kt=Math.round(Kt/se*ye),se=ye):(se=Math.round(se/Kt*ye),Kt=ye)),Gt.width=se,Gt.height=Kt,Gt.getContext("2d").drawImage(_e,0,0,se,Kt),_e.close(),new Promise((on,ee)=>{Gt.toBlob(Le=>{Le?on(new File([Le],X.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):ee(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(_e){throw console.error("Compress cover error:",_e),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},Lt=async X=>{var _e;const pe=X.target.files[0];if(!pe)return;if(!(pe.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(pe.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}Jt(!0);try{const Gt=await it(pe),se=await window.KTM.cloudinary.uploadImage({file:Gt,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-albums/covers"});if(!se.secure_url)throw console.error("Cloudinary error:",se),new Error(((_e=se.error)==null?void 0:_e.message)||"Upload failed");V(Kt=>({...Kt,cover_url:se.secure_url}))}catch(Gt){console.error("Cover upload error:",Gt),alert("L\u1ED7i upload \u1EA3nh b\xECa: "+Gt.message)}Jt(!1),X.target.value=""};return P?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},j?"S\u1EEDa":"T\u1EA1o"," Folder"),React.createElement("button",{type:"button",className:"btn-close",onClick:F})),React.createElement("form",{onSubmit:Ft},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:J.title,onChange:X=>V({...J,title:X.target.value,slug:J.slug||Vt(X.target.value)}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Slug (URL) *"),React.createElement("input",{type:"text",className:"form-control",value:J.slug,onChange:X=>V({...J,slug:X.target.value}),required:!0,disabled:!!j}),React.createElement("small",{className:"text-muted"},"VD: may-cay-kubota-l1501")),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:J.description,onChange:X=>V({...J,description:X.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex gap-2 align-items-start"},J.cover_url&&React.createElement("div",{className:"position-relative",style:{width:80,height:80}},React.createElement("img",{src:J.cover_url,alt:"Cover",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:8}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute",style:{top:-8,right:-8,padding:"2px 6px",fontSize:10},onClick:()=>V(X=>({...X,cover_url:""}))},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{ref:re,type:"file",accept:"image/*",className:"d-none",onChange:Lt}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100 mb-2",onClick:()=>{var X;return(X=re.current)==null?void 0:X.click()},disabled:Ct},Ct?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh b\xECa")),React.createElement("input",{type:"url",className:"form-control form-control-sm",value:J.cover_url,onChange:X=>V({...J,cover_url:X.target.value}),placeholder:"Ho\u1EB7c d\xE1n URL \u1EA3nh..."}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:F},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:Et||Ct},Et?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function FolderTreeItem({folder:P,allAlbums:j,currentAlbumId:F,targetAlbum:wt,onSelect:ot,level:J=0}){const[V,Et]=useState(!0),Ht=P.uuid||P.id,Ct=Ht===F,Jt=wt===Ht,re=j.filter(Vt=>Vt.parentId===Ht),Ft=re.length>0;return React.createElement("div",{style:{marginLeft:J*16+"px"}},React.createElement("div",{className:`d-flex align-items-center p-2 rounded mb-1 ${Jt?"bg-info text-white":Ct?"bg-light text-muted":"hover-bg"}`,style:{cursor:Ct?"not-allowed":"pointer",opacity:Ct?.5:1,transition:"background 0.2s"},onClick:()=>!Ct&&ot(Ht)},Ft&&React.createElement("i",{className:`fas fa-chevron-${V?"down":"right"} me-2`,style:{fontSize:"10px",width:"12px",cursor:"pointer"},onClick:Vt=>{Vt.stopPropagation(),Et(!V)}}),!Ft&&React.createElement("span",{style:{width:"20px"}}),React.createElement("i",{className:`fas fa-folder${Jt?"-open":""} me-2 ${Jt?"":"text-warning"}`}),React.createElement("span",{className:"small"},P.title),Ct&&React.createElement("span",{className:"ms-2 badge bg-secondary",style:{fontSize:"9px"}},"Hi\u1EC7n t\u1EA1i"),P.count>0&&!Ct&&React.createElement("span",{className:"ms-auto badge bg-light text-muted",style:{fontSize:"10px"}},P.count)),V&&Ft&&React.createElement("div",null,re.map(Vt=>React.createElement(FolderTreeItem,{key:Vt.uuid||Vt.id,folder:Vt,allAlbums:j,currentAlbumId:F,targetAlbum:wt,onSelect:ot,level:J+1}))))}function AlbumDetail({album:P,onBack:j,onRefresh:F,showToast:wt,onNavigateToFolder:ot,onEditSubfolder:J,parentAlbum:V}){const[Et,Ht]=useState([]),[Ct,Jt]=useState([]),[re,Ft]=useState(!0),[Vt,it]=useState(!1),[Lt,X]=useState(""),[pe,ge]=useState([]),[_e,Gt]=useState([]),[se,Kt]=useState({}),[ye,$e]=useState(null),[on,ee]=useState(!1),[Le,Be]=useState(""),[$,M]=useState(!1),z=useRef(null),vt=useRef(null),[St,ut]=useState(!1),[ht,_t]=useState([]),[x,q]=useState([]),[Y,dt]=useState(""),[kt,$t]=useState(!1),Zt=async(H,p=2)=>{const G=p*1024*1024,at=H.type==="image/heic"||H.type==="image/heif"||/\.heic$/i.test(H.name);if(H.size<=G&&!at)return H;try{const Pt=await createImageBitmap(H),jt=document.createElement("canvas");let Ut=Pt.width,xe=Pt.height;const ae=1200;return(Ut>ae||xe>ae)&&(Ut>xe?(xe=Math.round(xe/Ut*ae),Ut=ae):(Ut=Math.round(Ut/xe*ae),xe=ae)),jt.width=Ut,jt.height=xe,jt.getContext("2d").drawImage(Pt,0,0,Ut,xe),Pt.close(),new Promise((Xe,cn)=>{jt.toBlob(Nn=>{Nn?Xe(new File([Nn],H.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):cn(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(Pt){throw console.error("Compress error:",Pt),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh")}};useEffect(()=>{Yt(),Se()},[P.id,P.uuid]);const Yt=async()=>{Ft(!0);try{const H=await window.KTM.api.getJSON(`${API_BASE}/api/albums/${P.uuid||P.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");Ht(H.images||[]);const p=await window.KTM.api.getJSON(`${API_BASE}/api/albums?parent_id=${P.uuid||P.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");Jt(Array.isArray(p)?p:[])}catch(H){console.error(H),wt("L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u","danger")}Ft(!1)},Se=async()=>{try{const H=await window.KTM.api.getJSON(`${API_BASE}/api/albums`,"L\u1ED7i t\u1EA3i album");q(Array.isArray(H)?H:[])}catch(H){console.error("Error loading albums:",H)}},Pe=H=>{_t(p=>p.includes(H)?p.filter(G=>G!==H):[...p,H])},xt=async()=>{if(!Y||ht.length===0){wt("Vui l\xF2ng ch\u1ECDn folder \u0111\xEDch","warning");return}$t(!0);let H=0;for(const p of ht)try{await window.KTM.api.putJSON(`${API_BASE}/api/images/${p}`,{album_id:Y},"L\u1ED7i di chuy\u1EC3n \u1EA3nh"),H++}catch(G){console.error("Move error:",G)}$t(!1),ut(!1),_t([]),dt(""),H>0?(wt("\u0110\xE3 di chuy\u1EC3n \u1EA3nh th\xE0nh c\xF4ng!","success"),Yt(),F()):wt("Di chuy\u1EC3n th\u1EA5t b\u1EA1i","danger")},[ne,Je]=useState(!1),Me=async()=>{if(ht.length===0||!confirm(`X\xF3a ${ht.length} \u1EA3nh \u0111\xE3 ch\u1ECDn? H\xE0nh \u0111\u1ED9ng n\xE0y kh\xF4ng th\u1EC3 ho\xE0n t\xE1c!`))return;Je(!0);let H=0;for(const p of ht)try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${p}`,"L\u1ED7i x\xF3a \u1EA3nh"),H++}catch(G){console.error("Delete error:",G)}Je(!1),_t([]),H>0?(wt(`\u0110\xE3 x\xF3a ${H} \u1EA3nh!`,"success"),Yt(),F()):wt("X\xF3a th\u1EA5t b\u1EA1i","danger")},mn=()=>{ht.length===Et.length?_t([]):_t(Et.map(H=>H.id))},je=async()=>{if(Le.trim()){M(!0);try{const H=Le.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");await window.KTM.api.postJSON(`${API_BASE}/api/albums`,{slug:H+"-"+Date.now(),title:Le,parent_id:P.uuid||P.id},"L\u1ED7i t\u1EA1o folder"),wt("T\u1EA1o folder th\xE0nh c\xF4ng!","success"),Be(""),ee(!1),Yt(),F()}catch(H){wt(H.message,"danger")}M(!1)}},yn=async H=>{if(confirm(`X\xF3a folder "${H.title}"? T\u1EA5t c\u1EA3 n\u1ED9i dung b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${H.uuid||H.id}`,"L\u1ED7i x\xF3a folder"),wt("\u0110\xE3 x\xF3a folder","success"),Yt(),F()}catch(p){wt("L\u1ED7i x\xF3a folder","danger")}},vn=H=>{const p=Array.from(H).filter(G=>G.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(G.name));ge(G=>[...G,...p]),p.forEach(G=>{const at=new FileReader;at.onload=Pt=>{Gt(jt=>[...jt,{file:G,preview:Pt.target.result}])},at.readAsDataURL(G)})},E=H=>{ge(p=>p.filter((G,at)=>at!==H)),Gt(p=>p.filter((G,at)=>at!==H))},ct=async H=>{var G;const p=await window.KTM.cloudinary.uploadImage({file:H,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:`ktm-albums/${P.id}`});if(!p.secure_url)throw console.error("Cloudinary error:",p),new Error(((G=p.error)==null?void 0:G.message)||"Upload failed");return p},Qt=async()=>{if(pe.length===0)return;it(!0);let H=0;for(let p=0;p<pe.length;p++)try{X(`\u0110ang x\u1EED l\xFD ${p+1}/${pe.length}...`);const G=await Zt(pe[p],2);X(`\u0110ang upload ${p+1}/${pe.length}...`);const at=await ct(G);await window.KTM.api.postJSON(`${API_BASE}/api/albums/${P.id}`,{url:at.secure_url,caption:se[p]||pe[p].name.replace(/\.[^/.]+$/,""),sort_order:Et.length+p},"L\u1ED7i l\u01B0u \u1EA3nh"),H++}catch(G){console.error("Upload error:",G)}it(!1),X(""),ge([]),Gt([]),Kt({}),H>0?(wt(`\u0110\xE3 upload ${H} \u1EA3nh th\xE0nh c\xF4ng!`,"success"),Yt(),F()):wt("Upload th\u1EA5t b\u1EA1i","danger")},Ke=async(H,p)=>{if(confirm("X\xF3a \u1EA3nh n\xE0y?"))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${H}`,"L\u1ED7i x\xF3a \u1EA3nh"),wt("\u0110\xE3 x\xF3a \u1EA3nh","success"),Yt(),F()}catch(G){wt("L\u1ED7i x\xF3a \u1EA3nh","danger")}},un=H=>{var p;H.preventDefault(),(p=vt.current)==null||p.classList.add("dragover")},ze=()=>{var H;(H=vt.current)==null||H.classList.remove("dragover")},Ue=H=>{var p;H.preventDefault(),(p=vt.current)==null||p.classList.remove("dragover"),vn(H.dataTransfer.files)};return React.createElement("div",null,React.createElement("div",{className:"d-flex align-items-center justify-content-between mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:j},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("h4",{className:"m-0"},P.title),React.createElement("small",{className:"text-muted"},Ct.length>0&&React.createElement("span",null,Ct.length," folder \u2022 "),Et.length," \u1EA3nh"))),React.createElement("button",{className:"btn btn-outline-warning btn-sm",onClick:()=>ee(!0)},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder con")),on&&React.createElement("div",{className:"card mb-4 border-warning"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder-plus me-2 text-warning"}),"T\u1EA1o folder con"),React.createElement("div",{className:"d-flex gap-2"},React.createElement("input",{type:"text",className:"form-control",placeholder:"T\xEAn folder...",value:Le,onChange:H=>Be(H.target.value),onKeyPress:H=>H.key==="Enter"&&je(),autoFocus:!0}),React.createElement("button",{className:"btn btn-warning",onClick:je,disabled:$||!Le.trim()},$?React.createElement("span",{className:"spinner-border spinner-border-sm"}):"T\u1EA1o"),React.createElement("button",{className:"btn btn-secondary",onClick:()=>{ee(!1),Be("")}},"H\u1EE7y")))),Ct.length>0&&React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),"Folder con"),React.createElement("div",{className:"row g-2"},Ct.map(H=>React.createElement("div",{key:H.uuid||H.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-item",style:{cursor:"pointer"},onClick:()=>ot&&ot(H)},React.createElement("div",{className:"card-body text-center py-3"},React.createElement("i",{className:"fas fa-folder fa-2x text-warning mb-2"}),React.createElement("div",{className:"small fw-bold text-truncate"},H.title),React.createElement("small",{className:"text-muted"},H.subfolderCount>0&&React.createElement("span",null,H.subfolderCount," folder"),H.subfolderCount>0&&H.count>0&&" \u2022 ",H.count>0&&React.createElement("span",null,H.count," \u1EA3nh"),H.subfolderCount===0&&H.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0 text-center"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-1",onClick:p=>{p.stopPropagation(),J&&J(H)},title:"S\u1EEDa folder"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:p=>{p.stopPropagation(),yn(H)},title:"X\xF3a folder"},React.createElement("i",{className:"fas fa-trash"}))))))))),React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-cloud-upload-alt me-2"}),"Upload \u1EA3nh m\u1EDBi"),React.createElement("div",{ref:vt,className:"upload-zone",onClick:()=>{var H;return(H=z.current)==null?void 0:H.click()},onDragOver:un,onDragLeave:ze,onDrop:Ue},React.createElement("i",{className:"fas fa-images fa-2x text-muted mb-2"}),React.createElement("p",{className:"mb-0"},"K\xE9o th\u1EA3 \u1EA3nh v\xE0o \u0111\xE2y ho\u1EB7c click \u0111\u1EC3 ch\u1ECDn"),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3 JPG, PNG, WebP"),React.createElement("input",{ref:z,type:"file",multiple:!0,accept:"image/*",onChange:H=>vn(H.target.files)})),_e.length>0&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"upload-preview"},_e.map((H,p)=>React.createElement("div",{key:p,className:"upload-preview-item"},React.createElement("img",{src:H.preview,alt:""}),React.createElement("button",{className:"remove",onClick:()=>E(p)},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("div",{className:"mt-3"},React.createElement("button",{className:"btn btn-warning",onClick:Qt,disabled:Vt},Vt?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),Lt||"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload ",pe.length," \u1EA3nh")))))),React.createElement("div",{className:"card"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("h6",{className:"m-0"},React.createElement("i",{className:"fas fa-th me-2"}),"\u1EA2nh (",Et.length,")"),Et.length>0&&React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:mn},ht.length===Et.length?"B\u1ECF ch\u1ECDn":"Ch\u1ECDn t\u1EA5t c\u1EA3")),ht.length>0&&React.createElement("div",{className:"d-flex align-items-center gap-2 flex-wrap"},React.createElement("span",{className:"badge bg-primary"},ht.length," \u0111\xE3 ch\u1ECDn"),React.createElement("button",{className:"btn btn-sm btn-info",onClick:()=>ut(!0)},React.createElement("i",{className:"fas fa-folder-open me-1"}),"Di chuy\u1EC3n"),React.createElement("button",{className:"btn btn-sm btn-danger",onClick:Me,disabled:ne},ne?React.createElement("span",{className:"spinner-border spinner-border-sm"}):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-trash me-1"}),"X\xF3a")),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>_t([])},React.createElement("i",{className:"fas fa-times"})))),re?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):Et.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},React.createElement("i",{className:"fas fa-image fa-2x mb-2"}),React.createElement("p",null,"Ch\u01B0a c\xF3 \u1EA3nh n\xE0o trong album n\xE0y")):React.createElement("div",{className:"image-grid"},Et.map((H,p)=>React.createElement("div",{key:p,className:`image-item ${ht.includes(H.id)?"selected":""}`,style:{position:"relative",cursor:"pointer"},onClick:()=>Pe(H.id)},React.createElement("div",{className:"select-checkbox",style:{position:"absolute",top:"6px",left:"6px",zIndex:10,width:"24px",height:"24px",borderRadius:"4px",background:ht.includes(H.id)?"#0d6efd":"rgba(255,255,255,0.9)",border:ht.includes(H.id)?"none":"2px solid #ccc",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"}},ht.includes(H.id)&&React.createElement("i",{className:"fas fa-check",style:{color:"#fff",fontSize:"12px"}})),React.createElement("img",{src:H.src,alt:H.caption,style:{opacity:ht.includes(H.id)?.7:1,border:ht.includes(H.id)?"3px solid #0d6efd":"none",borderRadius:"8px"}}),React.createElement("div",{className:"actions"},React.createElement("button",{className:"btn btn-sm btn-danger",onClick:G=>{G.stopPropagation(),Ke(H.id,p)},title:"X\xF3a \u1EA3nh"},React.createElement("i",{className:"fas fa-trash"}))),H.caption&&React.createElement("div",{className:"p-2 bg-light small text-truncate"},H.caption)))))),St&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header bg-info text-white"},React.createElement("h5",{className:"modal-title"},React.createElement("i",{className:"fas fa-folder-open me-2"}),"Di chuy\u1EC3n ",ht.length," \u1EA3nh"),React.createElement("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>ut(!1)})),React.createElement("div",{className:"modal-body",style:{maxHeight:"400px",overflowY:"auto"}},React.createElement("p",{className:"text-muted small mb-3"},"Ch\u1ECDn th\u01B0 m\u1EE5c \u0111\xEDch:"),React.createElement("div",{className:"folder-tree"},x.filter(H=>!H.parentId).map(H=>React.createElement(FolderTreeItem,{key:H.uuid||H.id,folder:H,allAlbums:x,currentAlbumId:P.uuid||P.id,targetAlbum:Y,onSelect:dt})))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>ut(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-info",onClick:xt,disabled:!Y||kt},kt?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang chuy\u1EC3n..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-1"}),"Di chuy\u1EC3n \u0111\u1EBFn \u0111\xE2y")))))),ye&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.9)"},onClick:()=>$e(null)},React.createElement("div",{className:"modal-dialog modal-fullscreen d-flex align-items-center justify-content-center"},React.createElement("div",{className:"position-relative",style:{maxWidth:"95vw",maxHeight:"95vh"}},React.createElement("button",{className:"btn btn-light position-absolute",style:{top:"-50px",right:"0",borderRadius:"50%",width:"40px",height:"40px"},onClick:()=>$e(null)},React.createElement("i",{className:"fas fa-times"})),React.createElement("img",{src:ye.src,alt:ye.caption,style:{maxWidth:"95vw",maxHeight:"90vh",objectFit:"contain"},onClick:H=>H.stopPropagation()}),ye.caption&&React.createElement("div",{className:"text-white text-center mt-2"},ye.caption)))))}function SearchCenter({showToast:P,onNavigate:j}){const[F,wt]=useState(""),[ot,J]=useState([]),[V,Et]=useState([]),[Ht,Ct]=useState([]),[Jt,re]=useState("all"),[Ft,Vt]=useState(null),[it,Lt]=useState("list"),[X,pe]=useState(!0),[ge,_e]=useState([]),[Gt,se]=useState([]),Kt=useRef(null),[ye,$e]=useState(!0),[on,ee]=useState(!1),Le=useRef(null),Be=useRef(null),$=useRef(null),[M,z]=useState(!1),[vt,St]=useState([]),[ut,ht]=useState([]),[_t,x]=useState(""),q=useRef(null),Y=useRef(new Map),[dt,kt]=useState("auto"),[$t,Zt]=useState({start:0,end:20}),[Yt,Se]=useState(!1),[Pe,xt]=useState([{role:"assistant",content:`Xin ch\xE0o! H\xE3y h\u1ECFi t\xF4i v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3... V\xED d\u1EE5:
\u2022 "Gi\xE1 van 2 tay?"
\u2022 "Combo r\u1EBB nh\u1EA5t?"
\u2022 "Freeship?"`,attachments:[]}]),[ne,Je]=useState(""),[Me,mn]=useState(!1),je=useRef(null),yn=useRef(null),vn=s=>s?String(s).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").trim():"",E=s=>s?String(s).replace(/\s+/g,"").replace(/[-()]/g,"").replace(/^\+84/,"0").trim():"",ct=(s,d)=>{if(!s||!d)return s;const c=new RegExp(`(${d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return s.replace(c,'<mark style="background:#ffeb3b">$1</mark>')};useEffect(()=>{try{const s=JSON.parse(localStorage.getItem("ktm_search_history")||"[]"),d=JSON.parse(localStorage.getItem("ktm_saved_searches")||"[]");St(Array.isArray(s)?s.slice(0,10):[]),ht(Array.isArray(d)?d:[])}catch(s){}},[]);const Qt=s=>{if(!s.trim())return;const d=[s,...vt.filter(c=>c!==s)].slice(0,10);St(d);try{localStorage.setItem("ktm_search_history",JSON.stringify(d))}catch(c){}},Ke=s=>{if(!s.trim())return;const d=ut.includes(s)?ut.filter(c=>c!==s):[s,...ut].slice(0,5);ht(d);try{localStorage.setItem("ktm_saved_searches",JSON.stringify(d))}catch(c){}},un="ktm_search_query_stats_v1",ze="ktm_search_product_stats_v1",Ue=(s,d)=>{try{const c=localStorage.getItem(s);if(!c)return d;const k=JSON.parse(c);return k!=null?k:d}catch(c){return d}},H=(s,d)=>{try{localStorage.setItem(s,JSON.stringify(d))}catch(c){}},[p,G]=useState(()=>Ue(un,{})),[at,Pt]=useState(()=>Ue(ze,{})),jt=useRef(!1),Ut=useRef(new Map);useEffect(()=>{const s=d=>{d&&(d.key===un&&G(Ue(un,{})),d.key===ze&&Pt(Ue(ze,{})))};return window.addEventListener("storage",s),()=>window.removeEventListener("storage",s)},[]);const xe=s=>{const d=String(s||"").trim();if(!d)return;const c=At(d).trim();if(c.length<3||c==="sdt:"||c==="#"||c.endsWith(":"))return;const k=Date.now(),R=Ue(un,p&&typeof p=="object"?p:{}),S={...R&&typeof R=="object"?R:{}},w=S[c]&&typeof S[c]=="object"?S[c]:{};S[c]={q:d,count:(Number(w.count)||0)+1,lastAt:k},G(S),H(un,S)},ae=(s,d)=>{if(!s||s._type!=="product")return;const c=String(s.id||"").trim();if(!c)return;const k=Date.now(),R=Ue(ze,at&&typeof at=="object"?at:{}),S={...R&&typeof R=="object"?R:{}},w=S[c]&&typeof S[c]=="object"?S[c]:{};S[c]={id:c,name:String(s.name||w.name||"").trim(),code:String(s.code||w.code||"").trim(),count:(Number(w.count)||0)+1,lastAt:k,action:String(d||w.action||"").trim()},Pt(S),H(ze,S)},pn=(s,d)=>{const c=String(s||"").trim();if(!c)return;const k=At(c).trim();if(k.length<3||k==="sdt:"||k==="#"||k.endsWith(":"))return;const R=Date.now(),S=Number(Ut.current.get(k)||0);if(R-S<3e4)return;const U=(Array.isArray(d)?d:[]).find(lt=>lt&&lt._type==="product");U&&(Ut.current.set(k,R),ae(U,"search"))},Xe=useMemo(()=>Object.values(p&&typeof p=="object"?p:{}).map(c=>({q:String((c==null?void 0:c.q)||"").trim(),count:Number(c==null?void 0:c.count)||0,lastAt:Number(c==null?void 0:c.lastAt)||0})).filter(c=>c.q&&c.count>0).sort((c,k)=>k.count-c.count||k.lastAt-c.lastAt).slice(0,6),[p]),cn=useMemo(()=>Object.values(at&&typeof at=="object"?at:{}).map(c=>({id:String((c==null?void 0:c.id)||"").trim(),name:String((c==null?void 0:c.name)||"").trim(),code:String((c==null?void 0:c.code)||"").trim(),count:Number(c==null?void 0:c.count)||0,lastAt:Number(c==null?void 0:c.lastAt)||0})).filter(c=>c.id&&c.count>0).sort((c,k)=>k.count-c.count||k.lastAt-c.lastAt).slice(0,8).map(c=>{const k=V.find(R=>R&&R._type==="product"&&String(R.id)===c.id);return k?{...c,item:k}:{...c,item:null}}),[at,V]),Nn=(s,d={})=>{const c=String(s||"");ke(c),d.addToHistory!==!1&&Qt(c),z(!1),gn(!1),C(!1),d.focus!==!1?(jt.current=!0,setTimeout(()=>{var S;const R=Kt.current;(S=R==null?void 0:R.focus)==null||S.call(R);try{if(d.caret==="end"&&R&&typeof R.setSelectionRange=="function"){const w=String(R.value||"").length;R.setSelectionRange(w,w)}}catch(w){}},0)):(jt.current=!1,setTimeout(()=>{var R,S,w,U;try{(S=(R=Kt.current)==null?void 0:R.blur)==null||S.call(R),(U=(w=document.activeElement)==null?void 0:w.blur)==null||U.call(w)}catch(lt){}},0))},[ie,hn]=useState(null),[Dn,Sn]=useState(!1),[me,r]=useState(null),[l,C]=useState(!1),[h,f]=useState(!1),[L,K]=useState(null),[b,A]=useState({name:"",code:"",price:"",image:"",category:"",note:"",commission_percent:""}),D=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"],W=s=>{var d,c;s._type==="product"&&(r(s),A({name:s.name||"",code:s.code||"",price:s.price||"",image:s.image||"",category:s.category||"",note:s.note||"",commission_percent:(c=(d=s.commission_percent)!=null?d:s.commissionPercent)!=null?c:""}),Sn(!0))},st=async()=>{if(me)try{await window.KTM.api.putJSON(`${API_BASE}/api/products?id=${me.id}`,b,"L\u1ED7i c\u1EADp nh\u1EADt"),P("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),Sn(!1),r(null),Wt()}catch(s){P(s.message,"danger")}},Nt=async s=>{const d=s._type==="product"?"s\u1EA3n ph\u1EA9m":s._type==="album"?"\u1EA3nh":"video";if(confirm(`X\xF3a ${d} "${s.name}"?`))try{let c="";s._type==="product"?c=`${API_BASE}/api/products?id=${s.id}`:s._type==="album"?c=`${API_BASE}/api/images/${s.id}`:s._type==="video"&&(c=`${API_BASE}/api/videos/${s.id}`),await window.KTM.api.deleteJSON(c,"L\u1ED7i x\xF3a"),P(`\u0110\xE3 x\xF3a ${d}`,"success"),Wt()}catch(c){P(c.message,"danger")}},rt=async s=>{try{const d=L?`${API_BASE}/api/products?id=${L.id}`:`${API_BASE}/api/products`;L?await window.KTM.api.putJSON(d,s,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(d,s,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),P(L?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),f(!1),K(null),Wt()}catch(d){P(d.message,"danger")}},Dt="ktm_admin_data_cache_v1",It=1e3*60*10,Wt=async()=>{let s=null,d=!1;const c=window.KTM.cache.read(Dt,{ttlMs:It,validate:Array.isArray});c.hit?(s=c.value,console.log("[CACHE] Using cache, items:",s.length),Et(s),J(s),pe(!1),d=!0):c.status==="miss"?console.log("[CACHE] No cache found"):c.status==="expired"||c.status==="invalid"?console.log("[CACHE] Cache expired or invalid"):c.status==="error"&&console.error("[CACHE] Error parsing cache"),d||pe(!0);try{const k=async(Mt,y)=>{try{const gt=await window.KTM.api.getJSON(Mt,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");return gt!=null?gt:y}catch(gt){return y}},[R,S,w]=await Promise.all([k(`${API_BASE}/api/products?fields=search`,[]),k(`${API_BASE}/api/albums`,[]),k(`${API_BASE}/api/video-folders?withVideos=true`,[])]),U=Array.isArray(R)?R.map(Mt=>({...Mt,_type:"product",_source:"database"})):[];_e(S);let lt=[];Array.isArray(S)&&S.length>0&&(await Promise.all(S.map(y=>k(`${API_BASE}/api/albums/${y.id}`,{})))).forEach((y,gt)=>{const ft=S[gt];y.images&&y.images.length>0&&y.images.forEach(oe=>{lt.push({id:oe.id,name:oe.caption||"\u1EA2nh t\u1EEB "+ft.title,image:oe.src,folder:ft.title,_type:"album",_source:"database"})})}),se(w);let Q=[];Array.isArray(w)&&w.forEach(Mt=>{Mt.videos&&Mt.videos.forEach(y=>{Q.push({id:y.id,name:y.title,folder:Mt.name,image:y.thumb,youtubeId:y.youtubeId,url:y.url,_type:"video",_source:"database"})})});const et=[...U,...lt,...Q];(!s||JSON.stringify(et)!==JSON.stringify(s))&&(Et(et),J(et),window.KTM.cache.write(Dt,et))}catch(k){console.error("Song song fetch error:",k)}pe(!1)};useEffect(()=>{Wt(),setTimeout(()=>{var d;return(d=Kt.current)==null?void 0:d.focus()},100);const s=d=>{var c,k;(d.ctrlKey||d.metaKey)&&d.key==="k"&&(d.preventDefault(),z(!0),setTimeout(()=>{var R;return(R=q.current)==null?void 0:R.focus()},0)),d.key==="/"&&!M&&((c=document.activeElement)==null?void 0:c.tagName)!=="INPUT"&&(d.preventDefault(),(k=Kt.current)==null||k.focus()),d.key==="Escape"&&M&&z(!1)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[M]);const At=s=>{try{return String(s!=null?s:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(d){return String(s!=null?s:"").toLowerCase()}},ue=s=>{const c=At(s).trim().split(/\s+/).filter(Boolean).map(lt=>{const Q=String(lt||"").trim();return Q?Q.startsWith("#")?Q.slice(1):Q.startsWith("sdt:")?Q.slice(4):Q.startsWith("phone:")?Q.slice(6):Q:""}).filter(Boolean),k=c.includes("anh"),R=c.includes("video"),S=c.filter(lt=>lt!=="anh"&&lt!=="video"),w=S.join(" "),U=new Set(["product"]);return k&&U.add("album"),R&&U.add("video"),{allowedTypes:U,includeAlbum:k,includeVideo:R,contentTokens:S,cleanedQuery:w}},pt=(s,d,c)=>{var gt,ft,oe,le,Ae;const k=Array.isArray(d)?d:[],R=At(c).trim();if(!k.length&&!R)return 0;const S=At((gt=s==null?void 0:s.name)!=null?gt:""),w=At((ft=s==null?void 0:s.code)!=null?ft:""),U=At((oe=s==null?void 0:s.category)!=null?oe:""),lt=At((le=s==null?void 0:s.note)!=null?le:""),Q=At((Ae=s==null?void 0:s.folder)!=null?Ae:"");if(!`${S} ${w} ${U} ${lt} ${Q}`.trim())return 0;const Ot=S.replace(/\s+/g,""),Mt=R.replace(/\s+/g,"");let y=0;R&&(S===R&&(y+=220),S.includes(R)&&(y+=140),S.startsWith(R)&&(y+=160),Mt&&(Ot===Mt?y+=280:Ot.startsWith(Mt)?y+=180:Ot.includes(Mt)&&(y+=110)),w&&w===R&&(y+=180),w&&w.includes(R)&&(y+=90));for(const Ze of k){if(!Ze)continue;const qe=new RegExp(`(?:^|\\s)${Ze.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}`),Ve=String(Ze).replace(/\s+/g,"");S.includes(Ze)&&(y+=35),qe.test(S)&&(y+=25),Ve&&(Ot===Ve?y+=90:Ot.startsWith(Ve)?y+=50:Ot.includes(Ve)&&(y+=28)),w&&w.includes(Ze)&&(y+=20),w&&qe.test(w)&&(y+=10),U&&U.includes(Ze)&&(y+=12),Q&&Q.includes(Ze)&&(y+=12),lt&&lt.includes(Ze)&&(y+=6)}return y>0&&S&&(y+=Math.max(0,10-Math.min(10,Math.floor(S.length/10)))),y},zt=(s,d,c)=>{const k=Array.isArray(s)?s:[];return k.length?k.map((S,w)=>({it:S,idx:w,score:pt(S,d,c)})).sort((S,w)=>w.score!==S.score?w.score-S.score:S.idx-w.idx).map(S=>S.it):[]},De=async(s,d)=>{if(!(!ye||d.length===0)){ee(!0);try{const c=d.map(R=>({id:R.id,name:R.name,price:R.price,category:R.category,note:R.note,folder:R.folder,_type:R._type})),k=await window.KTM.api.postJSON(`${API_BASE}/api/ai-search`,{query:s,products:c},"AI Search error");if(k&&k.matchedIds&&k.matchedIds.length>0){const{contentTokens:R,cleanedQuery:S}=ue(s),w=new Set(k.matchedIds),U=d.filter(lt=>w.has(lt.id)).sort((lt,Q)=>pt(Q,R,S)-pt(lt,R,S));U.length>0&&J(U)}else k&&k.matchedIds&&k.matchedIds.length===0&&J([])}catch(c){console.error("AI Search error:",c)}ee(!1)}},ke=s=>{if(wt(s),x(s),Be.current&&clearTimeout(Be.current),Le.current&&clearTimeout(Le.current),$.current&&$.current.abort(),!s.trim()){ve(Jt);return}const c=`v2|${At(s).trim().replace(/\s+/g,"")}|${Jt}`;if(Y.current.has(c)){J(Y.current.get(c));return}const{allowedTypes:k,contentTokens:R,cleanedQuery:S}=ue(s);Be.current=setTimeout(()=>{const w=V.filter(Q=>{if(!k.has(Q==null?void 0:Q._type))return!1;if(R.length===0)return!0;const et=vn(Object.entries(Q).filter(([gt])=>!gt.startsWith("_")).map(([,gt])=>String(gt||"")).join(" ")),Ot=Q.phone?E(Q.phone):"",Mt=`${et} ${Ot}`.trim(),y=Mt.replace(/\s+/g,"");return R.every(gt=>{const ft=String(gt||"").trim();return ft?Mt.includes(ft)||y.includes(ft.replace(/\s+/g,"")):!0})});let U=w;Jt!=="all"&&(U=w.filter(Q=>(Q==null?void 0:Q._type)===Jt));const lt=zt(U,R,S);if(xe(s),pn(s,lt),Y.current.size>20){const Q=Y.current.keys().next().value;Y.current.delete(Q)}Y.current.set(c,lt),J(lt),ye&&S.length>=3&&(Le.current=setTimeout(()=>{De(S,U)},500))},200)},ve=s=>{re(s);const{allowedTypes:d,contentTokens:c}=ue(F),{cleanedQuery:k}=ue(F);let R=V.filter(S=>d.has(S==null?void 0:S._type));s!=="all"&&(R=R.filter(S=>(S==null?void 0:S._type)===s)),F.trim()&&c.length>0&&(R=R.filter(S=>{const w=At(Object.entries(S).filter(([et])=>!et.startsWith("_")).map(([,et])=>String(et||"")).join(" ")),U=S.phone?E(S.phone):"",lt=`${w} ${U}`.trim(),Q=lt.replace(/\s+/g,"");return c.every(et=>{const Ot=String(et||"").trim();return Ot?lt.includes(Ot)||Q.includes(Ot.replace(/\s+/g,"")):!0})})),J(zt(R,c,k))},Bt=(s,d,c)=>{c&&c.item&&ae(c.item,c.action||"copy"),window.KTM.clipboard.writeText(s).then(()=>{Vt(d),P("\u0110\xE3 copy!","success"),setTimeout(()=>Vt(null),1500)})},O=async(s,d,c)=>{try{c&&c.item&&ae(c.item,c.action||"copy_image"),await window.KTM.clipboard.writeImageFromUrl(s),Vt(d+"-img"),P("\u0110\xE3 copy \u1EA3nh!","success"),setTimeout(()=>Vt(null),1500)}catch(k){Bt(s,d+"-img",c)}},mt=s=>{let d=s.toLowerCase();const c=[],k=V.filter(w=>w._type==="product");if(d.includes("ty")||d.includes("xy lanh")){if(d.includes("gi\u1EEFa")||d.includes("giua")){const w=k.find(U=>{var lt;return(lt=U.name)==null?void 0:lt.toLowerCase().includes("xy lanh gi\u1EEFa")});w&&!c.find(U=>U.id===w.id)&&c.push(w)}if(d.includes("nghi\xEAng")||d.includes("nghieng")){const w=k.find(U=>{var lt;return(lt=U.name)==null?void 0:lt.toLowerCase().includes("xy lanh nghi\xEAng")});w&&!c.find(U=>U.id===w.id)&&c.push(w)}if(d.includes("\u1EE7i")||d.includes("ui")){const w=k.find(U=>{var lt;return(lt=U.name)==null?void 0:lt.toLowerCase().includes("xy lanh \u1EE7i")});w&&!c.find(U=>U.id===w.id)&&c.push(w)}}const R=d.match(/van\s*(\d+)\s*tay.*?(\d+)\s*ty/);if(R){const w=R[1],U=R[2],lt=k.find(Q=>{var Ot;const et=((Ot=Q.name)==null?void 0:Ot.toLowerCase())||"";return et.includes("combo")&&et.includes(`${w} tay`)&&(et.includes(`${U} xy`)||et.includes(`${U} xylanh`))});if(lt&&!c.find(Q=>Q.id===lt.id))c.push(lt);else{const Q=k.find(et=>{var Mt;const Ot=((Mt=et.name)==null?void 0:Mt.toLowerCase())||"";return Ot.includes("combo")&&Ot.includes(`${w} tay`)});Q&&!c.find(et=>et.id===Q.id)&&c.push(Q)}}if(d.includes("combo")&&!R){const w=d.match(/combo.*?(\d+)\s*tay/);if(w){const U=w[1];k.filter(Q=>{var Ot;const et=((Ot=Q.name)==null?void 0:Ot.toLowerCase())||"";return et.includes("combo")&&et.includes(`${U} tay`)}).forEach(Q=>{c.find(et=>et.id===Q.id)||c.push(Q)})}}const S=d.match(/van\s*(\d+)\s*tay/);if(S&&!d.includes("ty")&&!d.includes("combo")){const w=S[1],U=k.find(lt=>{var et;const Q=((et=lt.name)==null?void 0:et.toLowerCase())||"";return Q.includes(`van ${w} tay`)&&!Q.includes("combo")});U&&!c.find(lt=>lt.id===U.id)&&c.push(U)}return c.slice(0,4)},Xt=async s=>{if(!s.trim())return;const d={role:"user",content:s,attachments:[]};xt(k=>[...k,d]),Je(""),mn(!0);const c=mt(s);setTimeout(()=>{var k;return(k=je.current)==null?void 0:k.scrollIntoView({behavior:"smooth"})},100);try{const R=V.filter(et=>et._type==="product").map(et=>{let Ot=`- ${et.name}`;return et.code&&(Ot+=` (M\xE3: ${et.code})`),et.price&&(Ot+=` - Gi\xE1: ${et.price.replace(/[đ\s]/g,"")}\u0111`),et.category&&(Ot+=` [${et.category}]`),et.note&&(Ot+=` (${et.note})`),Ot}).join(`
`),w=Pe.slice(-6).map(et=>`${et.role==="user"?"Kh\xE1ch":"AI"}: ${et.content}`).join(`
`),U=w?`L\u1ECACH S\u1EEC H\u1ED8I THO\u1EA0I:
${w}

DANH S\xC1CH S\u1EA2N PH\u1EA8M:
${R}`:R,Q=(await window.KTM.api.postJSON(`${API_BASE}/api/ai-chat`,{message:s,context:U,audience:"admin"},"API error")).response||"Xin l\u1ED7i, t\xF4i kh\xF4ng th\u1EC3 tr\u1EA3 l\u1EDDi l\xFAc n\xE0y.";xt(et=>[...et,{role:"assistant",content:Q,attachments:c}])}catch(k){console.error("AI Error:",k);const R=s.toLowerCase(),S=V.filter(U=>{const lt=Object.values(U).join(" ").toLowerCase();return R.split(" ").some(Q=>lt.includes(Q))});let w="";S.length>0?(w=`T\xECm th\u1EA5y ${S.length} s\u1EA3n ph\u1EA9m li\xEAn quan:

`,S.slice(0,5).forEach(U=>{w+=`\u2022 ${U.name}`,U.price&&(w+=` - ${U.price.replace(/[đ\s]/g,"")}\u0111`),U.note&&(w+=` (${U.note})`),w+=`
`}),S.length>5&&(w+=`
...v\xE0 ${S.length-5} s\u1EA3n ph\u1EA9m kh\xE1c`)):w='Kh\xF4ng t\xECm th\u1EA5y s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p. H\xE3y th\u1EED t\u1EEB kh\xF3a kh\xE1c nh\u01B0 "van", "combo", "xy lanh"...',xt(U=>[...U,{role:"assistant",content:w,attachments:S.slice(0,4)}])}mn(!1),setTimeout(()=>{var k,R;(k=je.current)==null||k.scrollIntoView({behavior:"smooth"}),(R=yn.current)==null||R.focus()},100)};function fe({show:s,product:d,categories:c,onClose:k,onSave:R}){const[S,w]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[U,lt]=useState(!1),[Q,et]=useState(!1),Ot=useRef(null),Mt=Z=>window.KTM.money.formatVNDInputDigits(Z),y=Z=>{const nt=window.KTM.money.getDigits(String(Z!=null?Z:"")),bt=Number(nt);return nt&&Number.isFinite(bt)?Math.trunc(bt):0},gt=(Z,nt)=>{if(Z==null||Z==="")return[];let bt=Z;if(typeof bt=="string"){const Rt=bt.trim();if(!Rt)return[];try{bt=JSON.parse(Rt)}catch(Tt){return[]}}if(!Array.isArray(bt))return[];const qt=y(nt);return bt.map(Rt=>{var de;if(!Rt||typeof Rt!="object")return null;const Tt=String((de=Rt.name)!=null?de:"").trim(),he=(Array.isArray(Rt.options)?Rt.options:[]).map(Te=>{var Mn,In,Rn,Kn,Gn,Bn,ka;if(!Te||typeof Te!="object")return null;const tn=String((Mn=Te.label)!=null?Mn:"").trim();if(!tn)return null;const dn=(Gn=(Kn=(Rn=(In=Te.price)!=null?In:Te.priceValue)!=null?Rn:Te.unit_price)!=null?Kn:Te.unitPrice)!=null?Gn:null,xn=Number(dn);let An=Number.isFinite(xn)?Math.trunc(xn):null;if(An==null){const On=(ka=(Bn=Te.price_delta)!=null?Bn:Te.priceDelta)!=null?ka:null,Jn=Number(On);Number.isFinite(Jn)&&(An=qt+Math.trunc(Jn))}An==null&&(An=qt);const Cn=String(Math.max(0,Math.trunc(Number(An)||0)));return{label:tn,price:Math.max(0,Math.trunc(Number(An)||0)),priceDigits:Cn}}).filter(Boolean);return{name:Tt||"Bi\u1EBFn th\u1EC3",options:he}}).filter(Boolean)},ft=Z=>{if(Z==null||Z==="")return[];let nt=Z;if(typeof nt=="string"){const bt=nt.trim();if(!bt)return[];try{nt=JSON.parse(bt)}catch(qt){return[]}}return nt&&typeof nt=="object"&&!Array.isArray(nt)&&(nt=Object.entries(nt).map(([bt,qt])=>({key:bt,value:qt}))),Array.isArray(nt)?nt.map(bt=>{var he,de,Te,tn,dn;if(!bt||typeof bt!="object")return null;const qt=String((Te=(de=(he=bt.key)!=null?he:bt.name)!=null?de:bt.label)!=null?Te:"").trim(),Rt=String((tn=bt.value)!=null?tn:"").trim(),Tt=String((dn=bt.unit)!=null?dn:"").trim();return qt?{key:qt,value:Rt,unit:Tt}:null}).filter(Boolean):[]};useEffect(()=>{var Z,nt;if(d)if(w({name:d.name||"",code:d.code||"",price:d.price||"",image:d.image||"",category:d.category||"",note:d.note||"",sort_order:d.sort_order||0,commission_percent:(nt=(Z=d.commission_percent)!=null?Z:d.commissionPercent)!=null?nt:5,variants:gt(d.variants,d.price),attributes:ft(d.attributes)}),d.price){const bt=window.KTM.money.getDigits(d.price);Ve(bt),w(qt=>({...qt,price:Mt(bt)}))}else Ve("");else w({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),Ve("")},[d,s]);const oe=Z=>{w(nt=>{var he;const bt=y(nt.price),qt=String(bt),Rt=Array.isArray(nt.variants)?[...nt.variants]:[],Tt={...Rt[Z]||{},options:Array.isArray((he=Rt[Z])==null?void 0:he.options)?[...Rt[Z].options]:[]};return Tt.options=Tt.options.map(de=>({label:String((de==null?void 0:de.label)||""),price:bt,priceDigits:qt})),Rt[Z]=Tt,{...nt,variants:Rt}})},le=()=>{w(Z=>{const nt=y(Z.price),bt=String(nt),Rt=(Array.isArray(Z.variants)?[...Z.variants]:[]).map(Tt=>{const he=(Array.isArray(Tt==null?void 0:Tt.options)?Tt.options:[]).map(de=>({label:String((de==null?void 0:de.label)||""),price:nt,priceDigits:bt}));return{name:String((Tt==null?void 0:Tt.name)||"Bi\u1EBFn th\u1EC3"),options:he}});return{...Z,variants:Rt}})},[Ae,Ze]=React.useState(""),[qe,Ve]=React.useState(""),be=Z=>{const nt=window.KTM.money.nextPriceInputState(Z.target.value,qe);Ve(nt.digits),w({...S,price:nt.price})},nn=async(Z,nt=2)=>{const bt=nt*1024*1024;if(Z.size<=bt)return Z;try{const qt=await createImageBitmap(Z),Rt=document.createElement("canvas");let Tt=qt.width,he=qt.height;const de=1200;return(Tt>de||he>de)&&(Tt>he?(he=Math.round(he/Tt*de),Tt=de):(Tt=Math.round(Tt/he*de),he=de)),Rt.width=Tt,Rt.height=he,Rt.getContext("2d").drawImage(qt,0,0,Tt,he),qt.close(),new Promise((tn,dn)=>{Rt.toBlob(xn=>{xn?tn(new File([xn],Z.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):dn(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(qt){throw console.error("Compress error:",qt),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},fn=async Z=>{var qt;const nt=Z.target.files[0];if(!nt)return;if(!(nt.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp)$/i.test(nt.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}et(!0);try{const Rt=await nn(nt),Tt=await window.KTM.cloudinary.uploadImage({file:Rt,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-products"});if(!Tt.secure_url)throw console.error("Cloudinary error:",Tt),new Error(((qt=Tt.error)==null?void 0:qt.message)||"Upload failed");w(he=>({...he,image:Tt.secure_url}))}catch(Rt){console.error("Upload error:",Rt),alert("L\u1ED7i upload \u1EA3nh: "+Rt.message)}et(!1),Z.target.value=""},ln=async Z=>{Z.preventDefault(),lt(!0);const nt={...S,variants:gt(S.variants,S.price),attributes:ft(S.attributes)};await R(nt),lt(!1)};return s?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-lg"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,border:"none",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark"},React.createElement("i",{className:"fas fa-box me-2"}),d?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:k})),React.createElement("form",{onSubmit:ln},React.createElement("div",{className:"modal-body",style:{maxHeight:"70vh",overflowY:"auto"}},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-8"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-tag me-1"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:S.name,onChange:Z=>w({...S,name:Z.target.value}),placeholder:"V\xED d\u1EE5: Xy lanh nghi\xEAng KTM",required:!0,style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-hashtag me-1"}),"M\xE3 s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:S.code,onChange:Z=>w({...S,code:Z.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1"}),"Gi\xE1 b\xE1n"),React.createElement("input",{type:"text",className:"form-control",value:S.price,onChange:be,placeholder:"1.950.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3 mt-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-percent me-1"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:S.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:Z=>w({...S,commission_percent:Z.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-list me-1"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:S.category,onChange:Z=>w({...S,category:Z.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),c.map(Z=>React.createElement("option",{key:Z,value:Z},Z)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1"}),"Ghi ch\xFA"),React.createElement("textarea",{className:"form-control",rows:"2",value:S.note,onChange:Z=>w({...S,note:Z.target.value}),placeholder:"V\xED d\u1EE5: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(S.attributes)?S.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(S.attributes)?S.attributes:[]).map((Z,nt)=>React.createElement("div",{key:nt,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(Z==null?void 0:Z.key)||"",onChange:bt=>{const qt=bt.target.value;w(Rt=>{const Tt=Array.isArray(Rt.attributes)?[...Rt.attributes]:[];return Tt[nt]={...Tt[nt]||{},key:qt},{...Rt,attributes:Tt}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(Z==null?void 0:Z.value)||"",onChange:bt=>{const qt=bt.target.value;w(Rt=>{const Tt=Array.isArray(Rt.attributes)?[...Rt.attributes]:[];return Tt[nt]={...Tt[nt]||{},value:qt},{...Rt,attributes:Tt}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(Z==null?void 0:Z.unit)||"",onChange:bt=>{const qt=bt.target.value;w(Rt=>{const Tt=Array.isArray(Rt.attributes)?[...Rt.attributes]:[];return Tt[nt]={...Tt[nt]||{},unit:qt},{...Rt,attributes:Tt}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{w(bt=>{const qt=Array.isArray(bt.attributes)?[...bt.attributes]:[];return qt.splice(nt,1),{...bt,attributes:qt}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{w(Z=>{const nt=Array.isArray(Z.attributes)?[...Z.attributes]:[];return nt.push({key:"",value:"",unit:""}),{...Z,attributes:nt}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(S.variants)?S.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3. C\xF3 th\u1EC3 th\xEAm (v\xED d\u1EE5 Size: S/M/L)."):null,(Array.isArray(S.variants)?S.variants:[]).map((Z,nt)=>React.createElement("div",{key:nt,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(Z==null?void 0:Z.name)||"",onChange:bt=>{const qt=bt.target.value;w(Rt=>{var he;const Tt=Array.isArray(Rt.variants)?[...Rt.variants]:[];return Tt[nt]={...Tt[nt]||{},name:qt,options:Array.isArray((he=Tt[nt])==null?void 0:he.options)?Tt[nt].options:[]},{...Rt,variants:Tt}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>oe(nt),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(Z==null?void 0:Z.options)||Z.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{w(bt=>{const qt=Array.isArray(bt.variants)?[...bt.variants]:[];return qt.splice(nt,1),{...bt,variants:qt}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(Z==null?void 0:Z.options)?Z.options:[]).map((bt,qt)=>{var Rt,Tt;return React.createElement("div",{key:qt,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(bt==null?void 0:bt.label)||"",onChange:he=>{const de=he.target.value;w(Te=>{var Cn,Mn,In,Rn,Kn;const tn=Array.isArray(Te.variants)?[...Te.variants]:[],dn={...tn[nt]||{},options:Array.isArray((Cn=tn[nt])==null?void 0:Cn.options)?[...tn[nt].options]:[]},xn=Number((In=(Mn=dn.options[qt])==null?void 0:Mn.price)!=null?In:0)||0,An=String((Kn=(Rn=dn.options[qt])==null?void 0:Rn.priceDigits)!=null?Kn:Math.max(0,Math.trunc(xn)));return dn.options[qt]={...dn.options[qt]||{},label:de,price:Math.max(0,Math.trunc(xn)),priceDigits:An},tn[nt]=dn,{...Te,variants:tn}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:Mt(String((Tt=bt==null?void 0:bt.priceDigits)!=null?Tt:window.KTM.money.getDigits(String((Rt=bt==null?void 0:bt.price)!=null?Rt:"")))),onChange:he=>{w(de=>{var In,Rn,Kn,Gn,Bn;const Te=String((Rn=bt==null?void 0:bt.priceDigits)!=null?Rn:window.KTM.money.getDigits(String((In=bt==null?void 0:bt.price)!=null?In:""))),tn=window.KTM.money.nextPriceInputState(he.target.value,Te),dn=String((Kn=tn.digits)!=null?Kn:""),xn=Number(dn),An=Number.isFinite(xn)?Math.max(0,Math.trunc(xn)):0,Cn=Array.isArray(de.variants)?[...de.variants]:[],Mn={...Cn[nt]||{},options:Array.isArray((Gn=Cn[nt])==null?void 0:Gn.options)?[...Cn[nt].options]:[]};return Mn.options[qt]={...Mn.options[qt]||{},label:String(((Bn=Mn.options[qt])==null?void 0:Bn.label)||""),price:An,priceDigits:dn},Cn[nt]=Mn,{...de,variants:Cn}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{w(he=>{var tn;const de=Array.isArray(he.variants)?[...he.variants]:[],Te={...de[nt]||{},options:Array.isArray((tn=de[nt])==null?void 0:tn.options)?[...de[nt].options]:[]};return Te.options.splice(qt,1),de[nt]=Te,{...he,variants:de}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{w(bt=>{var he;const qt=Array.isArray(bt.variants)?[...bt.variants]:[],Rt={...qt[nt]||{},options:Array.isArray((he=qt[nt])==null?void 0:he.options)?[...qt[nt].options]:[]},Tt=y(bt.price);return Rt.options.push({label:"",price:Tt,priceDigits:String(Tt)}),qt[nt]=Rt,{...bt,variants:qt}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{w(Z=>{const nt=y(Z.price),bt=Array.isArray(Z.variants)?[...Z.variants]:[],qt=String(nt);return bt.push({name:"Size",options:[{label:"S",price:nt,priceDigits:qt},{label:"M",price:nt,priceDigits:qt},{label:"L",price:nt,priceDigits:qt}]}),{...Z,variants:bt}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:le,disabled:!Array.isArray(S.variants)||S.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111.")))),React.createElement("div",{className:"col-md-4"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-image me-1"}),"\u1EA2nh s\u1EA3n ph\u1EA9m"),React.createElement("div",{className:"mb-2"},S.image?React.createElement(React.Fragment,null,React.createElement("img",{src:S.image,alt:"Product",style:{width:"100%",height:150,objectFit:"cover",borderRadius:"12px",border:"2px solid #e9ecef"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger mt-2",onClick:()=>w({...S,image:""}),style:{borderRadius:"20px",fontSize:"0.75rem"}},React.createElement("i",{className:"fas fa-times me-1"}),"X\xF3a \u1EA3nh")):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:"100%",height:150,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd",cursor:"pointer"},onClick:()=>{var Z;return(Z=Ot.current)==null?void 0:Z.click()}},React.createElement("div",{className:"text-center"},React.createElement("i",{className:"fas fa-cloud-upload-alt fa-2x text-muted mb-2"}),React.createElement("div",{className:"small text-muted"},"Click \u0111\u1EC3 upload")))),React.createElement("input",{ref:Ot,type:"file",accept:"image/*",className:"d-none",onChange:fn}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100",onClick:()=>{var Z;return(Z=Ot.current)==null?void 0:Z.click()},disabled:Q,style:{borderRadius:"10px"}},Q?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh")),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"Ho\u1EB7c URL \u1EA3nh"),React.createElement("input",{type:"url",className:"form-control",value:S.image,onChange:Z=>w({...S,image:Z.target.value}),placeholder:"https://...",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"8px",fontSize:"0.875rem"}}))))),React.createElement("div",{className:"modal-footer",style:{border:"none",padding:"20px"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:k,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:U,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},U?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}const Ce=s=>window.KTM.money.formatVND(s),Ye=s=>{if(s==null||s==="")return[];let d=s;if(typeof d=="string"){const c=d.trim();if(!c)return[];try{d=JSON.parse(c)}catch(k){return[]}}return Array.isArray(d)?d:[]},Ne=s=>{if(s==null||s==="")return[];let d=s;if(typeof d=="string"){const c=d.trim();if(!c)return[];try{d=JSON.parse(c)}catch(k){return[]}}return d&&typeof d=="object"&&!Array.isArray(d)&&(d=Object.entries(d).map(([c,k])=>({key:c,value:k}))),Array.isArray(d)?d:[]},Ee=(s,d={})=>{var S;const c=Ne(s).map(w=>{var U,lt,Q,et,Ot;return{key:String((Q=(lt=(U=w==null?void 0:w.key)!=null?U:w==null?void 0:w.name)!=null?lt:w==null?void 0:w.label)!=null?Q:"").trim(),value:String((et=w==null?void 0:w.value)!=null?et:"").trim(),unit:String((Ot=w==null?void 0:w.unit)!=null?Ot:"").trim()}}).filter(w=>!!w.key);if(!c.length)return null;const k=!!d.compact,R=String((S=d.className)!=null?S:"").trim();return React.createElement("div",{className:`ktm-variants-preview${k?" compact":""}${R?" "+R:""}`},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},c.map((w,U)=>{const lt=w.key,Q=`${w.value||""}${w.unit?(w.value?" ":"")+w.unit:""}`.trim();return React.createElement("div",{key:`${lt}-${U}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},lt),Q?React.createElement("span",{className:"ktm-chip ktm-chip-option"},Q):null)})))},Qe=(s,d={})=>{var lt;const c=Ye(s).map(Q=>{var et;return{name:String((et=Q==null?void 0:Q.name)!=null?et:"").trim(),options:Array.isArray(Q==null?void 0:Q.options)?Q.options:[]}}).map(Q=>({...Q,options:Q.options.map(et=>{var Ot;return{label:String((Ot=et==null?void 0:et.label)!=null?Ot:"").trim(),price:Number(et==null?void 0:et.price)}}).filter(et=>!!et.label)})).filter(Q=>Q.options.length>0);if(!c.length)return null;const k=Number.isFinite(d.maxGroups)?Math.max(1,Math.trunc(d.maxGroups)):c.length,R=Number.isFinite(d.maxOptionsPerGroup)?Math.max(1,Math.trunc(d.maxOptionsPerGroup)):3,S=!!d.compact,w=String((lt=d.className)!=null?lt:"").trim(),U=c.slice(0,k);return React.createElement("div",{className:`ktm-variants-preview${S?" compact":""}${w?" "+w:""}`},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},U.map((Q,et)=>{const Ot=Q.name||"Bi\u1EBFn th\u1EC3",Mt=Q.options.slice(0,R),y=Q.options.length-Mt.length;return React.createElement("div",{key:`${Ot}-${et}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},Ot),Mt.map((gt,ft)=>{const oe=gt.price,le=Number.isFinite(oe)&&oe>=0?Ce(Math.trunc(oe)):"",Ae=le?`${gt.label} \xB7 ${le}`:gt.label;return React.createElement("span",{key:`${Ot}-${et}-${ft}`,className:"ktm-chip ktm-chip-option"},Ae)}),y>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",y))})))},Ie=(s,d)=>{const c=s._type==="product",k=s._type==="album",R=s._type==="video",S=s.note&&(s.note.toLowerCase().includes("free")||s.note.toLowerCase().includes("gi\u1EA3m")||s.note.toLowerCase().includes("sale")),w=c?Ee(s.attributes,{compact:it==="grid",className:it==="grid"?"meta text-muted":"text-muted"}):null,U=c?Qe(s.variants,{compact:it==="grid",maxOptionsPerGroup:999,className:it==="grid"?"meta text-muted":"text-muted"}):null;return it==="grid"?React.createElement("div",{key:s.id||d,className:"grid-card"},React.createElement("div",{className:"thumb-wrap",onClick:()=>{ae(s,"preview"),hn({url:s.image,name:s.name,price:s.price,note:s.note,item:s})}},s.image?React.createElement("img",{src:s.image,alt:s.name,className:"thumb",loading:"lazy"}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${R?"fa-video":"fa-image"} fa-2x text-muted`})),s.price&&React.createElement("div",{className:"price-overlay"},s.price.replace(/[đ\s]/g,""),"\u0111"),React.createElement("span",{className:`type-badge ${c?"product":k?"album":"video"}`},c?"SP":k?"\u1EA2nh":"Video"),S&&React.createElement("span",{className:"promo-badge"},"\u{1F525} \u01AFU \u0110\xC3I")),React.createElement("div",{className:"card-body"},React.createElement("div",{className:"name"},s.name),s.note&&React.createElement("div",{className:"meta text-info",style:{fontSize:10}},s.note),w&&React.createElement("div",{style:{marginTop:2}},w),U&&React.createElement("div",{style:{marginTop:2}},U),React.createElement("div",{className:"quick-copy"},React.createElement("button",{className:Ft===s.id+"-img"?"copied":"",onClick:()=>O(s.image,s.id,{item:s,action:"copy_image"})},React.createElement("i",{className:"fas fa-image"})),s.price&&React.createElement("button",{className:Ft===s.id+"-price"?"copied":"",onClick:()=>Bt(s.price.replace(/[đ\s]/g,""),s.id+"-price",{item:s,action:"copy_price"})},React.createElement("i",{className:"fas fa-tag"}))))):React.createElement("div",{key:s.id||d,className:"product-card-mobile"},React.createElement("span",{className:`type-badge ${c?"product":k?"album":"video"}`},c?"S\u1EA3n ph\u1EA9m":k?"\u1EA2nh":"Video"),React.createElement("div",{className:"card-inner"},s.image?React.createElement("img",{src:s.image,alt:s.name,className:"thumb",loading:"lazy",onClick:()=>{ae(s,"preview"),hn({url:s.image,name:s.name,price:s.price,note:s.note,item:s})}}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${R?"fa-video":"fa-image"} fa-2x text-muted`})),React.createElement("div",{className:"info"},React.createElement("div",null,React.createElement("div",{className:"name"},s.name),React.createElement("div",{className:"price-row"},s.price&&React.createElement("span",{className:"price"},s.price.replace(/[đ\s]/g,""),"\u0111"),S&&React.createElement("span",{className:"badge-promo"},"\u{1F525} \u01AFU \u0110\xC3I")),w&&React.createElement("div",{style:{marginTop:4}},w),U&&React.createElement("div",{style:{marginTop:4}},U)),React.createElement("div",{className:"meta"},s.code&&React.createElement("span",{className:"meta-tag"},"#",s.code),s.category&&React.createElement("span",{className:"meta-tag"},s.category),s.note&&React.createElement("span",{className:"meta-tag highlight"},s.note),s.folder&&React.createElement("span",{className:"meta-tag"},s.folder),R&&React.createElement("span",{className:"meta-tag"},React.createElement("i",{className:"fab fa-youtube text-danger"})," Video")))),React.createElement("div",{className:"quick-actions"},c&&React.createElement("button",{onClick:()=>{ae(s,"create_order"),j&&j("orders","create",{productId:s.id})}},React.createElement("i",{className:"fas fa-receipt"})," T\u1EA1o \u0111\u01A1n"),s.price&&React.createElement("button",{className:Ft===s.id+"-price"?"copied":"",onClick:()=>Bt(s.price.replace(/[đ\s]/g,""),s.id+"-price",{item:s,action:"copy_price"})},React.createElement("i",{className:"fas fa-tag"})," Gi\xE1"),React.createElement("button",{className:Ft===s.id+"-name"?"copied":"",onClick:()=>Bt(s.name,s.id+"-name",{item:s,action:"copy_name"})},React.createElement("i",{className:"fas fa-font"})," T\xEAn"),R&&s.youtubeId&&React.createElement("button",{className:Ft===s.id+"-yt"?"copied":"",onClick:()=>Bt(`https://www.youtube.com/watch?v=${s.youtubeId}`,s.id+"-yt")},React.createElement("i",{className:"fab fa-youtube"})),c&&React.createElement("button",{className:"action-edit",onClick:()=>W(s)},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"action-delete",onClick:()=>Nt(s)},React.createElement("i",{className:"fas fa-trash"}))))},[en,gn]=useState(!1);return React.createElement(React.Fragment,null,React.createElement("div",{className:"search-suggestions mobile-only"},React.createElement("div",{className:"search-suggestions-section"},React.createElement("div",{className:"search-suggestions-label"},"G\u1EE3i \xFD nhanh"),React.createElement("div",{className:"search-suggestions-row"},[{label:"van 2 tay",query:"van 2 tay"},{label:"combo r\u1EBB",query:"combo r\u1EBB"},{label:"xylanh",query:"xylanh"},{label:"sdt:\u2026",query:"sdt:",caret:"end",addToHistory:!1},{label:"#m\xE3\u2026",query:"#",caret:"end",addToHistory:!1}].map(s=>React.createElement("button",{key:s.label,type:"button",className:"suggestion-chip",onClick:()=>Nn(s.query,{caret:s.caret,addToHistory:s.addToHistory,focus:!1})},s.label)))),cn.length>0&&React.createElement("div",{className:"search-suggestions-section"},React.createElement("div",{className:"search-suggestions-label"},"S\u1EA3n ph\u1EA9m hay t\xECm"),React.createElement("div",{className:"search-suggestions-row"},cn.map(s=>{var R,S;const d=(((R=s.item)==null?void 0:R.name)||s.name||"").trim();if(!d)return null;const c=String(((S=s.item)==null?void 0:S.code)||s.code||"").trim(),k=c?`#${c}`:d;return React.createElement("button",{key:s.id,type:"button",className:"suggestion-chip suggestion-chip-popular",onClick:()=>{s.item&&ae(s.item,"suggestion"),Nn(k,{caret:"end",focus:!1})},title:c?`#${c}`:d},d)}))),Xe.length>0&&React.createElement("div",{className:"search-suggestions-section"},React.createElement("div",{className:"search-suggestions-label"},"T\xECm g\u1EA7n \u0111\xE2y / hay d\xF9ng"),React.createElement("div",{className:"search-suggestions-row"},Xe.map(s=>React.createElement("button",{key:s.q,type:"button",className:"suggestion-chip suggestion-chip-query",onClick:()=>Nn(s.q,{caret:"end",focus:!1}),title:`${s.q} (${s.count})`},s.q))))),React.createElement("div",{className:"result-header"},React.createElement("span",null,React.createElement("strong",null,ot.length)," k\u1EBFt qu\u1EA3",ye&&F.length>=3&&React.createElement("span",{className:"ai-badge ms-2"},React.createElement("i",{className:"fas fa-robot"})," AI"),Jt!=="all"&&React.createElement("span",{className:"ms-2 badge bg-warning text-dark"},Jt==="product"?"S\u1EA3n ph\u1EA9m":Jt==="album"?"\u1EA2nh":"Video")),React.createElement("div",{className:"d-flex gap-1 align-items-center"},React.createElement("button",{className:`btn btn-sm ${it==="list"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>Lt("list"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-list"})),React.createElement("button",{className:`btn btn-sm ${it==="grid"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>Lt("grid"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-th"})))),React.createElement("div",{className:"search-results-area"},X?React.createElement("div",null,[...Array(8)].map((s,d)=>React.createElement("div",{key:d,className:"product-card-mobile mb-2",style:{opacity:.7}},React.createElement("div",{className:"card-inner"},React.createElement("div",{className:"thumb bg-light",style:{width:80,height:80,borderRadius:8}}),React.createElement("div",{className:"info",style:{flex:1,minWidth:0}},React.createElement("div",{className:"skeleton-box mb-2",style:{height:16,width:"60%",background:"#eee",borderRadius:4}}),React.createElement("div",{className:"skeleton-box mb-1",style:{height:12,width:"40%",background:"#f3f3f3",borderRadius:4}}),React.createElement("div",{className:"skeleton-box",style:{height:10,width:"30%",background:"#f3f3f3",borderRadius:4}})))))):ot.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-search"}),React.createElement("p",null,'Kh\xF4ng t\xECm th\u1EA5y "',F,'"'),React.createElement("button",{className:"btn btn-warning",onClick:()=>{wt(""),ke("")}},"Xem t\u1EA5t c\u1EA3")):it==="grid"?React.createElement("div",{className:"product-grid-mobile"},ot.map((s,d)=>Ie(s,d))):React.createElement("div",null,ot.map((s,d)=>Ie(s,d)))),en&&React.createElement("div",{className:"filter-dropdown"},React.createElement("div",{className:"filter-header"},React.createElement("strong",null,"L\u1ECDc theo lo\u1EA1i"),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>gn(!1)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"filter-chips"},React.createElement("span",{className:`filter-chip ${Jt==="all"?"active":""}`,onClick:()=>{ve("all"),gn(!1)}},"T\u1EA5t c\u1EA3"),React.createElement("span",{className:`filter-chip ${Jt==="product"?"active":""}`,onClick:()=>{ve("product"),gn(!1)}},React.createElement("i",{className:"fas fa-box me-1"}),"S\u1EA3n ph\u1EA9m"),React.createElement("span",{className:`filter-chip ${Jt==="album"?"active":""}`,onClick:()=>{ve("album"),gn(!1)}},React.createElement("i",{className:"fas fa-images me-1"}),"\u1EA2nh"),React.createElement("span",{className:`filter-chip ${Jt==="video"?"active":""}`,onClick:()=>{ve("video"),gn(!1)}},React.createElement("i",{className:"fas fa-video me-1"}),"Video")),React.createElement("div",{className:"mt-3 pt-3 border-top d-flex align-items-center justify-content-between"},React.createElement("span",null,"AI Search th\xF4ng minh"),React.createElement("div",{className:"form-check form-switch m-0"},React.createElement("input",{type:"checkbox",className:"form-check-input",checked:ye,onChange:s=>$e(s.target.checked),style:{width:40,height:20}})))),React.createElement("div",{className:"search-bar-bottom"},React.createElement("div",{className:"search-input-wrap"},React.createElement("input",{ref:Kt,type:"text",className:"search-input",placeholder:"\u{1F50D} T\xECm: van 3 tay, xylanh... (/ \u0111\u1EC3 focus, Ctrl+K palette)",value:F,onChange:s=>ke(s.target.value)}),React.createElement("button",{className:`filter-btn ${en||Jt!=="all"?"active":""}`,onClick:()=>gn(!en)},React.createElement("i",{className:"fas fa-filter"})))),M&&React.createElement("div",{className:"search-palette-overlay",onClick:()=>z(!1)},React.createElement("div",{className:"search-palette",onClick:s=>s.stopPropagation()},React.createElement("div",{className:"palette-header"},React.createElement("input",{ref:q,type:"text",className:"palette-input",placeholder:"\u{1F50D} T\xECm ki\u1EBFm n\xE2ng cao... (filter: \u1EA3nh, video; t\u1EEB kh\xF3a...)",value:_t,onChange:s=>ke(s.target.value),onKeyDown:s=>{s.key==="Enter"&&ot.length>0?(Qt(_t),z(!1)):s.key==="Escape"&&z(!1)}}),React.createElement("button",{className:"palette-close",onClick:()=>z(!1)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"palette-body"},React.createElement("div",{className:"palette-section"},React.createElement("div",{className:"section-label"},"Lo\u1EA1i"),React.createElement("div",{className:"filter-chips-row"},["T\u1EA5t c\u1EA3","S\u1EA3n ph\u1EA9m","\u1EA2nh","Video"].map((s,d)=>React.createElement("span",{key:s,className:`filter-chip ${Jt===["all","product","album","video"][d]?"active":""}`,onClick:()=>{ve(["all","product","album","video"][d])}},s)))),ut.length>0&&!_t.trim()&&React.createElement("div",{className:"palette-section"},React.createElement("div",{className:"section-label"},React.createElement("i",{className:"fas fa-star me-1"}),"T\xECm ki\u1EBFm \u0111\xE3 l\u01B0u"),React.createElement("div",{className:"palette-items"},ut.map((s,d)=>React.createElement("div",{key:d,className:"palette-item",onClick:()=>{ke(s),Qt(s)}},React.createElement("i",{className:"fas fa-star"}),React.createElement("span",null,s),React.createElement("button",{className:"unsave-btn",onClick:c=>{c.stopPropagation(),Ke(s)}},React.createElement("i",{className:"fas fa-trash-alt"})))))),vt.length>0&&!_t.trim()&&React.createElement("div",{className:"palette-section"},React.createElement("div",{className:"section-label"},React.createElement("i",{className:"fas fa-clock me-1"}),"L\u1ECBch s\u1EED t\xECm ki\u1EBFm"),React.createElement("div",{className:"palette-items"},vt.map((s,d)=>React.createElement("div",{key:d,className:"palette-item",onClick:()=>{ke(s)}},React.createElement("i",{className:"fas fa-history"}),React.createElement("span",null,s),React.createElement("button",{className:"save-btn",onClick:c=>{c.stopPropagation(),Ke(s)}},React.createElement("i",{className:`fas fa-star${ut.includes(s)?"":"-o"}`})))))),_t.trim()&&ot.length>0&&React.createElement("div",{className:"palette-section"},React.createElement("div",{className:"section-label"},"K\u1EBFt qu\u1EA3 (",ot.length,")"),React.createElement("div",{className:"palette-items",style:{maxHeight:300,overflowY:"auto"}},ot.slice(0,8).map((s,d)=>React.createElement("div",{key:s.id||d,className:"palette-result-item",onClick:()=>{Qt(_t),z(!1)}},s.image&&React.createElement("img",{src:s.image,alt:s.name,className:"result-thumb"}),React.createElement("div",{className:"result-text"},React.createElement("div",{className:"result-name"},s.name),s.price&&React.createElement("div",{className:"result-meta"},s.price.replace(/[đ\s]/g,""),"\u0111")),React.createElement("button",{className:"save-btn",onClick:c=>{c.stopPropagation(),Ke(_t)}},React.createElement("i",{className:`fas fa-star${ut.includes(_t)?"":"-o"}`})))))),_t.trim()&&ot.length===0&&React.createElement("div",{className:"palette-empty"},React.createElement("i",{className:"fas fa-search"}),React.createElement("p",null,'Kh\xF4ng t\xECm th\u1EA5y k\u1EBFt qu\u1EA3 cho "',_t,'"'))),React.createElement("div",{className:"palette-footer"},React.createElement("span",null,React.createElement("kbd",null,"Esc")," \u0111\u1EC3 \u0111\xF3ng"),React.createElement("span",null,React.createElement("kbd",null,"Enter")," \u0111\u1EC3 l\u01B0u v\xE0o l\u1ECBch s\u1EED")))),React.createElement("button",{className:"btn btn-lg rounded-circle position-fixed shadow-lg",style:{bottom:l?320:130,right:16,width:56,height:56,zIndex:1050,transition:"bottom 0.2s ease",background:"linear-gradient(135deg, #667eea, #764ba2)",color:"#fff",border:"none",WebkitTapHighlightColor:"transparent",touchAction:"manipulation",cursor:"pointer",outline:"none"},onClick:()=>Se(!0),onTouchStart:()=>Se(!0)},React.createElement("i",{className:"fas fa-robot fa-lg"})),Yt&&React.createElement("div",{className:"ai-chat-mobile"},React.createElement("div",{className:"chat-header"},React.createElement("button",{className:"back-btn",onClick:()=>Se(!1)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("strong",null,"KTM AI Assistant"),React.createElement("div",{style:{fontSize:11,opacity:.8}},"H\u1ECFi v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3..."))),React.createElement("div",{className:"chat-messages"},Pe.map((s,d)=>React.createElement("div",{key:d,className:`mb-3 ${s.role==="user"?"d-flex justify-content-end":""}`},React.createElement("div",{className:`p-3 rounded-3 position-relative ${s.role==="user"?"text-white":"bg-white border"}`,style:{maxWidth:"85%",whiteSpace:"pre-wrap",background:s.role==="user"?"linear-gradient(135deg, #667eea, #764ba2)":void 0}},s.content,s.role==="assistant"&&React.createElement("button",{className:"btn btn-sm position-absolute",style:{top:4,right:4,padding:"2px 6px",fontSize:11,background:Ft===`chat-${d}`?"#28a745":"rgba(0,0,0,0.1)",border:"none",borderRadius:4,color:Ft===`chat-${d}`?"#fff":"#666"},onClick:()=>{window.KTM.clipboard.writeText(s.content),Vt(`chat-${d}`),setTimeout(()=>Vt(null),1500)}},React.createElement("i",{className:`fas ${Ft===`chat-${d}`?"fa-check":"fa-copy"}`})),s.attachments&&s.attachments.length>0&&React.createElement("div",{className:"mt-2 d-flex flex-wrap gap-2"},s.attachments.map((c,k)=>React.createElement("div",{key:k,style:{width:70},className:"text-center"},c.image&&React.createElement("img",{src:c.image,className:"rounded",style:{width:70,height:50,objectFit:"cover",cursor:"pointer"},onClick:()=>hn({url:c.image,name:c.name,price:c.price})}),React.createElement("div",{style:{fontSize:9},className:"text-truncate"},c.name),c.price&&React.createElement("div",{style:{fontSize:10,color:"#dc3545",fontWeight:600}},c.price.replace(/[đ\s]/g,""),"\u0111"))))))),Me&&React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"bg-white border p-3 rounded-3 d-inline-block"},React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang suy ngh\u0129...")),React.createElement("div",{ref:je})),React.createElement("div",{className:"px-3 py-2 border-top d-flex gap-2 overflow-auto"},["Gi\xE1 van 2 tay?","Combo r\u1EBB nh\u1EA5t?","Freeship?","Van 3 tay?"].map(s=>React.createElement("button",{key:s,className:"btn btn-sm btn-outline-secondary flex-shrink-0",onClick:()=>Xt(s),disabled:Me,style:{whiteSpace:"nowrap"}},s))),React.createElement("div",{className:"chat-input-area"},React.createElement("form",{onSubmit:s=>{s.preventDefault(),Xt(ne)},className:"chat-input-wrap"},React.createElement("input",{ref:yn,type:"text",className:"chat-input",placeholder:"Nh\u1EADp c\xE2u h\u1ECFi...",value:ne,onChange:s=>Je(s.target.value),disabled:Me}),React.createElement("button",{type:"submit",className:"send-btn",disabled:Me||!ne.trim()},React.createElement("i",{className:"fas fa-paper-plane"}))))),ie&&React.createElement("div",{className:"preview-modal",onClick:()=>hn(null)},React.createElement("div",{className:"preview-header"},React.createElement("div",null),React.createElement("button",{className:"close-btn",onClick:()=>hn(null)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"preview-body",onClick:s=>s.stopPropagation()},React.createElement("img",{src:ie.url,alt:ie.name})),React.createElement("div",{className:"preview-footer",onClick:s=>s.stopPropagation()},React.createElement("div",{className:"name"},ie.name),ie.price&&React.createElement("div",{className:"price"},ie.price.replace(/[đ\s]/g,""),"\u0111"),ie.note&&React.createElement("div",{className:"mb-2",style:{fontSize:14,color:"#17a2b8"}},ie.note),React.createElement("div",{className:"action-btns"},React.createElement("button",{className:Ft==="preview-img"?"btn-success text-white":"btn-outline-light text-white",style:{background:Ft==="preview-img"?"#28a745":"rgba(255,255,255,0.2)"},onClick:()=>O(ie.url,"preview")},React.createElement("i",{className:`fas ${Ft==="preview-img"?"fa-check":"fa-copy"}`}),"Copy \u1EA3nh"),ie.price&&React.createElement("button",{className:Ft==="preview-price"?"btn-success text-white":"btn-warning",onClick:()=>Bt(ie.price.replace(/[đ\s]/g,""),"preview-price")},React.createElement("i",{className:`fas ${Ft==="preview-price"?"fa-check":"fa-tag"}`}),"Copy gi\xE1")))),React.createElement(fe,{show:h,product:L,categories:Ht,onClose:()=>{f(!1),K(null)},onSave:rt}),React.createElement("div",{className:`fab-container mobile-only ${l?"open":""}`},React.createElement("div",{className:"fab-actions"},React.createElement("button",{className:"fab-action product",onClick:()=>{C(!1),f(!0),K(null)}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",{className:"tooltip"},"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("button",{className:"fab-action product",onClick:()=>{C(!1),j&&j("orders","create")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",{className:"tooltip"},"T\u1EA1o order nhanh"))),React.createElement("button",{className:`fab-main ${l?"open":""}`,onClick:()=>C(!l)},React.createElement("i",{className:"fas fa-plus"}))),Dn&&me&&React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,maxHeight:"90vh"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none"}},React.createElement("h6",{className:"modal-title fw-bold"},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa nhanh"),React.createElement("button",{type:"button",className:"btn-close",onClick:()=>Sn(!1)})),React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"T\xEAn s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:b.name,onChange:s=>A({...b,name:s.target.value})})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:b.code,onChange:s=>A({...b,code:s.target.value})})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:b.price,onChange:s=>A({...b,price:s.target.value})}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:b.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:s=>A({...b,commission_percent:s.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:b.category,onChange:s=>A({...b,category:s.target.value})},React.createElement("option",{value:""},"-- Ch\u1ECDn danh m\u1EE5c --"),D.map(s=>React.createElement("option",{key:s,value:s},s)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Ghi ch\xFA (\u01B0u \u0111\xE3i)"),React.createElement("input",{type:"text",className:"form-control",value:b.note,placeholder:"VD: Free ship, Gi\u1EA3m 10%...",onChange:s=>A({...b,note:s.target.value})}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>Sn(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-warning",onClick:st},React.createElement("i",{className:"fas fa-save me-1"}),"L\u01B0u"))))))}function VideoList({onRefresh:P,showToast:j}){const[F,wt]=useState([]),[ot,J]=useState([]),[V,Et]=useState(!0),[Ht,Ct]=useState(null),[Jt,re]=useState(!1),[Ft,Vt]=useState(null),[it,Lt]=useState(!1),[X,pe]=useState(null),[ge,_e]=useState(!1),[Gt,se]=useState(null),[Kt,ye]=useState(!1),[$e,on]=useState(!1),[ee,Le]=useState(null),[Be,$]=useState(!1),[M,z]=useState(null),[vt,St]=useState([]);useEffect(()=>{ut()},[]);const ut=async(E=null)=>{Et(!0);try{const ct=E?`${API_BASE}/api/video-folders?withVideos=true&parent_id=${E}`:`${API_BASE}/api/video-folders?withVideos=true&parent_id=root`,Qt=await window.KTM.api.getJSON(ct,"L\u1ED7i t\u1EA3i danh s\xE1ch folder");wt(Array.isArray(Qt)?Qt:[])}catch(ct){console.error(ct),j("L\u1ED7i t\u1EA3i danh s\xE1ch folder","danger")}Et(!1)},ht=async E=>{try{const ct=await window.KTM.api.getJSON(`${API_BASE}/api/videos?folderId=${E}`,"L\u1ED7i t\u1EA3i video");J(Array.isArray(ct)?ct:[])}catch(ct){console.error(ct)}},_t=async E=>{if(E===0)return;const ct=[...F];[ct[E-1],ct[E]]=[ct[E],ct[E-1]],wt(ct),await q(ct)},x=async E=>{if(E===F.length-1)return;const ct=[...F];[ct[E],ct[E+1]]=[ct[E+1],ct[E]],wt(ct),await q(ct)},q=async E=>{try{await Promise.all(E.map((ct,Qt)=>window.KTM.api.putJSON(`${API_BASE}/api/video-folders/${ct.id}`,{sortOrder:Qt},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),j("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(ct){j("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),ut(M==null?void 0:M.id)}},Y=async E=>{if(E===0)return;const ct=[...ot];[ct[E-1],ct[E]]=[ct[E],ct[E-1]],J(ct),await kt(ct)},dt=async E=>{if(E===ot.length-1)return;const ct=[...ot];[ct[E],ct[E+1]]=[ct[E+1],ct[E]],J(ct),await kt(ct)},kt=async E=>{try{await Promise.all(E.map((ct,Qt)=>window.KTM.api.putJSON(`${API_BASE}/api/videos/${ct.id}`,{sort_order:Qt},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),j("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(ct){j("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),ht(Ht.id)}},$t=()=>{Vt(null),re(!0)},Zt=E=>{Le(E),on(!0),$(!0)},Yt=async(E,ct="modal")=>{try{!Ft&&M&&(E.parent_id=M.id);const Qt=Ft?`${API_BASE}/api/video-folders/${Ft.id}`:`${API_BASE}/api/video-folders`;Ft?await window.KTM.api.putJSON(Qt,E,"L\u1ED7i l\u01B0u folder"):await window.KTM.api.postJSON(Qt,E,"L\u1ED7i l\u01B0u folder"),j(Ft?"\u0110\xE3 c\u1EADp nh\u1EADt folder!":"\u0110\xE3 t\u1EA1o folder m\u1EDBi!","success"),ct==="drawer"?($(!1),Vt(null),ut(M==null?void 0:M.id),Ft&&ee&&Le({...ee,...E})):(re(!1),Vt(null),ut(M==null?void 0:M.id))}catch(Qt){j(Qt.message,"danger")}},Se=async E=>{const ct=E.subfolderCount>0?`X\xF3a folder "${E.name}"? T\u1EA5t c\u1EA3 subfolder v\xE0 videos b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`:`X\xF3a folder "${E.name}"? Videos trong folder s\u1EBD kh\xF4ng b\u1ECB x\xF3a.`;if(confirm(ct))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/video-folders/${E.id}`,"L\u1ED7i x\xF3a folder"),j("\u0110\xE3 x\xF3a folder","success"),Ct(null),ut(M==null?void 0:M.id)}catch(Qt){j("L\u1ED7i x\xF3a folder","danger")}},Pe=E=>{E.subfolderCount>0?(St(ct=>[...ct,E]),z(E),ut(E.id)):(Ct(E),J(E.videos||[]))},xt=E=>{if(E==="root")St([]),z(null),ut(null);else if(E){const ct=vt.findIndex(Qt=>Qt.id===E.id);ct>=0&&(St(vt.slice(0,ct+1)),z(E),ut(E.id))}else{const ct=[...vt];ct.pop();const Qt=ct[ct.length-1]||null;St(ct),z(Qt),ut(Qt==null?void 0:Qt.id)}},ne=()=>{on(!1),$(!1),Le(null)},Je=()=>{_e(!1),ye(!1),se(null)},Me=()=>{pe(null),Lt(!0)},mn=E=>{se(E),_e(!0),ye(!0)},je=async(E,ct="modal")=>{try{E.folder_id=Ht==null?void 0:Ht.id;const Qt=X?`${API_BASE}/api/videos/${X.id}`:`${API_BASE}/api/videos`;X?await window.KTM.api.putJSON(Qt,E,"L\u1ED7i l\u01B0u video"):await window.KTM.api.postJSON(Qt,E,"L\u1ED7i l\u01B0u video"),j(X?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm video th\xE0nh c\xF4ng!","success"),ct==="drawer"?(ye(!1),pe(null),ut(),Ht&&ht(Ht.id),X&&Gt&&se({...Gt,...E})):(Lt(!1),pe(null),ut(),Ht&&ht(Ht.id))}catch(Qt){j(Qt.message,"danger")}},yn=async E=>{if(confirm(`X\xF3a video "${E.title}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/videos/${E.id}`,"L\u1ED7i x\xF3a video"),j("\u0110\xE3 x\xF3a video","success"),ut(),Ht&&ht(Ht.id)}catch(ct){j("L\u1ED7i x\xF3a video","danger")}},vn=E=>{const ct=`https://www.youtube.com/watch?v=${E.youtubeId}`;window.KTM.clipboard.writeText(ct).then(()=>{j("\u0110\xE3 copy link!","success")}).catch(()=>{j("Kh\xF4ng th\u1EC3 copy link","danger")})};return Ht?React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>Ct(null)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:`fas fa-folder-open me-2 ${Ht.slug==="shorts"?"text-danger":"text-warning"}`}),Ht.name)),React.createElement("button",{className:"btn btn-warning",onClick:Me},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm Video")),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1 videos"),ot.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-video fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},"Ch\u01B0a c\xF3 video trong folder n\xE0y")):React.createElement("div",{className:"row g-4"},ot.map((E,ct)=>React.createElement("div",{key:E.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>Y(ct),disabled:ct===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},ct+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>dt(ct),disabled:ct===ot.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"position-relative"},React.createElement("img",{src:E.thumb,className:"card-img-top",alt:E.title,style:{height:"120px",objectFit:"cover"}}),React.createElement("a",{href:`https://www.youtube.com/watch?v=${E.youtubeId}`,target:"_blank",className:"position-absolute top-50 start-50 translate-middle"},React.createElement("i",{className:"fas fa-play-circle fa-3x text-white",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"}}))),React.createElement("div",{className:"card-body py-2"},React.createElement("h6",{className:"card-title small mb-1 text-truncate",title:E.title},E.title),React.createElement("small",{className:"text-muted"},E.youtubeId)),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-primary",onClick:()=>vn(E),title:"Copy link"},React.createElement("i",{className:"fas fa-link"})),React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>mn(E),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-outline-danger",onClick:()=>yn(E),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))))),React.createElement(VideoModal,{show:it,video:X,onClose:()=>Lt(!1),onSave:je}),React.createElement(AdminDrawer,{open:$e,title:ee?ee.name:"Folder",subtitle:ee?`${ee.subfolderCount||0} subfolder \u2022 ${ee.videoCount||0} videos`:"",onClose:ne,footer:Be?React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:ne},React.createElement("i",{className:"fas fa-xmark me-2"}),"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-warning fw-semibold",onClick:()=>{ee&&Yt({name:ee.name||"",description:ee.description||"",sortOrder:ee.sortOrder||0},"drawer")}},React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u")):ee?React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{window.KTM.clipboard.writeText(ee.name),j("\u0110\xE3 copy t\xEAn folder","success")}},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy"),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>{$(!0)}},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>{confirm(`X\xF3a folder "${ee.name}"?`)&&(Se(ee),ne())}},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a"))):null},Be&&ee?React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-pen me-2 text-warning"}),"Ch\u1EC9nh s\u1EEDa"),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:ee.name||"",onChange:E=>Le({...ee,name:E.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:ee.description||"",onChange:E=>Le({...ee,description:E.target.value})}))):ee?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"Th\xF4ng tin"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"T\xEAn"),React.createElement("div",{className:"v"},ee.name),React.createElement("div",{className:"k"},"Slug"),React.createElement("div",{className:"v font-monospace"},ee.id),React.createElement("div",{className:"k"},"Subfolder"),React.createElement("div",{className:"v"},ee.subfolderCount||0),React.createElement("div",{className:"k"},"Video"),React.createElement("div",{className:"v"},ee.videoCount||0))),ee.description&&React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-note-sticky me-2 text-secondary"}),"M\xF4 t\u1EA3"),React.createElement("p",null,ee.description))):React.createElement("div",{className:"text-muted"},"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u")),React.createElement(AdminDrawer,{open:ge,title:Gt?Gt.title:"Video",subtitle:Gt?`${Gt.youtubeId}`:"",onClose:Je,footer:Kt?React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:Je},React.createElement("i",{className:"fas fa-xmark me-2"}),"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-warning fw-semibold",onClick:()=>{Gt&&je({youtube_url:`https://www.youtube.com/watch?v=${Gt.youtubeId}`,title:Gt.title||"",thumbnail_url:Gt.thumb||"",sort_order:Gt.sortOrder||0},"drawer")}},React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u")):Gt?React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{const E=`https://www.youtube.com/watch?v=${Gt.youtubeId}`;window.KTM.clipboard.writeText(E).then(()=>{j("\u0110\xE3 copy link!","success")})}},React.createElement("i",{className:"fas fa-link me-2"}),"Copy"),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>{ye(!0)}},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>{confirm(`X\xF3a video "${Gt.title}"?`)&&(yn(Gt),Je())}},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a"))):null},Kt&&Gt?React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-pen me-2 text-warning"}),"Ch\u1EC9nh s\u1EEDa"),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ti\xEAu \u0111\u1EC1 *"),React.createElement("input",{type:"text",className:"form-control",value:Gt.title||"",onChange:E=>se({...Gt,title:E.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"YouTube ID"),React.createElement("input",{type:"text",className:"form-control",value:Gt.youtubeId||"",onChange:E=>se({...Gt,youtubeId:E.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:Gt.sortOrder||0,onChange:E=>se({...Gt,sortOrder:parseInt(E.target.value)||0})}))):Gt?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"Th\xF4ng tin"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"Ti\xEAu \u0111\u1EC1"),React.createElement("div",{className:"v"},Gt.title),React.createElement("div",{className:"k"},"YouTube ID"),React.createElement("div",{className:"v font-monospace"},Gt.youtubeId),React.createElement("div",{className:"k"},"Th\u1EE9 t\u1EF1"),React.createElement("div",{className:"v"},Gt.sortOrder||0))),Gt.thumb&&React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-image me-2 text-info"}),"Thumbnail"),React.createElement("img",{src:Gt.thumb,alt:Gt.title,className:"rounded w-100",style:{maxHeight:200,objectFit:"cover"}}))):React.createElement("div",{className:"text-muted"},"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u"))):React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},M&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>xt()},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-video me-2 text-warning"}),M?M.name:"Qu\u1EA3n l\xFD Video")),React.createElement("button",{className:"btn btn-warning",onClick:$t},React.createElement("i",{className:"fas fa-folder-plus me-2"}),"T\u1EA1o Folder")),vt.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:E=>{E.preventDefault(),xt("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),vt.map((E,ct)=>React.createElement("li",{key:E.id,className:`breadcrumb-item ${ct===vt.length-1?"active":""}`},ct===vt.length-1?E.name:React.createElement("a",{href:"#",onClick:Qt=>{Qt.preventDefault(),xt(E)},className:"text-warning"},E.name))))),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1. Click v\xE0o folder \u0111\u1EC3 v\xE0o b\xEAn trong."),V?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):F.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},M?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder video n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:$t},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o folder",M?" con":" \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"row g-3"},F.map((E,ct)=>{var Qt,Ke,un,ze;return React.createElement("div",{key:E.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-card"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Ue=>{Ue.stopPropagation(),_t(ct)},disabled:ct===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},ct+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Ue=>{Ue.stopPropagation(),x(ct)},disabled:ct===F.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"card-body text-center py-3",onClick:()=>Pe(E),style:{cursor:"pointer"}},React.createElement("i",{className:`fas fa-folder fa-3x mb-3 ${E.slug==="shorts"?"text-danger":"text-warning"}`}),React.createElement("h5",{className:"card-title"},E.name),React.createElement("p",{className:"text-muted mb-0"},E.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),E.subfolderCount," folder"),E.subfolderCount>0&&(E.videoCount>0||((Qt=E.videos)==null?void 0:Qt.length)>0)&&" \u2022 ",(E.videoCount>0||((Ke=E.videos)==null?void 0:Ke.length)>0)&&React.createElement("span",null,React.createElement("i",{className:"fas fa-video me-1"}),E.videoCount||((un=E.videos)==null?void 0:un.length)||0," videos"),E.subfolderCount===0&&!E.videoCount&&!((ze=E.videos)!=null&&ze.length)&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:Ue=>{Ue.stopPropagation(),Zt(E)}},React.createElement("i",{className:"fas fa-edit"})," S\u1EEDa"),React.createElement("button",{className:"btn btn-outline-danger",onClick:Ue=>{Ue.stopPropagation(),Se(E)}},React.createElement("i",{className:"fas fa-trash"})," X\xF3a")))))})),React.createElement(VideoFolderModal,{show:Jt,folder:Ft,onClose:()=>re(!1),onSave:Yt}))}function VideoFolderModal({show:P,folder:j,onClose:F,onSave:wt}){const[ot,J]=useState({name:"",description:"",sortOrder:0,coverImage:""}),[V,Et]=useState(!1),[Ht,Ct]=useState(!1);useEffect(()=>{J(j?{name:j.name||"",description:j.description||"",sortOrder:j.sortOrder||0,coverImage:j.coverImage||""}:{name:"",description:"",sortOrder:0,coverImage:""})},[j,P]);const Jt=async Ft=>{const Vt=Ft.target.files[0];if(Vt){Ct(!0);try{const it=await window.KTM.cloudinary.uploadImage({file:Vt,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});it.secure_url&&J(Lt=>({...Lt,coverImage:it.secure_url})),window.KTM.cache.remove(CACHE_KEY),showToast("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),setShowQuickEdit(!1),setEditingItem(null),loadAllData()}catch(it){console.error("Cloudinary upload error:",it),alert("L\u1ED7i upload \u1EA3nh: "+(it.message||it))}finally{Ct(!1)}}},re=async Ft=>{Ft.preventDefault(),Et(!0);const Vt={...ot,variants:normalizeVariants(ot.variants,ot.price),attributes:normalizeAttributes(ot.attributes)};await wt(Vt),Et(!1)};return P?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},j?"S\u1EEDa Folder":"T\u1EA1o Folder m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:F})),React.createElement("form",{onSubmit:re},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn folder *"),React.createElement("input",{type:"text",className:"form-control",value:ot.name,onChange:Ft=>J({...ot,name:Ft.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",value:ot.description,onChange:Ft=>J({...ot,description:Ft.target.value}),rows:"2"})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:ot.sortOrder,onChange:Ft=>J({...ot,sortOrder:parseInt(Ft.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex align-items-start gap-3"},ot.coverImage?React.createElement("div",{className:"position-relative"},React.createElement("img",{src:ot.coverImage,alt:"Cover",className:"rounded",style:{width:120,height:80,objectFit:"cover"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute top-0 end-0",onClick:()=>J({...ot,coverImage:""}),style:{transform:"translate(30%, -30%)"}},React.createElement("i",{className:"fas fa-times"}))):React.createElement("div",{className:"bg-light rounded d-flex align-items-center justify-content-center text-muted",style:{width:120,height:80}},React.createElement("i",{className:"fas fa-image fa-2x"})),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{type:"file",className:"form-control form-control-sm",accept:"image/*,image/jpeg,image/png,image/gif,image/webp",onChange:Jt,disabled:Ht}),Ht&&React.createElement("div",{className:"mt-1 text-muted small"},React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang upload..."),React.createElement("div",{className:"mt-1 text-muted small"},"Ho\u1EB7c d\xE1n URL:"),React.createElement("input",{type:"url",className:"form-control form-control-sm",placeholder:"https://...",value:ot.coverImage,onChange:Ft=>J({...ot,coverImage:Ft.target.value})}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:F},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:V},V?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function ProductManager({showToast:P,settings:j}){const[F,wt]=useState([]),[ot,J]=useState(!0),[V,Et]=useState(!1),[Ht,Ct]=useState(null),[Jt,re]=useState(""),[Ft,Vt]=useState(""),[it,Lt]=useState(!1),[X,pe]=useState(null),ge=normalizeShipPercent(j==null?void 0:j.ship_percent),{parseMoney:_e,formatVND:Gt}=window.KTM.money,se=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"];useEffect(()=>{Kt()},[]);const Kt=async()=>{J(!0);try{const x=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");wt(Array.isArray(x)?x:[])}catch(x){console.error(x),P("L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m","danger")}J(!1)},ye=()=>{Ct(null),Et(!0)},$e=x=>{Ct(x),Et(!0)},on=x=>{x&&(pe(x),Lt(!0))},ee=()=>{Lt(!1)},Le=async x=>{if(!(!x||!x.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:x},"L\u1ED7i x\xF3a \u1EA3nh"),window.KTM.cache.remove(CACHE_KEY),P(`\u0110\xE3 x\xF3a ${typeName}`,"success"),loadAllData(),Kt()}catch(q){P("L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m","danger")}},Be=async x=>{try{const q=Ht?`${API_BASE}/api/products?id=${Ht.id}`:`${API_BASE}/api/products`;Ht?await window.KTM.api.putJSON(q,x,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(q,x,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),P(Ht?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Et(!1),Kt()}catch(q){P(q.message,"danger")}},$=async x=>{if(confirm(`B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n x\xF3a s\u1EA3n ph\u1EA9m "${x.name}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/products?id=${x.id}`,"L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m"),P("X\xF3a s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Kt()}catch(q){P(q.message,"danger")}},M=F.filter(x=>{const q=!Jt||x.name.toLowerCase().includes(Jt.toLowerCase())||x.code&&x.code.toLowerCase().includes(Jt.toLowerCase()),Y=!Ft||x.category===Ft;return q&&Y}),z=x=>{var dt;const q=(dt=x==null?void 0:x.commission_percent)!=null?dt:x==null?void 0:x.commissionPercent,Y=q===""||q==null?NaN:Number(q);return Number.isFinite(Y)?Math.max(0,Math.min(100,Y)):5},vt=x=>{const q=z(x),Y=Number.isInteger(q)?String(q):String(Math.round(q*100)/100),dt=_e(x==null?void 0:x.price);if(!Number.isFinite(dt)||dt<=0)return`${Y}%`;const kt=(Number(q)||0)/100,Zt=window.KTM.money.parseShipFeeFromNote(x==null?void 0:x.note)!=null?0:ge>0?dt*ge/100:0,Yt=dt*kt-Zt*kt,Se=Math.max(0,Math.round(Yt));return`${Y}% - ${Gt(Se)}`},St=x=>{if(x==null||x==="")return[];let q=x;if(typeof q=="string"){const Y=q.trim();if(!Y)return[];try{q=JSON.parse(Y)}catch(dt){return[]}}return Array.isArray(q)?q:[]},ut=x=>{if(x==null||x==="")return[];let q=x;if(typeof q=="string"){const Y=q.trim();if(!Y)return[];try{q=JSON.parse(Y)}catch(dt){return[]}}return q&&typeof q=="object"&&!Array.isArray(q)&&(q=Object.entries(q).map(([Y,dt])=>({key:Y,value:dt}))),Array.isArray(q)?q:[]},ht=x=>{const q=ut(x).map(Y=>{var dt,kt,$t,Zt,Yt;return{key:String(($t=(kt=(dt=Y==null?void 0:Y.key)!=null?dt:Y==null?void 0:Y.name)!=null?kt:Y==null?void 0:Y.label)!=null?$t:"").trim(),value:String((Zt=Y==null?void 0:Y.value)!=null?Zt:"").trim(),unit:String((Yt=Y==null?void 0:Y.unit)!=null?Yt:"").trim()}}).filter(Y=>!!Y.key);return q.length?React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},q.map((Y,dt)=>{const kt=Y.key,$t=`${Y.value||""}${Y.unit?(Y.value?" ":"")+Y.unit:""}`.trim();return React.createElement("div",{key:`${kt}-${dt}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},kt),$t?React.createElement("span",{className:"ktm-chip ktm-chip-option"},$t):null)}))):null},_t=(x,q={})=>{const Y=St(x).map(Zt=>{var Yt;return{name:String((Yt=Zt==null?void 0:Zt.name)!=null?Yt:"").trim(),options:Array.isArray(Zt==null?void 0:Zt.options)?Zt.options:[]}}).map(Zt=>({...Zt,options:Zt.options.map(Yt=>{var Se;return{label:String((Se=Yt==null?void 0:Yt.label)!=null?Se:"").trim(),price:Number(Yt==null?void 0:Yt.price)}}).filter(Yt=>!!Yt.label)})).filter(Zt=>Zt.options.length>0);if(!Y.length)return null;const dt=Number.isFinite(q.maxGroups)?Math.max(1,Math.trunc(q.maxGroups)):Y.length,kt=Number.isFinite(q.maxOptionsPerGroup)?Math.max(1,Math.trunc(q.maxOptionsPerGroup)):4,$t=Y.slice(0,dt);return React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},$t.map((Zt,Yt)=>{const Se=Zt.name||"Bi\u1EBFn th\u1EC3",Pe=Zt.options.slice(0,kt),xt=Zt.options.length-Pe.length;return React.createElement("div",{key:`${Se}-${Yt}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},Se),Pe.map((ne,Je)=>{const Me=ne.price,mn=Number.isFinite(Me)&&Me>=0?Gt(Math.trunc(Me)):"",je=mn?`${ne.label} \xB7 ${mn}`:ne.label;return React.createElement("span",{key:`${Se}-${Yt}-${Je}`,className:"ktm-chip ktm-chip-option"},je)}),xt>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",xt))})))};return React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",null,React.createElement("i",{className:"fas fa-box me-2"}),"S\u1EA3n ph\u1EA9m"),React.createElement("button",{className:"btn-add-product",onClick:ye},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"d-flex gap-2 mb-2"},React.createElement("div",{className:"flex-grow-1 position-relative"},React.createElement("input",{type:"text",className:"form-control",placeholder:"\u{1F50D} T\xECm s\u1EA3n ph\u1EA9m...",value:Jt,onChange:x=>re(x.target.value)})),React.createElement("span",{className:"product-count"},M.length)),React.createElement("select",{className:"form-select",value:Ft,onChange:x=>Vt(x.target.value)},React.createElement("option",{value:""},"\u{1F4C1} T\u1EA5t c\u1EA3 danh m\u1EE5c"),se.map(x=>React.createElement("option",{key:x,value:x},x)))),ot?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"2.5rem",height:"2.5rem"}}),React.createElement("p",{className:"text-muted mt-3 mb-0"},"\u0110ang t\u1EA3i...")):M.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-box-open"}),React.createElement("p",null,"Ch\u01B0a c\xF3 s\u1EA3n ph\u1EA9m n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:ye},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"product-list"},M.map(x=>React.createElement("div",{key:x.id,className:"product-item d-flex align-items-center gap-3",role:"button",tabIndex:0,onClick:()=>on(x),onKeyDown:q=>{(q.key==="Enter"||q.key===" ")&&(q.preventDefault(),on(x))},title:"Xem chi ti\u1EBFt"},x.image?React.createElement("img",{src:x.image,alt:"",className:"product-img"}):React.createElement("div",{className:"product-img-placeholder"},React.createElement("i",{className:"fas fa-image text-muted"})),React.createElement("div",{className:"flex-grow-1 min-width-0"},React.createElement("div",{className:"product-name"},x.name),React.createElement("div",{className:"d-flex flex-wrap gap-1 mb-1"},x.category&&React.createElement("span",{className:"product-badge bg-info bg-opacity-75"},x.category),x.code&&React.createElement("span",{className:"product-badge bg-secondary"},x.code),React.createElement("span",{className:"product-badge bg-warning text-dark",title:"Hoa h\u1ED3ng (%)"},React.createElement("i",{className:"fas fa-percent me-1"}),vt(x))),React.createElement("div",{className:"product-price"},x.price?x.price.replace(/[đ\s]/g,"")+"\u0111":"Li\xEAn h\u1EC7"),x.note&&React.createElement("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"}},x.note),ht(x.attributes)&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},ht(x.attributes)),_t(x.variants,{maxOptionsPerGroup:4})&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},_t(x.variants,{maxOptionsPerGroup:4}))),React.createElement("div",{className:"product-actions"},React.createElement("button",{className:"btn btn-edit",onClick:q=>{q.stopPropagation(),$e(x)},title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"btn btn-delete",onClick:q=>{q.stopPropagation(),$(x)},title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement(AdminDrawer,{open:it,title:String((X==null?void 0:X.name)||"S\u1EA3n ph\u1EA9m"),subtitle:[String((X==null?void 0:X.code)||"").trim()||null,String((X==null?void 0:X.category)||"").trim()||null].filter(Boolean).join(" \u2022 "),onClose:ee,footer:React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{const x=String((X==null?void 0:X.code)||"").trim();x&&window.KTM.clipboard.writeText(x).then(()=>P("\u0110\xE3 copy m\xE3 s\u1EA3n ph\u1EA9m","success"))},disabled:!String((X==null?void 0:X.code)||"").trim(),title:"Copy m\xE3"},React.createElement("i",{className:"fas fa-barcode me-2"}),"Copy m\xE3"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{const x=String((X==null?void 0:X.price)||"").trim();x&&window.KTM.clipboard.writeText(x).then(()=>P("\u0110\xE3 copy gi\xE1","success"))},disabled:!String((X==null?void 0:X.price)||"").trim(),title:"Copy gi\xE1"},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy gi\xE1")),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>X&&$e(X),disabled:!X},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>X&&$(X),disabled:!X},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a")))},X?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"T\u1ED5ng quan"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"Gi\xE1"),React.createElement("div",{className:"v"},(()=>{const x=String((X==null?void 0:X.price)||"").trim(),q=_e(x);return Number.isFinite(q)&&q>0?Gt(Math.trunc(q)):x||"Li\xEAn h\u1EC7"})()),React.createElement("div",{className:"k"},"Hoa h\u1ED3ng"),React.createElement("div",{className:"v"},vt(X)),React.createElement("div",{className:"k"},"Danh m\u1EE5c"),React.createElement("div",{className:"v"},X.category||"\u2014"),React.createElement("div",{className:"k"},"M\xE3"),React.createElement("div",{className:"v"},React.createElement("span",{className:"font-monospace"},X.code||"\u2014")))),React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-image me-2 text-info"}),"H\xECnh \u1EA3nh"),X.image?React.createElement("img",{src:X.image,alt:"",className:"rounded",style:{width:"100%",maxHeight:260,objectFit:"cover"}}):React.createElement("div",{className:"text-muted"},"Ch\u01B0a c\xF3 \u1EA3nh")),(String(X.note||"").trim()||X.attributes||X.variants)&&React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-sliders-h me-2 text-primary"}),"Chi ti\u1EBFt"),String(X.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",String(X.note||"").trim()),ht(X.attributes)?React.createElement("div",{className:"mt-2"},ht(X.attributes)):null,_t(X.variants,{maxGroups:99,maxOptionsPerGroup:8})?React.createElement("div",{className:"mt-2"},_t(X.variants,{maxGroups:99,maxOptionsPerGroup:8})):null)):React.createElement("div",{className:"text-muted"},"Ch\u01B0a c\xF3 d\u1EEF li\u1EC7u")),React.createElement(ProductModal,{show:V,product:Ht,categories:se,onClose:()=>Et(!1),onSave:Be}))}function ProductModal({show:P,product:j,categories:F,onClose:wt,onSave:ot}){const[J,V]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[Et,Ht]=useState(!1),[Ct,Jt]=useState(!1),re=$=>{const M=window.KTM.money.getDigits(String($!=null?$:"")),z=Number(M);return M&&Number.isFinite(z)?Math.trunc(z):0},Ft=$=>{if($==null||$==="")return[];let M=$;if(typeof M=="string"){const z=M.trim();if(!z)return[];try{M=JSON.parse(z)}catch(vt){return[]}}return M&&typeof M=="object"&&!Array.isArray(M)&&(M=Object.entries(M).map(([z,vt])=>({key:z,value:vt}))),Array.isArray(M)?M.map(z=>{var ht,_t,x,q,Y;if(!z||typeof z!="object")return null;const vt=String((x=(_t=(ht=z.key)!=null?ht:z.name)!=null?_t:z.label)!=null?x:"").trim(),St=String((q=z.value)!=null?q:"").trim(),ut=String((Y=z.unit)!=null?Y:"").trim();return vt?{key:vt,value:St,unit:ut}:null}).filter(Boolean):[]},Vt=($,M)=>{if($==null||$==="")return[];let z=$;if(typeof z=="string"){const St=z.trim();if(!St)return[];try{z=JSON.parse(St)}catch(ut){return[]}}if(!Array.isArray(z))return[];const vt=re(M);return z.map(St=>{var _t;if(!St||typeof St!="object")return null;const ut=String((_t=St.name)!=null?_t:"").trim(),ht=(Array.isArray(St.options)?St.options:[]).map(x=>{var Zt,Yt,Se,Pe,xt,ne,Je;if(!x||typeof x!="object")return null;const q=String((Zt=x.label)!=null?Zt:"").trim();if(!q)return null;const Y=(xt=(Pe=(Se=(Yt=x.price)!=null?Yt:x.priceValue)!=null?Se:x.unit_price)!=null?Pe:x.unitPrice)!=null?xt:null,dt=Number(Y);let kt=Number.isFinite(dt)?Math.trunc(dt):null;if(kt==null){const Me=(Je=(ne=x.price_delta)!=null?ne:x.priceDelta)!=null?Je:null,mn=Number(Me);Number.isFinite(mn)&&(kt=vt+Math.trunc(mn))}kt==null&&(kt=vt);const $t=String(Math.max(0,Math.trunc(Number(kt)||0)));return{label:q,price:Math.max(0,Math.trunc(Number(kt)||0)),priceDigits:$t}}).filter(Boolean);return{name:ut||"Bi\u1EBFn th\u1EC3",options:ht}}).filter(Boolean)};useEffect(()=>{var $,M;V(j?{name:j.name||"",code:j.code||"",price:j.price||"",image:j.image||"",category:j.category||"",note:j.note||"",sort_order:j.sort_order||0,commission_percent:(M=($=j.commission_percent)!=null?$:j.commissionPercent)!=null?M:5,variants:Vt(j.variants,j.price),attributes:Ft(j.attributes)}:{name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]})},[j,P]);const it=$=>{V(M=>{var ht;const z=re(M.price),vt=String(z),St=Array.isArray(M.variants)?[...M.variants]:[],ut={...St[$]||{},options:Array.isArray((ht=St[$])==null?void 0:ht.options)?[...St[$].options]:[]};return ut.options=ut.options.map(_t=>({label:String((_t==null?void 0:_t.label)||""),price:z,priceDigits:vt})),St[$]=ut,{...M,variants:St}})},Lt=()=>{V($=>{const M=re($.price),z=String(M),St=(Array.isArray($.variants)?[...$.variants]:[]).map(ut=>{const ht=(Array.isArray(ut==null?void 0:ut.options)?ut.options:[]).map(_t=>({label:String((_t==null?void 0:_t.label)||""),price:M,priceDigits:z}));return{name:String((ut==null?void 0:ut.name)||"Bi\u1EBFn th\u1EC3"),options:ht}});return{...$,variants:St}})},[X,pe]=React.useState(""),ge=$=>window.KTM.money.formatVNDInputDigits($),[_e,Gt]=React.useState(""),se=$=>{const M=window.KTM.money.nextPriceInputState($.target.value,_e);Gt(M.digits),V({...J,price:M.price})},[Kt,ye]=React.useState("");React.useEffect(()=>{j!=null&&j.image&&ye(j.image)},[j]);const $e=async $=>{if(!(!$||!$.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:$},"L\u1ED7i x\xF3a \u1EA3nh")}catch(M){console.error("Delete cloudinary image error:",M)}},on=async($,M=2,z)=>{const vt=M*1024*1024,St=$.type==="image/heic"||$.type==="image/heif"||/\.heic$/i.test($.name);if($.size<=vt&&!St)return $;z==null||z("\u0110ang x\u1EED l\xFD \u1EA3nh...");try{const ut=await createImageBitmap($);z==null||z("\u0110ang n\xE9n \u1EA3nh...");const ht=document.createElement("canvas");let _t=ut.width,x=ut.height;const q=1200;return(_t>q||x>q)&&(_t>x?(x=Math.round(x/_t*q),_t=q):(_t=Math.round(_t/x*q),x=q)),ht.width=_t,ht.height=x,ht.getContext("2d").drawImage(ut,0,0,_t,x),ut.close(),new Promise((dt,kt)=>{ht.toBlob($t=>{$t?(z==null||z("Ho\xE0n t\u1EA5t!"),dt(new File([$t],$.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"}))):kt(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(ut){throw console.error("createImageBitmap error:",ut),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},ee=async $=>{var vt,St;const M=(vt=$.target.files)==null?void 0:vt[0];if(!M)return;if(!(M.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(M.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}Jt(!0),pe("\u0110ang chu\u1EA9n b\u1ECB...");try{const ut=(M.size/1024/1024).toFixed(1);pe(`File ${ut}MB - \u0110ang n\xE9n...`);const ht=await on(M,2,q=>{pe(q)}),_t=(ht.size/1024/1024).toFixed(1);pe(`\u0110\xE3 n\xE9n: ${_t}MB - \u0110ang upload...`);const x=await window.KTM.cloudinary.uploadImage({file:ht,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});x.secure_url?(J.image&&J.image!==Kt&&$e(J.image),V(q=>({...q,image:x.secure_url})),pe("")):(console.error("Cloudinary error:",x),alert("Upload th\u1EA5t b\u1EA1i: "+(((St=x.error)==null?void 0:St.message)||"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh")),pe(""))}catch(ut){console.error("Upload error:",ut),alert("L\u1ED7i: "+ut.message),pe("")}Jt(!1),$.target.value=""},Le=()=>{J.image&&(J.image!==Kt&&$e(J.image),V($=>({...$,image:""})))},Be=async $=>{$.preventDefault(),Ht(!0),Kt&&J.image&&Kt!==J.image&&await $e(Kt),Kt&&!J.image&&await $e(Kt),await ot(J),Ht(!1)};return P?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down"},React.createElement("div",{className:"modal-content",style:{borderRadius:"16px",overflow:"hidden"}},React.createElement("div",{className:"modal-header border-0 py-3",style:{background:"linear-gradient(135deg, #ffc107 0%, #ffca2c 100%)"}},React.createElement("h6",{className:"modal-title fw-bold",style:{color:"#1a1a2e"}},React.createElement("i",{className:`fas ${j?"fa-edit":"fa-plus-circle"} me-2`}),j?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:wt})),React.createElement("form",{onSubmit:Be},React.createElement("div",{className:"modal-body py-4",style:{maxHeight:"65vh",overflowY:"auto",background:"#f8f9fa"}},React.createElement("div",{className:"text-center mb-4"},React.createElement("div",{className:"position-relative d-inline-block"},J.image?React.createElement(React.Fragment,null,React.createElement("img",{src:J.image,alt:"",style:{width:110,height:110,objectFit:"cover",borderRadius:"12px",boxShadow:"0 4px 15px rgba(0,0,0,0.15)"}}),React.createElement("button",{type:"button",className:"btn btn-danger position-absolute",onClick:Le,style:{top:-10,right:-10,width:28,height:28,padding:0,borderRadius:"50%",boxShadow:"0 2px 8px rgba(220,53,69,0.4)"}},React.createElement("i",{className:"fas fa-times",style:{fontSize:"0.75rem"}}))):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:110,height:110,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd"}},React.createElement("i",{className:"fas fa-image fa-2x text-muted"}))),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"btn btn-warning btn-sm px-3",style:{borderRadius:"20px"}},React.createElement("i",{className:`fas ${Ct?"fa-spinner fa-spin":"fa-camera"} me-1`}),Ct?X||"\u0110ang x\u1EED l\xFD...":"Ch\u1ECDn \u1EA3nh",React.createElement("input",{type:"file",accept:"image/*",onChange:ee,disabled:Ct,style:{position:"absolute",left:"-9999px",opacity:0,width:1,height:1}})),Ct&&X&&React.createElement("div",{className:"text-center mt-1",style:{fontSize:11,color:"#6c757d"}},X))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-tag me-1 text-warning"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:J.name,onChange:$=>V({...J,name:$.target.value}),required:!0,placeholder:"VD: Combo Van 3 tay + 2 xylanh",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-barcode me-1 text-info"}),"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:J.code,onChange:$=>V({...J,code:$.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1 text-success"}),"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:J.price,onChange:se,placeholder:"1.950.000\u0111",inputMode:"numeric",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-percent me-1 text-secondary"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:J.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:$=>V({...J,commission_percent:$.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-folder me-1 text-primary"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:J.category,onChange:$=>V({...J,category:$.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),F.map($=>React.createElement("option",{key:$,value:$},$)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1 text-secondary"}),"Ghi ch\xFA"),React.createElement("input",{type:"text",className:"form-control",value:J.note,onChange:$=>V({...J,note:$.target.value}),placeholder:"VD: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1 text-secondary"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(J.attributes)?J.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(J.attributes)?J.attributes:[]).map(($,M)=>React.createElement("div",{key:M,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:($==null?void 0:$.key)||"",onChange:z=>{const vt=z.target.value;V(St=>{const ut=Array.isArray(St.attributes)?[...St.attributes]:[];return ut[M]={...ut[M]||{},key:vt},{...St,attributes:ut}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:($==null?void 0:$.value)||"",onChange:z=>{const vt=z.target.value;V(St=>{const ut=Array.isArray(St.attributes)?[...St.attributes]:[];return ut[M]={...ut[M]||{},value:vt},{...St,attributes:ut}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:($==null?void 0:$.unit)||"",onChange:z=>{const vt=z.target.value;V(St=>{const ut=Array.isArray(St.attributes)?[...St.attributes]:[];return ut[M]={...ut[M]||{},unit:vt},{...St,attributes:ut}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{V(z=>{const vt=Array.isArray(z.attributes)?[...z.attributes]:[];return vt.splice(M,1),{...z,attributes:vt}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{V($=>{const M=Array.isArray($.attributes)?[...$.attributes]:[];return M.push({key:"",value:"",unit:""}),{...$,attributes:M}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1 text-secondary"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(J.variants)?J.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3."):null,(Array.isArray(J.variants)?J.variants:[]).map(($,M)=>React.createElement("div",{key:M,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:($==null?void 0:$.name)||"",onChange:z=>{const vt=z.target.value;V(St=>{var ht;const ut=Array.isArray(St.variants)?[...St.variants]:[];return ut[M]={...ut[M]||{},name:vt,options:Array.isArray((ht=ut[M])==null?void 0:ht.options)?ut[M].options:[]},{...St,variants:ut}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>it(M),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray($==null?void 0:$.options)||$.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{V(z=>{const vt=Array.isArray(z.variants)?[...z.variants]:[];return vt.splice(M,1),{...z,variants:vt}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray($==null?void 0:$.options)?$.options:[]).map((z,vt)=>{var St,ut;return React.createElement("div",{key:vt,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(z==null?void 0:z.label)||"",onChange:ht=>{const _t=ht.target.value;V(x=>{var $t,Zt,Yt,Se,Pe;const q=Array.isArray(x.variants)?[...x.variants]:[],Y={...q[M]||{},options:Array.isArray(($t=q[M])==null?void 0:$t.options)?[...q[M].options]:[]},dt=Number((Yt=(Zt=Y.options[vt])==null?void 0:Zt.price)!=null?Yt:0)||0,kt=String((Pe=(Se=Y.options[vt])==null?void 0:Se.priceDigits)!=null?Pe:Math.max(0,Math.trunc(dt)));return Y.options[vt]={...Y.options[vt]||{},label:_t,price:Math.max(0,Math.trunc(dt)),priceDigits:kt},q[M]=Y,{...x,variants:q}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:ge(String((ut=z==null?void 0:z.priceDigits)!=null?ut:window.KTM.money.getDigits(String((St=z==null?void 0:z.price)!=null?St:"")))),onChange:ht=>{V(_t=>{var Yt,Se,Pe,xt,ne;const x=String((Se=z==null?void 0:z.priceDigits)!=null?Se:window.KTM.money.getDigits(String((Yt=z==null?void 0:z.price)!=null?Yt:""))),q=window.KTM.money.nextPriceInputState(ht.target.value,x),Y=String((Pe=q.digits)!=null?Pe:""),dt=Number(Y),kt=Number.isFinite(dt)?Math.max(0,Math.trunc(dt)):0,$t=Array.isArray(_t.variants)?[..._t.variants]:[],Zt={...$t[M]||{},options:Array.isArray((xt=$t[M])==null?void 0:xt.options)?[...$t[M].options]:[]};return Zt.options[vt]={...Zt.options[vt]||{},label:String(((ne=Zt.options[vt])==null?void 0:ne.label)||""),price:kt,priceDigits:Y},$t[M]=Zt,{..._t,variants:$t}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{V(ht=>{var q;const _t=Array.isArray(ht.variants)?[...ht.variants]:[],x={..._t[M]||{},options:Array.isArray((q=_t[M])==null?void 0:q.options)?[..._t[M].options]:[]};return x.options.splice(vt,1),_t[M]=x,{...ht,variants:_t}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{V(z=>{var ht;const vt=Array.isArray(z.variants)?[...z.variants]:[],St={...vt[M]||{},options:Array.isArray((ht=vt[M])==null?void 0:ht.options)?[...vt[M].options]:[]},ut=re(z.price);return St.options.push({label:"",price:ut,priceDigits:String(ut)}),vt[M]=St,{...z,variants:vt}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{V($=>{const M=re($.price),z=Array.isArray($.variants)?[...$.variants]:[],vt=String(M);return z.push({name:"Size",options:[{label:"S",price:M,priceDigits:vt},{label:"M",price:M,priceDigits:vt},{label:"L",price:M,priceDigits:vt}]}),{...$,variants:z}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:Lt,disabled:!Array.isArray(J.variants)||J.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111."))),React.createElement("div",{className:"mb-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"URL \u1EA3nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",placeholder:"https://...",value:J.image,onChange:$=>V({...J,image:$.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"10px",fontSize:"0.9rem"}}))),React.createElement("div",{className:"modal-footer border-0 py-3",style:{background:"#fff"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:wt,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:Et,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},Et?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}function VideoModal({show:P,video:j,onClose:F,onSave:wt}){const[ot,J]=useState({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),[V,Et]=useState(!1),[Ht,Ct]=useState("");useEffect(()=>{j?(J({title:j.title||"",youtube_url:`https://www.youtube.com/watch?v=${j.youtubeId}`,thumbnail_url:j.thumb||"",sort_order:j.sortOrder||0}),Ct(j.thumb)):(J({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),Ct(""))},[j,P]);const Jt=Vt=>{const it=Vt.match(/(?:youtube\.com\/(?:embed\/|watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return it?it[1]:null},re=Vt=>{J({...ot,youtube_url:Vt});const it=Jt(Vt);it&&Ct(`https://img.youtube.com/vi/${it}/hqdefault.jpg`)},Ft=async Vt=>{Vt.preventDefault(),Et(!0),await wt(ot),Et(!1)};return P?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},j?"S\u1EEDa Video":"Th\xEAm Video m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:F})),React.createElement("form",{onSubmit:Ft},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Link YouTube *"),React.createElement("input",{type:"url",className:"form-control",value:ot.youtube_url,onChange:Vt=>re(Vt.target.value),placeholder:"https://www.youtube.com/watch?v=... ho\u1EB7c shorts/...",required:!0}),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3: youtube.com/watch, youtu.be, youtube.com/shorts")),Ht&&React.createElement("div",{className:"mb-3 text-center"},React.createElement("img",{src:Ht,alt:"Preview",className:"img-fluid rounded",style:{maxHeight:"150px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ti\xEAu \u0111\u1EC1 *"),React.createElement("input",{type:"text",className:"form-control",value:ot.title,onChange:Vt=>J({...ot,title:Vt.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:ot.sort_order,onChange:Vt=>J({...ot,sort_order:parseInt(Vt.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Thumbnail t\xF9y ch\u1EC9nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",value:ot.thumbnail_url,onChange:Vt=>J({...ot,thumbnail_url:Vt.target.value}),placeholder:"\u0110\u1EC3 tr\u1ED1ng s\u1EBD d\xF9ng thumbnail m\u1EB7c \u0111\u1ECBnh c\u1EE7a YouTube"}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:F},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:V},V?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function getCurrentMonth(){const P=new Date,j=P.getFullYear(),F=String(P.getMonth()+1).padStart(2,"0");return`${j}-${F}`}function ReconExcelManager({showToast:P}){var me;const j=typeof P=="function"?P:()=>{},[F,wt]=useState(getCurrentMonth()),ot=F,J=wt,[V,Et]=useState(!1),[Ht,Ct]=useState(""),[Jt,re]=useState(""),[Ft,Vt]=useState(""),[it,Lt]=useState(null),[X,pe]=useState("matches"),[ge,_e]=useState(""),[Gt,se]=useState(!0),[Kt,ye]=useState(!0),[$e,on]=useState(!1),[ee,Le]=useState("created_at"),[Be,$]=useState(!1),[M,z]=useState(0),[vt,St]=useState(!1),[ut,ht]=useState(""),[_t,x]=useState(()=>new Set),[q,Y]=useState(!1),[dt,kt]=useState(null),$t=useRef(new Map),Zt=useRef(new Map),Yt=useRef(null),[Se,Pe]=useState(()=>{var r;return(r=window==null?void 0:window.XLSX)!=null&&r.read?"ready":"loading"}),xt=r=>new Promise((l,C)=>{var h;try{if(!r)return l();const f=String(r),L=document.querySelector(`script[data-ktm-src="${f}"]`)||document.querySelector(`script[src="${f}"]`);if(L){if(L.getAttribute("data-ktm-loaded")==="1"||(h=window==null?void 0:window.XLSX)!=null&&h.read)return l();L.addEventListener("load",()=>l(),{once:!0}),L.addEventListener("error",()=>C(new Error(`Failed to load ${f}`)),{once:!0});return}const K=document.createElement("script");K.src=f,K.async=!0,K.defer=!0,K.setAttribute("data-ktm-src",f),K.addEventListener("load",()=>{K.setAttribute("data-ktm-loaded","1"),l()},{once:!0}),K.addEventListener("error",()=>C(new Error(`Failed to load ${f}`)),{once:!0}),document.head.appendChild(K)}catch(f){C(f)}}),ne=()=>!!(window!=null&&window.XLSX&&typeof window.XLSX.read=="function"),Je=async()=>{if(ne())return Pe("ready"),!0;if(Yt.current)return Yt.current;const r=["https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js","https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js","https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"],l=async C=>{const h=Date.now();for(;Date.now()-h<C;){if(ne())return!0;await new Promise(f=>setTimeout(f,50))}return ne()};return Pe("loading"),Yt.current=(async()=>{try{for(const C of r)try{if(await xt(C),await l(1500))return Pe("ready"),!0}catch(h){}return Pe("failed"),!1}finally{Yt.current=null}})(),Yt.current};useEffect(()=>{if(ne()){Pe("ready");return}Je()},[]);const Me=r=>{const l=[],C=String(r!=null?r:"").split(/\s+/g);for(const h of C){const f=String(h||"").trim();f&&l.push(f)}return l.join(" ").replace(/\s+/g," ").trim()},mn=r=>{try{return String(r!=null?r:"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,l=>l==="\u0111"?"d":"D")}catch(l){return String(r!=null?r:"").replace(/[đĐ]/g,C=>C==="\u0111"?"d":"D")}},je=r=>{const l=Me(String(r!=null?r:""));return l?mn(l).toLowerCase().replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim():""},yn=r=>{const l=je(r);return l?l.replace(/\b(combo|set|sp|san\s*pham|sanpham|hang|ship|freeship|free\s*ship)\b/g," ").replace(/\s+/g," ").trim():""},vn=r=>{var L,K;if(r==null||r==="")return"";if(typeof r=="number"&&Number.isFinite(r)&&((K=(L=window==null?void 0:window.XLSX)==null?void 0:L.SSF)!=null&&K.parse_date_code))try{const b=window.XLSX.SSF.parse_date_code(r);return!b||!b.y||!b.m?"":`${String(b.y).padStart(4,"0")}-${String(b.m).padStart(2,"0")}`}catch(b){}const l=String(r).trim(),C=l.match(/^(\d{1,2})[\.\/\-](\d{1,2})[\.\/\-](\d{4})$/);if(C){const b=String(Number(C[2])||0).padStart(2,"0");return`${C[3]}-${b}`}const h=l.match(/^(\d{4})-(\d{2})-(\d{2})/);if(h)return`${h[1]}-${h[2]}`;const f=new Date(l);return Number.isNaN(f.getTime())?"":`${f.getFullYear()}-${String(f.getMonth()+1).padStart(2,"0")}`},E=r=>{var L,K;if(r==null||r==="")return"";if(typeof r=="number"&&Number.isFinite(r)&&((K=(L=window==null?void 0:window.XLSX)==null?void 0:L.SSF)!=null&&K.parse_date_code))try{const b=window.XLSX.SSF.parse_date_code(r);return!b||!b.y||!b.m||!b.d?"":`${String(b.y).padStart(4,"0")}-${String(b.m).padStart(2,"0")}-${String(b.d).padStart(2,"0")}`}catch(b){}const l=String(r).trim(),C=l.match(/^(\d{1,2})[\.\/\-](\d{1,2})[\.\/\-](\d{4})$/);if(C){const b=String(Number(C[1])||0).padStart(2,"0"),A=String(Number(C[2])||0).padStart(2,"0");return`${C[3]}-${A}-${b}`}const h=l.match(/^(\d{4})-(\d{2})-(\d{2})/);if(h)return`${h[1]}-${h[2]}-${h[3]}`;const f=new Date(l);return Number.isNaN(f.getTime())?"":`${f.getFullYear()}-${String(f.getMonth()+1).padStart(2,"0")}-${String(f.getDate()).padStart(2,"0")}`},ct=r=>{if(r==null||r==="")return 0;if(typeof r=="number"&&Number.isFinite(r))return Math.trunc(r);const l=String(r!=null?r:"").trim();if(!l)return 0;try{const L=window.KTM.money.parseMoney(l);if(Number.isFinite(L)&&L>0)return Math.trunc(L)}catch(L){}const h=l.toLowerCase().replace(/vnd|đ|d/g," ").replace(/\s+/g," ").trim().replace(/[^0-9]/g,"");if(!h)return 0;const f=Number(h);return Number.isFinite(f)?Math.trunc(f):0},Qt=r=>{var C,h;let l="";try{(h=(C=window==null?void 0:window.KTM)==null?void 0:C.phone)!=null&&h.normalize&&(l=window.KTM.phone.normalize(r))}catch(f){}return l||(l=String(r!=null?r:"").replace(/[^0-9]/g,"")),l=String(l||"").replace(/[^0-9]/g,""),l?(l.startsWith("840")?l=`0${l.slice(3)}`:l.startsWith("84")&&(l.length===11?l=`0${l.slice(2)}`:l.length===12&&l[2]!=="0"&&(l=`0${l.slice(2)}`)),l.length===9&&(l=`0${l}`),l):""},Ke=(r,l)=>{try{const C=Array.isArray(l)?l:[],h=A=>{const D=String(A!=null?A:"");return/[\n\r",]/.test(D)?`"${D.replace(/"/g,'""')}"`:D},f=C.map(A=>Array.isArray(A)?A.map(h).join(","):"").join(`
`),L=new Blob([`\uFEFF${f}`],{type:"text/csv;charset=utf-8"}),K=URL.createObjectURL(L),b=document.createElement("a");b.href=K,b.download=r,document.body.appendChild(b),b.click(),setTimeout(()=>{try{URL.revokeObjectURL(K)}catch(A){}try{b.remove()}catch(A){}},0)}catch(C){}},un=r=>{const l=String(r!=null?r:"");if(!l.trim())return{phone:"",phoneNorm:"",cleanedText:String(r!=null?r:"").trim()};const C=/(?:\+?84|0)\s*[0-9\s\-.()]{8,16}/g;let h=null,f;for(;(f=C.exec(l))!=null;){const A=f[0],D=Qt(A);D&&(D.length<9||D.length>12||(h={raw:A,digits:D}))}if(!h){const A=Qt(l);if(A.length>=9){const D=A.slice(-12);D.length>=9&&(h={raw:D,digits:D})}}if(!h)return{phone:"",phoneNorm:"",cleanedText:l.trim()};const L=h.digits,K=L;let b=l;return h.raw&&l.includes(h.raw)?b=b.replace(h.raw," "):b=b.replace(new RegExp(`${h.digits}$`)," "),b=b.replace(/[\-–—•|]+\s*$/g," ").replace(/\s+[\-–—•|]+\s*/g," ").replace(/\s+/g," ").trim(),{phone:K,phoneNorm:L,cleanedText:b}},ze=async()=>{var l;const r=$t.current;if(r&&r.size>0)return r;try{const C=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m"),h=Array.isArray(C==null?void 0:C.products)?C.products:Array.isArray(C)?C:[],f=new Map;for(const L of h){const K=String((l=L==null?void 0:L.id)!=null?l:"").trim();K&&f.set(K,L)}return $t.current=f,f}catch(C){return $t.current=new Map,$t.current}},Ue=r=>{var C;const l=String(r!=null?r:"").trim();return l&&((C=$t.current)==null?void 0:C.get(l))||null},H=async r=>{var A,D,W;if(!r)throw new Error("Ch\u01B0a ch\u1ECDn file");const l=await r.arrayBuffer(),C=Number(r.size||0)||0;if(!!!(window!=null&&window.Worker&&typeof Blob!="undefined"&&typeof URL!="undefined")||C<450*1024){if(!((A=window==null?void 0:window.XLSX)!=null&&A.read))try{await Je()}catch(Dt){}if(!((D=window==null?void 0:window.XLSX)!=null&&D.read))throw new Error("Thi\u1EBFu th\u01B0 vi\u1EC7n \u0111\u1ECDc Excel (XLSX). Vui l\xF2ng t\u1EA3i l\u1EA1i trang admin.");const st=window.XLSX.read(l,{type:"array"}),Nt=(W=st==null?void 0:st.SheetNames)==null?void 0:W[0],rt=Nt?st.Sheets[Nt]:null;if(!rt)throw new Error("Kh\xF4ng \u0111\u1ECDc \u0111\u01B0\u1EE3c sheet trong file");return window.XLSX.utils.sheet_to_json(rt,{header:1,raw:!0,defval:""})}const f=`
					const sources = [
						'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
						'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
						'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js',
					];

					const hasXlsx = () => Boolean(self.XLSX && typeof self.XLSX.read === 'function');
					const ensureXlsx = async () => {
						if (hasXlsx()) return true;
						for (const src of sources) {
							try {
								self.importScripts(src);
								if (hasXlsx()) return true;
							} catch (e) {
								// try next
							}
						}
						return hasXlsx();
					};

					self.onmessage = async (ev) => {
						try {
							const data = ev && ev.data;
							const buf = data && data.buf;
							const ok = await ensureXlsx();
							if (!ok) throw new Error('XLSX not available');
							const wb = self.XLSX.read(buf, { type: 'array' });
							const sheetName = wb && wb.SheetNames && wb.SheetNames[0];
							const ws = sheetName ? wb.Sheets[sheetName] : null;
							if (!ws) throw new Error('No sheet');
							const grid = self.XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: '' });
							self.postMessage({ ok: true, grid });
						} catch (e) {
							self.postMessage({ ok: false, error: String((e && e.message) || e || 'worker error') });
						}
					};
				`,L=new Blob([f],{type:"application/javascript"}),K=URL.createObjectURL(L),b=new Worker(K);try{return await new Promise((Nt,rt)=>{const Dt=setTimeout(()=>{try{b.terminate()}catch(It){}rt(new Error("Worker timeout"))},12e3);b.onmessage=It=>{const Wt=It&&It.data;Wt&&Wt.ok?(clearTimeout(Dt),Nt(Wt.grid)):Wt&&Wt.ok===!1&&(clearTimeout(Dt),rt(new Error(Wt.error||"Worker failed")))},b.onerror=()=>{clearTimeout(Dt),rt(new Error("Worker error"))};try{b.postMessage({buf:l},[l])}catch(It){b.postMessage({buf:l})}})}finally{try{b.terminate()}catch(st){}try{URL.revokeObjectURL(K)}catch(st){}}},p=async r=>{var D,W;if(!r)throw new Error("Ch\u01B0a ch\u1ECDn file");const l=await H(r),C=Array.isArray(l)?l:[];if(!C.length)throw new Error("File r\u1ED7ng");const h={product:["ten san pham","tensanpham","san pham","t\xEAn s\u1EA3n ph\u1EA9m"],cod:["tong tien thu ho","t\u1ED5ng ti\u1EC1n thu h\u1ED9","thu ho","thu h\u1ED9","tong thu ho","t\u1ED5ng thu h\u1ED9"],date:["ngay","ng\xE0y","date"],phone:["sdt","s\u0111t","so dien thoai","s\u1ED1 \u0111i\u1EC7n tho\u1EA1i","dien thoai","\u0111i\u1EC7n tho\u1EA1i","phone"],qty:["sl","so luong","s\u1ED1 l\u01B0\u1EE3ng","qty","quantity"]},L=(()=>{const st=Math.min(30,C.length);for(let Nt=0;Nt<st;Nt++){const Dt=(Array.isArray(C[Nt])?C[Nt]:[]).map(ue=>je(ue)),It=ue=>{for(let pt=0;pt<Dt.length;pt++){const zt=Dt[pt];if(zt&&ue.some(De=>zt.includes(je(De))))return pt}return-1},Wt=It(h.product),At=It(h.cod);if(At>=0){const ue=It(h.date),pt=It(h.phone),zt=It(h.qty);return{headerRow:Nt,productCol:Wt,codCol:At,dateCol:ue,phoneCol:pt,qtyCol:zt}}}return null})();if(!L)throw new Error('Kh\xF4ng t\xECm th\u1EA5y header c\u1ED9t "T\u1ED5ng ti\u1EC1n thu h\u1ED9"');const K=[],b=new Set,A=st=>{const Nt=String(st!=null?st:"").trim();if(!Nt)return{text:"",qty:null};let rt=Nt.match(/^\s*x\s*(\d{1,3})\s+(.+)$/i);return rt?{text:String(rt[2]||"").trim(),qty:Number(rt[1])}:(rt=Nt.match(/^\s*(\d{1,3})\s*(?:x|\*|×)?\s+(.+)$/i),rt?{text:String(rt[2]||"").trim(),qty:Number(rt[1])}:{text:Nt,qty:null})};for(let st=L.headerRow+1;st<C.length;st++){const Nt=Array.isArray(C[st])?C[st]:[],rt=L.productCol>=0?String((D=Nt[L.productCol])!=null?D:"").trim():"",Dt=A(rt),It=Dt.text,Wt=ct(Nt[L.codCol]),At=L.qtyCol>=0?Nt[L.qtyCol]:"",ue=(()=>{if(At!=null&&At!==""){if(typeof At=="number"&&Number.isFinite(At))return{qty:Math.max(1,Math.trunc(At)),source:"cell"};const Qe=String(At).trim(),Ie=Number(Qe.replace(/[^0-9]/g,""));if(Number.isFinite(Ie)&&Ie>0)return{qty:Math.max(1,Math.trunc(Ie)),source:"cell"}}const Ee=Number(Dt.qty);return Number.isFinite(Ee)&&Ee>1?{qty:Math.max(1,Math.trunc(Ee)),source:"text"}:{qty:1,source:"default"}})(),pt=ue.qty,zt=ue.source,De=zt==="cell"&&pt>1&&Wt>0&&pt<=50?Wt*pt:0,ke=Array.from(new Set([Wt,De].filter(Ee=>Number(Ee||0)>0))),ve=Wt;if(!It&&!ve)continue;const Bt=L.phoneCol>=0?String((W=Nt[L.phoneCol])!=null?W:"").trim():"",O=Qt(Bt);let mt=un(It);if(O&&(mt={...mt,phone:O,phoneNorm:O}),!mt.phoneNorm){const Ee=Nt.map(Ie=>String(Ie!=null?Ie:"")).join(" | "),Qe=un(Ee);Qe.phoneNorm&&(mt={...mt,phone:Qe.phone,phoneNorm:Qe.phoneNorm})}const Xt=mt.cleanedText||It||"",fe=je(Xt);if(fe&&(fe.includes("tong tien")||fe.includes("tong")||fe.includes("thanh toan")||fe.includes("thanh to\xE1n")))continue;const Ce=L.dateCol>=0?Nt[L.dateCol]:"",Ye=Ce?vn(Ce):"";Ye&&b.add(Ye);const Ne=Ce?E(Ce):"";K.push({rowIndex:st+1,dateRaw:Ce,monthKey:Ye,dayKey:Ne,product:Xt,productNorm:yn(Xt),productCompact:yn(Xt).replace(/\s+/g,""),phone:mt.phone,phoneNorm:mt.phoneNorm,cod:ve,codRaw:Wt,qty:pt,qtySource:zt,codAlt:De,codCandidates:ke})}return{rows:K,monthKeys:Array.from(b.values()).sort()}},G=r=>{const l=new Map,C=(b,A)=>{const D=l.get(b)||{key:b,rows:[],phoneNorm:"",phone:"",monthKey:"",dayKey:""};D.rows.push(A),!D.phoneNorm&&A.phoneNorm&&(D.phoneNorm=A.phoneNorm,D.phone=A.phone||A.phoneNorm),!D.monthKey&&A.monthKey&&(D.monthKey=A.monthKey),!D.dayKey&&A.dayKey&&(D.dayKey=A.dayKey),l.set(b,D)};for(const b of Array.isArray(r)?r:[]){const A=String((b==null?void 0:b.phoneNorm)||"").trim(),D=String((b==null?void 0:b.dayKey)||"").trim(),W=String((b==null?void 0:b.monthKey)||"").trim();if(A){const st=D?`p:${A}:d:${D}`:W?`p:${A}:m:${W}`:`p:${A}`;C(st,b)}else C(`r:${b==null?void 0:b.rowIndex}`,b)}const h=b=>{const A=Number((b==null?void 0:b.cod)||0)||0;if(A>0)return A;const D=Number((b==null?void 0:b.codAlt)||0)||0;return D>0?D:0},f=b=>{var st;const A=((b==null?void 0:b.rows)||[]).slice().filter(Boolean);if(A.length<=1)return[{key:b.key,rows:A,phoneNorm:b.phoneNorm,phone:b.phone,monthKey:b.monthKey}];const D=A.map(h).filter(Nt=>Nt>0),W=Array.from(new Set(D));if(b.phoneNorm&&b.dayKey&&W.length>1&&W.length<=8){const Nt=new Map;for(const Dt of W)Nt.set(String(Dt),{key:`${b.key}:t:${Dt}`,rows:[],phoneNorm:b.phoneNorm,phone:b.phone,monthKey:b.monthKey});const rt=[];for(const Dt of A){const It=h(Dt);It>0?Nt.get(String(It)).rows.push(Dt):rt.push(Dt)}if(rt.length){const Dt=Array.from(Nt.values()).map(It=>{const Wt=It.rows.find(At=>String((At==null?void 0:At.productNorm)||"").trim())||null;return{group:It,seedNorm:String((Wt==null?void 0:Wt.productNorm)||"")}});for(const It of rt){const Wt=String((It==null?void 0:It.productNorm)||"");let At=null,ue=-1;for(const pt of Dt){const zt=jt(Wt,pt.seedNorm);zt>ue&&(ue=zt,At=pt.group)}(At||((st=Dt[0])==null?void 0:st.group)).rows.push(It)}}return Array.from(Nt.values()).filter(Dt=>Dt.rows.length>0)}return[{key:b.key,rows:A,phoneNorm:b.phoneNorm,phone:b.phone,monthKey:b.monthKey}]},L=[];for(const b of l.values())L.push(...f(b));const K=b=>{var De,ke,ve;const A=b.rows.slice().filter(Boolean),D=A.map(Bt=>Bt.rowIndex).filter(Boolean),W=[],st=new Set;for(const Bt of A){const O=String((Bt==null?void 0:Bt.productNorm)||"").trim();O&&(st.has(O)||(st.add(O),W.push(String((Bt==null?void 0:Bt.product)||"").trim())))}const Nt=W.filter(Boolean).join(" + "),rt=je(Nt),Dt=[];for(const Bt of A){const O=Array.isArray(Bt==null?void 0:Bt.codCandidates)?Bt.codCandidates:[];for(const mt of O){const Xt=Number(mt||0)||0;Xt>0&&Dt.push(Xt)}}const It=Array.from(new Set(Dt)).sort((Bt,O)=>Bt-O),Wt=A.map(Bt=>h(Bt)).filter(Bt=>Bt>0);let At=0;if(!Wt.length)At=0;else{const Bt=new Map;for(const mt of Wt)Bt.set(mt,(Bt.get(mt)||0)+1);const O=Array.from(Bt.keys());if(O.length===1)At=O[0];else{let mt=null,Xt=0;for(const[fe,Ce]of Bt.entries())Ce>Xt&&(Xt=Ce,mt=fe);mt!=null&&Xt>=2?At=mt:At=Wt.reduce((fe,Ce)=>fe+Ce,0)}}const ue=b.monthKey||((De=A.find(Bt=>Bt==null?void 0:Bt.monthKey))==null?void 0:De.monthKey)||"",pt=((ke=A.find(Bt=>Bt==null?void 0:Bt.dayKey))==null?void 0:ke.dayKey)||"",zt=((ve=A.find(Bt=>Bt==null?void 0:Bt.dateRaw))==null?void 0:ve.dateRaw)||"";return{key:b.key,phoneNorm:b.phoneNorm||"",phone:b.phone||b.phoneNorm||"",monthKey:ue,dayKey:pt,dateRaw:zt,rowIndices:D,rowIndexFirst:D.length?Math.min(...D):null,rowCount:A.length,productDisplay:Nt,productNorm:rt,productCompact:String(rt||"").replace(/\s+/g,""),cod:At,codCandidates:It,rows:A}};return L.map(K)},at=async r=>{const l=`${API_BASE}/api/orders?month=${encodeURIComponent(r)}&includeItems=1`,C=await window.KTM.api.getJSON(l,"L\u1ED7i t\u1EA3i danh s\xE1ch \u0111\u01A1n");return Array.isArray(C==null?void 0:C.orders)?C.orders:Array.isArray(C)?C:[]},Pt=async r=>{var A,D;const l=Array.isArray(r)&&r.length?r:[F],C=[],h=5*60*1e3;for(let W=0;W<l.length;W++){const st=l[W],Nt=(A=Zt.current)==null?void 0:A.get(st);if(Nt&&Date.now()-Number(Nt.at||0)<h&&Array.isArray(Nt.records)){C.push(...Nt.records);continue}re(`\u0110ang t\u1EA3i \u0111\u01A1n h\u1EC7 th\u1ED1ng th\xE1ng ${st} (${W+1}/${l.length})...`);const rt=await at(st);(D=Zt.current)==null||D.set(st,{at:Date.now(),records:rt}),C.push(...rt)}const f=W=>String(W||"").trim().toLowerCase(),L=C.filter(W=>{const st=f(W==null?void 0:W.status);return!(Gt&&st==="draft"||Kt&&st==="canceled"||$e&&st==="paid")}),K=W=>{var Nt,rt,Dt;return String(ee||"created_at")==="updated_at"?(rt=(Nt=W==null?void 0:W.updated_at)!=null?Nt:W==null?void 0:W.created_at)!=null?rt:null:(Dt=W==null?void 0:W.created_at)!=null?Dt:null};return L.map(W=>{var At,ue,pt,zt,De,ke;const st=window.KTM.orders.getOrderProductSummary(W,Ue),Nt=window.KTM.orders.getOrderTotalMoney(W,Ue),rt=yn(st),Dt=Qt((At=W==null?void 0:W.phone)!=null?At:""),It=K(W),Wt=(()=>{if(!It)return"";const ve=new Date(It);return Number.isNaN(ve.getTime())?"":`${ve.getFullYear()}-${String(ve.getMonth()+1).padStart(2,"0")}-${String(ve.getDate()).padStart(2,"0")}`})();return{id:String((ue=W==null?void 0:W.id)!=null?ue:""),created_at:(pt=W==null?void 0:W.created_at)!=null?pt:null,updated_at:(zt=W==null?void 0:W.updated_at)!=null?zt:null,dayKey:Wt,status:String((De=W==null?void 0:W.status)!=null?De:""),phone:String((ke=W==null?void 0:W.phone)!=null?ke:""),phoneNorm:Dt,productSummary:st,productNorm:rt,productCompact:rt.replace(/\s+/g,""),cod:Number(Nt||0)||0,raw:W}}).filter(W=>W.id&&W.cod>0)},jt=(r,l)=>{const C=String(r||"").trim(),h=String(l||"").trim();if(!C||!h)return 0;if(C===h)return 1;const f=C.replace(/\s+/g,""),L=h.replace(/\s+/g,"");if(f&&L&&f===L)return 1;if(f&&L&&(L.includes(f)||f.includes(L)))return .92;const K=At=>String(At||"").replace(/[\+]/g," ").replace(/[()\[\]{},.;:!?]/g," ").replace(/\s+/g," ").trim().split(" ").map(zt=>zt.trim()).filter(Boolean).map(zt=>zt.replace(/[^a-z0-9]/g,"")).filter(Boolean).filter(zt=>zt.length>1),b=K(C),A=K(h);if(!b.length||!A.length)return 0;const D=new Set(A),W=(At,ue)=>{if(At===ue)return 0;const pt=At.length,zt=ue.length;if(Math.abs(pt-zt)>1)return 2;let De=0,ke=0,ve=0;for(;De<pt&&ke<zt;){if(At[De]===ue[ke]){De+=1,ke+=1;continue}if(ve+=1,ve>1)return ve;pt>zt?De+=1:(zt>pt||(De+=1),ke+=1)}return(De<pt||ke<zt)&&(ve+=1),ve},st=At=>/[0-9]/.test(At)?2:1;let Nt=0,rt=0;for(const At of b){const ue=st(At);if(rt+=ue,D.has(At)||L&&L.includes(At)){Nt+=ue;continue}if(At.length>=4){let pt=!1;for(const zt of A){if(zt===At){pt=!0;break}if(zt.includes(At)||At.includes(zt)){pt=!0;break}if(L&&L.includes(At)){pt=!0;break}if(W(At,zt)<=1){pt=!0;break}}pt&&(Nt+=ue*.8)}}const Dt=Nt/Math.max(1,rt),It=Math.min(.12,Math.abs(C.length-h.length)/Math.max(1,Math.max(C.length,h.length))),Wt=(()=>{const At=b.filter(pt=>/[0-9]/.test(pt)&&pt.length>=3);if(!At.length)return 0;let ue=0;for(const pt of At)(D.has(pt)||L&&L.includes(pt))&&(ue+=1);return Math.min(.08,.04*ue)})();return Math.max(0,Math.min(1,Dt-It+Wt))},Ut=r=>{const C=String(r||"").trim().match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!C)return null;const h=new Date(Number(C[1]),Number(C[2])-1,Number(C[3]));return Number.isNaN(h.getTime())?null:h.getTime()},xe=(r,l)=>{const C=Array.isArray(r==null?void 0:r.codCandidates)&&r.codCandidates.length?r.codCandidates:[Number((r==null?void 0:r.cod)||0)||0],h=Number((l==null?void 0:l.cod)||0)||0;let f=1/0,L=0;for(const K of C){const b=Number(K||0)||0;if(b<=0)continue;const A=Math.abs(h-b);A<f&&(f=A,L=b)}return Number.isFinite(f)||(f=1/0),{bestDiff:f,bestCand:L,oCod:h}},ae=(r,l,C)=>{const h=String((r==null?void 0:r.phoneNorm)||"").trim(),f=!!(h&&String((l==null?void 0:l.phoneNorm)||"")===h),L=Math.max(0,Number((C==null?void 0:C.codTolerance)||0)||0),{bestDiff:K,bestCand:b}=xe(r,l),A=K===0,D=Number.isFinite(K)&&L>0&&K>0&&K<=L,W=String((r==null?void 0:r.dayKey)||"").trim(),st=String((l==null?void 0:l.dayKey)||"").trim(),Nt=!!(W&&st&&W===st),rt=(()=>{if(!W||!st)return!1;const De=Ut(W),ke=Ut(st);if(De==null||ke==null)return!1;const ve=Math.abs(De-ke)/(24*60*60*1e3);return ve>0&&ve<=1.01})(),It=!!h?{phone:.65,cod:.27,day:.08}:{phone:0,cod:.85,day:.15},Wt=f?It.phone:0,At=A?It.cod:D?It.cod*(1-K/Math.max(1,L)):0,ue=Nt?It.day:rt?It.day*.6:0,pt=Wt+At+ue,zt=[];return f&&zt.push("S\u0110T tr\xF9ng"),A?zt.push("COD tr\xF9ng"):D?zt.push(`COD l\u1EC7ch ${window.KTM.money.formatNumber(K)} (<= ${window.KTM.money.formatNumber(L)})`):b>0&&Number.isFinite(K)&&K!==1/0&&zt.push(`COD l\u1EC7ch ${window.KTM.money.formatNumber(K)}`),Nt?zt.push("C\xF9ng ng\xE0y"):rt&&zt.push("Ng\xE0y g\u1EA7n \u0111\xFAng (\xB11)"),{score:pt,reasons:zt,nameSim:null,phoneMatch:f,codExact:A,codWithin:D,codDiff:K,bestCand:b}},pn=r=>{let l=String(r!=null?r:"");return l=l.replace(/^\s*(?:x\s*)?(\d{1,3})\s*(?:x|\*|×)?\s*/i," "),l=l.replace(/\s+/g," ").trim(),yn(l)},Xe=r=>{var L;const l=new Map,C=new Map,h=Array.isArray(r==null?void 0:r.rows)?r.rows:[],f=h.length>1||h.some(K=>String((K==null?void 0:K.qtySource)||"default")!=="default");for(const K of h){const b=String((K==null?void 0:K.product)||"").trim(),A=pn(b);if(!A)continue;const D=Math.max(1,Number((L=K==null?void 0:K.qty)!=null?L:1)||1),W=f?D:1;l.set(A,(l.get(A)||0)+W),C.has(A)||C.set(A,b)}return{qtyByKey:l,labelByKey:C,qtyReliable:f}},cn=r=>{var b;const l=new Map,C=new Map,h=(r==null?void 0:r.raw)||null,f=Array.isArray(h==null?void 0:h.items)?h.items:[];if(f.length){for(const A of f){const D=A==null?void 0:A.product_id,W=D?Ue(D):null,st=String((W==null?void 0:W.name)||(A==null?void 0:A.product_name)||"").trim(),Nt=String((A==null?void 0:A.variant)||"").trim(),rt=(st||(r==null?void 0:r.productSummary)||"").trim()+(Nt?` (${Nt})`:""),Dt=pn(rt);if(!Dt)continue;const It=Math.max(1,Number((b=A==null?void 0:A.quantity)!=null?b:1)||1);l.set(Dt,(l.get(Dt)||0)+It),C.has(Dt)||C.set(Dt,st||rt)}return{qtyByKey:l,labelByKey:C}}const L=String((r==null?void 0:r.productSummary)||"").trim();if(!L)return{qtyByKey:l,labelByKey:C};const K=L.split("+").map(A=>String(A||"").trim()).filter(Boolean);for(const A of K){const D=A.match(/\bx\s*(\d{1,3})\b/i),W=D?Math.max(1,Number(D[1])||1):1,st=A.replace(/\bx\s*\d{1,3}\b/ig," ").replace(/\s+/g," ").trim(),Nt=pn(st);Nt&&(l.set(Nt,(l.get(Nt)||0)+W),C.has(Nt)||C.set(Nt,st))}return{qtyByKey:l,labelByKey:C}},Nn=(r,l)=>{const C=Xe(r),h=cn(l),f=Array.from(C.qtyByKey.keys()),L=Array.from(h.qtyByKey.keys()),K=[];for(const rt of f)for(const Dt of L){const It=jt(rt,Dt);It>=.9&&K.push({ek:rt,sk:Dt,sc:It})}K.sort((rt,Dt)=>Dt.sc-rt.sc);const b=new Map,A=new Set,D=new Set;for(const rt of K)A.has(rt.ek)||D.has(rt.sk)||(b.set(rt.ek,rt.sk),A.add(rt.ek),D.add(rt.sk));const W=[],st=[];for(const[rt,Dt]of C.qtyByKey.entries()){const It=b.get(rt)||rt,Wt=h.qtyByKey.get(It)||0;Wt<Dt&&W.push({name:C.labelByKey.get(rt)||rt,qty:Dt-Wt})}for(const[rt,Dt]of h.qtyByKey.entries()){let It=C.qtyByKey.get(rt)||0;if(!It){for(const[Wt,At]of b.entries())if(At===rt){It=C.qtyByKey.get(Wt)||0;break}}It<Dt&&st.push({name:h.labelByKey.get(rt)||rt,qty:Dt-It})}return{hasDiff:W.length>0||st.length>0,missingInSystem:W,missingInExcel:st}},ie=r=>{if(!(r!=null&&r.hasDiff))return"";const l=h=>h.slice(0,4).map(f=>`${f.name} x${f.qty}`).join(", ")+(h.length>4?` (+${h.length-4})`:""),C=[];return Array.isArray(r.missingInExcel)&&r.missingInExcel.length&&C.push(`Thi\u1EBFu trong Excel: ${l(r.missingInExcel)}`),Array.isArray(r.missingInSystem)&&r.missingInSystem.length&&C.push(`Thi\u1EBFu trong h\u1EC7 th\u1ED1ng: ${l(r.missingInSystem)}`),C.join(" \xB7 ")},hn=async r=>{Ct(""),Lt(null),Vt((r==null?void 0:r.name)||""),Et(!0),re("\u0110ang \u0111\u1ECDc file Excel...");try{await ze();const l=await p(r),C=Array.isArray(l.rows)?l.rows:[],h=String(F||"").trim()||getCurrentMonth(),f=tt=>{const s=String(tt||"").match(/^(\d{4})-(\d{2})$/);if(!s)return NaN;const d=Number(s[1]),c=Number(s[2]);return!Number.isFinite(d)||!Number.isFinite(c)||c<1||c>12?NaN:d*12+(c-1)},L=tt=>{if(!Number.isFinite(tt))return"";const s=Math.floor(tt/12),d=tt%12+1;return!Number.isFinite(s)||!Number.isFinite(d)||d<1||d>12?"":`${String(s).padStart(4,"0")}-${String(d).padStart(2,"0")}`},K=f(h),b=Number.isFinite(K)?K-2:NaN,A=tt=>{const s=f(tt);return!Number.isFinite(s)||!Number.isFinite(K)||!Number.isFinite(b)?!1:s>=b&&s<=K},D=(()=>{if(!Number.isFinite(K)||!Number.isFinite(b))return[h];const tt=[];for(let s=b;s<=K;s++){const d=L(s);d&&tt.push(d)}return tt.length?tt:[h]})(),W=C.filter(tt=>{const s=String((tt==null?void 0:tt.monthKey)||"").trim();return s?A(s):!0}),st=C.filter(tt=>{const s=String((tt==null?void 0:tt.monthKey)||"").trim();return s?!A(s):!1});if(!W.length)throw new Error(`File kh\xF4ng c\xF3 d\u1EEF li\u1EC7u trong 3 th\xE1ng g\u1EA7n nh\u1EA5t quanh ${h}.`);const Nt=D,rt=await Pt(Nt),Dt=(()=>{const tt=new Map;for(const s of Array.isArray(rt)?rt:[]){const d=String((s==null?void 0:s.phoneNorm)||"").trim(),c=String((s==null?void 0:s.dayKey)||"").trim();if(!d||!c)continue;const k=`${d}|${c}`;tt.set(k,(tt.get(k)||0)+1)}return tt})(),It=tt=>{const s=Number(tt);return Number.isFinite(s)?Math.trunc(s):0},Wt=(tt,s)=>{const d=String(tt||"").trim(),c=It(s);return!d||!c?"":`${d}|${c}`},At=(()=>{const tt=new Map;for(const s of Array.isArray(rt)?rt:[]){const d=Wt(s==null?void 0:s.phoneNorm,s==null?void 0:s.cod);d&&tt.set(d,(tt.get(d)||0)+1)}return tt})(),ue=new Set(rt.map(tt=>Wt(tt==null?void 0:tt.phoneNorm,tt==null?void 0:tt.cod)).filter(Boolean)),pt=(()=>{var s,d,c,k,R;const tt=new Map;for(const S of st){const w=Wt(S==null?void 0:S.phoneNorm,S==null?void 0:S.cod);if(!w||!ue.has(w))continue;const U=tt.get(w)||[];U.push({rowIndex:(s=S==null?void 0:S.rowIndex)!=null?s:null,dateRaw:(d=S==null?void 0:S.dateRaw)!=null?d:"",monthKey:(c=S==null?void 0:S.monthKey)!=null?c:"",dayKey:(k=S==null?void 0:S.dayKey)!=null?k:"",product:(R=S==null?void 0:S.product)!=null?R:""}),tt.set(w,U)}return tt})(),zt=W,De=tt=>{const s=Number((tt==null?void 0:tt.cod)||0)||0;if(s>0)return s;const d=Number((tt==null?void 0:tt.codAlt)||0)||0;return d>0?d:0},ke=tt=>{var c;const s=new Map;for(const k of Array.isArray(tt)?tt:[]){const R=String((k==null?void 0:k.phoneNorm)||"").trim(),S=String((k==null?void 0:k.dayKey)||"").trim();if(!R||!S)continue;const w=`${R}|${S}`,U=s.get(w)||[];U.push(k),s.set(w,U)}const d=[];for(const[k,R]of s.entries()){if(!Array.isArray(R)||R.length<2)continue;const[S,w]=String(k).split("|"),U=w&&w.length>=7?w.slice(0,7):"",lt=R.map(De).filter(Mt=>Mt>0).reduce((Mt,y)=>Mt+y,0);if(!lt)continue;const Q=R.map(Mt=>Mt==null?void 0:Mt.rowIndex).filter(Boolean),et=[],Ot=new Set;for(const Mt of R){const y=String((Mt==null?void 0:Mt.product)||"").trim();y&&(Ot.has(y)||(Ot.add(y),et.push(y)))}d.push({key:`merge:p:${S}:d:${w}`,isMerged:!0,phoneNorm:S,phone:S,monthKey:U,dayKey:w,dateRaw:((c=R.find(Mt=>Mt==null?void 0:Mt.dateRaw))==null?void 0:c.dateRaw)||"",rowIndices:Q,rowIndexFirst:Q.length?Math.min(...Q):null,rowCount:R.length,productDisplay:et.join(" + "),productNorm:"",productCompact:"",cod:lt,codCandidates:[],rows:R})}return d},ve=G(zt),Bt=ke(zt),O=Bt.length?ve.concat(Bt):ve;re(`\u0110\u1ECDc \u0111\u01B0\u1EE3c ${zt.length} d\xF2ng (${ve.length} c\u1EE5m; +${Bt.length} c\u1EE5m g\u1ED9p) trong 3 th\xE1ng g\u1EA7n nh\u1EA5t. \u0110ang chu\u1EA9n b\u1ECB \u0111\u1ED1i so\xE1t...`),re(`\u0110ang \u0111\u1ED1i so\xE1t (${O.length} c\u1EE5m Excel vs ${rt.length} \u0111\u01A1n h\u1EC7 th\u1ED1ng)...`);const mt=new Map,Xt=new Map,fe=new Map;for(const tt of O){const s=String(tt.phoneNorm||"").trim();if(!s)continue;const d=mt.get(s)||[];d.push(tt),mt.set(s,d);const c=Wt(s,tt.cod);if(c){const k=Xt.get(c)||[];k.push(tt),Xt.set(c,k);const R=String((tt==null?void 0:tt.dayKey)||"").trim();if(R){const S=`${c}|${R}`,w=fe.get(S)||[];w.push(tt),fe.set(S,w)}}}const Ce=new Set,Ye=(()=>{const tt=new Map;for(const s of O){const d=String((s==null?void 0:s.key)||"").trim();if(!d)continue;const c=Array.isArray(s==null?void 0:s.rowIndices)?s.rowIndices:[];for(const k of c){const R=Number(k);if(!Number.isFinite(R))continue;const S=tt.get(R)||[];S.push(d),tt.set(R,S)}}return tt})(),Ne=tt=>{const s=Array.isArray(tt==null?void 0:tt.rowIndices)?tt.rowIndices:[];for(const c of s){const k=Number(c);if(!Number.isFinite(k))continue;const R=Ye.get(k)||[];for(const S of R)Ce.add(String(S))}const d=String((tt==null?void 0:tt.key)||"").trim();d&&Ce.add(d)},Ee=[],Qe=[],Ie=[],en=tt=>{const s=Array.isArray(tt)?tt.filter(Boolean):[];return s.length?`C\xF3 d\xF2ng Excel ngo\xE0i 3 th\xE1ng tr\xF9ng S\u0110T+COD: ${s.slice(0,2).map(c=>{const k=String((c==null?void 0:c.dateRaw)||(c==null?void 0:c.dayKey)||(c==null?void 0:c.monthKey)||"").trim(),R=c!=null&&c.rowIndex?`d\xF2ng ${c.rowIndex}`:"";return[k,R].filter(Boolean).join(" \xB7 ")}).join(" | ")}`:""};for(const tt of rt){const s=String(tt.phoneNorm||"").trim(),d=It(tt.cod);if(!s||!d){Ie.push(tt);continue}const c=Wt(s,d),k=String(tt.dayKey||"").trim();let R=c?Xt.get(c)||[]:[],S=[];if(c&&k&&(S=fe.get(`${c}|${k}`)||[]),k&&R.length){const ft=(At.get(c)||0)>1;R=R.filter(oe=>{const le=String((oe==null?void 0:oe.dayKey)||"").trim();return le?le===k:!ft})}const w=ft=>{if(!(ft!=null&&ft.isMerged))return!0;const oe=String((ft==null?void 0:ft.dayKey)||"").trim();return!k||!oe||oe!==k?!1:(Dt.get(`${s}|${k}`)||0)===1},U=ft=>{const oe=(Array.isArray(ft)?ft:[]).filter(Ae=>!Ce.has(String(Ae==null?void 0:Ae.key)));if(!oe.length)return null;let le=oe.find(Ae=>!(Ae!=null&&Ae.isMerged))||null;return le||(le=oe.find(Ae=>w(Ae))||null),le&&(le!=null&&le.isMerged)&&!w(le)?null:le};if(S.length){const ft=U(S);if(ft){Ne(ft),Ee.push({group:ft,order:tt,score:1,reasons:["S\u0110T tr\xF9ng","COD tr\xF9ng","C\xF9ng ng\xE0y"]});continue}}if(R.length){const ft=U(R);if(ft){Ne(ft),Ee.push({group:ft,order:tt,score:1,reasons:["S\u0110T tr\xF9ng","COD tr\xF9ng",...ft.dayKey&&k&&ft.dayKey===k?["C\xF9ng ng\xE0y"]:[]]});continue}}const lt=mt.get(s)||[];if(!lt.length){const ft=pt.get(c)||[];Ie.push(ft.length?{...tt,excelOutsideHints:ft,excelOutsideHintText:en(ft)}:tt);continue}let Q=lt.filter(ft=>!Ce.has(String(ft==null?void 0:ft.key)));if(k){const ft=Q.filter(oe=>String(oe.dayKey||"").trim()===k);ft.length&&(Q=ft)}if(!Q.length){const ft=pt.get(c)||[];Ie.push(ft.length?{...tt,excelOutsideHints:ft,excelOutsideHintText:en(ft)}:tt);continue}let et=null,Ot=Number.POSITIVE_INFINITY;for(const ft of Q){const oe=It(ft.cod);if(!oe)continue;const le=Math.abs(oe-d);le<Ot&&(Ot=le,et=ft)}if(!et){const ft=pt.get(c)||[];Ie.push(ft.length?{...tt,excelOutsideHints:ft,excelOutsideHintText:en(ft)}:tt);continue}const Mt=It(et.cod)-d,y=Math.abs(Mt),gt=Be?Math.max(0,It(M)):0;if(y===0||gt>0&&y<=gt){Ne(et),Ee.push({group:et,order:tt,score:1,reasons:["S\u0110T tr\xF9ng","COD tr\xF9ng",...gt>0&&y>0?[`Trong ng\u01B0\u1EE1ng \xB1${gt}`]:[],...k&&String(et.dayKey||"").trim()===k?["C\xF9ng ng\xE0y"]:[]]});continue}Qe.push({group:et,order:tt,score:0,diff:Mt,reason:k&&String(et.dayKey||"").trim()===k?"S\u0110T tr\xF9ng \xB7 C\xF9ng ng\xE0y":"S\u0110T tr\xF9ng",suggestions:Q.slice(0,3).map(ft=>({key:ft.key,cod:It(ft.cod),productSummary:String(ft.product||"").trim(),score:0,reasons:["Excel c\xF9ng S\u0110T"]}))})}const gn=Ie.length===0&&Qe.length===0;Lt({ok:gn,monthKeys:Nt,excelCount:zt.length,excelGroupCount:O.length,systemCount:rt.length,matches:Ee,systemOnly:Ie,moneyMismatch:Qe}),pe(Ie.length?"systemOnly":Qe.length?"moneyMismatch":"matches"),x(new Set),re(gn?"OK \u2705":"\u0110\xE3 \u0111\u1ED1i so\xE1t xong")}catch(l){Ct(String((l==null?void 0:l.message)||l||"L\u1ED7i \u0111\u1ED1i so\xE1t")),re("")}finally{Et(!1)}},Dn=(r,l)=>{var D,W,st,Nt,rt,Dt,It,Wt,At,ue;const C=pt=>String(pt||"").replace(/[^0-9]/g,""),h=(r==null?void 0:r.raw)||{},f=String((W=(D=r==null?void 0:r.id)!=null?D:h==null?void 0:h.id)!=null?W:"").trim(),L=C((Nt=(st=h==null?void 0:h.phone)!=null?st:r==null?void 0:r.phone)!=null?Nt:"");if(!f||!L)return null;let b=(Array.isArray(h==null?void 0:h.items)?h.items:[]).map(pt=>{var zt,De;return{product_id:(pt==null?void 0:pt.product_id)||"",quantity:Number((zt=pt==null?void 0:pt.quantity)!=null?zt:1),variant:String((pt==null?void 0:pt.variant)||"").trim()||null,variant_json:(De=pt==null?void 0:pt.variant_json)!=null?De:null,unit_price:(()=>{var Bt;const ke=(Bt=pt==null?void 0:pt.unit_price)!=null?Bt:pt==null?void 0:pt.unitPrice,ve=ke==null||ke===""?NaN:Number(ke);return Number.isFinite(ve)?Math.max(0,Math.trunc(ve)):null})()}}).filter(pt=>pt.product_id&&Number.isFinite(pt.quantity)&&pt.quantity>0);if(!b.length&&(h!=null&&h.product_id)){const pt=Number((rt=h==null?void 0:h.quantity)!=null?rt:1);b=[{product_id:h.product_id,quantity:Number.isFinite(pt)&&pt>0?pt:1,variant:null,variant_json:null,unit_price:null}]}if(!b.length)return null;const A=b[0];return{id:f,customer_name:String((Dt=h==null?void 0:h.customer_name)!=null?Dt:"").trim(),phone:L,address:String((It=h==null?void 0:h.address)!=null?It:"").trim(),note:String((Wt=h==null?void 0:h.note)!=null?Wt:"").trim(),adjustment_amount:Number((At=h==null?void 0:h.adjustment_amount)!=null?At:0)||0,adjustment_note:String((ue=h==null?void 0:h.adjustment_note)!=null?ue:"").trim(),product_id:A.product_id,quantity:A.quantity,status:l,items:b}},Sn=async()=>{if(!it||vt)return;const r=Array.from(_t.values()).map(h=>String(h||"").trim()).filter(Boolean);if(!r.length||!confirm(`\u0110\xE1nh d\u1EA5u \u0111\xE3 nh\u1EADn ti\u1EC1n cho ${r.length} \u0111\u01A1n?`))return;St(!0),ht("\u0110ang c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i...");let l=0;const C=[];try{for(let h=0;h<r.length;h++){const f=r[h];ht(`\u0110ang c\u1EADp nh\u1EADt (${h+1}/${r.length})...`);const L=(Array.isArray(it==null?void 0:it.matches)?it.matches:[]).find(b=>{var A;return String(((A=b==null?void 0:b.order)==null?void 0:A.id)||"")===f}),K=Dn(L==null?void 0:L.order,"paid");if(!K){C.push({id:f,error:"Thi\u1EBFu d\u1EEF li\u1EC7u (phone/items)"});continue}try{await window.KTM.api.putJSON(`${API_BASE}/api/orders/${encodeURIComponent(f)}`,K,"L\u1ED7i c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i"),l+=1}catch(b){C.push({id:f,error:String((b==null?void 0:b.message)||b||"L\u1ED7i")})}}}finally{St(!1),ht("")}if(l>0){j(`\u0110\xE3 c\u1EADp nh\u1EADt ${l} \u0111\u01A1n sang \u0110\xE3 nh\u1EADn ti\u1EC1n`,"success");const h=new Set(r);Lt(f=>{if(!f)return f;const L=K=>{if(!K||!h.has(String(K.id)))return K;const b=K.raw?{...K.raw,status:"paid"}:K.raw;return{...K,status:"paid",raw:b}};return{...f,matches:Array.isArray(f.matches)?f.matches.map(K=>({...K,order:L(K==null?void 0:K.order)})):f.matches,systemOnly:Array.isArray(f.systemOnly)?f.systemOnly.map(L):f.systemOnly,moneyMismatch:Array.isArray(f.moneyMismatch)?f.moneyMismatch.map(K=>({...K,order:L(K==null?void 0:K.order)})):f.moneyMismatch}}),x(new Set)}C.length&&(j(`C\xF3 ${C.length} \u0111\u01A1n c\u1EADp nh\u1EADt l\u1ED7i (xem console)`,"warning"),console.warn("Recon paid update failures:",C))};return React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-file-excel me-2 text-success"}),"\u0110\u1ED1i so\xE1t Excel")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"Th\xE1ng m\u1EB7c \u0111\u1ECBnh (n\u1EBFu Excel kh\xF4ng c\xF3 c\u1ED9t ng\xE0y)"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:ot,onChange:r=>J(r.target.value),"aria-label":"Ch\u1ECDn th\xE1ng",disabled:V}))))),React.createElement("div",{className:"card border-0 shadow-sm mb-3"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-2"},React.createElement("div",{className:"fw-semibold"},React.createElement("i",{className:"fas fa-file-excel me-2 text-success"}),"\u0110\u1ED1i so\xE1t c\xF4ng n\u1EE3 (Excel)"),React.createElement("div",{className:"d-flex flex-wrap gap-2 align-items-center"},React.createElement("span",{className:"text-muted small"},"\u0110\u1ED1i so\xE1t theo: ",React.createElement("span",{className:"fw-semibold"},"S\u0110T")," + ",React.createElement("span",{className:"fw-semibold"},"T\u1ED5ng ti\u1EC1n thu h\u1ED9")))),Se==="loading"&&React.createElement("div",{className:"alert alert-info mt-3 mb-0"},"\u0110ang t\u1EA3i th\u01B0 vi\u1EC7n \u0111\u1ECDc Excel (XLSX)..."),Se==="failed"&&React.createElement("div",{className:"alert alert-warning mt-3 mb-0"},"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c th\u01B0 vi\u1EC7n \u0111\u1ECDc Excel (XLSX). H\xE3y ki\u1EC3m tra m\u1EA1ng / ch\u1EB7n CDN (AdBlock) ho\u1EB7c refresh l\u1EA1i trang."),React.createElement("div",{className:"row g-2 align-items-end mt-2"},React.createElement("div",{className:"col-12 col-md-7"},React.createElement("label",{className:"form-label mb-1"},"Upload file Excel"),React.createElement("input",{type:"file",className:"form-control",accept:".xlsx,.xls,.csv",disabled:V,onChange:async r=>{const l=r.target.files&&r.target.files[0];l&&await hn(l)}}),React.createElement("div",{className:"form-text"},Ft?`File: ${Ft}`:'Header c\u1EA7n c\xF3: "T\u1ED5ng Ti\u1EC1n Thu H\u1ED9". "T\xEAn s\u1EA3n ph\u1EA9m" (n\u1EBFu c\xF3) s\u1EBD gi\xFAp g\u1EE3i \xFD kh\u1EDBp t\u1ED1t h\u01A1n. C\xF3 c\u1ED9t "Ng\xE0y" th\xEC s\u1EBD t\u1EF1 t\u1EA3i \u0111\xFAng th\xE1ng trong file.')),React.createElement("div",{className:"col-12 col-md-5"},React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-md-end"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("label",{className:"form-label mb-0 small text-muted"},"Ng\xE0y theo"),React.createElement("select",{className:"form-select form-select-sm",style:{width:150},value:ee,disabled:V,onChange:r=>Le(r.target.value)},React.createElement("option",{value:"created_at"},"created_at"),React.createElement("option",{value:"updated_at"},"updated_at"))),React.createElement("div",{className:"form-check"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"recon-exc-draft",checked:Gt,disabled:V,onChange:r=>se(!!r.target.checked)}),React.createElement("label",{className:"form-check-label small",htmlFor:"recon-exc-draft"},"B\u1ECF nh\xE1p")),React.createElement("div",{className:"form-check"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"recon-exc-canceled",checked:Kt,disabled:V,onChange:r=>ye(!!r.target.checked)}),React.createElement("label",{className:"form-check-label small",htmlFor:"recon-exc-canceled"},"B\u1ECF h\u1EE7y")),React.createElement("div",{className:"form-check"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"recon-exc-paid",checked:$e,disabled:V,onChange:r=>on(!!r.target.checked)}),React.createElement("label",{className:"form-check-label small",htmlFor:"recon-exc-paid"},"B\u1ECF \u0111\xE3 nh\u1EADn ti\u1EC1n")),React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("div",{className:"form-check mb-0"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"recon-cod-tol",checked:Be,disabled:V,onChange:r=>$(!!r.target.checked)}),React.createElement("label",{className:"form-check-label small",htmlFor:"recon-cod-tol"},"Cho l\u1EC7ch COD")),React.createElement("input",{type:"number",className:"form-control form-control-sm",style:{width:110},value:M,min:"0",step:"1000",disabled:V||!Be,onChange:r=>z(r.target.value)})))),React.createElement("div",{className:"col-12 d-flex gap-2 justify-content-md-end"},React.createElement("button",{className:"btn btn-outline-secondary",disabled:V,onClick:()=>{Ct(""),re(""),Lt(null),Vt(""),pe("matches"),_e(""),j("\u0110\xE3 reset \u0111\u1ED1i so\xE1t","info")}},React.createElement("i",{className:"fas fa-rotate-left me-2"}),"Reset"))),Jt&&React.createElement("div",{className:"mt-2 small text-muted"},Jt),Ht&&React.createElement("div",{className:"alert alert-danger mt-3 mb-0"},Ht),it&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:`alert ${it.ok?"alert-success":"alert-warning"} mb-3`},it.ok?React.createElement("div",{className:"fw-semibold"},"OK \u2014 Kh\xF4ng th\u1EA5y \u0111\u01A1n h\u1EC7 th\u1ED1ng b\u1ECB thi\u1EBFu trong Excel ho\u1EB7c l\u1EC7ch ti\u1EC1n."):React.createElement("div",{className:"fw-semibold"},"CH\u01AFA KH\u1EDAP \u2014 C\xF3 \u0111\u01A1n h\u1EC7 th\u1ED1ng thi\u1EBFu trong Excel ho\u1EB7c l\u1EC7ch ti\u1EC1n."),React.createElement("div",{className:"small mt-1"},"Th\xE1ng \u0111\u1ED1i so\xE1t: ",Array.isArray(it.monthKeys)?it.monthKeys.join(", "):""," \xB7 Excel: ",it.excelCount," d\xF2ng",Number(it.excelGroupCount||0)?` (${it.excelGroupCount} c\u1EE5m)`:""," \xB7 H\u1EC7 th\u1ED1ng: ",it.systemCount," \u0111\u01A1n")),React.createElement("div",{className:"d-flex flex-wrap gap-2 align-items-center justify-content-between mb-2"},React.createElement("div",{className:"btn-group btn-group-sm",role:"group","aria-label":"Recon view"},React.createElement("button",{type:"button",className:`btn ${X==="matches"?"btn-success":"btn-outline-success"}`,disabled:!Array.isArray(it.matches)||it.matches.length===0,onClick:()=>pe("matches")},"Kh\u1EDBp (",Array.isArray(it.matches)?it.matches.length:0,")"),React.createElement("button",{type:"button",className:`btn ${X==="systemOnly"?"btn-warning":"btn-outline-warning"}`,disabled:!Array.isArray(it.systemOnly)||it.systemOnly.length===0,onClick:()=>pe("systemOnly")},"Thi\u1EBFu Excel (",Array.isArray(it.systemOnly)?it.systemOnly.length:0,")"),React.createElement("button",{type:"button",className:`btn ${X==="moneyMismatch"?"btn-danger":"btn-outline-danger"}`,disabled:!Array.isArray(it.moneyMismatch)||it.moneyMismatch.length===0,onClick:()=>pe("moneyMismatch")},"Sai ti\u1EC1n (",Array.isArray(it.moneyMismatch)?it.moneyMismatch.length:0,")")),React.createElement("div",{className:"d-flex flex-wrap gap-2 align-items-center"},React.createElement("input",{type:"text",className:"form-control form-control-sm recon-phone-input",placeholder:"L\u1ECDc theo S\u0110T...",value:ge,onChange:r=>_e(r.target.value)}),React.createElement("div",{className:"btn-group btn-group-sm",role:"group","aria-label":"Export CSV"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{var C,h,f,L,K,b,A;const r=Qt(ge),l=[["type","order_id","date","phone","product","cod_excel","cod_system","diff","reason"]];for(const D of Array.isArray(it.moneyMismatch)?it.moneyMismatch:[])r&&String(((C=D==null?void 0:D.group)==null?void 0:C.phoneNorm)||"").indexOf(r)<0||l.push(["moneyMismatch",((h=D==null?void 0:D.order)==null?void 0:h.id)||"",String(((f=D==null?void 0:D.group)==null?void 0:f.dateRaw)||""),((L=D==null?void 0:D.group)==null?void 0:L.phone)||"",((K=D==null?void 0:D.group)==null?void 0:K.productDisplay)||"",Number(((b=D==null?void 0:D.group)==null?void 0:b.cod)||0),Number(((A=D==null?void 0:D.order)==null?void 0:A.cod)||0),Number((D==null?void 0:D.diff)||0),String((D==null?void 0:D.reason)||"")]);for(const D of Array.isArray(it.systemOnly)?it.systemOnly:[])r&&String((D==null?void 0:D.phoneNorm)||"").indexOf(r)<0||l.push(["systemOnly",(D==null?void 0:D.id)||"",window.KTM.date.formatDateTime(D==null?void 0:D.created_at),(D==null?void 0:D.phone)||"",(D==null?void 0:D.productSummary)||"","",Number((D==null?void 0:D.cod)||0),"",String((D==null?void 0:D.excelOutsideHintText)||"")]);Ke(`recon_${String(F||"").replace(/[^0-9\-]/g,"")}.csv`,l)}},"Export CSV")))),Array.isArray(it.moneyMismatch)&&it.moneyMismatch.length>0&&X==="moneyMismatch"&&React.createElement("div",{className:"card border-0 shadow-sm mb-2"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"fw-semibold mb-2 text-danger"},"Sai l\u1EC7ch s\u1ED1 ti\u1EC1n"),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Excel (d\xF2ng)"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"T\xEAn s\u1EA3n ph\u1EA9m (Excel)"),React.createElement("th",{className:"text-end"},"Thu h\u1ED9 (Excel)"),React.createElement("th",null,"Order ID"),React.createElement("th",null,"T\xEAn SP (H\u1EC7 th\u1ED1ng)"),React.createElement("th",{className:"text-end"},"Thu h\u1ED9 (H\u1EC7 th\u1ED1ng)"),React.createElement("th",{className:"text-end"},"L\u1EC7ch"),React.createElement("th",null,"L\xFD do"))),React.createElement("tbody",null,it.moneyMismatch.filter(r=>{var C;const l=Qt(ge);return l?String(((C=r==null?void 0:r.group)==null?void 0:C.phoneNorm)||"").includes(l):!0}).slice(0,30).map(r=>{var l,C,h,f,L,K,b,A,D,W;return React.createElement("tr",{key:`mm-${String(((l=r==null?void 0:r.group)==null?void 0:l.key)||((C=r==null?void 0:r.order)==null?void 0:C.id)||Math.random())}`,className:"table-danger"},React.createElement("td",null,((h=r==null?void 0:r.group)==null?void 0:h.rowIndexFirst)||"\u2014",Number(((f=r==null?void 0:r.group)==null?void 0:f.rowCount)||0)>1?` (+${Number(r.group.rowCount)-1})`:""),React.createElement("td",{className:"text-muted"},((L=r==null?void 0:r.group)==null?void 0:L.phone)||"\u2014"),React.createElement("td",{style:{minWidth:260}},((K=r==null?void 0:r.group)==null?void 0:K.productDisplay)||"\u2014"),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(Number(((b=r==null?void 0:r.group)==null?void 0:b.cod)||0))),React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",onClick:()=>{kt((r==null?void 0:r.order)||null),Y(!0)}},(A=r==null?void 0:r.order)==null?void 0:A.id)),React.createElement("td",{style:{minWidth:240}},(D=r==null?void 0:r.order)==null?void 0:D.productSummary),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber((W=r==null?void 0:r.order)==null?void 0:W.cod)),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(r==null?void 0:r.diff)),React.createElement("td",{className:"text-muted",style:{minWidth:220}},(r==null?void 0:r.reason)||""))})))),it.moneyMismatch.length>30&&React.createElement("div",{className:"text-muted small mt-2"},"\u0110ang hi\u1EC3n th\u1ECB 30/",it.moneyMismatch.length," d\xF2ng.")),React.createElement("div",{className:"d-md-none"},it.moneyMismatch.filter(r=>{var C;const l=Qt(ge);return l?String(((C=r==null?void 0:r.group)==null?void 0:C.phoneNorm)||"").includes(l):!0}).slice(0,30).map(r=>{var h,f,L,K,b,A,D,W,st,Nt,rt,Dt;const l=`${((h=r==null?void 0:r.group)==null?void 0:h.rowIndexFirst)||"\u2014"}${Number(((f=r==null?void 0:r.group)==null?void 0:f.rowCount)||0)>1?` (+${Number(r.group.rowCount)-1})`:""}`,C=String(((L=r==null?void 0:r.group)==null?void 0:L.dateRaw)||((K=r==null?void 0:r.group)==null?void 0:K.dayKey)||"").trim();return React.createElement("div",{key:`mm-m-${String(((b=r==null?void 0:r.group)==null?void 0:b.key)||((A=r==null?void 0:r.order)==null?void 0:A.id)||Math.random())}`,className:"recon-mobile-card recon-mobile-card-danger"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold text-truncate",style:{maxWidth:"70%"}},((D=r==null?void 0:r.group)==null?void 0:D.phone)||"\u2014"),React.createElement("div",{className:"fw-semibold text-danger"},window.KTM.money.formatNumber(r==null?void 0:r.diff))),React.createElement("div",{className:"small text-muted mt-1"},"Excel d\xF2ng ",l,C?` \u2022 ${C}`:""),React.createElement("div",{className:"mt-2"},React.createElement("div",{className:"recon-mobile-kv"},React.createElement("span",{className:"text-muted"},"Thu h\u1ED9 (Excel)"),React.createElement("span",{className:"fw-semibold"},window.KTM.money.formatNumber(Number(((W=r==null?void 0:r.group)==null?void 0:W.cod)||0)))),React.createElement("div",{className:"recon-mobile-value mt-1"},((st=r==null?void 0:r.group)==null?void 0:st.productDisplay)||"\u2014")),React.createElement("div",{className:"mt-2 pt-2 border-top"},React.createElement("div",{className:"recon-mobile-kv"},React.createElement("span",{className:"text-muted"},"Order"),React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",onClick:()=>{kt((r==null?void 0:r.order)||null),Y(!0)}},((Nt=r==null?void 0:r.order)==null?void 0:Nt.id)||"\u2014")),React.createElement("div",{className:"recon-mobile-value mt-1"},((rt=r==null?void 0:r.order)==null?void 0:rt.productSummary)||"\u2014"),React.createElement("div",{className:"recon-mobile-kv mt-1"},React.createElement("span",{className:"text-muted"},"Thu h\u1ED9 (H\u1EC7 th\u1ED1ng)"),React.createElement("span",{className:"fw-semibold"},window.KTM.money.formatNumber(Number(((Dt=r==null?void 0:r.order)==null?void 0:Dt.cod)||0))))),r!=null&&r.reason?React.createElement("div",{className:"small text-muted mt-2"},"L\xFD do: ",r.reason):null)}),it.moneyMismatch.length>30&&React.createElement("div",{className:"text-muted small mt-2"},"\u0110ang hi\u1EC3n th\u1ECB 30/",it.moneyMismatch.length," d\xF2ng.")))),Array.isArray(it.systemOnly)&&it.systemOnly.length>0&&X==="systemOnly"&&React.createElement("div",{className:"card border-0 shadow-sm mb-2"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"fw-semibold mb-2 text-warning"},"C\xF3 trong h\u1EC7 th\u1ED1ng nh\u01B0ng thi\u1EBFu trong Excel"),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Order ID"),React.createElement("th",null,"Ng\xE0y t\u1EA1o"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"T\xEAn s\u1EA3n ph\u1EA9m"),React.createElement("th",{className:"text-end"},"Thu h\u1ED9"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"))),React.createElement("tbody",null,it.systemOnly.filter(r=>{const l=Qt(ge);return l?String((r==null?void 0:r.phoneNorm)||"").includes(l):!0}).slice(0,30).map(r=>React.createElement("tr",{key:`so-${r.id}`,className:"table-warning"},React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",onClick:()=>{kt(r||null),Y(!0)}},r.id)),React.createElement("td",{className:"text-muted"},window.KTM.date.formatDateTime(r.created_at)),React.createElement("td",{className:"text-muted"},r.phone||"\u2014"),React.createElement("td",{style:{minWidth:280}},r.productSummary),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(r.cod)),React.createElement("td",{className:"text-muted"},r.status,r!=null&&r.excelOutsideHintText?React.createElement("div",{className:"small text-muted mt-1"},r.excelOutsideHintText):null)))))),it.systemOnly.length>30&&React.createElement("div",{className:"text-muted small mt-2"},"\u0110ang hi\u1EC3n th\u1ECB 30/",it.systemOnly.length," \u0111\u01A1n.")),React.createElement("div",{className:"d-md-none"},it.systemOnly.filter(r=>{const l=Qt(ge);return l?String((r==null?void 0:r.phoneNorm)||"").includes(l):!0}).slice(0,30).map(r=>React.createElement("div",{key:`so-m-${r.id}`,className:"recon-mobile-card recon-mobile-card-warning"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",onClick:()=>{kt(r||null),Y(!0)}},r.id),React.createElement("span",{className:"badge bg-secondary"},r.status||"\u2014")),React.createElement("div",{className:"small text-muted mt-1"},window.KTM.date.formatDateTime(r.created_at),r.phone?` \u2022 ${r.phone}`:""),React.createElement("div",{className:"recon-mobile-value mt-2"},r.productSummary||"\u2014"),React.createElement("div",{className:"recon-mobile-kv mt-2"},React.createElement("span",{className:"text-muted"},"Thu h\u1ED9"),React.createElement("span",{className:"fw-semibold"},window.KTM.money.formatNumber(r.cod))),r!=null&&r.excelOutsideHintText?React.createElement("div",{className:"small text-muted mt-2"},r.excelOutsideHintText):null)),it.systemOnly.length>30&&React.createElement("div",{className:"text-muted small mt-2"},"\u0110ang hi\u1EC3n th\u1ECB 30/",it.systemOnly.length," \u0111\u01A1n.")))),X==="matches"&&Array.isArray(it.matches)&&it.matches.length>0&&React.createElement("div",{className:"card border-0 shadow-sm mb-2"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2"},React.createElement("div",{className:"fw-semibold"},"\u0110\u01A1n \u0111\xE3 kh\u1EDBp"),React.createElement("div",{className:"d-flex flex-wrap align-items-center gap-2"},ut?React.createElement("span",{className:"text-muted small"},ut):null,React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",disabled:vt||!(_t&&_t.size),onClick:Sn},"\u0110\xE1nh d\u1EA5u \u0111\xE3 nh\u1EADn ti\u1EC1n"))),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",{style:{width:34}},React.createElement("input",{type:"checkbox",checked:(()=>{var C;const r=Qt(ge),l=(it.matches||[]).filter(h=>{var K;const f=h==null?void 0:h.order;if(!(f!=null&&f.id))return!1;const L=String((f==null?void 0:f.status)||((K=f==null?void 0:f.raw)==null?void 0:K.status)||"").toLowerCase();return!($e&&L==="paid"||r&&!String((f==null?void 0:f.phoneNorm)||"").includes(r))});if(!l.length)return!1;for(const h of l)if(!_t.has(String(((C=h==null?void 0:h.order)==null?void 0:C.id)||"")))return!1;return!0})(),onChange:r=>{const l=!!r.target.checked;x(C=>{var K;const h=new Set(C),f=Qt(ge),L=(it.matches||[]).filter(b=>{var W;const A=b==null?void 0:b.order;if(!(A!=null&&A.id))return!1;const D=String((A==null?void 0:A.status)||((W=A==null?void 0:A.raw)==null?void 0:W.status)||"").toLowerCase();return!($e&&D==="paid"||f&&!String((A==null?void 0:A.phoneNorm)||"").includes(f))});for(const b of L){const A=String(((K=b==null?void 0:b.order)==null?void 0:K.id)||"").trim();A&&(l?h.add(A):h.delete(A))}return h})}})),React.createElement("th",null,"Order ID"),React.createElement("th",null,"Ng\xE0y"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"Excel"),React.createElement("th",null,"H\u1EC7 th\u1ED1ng"),React.createElement("th",{className:"text-end"},"Thu h\u1ED9"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"))),React.createElement("tbody",null,(it.matches||[]).filter(r=>{var f;const l=r==null?void 0:r.order;if(!(l!=null&&l.id))return!1;const C=String((l==null?void 0:l.status)||((f=l==null?void 0:l.raw)==null?void 0:f.status)||"").toLowerCase();if($e&&C==="paid")return!1;const h=Qt(ge);return!(h&&!String((l==null?void 0:l.phoneNorm)||"").includes(h))}).slice(0,50).map(r=>{var h,f,L,K;const l=r.order,C=String(l.id);return React.createElement("tr",{key:`match-${C}`},React.createElement("td",null,React.createElement("input",{type:"checkbox",checked:_t.has(C),onChange:b=>{const A=!!b.target.checked;x(D=>{const W=new Set(D);return A?W.add(C):W.delete(C),W})}})),React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",onClick:()=>{kt(l||null),Y(!0)}},C)),React.createElement("td",{className:"text-muted"},window.KTM.date.formatDateTime(l.created_at)),React.createElement("td",{className:"text-muted"},l.phone||"\u2014"),React.createElement("td",{style:{minWidth:240}},((h=r==null?void 0:r.group)==null?void 0:h.productDisplay)||"\u2014"),React.createElement("td",{style:{minWidth:240}},l.productSummary||"\u2014"),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(l.cod)),React.createElement("td",null,React.createElement("span",{className:`badge ${String((l==null?void 0:l.status)||((f=l==null?void 0:l.raw)==null?void 0:f.status)||"").toLowerCase()==="paid"?"bg-primary":"bg-secondary"}`},String((l==null?void 0:l.status)||((L=l==null?void 0:l.raw)==null?void 0:L.status)||"").toLowerCase()==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":(l==null?void 0:l.status)||((K=l==null?void 0:l.raw)==null?void 0:K.status)||"\u2014")))})))),React.createElement("div",{className:"text-muted small mt-2"},"Hi\u1EC3n th\u1ECB t\u1ED1i \u0111a 50 \u0111\u01A1n. D\xF9ng l\u1ECDc S\u0110T \u0111\u1EC3 thu h\u1EB9p.")),React.createElement("div",{className:"d-md-none"},(()=>{const r=(it.matches||[]).filter(h=>{var b;const f=h==null?void 0:h.order;if(!(f!=null&&f.id))return!1;const L=String((f==null?void 0:f.status)||((b=f==null?void 0:f.raw)==null?void 0:b.status)||"").toLowerCase();if($e&&L==="paid")return!1;const K=Qt(ge);return!(K&&!String((f==null?void 0:f.phoneNorm)||"").includes(K))}).slice(0,50),l=r.map(h=>{var f;return String(((f=h==null?void 0:h.order)==null?void 0:f.id)||"").trim()}).filter(Boolean),C=(()=>{if(!l.length)return!1;for(const h of l)if(!_t.has(h))return!1;return!0})();return React.createElement(React.Fragment,null,React.createElement("div",{className:"d-flex align-items-center justify-content-between mb-2"},React.createElement("label",{className:"d-flex align-items-center gap-2 small mb-0"},React.createElement("input",{type:"checkbox",checked:C,disabled:!l.length,onChange:h=>{const f=!!h.target.checked;x(L=>{const K=new Set(L);for(const b of l)f?K.add(b):K.delete(b);return K})}}),React.createElement("span",null,"Ch\u1ECDn t\u1EA5t c\u1EA3 (\u0111ang hi\u1EC3n th\u1ECB)")),React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none",disabled:!l.length,onClick:()=>{x(h=>{const f=new Set(h);for(const L of l)f.delete(L);return f})}},"B\u1ECF ch\u1ECDn")),r.map(h=>{var b,A,D;const f=h==null?void 0:h.order,L=String((f==null?void 0:f.id)||"").trim(),K=String((f==null?void 0:f.status)||((b=f==null?void 0:f.raw)==null?void 0:b.status)||"").toLowerCase();return React.createElement("div",{key:`match-m-${L||String((f==null?void 0:f.created_at)||"")}`,className:"recon-mobile-card recon-mobile-card-success"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"d-flex align-items-center gap-2",style:{minWidth:0}},React.createElement("input",{type:"checkbox",checked:!!L&&_t.has(L),onChange:W=>{const st=!!W.target.checked;x(Nt=>{const rt=new Set(Nt);return L&&(st?rt.add(L):rt.delete(L)),rt})}}),React.createElement("button",{type:"button",className:"btn btn-link btn-sm p-0 text-decoration-none text-truncate",onClick:()=>{kt(f||null),Y(!0)}},L||"\u2014")),React.createElement("span",{className:`badge ${K==="paid"?"bg-primary":"bg-secondary"}`},K==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":(f==null?void 0:f.status)||((A=f==null?void 0:f.raw)==null?void 0:A.status)||"\u2014")),React.createElement("div",{className:"small text-muted mt-1"},window.KTM.date.formatDateTime(f==null?void 0:f.created_at),f!=null&&f.phone?` \u2022 ${f.phone}`:""),React.createElement("div",{className:"recon-mobile-kv mt-2"},React.createElement("span",{className:"text-muted"},"Thu h\u1ED9"),React.createElement("span",{className:"fw-semibold"},window.KTM.money.formatNumber(f==null?void 0:f.cod))),React.createElement("div",{className:"recon-mobile-value mt-2"},React.createElement("span",{className:"text-muted"},"Excel:")," ",((D=h==null?void 0:h.group)==null?void 0:D.productDisplay)||"\u2014"),React.createElement("div",{className:"recon-mobile-value mt-1"},React.createElement("span",{className:"text-muted"},"H\u1EC7 th\u1ED1ng:")," ",(f==null?void 0:f.productSummary)||"\u2014"))}))})(),React.createElement("div",{className:"text-muted small mt-2"},"Hi\u1EC3n th\u1ECB t\u1ED1i \u0111a 50 \u0111\u01A1n. D\xF9ng l\u1ECDc S\u0110T \u0111\u1EC3 thu h\u1EB9p."))))))),React.createElement(AdminDrawer,{open:q,title:dt?`Order #${dt.id}`:"Order",subtitle:dt?`${dt.phone||""} \u2022 ${window.KTM.money.formatNumber(Number(dt.cod||0))}`:"",onClose:()=>{Y(!1),kt(null)}},dt?React.createElement("div",{className:"small"},React.createElement("div",{className:"mb-2"},React.createElement("div",null,React.createElement("span",{className:"text-muted"},"Tr\u1EA1ng th\xE1i:")," ",dt.status||"\u2014"),React.createElement("div",null,React.createElement("span",{className:"text-muted"},"created_at:")," ",window.KTM.date.formatDateTime(dt.created_at)),React.createElement("div",null,React.createElement("span",{className:"text-muted"},"updated_at:")," ",dt.updated_at?window.KTM.date.formatDateTime(dt.updated_at):"\u2014"),React.createElement("div",null,React.createElement("span",{className:"text-muted"},"S\u1EA3n ph\u1EA9m:")," ",dt.productSummary||"\u2014")),React.createElement("div",{className:"fw-semibold mb-1"},"Line items"),React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"#"),React.createElement("th",null,"product_id"),React.createElement("th",{className:"text-end"},"qty"),React.createElement("th",{className:"text-end"},"price"),React.createElement("th",{className:"text-end"},"total"))),React.createElement("tbody",null,(Array.isArray((me=dt==null?void 0:dt.raw)==null?void 0:me.items)?dt.raw.items:[]).map((r,l)=>{var K,b,A,D,W,st;const C=String((b=(K=r==null?void 0:r.product_id)!=null?K:r==null?void 0:r.id)!=null?b:"").trim(),h=Number((D=(A=r==null?void 0:r.qty)!=null?A:r==null?void 0:r.quantity)!=null?D:0)||0,f=Number((st=(W=r==null?void 0:r.price)!=null?W:r==null?void 0:r.unit_price)!=null?st:0)||0,L=h*f;return React.createElement("tr",{key:`li-${l}-${C}`},React.createElement("td",{className:"text-muted"},l+1),React.createElement("td",{className:"text-muted"},C||"\u2014"),React.createElement("td",{className:"text-end"},h),React.createElement("td",{className:"text-end"},window.KTM.money.formatNumber(f)),React.createElement("td",{className:"text-end fw-semibold"},window.KTM.money.formatNumber(L)))}))))):null))}function AdminApp(){const[P,j]=useState(!1),[F,wt]=useState(""),[ot,J]=useState(null),[V,Et]=useState("search"),[Ht,Ct]=useState(()=>loadAdminPins()),[Jt,re]=useState(()=>loadAdminRecent()),[Ft,Vt]=useState(null),[it,Lt]=useState(""),[X,pe]=useState([]),[ge,_e]=useState(null),[Gt,se]=useState(!1),[Kt,ye]=useState(null),[$e,on]=useState(!0),[ee,Le]=useState([]),[Be,$]=useState(!1),[M,z]=useState(null),[vt,St]=useState(!1),[ut,ht]=useState(!1),[_t,x]=useState(""),[q,Y]=useState(()=>loadAdminSettings()),[dt,kt]=useState(null),[$t,Zt]=useState([]);useEffect(()=>{const p=localStorage.getItem("ktm_admin_session");if(p)try{const G=JSON.parse(p);G.expiry>Date.now()?(j(!0),J(G.user)):localStorage.removeItem("ktm_admin_session")}catch(G){localStorage.removeItem("ktm_admin_session")}},[]),useEffect(()=>{P&&Me()},[P]),useEffect(()=>{const p=()=>{try{const at=document.querySelector(".admin-topbar");if(!at)return;const Pt=at.getBoundingClientRect(),jt=Math.max(0,Math.round(Pt.height));document.documentElement.style.setProperty("--ktm-admin-sticky-top",`${jt+10}px`)}catch(at){}};p(),window.addEventListener("resize",p);const G=setTimeout(p,0);return()=>{clearTimeout(G),window.removeEventListener("resize",p)}},[P,V]),useEffect(()=>{var at,Pt;const p=window.visualViewport,G=()=>{try{const jt=Number(window.innerHeight)||0,Ut=Number(p==null?void 0:p.height)||jt,xe=Number(p==null?void 0:p.offsetTop)||0,ae=Math.max(0,Math.round(jt-Ut-xe));document.documentElement.style.setProperty("--ktm-visual-inset-bottom",`${ae}px`)}catch(jt){}};G(),window.addEventListener("resize",G);try{(at=p==null?void 0:p.addEventListener)==null||at.call(p,"resize",G),(Pt=p==null?void 0:p.addEventListener)==null||Pt.call(p,"scroll",G)}catch(jt){}return()=>{var jt,Ut;window.removeEventListener("resize",G);try{(jt=p==null?void 0:p.removeEventListener)==null||jt.call(p,"resize",G),(Ut=p==null?void 0:p.removeEventListener)==null||Ut.call(p,"scroll",G)}catch(xe){}}},[]),useEffect(()=>{if(!P)return;const p=at=>{if(!at)return!1;const Pt=String(at.tagName||"").toLowerCase();return!!(Pt==="input"||Pt==="textarea"||Pt==="select"||at.isContentEditable)},G=at=>{if(!at||at.ctrlKey||at.metaKey||at.altKey||p(at.target))return;const Pt=at.key;(Pt==="/"||Pt==="N"||Pt==="n"||Pt==="Escape"||Pt==="j"||Pt==="J"||Pt==="k"||Pt==="K")&&(Pt==="/"&&at.preventDefault(),window.dispatchEvent(new CustomEvent("ktm-admin-hotkey",{detail:{key:Pt}})))};return document.addEventListener("keydown",G),()=>document.removeEventListener("keydown",G)},[P]),useEffect(()=>{P&&re(p=>{const G=Array.isArray(p)?p:[],at=[V,...G.filter(Pt=>Pt!==V)].slice(0,8);return saveAdminRecent(at),at})},[P]);const Yt=p=>{const G=String(p||"").trim();G&&re(at=>{const Pt=Array.isArray(at)?at:[],jt=[G,...Pt.filter(Ut=>Ut!==G)].slice(0,8);return saveAdminRecent(jt),jt})},Se=p=>{const G=String(p||"").trim();G&&Ct(at=>{const Pt=Array.isArray(at)?at:[],Ut=Pt.includes(G)?Pt.filter(xe=>xe!==G):[G,...Pt].slice(0,10);return saveAdminPins(Ut),Ut})};useEffect(()=>{if(!P)return;let p=!1;return(async()=>{try{const G=await fetchAdminSettingsFromServer();if(p)return;Y(G),saveAdminSettings(G)}catch(G){}})(),()=>{p=!0}},[P]);const Pe=async(p,G)=>{wt("");try{const at=await window.KTM.api.postJSON(`${API_BASE}/api/auth/login`,{username:p,password:G},"\u0110\u0103ng nh\u1EADp th\u1EA5t b\u1EA1i"),Pt={user:at.user,token:at.token,expiry:Date.now()+100*365*24*60*60*1e3};localStorage.setItem("ktm_admin_session",JSON.stringify(Pt)),J(at.user),j(!0)}catch(at){wt(at.message)}},xt=()=>{localStorage.removeItem("ktm_admin_session"),j(!1),J(null),pe([]),_e(null)},ne=(p,G="success",at=null)=>{const Pt=Date.now()+Math.floor(Math.random()*1e3);if(p&&typeof p=="object"){const Ut=p;Le(xe=>[...xe,{id:Pt,message:String(Ut.message||""),type:String(Ut.type||G||"success"),actionLabel:Ut.actionLabel||null,onAction:typeof Ut.onAction=="function"?Ut.onAction:null,durationMs:Ut.durationMs||null}]);return}const jt=at&&typeof at=="object"?at:null;Le(Ut=>[...Ut,{id:Pt,message:String(p||""),type:String(G||"success"),actionLabel:(jt==null?void 0:jt.actionLabel)||null,onAction:typeof(jt==null?void 0:jt.onAction)=="function"?jt.onAction:null,durationMs:(jt==null?void 0:jt.durationMs)||null}])},Je=p=>{Le(G=>G.filter(at=>at.id!==p))},Me=async(p=null)=>{on(!0);try{const G=p?`${API_BASE}/api/albums?parent_id=${p}`:`${API_BASE}/api/albums?parent_id=root`,at=await window.KTM.api.getJSON(G,"L\u1ED7i t\u1EA3i danh s\xE1ch album");pe(Array.isArray(at)?at:[])}catch(G){console.error(G),ne("L\u1ED7i t\u1EA3i danh s\xE1ch album","danger")}on(!1)},mn=()=>{ye(null),se(!0)},je=p=>{Qt(p),St(!0)},yn=async(p,G="modal")=>{try{const at=Kt&&Kt.uuid;!at&&dt&&(p.parent_id=dt.uuid);const Pt=at?`${API_BASE}/api/albums/${Kt.uuid||Kt.id}`:`${API_BASE}/api/albums`;at?await window.KTM.api.putJSON(Pt,p,"L\u1ED7i c\u1EADp nh\u1EADt"):await window.KTM.api.postJSON(Pt,p,"L\u1ED7i t\u1EA1o"),ne(at?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"T\u1EA1o th\xE0nh c\xF4ng!","success"),G==="drawer"?(St(!1),ye(null),Me(dt==null?void 0:dt.uuid),at&&M&&z({...M,...p})):(se(!1),ye(null),Me(dt==null?void 0:dt.uuid))}catch(at){ne(at.message,"danger")}},vn=p=>{_e(p)},E=p=>{if(p==="root")Zt([]),kt(null),Me(null);else if(p){const G=$t.findIndex(at=>at.uuid===p.uuid);G>=0&&(Zt($t.slice(0,G+1)),kt(p),Me(p.uuid))}else{const G=[...$t];G.pop();const at=G[G.length-1]||null;Zt(G),kt(at),Me(at==null?void 0:at.uuid)}},ct=async p=>{const G=`X\xF3a folder "${p.title}"? T\u1EA5t c\u1EA3 folder con v\xE0 \u1EA3nh b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`;if(confirm(G))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${p.uuid||p.id}`,"L\u1ED7i x\xF3a album"),ne("\u0110\xE3 x\xF3a","success"),Me(dt==null?void 0:dt.uuid)}catch(at){ne("L\u1ED7i x\xF3a album","danger")}},Qt=async p=>{p&&($(!0),x(""),ht(!1),St(!1),z(p))},Ke=()=>{$(!1),ht(!1),x(""),St(!1),z(null)},un=p=>{St(!0)};if(!P)return React.createElement(LoginPage,{onLogin:Pe,error:F});const ze=()=>{const p=new Date,G=p.getFullYear(),at=String(p.getMonth()+1).padStart(2,"0");return`${G}-${at}`};function Ue(){const[p,G]=useState(()=>{var Ut;return String((Ut=q==null?void 0:q.ship_percent)!=null?Ut:DEFAULT_SHIP_PERCENT)}),[at,Pt]=useState(!1);return useEffect(()=>{var Ut;G(String((Ut=q==null?void 0:q.ship_percent)!=null?Ut:DEFAULT_SHIP_PERCENT))},[q==null?void 0:q.ship_percent]),React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-cog me-2 text-warning"}),"C\xE0i \u0111\u1EB7t")),React.createElement("div",{className:"card p-3"},React.createElement("form",{onSubmit:async Ut=>{Ut.preventDefault(),Pt(!0);const xe=saveAdminSettings({ship_percent:p});try{const ae=await saveAdminSettingsToServer(xe);Y(ae),saveAdminSettings(ae),ne("\u0110\xE3 l\u01B0u c\xE0i \u0111\u1EB7t v\xE0o DB","success")}catch(ae){Y(xe),ne("Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c DB, \u0111\xE3 l\u01B0u t\u1EA1m tr\xEAn m\xE1y","warning")}finally{Pt(!1)}}},React.createElement("div",{className:"mb-2 text-muted small"},"\xC1p d\u1EE5ng cho th\u1ED1ng k\xEA hoa h\u1ED3ng khi \u0111\u01A1n h\xE0ng kh\xF4ng ghi ph\xED ship trong ghi ch\xFA s\u1EA3n ph\u1EA9m."),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ph\xED ship (%) khi kh\xF4ng c\xF3 ship"),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",value:p,min:"0",max:"100",step:"0.01",onChange:Ut=>G(Ut.target.value)}),React.createElement("span",{className:"input-group-text"},"%")),React.createElement("div",{className:"form-text"},"M\u1EB7c \u0111\u1ECBnh: ",DEFAULT_SHIP_PERCENT,"%")),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:at},at?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u c\xE0i \u0111\u1EB7t"))))}function H(){const[p,G]=useState(ze()),[at,Pt]=useState(!0),jt=useRef(null),Ut=useRef(null),[xe,ae]=useState(0),[pn,Xe]=useState(!1),cn=useRef(0),Nn=()=>({statusCounts:{draft:0,pending:0,processing:0,done:0,paid:0,canceled:0,other:0},activeOrders:0,totalQty:0,totalRevenue:0,doneRevenue:0,tempCommission:0,tempCommissionAll:0,products:[],customers:[],days:[],uniqueCustomers:0,avgOrderValue:0,avgQtyPerOrder:0}),[ie,hn]=useState(Nn),Dn=useRef(new Map),Sn=normalizeShipPercent(q==null?void 0:q.ship_percent),{formatNumber:me,formatVND:r}=window.KTM.money,l=async(O,mt=!1)=>{var Ie,en;const Xt=String(O||"").trim();if(!Xt)return Nn();const fe=`${Xt}|${Sn}`,Ce=(Ie=Dn.current)==null?void 0:Ie.get(fe);if(!mt&&Ce)return Ce;const Ye=`${API_BASE}/api/orders?resource=stats&month=${encodeURIComponent(Xt)}&ship_percent=${encodeURIComponent(Sn)}`,Ne=await window.KTM.api.getJSON(Ye,"L\u1ED7i t\u1EA3i th\u1ED1ng k\xEA"),Ee=Ne!=null&&Ne.stats&&(Ne!=null&&Ne.meta)?Ne.stats:Ne,Qe=Ee&&typeof Ee=="object"?Ee:Nn();return(en=Dn.current)==null||en.set(fe,Qe),Qe},C=async(O=!1)=>{Pt(!0);try{const mt=await l(p,O);hn(mt)}catch(mt){console.error("Load stats error:",mt),hn(Nn())}finally{Pt(!1)}};useEffect(()=>{C()},[p,Sn]);const h=(O,mt)=>{const Xt=String(O||"").trim(),fe=Xt.match(/^(\d{4})-(\d{2})$/);if(!fe)return Xt;const Ce=Number(fe[1]),Ye=Number(fe[2])-1,Ne=new Date(Ce,Ye,1);Ne.setMonth(Ne.getMonth()+Number(mt||0));const Ee=Ne.getFullYear(),Qe=String(Ne.getMonth()+1).padStart(2,"0");return`${Ee}-${Qe}`},f=ze(),L=h(f,-5),K=O=>{const mt=String(O||"").trim();return mt?mt>=L&&mt<=f:!1},b=O=>{const mt=String(O||"").trim();return mt&&(mt<L?L:mt>f?f:mt)},A=O=>{const mt=Date.now();mt-Number(cn.current||0)<1200||(cn.current=mt,ne(O==="future"?"Kh\xF4ng xem \u0111\u01B0\u1EE3c th\xE1ng t\u01B0\u01A1ng lai":"Ch\u1EC9 xem t\u1ED1i \u0111a 5 th\xE1ng g\u1EA7n nh\u1EA5t","warning"))},D=(O,mt,Xt)=>Math.max(mt,Math.min(Xt,O)),W=()=>{var O;return Math.max(320,Number((O=Ut.current)==null?void 0:O.clientWidth)||360)},st=()=>{const O=W();return D(Math.floor(O*.35),110,180)},Nt=()=>{const O=W();return D(Math.floor(O*.22),70,140)},rt=O=>{try{if(!(O!=null&&O.touches)||O.touches.length!==1||pn)return;const mt=O.target;if(mt&&typeof mt.closest=="function"&&mt.closest('input, textarea, select, button, a, [role="button"], [contenteditable="true"], .dropdown-menu, .modal')){jt.current=null;return}const Xt=O.touches[0];jt.current={x:Xt.clientX,y:Xt.clientY,at:Date.now(),swiping:!1}}catch(mt){jt.current=null}},Dt=O=>{const mt=jt.current;if(!mt||pn)return;const Xt=(O==null?void 0:O.touches)&&O.touches[0];if(!Xt)return;const fe=Xt.clientX-mt.x,Ce=Xt.clientY-mt.y,Ye=Math.abs(fe),Ne=Math.abs(Ce);if(!mt.swiping)if(Ye>12&&Ye>Ne*1.2)mt.swiping=!0,Xe(!1);else return;const Ee=st();ae(D(fe,-Ee,Ee))},It=O=>{const mt=jt.current;if(jt.current=null,!mt||pn||!mt.swiping){ae(0);return}const Xt=(O==null?void 0:O.changedTouches)&&O.changedTouches[0];if(!Xt)return;const fe=Xt.clientX-mt.x,Ce=Xt.clientY-mt.y,Ye=Date.now()-mt.at,Ne=Math.abs(fe),Ee=Math.abs(Ce);if(Ye>1e3)return;if(Ne<30){ae(0);return}if(Ne<Ee*1.5)return;const Qe=Nt(),Ie=Ne>=Qe,en=fe>0?1:-1;if(!Ie){Xe(!0),ae(0),setTimeout(()=>Xe(!1),220);return}const gn=en>0?-1:1,tt=h(p,gn);if(!K(tt)){Xe(!0),ae(en*Math.floor(st()*.55)),setTimeout(()=>{ae(0),setTimeout(()=>Xe(!1),200)},140),A(tt>f?"future":"past");return}Xe(!0),ae(en*st()),setTimeout(()=>{G(s=>h(s,gn)),ae(-en*st()),requestAnimationFrame(()=>{requestAnimationFrame(()=>{ae(0),setTimeout(()=>Xe(!1),220)})})},140)},Wt=()=>{jt.current=null,ae(0)},At=O=>{var mt,Xt;try{if(!O||O.pointerType==="touch"||typeof O.button=="number"&&O.button!==0||pn)return;const fe=O.target;if(fe&&typeof fe.closest=="function"&&fe.closest('input, textarea, select, button, a, [role="button"], [contenteditable="true"], .dropdown-menu, .modal')){jt.current=null;return}jt.current={x:O.clientX,y:O.clientY,at:Date.now(),swiping:!1};try{(Xt=(mt=O.currentTarget)==null?void 0:mt.setPointerCapture)==null||Xt.call(mt,O.pointerId)}catch(Ce){}}catch(fe){jt.current=null}},ue=O=>{try{if(!O||O.pointerType==="touch")return;const mt=jt.current;if(!mt||pn)return;const Xt=O.clientX-mt.x,fe=O.clientY-mt.y,Ce=Math.abs(Xt),Ye=Math.abs(fe);if(!mt.swiping)if(Ce>12&&Ce>Ye*1.2)mt.swiping=!0,Xe(!1);else return;const Ne=st();ae(D(Xt,-Ne,Ne))}catch(mt){}},pt=O=>{try{if(!O||O.pointerType==="touch")return;const mt=jt.current;if(jt.current=null,!mt||pn||!mt.swiping){ae(0);return}const Xt=O.clientX-mt.x,fe=O.clientY-mt.y,Ce=Date.now()-mt.at,Ye=Math.abs(Xt),Ne=Math.abs(fe);if(Ce>1e3)return;if(Ye<30){ae(0);return}if(Ye<Ne*1.5)return;const Ee=Nt(),Qe=Ye>=Ee,Ie=Xt>0?1:-1;if(!Qe){Xe(!0),ae(0),setTimeout(()=>Xe(!1),220);return}const en=Ie>0?-1:1,gn=h(p,en);if(!K(gn)){Xe(!0),ae(Ie*Math.floor(st()*.55)),setTimeout(()=>{ae(0),setTimeout(()=>Xe(!1),200)},140),A(gn>f?"future":"past");return}Xe(!0),ae(Ie*st()),setTimeout(()=>{G(tt=>h(tt,en)),ae(-Ie*st()),requestAnimationFrame(()=>{requestAnimationFrame(()=>{ae(0),setTimeout(()=>Xe(!1),220)})})},140)}catch(mt){jt.current=null}},zt=()=>{jt.current=null,ae(0)},De=xe>0?"Th\xE1ng tr\u01B0\u1EDBc":xe<0?"Th\xE1ng sau":"",ke=xe>0?h(p,-1):xe<0?h(p,1):"",ve=ke&&K(ke)?ke:"",Bt=Math.min(1,Math.abs(xe)/Math.max(1,Nt()));return React.createElement("div",{className:"product-manager pb-5 mb-4 stats-manager",ref:Ut,style:{touchAction:"pan-y",transform:`translateX(${xe}px)`,transition:pn?"transform 220ms ease":"none",willChange:"transform"},onTouchStartCapture:rt,onTouchMoveCapture:Dt,onTouchEndCapture:It,onTouchCancelCapture:Wt,onPointerDown:At,onPointerMove:ue,onPointerUp:pt,onPointerCancel:zt},!!De&&React.createElement("div",{"aria-hidden":"true",style:{position:"fixed",left:0,right:0,top:84,zIndex:1060,pointerEvents:"none",opacity:.15+.55*Bt,transform:"translateZ(0)"}},React.createElement("div",{className:"d-flex justify-content-center"},React.createElement("div",{className:"px-3 py-2 rounded-pill bg-dark text-white shadow-sm",style:{fontSize:13}},xe>0?"\u2190":"\u2192"," ",De," \xB7 ",ve))),React.createElement(Loading,{show:at}),React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-chart-column me-2 text-warning"}),"Th\u1ED1ng k\xEA"),React.createElement("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>C(!0),disabled:at},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"Ch\u1ECDn th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:p,onChange:O=>G(O.target.value),"aria-label":"Ch\u1ECDn th\xE1ng"}))),React.createElement("div",{className:"col-12 col-md-7 d-flex gap-2 justify-content-md-end"},React.createElement("div",{className:"d-flex flex-wrap gap-2 align-self-center"},React.createElement("span",{className:"badge rounded-pill bg-secondary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-truck me-1"}),"Ship \u01B0\u1EDBc t\xEDnh: ",Sn,"%"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-receipt me-1"}),me(ie.activeOrders)," \u0111\u01A1n"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-user me-1"}),me(ie.uniqueCustomers)," kh\xE1ch"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-boxes-stacked me-1"}),me(ie.totalQty)," SL"),React.createElement("span",{className:"badge rounded-pill bg-primary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-hand-holding-dollar me-1"}),"\u0110\xE3 nh\u1EADn ti\u1EC1n: ",me(ie.statusCounts.paid),"/",me(ie.statusCounts.done)))))),React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng \u0111\u01A1n (kh\xF4ng t\xEDnh h\u1EE7y/nh\xE1p)"),React.createElement("i",{className:"fas fa-receipt text-dark"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},me(ie.activeOrders)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (t\u1EA1m t\xEDnh)"),React.createElement("i",{className:"fas fa-sack-dollar text-warning"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},r(ie.totalRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (Ho\xE0n th\xE0nh)"),React.createElement("i",{className:"fas fa-circle-check text-success"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},r(ie.doneRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-info bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng s\u1EBD nh\u1EADn (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-chart-line text-info"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},r(ie.tempCommission)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng t\u1ED5ng (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-coins text-primary"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},r(ie.tempCommissionAll))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-layer-group me-2 text-warning"}),"T\u1ED5ng quan tr\u1EA1ng th\xE1i"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},"SL TB/\u0111\u01A1n: ",ie.avgQtyPerOrder?ie.avgQtyPerOrder.toFixed(2):"0.00")),React.createElement("div",{className:"d-md-none mt-2"},React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-light bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Nh\xE1p"),React.createElement("div",{className:"fw-semibold"},me(ie.statusCounts.draft)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-secondary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("div",{className:"fw-semibold"},me(ie.statusCounts.pending)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("div",{className:"fw-semibold"},me(ie.statusCounts.processing)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-danger bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"H\u1EE7y \u0111\u01A1n"),React.createElement("div",{className:"fw-semibold"},me(ie.statusCounts.canceled)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh"),React.createElement("div",{className:"fw-semibold"},me(ie.statusCounts.done)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("div",{className:"fw-semibold"},me(ie.statusCounts.paid)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng SL"),React.createElement("div",{className:"fw-semibold"},me(ie.totalQty)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Nh\xE1p"),React.createElement("th",null,"Ch\u1EDD x\u1EED l\xFD"),React.createElement("th",null,"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("th",null,"H\u1EE7y \u0111\u01A1n"),React.createElement("th",null,"Ho\xE0n th\xE0nh"),React.createElement("th",null,"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("th",null,"Kh\xE1c"),React.createElement("th",null,"T\u1ED5ng SL"))),React.createElement("tbody",null,React.createElement("tr",null,React.createElement("td",null,me(ie.statusCounts.draft)),React.createElement("td",null,me(ie.statusCounts.pending)),React.createElement("td",null,me(ie.statusCounts.processing)),React.createElement("td",null,me(ie.statusCounts.canceled)),React.createElement("td",null,me(ie.statusCounts.done)),React.createElement("td",null,me(ie.statusCounts.paid)),React.createElement("td",null,me(ie.statusCounts.other)),React.createElement("td",null,me(ie.totalQty))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-box me-2 text-info"}),"Top s\u1EA3n ph\u1EA9m"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},ie.products.slice(0,10).map(O=>React.createElement("div",{key:O.product_id,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-info"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},O.product_name),React.createElement("div",{className:"text-muted small text-truncate"},O.product_code?`#${O.product_code} \u2022 `:"",me(O.orders)," \u0111\u01A1n \u2022 ",me(O.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},r(O.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"M\xE3"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,ie.products.slice(0,10).map(O=>React.createElement("tr",{key:O.product_id},React.createElement("td",null,O.product_name),React.createElement("td",null,O.product_code||"\u2014"),React.createElement("td",null,me(O.orders)),React.createElement("td",null,me(O.quantity)),React.createElement("td",{className:"fw-semibold"},r(O.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-user-group me-2 text-warning"}),"Top kh\xE1ch h\xE0ng"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},ie.customers.slice(0,10).map(O=>React.createElement("div",{key:O.key,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-warning"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},O.customer_name||"\u2014"),React.createElement("div",{className:"text-muted small text-truncate"},O.phone||"\u2014"," \u2022 ",me(O.orders)," \u0111\u01A1n \u2022 ",me(O.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},r(O.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,ie.customers.slice(0,10).map(O=>React.createElement("tr",{key:O.key},React.createElement("td",null,O.customer_name||"\u2014"),React.createElement("td",null,O.phone||"\u2014"),React.createElement("td",null,me(O.orders)),React.createElement("td",null,me(O.quantity)),React.createElement("td",{className:"fw-semibold"},r(O.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3 mb-4"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-calendar-day me-2 text-success"}),"Theo ng\xE0y"),React.createElement("span",{className:"badge rounded-pill bg-success bg-opacity-10 text-dark"},"DT (t\u1EA1m t\xEDnh) & ho\xE0n th\xE0nh")),React.createElement("div",{className:"d-md-none mt-2"},ie.days.map(O=>React.createElement("div",{key:O.day,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-success"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"fw-semibold"},O.day),React.createElement("div",{className:"text-muted small"},me(O.orders)," \u0111\u01A1n \u2022 ",me(O.quantity)," SL"),React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh: ",me(O.doneOrders)," \u2022 ",r(O.doneRevenue))),React.createElement("div",{className:"fw-semibold text-nowrap"},r(O.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Ng\xE0y"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"DT (t\u1EA1m t\xEDnh)"),React.createElement("th",null,"\u0110\u01A1n ho\xE0n th\xE0nh"),React.createElement("th",null,"DT ho\xE0n th\xE0nh"))),React.createElement("tbody",null,ie.days.map(O=>React.createElement("tr",{key:O.day},React.createElement("td",null,O.day),React.createElement("td",null,me(O.orders)),React.createElement("td",null,me(O.quantity)),React.createElement("td",{className:"fw-semibold"},r(O.revenue)),React.createElement("td",null,me(O.doneOrders)),React.createElement("td",{className:"fw-semibold"},r(O.doneRevenue)))))))))}return React.createElement("div",null,React.createElement(Sidebar,{activeMenu:V,onMenuChange:p=>{Yt(p),Et(p),p==="albums"&&(kt(null),Zt([]),Me(null))},onLogout:xt,currentUser:ot,pinnedMenus:Ht,recentMenus:Jt,onTogglePin:Se}),React.createElement("div",{className:"main-content"},React.createElement("header",{className:"admin-topbar",role:"banner"},(()=>{const G={search:{title:"Tra c\u1EE9u",icon:"fa-search",sub:"T\xECm nhanh s\u1EA3n ph\u1EA9m/kh\xE1ch/\u0111\u01A1n"},albums:{title:"Album",icon:"fa-images",sub:"Qu\u1EA3n l\xFD \u1EA3nh & folder"},videos:{title:"Video",icon:"fa-video",sub:"Qu\u1EA3n l\xFD video & folder"},products:{title:"S\u1EA3n ph\u1EA9m",icon:"fa-box",sub:"Danh s\xE1ch, gi\xE1, m\xF4 t\u1EA3"},orders:{title:"\u0110\u01A1n h\xE0ng",icon:"fa-receipt",sub:"T\u1EA1o & theo d\xF5i tr\u1EA1ng th\xE1i"},recon:{title:"\u0110\u1ED1i so\xE1t Excel",icon:"fa-file-excel",sub:"\u0110\u1ED1i so\xE1t c\xF4ng n\u1EE3 t\u1EEB Excel"},stats:{title:"Th\u1ED1ng k\xEA",icon:"fa-chart-column",sub:"Doanh thu & hoa h\u1ED3ng"},settings:{title:"C\xE0i \u0111\u1EB7t",icon:"fa-cog",sub:"Tu\u1EF3 ch\u1EC9nh h\u1EC7 th\u1ED1ng"}}[V]||{title:"KTM Admin",icon:"fa-tractor",sub:""},at=(ot==null?void 0:ot.username)||(ot==null?void 0:ot.name)||(ot==null?void 0:ot.email)||"Admin",Pt=(()=>{if(V!=="albums")return"";const jt=[];return jt.push("Root"),Array.isArray($t)&&$t.length>0&&jt.push(...$t.map(Ut=>Ut==null?void 0:Ut.title).filter(Boolean)),ge!=null&&ge.title&&jt.push(ge.title),jt.length>0?jt.join(" / "):""})();return React.createElement("div",{className:"admin-topbar-inner"},React.createElement("div",{className:"admin-topbar-left"},React.createElement("div",{className:"admin-page-icon","aria-hidden":"true"},React.createElement("i",{className:`fas ${G.icon}`})),React.createElement("div",{className:"admin-page-title"},React.createElement("div",{className:"admin-page-heading"},G.title),React.createElement("div",{className:"admin-page-subtitle"},Pt||G.sub))),React.createElement("div",{className:"admin-topbar-right"},V==="albums"&&React.createElement("button",{className:"btn btn-warning btn-sm admin-topbar-action",onClick:mn,title:"T\u1EA1o folder"},React.createElement("i",{className:"fas fa-plus me-2"}),React.createElement("span",{className:"d-none d-sm-inline"},"Folder")),React.createElement("a",{href:"/",className:"btn btn-outline-secondary btn-sm d-none d-md-inline-flex",title:"V\u1EC1 trang ch\u1EE7"},React.createElement("i",{className:"fas fa-home me-2"}),"Trang ch\u1EE7"),React.createElement("div",{className:"admin-user-chip",title:at},React.createElement("i",{className:"fas fa-user-circle"}),React.createElement("span",{className:"admin-user-chip-name"},at)),React.createElement("button",{className:"btn btn-outline-danger btn-sm d-md-none",onClick:xt,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"}))))})()),React.createElement("div",{className:"admin-page-body"},V==="albums"&&!ge&&React.createElement(AlbumList,{albums:X,loading:$e,currentFolder:dt,breadcrumb:$t,onSelect:vn,onCreate:mn,onEdit:je,onDelete:ct,onBack:E}),V==="search"&&React.createElement(SearchCenter,{showToast:ne,onNavigate:(p,G,at)=>{Et(p),p==="orders"&&G==="create"&&(Vt(Date.now()),Lt((at==null?void 0:at.productId)||""))}}),V==="albums"&&ge&&React.createElement(AlbumDetail,{album:ge,parentAlbum:$t.length>0?$t[$t.length-1]:null,onBack:()=>{if(ge.parentId){const p=$t.findIndex(G=>G.uuid===ge.parentId);p>=0?_e($t[p]):_e(null)}else _e(null)},onRefresh:()=>Me(dt==null?void 0:dt.uuid),showToast:ne,onNavigateToFolder:p=>{Zt(G=>[...G,ge]),_e(p)},onEditSubfolder:p=>{ye(p),se(!0)}}),V==="videos"&&React.createElement(VideoList,{showToast:ne}),V==="products"&&React.createElement(ProductManager,{showToast:ne,settings:q}),V==="orders"&&React.createElement(OrderManager,{autoOpenCreateToken:Ft,autoOpenCreateProductId:it,showToast:ne}),V==="recon"&&React.createElement(ReconExcelManager,{showToast:ne}),V==="stats"&&React.createElement(H,null),V==="settings"&&React.createElement(Ue,null))),React.createElement("nav",{className:"mobile-bottom-nav"},React.createElement("div",{className:"nav-items"},React.createElement("a",{href:"#",className:`nav-item ${V==="search"?"active":""}`,onClick:p=>{p.preventDefault(),Et("search")}},React.createElement("i",{className:"fas fa-search"}),React.createElement("span",null,"Tra c\u1EE9u")),React.createElement("a",{href:"#",className:`nav-item ${V==="albums"?"active":""}`,onClick:p=>{p.preventDefault(),Et("albums"),_e(null)}},React.createElement("i",{className:"fas fa-images"}),React.createElement("span",null,"Album")),React.createElement("a",{href:"#",className:`nav-item ${V==="videos"?"active":""}`,onClick:p=>{p.preventDefault(),Et("videos")}},React.createElement("i",{className:"fas fa-video"}),React.createElement("span",null,"Video")),React.createElement("a",{href:"#",className:`nav-item ${V==="products"?"active":""}`,onClick:p=>{p.preventDefault(),Et("products")}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",null,"S\u1EA3n ph\u1EA9m")),React.createElement("a",{href:"#",className:`nav-item ${V==="orders"?"active":""}`,onClick:p=>{p.preventDefault(),Et("orders")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",null,"\u0110\u01A1n h\xE0ng")),React.createElement("a",{href:"#",className:`nav-item ${V==="recon"?"active":""}`,onClick:p=>{p.preventDefault(),Et("recon")}},React.createElement("i",{className:"fas fa-file-excel"}),React.createElement("span",null,"\u0110\u1ED1i so\xE1t")),React.createElement("a",{href:"#",className:`nav-item ${V==="stats"?"active":""}`,onClick:p=>{p.preventDefault(),Et("stats")}},React.createElement("i",{className:"fas fa-chart-column"}),React.createElement("span",null,"Th\u1ED1ng k\xEA")))),React.createElement(AlbumModal,{show:Gt,album:Kt,parentId:dt==null?void 0:dt.uuid,onClose:()=>se(!1),onSave:yn}),React.createElement(AdminDrawer,{open:Be,title:M?M.title:"Album",subtitle:M?`${M.subfolderCount||0} subfolder \u2022 ${M.count||0} \u1EA3nh`:"",onClose:Ke,footer:vt?React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{St(!1)}},React.createElement("i",{className:"fas fa-xmark me-2"}),"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-warning fw-semibold",onClick:()=>{M&&(ye(M),yn({slug:M.id||"",title:M.title||"",description:M.description||"",cover_url:M.cover||"",parent_id:M.parentId||null},"drawer"))}},React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u")):M?React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{window.KTM.clipboard.writeText(M.title),ne("\u0110\xE3 copy t\xEAn folder","success")}},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy"),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>un(M)},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>{M&&confirm(`X\xF3a folder "${M.title}"?`)&&(ct(M),Ke())}},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a"))):null},vt&&M?React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-pen me-2 text-warning"}),"Ch\u1EC9nh s\u1EEDa"),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:M.title,onChange:p=>z({...M,title:p.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:M.description,onChange:p=>z({...M,description:p.target.value})}))):M?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"Th\xF4ng tin"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"T\xEAn"),React.createElement("div",{className:"v"},M.title),React.createElement("div",{className:"k"},"Slug"),React.createElement("div",{className:"v font-monospace"},M.id),React.createElement("div",{className:"k"},"Subfolder"),React.createElement("div",{className:"v"},M.subfolderCount||0),React.createElement("div",{className:"k"},"\u1EA2nh"),React.createElement("div",{className:"v"},M.count||0))),M.description&&React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-note-sticky me-2 text-secondary"}),"M\xF4 t\u1EA3"),React.createElement("p",null,M.description))):React.createElement("div",{className:"text-muted"},"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u")),React.createElement("div",{className:"toast-container"},ee.map(p=>React.createElement(Toast,{key:p.id,message:p.message,type:p.type,actionLabel:p.actionLabel,onAction:p.onAction,durationMs:p.durationMs,onClose:()=>Je(p.id)}))))}ReactDOM.render(React.createElement(AdminApp,null),document.getElementById("root"));function OrderManager({autoOpenCreateToken:P,autoOpenCreateProductId:j,showToast:F}){const[wt,ot]=useState([]),[J,V]=useState(0),[Et,Ht]=useState(!1),[Ct,Jt]=useState(!1),[re,Ft]=useState([]),[Vt,it]=useState(!0),[Lt,X]=useState(!1),[pe,ge]=useState([]),[_e,Gt]=useState(!1),[se,Kt]=useState(""),[ye,$e]=useState([]),[on,ee]=useState(!1),[Le,Be]=useState(""),[$,M]=useState(!1),[z,vt]=useState(null),[St,ut]=useState(null),[ht,_t]=useState(!1),[x,q]=useState(()=>{const t=new Date,n=t.getFullYear(),e=String(t.getMonth()+1).padStart(2,"0");return`${n}-${e}`}),[Y,dt]=useState(""),[kt,$t]=useState(!1),[Zt,Yt]=useState(!1),[Se,Pe]=useState(!1),[xt,ne]=useState(null),[Je,Me]=useState(!1),[mn,je]=useState(""),[yn,vn]=useState(!1),E=useRef(0),[ct,Qt]=useState(!1),[Ke,un]=useState(null),[ze,Ue]=useState(!1),[H,p]=useState(null),[G,at]=useState(()=>({left:12,top:12,placement:"bottom"})),Pt=useRef(null),jt=useRef(!1),Ut=useRef({active:!1,id:null,startX:0,startY:0,dx:0,dy:0,lock:null,pointerId:null,captured:!1}),[xe,ae]=useState(()=>({id:null,dir:null})),pn=useRef(!1),Xe=useRef(new Map),cn=useRef(null),Nn=useRef(null),ie="ktm_orders_status_sync_queue_v1",hn=useRef([]),Dn=useRef(!1),[Sn,me]=useState(()=>({})),[r,l]=useState(!1),[C,h]=useState(!1),[f,L]=useState(!1),[K,b]=useState(()=>new Set),[A,D]=useState(()=>({})),W="ktm_orders_pinned_v1",[st,Nt]=useState(()=>new Set),[rt,Dt]=useState(!1),[It,Wt]=useState(!1),[At,ue]=useState(!1),[pt,zt]=useState(""),[De,ke]=useState(()=>[]),ve=useRef(null),Bt=useRef(null),O=useRef(!1),mt=useRef({active:!1,startY:0,startX:0,fired:!1}),[Xt,fe]=useState(()=>{try{return((window==null?void 0:window.innerWidth)||1024)<768}catch(t){return!1}}),Ce=24,Ye=20,[Ne,Ee]=useState(Ce),Qe=useRef(null),Ie=useRef(null),en=useRef(!1),gn=useRef(new Map),tt=useRef({timer:null,events:[]}),s=useRef(null),d="ktm_orders_phone_tip_v1",c="ktm_orders_search_history_v1",[k,R]=useState(null),[S,w]=useState(!1),[U,lt]=useState([]),[Q,et]=useState(!1),[Ot,Mt]=useState([]),[y,gt]=useState({customer_name:"",phone:"",address:"",note:"",items:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:[{amount:"",note:""}],adjustment_amount:0,adjustment_note:"",status:"pending"}),[ft,oe]=useState([""]),[le,Ae]=useState(null),Ze=useRef({}),[qe,Ve]=useState([]),[be,nn]=useState(null),fn=useRef(null),ln=useRef(null),Z=useRef(0),nt=useRef(null),bt=useRef(0),qt=useRef(new Map),Rt=useRef(null),Tt=useRef(0),he=useRef(new Map),de=useRef(new Map),Te=useRef(""),tn=useRef(null),dn=useRef(null),xn=useRef(0),An=useRef(null),Cn=9,Mn=150,In=250,Rn=3*60*1e3,Kn=24*60*60*1e3,Gn=5*60*1e3,Bn="ktm_customer_lookup_cache_v1",ka=200,On=3,Jn=3,Xa=1,er=24*60*60*1e3,nr=120,ar=5*60*1e3,cs=80,ls=2,ds=4,ms=60,te=React.useMemo(()=>String(se||"").trim().length>0,[se]),ua=React.useMemo(()=>[{value:"draft",label:"\u0110\u01A1n nh\xE1p"},{value:"pending",label:"Ch\u1EDD x\u1EED l\xFD"},{value:"processing",label:"\u0110ang v\u1EADn chuy\u1EC3n"},{value:"done",label:"Ho\xE0n th\xE0nh"},{value:"paid",label:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},{value:"canceled",label:"H\u1EE7y \u0111\u01A1n"}],[]),us=t=>{un(t),Qt(!0)},ps=(t,n)=>{var e,a,i,o;try{const g=(e=n==null?void 0:n.getBoundingClientRect)==null?void 0:e.call(n),m=window.innerWidth||360,I=window.innerHeight||640,v=230,u=280,_=Math.min(Math.max(10,Math.round((a=g==null?void 0:g.left)!=null?a:10)),Math.max(10,m-v-10));let N=Math.round(((i=g==null?void 0:g.bottom)!=null?i:10)+8),B="bottom";N+u>I-10&&(N=Math.max(10,Math.round(((o=g==null?void 0:g.top)!=null?o:10)-8-u)),B="top"),at({left:_,top:N,placement:B})}catch(g){at({left:12,top:12,placement:"bottom"})}p(t),Ue(!0)},Un=()=>{Ue(!1),setTimeout(()=>p(null),120)};useEffect(()=>{if(!ze)return;const t=n=>{n.key==="Escape"&&Un()};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[ze]);const qn=()=>{Qt(!1),setTimeout(()=>un(null),180)},sr=()=>{l(!0)},Ca=()=>{l(!1)},hs=t=>{const n=String(t||"").trim();n&&b(e=>{const a=new Set(e);return a.has(n)?a.delete(n):a.add(n),a})};useEffect(()=>{try{const t=localStorage.getItem(W);if(!t)return;const n=JSON.parse(t);if(!Array.isArray(n))return;Nt(new Set(n.map(e=>String(e||"").trim()).filter(Boolean)))}catch(t){}},[]),useEffect(()=>{try{const t=Array.from(st||[]).map(n=>String(n||"").trim()).filter(Boolean);localStorage.setItem(W,JSON.stringify(t))}catch(t){}},[st]);const rr=t=>{const n=String(t||"").trim();n&&Nt(e=>{const a=new Set(e);return a.has(n)?a.delete(n):a.add(n),a})};useEffect(()=>{try{const t=localStorage.getItem(c);if(!t)return;const n=JSON.parse(t);if(!Array.isArray(n))return;ke(n.map(e=>String(e||"").trim()).filter(Boolean).slice(0,10))}catch(t){}},[]);const ir=t=>{try{localStorage.setItem(c,JSON.stringify(t))}catch(n){}},pa=t=>{const n=String(t||"").trim();n&&ke(e=>{const a=Array.isArray(e)?e:[],i=[n,...a.filter(o=>String(o||"").trim().toLowerCase()!==n.toLowerCase())].slice(0,10);return ir(i),i})},fs=t=>{var e;const n=String((e=t!=null?t:se)!=null?e:"").trim();zt(n),ue(!0),setTimeout(()=>{var a,i;try{(i=(a=ve.current)==null?void 0:a.focus)==null||i.call(a)}catch(o){}},0)},_n=()=>{ue(!1)};useEffect(()=>{if(!At)return;const t=n=>{n.key==="Escape"&&_n()};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[At]),useEffect(()=>{if(!Xt)return;const t=a=>{if(At||(window.scrollY||0)>6)return;const i=a.touches&&a.touches[0];i&&(mt.current={active:!0,startY:i.clientY,startX:i.clientX,fired:!1})},n=a=>{const i=mt.current;if(!(i!=null&&i.active)||i.fired||(window.scrollY||0)>6)return;const o=a.touches&&a.touches[0];if(!o)return;const g=o.clientY-i.startY,m=o.clientX-i.startX;Math.abs(m)>24||g>92&&(i.fired=!0,fs(se))},e=()=>{mt.current={active:!1,startY:0,startX:0,fired:!1}};return window.addEventListener("touchstart",t,{passive:!0}),window.addEventListener("touchmove",n,{passive:!0}),window.addEventListener("touchend",e,{passive:!0}),window.addEventListener("touchcancel",e,{passive:!0}),()=>{window.removeEventListener("touchstart",t),window.removeEventListener("touchmove",n),window.removeEventListener("touchend",e),window.removeEventListener("touchcancel",e)}},[Xt,At,se]);const gs=t=>{try{const n=bn(t==null?void 0:t.status);if(!(n==="pending"||n==="processing"))return!1;const e=new Date(t==null?void 0:t.created_at);if(!Number.isFinite(e.getTime()))return!1;const a=new Date;return e.getFullYear()===a.getFullYear()&&e.getMonth()===a.getMonth()&&e.getDate()===a.getDate()}catch(n){return!1}};useEffect(()=>{var e;let t;const n=()=>{try{fe(t?!!t.matches:((window==null?void 0:window.innerWidth)||1024)<768)}catch(a){fe(!1)}};try{t=(e=window.matchMedia)==null?void 0:e.call(window,"(max-width: 767.98px)"),t!=null&&t.addEventListener?t.addEventListener("change",n):t!=null&&t.addListener&&t.addListener(n)}catch(a){t=null}return window.addEventListener("resize",n),n(),()=>{try{t!=null&&t.removeEventListener?t.removeEventListener("change",n):t!=null&&t.removeListener&&t.removeListener(n)}catch(a){}window.removeEventListener("resize",n)}},[]),useEffect(()=>{const t="admin-sheet-open";return ct||r||ze?document.body.classList.add(t):document.body.classList.remove(t),()=>document.body.classList.remove(t)},[ct,r,ze]),useEffect(()=>{if(!ct&&!r&&!ze)return;const t=n=>{n.key==="Escape"&&(ct&&qn(),r&&Ca(),ze&&Un())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[ct,r,ze]);const or=()=>{try{if(localStorage.getItem(d))return;localStorage.setItem(d,"1"),typeof F=="function"&&F("Tip: Ch\u1EA1m S\u0110T \u0111\u1EC3 copy \u2022 Gi\u1EEF \u0111\u1EC3 g\u1ECDi","info",{durationMs:7e3})}catch(t){}},bs=t=>String((t==null?void 0:t.address)||"").replace(/\s*\n+\s*/g,", ").replace(/\s+/g," ").trim(),ys=t=>String((t==null?void 0:t.note)||"").replace(/\s*\n+\s*/g," \u2014 ").replace(/\s+/g," ").trim(),cr=t=>{const n=We(String(t||"")).replace(/[^0-9+]/g,"");if(n)try{window.location.href=`tel:${n}`}catch(e){}},vs=async t=>{var e,a,i,o,g;const n=We(String(t||"")).replace(/[^0-9+]/g,"");if(n)try{(a=(e=window==null?void 0:window.KTM)==null?void 0:e.clipboard)!=null&&a.writeText?await window.KTM.clipboard.writeText(n):await((g=(o=(i=navigator.clipboard)==null?void 0:i.writeText)==null?void 0:o.call(i,n))!=null?g:Promise.reject(new Error("Clipboard not available"))),typeof F=="function"&&F("\u0110\xE3 copy S\u0110T","success")}catch(m){typeof F=="function"&&F("Kh\xF4ng copy \u0111\u01B0\u1EE3c S\u0110T","danger")}},lr=()=>{try{const t=localStorage.getItem(ie),n=t?JSON.parse(t):[];return Array.isArray(n)?n:[]}catch(t){return[]}},Ns=t=>{try{localStorage.setItem(ie,JSON.stringify(Array.isArray(t)?t:[]))}catch(n){}},Aa=(t,n)=>{const e=String(t||"").trim();e&&me(a=>{const i={...a||{}};return n?i[e]=!0:delete i[e],i})},dr=(t,n,e)=>{const a=String(t||"").trim(),i=bn(n),o=bn(e);if(!a||!i)return;const g=Array.isArray(hn.current)?hn.current:[],m=new Map(g.map(v=>[String((v==null?void 0:v.orderId)||""),v]));m.set(a,{orderId:a,nextStatus:i,prevStatus:o,ts:Date.now()});const I=Array.from(m.values()).sort((v,u)=>(Number(v.ts)||0)-(Number(u.ts)||0));hn.current=I,Ns(I),Aa(a,!0)},Va=async()=>{if(Dn.current||!navigator.onLine)return;const t=Array.isArray(hn.current)?hn.current.slice():[];if(t.length){Dn.current=!0;try{for(const n of t){const e=String((n==null?void 0:n.orderId)||"").trim(),a=bn(n==null?void 0:n.nextStatus);if(!(!e||!a)){Aa(e,!0);try{await Zn({id:e,status:(n==null?void 0:n.prevStatus)||""},a,{silentToast:!0,skipToastBatch:!0,fromSync:!0});const i=(Array.isArray(hn.current)?hn.current:[]).filter(o=>String((o==null?void 0:o.orderId)||"")!==e);hn.current=i,Ns(i),Aa(e,!1)}catch(i){if(!navigator.onLine)break}}}}finally{Dn.current=!1}}};useEffect(()=>{const t=lr();hn.current=t;try{const n={};for(const e of t){const a=String((e==null?void 0:e.orderId)||"").trim();a&&(n[a]=!0)}me(n)}catch(n){}setTimeout(()=>Va(),600)},[]),useEffect(()=>{const t=()=>Va();window.addEventListener("online",t);const n=setInterval(()=>Va(),8e3);return()=>{clearInterval(n),window.removeEventListener("online",t)}},[]);const mr=(t,n)=>{var e;(e=t==null?void 0:t.stopPropagation)==null||e.call(t),en.current=!1,or(),Ie.current={t0:Date.now(),phoneRaw:n}},Wa=t=>{var n;(n=t==null?void 0:t.stopPropagation)==null||n.call(t),Ie.current=null},ur=(t,n)=>{var o;(o=t==null?void 0:t.stopPropagation)==null||o.call(t);const e=Ie.current;Ie.current=null;const a=Number(e==null?void 0:e.t0)||0;(a?Date.now()-a:0)>=520&&(en.current=!0,cr(n!=null?n:e==null?void 0:e.phoneRaw))},pr=t=>{const n=String(t||"").trim();if(!n)return;D(i=>({...i,[n]:Date.now()}));const e=gn.current;try{const i=e.get(n);i&&clearTimeout(i)}catch(i){}const a=setTimeout(()=>{D(i=>{const o={...i||{}};return delete o[n],o});try{e.delete(n)}catch(i){}},9e3);e.set(n,a)},ws=t=>String(t||"").replace(/\s+/g," ").trim(),hr=t=>String(t||"").replace(/[^0-9]+/g,""),ha=t=>{try{const n=new Date(t==null?void 0:t.created_at).getTime();if(!Number.isFinite(n))return 0;const e=Date.now()-n;return!Number.isFinite(e)||e<=0?0:Math.floor(e/er)}catch(n){return 0}},Ma=t=>String((t==null?void 0:t.status)||"").trim()!=="pending"?!1:ha(t)>=On,bn=t=>{const n=String(t!=null?t:"").trim().toLowerCase();return n==="cancelled"?"canceled":n},Ga=React.useMemo(()=>["draft","pending","processing","done","paid"],[]),aa=(t,n)=>{const e=bn(t);if(!e||e==="canceled")return null;const a=Ga.indexOf(e);return a<0?null:n==="left"?Ga[a+1]||null:n==="right"&&Ga[a-1]||null},Ss=t=>{var i;const n=bn(t);if(!n)return{label:"",icon:"fa-circle"};const e=((i=ua.find(o=>bn(o==null?void 0:o.value)===n))==null?void 0:i.label)||"",a=(()=>{switch(n){case"draft":return"fa-file-lines";case"pending":return"fa-hourglass-half";case"processing":return"fa-truck";case"done":return"fa-check";case"paid":return"fa-money-bill-wave";case"canceled":return"fa-ban";default:return"fa-circle"}})();return{label:e,icon:a}},Ta=t=>{if(bn(t==null?void 0:t.status)!=="draft")return null;const e=Jn-ha(t);return Number.isFinite(e)?e:null},_a=t=>{const n=Ta(t);return Number.isFinite(n)?n>0&&n<=Xa:!1},Hn=t=>{gt({customer_name:"",phone:"",address:"",note:"",items:[{product_id:t||"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:[{amount:"",note:""}],adjustment_amount:0,adjustment_note:"",status:"pending"}),oe([""]),R(null),Ae(null)};useEffect(()=>{const t=n=>{var a;if(le==null)return;const e=(a=Ze.current)==null?void 0:a[le];e&&!e.contains(n.target)&&Ae(null)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[le]);const xs=t=>window.KTM.money.parseMoney(t),ks=t=>window.KTM.money.parseSignedMoney(t),Fe=t=>window.KTM.money.formatVND(t),Pn=t=>{const e=(Array.isArray(t)?t:[]).map(a=>{var i,o;return{amount:String((i=a==null?void 0:a.amount)!=null?i:""),note:String((o=a==null?void 0:a.note)!=null?o:"")}});return e.length?e:[{amount:"",note:""}]},fr=t=>{try{const n=window.KTM.orders.getOrderAdjustmentItems(t),e=(Array.isArray(n)?n:[]).map(a=>{var i,o;return{amount:(a==null?void 0:a.amount)===0?"":String((i=a==null?void 0:a.amount)!=null?i:""),note:String((o=a==null?void 0:a.note)!=null?o:"").trim()}}).filter(a=>String(a.amount||"").trim()||String(a.note||"").trim());return e.length?e:[{amount:"",note:""}]}catch(n){return[{amount:"",note:""}]}},sa=t=>(Array.isArray(t)?t:[]).map(e=>({amount:ks(e==null?void 0:e.amount),note:String((e==null?void 0:e.note)||"").trim()})).filter(e=>e.amount!==0||!!e.note),Ja=t=>{const n=Array.isArray(t==null?void 0:t.adjustment_items)?t.adjustment_items:[],e=sa(n),a=ra(e),i=(()=>{if(!e.length)return"";const o=e.map(g=>String((g==null?void 0:g.note)||"").trim()).filter(Boolean);return o.length?o.join(" \u2022 "):e.length>1?`${e.length} m\u1EE5c`:""})();return{cleanAdjItems:e,amount:a,summaryText:i}},ra=t=>(Array.isArray(t)?t:[]).reduce((e,a)=>e+(Number(a==null?void 0:a.amount)||0),0),Ua=t=>{const n=Array.isArray(t)?t:[];return n.length?JSON.stringify(n):""},Lr=t=>window.KTM.money.parseShipFeeFromNote(t),ia=t=>window.KTM.phone.isValid(t),We=t=>window.KTM.phone.normalize(t),$a=async t=>{if(!t)return null;const n=await window.KTM.api.getJSON(`${API_BASE}/api/orders/${t}`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng");return n&&typeof n=="object"&&n.order&&typeof n.order=="object"?n.order:n},gr=(t,n)=>{var o;const e=Array.isArray(t)?t:[],a=Array.isArray(n)?n:[];if(!e.length)return a;if(!a.length)return e;const i=new Map(e.map(g=>{var m;return[String((m=g==null?void 0:g.id)!=null?m:""),g]}));for(const g of a){const m=String((o=g==null?void 0:g.id)!=null?o:"");m&&i.set(m,g)}return Array.from(i.values())},Da=async t=>{var n,e,a,i;if(!(t!=null&&t.id)||Array.isArray(t.items)&&t.items.length)return t;try{const o=(e=(n=Xe.current)==null?void 0:n.get)==null?void 0:e.call(n,String(t.id));if(o&&typeof o=="object"&&Array.isArray(o.items)&&o.items.length)return o}catch(o){}try{const o=await $a(t.id);if(o&&typeof o=="object"){try{(i=(a=Xe.current)==null?void 0:a.set)==null||i.call(a,String(t.id),o)}catch(g){}return ot(g=>Array.isArray(g)?g.map(m=>String(m==null?void 0:m.id)===String(t.id)?o:m):g),o}}catch(o){console.error("Fetch order by id error:",o)}return t},br=()=>{var t;try{const n=localStorage.getItem(Bn);if(!n)return;const e=JSON.parse(n);if(!e||typeof e!="object")return;const a=Object.entries(e);for(const[i,o]of a)!i||!o||typeof o!="object"||(t=de.current)==null||t.set(String(i),o)}catch(n){}},Ya=()=>{try{const t=de.current;if(!t||typeof t.entries!="function")return;const n=Array.from(t.entries()).filter(([a,i])=>a&&i&&typeof i=="object"&&Number.isFinite(i.ts)).sort((a,i)=>(Number(i[1].ts)||0)-(Number(a[1].ts)||0)).slice(0,ka),e={};for(const[a,i]of n)e[a]=i;localStorage.setItem(Bn,JSON.stringify(e))}catch(t){}};useEffect(()=>{br()},[]);const Cs=t=>{const n=We(t);if(!n)return null;const e=Array.isArray(wt)?wt:[];let a=null,i=-1;for(const o of e){if(!o||We(o.phone||"")!==n)continue;const g=new Date(o.created_at).getTime(),m=Number.isFinite(g)?g:0;m>=i&&(i=m,a=o)}return a?{name:String(a.customer_name||"").trim(),address:String(a.address||"").trim()}:null},As=(t,n)=>{t&&gt(e=>n&&We(e.phone)!==n?e:{...e,customer_name:t.name||e.customer_name,address:t.address||e.address})},yr=t=>{const n=Cs(t);if(!n)return;const e=We(t);gt(a=>{if(e&&We(a.phone)!==e)return a;const i={...a};return!String(a.customer_name||"").trim()&&n.name&&(i.customer_name=n.name),!String(a.address||"").trim()&&n.address&&(i.address=n.address),i})},vr=(t,n,e)=>{var a;try{const i=We(t);if(!i)return;const o=String(n||"").trim(),g=String(e||"").trim();if(!o&&!g)return;(a=de.current)==null||a.set(i,{ts:Date.now(),status:"found",customer:{phone:i,name:o||null,address:g||null}}),Ya()}catch(i){}},Ia=async t=>{var i,o,g;const n=We(t);if(!n)return;yr(n);const e=(i=de.current)==null?void 0:i.get(n);if(e&&Number.isFinite(e.ts)){const m=Date.now()-e.ts,I=e.status==="found"?Kn:Gn;if(m>=0&&m<=I){R({status:e.status,phone:n,customer:e.customer}),e.status==="found"&&e.customer&&As(e.customer,n);return}}const a=++Z.current;R({status:"loading",phone:n});try{const m=await window.KTM.api.getJSON(`${API_BASE}/api/customers?phone=${encodeURIComponent(n)}`,"L\u1ED7i tra c\u1EE9u kh\xE1ch");if(Z.current!==a)return;if(m&&m.exists&&m.customer){(o=de.current)==null||o.set(n,{ts:Date.now(),status:"found",customer:m.customer}),Ya(),R({status:"found",phone:n,customer:m.customer}),As(m.customer,n);return}(g=de.current)==null||g.set(n,{ts:Date.now(),status:"not-found",customer:null}),Ya(),R({status:"not-found",phone:n})}catch(m){if(Z.current!==a)return;console.error("Customer lookup error:",m),R({status:"error",phone:n})}},Ms=t=>{const n=We(t),e=Cs(n);gt(i=>{const o={...i,phone:n};return e&&(!String(i.customer_name||"").trim()&&e.name&&(o.customer_name=e.name),!String(i.address||"").trim()&&e.address&&(o.address=e.address)),o}),w(!1),ln.current&&(clearTimeout(ln.current),ln.current=null);const a=n;if(a.length<Cn){R(null);return}if(ia(a)&&a!==Te.current){Te.current=a,Ia(a);return}ln.current=setTimeout(()=>{const i=We(n);ia(i)&&i!==Te.current&&(Te.current=i,Ia(i))},Mn)},Ts=()=>{const t=We(y.phone);t.length<Cn||ia(t)&&t!==Te.current&&(Te.current=t,Ia(t))};useEffect(()=>(Zt?(document.body.classList.add("order-modal-open"),document.body.style.overflow="hidden"):(document.body.classList.remove("order-modal-open"),document.body.style.overflow=""),()=>{document.body.classList.remove("order-modal-open"),document.body.style.overflow=""}),[Zt]);const Ra=Array.isArray(y.items)?y.items.length:0;useEffect(()=>{if(!Zt){xn.current=Ra;return}Ra>xn.current&&setTimeout(()=>{const t=tn.current;t&&t.scrollTo({top:t.scrollHeight,behavior:"smooth"})},0),xn.current=Ra},[Zt,Ra]),useEffect(()=>()=>{ln.current&&(clearTimeout(ln.current),ln.current=null),nt.current&&(clearTimeout(nt.current),nt.current=null)},[]),useEffect(()=>{if(!Zt)return;nt.current&&(clearTimeout(nt.current),nt.current=null);const t=We((y==null?void 0:y.phone)||"");if(!ia(t)){lt([]),et(!1);return}return nt.current=setTimeout(async()=>{var i;const n=String(t),e=(i=qt.current)==null?void 0:i.get(n);if(e&&Number.isFinite(e.ts)&&Date.now()-e.ts<=Rn){lt(Array.isArray(e.orders)?e.orders:[]),et(!1);return}const a=++bt.current;et(!0);try{const o=`${API_BASE}/api/orders?search=${encodeURIComponent(t)}`,g=await window.KTM.api.getJSON(o,"L\u1ED7i t\u1EA3i l\u1ECBch s\u1EED \u0111\u01A1n theo S\u0110T");if(bt.current!==a)return;const m=Array.isArray(g)?g:Array.isArray(g==null?void 0:g.orders)?g.orders:[];lt(m);try{const I=qt.current;if(I&&typeof I.set=="function"&&(I.set(n,{ts:Date.now(),orders:m}),I.size>100)){const v=Array.from(I.entries()).sort((_,N)=>{var B,T;return(Number((B=_==null?void 0:_[1])==null?void 0:B.ts)||0)-(Number((T=N==null?void 0:N[1])==null?void 0:T.ts)||0)}),u=Math.max(0,v.length-100);for(let _=0;_<u;_++)I.delete(v[_][0])}}catch(I){}}catch(o){if(bt.current!==a)return;console.error("Phone history fetch error:",o),lt([])}finally{if(bt.current!==a)return;et(!1)}},In),()=>{nt.current&&(clearTimeout(nt.current),nt.current=null)}},[Zt,y==null?void 0:y.phone]),useEffect(()=>{Sr()},[]),useEffect(()=>{te||Yn()},[x,te]),useEffect(()=>{ga()},[]),useEffect(()=>{P&&fn.current!==P&&(fn.current=P,Pa(j))},[P]);const $n=t=>t==="draft"?"\u0110\u01A1n nh\xE1p":t==="pending"?"Ch\u1EDD x\u1EED l\xFD":t==="processing"?"\u0110ang v\u1EADn chuy\u1EC3n":t==="done"?"Ho\xE0n th\xE0nh":t==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":t==="cancelled"||t==="canceled"?"H\u1EE7y \u0111\u01A1n":t||"",oa=t=>t==="draft"?"bg-light text-dark":t==="pending"?"bg-secondary":t==="processing"?"bg-warning text-dark":t==="done"?"bg-success":t==="paid"?"bg-primary":t==="cancelled"||t==="canceled"?"bg-danger":"bg-light text-dark",zn=React.useMemo(()=>{const t=window.KTM.orders.sortOrders(wt),n=st;if(!n||!(n instanceof Set)||n.size===0)return t;const e=Array.isArray(t)?t.slice():[];return e.sort((a,i)=>{var m,I;const o=n.has(String((m=a==null?void 0:a.id)!=null?m:""))?1:0;return(n.has(String((I=i==null?void 0:i.id)!=null?I:""))?1:0)-o}),e},[wt,st]),Qa=React.useMemo(()=>window.KTM.orders.sortOrders(re),[re]),Ka=React.useMemo(()=>{const n=(Array.isArray(Qa)?Qa:[]).filter(e=>Ma(e));return n.sort((e,a)=>{const i=new Date(e==null?void 0:e.created_at).getTime(),o=new Date(a==null?void 0:a.created_at).getTime();return(Number.isFinite(i)?i:0)-(Number.isFinite(o)?o:0)}),n},[Qa]),_s=React.useMemo(()=>{const n=(Array.isArray(pe)?pe:[]).filter(e=>_a(e));return n.sort((e,a)=>{const i=new Date(e==null?void 0:e.created_at).getTime(),o=new Date(a==null?void 0:a.created_at).getTime();return(Number.isFinite(i)?i:0)-(Number.isFinite(o)?o:0)}),n},[pe]),fa=React.useMemo(()=>{if(kt)return Ka;let t=zn;if(rt){const e=st;t=(Array.isArray(t)?t:[]).filter(a=>{var i,o;return(o=e==null?void 0:e.has)==null?void 0:o.call(e,String((i=a==null?void 0:a.id)!=null?i:""))})}It&&(t=(Array.isArray(t)?t:[]).filter(e=>gs(e)));const n=String(x||"").trim();if(n){const e=a=>{try{const i=new Date(a==null?void 0:a.created_at);if(!i||Number.isNaN(i.getTime()))return"";const o=i.getFullYear(),g=String(i.getMonth()+1).padStart(2,"0");return`${o}-${g}`}catch(i){return""}};t=(Array.isArray(t)?t:[]).filter(a=>e(a)===n)}return t},[kt,Ka,zn,rt,st,It,x]),Oa=React.useMemo(()=>{if(kt)return fa;const t=String(Y||"").trim();return t?(Array.isArray(fa)?fa:[]).filter(n=>String((n==null?void 0:n.status)||"").trim()===t):fa},[fa,Y,kt]),$s=React.useMemo(()=>window.KTM.orders.sortOrders(ye),[ye]),an=React.useMemo(()=>te?$s:Oa,[Oa,te,$s]),Ds=React.useMemo(()=>{const t=Array.isArray(an)?an:[];return Xt?t.slice(0,Math.max(0,Number(Ne)||0)):t},[Xt,Ne,an]);useEffect(()=>{Xt&&Ee(Ce)},[Xt,Y,kt,x,se]),useEffect(()=>{if(!Xt)return;const t=Array.isArray(an)?an.length:0;if(Ne>=t)return;const n=Qe.current;if(!n)return;const e=new IntersectionObserver(a=>{Array.isArray(a)&&a.some(o=>o==null?void 0:o.isIntersecting)&&Ee(o=>Math.min((Number(o)||0)+Ye,t))},{root:null,rootMargin:"520px 0px",threshold:0});return e.observe(n),()=>e.disconnect()},[Xt,Ne,an]),useEffect(()=>{if(!Xt){h(!1),L(!1);return}const t=()=>{s.current||(s.current=window.requestAnimationFrame(()=>{s.current=null;const n=window.scrollY||document.documentElement.scrollTop||0;h(n>140),L(n>60)}))};return window.addEventListener("scroll",t,{passive:!0}),t(),()=>{window.removeEventListener("scroll",t),s.current&&(window.cancelAnimationFrame(s.current),s.current=null)}},[Xt]),useEffect(()=>{if(!Xt){try{document.documentElement.style.removeProperty("--ktm-mobile-bottom-nav-h")}catch(n){}return}const t=()=>{try{const n=document.querySelector(".mobile-bottom-nav"),e=n&&n.offsetHeight?n.offsetHeight:0;document.documentElement.style.setProperty("--ktm-mobile-bottom-nav-h",`${e}px`)}catch(n){}};return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[Xt]);const Xn=React.useMemo(()=>{const t=Array.isArray(an)?an:[],n={all:t.length,draft:0,pending:0,processing:0,done:0,paid:0,canceled:0,other:0};for(const e of t){const a=bn(e==null?void 0:e.status);a==="draft"?n.draft+=1:a==="pending"?n.pending+=1:a==="processing"?n.processing+=1:a==="done"?n.done+=1:a==="paid"?n.paid+=1:a==="canceled"?n.canceled+=1:n.other+=1}return n},[an]),Nr=React.useMemo(()=>{const t=st;return!t||t.size===0?0:(Array.isArray(zn)?zn:[]).reduce((n,e)=>{var a;return n+(t.has(String((a=e==null?void 0:e.id)!=null?a:""))?1:0)},0)},[st,zn]),wr=React.useMemo(()=>(Array.isArray(zn)?zn:[]).filter(t=>gs(t)).length,[zn]),jn=React.useMemo(()=>{const t=new Date,n=t.getFullYear(),e=String(t.getMonth()+1).padStart(2,"0");return`${n}-${e}`},[]),Fn=t=>{if(te&&Kt(""),t==="thisMonth"){$t(!1),dt(""),q(jn);return}if(t==="overduePending"){q(""),$t(!0),dt("pending");return}if(t==="draftExpiring"){$t(!1),dt("draft"),q(""),ga();return}if(t==="all"){$t(!1),dt(""),q(jn);return}},ca=t=>window.KTM.date.formatDateTime(t),Sr=async()=>{try{const t=await window.KTM.api.getJSON(`${API_BASE}/api/products?fields=order`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");Ve(Array.isArray(t)?t:[])}catch(t){console.error("Load products error:",t),Ve([])}},Yn=async()=>{it(!0),Jt(!1);try{const n=new URLSearchParams;x&&n.set("month",String(x)),n.set("includeItems","0"),n.set("meta","1"),n.set("limit",String(ms)),n.set("offset","0");const e=`${API_BASE}/api/orders?${n.toString()}`,a=await window.KTM.api.getJSON(e,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),i=Array.isArray(a)?a:Array.isArray(a==null?void 0:a.orders)?a.orders:[],o=!Array.isArray(a)&&a&&typeof a=="object"&&a.meta||null;ot(Array.isArray(i)?i:[]),V(Array.isArray(i)?i.length:0),Ht(!!(o!=null&&o.hasMore)),ga()}catch(n){console.error("Load orders error:",n),ot([]),V(0),Ht(!1)}finally{it(!1),Jt(!1)}},xr=async()=>{if(!(Vt||Ct||te)&&Et){Jt(!0);try{const t=new URLSearchParams;x&&t.set("month",String(x)),t.set("includeItems","0"),t.set("meta","1"),t.set("limit",String(ms)),t.set("offset",String(J));const n=`${API_BASE}/api/orders?${t.toString()}`,e=await window.KTM.api.getJSON(n,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),a=Array.isArray(e)?e:Array.isArray(e==null?void 0:e.orders)?e.orders:[],i=!Array.isArray(e)&&e&&typeof e=="object"&&e.meta||null;ot(o=>gr(o,Array.isArray(a)?a:[])),V(o=>o+(Array.isArray(a)?a.length:0)),Ht(!!(i!=null&&i.hasMore))}catch(t){console.error("Load more orders error:",t)}finally{Jt(!1)}}},Is=async t=>{var i;const n=ws(t);if(!n){$e([]),Be(""),ee(!1);return}const e=hr(n);if(n.length<ls&&e.length<ds){$e([]),Be(`Nh\u1EADp \xEDt nh\u1EA5t ${ls} k\xFD t\u1EF1 (ho\u1EB7c ${ds} s\u1ED1) \u0111\u1EC3 search nhanh`),ee(!1);return}try{const o=(i=he.current)==null?void 0:i.get(n);if(o&&Number.isFinite(o.ts)&&Date.now()-o.ts<=ar){$e(Array.isArray(o.results)?o.results:[]),Be(""),ee(!1);return}}catch(o){}const a=++Tt.current;ee(!0),Be("");try{const o=`${API_BASE}/api/orders?search=${encodeURIComponent(n)}`,g=await window.KTM.api.getJSON(o,"L\u1ED7i search \u0111\u01A1n h\xE0ng");if(Tt.current!==a)return;const m=Array.isArray(g)?g:[];$e(m);try{const I=he.current;if(I&&typeof I.set=="function"&&(I.set(n,{ts:Date.now(),results:m}),I.size>cs)){const v=Array.from(I.entries()).sort((_,N)=>{var B,T;return(Number((B=_==null?void 0:_[1])==null?void 0:B.ts)||0)-(Number((T=N==null?void 0:N[1])==null?void 0:T.ts)||0)}),u=Math.max(0,v.length-cs);for(let _=0;_<u;_++)I.delete(v[_][0])}}catch(I){}}catch(o){if(Tt.current!==a)return;console.error("Order search error:",o),$e([]),Be((o==null?void 0:o.message)||"Search l\u1ED7i")}finally{if(Tt.current!==a)return;ee(!1)}};useEffect(()=>{Rt.current&&(clearTimeout(Rt.current),Rt.current=null);const t=ws(se);if(!t){$e([]),Be(""),ee(!1);return}return kt&&$t(!1),Rt.current=setTimeout(()=>{Is(t)},nr),()=>{Rt.current&&(clearTimeout(Rt.current),Rt.current=null)}},[se]);const ga=async()=>{X(!0),Gt(!0);try{const[t,n]=await Promise.all([window.KTM.api.getJSON(`${API_BASE}/api/orders?overdue=1&days=${encodeURIComponent(On)}&includeItems=0`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),window.KTM.api.getJSON(`${API_BASE}/api/orders?draftExpiring=1&remainingDays=${encodeURIComponent(Xa)}&includeItems=0`,"L\u1ED7i t\u1EA3i \u0111\u01A1n nh\xE1p")]);Ft(Array.isArray(t)?t:[]),ge(Array.isArray(n)?n:[])}catch(t){console.error("Load all orders error:",t),Ft([]),ge([])}finally{X(!1),Gt(!1)}},Za=async t=>{const n=await Da(t);if(!n)return;nn(n.id);const e=Array.isArray(n.items)&&n.items.length?n.items.map(m=>{var I,v,u,_;return{product_id:(m==null?void 0:m.product_id)||"",quantity:Number((I=m==null?void 0:m.quantity)!=null?I:1)||1,unit_price:(()=>{var T;const N=(T=m==null?void 0:m.unit_price)!=null?T:m==null?void 0:m.unitPrice,B=N==null||N===""?NaN:Number(N);return Number.isFinite(B)?Math.trunc(B):null})(),variant:String((v=m==null?void 0:m.variant)!=null?v:"").trim(),variant_json:(_=(u=m==null?void 0:m.variant_json)!=null?u:m==null?void 0:m.variantJson)!=null?_:null}}).filter(m=>m.product_id):[{product_id:n.product_id||"",quantity:Number(n.quantity||1)||1,unit_price:null,variant:"",variant_json:null}],a=fr(n),i=sa(a),o=ra(i),g=Ua(i);gt({customer_name:n.customer_name||"",phone:We(n.phone||""),address:n.address||"",note:(n==null?void 0:n.note)||"",items:e.length?e:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_items:a,adjustment_amount:o,adjustment_note:g||(n==null?void 0:n.adjustment_note)||"",status:n.status||"pending"}),oe(new Array(e.length?e.length:1).fill("")),Mt(new Array(e.length?e.length:1).fill(!0)),R(null),Yt(!1),ne(n),Pe(!0),je(""),Me(!1),vn(!0),n.phone&&Ia(We(n.phone))},ba=async t=>{if(!t)return;Pe(!0),je(""),Me(!0),vn(!1),ne(t);const n=++E.current;try{const e=await Da(t);if(E.current!==n)return;ne(e||t)}catch(e){if(E.current!==n)return;je((e==null?void 0:e.message)||"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c chi ti\u1EBFt \u0111\u01A1n")}finally{if(E.current!==n)return;Me(!1)}},Rs=()=>{$||ht||(Pe(!1),Me(!1),je(""),vn(!1),nn(null),Hn(""),w(!1),Mt([]))};function Pa(t){Pe(!1),vn(!1),Me(!1),je(""),nn(null),Hn(t||""),w(!1),Mt([]),Yt(!0)}const ts=()=>{$||ht||(Yt(!1),nn(null),Hn(""),w(!1),Mt([]))},Ks=async()=>{var m,I,v;if(!be||ht||$)return;const t=(Array.isArray(wt)?wt:[]).find(u=>String(u==null?void 0:u.id)===String(be))||null,n=String((t==null?void 0:t.status)||(y==null?void 0:y.status)||"").trim();if(n==="done"||n==="paid"||n==="canceled"){const u="Kh\xF4ng th\u1EC3 t\xE1ch: \u0111\u01A1n \u0111\xE3 ho\xE0n th\xE0nh/\u0111\xE3 nh\u1EADn ti\u1EC1n/\u0111\xE3 h\u1EE7y.";typeof F=="function"?F(u,"warning"):alert(u);return}const e=We(y.phone),i=(Array.isArray(y.items)?y.items:[]).map((u,_)=>{var N,B;return{idx:_,product_id:String((u==null?void 0:u.product_id)||"").trim(),quantity:Number((N=u==null?void 0:u.quantity)!=null?N:0),variant:String((u==null?void 0:u.variant)||"").trim()||null,variant_json:(B=u==null?void 0:u.variant_json)!=null?B:null,unit_price:(()=>{const T=u==null?void 0:u.unit_price,yt=T===""||T==null?NaN:Number(T);if(Number.isFinite(yt))return Math.max(0,Math.trunc(yt));const ce=Tn(u==null?void 0:u.product_id),Ge=u!=null&&u.variant_json&&typeof u.variant_json=="object"?u.variant_json:null;return la(ce,Ge)})()}}).filter(u=>u.product_id&&Number.isFinite(u.quantity)&&u.quantity>0);if(i.length<2){const u="C\u1EA7n \xEDt nh\u1EA5t 2 s\u1EA3n ph\u1EA9m \u0111\u1EC3 t\xE1ch \u0111\u01A1n.";typeof F=="function"?F(u,"warning"):alert(u);return}const o=[],g=[];for(const u of i){const _=!!Ot[u.idx],N={product_id:u.product_id,quantity:u.quantity,unit_price:u.unit_price,variant:u.variant,variant_json:u.variant_json};_?o.push(N):g.push(N)}if(!o.length||!g.length){const u="Ch\u1ECDn m\u1ED9t s\u1ED1 s\u1EA3n ph\u1EA9m \u201CGiao \u0111\u1EE3t 1\u201D, v\xE0 \u0111\u1EC3 l\u1EA1i \xEDt nh\u1EA5t 1 s\u1EA3n ph\u1EA9m \u201CCh\u1EDD h\xE0ng\u201D.";typeof F=="function"?F(u,"warning"):alert(u);return}_t(!0);try{const u=Array.isArray(y==null?void 0:y.adjustment_items)?y.adjustment_items:[],_=sa(u),N=ra(_),B=Ua(_),T={customer_name:y.customer_name,phone:e,address:y.address,note:(y.note||"").trim(),adjustment_amount:N,adjustment_note:B,adjustment_items:_,status:"processing",items:o,created_at_from_order_id:String(be),product_id:o[0].product_id,quantity:o[0].quantity,split_seq:1},yt=await window.KTM.api.postJSON(`${API_BASE}/api/orders`,T,"L\u1ED7i t\xE1ch \u0111\u01A1n (t\u1EA1o \u0111\u01A1n giao ngay)"),ce=(v=(I=yt==null?void 0:yt.id)!=null?I:(m=yt==null?void 0:yt.order)==null?void 0:m.id)!=null?v:null;if(!ce)throw new Error("T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i: kh\xF4ng nh\u1EADn \u0111\u01B0\u1EE3c ID \u0111\u01A1n giao ngay");const Ge={id:be,customer_name:y.customer_name,phone:e,address:y.address,note:(y.note||"").trim(),adjustment_amount:0,adjustment_note:"",adjustment_items:[],status:"pending",items:g,product_id:g[0].product_id,quantity:g[0].quantity,parent_order_id:String(ce),split_seq:2};if(await window.KTM.api.putJSON(`${API_BASE}/api/orders/${be}`,Ge,"L\u1ED7i t\xE1ch \u0111\u01A1n (c\u1EADp nh\u1EADt ph\u1EA7n ch\u1EDD h\xE0ng)"),Se){vn(!1),nn(null),Hn(""),w(!1),Mt([]),je(""),Me(!0);try{const rn=await $a(ce);rn&&typeof rn=="object"?ne(rn):(ne(null),je("Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c \u0111\u01A1n giao ngay sau khi t\xE1ch"))}catch(rn){je((rn==null?void 0:rn.message)||"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c \u0111\u01A1n giao ngay sau khi t\xE1ch")}finally{Me(!1)}}else ts();Yn(),ga();const we=ce?`\u0110\xE3 t\xE1ch \u0111\u01A1n. \u0110\u01A1n giao ngay: #${ce}`:"\u0110\xE3 t\xE1ch \u0111\u01A1n.";typeof F=="function"?F(we,"success"):alert(we)}catch(u){console.error(u);const _=(u==null?void 0:u.message)||"T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i";typeof F=="function"?F(_,"danger"):alert(_)}finally{_t(!1)}},Os=t=>{if(!t)return"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --";const n=String(t),e=qe.find(a=>String(a==null?void 0:a.id)===n);return e?`${e.name}${e.code?` (${e.code})`:""}`:"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"},En=t=>{try{return String(t!=null?t:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(n){return String(t!=null?t:"").toLowerCase()}},kr=t=>{const e=En(t).trim().split(/\s+/).filter(Boolean),a=e.join(" ");return{contentTokens:e,cleanedQuery:a}},Ps=React.useMemo(()=>(Array.isArray(qe)?qe:[]).map((t,n)=>{var v,u,_,N,B,T;const e=En((v=t==null?void 0:t.name)!=null?v:""),a=En((u=t==null?void 0:t.code)!=null?u:""),i=En((_=t==null?void 0:t.category)!=null?_:""),o=En((N=t==null?void 0:t.note)!=null?N:""),g=En((B=t==null?void 0:t.id)!=null?B:""),m=En((T=t==null?void 0:t.stt)!=null?T:""),I=`${e} ${a} ${i} ${o} ${g} ${m}`.trim();return{p:t,originalIndex:n,name:e,code:a,category:i,note:o,haystackAll:I}}),[qe]),Cr=(t,n,e)=>{var _,N,B,T,yt;const a=Array.isArray(n)?n:[],i=En(e).trim();if(!a.length&&!i)return 0;const o=(_=t==null?void 0:t.name)!=null?_:"",g=(N=t==null?void 0:t.code)!=null?N:"",m=(B=t==null?void 0:t.category)!=null?B:"",I=(T=t==null?void 0:t.note)!=null?T:"";if(!((yt=t==null?void 0:t.haystackAll)!=null?yt:""))return 0;let u=0;i&&(o===i&&(u+=220),o.includes(i)&&(u+=140),o.startsWith(i)&&(u+=160),g&&g===i&&(u+=180),g&&g.includes(i)&&(u+=90));for(const ce of a){if(!ce)continue;const Ge=new RegExp(`(?:^|\\s)${ce.replace(/[.*+?^${}()|[\[\]\\]/g,"\\$&")}`);o.includes(ce)&&(u+=35),Ge.test(o)&&(u+=25),g&&g.includes(ce)&&(u+=20),g&&Ge.test(g)&&(u+=10),m&&m.includes(ce)&&(u+=12),I&&I.includes(ce)&&(u+=6)}return u>0&&o&&(u+=Math.max(0,10-Math.min(10,Math.floor(o.length/10)))),u},es=(t,n)=>{const e=String(t||""),a=String(n||"");if(e===a)return 0;if(!e)return a.length;if(!a)return e.length;const i=e.length,o=a.length;if(o>i)return es(a,e);let g=new Array(o+1),m=new Array(o+1);for(let I=0;I<=o;I++)g[I]=I;for(let I=1;I<=i;I++){m[0]=I;const v=e.charCodeAt(I-1);for(let _=1;_<=o;_++){const N=v===a.charCodeAt(_-1)?0:1;m[_]=Math.min(g[_]+1,m[_-1]+1,g[_-1]+N)}const u=g;g=m,m=u}return g[o]},Ar=(t,n)=>{const e=String(t||"").trim(),a=String(n||"");if(!e||!a)return!1;if(a.includes(e))return!0;const i=a.split(/\s+/).filter(Boolean);if(!i.length)return!1;const o=e.length<=4?1:2;for(const g of i)if(!(Math.abs(g.length-e.length)>o)&&es(e,g)<=o)return!0;return!1},Ea=t=>{const n=En(t).replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim();return n?n.split(" ").filter(Boolean):[]},Mr=(t,n)=>{const e=Array.isArray(n)?n:[];if(!e.length)return 0;const a=Ea((t==null?void 0:t.name)||""),i=Ea((t==null?void 0:t.code)||""),o=Ea((t==null?void 0:t.category)||""),g=Ea((t==null?void 0:t.note)||""),m=(v,u,_)=>{const N=String(v||"").trim();if(!N||!u.length)return 0;const B=N.length<=4?1:2;let T=1/0,yt=-1;for(let we=0;we<u.length;we++){const rn=u[we];if(!rn||Math.abs(rn.length-N.length)>B)continue;const He=es(N,rn);if(He<T&&(T=He,yt=we,He===0))break}if(T===1/0||T>B)return 0;let Ge=Math.round(_*(T===0?1:T===1?.65:.45));return yt===0?Ge+=Math.round(_*.25):yt===1&&(Ge+=Math.round(_*.12)),Ge};let I=0;for(const v of e){if(!v)continue;const u=m(v,a,180),_=m(v,i,120),N=m(v,o,60),B=m(v,g,30);I+=Math.max(u,_,N,B)}if(I>0){const v=((t==null?void 0:t.name)||"").length;I+=Math.max(0,60-Math.min(60,Math.floor(v/2)))}return I},ns=React.useRef(new Map);React.useEffect(()=>{ns.current=new Map},[qe]);const Es=t=>{var v,u;const n=String(ft[t]||"").trim();if(!n)return qe;const{contentTokens:e,cleanedQuery:a}=kr(n);if(e.length===0)return qe;const i=En(n).trim(),o=ns.current.get(i);if(o)return o;const g=[];for(const _ of Ps){const N=_.haystackAll;N&&e.some(B=>N.includes(B))&&g.push(_)}let m=g;if(m.length<8&&e.length>0){const _=[],N=new Set(m.map(B=>{var T,yt;return String((yt=(T=B.p)==null?void 0:T.id)!=null?yt:"")+":"+String(B.originalIndex)}));for(const B of Ps){const T=String((u=(v=B.p)==null?void 0:v.id)!=null?u:"")+":"+String(B.originalIndex);if(N.has(T))continue;const yt=B.haystackAll;yt&&e.some(ce=>Ar(ce,yt))&&(_.push(B),N.add(T))}_.length&&(m=m.concat(_))}const I=m.map(_=>({entry:_,score:Cr(_,e,a)})).map(_=>{if(_.score>0)return _;const N=Mr(_.entry,e);return N>0?{..._,score:N}:_}).filter(_=>_.score>0).sort((_,N)=>N.score!==_.score?N.score-_.score:_.entry.originalIndex-N.entry.originalIndex).slice(0,40).map(_=>_.entry.p);return ns.current.set(i,I),I},Tn=t=>{if(!t)return null;const n=String(t);return qe.find(e=>String(e==null?void 0:e.id)===n)||null},Vn=t=>{if(t==null||t==="")return[];let n=t;if(typeof n=="string"){const e=n.trim();if(!e)return[];try{n=JSON.parse(e)}catch(a){return[]}}return Array.isArray(n)?n.map((e,a)=>{var g;if(!e||typeof e!="object")return null;const i=String((g=e.name)!=null?g:"").trim()||`Bi\u1EBFn th\u1EC3 ${a+1}`,o=(Array.isArray(e.options)?e.options:[]).map(m=>{var yt,ce,Ge,we,rn,He,Ln;if(!m||typeof m!="object")return null;const I=String((yt=m.label)!=null?yt:"").trim();if(!I)return null;const v=(rn=(we=(Ge=(ce=m.price)!=null?ce:m.priceValue)!=null?Ge:m.unit_price)!=null?we:m.unitPrice)!=null?rn:null,u=v==null||v===""?NaN:typeof v=="number"?v:typeof v=="string"?xs(v):Number(v),_=Number.isFinite(u)?Math.trunc(u):null,N=(Ln=(He=m.price_delta)!=null?He:m.priceDelta)!=null?Ln:null,B=Number(N),T=Number.isFinite(B)?Math.trunc(B):0;return{label:I,price:_,price_delta:T}}).filter(Boolean);return{name:i,options:o}}).filter(Boolean):[]},jr=t=>{const n=Tn(t);return Vn(n==null?void 0:n.variants)},La=t=>{if(!t||typeof t!="object")return"";const n=[];for(const[e,a]of Object.entries(t)){const i=String(e||"").trim(),o=String(a||"").trim();!i||!o||n.push(`${i}: ${o}`)}return n.join(", ")},la=(t,n)=>{const e=xs(t==null?void 0:t.price),a=Vn(t==null?void 0:t.variants);if(!a.length||!n||typeof n!="object")return e;let i=e,o=!1;for(const g of a){const m=String((g==null?void 0:g.name)||"").trim(),I=String((n==null?void 0:n[m])||"").trim();if(!m||!I)continue;const v=(Array.isArray(g.options)?g.options:[]).find(T=>String((T==null?void 0:T.label)||"").trim()===I);if(!v)continue;const u=v==null?void 0:v.price,_=u==null||u===""?NaN:Number(u);if(Number.isFinite(_)){i=Math.max(0,Math.trunc(_)),o=!0;continue}const N=v==null?void 0:v.price_delta,B=N==null||N===""?NaN:Number(N);Number.isFinite(B)&&(i+=Math.trunc(B))}return i},as=t=>window.KTM.orders.getOrderItems(t),Ls=t=>window.KTM.orders.getOrderTotalQty(t),da=t=>window.KTM.orders.getOrderProductSummary(t,Tn),ja=t=>window.KTM.orders.getOrderItemRows(t,Tn),ya=t=>window.KTM.orders.getOrderAdjustmentMoney(t),Qn=t=>window.KTM.orders.getOrderAdjustmentSummaryText(t),Tr=t=>{const n=as(t),e=ja(t),a=Na(n),i=va(n),o=i.fee,g=ya(t),m=a+o+g,I=u=>{const _=Number(u)||0;return _>0?`+${Fe(_)}`:Fe(_)},v=[];if(t!=null&&t.customer_name&&v.push(`KH\xC1CH: ${t.customer_name}`),t!=null&&t.phone&&v.push(`S\u0110T: ${t.phone}`),t!=null&&t.address&&v.push(`\u0110\u1ECAA CH\u1EC8: ${t.address}`),((t==null?void 0:t.note)||"").trim()&&v.push(`GHI CH\xDA: ${(t.note||"").trim()}`),v.push(""),v.push("S\u1EA2N PH\u1EA8M:"),e.length)for(const u of e)v.push(`- ${u.name} (SL: ${u.qty})`);else{const u=da(t);u&&u!=="\u2014"&&v.push(`- ${u}`)}v.push(""),v.push(`T\u1EA0M T\xCDNH: ${Fe(a)}`),i.found&&o!==0&&v.push(`SHIP: ${Fe(o)}`);{const u=window.KTM.orders.getOrderAdjustmentItems(t),_=(Array.isArray(u)?u:[]).map(T=>{var yt;return{amount:Number((yt=T==null?void 0:T.amount)!=null?yt:0)||0,note:String((T==null?void 0:T.note)||"").trim()}}).filter(T=>T.amount!==0||!!T.note),N=Qn(t);if(g!==0||_.length>0||!!N)if(_.length===1){const T=_[0];v.push(`\u0110I\u1EC0U CH\u1EC8NH: ${I(g)}${T.note?` \u2014 ${T.note}`:""}`)}else{v.push(`\u0110I\u1EC0U CH\u1EC8NH: ${I(g)}${!_.length&&N?` \u2014 ${N}`:""}`);for(const T of _)v.push(`- ${I(T.amount)}${T.note?`: ${T.note}`:""}`)}}return v.push(`T\u1ED4NG: ${Fe(m)}`),v.filter(Boolean).join(`
`)},Fa=t=>{try{const n=Tr(t);Promise.resolve(window.KTM.clipboard.writeText(n)).then(()=>{typeof F=="function"?F("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng","success"):alert("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng")}).catch(e=>{console.error(e),typeof F=="function"?F("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)","danger"):alert("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)")});try{Da(t)}catch(e){}}catch(n){console.error(n),typeof F=="function"?F("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)","danger"):alert("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)")}},va=t=>window.KTM.orders.getOrderShipInfo(t,Tn),Na=t=>window.KTM.orders.getItemsSubtotal(t,Tn),ss=t=>{try{const n=t instanceof Date?t:new Date(t);if(!n||Number.isNaN(n.getTime()))return"";const e=n.getFullYear(),a=String(n.getMonth()+1).padStart(2,"0");return`${e}-${a}`}catch(n){return""}},rs=()=>x?String(x):ss(new Date),js=t=>{const n=String((t==null?void 0:t.customer_name)||"").trim().toLowerCase(),e=We((t==null?void 0:t.phone)||""),a=String((t==null?void 0:t.address)||"").trim().toLowerCase(),i=Ja(t).amount,g=(Array.isArray(t==null?void 0:t.items)?t.items:[]).map(m=>{var I;return{product_id:String((m==null?void 0:m.product_id)||"").trim(),quantity:Number((I=m==null?void 0:m.quantity)!=null?I:0),variant:String((m==null?void 0:m.variant)||"").trim()}}).filter(m=>m.product_id&&Number.isFinite(m.quantity)&&m.quantity>0).sort((m,I)=>m.product_id<I.product_id?-1:m.product_id>I.product_id?1:m.variant<I.variant?-1:m.variant>I.variant?1:m.quantity-I.quantity);return JSON.stringify({name:n,phone:e,address:a,items:g,adj:i})},kn=React.useMemo(()=>{const t=We((y==null?void 0:y.phone)||"");if(!t)return{count:0,orders:[],monthKey:rs()};const n=rs(),a=(Array.isArray(U)?U:[]).filter(i=>{if(!i||be&&String(i.id)===String(be)||We(i.phone||"")!==t)return!1;const o=ss(i.created_at);return o&&o===n}).sort((i,o)=>{const g=new Date(i.created_at).getTime(),m=new Date(o.created_at).getTime();return(Number.isFinite(m)?m:0)-(Number.isFinite(g)?g:0)});return{count:a.length,orders:a,monthKey:n}},[U,y==null?void 0:y.phone,x,be]),_r=t=>{var m;const n=String((t==null?void 0:t.customer_name)||"").trim().toLowerCase(),e=We((t==null?void 0:t.phone)||""),a=String((t==null?void 0:t.address)||"").trim().toLowerCase(),i=ks((m=t==null?void 0:t.adjustment_amount)!=null?m:0),o=as(t),g=(Array.isArray(o)?o:[]).map(I=>{var v;return{product_id:String((I==null?void 0:I.product_id)||"").trim(),quantity:Number((v=I==null?void 0:I.quantity)!=null?v:0),variant:String((I==null?void 0:I.variant)||"").trim()}}).filter(I=>I.product_id&&Number.isFinite(I.quantity)&&I.quantity>0).sort((I,v)=>I.product_id<v.product_id?-1:I.product_id>v.product_id?1:I.variant<v.variant?-1:I.variant>v.variant?1:I.quantity-v.quantity);return JSON.stringify({name:n,phone:e,address:a,items:g,adj:i})},Fs=React.useMemo(()=>{if(be)return"";const t=We((y==null?void 0:y.phone)||"");if(!t)return"";const n=rs(),e=js(y),a=Array.isArray(U)?U:[];for(const i of a){if(!i||be&&String(i.id)===String(be)||We(i.phone||"")!==t)continue;const o=ss(i.created_at);if(!o||o!==n)continue;const g=_r(i);if(g&&g===e)return`\u0110\u01A1n n\xE0y gi\u1ED1ng 100% m\u1ED9t \u0111\u01A1n trong th\xE1ng ${n}${i!=null&&i.id?` (#${i.id})`:""}`}return""},[U,y,x,be]),Bs=t=>{var rn;const n=[],e=[],a=String((t==null?void 0:t.customer_name)||"").trim(),i=We((t==null?void 0:t.phone)||""),o=String((t==null?void 0:t.address)||"").trim();a||n.push("Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng"),i||n.push("Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i"),i&&!ia(i)&&n.push("S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)"),o||e.push("Thi\u1EBFu \u0111\u1ECBa ch\u1EC9");const m=(Array.isArray(t==null?void 0:t.items)?t.items:[]).filter(He=>He&&He.product_id);m.length===0&&n.push("Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m"),m.some(He=>{var na;const Ln=Number((na=He==null?void 0:He.quantity)!=null?na:0);return!Number.isFinite(Ln)||Ln<=0})&&n.push("S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0");const v=new Set;let u=!1;for(const He of m){const Ln=String(He.product_id||"").trim(),na=String((He==null?void 0:He.variant)||"").trim();if(!Ln)continue;const Oe=`${Ln}||${na}`;if(v.has(Oe)){u=!0;break}v.add(Oe)}u&&e.push("S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)");const _=Na(m),N=va(m),B=N!=null&&N.found?Number((rn=N==null?void 0:N.fee)!=null?rn:0):0,T=Array.isArray(t==null?void 0:t.adjustment_items)?t.adjustment_items:[],yt=sa(T),ce=ra(yt),Ge=yt.some(He=>(Number(He==null?void 0:He.amount)||0)!==0&&!String((He==null?void 0:He.note)||"").trim());N!=null&&N.found&&(B>=2e5||_>0&&B>_*.6)&&e.push(`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${Fe(B)}`),Ge&&e.push("C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh");const we=Math.abs(ce);return(we>=5e5||_>0&&we>_*.5)&&ce!==0&&e.push(`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${Fe(ce)}`),{errors:n,warnings:e,canSubmit:n.length===0}},Fr=React.useMemo(()=>Bs(y),[y,qe]),Re=React.useMemo(()=>{var na;const t=String((y==null?void 0:y.customer_name)||"").trim(),n=We((y==null?void 0:y.phone)||""),e=String((y==null?void 0:y.address)||"").trim(),a=Array.isArray(y==null?void 0:y.items)?y.items:[],i=new Map;for(const Oe of a){const ma=String((Oe==null?void 0:Oe.product_id)||"").trim(),Ha=String((Oe==null?void 0:Oe.variant)||"").trim();if(!ma)continue;const za=`${ma}||${Ha}`;i.set(za,(i.get(za)||0)+1)}const o=a.map(Oe=>{var tr;const ma=String((Oe==null?void 0:Oe.product_id)||"").trim(),Ha=Number((tr=Oe==null?void 0:Oe.quantity)!=null?tr:0),za=ma?"":"Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m",Kr=Number.isFinite(Ha)&&Ha>0?"":"S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0",Or=String((Oe==null?void 0:Oe.variant)||"").trim(),Pr=`${ma}||${Or}`,Er=ma&&(i.get(Pr)||0)>1?"S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)":"";return{productError:za,qtyError:Kr,dupWarn:Er}}),g=a.filter(Oe=>Oe&&Oe.product_id),m=Na(g),I=va(g),v=I!=null&&I.found?Number((na=I==null?void 0:I.fee)!=null?na:0):0,u=Array.isArray(y==null?void 0:y.adjustment_items)?y.adjustment_items:[],_=sa(u),N=ra(_),B=_.some(Oe=>(Number(Oe==null?void 0:Oe.amount)||0)!==0&&!String((Oe==null?void 0:Oe.note)||"").trim()),T=Math.abs(N),yt=B?"C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh":"",ce=N!==0&&(T>=5e5||m>0&&T>m*.5)?`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${Fe(N)}`:"",Ge=I!=null&&I.found&&(v>=2e5||m>0&&v>m*.6)?`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${Fe(v)}`:"",we=t?"":"Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng",rn=n?ia(n)?"":"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)":"Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",He=e?"":"Thi\u1EBFu \u0111\u1ECBa ch\u1EC9",Ln=!we&&!rn&&o.every(Oe=>!Oe.productError&&!Oe.qtyError);return{nameError:we,phoneError:rn,addressWarn:He,items:o,shipAbnormalWarn:Ge,adjustmentNoteWarn:yt,adjustmentAbnormalWarn:ce,canSubmit:Ln}},[y,qe]),Ba=async t=>{var m,I,v;const n=(t==null?void 0:t.mode)||"close",e=(t==null?void 0:t.origin)||"modal",a=Bs(y);if(!a.canSubmit){const u=a.errors[0]||"Thi\u1EBFu d\u1EEF li\u1EC7u b\u1EAFt bu\u1ED9c";typeof F=="function"?F(u,"danger"):alert(u);return}if(!be&&Fs){const u=`${Fs}

B\u1EA1n c\xF3 mu\u1ED1n ti\u1EBFp t\u1EE5c l\u01B0u kh\xF4ng?`;if(!window.confirm(u)){(kn==null?void 0:kn.count)>0&&w(!0),setTimeout(()=>{var B;const N=document.getElementById("order-phone-input");N&&typeof N.scrollIntoView=="function"&&(N.scrollIntoView({block:"center",behavior:"smooth"}),(B=N.focus)==null||B.call(N))},0);return}}const i=We(y.phone),g=(Array.isArray(y.items)?y.items:[]).map(u=>{var _,N;return{product_id:(u==null?void 0:u.product_id)||"",quantity:Number((_=u==null?void 0:u.quantity)!=null?_:1),variant:String((u==null?void 0:u.variant)||"").trim()||null,variant_json:(N=u==null?void 0:u.variant_json)!=null?N:null,unit_price:(()=>{const B=u==null?void 0:u.unit_price,T=B===""||B==null?NaN:Number(B);if(Number.isFinite(T))return Math.max(0,Math.trunc(T));const yt=Tn(u==null?void 0:u.product_id),ce=u!=null&&u.variant_json&&typeof u.variant_json=="object"?u.variant_json:null;return la(yt,ce)})()}}).filter(u=>u.product_id&&Number.isFinite(u.quantity)&&u.quantity>0);M(!0);try{const u=be,_=be?`${API_BASE}/api/orders/${be}`:`${API_BASE}/api/orders`,N=g[0],B=Array.isArray(y==null?void 0:y.adjustment_items)?y.adjustment_items:[],T=sa(B),yt=ra(T),ce=Ua(T),Ge={customer_name:y.customer_name,phone:i,address:y.address,note:(y.note||"").trim(),adjustment_amount:yt,adjustment_note:ce,adjustment_items:T,product_id:N.product_id,quantity:N.quantity,status:y.status,items:g,...be?{id:be}:{}};if(be)await window.KTM.api.putJSON(_,Ge,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");else{const we=await window.KTM.api.postJSON(_,Ge,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");An.current={id:(v=(I=we==null?void 0:we.id)!=null?I:(m=we==null?void 0:we.order)==null?void 0:m.id)!=null?v:null,fingerprint:js(y),ts:Date.now()}}if(vr(i,y.customer_name,y.address),e==="drawer"){if(Hn(""),nn(null),Yt(!1),vn(!1),w(!1),Mt([]),Yn(),u){Me(!0),je("");try{const we=await $a(u);we&&typeof we=="object"&&ne(we)}catch(we){je((we==null?void 0:we.message)||"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c chi ti\u1EBFt \u0111\u01A1n")}finally{Me(!1)}}}else n==="new"&&!be?(Hn(""),nn(null),Yt(!0)):(Hn(""),nn(null),Yt(!1)),Yn()}catch(u){console.error(u),typeof F=="function"?F(u.message,"danger"):alert(u.message);return}finally{M(!1)}},wa=t=>window.KTM.orders.getOrderTotalMoney(t,Tn),qs=async t=>{if(confirm("X\xF3a \u0111\u01A1n h\xE0ng n\xE0y?")){vt(t);try{await window.KTM.api.deleteJSON(`${API_BASE}/api/orders/${t}`,"L\u1ED7i x\xF3a \u0111\u01A1n h\xE0ng");try{const n=String(t);ot(e=>Array.isArray(e)?e.filter(a=>String(a==null?void 0:a.id)!==n):e),Ft(e=>Array.isArray(e)?e.filter(a=>String(a==null?void 0:a.id)!==n):e),ge(e=>Array.isArray(e)?e.filter(a=>String(a==null?void 0:a.id)!==n):e),$e(e=>Array.isArray(e)?e.filter(a=>String(a==null?void 0:a.id)!==n):e),lt(e=>Array.isArray(e)?e.filter(a=>String(a==null?void 0:a.id)!==n):e)}catch(n){}try{Se&&String(xt==null?void 0:xt.id)===String(t)&&Rs()}catch(n){}try{ct&&String(Ke==null?void 0:Ke.id)===String(t)&&qn()}catch(n){}Yn(),ga()}catch(n){console.error(n),typeof F=="function"?F(n.message,"danger"):alert(n.message)}finally{vt(null)}}},$r=()=>{const t=tt.current;if(!t)return;if(t.timer){try{clearTimeout(t.timer)}catch(o){}t.timer=null}const n=Array.isArray(t.events)?t.events.splice(0):[];if(!n.length||typeof F!="function")return;const e=new Map;for(const o of n){const g=String((o==null?void 0:o.orderId)||"").trim();g&&e.set(g,o)}const a=Array.from(e.values());if(!a.length)return;const i=o=>async()=>{try{for(const g of o)!(g!=null&&g.prevStatus)||!(g!=null&&g.orderId)||await Zn({id:g.orderId,status:g.nextStatus},g.prevStatus,{silentToast:!0,skipToastBatch:!0,fromUndo:!0});F(o.length>1?`\u0110\xE3 ho\xE0n t\xE1c ${o.length} \u0111\u01A1n`:"\u0110\xE3 ho\xE0n t\xE1c","info")}catch(g){F("Ho\xE0n t\xE1c th\u1EA5t b\u1EA1i","danger")}};if(a.length===1){const o=a[0],g=`${$n(o.prevStatus)} \u2192 ${$n(o.nextStatus)}`.trim();F(`\u0110\xE3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i: ${g}`,"success",{actionLabel:"Undo",durationMs:8500,onAction:i([o])});return}F(`\u0110\xE3 c\u1EADp nh\u1EADt ${a.length} \u0111\u01A1n`,"success",{actionLabel:"Undo",durationMs:9500,onAction:i(a)})},Dr=t=>{const n=tt.current;n&&(Array.isArray(n.events)||(n.events=[]),n.events.push(t),!n.timer&&(n.timer=setTimeout(()=>$r(),320)))};useEffect(()=>()=>{try{const t=tt.current;t!=null&&t.timer&&clearTimeout(t.timer)}catch(t){}},[]);const Zn=async(t,n,e={})=>{var g;const a=await Da(t),i=a==null?void 0:a.id;if(!i||!n)return;const o=bn(a==null?void 0:a.status);ut(i);try{const m=as(a),I=(Array.isArray(m)?m:[]).map(T=>{var yt,ce;return{product_id:(T==null?void 0:T.product_id)||"",quantity:Number((yt=T==null?void 0:T.quantity)!=null?yt:1),variant:String((T==null?void 0:T.variant)||"").trim()||null,variant_json:(ce=T==null?void 0:T.variant_json)!=null?ce:null,unit_price:(()=>{var rn;const Ge=(rn=T==null?void 0:T.unit_price)!=null?rn:T==null?void 0:T.unitPrice,we=Number(Ge);return Number.isFinite(we)?Math.max(0,Math.trunc(we)):null})()}}).filter(T=>T.product_id&&Number.isFinite(T.quantity)&&T.quantity>0);if(!I.length)throw new Error("Kh\xF4ng th\u1EC3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i: \u0111\u01A1n kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m h\u1EE3p l\u1EC7");const v=I[0],u={id:i,customer_name:(a==null?void 0:a.customer_name)||"",phone:We((a==null?void 0:a.phone)||""),address:(a==null?void 0:a.address)||"",note:((a==null?void 0:a.note)||"").trim(),adjustment_amount:Number((g=a==null?void 0:a.adjustment_amount)!=null?g:0)||0,adjustment_note:(a==null?void 0:a.adjustment_note)||"",product_id:v.product_id,quantity:v.quantity,status:n,items:I};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${i}`,u,"L\u1ED7i c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i");const _=String(i),N=T=>({...T||{},status:n}),B=bn(n);if(ot(T=>Array.isArray(T)?T.map(yt=>String(yt==null?void 0:yt.id)===_?N(yt):yt):T),Ft(T=>Array.isArray(T)?T.flatMap(yt=>String(yt==null?void 0:yt.id)!==_?[yt]:B==="pending"?[N(yt)]:[]):T),ge(T=>Array.isArray(T)?B==="draft"?T.map(yt=>String(yt==null?void 0:yt.id)===_?N(yt):yt):T.filter(yt=>String(yt==null?void 0:yt.id)!==_):T),$e(T=>Array.isArray(T)?T.map(yt=>String(yt==null?void 0:yt.id)===_?N(yt):yt):T),lt(T=>Array.isArray(T)?T.map(yt=>String(yt==null?void 0:yt.id)===_?N(yt):yt):T),ne(T=>String(T==null?void 0:T.id)===_?N(T):T),un(T=>String(T==null?void 0:T.id)===_?N(T):T),p(T=>String(T==null?void 0:T.id)===_?N(T):T),Aa(i,!1),pr(i),e!=null&&e.silentToast)return;if(e!=null&&e.skipToastBatch){typeof F=="function"&&F("\u0110\xE3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i","success",{durationMs:4500});return}Dr({orderId:i,prevStatus:o,nextStatus:bn(n)})}catch(m){if(console.error(m),(!navigator.onLine||(m==null?void 0:m.name)==="TypeError"||String((m==null?void 0:m.message)||"").toLowerCase().includes("failed to fetch"))&&!(e!=null&&e.fromSync)){const v=String(i),u=N=>({...N||{},status:n}),_=bn(n);ot(N=>Array.isArray(N)?N.map(B=>String(B==null?void 0:B.id)===v?u(B):B):N),Ft(N=>Array.isArray(N)?N.flatMap(B=>String(B==null?void 0:B.id)!==v?[B]:_==="pending"?[u(B)]:[]):N),ge(N=>Array.isArray(N)?_==="draft"?N.map(B=>String(B==null?void 0:B.id)===v?u(B):B):N.filter(B=>String(B==null?void 0:B.id)!==v):N),$e(N=>Array.isArray(N)?N.map(B=>String(B==null?void 0:B.id)===v?u(B):B):N),lt(N=>Array.isArray(N)?N.map(B=>String(B==null?void 0:B.id)===v?u(B):B):N),ne(N=>String(N==null?void 0:N.id)===v?u(N):N),un(N=>String(N==null?void 0:N.id)===v?u(N):N),p(N=>String(N==null?void 0:N.id)===v?u(N):N),dr(i,n,o),typeof F=="function"&&F("M\u1EA5t m\u1EA1ng/timeout \u2022 \u0110\xE3 x\u1EBFp h\xE0ng \u0111\u1ED3ng b\u1ED9","info",{durationMs:6500});return}typeof F=="function"?F(m.message,"danger"):alert(m.message)}finally{ut(null)}};useEffect(()=>{const t=n=>{var a;const e=(a=n==null?void 0:n.detail)==null?void 0:a.key;if(e){if(e==="/"){setTimeout(()=>{var i,o;(o=(i=dn.current)==null?void 0:i.focus)==null||o.call(i)},0);return}if(e==="N"||e==="n"){Pa();return}if((e==="j"||e==="J"||e==="k"||e==="K")&&Se&&(xt!=null&&xt.id)){const i=Array.isArray(an)?an:[],o=i.findIndex(I=>String(I==null?void 0:I.id)===String(xt==null?void 0:xt.id));if(o<0)return;const m=i[o+(e==="j"||e==="J"?-1:1)];m&&ba(m)}}};return window.addEventListener("ktm-admin-hotkey",t),()=>window.removeEventListener("ktm-admin-hotkey",t)},[an,Se,xt]);const Ir=()=>React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"T\xEAn kh\xE1ch h\xE0ng *"),React.createElement("input",{className:"form-control",value:y.customer_name,onChange:t=>gt({...y,customer_name:t.target.value}),placeholder:"Nh\u1EADp t\xEAn kh\xE1ch h\xE0ng",required:!0,style:{borderRadius:10,padding:12}}),!!Re.nameError&&React.createElement("div",{className:"form-text text-danger"},Re.nameError)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i *"),React.createElement("input",{className:"form-control",type:"tel",inputMode:"numeric",pattern:"[0-9+\\s-]*",id:"order-phone-input",value:y.phone,onChange:t=>Ms(t.target.value),onBlur:Ts,placeholder:"Nh\u1EADp s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",required:!0,style:{borderRadius:10,padding:12}}),!!Re.phoneError&&React.createElement("div",{className:"form-text text-danger"},Re.phoneError),!Re.phoneError&&kn.count>0&&React.createElement("div",{className:"form-text text-warning d-flex align-items-center justify-content-between gap-2"},React.createElement("span",null,"Kh\xE1ch n\xE0y \u0111\xE3 c\xF3 ",kn.count," \u0111\u01A1n trong th\xE1ng ",kn.monthKey,"."),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>w(t=>!t)},S?"\u1EA8n l\u1ECBch s\u1EED":"Xem l\u1ECBch s\u1EED")),S&&kn.orders.length>0&&React.createElement("div",{className:"mt-2 border rounded-3 p-2",style:{background:"#fff"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between gap-2 mb-2"},React.createElement("div",{className:"small fw-semibold"},"L\u1ECBch s\u1EED \u0111\u01A1n (c\xF9ng th\xE1ng)"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>w(!1)},"\u1EA8n")),React.createElement("div",{className:"d-grid gap-2"},kn.orders.slice(0,5).map(t=>React.createElement("div",{key:t.id,className:"d-flex align-items-start justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"small fw-semibold",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},"#",t.id," \u2022 ",React.createElement("span",{className:`badge ${oa(t.status)}`},$n(t.status))),React.createElement("div",{className:"text-muted small"},ca(t.created_at)," \u2022 ",Fe(wa(t))),React.createElement("div",{className:"text-muted small",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},da(t))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{confirm(`M\u1EDF \u0111\u01A1n #${t.id}? D\u1EEF li\u1EC7u \u0111ang nh\u1EADp s\u1EBD m\u1EA5t.`)&&Za(t)}},"M\u1EDF")))),kn.orders.length>5&&React.createElement("div",{className:"text-muted small mt-2"},"Ch\u1EC9 hi\u1EC3n th\u1ECB 5 \u0111\u01A1n g\u1EA7n nh\u1EA5t.")),(k==null?void 0:k.status)==="loading"&&React.createElement("div",{className:"form-text"},"\u0110ang t\xECm kh\xE1ch theo S\u0110T..."),(k==null?void 0:k.status)==="found"&&React.createElement("div",{className:"form-text text-success"},"\u0110\xE3 c\xF3 kh\xE1ch, t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n th\xF4ng tin."),(k==null?void 0:k.status)==="not-found"&&React.createElement("div",{className:"form-text text-muted"},"Ch\u01B0a c\xF3 kh\xE1ch, s\u1EBD t\u1EA1o m\u1EDBi khi l\u01B0u \u0111\u01A1n."),(k==null?void 0:k.status)==="error"&&React.createElement("div",{className:"form-text text-danger"},"Kh\xF4ng tra \u0111\u01B0\u1EE3c kh\xE1ch (l\u1ED7i m\u1EA1ng/server).")),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("select",{className:"form-select",value:y.status,onChange:t=>gt({...y,status:t.target.value}),style:{borderRadius:10,padding:12}},React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n"))),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("input",{className:"form-control",value:y.address,onChange:t=>gt({...y,address:t.target.value}),placeholder:"Nh\u1EADp \u0111\u1ECBa ch\u1EC9 (kh\xF4ng b\u1EAFt bu\u1ED9c)",style:{borderRadius:10,padding:12}}),!!Re.addressWarn&&React.createElement("div",{className:"form-text text-warning"},Re.addressWarn)),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111\u01A1n h\xE0ng"),React.createElement("textarea",{className:"form-control",value:y.note,onChange:t=>gt({...y,note:t.target.value}),placeholder:"V\xED d\u1EE5: Giao gi\u1EDD h\xE0nh ch\xEDnh / G\u1ECDi tr\u01B0\u1EDBc khi giao...",rows:2,style:{borderRadius:10,padding:12,resize:"vertical"}})),React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110i\u1EC1u ch\u1EC9nh gi\xE1 (th\xEAm/b\u1EDBt)"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{gt(t=>({...t,adjustment_items:[...Array.isArray(t.adjustment_items)?t.adjustment_items:[{amount:"",note:""}],{amount:"",note:""}]}))}},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm \u0111i\u1EC1u ch\u1EC9nh")),React.createElement("div",{className:"d-grid gap-2"},Pn(y.adjustment_items).map((t,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label small text-muted mb-1"},"S\u1ED1 ti\u1EC1n"),React.createElement("input",{type:"text",inputMode:"numeric",className:"form-control",value:t.amount,onChange:e=>{const a=e.target.value;gt(i=>{const o=Pn(i.adjustment_items);return o[n]={...o[n],amount:a},{...i,adjustment_items:o}})},placeholder:"+500000 ho\u1EB7c -200000",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("label",{className:"form-label small text-muted mb-1"},"Ghi ch\xFA"),React.createElement("input",{className:"form-control",value:t.note,onChange:e=>{const a=e.target.value;gt(i=>{const o=Pn(i.adjustment_items);return o[n]={...o[n],note:a},{...i,adjustment_items:o}})},placeholder:"V\xED d\u1EE5: th\xEAm van 1 tay / gi\u1EA3m gi\xE1...",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-1 d-flex"},React.createElement("button",{type:"button",className:"btn btn-outline-danger w-100",onClick:()=>{gt(e=>{const a=Pn(e.adjustment_items);return a.splice(n,1),{...e,adjustment_items:a.length?a:[{amount:"",note:""}]}})},disabled:$||Pn(y.adjustment_items).length<=1,title:"X\xF3a \u0111i\u1EC1u ch\u1EC9nh",style:{borderRadius:10,padding:12}},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement("div",{className:"form-text"},"\xC2m = gi\u1EA3m gi\xE1, d\u01B0\u01A1ng = c\u1ED9ng th\xEAm."),!!Re.adjustmentAbnormalWarn&&React.createElement("div",{className:"form-text text-warning"},Re.adjustmentAbnormalWarn),!!Re.adjustmentNoteWarn&&React.createElement("div",{className:"form-text text-warning"},Re.adjustmentNoteWarn)),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1EA3n ph\u1EA9m *"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{gt(t=>({...t,items:[...Array.isArray(t.items)?t.items:[],{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]})),oe(t=>[...Array.isArray(t)?t:[],""]),be&&Mt(t=>[...Array.isArray(t)?t:[],!0])},disabled:$},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(y.items)?y.items:[{product_id:"",quantity:1}]).map((t,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"dropdown w-100",ref:e=>{Ze.current[n]=e}},React.createElement("button",{type:"button",className:"form-control text-start d-flex align-items-center justify-content-between",style:{borderRadius:10,padding:12},onClick:()=>{Ae(e=>e===n?null:n),setTimeout(()=>{const e=document.getElementById(`order-product-search-${n}`);e&&e.focus()},0)}},React.createElement("span",{className:t.product_id?"":"text-muted",style:{minWidth:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},Os(t.product_id)),React.createElement("i",{className:"fas fa-chevron-down text-muted",style:{marginLeft:8,flexShrink:0}})),le===n&&React.createElement("div",{className:"dropdown-menu show w-100 p-2",style:{maxHeight:320,overflowY:"auto"}},React.createElement("input",{id:`order-product-search-${n}`,className:"form-control",value:ft[n]||"",onChange:e=>{const a=e.target.value;oe(i=>{const o=Array.isArray(i)?[...i]:[];return o[n]=a,o})},placeholder:"T\xECm theo t\xEAn / m\xE3...",style:{borderRadius:10,padding:10}}),React.createElement("div",{className:"mt-2"}),(()=>{const e=Es(n);return e.length===0?React.createElement("div",{className:"text-muted small px-2 py-1"},"Kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p"):e.map(a=>React.createElement("button",{key:a.id,type:"button",className:"dropdown-item",onClick:()=>{const i=String(a.id),o=Vn(a==null?void 0:a.variants),g={};for(const v of o){const u=String((v==null?void 0:v.name)||"").trim(),_=Array.isArray(v==null?void 0:v.options)?v.options[0]:null,N=String((_==null?void 0:_.label)||"").trim();u&&N&&(g[u]=N)}const m=La(g),I=la(a,g);gt(v=>{const u=Array.isArray(v.items)?[...v.items]:[];return u[n]={...u[n]||{quantity:1},product_id:i,variant_json:Object.keys(g).length?g:null,variant:m,unit_price:o.length?I:null},{...v,items:u}}),Ae(null)}},a.name,a.code?` (${a.code})`:""))})()),React.createElement("select",{className:"form-select",value:t.product_id,onChange:()=>{},required:!0,style:{position:"absolute",opacity:0,height:0,pointerEvents:"none"},tabIndex:-1,"aria-hidden":"true"},React.createElement("option",{value:""},"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"),qe.map(e=>React.createElement("option",{key:e.id,value:e.id},e.name)))),(()=>{var a;const e=(a=Re.items)==null?void 0:a[n];return e?React.createElement(React.Fragment,null,!!e.productError&&React.createElement("div",{className:"form-text text-danger"},e.productError),!!e.dupWarn&&React.createElement("div",{className:"form-text text-warning"},e.dupWarn)):null})(),(()=>{if(!(t!=null&&t.product_id))return null;const e=Tn(t.product_id),a=Vn(e==null?void 0:e.variants);if(!a.length)return null;const i=t!=null&&t.variant_json&&typeof t.variant_json=="object"?t.variant_json:{};return React.createElement("div",{className:"mt-2 d-grid gap-2"},a.map((o,g)=>{const m=String((o==null?void 0:o.name)||`Bi\u1EBFn th\u1EC3 ${g+1}`).trim(),I=String((i==null?void 0:i[m])||"").trim();return React.createElement("div",{key:m},React.createElement("label",{className:"form-label small text-muted mb-1"},m),React.createElement("select",{className:"form-select",value:I,onChange:v=>{const u=String(v.target.value||"").trim();gt(_=>{const N=Array.isArray(_.items)?[..._.items]:[],B={...N[n]||{}},T=Tn(B.product_id),yt=Vn(T==null?void 0:T.variants),ce=B!=null&&B.variant_json&&typeof B.variant_json=="object"?{...B.variant_json}:{};u?ce[m]=u:delete ce[m];const Ge=La(ce),we=la(T,ce);return N[n]={...B,variant_json:Object.keys(ce).length?ce:null,variant:Ge,unit_price:we},{..._,items:N}})},style:{borderRadius:10,padding:12}},React.createElement("option",{value:""},"-- ch\u1ECDn ",m," --"),(Array.isArray(o==null?void 0:o.options)?o.options:[]).map(v=>React.createElement("option",{key:v.label,value:v.label},v.label,Number.isFinite(Number(v==null?void 0:v.price))?` (${Fe(Number(v.price))})`:Number(v==null?void 0:v.price_delta)?` (${v.price_delta>0?"+":""}${v.price_delta})`:""))))}))})(),be&&React.createElement("div",{className:"form-check mt-1"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:`order-split-deliver-${n}`,checked:!!Ot[n],onChange:e=>{const a=!!e.target.checked;Mt(i=>{const o=Array.isArray(i)?[...i]:[],g=Array.isArray(y.items)?y.items.length:0;for(;o.length<g;)o.push(!0);return o[n]=a,o})},disabled:$||ht}),React.createElement("label",{className:"form-check-label small text-muted",htmlFor:`order-split-deliver-${n}`},"Giao \u0111\u1EE3t 1"))),React.createElement("div",{className:"col-8 col-md-3"},React.createElement("input",{type:"number",className:"form-control",value:t.quantity,onChange:e=>{const a=e.target.value;gt(i=>{const o=Array.isArray(i.items)?[...i.items]:[];return o[n]={...o[n]||{product_id:""},quantity:a},{...i,items:o}})},min:"1",style:{borderRadius:10,padding:12}}),(()=>{var a;const e=(a=Re.items)==null?void 0:a[n];return e&&e.qtyError?React.createElement("div",{className:"form-text text-danger"},e.qtyError):null})()),React.createElement("div",{className:"col-4 col-md-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>{gt(e=>{const a=Array.isArray(e.items)?[...e.items]:[];return a.splice(n,1),{...e,items:a.length?a:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]}}),oe(e=>{const a=Array.isArray(e)?[...e]:[];return a.splice(n,1),a.length?a:[""]}),Mt(e=>{const a=Array.isArray(e)?[...e]:[];return a.splice(n,1),a}),Ae(e=>e==null?e:e===n?null:e>n?e-1:e)},disabled:$||ht||(Array.isArray(y.items)?y.items.length:1)<=1,title:"X\xF3a s\u1EA3n ph\u1EA9m",style:{borderRadius:10,padding:10}},React.createElement("i",{className:"fas fa-trash"}))))))),(()=>{const n=(Array.isArray(y.items)?y.items:[]).filter(m=>m==null?void 0:m.product_id),e=Na(n),a=va(n),i=Ja(y),o=i.amount,g=e+(a.found?a.fee:0)+o;return React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-column gap-1 small bg-light rounded-3 p-3"},React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1EA1m t\xEDnh"),React.createElement("span",{className:"fw-semibold"},Fe(e))),a.found&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"Ship"),React.createElement("span",{className:"fw-semibold"},Fe(a.fee))),!!Re.shipAbnormalWarn&&React.createElement("div",{className:"text-warning"},Re.shipAbnormalWarn),o!==0&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh"),React.createElement("span",{className:"fw-semibold"},Fe(o))),(y.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111\u01A1n: ",(y.note||"").trim()),!!i.summaryText&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh: ",i.summaryText),React.createElement("div",{className:"d-flex justify-content-between pt-1 border-top"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng"),React.createElement("span",{className:"fw-bold"},Fe(g)))))})()),[ta,sn]=useState(0),[Sa,wn]=useState(!1),ea=useRef(null),Wn=useRef(null),Hs=t=>{try{return!t||typeof t.closest!="function"?!1:!!(t.closest(".modal, .dropdown-menu")||t.closest('[contenteditable="true"]')||t.closest(".orders-search")||t.closest('button, a, [role="button"]'))}catch(n){return!1}},qa=(t,n)=>{const a=String(t||"").trim().split("-"),i=Number(a[0]||0),o=Number(a[1]||0);if(!i||!o)return"";const g=new Date(i,o-1+Number(n||0),1);return`${g.getFullYear()}-${String(g.getMonth()+1).padStart(2,"0")}`},xa=()=>{try{const t=(window==null?void 0:window.innerWidth)||360;return Math.max(110,Math.min(180,Math.floor(t*.28)))}catch(t){return 140}},is=()=>Math.min(96,Math.max(66,Math.floor(xa()*.62))),zs=t=>{var n;try{if(kt||te||Y==="draft"||!(t!=null&&t.touches)||t.touches.length!==1||Sa||(n=Wn.current)!=null&&n.active)return;const e=t.target;if(Hs(e))return;const a=t.touches[0];ea.current={x:a.clientX,y:a.clientY,at:Date.now(),swiping:!1}}catch(e){ea.current=null}},Xs=t=>{var v,u,_,N;const n=ea.current;if(!n||Sa)return;const e=(t==null?void 0:t.touches)&&t.touches[0];if(!e)return;const a=e.clientX-n.x,i=e.clientY-n.y,o=Math.abs(a),g=Math.abs(i);if(!n.swiping)if(o>10&&o>g*1.15){n.swiping=!0,wn(!1);try{(v=t.preventDefault)==null||v.call(t),(u=t.stopPropagation)==null||u.call(t)}catch(B){}}else return;const m=xa(),I=Math.max(-m,Math.min(m,a));sn(I);try{(_=t.preventDefault)==null||_.call(t),(N=t.stopPropagation)==null||N.call(t)}catch(B){}},Vs=t=>{const n=ea.current;ea.current=null;try{if(!n||kt||te||Y==="draft")return;if(!n.swiping){sn(0);return}const e=(t==null?void 0:t.changedTouches)&&t.changedTouches[0];if(!e)return;const a=e.clientX-n.x,i=e.clientY-n.y,o=Date.now()-n.at,g=Math.abs(a),m=Math.abs(i);if(o>1e3)return;if(g<24){sn(0);return}if(g<m*1.45)return;const I=is(),v=g>=I,u=a>0?1:-1,_=xa();if(!v){wn(!0),sn(0),setTimeout(()=>wn(!1),220);return}const N=u>0?-1:1,B=String(x||jn||"").trim(),T=qa(B,N);if(!T){wn(!0),sn(0),setTimeout(()=>wn(!1),220);return}if(String(T)>String(jn)){wn(!0),sn(u*Math.floor(_*.55)),setTimeout(()=>{sn(0),setTimeout(()=>wn(!1),200)},140);return}wn(!0),sn(u*_),setTimeout(()=>{q(T),sn(-u*_),requestAnimationFrame(()=>{requestAnimationFrame(()=>{sn(0),setTimeout(()=>wn(!1),220)})})},140)}catch(e){}},Ws=()=>{ea.current=null,sn(0)},Gs=t=>{var n,e;try{if(kt||te||Y==="draft"||Sa||(t==null?void 0:t.pointerType)==="mouse"&&t.button!=null&&t.button!==0)return;const a=t.target;if(Hs(a))return;ea.current=null,Wn.current={active:!0,pointerId:t.pointerId,startX:t.clientX,startY:t.clientY,at:Date.now(),lock:null,swiping:!1,captured:!1};try{(e=(n=t.currentTarget)==null?void 0:n.setPointerCapture)==null||e.call(n,t.pointerId),Wn.current.captured=!0}catch(i){}}catch(a){Wn.current=null}},Js=t=>{var I,v;const n=Wn.current;if(!n||!n.active||Sa)return;const e=t.clientX-n.startX,a=t.clientY-n.startY,i=Math.abs(e),o=Math.abs(a);if(n.lock||(i>10||o>10)&&(n.lock=i>o*1.15?"x":"y"),n.lock!=="x"){n.swiping&&sn(0);return}n.swiping=!0;const g=xa(),m=Math.max(-g,Math.min(g,e));sn(m);try{(I=t.preventDefault)==null||I.call(t),(v=t.stopPropagation)==null||v.call(t)}catch(u){}},Us=t=>{var e,a;const n=Wn.current;Wn.current=null;try{if(!n||!n.active||kt||te||Y==="draft")return;if(n.captured)try{(a=(e=t.currentTarget)==null?void 0:e.releasePointerCapture)==null||a.call(e,n.pointerId)}catch(ce){}if(!n.swiping){sn(0);return}const i=t.clientX-n.startX,o=t.clientY-n.startY,g=Date.now()-n.at,m=Math.abs(i),I=Math.abs(o);if(g>1e3)return;if(m<24){sn(0);return}if(m<I*1.45)return;const v=is(),u=m>=v,_=i>0?1:-1,N=xa();if(!u){wn(!0),sn(0),setTimeout(()=>wn(!1),220);return}const B=_>0?-1:1,T=String(x||jn||"").trim(),yt=qa(T,B);if(!yt){wn(!0),sn(0),setTimeout(()=>wn(!1),220);return}if(String(yt)>String(jn)){wn(!0),sn(_*Math.floor(N*.55)),setTimeout(()=>{sn(0),setTimeout(()=>wn(!1),200)},140);return}wn(!0),sn(_*N),setTimeout(()=>{q(yt),sn(-_*N),requestAnimationFrame(()=>{requestAnimationFrame(()=>{sn(0),setTimeout(()=>wn(!1),220)})})},140)}catch(i){}},Ys=()=>{Wn.current=null,sn(0)},Qs=ta>0?"Th\xE1ng tr\u01B0\u1EDBc":ta<0?"Th\xE1ng sau":"",os=ta>0?qa(String(x||jn||"").trim(),-1):ta<0?qa(String(x||jn||"").trim(),1):"",Zs=os&&String(os)<=String(jn)?os:"",Rr=Math.min(1,Math.abs(ta)/Math.max(1,is()));return React.createElement("div",{className:"product-manager"},React.createElement(Loading,{show:$||!!z||!!St}),!!Qs&&React.createElement("div",{"aria-hidden":"true",style:{position:"fixed",left:0,right:0,top:84,zIndex:1060,pointerEvents:"none",opacity:.15+.55*Rr,transform:"translateZ(0)"}},React.createElement("div",{className:"d-flex justify-content-center"},React.createElement("div",{className:"px-3 py-2 rounded-pill bg-dark text-white shadow-sm",style:{fontSize:13}},ta>0?"\u2190":"\u2192"," ",Qs,Zs?` \xB7 ${Zs}`:""))),React.createElement("div",{className:"orders-ops-toolbar card p-3"},React.createElement("div",{className:"d-flex flex-wrap align-items-center justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0}},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("h5",{className:"mb-0"},"\u0110\u01A1n h\xE0ng"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.all," \u0111\u01A1n"),te&&React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-25 text-dark"},"Search mode")),React.createElement("div",{className:"text-muted small mt-1"},"Hotkeys: ",React.createElement("span",{className:"fw-semibold"},"/")," search \u2022 ",React.createElement("span",{className:"fw-semibold"},"N")," t\u1EA1o \u0111\u01A1n \u2022 ",React.createElement("span",{className:"fw-semibold"},"Esc")," \u0111\xF3ng drawer")),React.createElement("div",{className:"d-flex gap-2"},React.createElement("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>te?Is(se):Yn(),disabled:on,title:"L\xE0m m\u1EDBi"},React.createElement("i",{className:"fas fa-rotate"})),React.createElement("button",{className:"btn btn-dark btn-sm",onClick:()=>Pa(),disabled:$||!!z},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o \u0111\u01A1n"))),React.createElement("div",{className:"orders-chip-row mt-3"},React.createElement("button",{type:"button",className:`orders-chip d-md-none ${rt&&!kt&&!te?"active":""}`,onClick:()=>{te&&Kt(""),$t(!1),Wt(!1),Dt(t=>!t)},title:"\u0110\u01A1n \u01B0u ti\xEAn (\u0111\xE3 ghim)"},React.createElement("i",{className:"fas fa-star me-1"}),"\u01AFu ti\xEAn"," ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Nr)),React.createElement("button",{type:"button",className:`orders-chip d-md-none ${It&&!kt&&!te?"active":""}`,onClick:()=>{te&&Kt(""),$t(!1),Dt(!1),Wt(t=>!t)},title:"\u0110\u01A1n c\u1EA7n x\u1EED l\xFD h\xF4m nay"},React.createElement("i",{className:"fas fa-calendar me-1"}),"H\xF4m nay"," ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},wr)),React.createElement("button",{type:"button",className:`orders-chip ${!Y&&!kt&&!te?"active":""}`,onClick:()=>{te&&Kt(""),$t(!1),dt("")}},"T\u1EA5t c\u1EA3 ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.all)),React.createElement("button",{type:"button",className:`orders-chip ${Y==="draft"&&!kt&&!te?"active":""}`,onClick:()=>{te&&Kt(""),$t(!1),dt("draft"),q("")}},"Nh\xE1p ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.draft)),React.createElement("button",{type:"button",className:`orders-chip ${Y==="pending"&&!kt&&!te?"active":""}`,onClick:()=>{te&&Kt(""),$t(!1),dt("pending")}},"Ch\u1EDD x\u1EED l\xFD ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.pending)),React.createElement("button",{type:"button",className:`orders-chip ${Y==="processing"&&!kt&&!te?"active":""}`,onClick:()=>{te&&Kt(""),$t(!1),dt("processing")}},"V\u1EADn chuy\u1EC3n ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.processing)),React.createElement("button",{type:"button",className:`orders-chip ${Y==="done"&&!kt&&!te?"active":""}`,onClick:()=>{te&&Kt(""),$t(!1),dt("done")}},"Ho\xE0n th\xE0nh ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.done)),React.createElement("button",{type:"button",className:`orders-chip ${Y==="paid"&&!kt&&!te?"active":""}`,onClick:()=>{te&&Kt(""),$t(!1),dt("paid")}},"\u0110\xE3 nh\u1EADn ti\u1EC1n ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.paid)),React.createElement("button",{type:"button",className:`orders-chip ${Y==="canceled"&&!kt&&!te?"active":""}`,onClick:()=>{te&&Kt(""),$t(!1),dt("canceled")}},"H\u1EE7y ",React.createElement("span",{className:"ms-1 badge rounded-pill bg-dark bg-opacity-10 text-dark"},Xn.canceled))),React.createElement("div",{className:"orders-presets mt-2 d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>Fn("thisMonth"),disabled:te},React.createElement("i",{className:"fas fa-calendar me-2"}),"Th\xE1ng n\xE0y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger",onClick:()=>Fn("overduePending"),disabled:te},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"Ch\u1EADm > ",On," ng\xE0y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>Fn("draftExpiring"),disabled:te},React.createElement("i",{className:"fas fa-clock me-2"}),"Nh\xE1p s\u1EAFp h\u1EE7y"),(Y||kt||!x&&!te)&&React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>Fn("all")},"Clear")),React.createElement("div",{className:"orders-filterbar mt-3 d-flex flex-wrap gap-2 align-items-center",style:{touchAction:"pan-y",transform:`translateX(${ta}px)`,transition:Sa?"transform 220ms ease":"none",willChange:"transform"},onTouchStartCapture:zs,onTouchMoveCapture:Xs,onTouchEndCapture:Vs,onTouchCancelCapture:Ws,onPointerDownCapture:Gs,onPointerMoveCapture:Js,onPointerUpCapture:Us,onPointerCancelCapture:Ys},React.createElement("div",{className:"input-group input-group-sm orders-search"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-search"})),React.createElement("input",{ref:dn,type:"text",className:"form-control",value:se,onChange:t=>Kt(t.target.value),placeholder:"Search t\xEAn / S\u0110T\u2026 (nh\u1EA5n /)","aria-label":"Search \u0111\u01A1n h\xE0ng theo t\xEAn ho\u1EB7c S\u0110T"}),String(se||"").trim()&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>Kt(""),disabled:on},React.createElement("i",{className:"fas fa-times"})),on&&React.createElement("span",{className:"input-group-text",title:"\u0110ang search...","aria-label":"\u0110ang search"},React.createElement("span",{className:"spinner-border spinner-border-sm text-warning",role:"status","aria-hidden":"true"}))),React.createElement("div",{className:"input-group input-group-sm orders-month"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:x,onChange:t=>q(t.target.value),"aria-label":"Ch\u1ECDn th\xE1ng",disabled:kt||te})),React.createElement("div",{className:"text-muted small ms-auto"},te?"Search b\u1ECF qua filter":kt?"\u0110ang xem \u0111\u01A1n ch\u1EADm":Y?`L\u1ECDc: ${$n(Y)}`:Xt?"Vu\u1ED1t tr\xE1i/ph\u1EA3i \u0111\u1EC3 \u0111\u1ED5i th\xE1ng":""))),React.createElement("div",{className:`orders-context-header d-md-none ${f?"visible":""}`,title:"Vu\u1ED1t tr\xE1i/ph\u1EA3i \u0111\u1EC3 \u0111\u1ED5i th\xE1ng",onTouchStartCapture:zs,onTouchMoveCapture:Xs,onTouchEndCapture:Vs,onTouchCancelCapture:Ws,onPointerDownCapture:Gs,onPointerMoveCapture:Js,onPointerUpCapture:Us,onPointerCancelCapture:Ys},React.createElement("div",{className:"orders-context-text"},(()=>{if(te){const t=String(se||"").trim();return`Search: ${t?`"${t}"`:""} \u2022 ${an.length} k\u1EBFt qu\u1EA3`}return kt?`\u0110\u01A1n ch\u1EADm \u2022 ${an.length} \u0111\u01A1n`:rt?`\u01AFu ti\xEAn \u2022 ${an.length} \u0111\u01A1n`:It?`H\xF4m nay \u2022 ${an.length} \u0111\u01A1n`:Y?`L\u1ECDc: ${$n(Y)} \u2022 ${an.length} \u0111\u01A1n`:`T\u1EA5t c\u1EA3 \u2022 ${an.length} \u0111\u01A1n`})()),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{Kt(""),Dt(!1),Wt(!1),Fn("all")},"aria-label":"Clear"},"Clear")),React.createElement("div",{className:"card p-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},"Danh s\xE1ch \u0111\u01A1n h\xE0ng"),React.createElement("span",{className:"text-muted small"},te?`${an.length} k\u1EBFt qu\u1EA3`:Y?`${Oa.length}/${wt.length} \u0111\u01A1n`:`${wt.length}${Et?"+":""} \u0111\u01A1n`)),te&&Le&&React.createElement("div",{className:"alert alert-danger mt-3 mb-0",role:"alert"},Le),Ka.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"C\xF3 ",React.createElement("strong",null,Ka.length)," \u0111\u01A1n ",React.createElement("strong",null,"Ch\u1EDD x\u1EED l\xFD")," qu\xE1 ",On," ng\xE0y.",Lt&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{$t(!0),dt("pending")}},"Xem ngay")),_s.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-clock me-2"}),"C\xF3 ",React.createElement("strong",null,_s.length)," \u0111\u01A1n ",React.createElement("strong",null,"Nh\xE1p")," s\u1EAFp t\u1EF1 h\u1EE7y (c\xF2n \u2264 ",Xa," ng\xE0y).",_e&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{$t(!1),dt("draft"),q(""),Yn()}},"Xem ngay")),(te?on:Vt)?React.createElement("div",{className:"orders-skeleton-wrap mt-3"},React.createElement("div",{className:"d-md-none"},new Array(6).fill(0).map((t,n)=>React.createElement("div",{key:n,className:"card mb-2"},React.createElement("div",{className:"card-body p-3"},React.createElement("div",{className:"admin-skeleton-line w-50 mb-2"}),React.createElement("div",{className:"admin-skeleton-line w-75 mb-2"}),React.createElement("div",{className:"admin-skeleton-line w-35"}))))),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive orders-table-wrap mt-3"},React.createElement("table",{className:"table orders-table align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"SL"),React.createElement("th",null,"T\u1ED5ng ti\u1EC1n"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"),React.createElement("th",null,"Th\u1EDDi gian"),React.createElement("th",null))),React.createElement("tbody",null,new Array(10).fill(0).map((t,n)=>React.createElement("tr",{key:n},React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-60"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-70"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-85"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-30"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-50"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-40"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-55"})),React.createElement("td",null,React.createElement("div",{className:"admin-skeleton-line w-40"}))))))))):(te?an.length===0:wt.length===0)?React.createElement("div",{className:"text-center py-4 text-muted"},te?"Kh\xF4ng c\xF3 k\u1EBFt qu\u1EA3":"Ch\u01B0a c\xF3 \u0111\u01A1n h\xE0ng"):!te&&Oa.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},"Kh\xF4ng c\xF3 \u0111\u01A1n ph\xF9 h\u1EE3p"):React.createElement(React.Fragment,null,React.createElement("div",{className:"d-md-none mt-3"},Ds.map(t=>{var n;return React.createElement("div",{key:t.id,className:`orders-mobile-swipe-shell mb-2 ${(xe==null?void 0:xe.id)===String(t.id)?`swipe-preview swipe-${(xe==null?void 0:xe.dir)||""}`:""}`,role:"button",tabIndex:0,onClick:()=>{if(pn.current){pn.current=!1;return}ba(t)},onPointerDown:e=>{if(ct||r||ze||e.button!=null&&e.button!==0)return;const a=String(t.id);pn.current=!1,Ut.current={active:!0,id:a,startX:e.clientX,startY:e.clientY,dx:0,dy:0,lock:null,pointerId:e.pointerId,captured:!1},ae(i=>(i==null?void 0:i.id)===a?i:{id:a,dir:null});try{e.currentTarget.classList.remove("swiping"),e.currentTarget.style.setProperty("--swipe-x","0px"),e.currentTarget.style.setProperty("--swipe-p","0"),e.currentTarget.style.setProperty("--swipe-l","0"),e.currentTarget.style.setProperty("--swipe-r","0")}catch(i){}try{cn.current&&clearTimeout(cn.current)}catch(i){}Nn.current=a,cn.current=setTimeout(async()=>{var o,g,m,I;const i=Nn.current;if(i)try{if((g=(o=Xe.current)==null?void 0:o.has)!=null&&g.call(o,i))return;const v=await $a(i);v&&typeof v=="object"&&((I=(m=Xe.current)==null?void 0:m.set)==null||I.call(m,i,v))}catch(v){}},150)},onPointerMove:e=>{const a=Ut.current;if(!(a!=null&&a.active)||String(a.id)!==String(t.id))return;const i=e.clientX-a.startX,o=e.clientY-a.startY;if(a.dx=i,a.dy=o,Math.abs(i)>14||Math.abs(o)>14){try{cn.current&&clearTimeout(cn.current)}catch(N){}cn.current=null,Nn.current=null}if(!a.lock){const N=Math.abs(i),B=Math.abs(o);if((N>10||B>10)&&(a.lock=N>B*1.2?"x":"y",a.lock==="x"&&!a.captured))try{e.currentTarget.setPointerCapture(e.pointerId),a.captured=!0}catch(T){}}if(a.lock!=="x"){try{e.currentTarget.classList.remove("swiping"),e.currentTarget.style.setProperty("--swipe-x","0px"),e.currentTarget.style.setProperty("--swipe-p","0"),e.currentTarget.style.setProperty("--swipe-l","0"),e.currentTarget.style.setProperty("--swipe-r","0")}catch(N){}Math.abs(o)>24&&ae(N=>(N==null?void 0:N.id)===a.id?{id:a.id,dir:null}:N);return}const g=!!aa(t==null?void 0:t.status,"right"),m=!!aa(t==null?void 0:t.status,"left"),I=(N,B,T)=>Math.max(B,Math.min(T,N)),v=I(i,-140,140),u=v>0&&!g||v<0&&!m?v*.35:v,_=I(Math.abs(u)/88,0,1);try{e.currentTarget.classList.add("swiping"),e.currentTarget.style.setProperty("--swipe-x",`${u}px`),e.currentTarget.style.setProperty("--swipe-p",String(_)),e.currentTarget.style.setProperty("--swipe-l",u>0&&g?String(_):"0"),e.currentTarget.style.setProperty("--swipe-r",u<0&&m?String(_):"0")}catch(N){}Math.abs(u)>12&&(pn.current=!0),i>72&&g?ae({id:a.id,dir:"right"}):i<-72&&m?ae({id:a.id,dir:"left"}):ae({id:a.id,dir:null})},onPointerCancel:e=>{try{cn.current&&clearTimeout(cn.current)}catch(i){}cn.current=null,Nn.current=null;const a=Ut.current;try{a!=null&&a.captured&&(a==null?void 0:a.pointerId)!=null&&e.currentTarget.releasePointerCapture(a.pointerId)}catch(i){}Ut.current={active:!1,id:null,startX:0,startY:0,dx:0,dy:0,lock:null,pointerId:null,captured:!1},ae({id:null,dir:null});try{e.currentTarget.classList.remove("swiping"),e.currentTarget.style.setProperty("--swipe-x","0px"),e.currentTarget.style.setProperty("--swipe-p","0"),e.currentTarget.style.setProperty("--swipe-l","0"),e.currentTarget.style.setProperty("--swipe-r","0")}catch(i){}},onPointerUp:e=>{try{cn.current&&clearTimeout(cn.current)}catch(u){}cn.current=null,Nn.current=null;const a=Ut.current;if(!(a!=null&&a.active)||String(a.id)!==String(t.id)){ae({id:null,dir:null});return}try{a!=null&&a.captured&&(a==null?void 0:a.pointerId)!=null&&e.currentTarget.releasePointerCapture(a.pointerId)}catch(u){}Ut.current={active:!1,id:null,startX:0,startY:0,dx:0,dy:0,lock:null,pointerId:null,captured:!1};const i=Number(a.dx)||0,o=Math.abs(i),g=a.lock==="x",m=bn(t==null?void 0:t.status);ae({id:null,dir:null});try{e.currentTarget.classList.remove("swiping"),e.currentTarget.style.setProperty("--swipe-x","0px"),e.currentTarget.style.setProperty("--swipe-p","0"),e.currentTarget.style.setProperty("--swipe-l","0"),e.currentTarget.style.setProperty("--swipe-r","0")}catch(u){}if(g&&o>12&&(pn.current=!0),!g||o<88)return;e.preventDefault(),e.stopPropagation();const I=i>0?aa(t==null?void 0:t.status,"right"):aa(t==null?void 0:t.status,"left"),v=bn(I);!v||v===m||Zn(t,v)},onKeyDown:e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),ba(t))},title:"Xem chi ti\u1EBFt"},React.createElement("div",{className:"orders-mobile-swipe-bg","aria-hidden":"true"},React.createElement("div",{className:"orders-mobile-swipe-bg-left"},React.createElement("div",{className:"orders-mobile-swipe-label"},(()=>{const e=aa(t==null?void 0:t.status,"right"),a=Ss(e),i=(a==null?void 0:a.label)||String(e||"").trim();return i?React.createElement(React.Fragment,null,React.createElement("i",{className:`fas ${a.icon||"fa-circle"}`}),i):null})())),React.createElement("div",{className:"orders-mobile-swipe-bg-right"},React.createElement("div",{className:"orders-mobile-swipe-label"},(()=>{const e=aa(t==null?void 0:t.status,"left"),a=Ss(e),i=(a==null?void 0:a.label)||String(e||"").trim();return i?React.createElement(React.Fragment,null,React.createElement("i",{className:`fas ${a.icon||"fa-circle"}`}),i):null})()))),React.createElement("div",{className:`card orders-mobile-card ${A!=null&&A[String(t.id)]?"order-recent-updated":""}`},React.createElement("div",{className:"card-body p-3 order-card-mobile"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"flex-grow-1",style:{minWidth:0}},React.createElement("div",{className:"fw-semibold order-customer-name"},t.customer_name),React.createElement("div",{className:"fw-bold font-monospace order-phone",role:"button",tabIndex:0,onPointerDown:e=>mr(e,t.phone),onPointerMove:Wa,onPointerUp:e=>ur(e,t.phone),onPointerCancel:Wa,onPointerLeave:Wa,onContextMenu:e=>{e.preventDefault(),e.stopPropagation()},onClick:e=>{if(e.stopPropagation(),en.current){en.current=!1;return}vs(t.phone)},onKeyDown:e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),e.stopPropagation(),vs(t.phone))},title:"Ch\u1EA1m \u0111\u1EC3 copy \u2022 Gi\u1EEF \u0111\u1EC3 g\u1ECDi"},t.phone),Number((n=t==null?void 0:t.split_seq)!=null?n:0)>0&&React.createElement("div",{className:"text-muted small"},"\u0110\u1EE3t ",t.split_seq),(()=>{const e=bs(t);if(!e)return null;const a=K.has(String(t.id)),i=e.length>84||ys(t).length>84;return React.createElement(React.Fragment,null,React.createElement("div",{className:`text-muted small order-address ${a?"":"order-text-collapsed"}`},e),i&&React.createElement("button",{type:"button",className:"btn btn-link p-0 order-expand-btn",onClick:o=>{o.stopPropagation(),hs(t.id)}},a?"Thu g\u1ECDn":"Xem th\xEAm"))})(),(()=>{const e=ys(t);if(!e)return null;const a=K.has(String(t.id)),i=bs(t).length,o=i>84||e.length>84;return React.createElement(React.Fragment,null,React.createElement("div",{className:`text-muted small order-note ${a?"":"order-text-collapsed"}`},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",e),o&&i<=0&&React.createElement("button",{type:"button",className:"btn btn-link p-0 order-expand-btn",onClick:g=>{g.stopPropagation(),hs(t.id)}},a?"Thu g\u1ECDn":"Xem th\xEAm"))})()),React.createElement("div",{className:"d-flex align-items-start gap-1 flex-shrink-0"},React.createElement("button",{type:"button",className:`btn btn-sm btn-link order-pin-btn ${st.has(String(t.id))?"active":""}`,onClick:e=>{e.stopPropagation(),rr(t.id)},title:st.has(String(t.id))?"B\u1ECF ghim":"Ghim","aria-label":st.has(String(t.id))?"B\u1ECF ghim":"Ghim"},React.createElement("i",{className:st.has(String(t.id))?"fas fa-star":"far fa-star"})),!!(Sn!=null&&Sn[String(t.id)])&&React.createElement("span",{className:"badge bg-info text-dark orders-sync-badge",title:"\u0110ang \u0111\u1ED3ng b\u1ED9","aria-label":"\u0110ang \u0111\u1ED3ng b\u1ED9"},React.createElement("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}),"Sync"),React.createElement("button",{type:"button",className:`badge ${oa(t.status)} order-status-badge-btn`,onPointerDown:e=>{e.stopPropagation(),jt.current=!1;try{Pt.current&&clearTimeout(Pt.current)}catch(a){}Pt.current=setTimeout(()=>{jt.current=!0,ps(t,e.currentTarget)},420)},onPointerUp:e=>{e.stopPropagation();try{Pt.current&&clearTimeout(Pt.current)}catch(a){}Pt.current=null},onPointerCancel:e=>{e.stopPropagation();try{Pt.current&&clearTimeout(Pt.current)}catch(a){}Pt.current=null},onClick:e=>{if(e.stopPropagation(),jt.current){jt.current=!1;return}ze&&String(H==null?void 0:H.id)===String(t.id)?Un():ps(t,e.currentTarget)},title:"\u0110\u1ED5i tr\u1EA1ng th\xE1i nhanh"},$n(t.status)),Ma(t)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${On} ng\xE0y`},"\u26A0 Ch\u1EADm ",ha(t),"d"),_a(t)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 h\u1EE7y sau ${Jn} ng\xE0y`},"\u23F3 C\xF2n ",Ta(t),"d"))),React.createElement("div",{className:"mt-2 small"},React.createElement("div",null,React.createElement("div",{className:"text-muted"},"S\u1EA3n ph\u1EA9m:"),(()=>{const e=ja(t);return e.length?React.createElement("div",{className:"mt-1"},e.map((a,i)=>React.createElement("div",{key:i,className:"d-flex justify-content-between gap-2",style:{lineHeight:1.25}},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,whiteSpace:"normal",wordBreak:"break-word",flex:1}},React.createElement("span",{className:"text-muted me-1"},i+1,"."),a.name),React.createElement("div",{className:"text-muted small text-end text-nowrap",style:{flexShrink:0}},"x",a.qty,Number(a.unitPrice)>0?` \u2022 ${Fe(a.unitPrice)}`:"")))):React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},da(t))})()),(ya(t)!==0||Qn(t))&&React.createElement("div",{style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh:")," ",React.createElement("span",{className:"fw-semibold"},Fe(ya(t))),Qn(t)?React.createElement("span",{className:"text-muted"}," ","(",Qn(t),")"):null),React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng ti\u1EC1n"),React.createElement("span",{className:"fw-bold"},Fe(wa(t)))),React.createElement("div",{className:"text-muted"},React.createElement("span",null,"Th\u1EDDi gian:")," ",ca(t.created_at))),React.createElement("div",{className:"mt-3 d-flex gap-2 align-items-center order-card-actions"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:e=>{e.stopPropagation(),Fa(t)},disabled:$||!!z||St===t.id},React.createElement("i",{className:"fas fa-copy me-1"}),"Copy"),React.createElement("button",{type:"button",className:"btn btn-sm btn-dark orders-mobile-action",onClick:e=>{e.stopPropagation(),us(t)},disabled:$||!!z||St===t.id,"aria-label":"M\u1EDF thao t\xE1c nhanh"},React.createElement("i",{className:"fas fa-bolt me-1"}),"Thao t\xE1c")))))}),React.createElement("div",{ref:Qe,className:"orders-mobile-sentinel","aria-hidden":"true"}),Array.isArray(an)&&Ds.length<an.length&&React.createElement("div",{className:"text-center text-muted small py-2"},"\u0110ang t\u1EA3i th\xEAm\u2026")),ze&&H&&React.createElement("div",{className:"orders-status-popover-root",role:"dialog","aria-modal":"true",onClick:()=>Un()},React.createElement("div",{className:`orders-status-popover ${(G==null?void 0:G.placement)||""}`,style:{left:G.left,top:G.top},onClick:t=>t.stopPropagation()},React.createElement("div",{className:"orders-status-popover-title"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0}},H.customer_name||"\u0110\u01A1n h\xE0ng"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>Un(),"aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"orders-status-popover-grid"},ua.map(t=>{const n=bn(H.status)===bn(t.value),e=$||!!z||St===H.id;return React.createElement("button",{key:t.value,type:"button",className:`orders-status-chip ${n?"active":""}`,onClick:()=>{n||(Zn(H,t.value),Un())},disabled:e},t.label)})),React.createElement("div",{className:"orders-status-popover-footer"},React.createElement("button",{type:"button",className:"btn btn-sm btn-dark",onClick:()=>{us(H),Un()}},React.createElement("i",{className:"fas fa-bolt me-2"}),"Thao t\xE1c")))),ct&&Ke&&React.createElement("div",{className:"admin-sheet-root",role:"dialog","aria-modal":"true",onClick:()=>qn()},React.createElement("div",{className:"admin-sheet",onClick:t=>t.stopPropagation()},React.createElement("div",{className:"admin-sheet-handle"}),React.createElement("div",{className:"admin-sheet-header"},React.createElement("div",{style:{minWidth:0}},React.createElement("div",{className:"fw-semibold admin-sheet-title"},Ke.customer_name||"\u0110\u01A1n h\xE0ng"),React.createElement("div",{className:"text-muted small d-flex align-items-center gap-2",style:{flexWrap:"wrap"}},React.createElement("span",{className:"font-monospace"},Ke.phone||""),React.createElement("span",{className:`badge ${oa(Ke.status)}`},$n(Ke.status)))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>qn(),"aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"admin-sheet-actions"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{Fa(Ke),qn()},disabled:$||!!z||St===Ke.id},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy"),!!String(Ke.phone||"").trim()&&React.createElement("a",{className:"btn btn-outline-secondary",href:`tel:${String(Ke.phone||"").trim()}`,onClick:()=>qn()},React.createElement("i",{className:"fas fa-phone me-2"}),"G\u1ECDi"),React.createElement("button",{type:"button",className:"btn btn-dark",onClick:()=>{ba(Ke),qn()}},React.createElement("i",{className:"fas fa-eye me-2"}),"M\u1EDF chi ti\u1EBFt"),React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>qs(Ke.id),disabled:$||!!z||St===Ke.id},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a")),React.createElement("div",{className:"admin-sheet-section-title"},"\u0110\u1ED5i tr\u1EA1ng th\xE1i"),React.createElement("div",{className:"orders-status-grid"},ua.map(t=>{const n=bn(Ke.status)===bn(t.value),e=$||!!z||St===Ke.id;return React.createElement("button",{key:t.value,type:"button",className:`orders-status-chip ${n?"active":""}`,onClick:()=>{n||(Zn(Ke,t.value),qn())},disabled:e},t.label)})))),r&&React.createElement("div",{className:"admin-sheet-root",role:"dialog","aria-modal":"true",onClick:()=>Ca()},React.createElement("div",{className:"admin-sheet",onClick:t=>t.stopPropagation()},React.createElement("div",{className:"admin-sheet-handle"}),React.createElement("div",{className:"admin-sheet-header"},React.createElement("div",{style:{minWidth:0}},React.createElement("div",{className:"fw-semibold admin-sheet-title"},"L\u1ECDc \u0111\u01A1n h\xE0ng"),React.createElement("div",{className:"text-muted small"},"T\u1ED1i \u01B0u cho thao t\xE1c m\u1ED9t tay")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>Ca(),"aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"p-3"},React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>Fn("thisMonth"),disabled:te},React.createElement("i",{className:"fas fa-calendar me-2"}),"Th\xE1ng n\xE0y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger",onClick:()=>Fn("overduePending"),disabled:te},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"Ch\u1EADm"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>Fn("draftExpiring"),disabled:te},React.createElement("i",{className:"fas fa-clock me-2"}),"Nh\xE1p s\u1EAFp h\u1EE7y")),React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"fw-semibold mb-2"},"Tr\u1EA1ng th\xE1i"),React.createElement("div",{className:"orders-filter-chip-grid"},React.createElement("button",{type:"button",className:`orders-filter-chip ${!Y&&!kt?"active":""}`,onClick:()=>{te&&Kt(""),$t(!1),dt("")}},"T\u1EA5t c\u1EA3"),ua.map(t=>React.createElement("button",{key:t.value,type:"button",className:`orders-filter-chip ${Y===t.value&&!kt?"active":""}`,onClick:()=>{te&&Kt(""),$t(!1),dt(t.value),t.value==="draft"&&q("")}},t.label)))),React.createElement("div",{className:"mt-3"},React.createElement("label",{className:"form-label small text-muted mb-1"},"Th\xE1ng"),React.createElement("input",{type:"month",className:"form-control",value:x,onChange:t=>q(t.target.value),disabled:kt||te}),React.createElement("div",{className:"form-text"},"B\u1EADt \u201CCh\u1EADm\u201D s\u1EBD b\u1ECF qua th\xE1ng.")),React.createElement("div",{className:"form-check mt-3"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"ordersOverdueOnly",checked:kt,onChange:t=>{te&&Kt("");const n=!!t.target.checked;$t(n),n&&(q(""),dt("pending"))},disabled:te}),React.createElement("label",{className:"form-check-label",htmlFor:"ordersOverdueOnly"},"Ch\u1EC9 xem \u0111\u01A1n ch\u1EADm > ",On," ng\xE0y")),React.createElement("div",{className:"d-flex gap-2 mt-4"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>Fn("all"),disabled:te},"Reset"),React.createElement("button",{type:"button",className:"btn btn-dark flex-grow-1",onClick:()=>Ca()},"Xong"))))),React.createElement("div",{className:`orders-mobile-toolbar d-md-none ${C?"visible":""}`},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onPointerDown:t=>{if(!(t.button!=null&&t.button!==0)){O.current=!1;try{Bt.current&&clearTimeout(Bt.current)}catch(n){}Bt.current=setTimeout(()=>{O.current=!0,fs(se)},460)}},onPointerUp:()=>{try{Bt.current&&clearTimeout(Bt.current)}catch(t){}Bt.current=null},onPointerCancel:()=>{try{Bt.current&&clearTimeout(Bt.current)}catch(t){}Bt.current=null},onClick:()=>{if(O.current){O.current=!1;return}try{window.scrollTo({top:0,behavior:"smooth"})}catch(t){}setTimeout(()=>{var t,n;return(n=(t=dn.current)==null?void 0:t.focus)==null?void 0:n.call(t)},120)},"aria-label":"Search"},React.createElement("i",{className:"fas fa-search me-2"}),"Search"),React.createElement("button",{type:"button",className:"btn btn-dark",onClick:()=>Pa(),disabled:$||!!z,"aria-label":"T\u1EA1o \u0111\u01A1n"},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o \u0111\u01A1n"),React.createElement("button",{type:"button",className:"btn btn-outline-dark",onClick:()=>sr(),"aria-label":"L\u1ECDc"},React.createElement("i",{className:"fas fa-sliders me-2"}),"L\u1ECDc")),At&&React.createElement("div",{className:"orders-search-palette-root",role:"dialog","aria-modal":"true",onClick:()=>{pa(pt),_n()}},React.createElement("div",{className:"orders-search-palette",onClick:t=>t.stopPropagation(),onTouchStart:t=>{const n=t.touches&&t.touches[0];n&&(mt.current={active:!0,startY:n.clientY,startX:n.clientX,fired:!1})},onTouchMove:t=>{const n=mt.current;if(!(n!=null&&n.active)||n.fired)return;const e=t.touches&&t.touches[0];if(!e)return;const a=e.clientY-n.startY,i=e.clientX-n.startX;Math.abs(i)>24||a>90&&(n.fired=!0,pa(pt),_n())},onTouchEnd:()=>{mt.current={active:!1,startY:0,startX:0,fired:!1}}},React.createElement("div",{className:"orders-search-palette-header"},React.createElement("div",{className:"fw-semibold"},"T\xECm nhanh"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{pa(pt),_n()},"aria-label":"\u0110\xF3ng"},React.createElement("i",{className:"fas fa-xmark"}))),React.createElement("div",{className:"orders-search-palette-body"},React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-search"})),React.createElement("input",{ref:ve,type:"text",className:"form-control",value:pt,onChange:t=>{const n=t.target.value;zt(n),Kt(n)},placeholder:"Nh\u1EADp t\xEAn / S\u0110T\u2026",onKeyDown:t=>{t.key==="Enter"&&(pa(pt),_n())}}),!!String(pt||"").trim()&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{zt(""),Kt("")}},React.createElement("i",{className:"fas fa-times"}))),Array.isArray(De)&&De.length>0&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"text-muted small mb-2"},"G\u1EA7n \u0111\xE2y"),React.createElement("div",{className:"orders-chip-row",style:{marginTop:0}},De.slice(0,8).map(t=>React.createElement("button",{key:t,type:"button",className:"orders-chip",onClick:()=>{zt(t),Kt(t),pa(t),_n()}},t)))),React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"text-muted small mb-2"},"Filter nhanh"),React.createElement("div",{className:"orders-filter-chip-grid"},React.createElement("button",{type:"button",className:`orders-filter-chip ${rt?"active":""}`,onClick:()=>{Kt(""),zt(""),$t(!1),Wt(!1),Dt(t=>!t),_n()}},React.createElement("i",{className:"fas fa-star me-2"}),"\u01AFu ti\xEAn"),React.createElement("button",{type:"button",className:`orders-filter-chip ${It?"active":""}`,onClick:()=>{Kt(""),zt(""),$t(!1),Dt(!1),Wt(t=>!t),_n()}},React.createElement("i",{className:"fas fa-calendar me-2"}),"H\xF4m nay"),React.createElement("button",{type:"button",className:`orders-filter-chip ${kt?"active":""}`,onClick:()=>{Kt(""),zt(""),$t(t=>!t),kt||(q(""),dt("pending")),_n()}},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"Ch\u1EADm"),React.createElement("button",{type:"button",className:`orders-filter-chip ${!Y&&!kt&&!rt&&!It?"active":""}`,onClick:()=>{Kt(""),zt(""),$t(!1),Dt(!1),Wt(!1),dt(""),_n()}},"T\u1EA5t c\u1EA3"),ua.map(t=>React.createElement("button",{key:t.value,type:"button",className:`orders-filter-chip ${Y===t.value&&!kt?"active":""}`,onClick:()=>{Kt(""),zt(""),$t(!1),Dt(!1),Wt(!1),dt(t.value),t.value==="draft"&&q(""),_n()}},t.label))))),React.createElement("div",{className:"orders-search-palette-hint text-muted small"},"Tip: Gi\u1EEF n\xFAt Search \u0111\u1EC3 m\u1EDF \u2022 Vu\u1ED1t xu\u1ED1ng \u0111\u1EC3 \u0111\xF3ng"))),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive orders-table-wrap mt-3"},React.createElement("table",{className:"table orders-table table-hover align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"SL"),React.createElement("th",null,"T\u1ED5ng ti\u1EC1n"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"),React.createElement("th",null,"Th\u1EDDi gian"),React.createElement("th",null))),React.createElement("tbody",null,an.map(t=>React.createElement("tr",{key:t.id,style:{cursor:"pointer"},onClick:()=>ba(t),title:"Xem chi ti\u1EBFt"},React.createElement("td",null,React.createElement("div",{className:"fw-semibold"},t.customer_name),((t==null?void 0:t.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(t.note||"").trim())),React.createElement("td",null,t.phone),React.createElement("td",null,(()=>{const n=ja(t);return n.length?React.createElement("div",{className:"d-grid gap-1"},n.map((e,a)=>React.createElement("div",{key:a,className:"small",style:{whiteSpace:"normal",wordBreak:"break-word",lineHeight:1.2}},React.createElement("span",{className:"text-muted me-1"},a+1,"."),React.createElement("span",{className:"fw-semibold"},e.name)," ",React.createElement("span",{className:"text-muted"},"x",e.qty),Number(e.unitPrice)>0&&React.createElement("span",{className:"text-muted"}," ","\u2022 ",Fe(e.unitPrice))))):da(t)})()),React.createElement("td",null,Ls(t)),React.createElement("td",{className:"fw-semibold"},Fe(wa(t))),React.createElement("td",null,React.createElement("div",{className:"d-flex align-items-center gap-1 flex-wrap"},React.createElement("span",{className:`badge ${oa(t.status)}`},$n(t.status)),Ma(t)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${On} ng\xE0y`},"\u26A0 Ch\u1EADm ",ha(t),"d"),_a(t)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 h\u1EE7y sau ${Jn} ng\xE0y`},"\u23F3 C\xF2n ",Ta(t),"d"))),React.createElement("td",null,ca(t.created_at)),React.createElement("td",null,React.createElement("div",{className:"d-flex gap-2 justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:n=>{n.stopPropagation(),Fa(t)},disabled:$||!!z||St===t.id},React.createElement("i",{className:"fas fa-copy"})),React.createElement("select",{className:"form-select form-select-sm orders-status-quick",defaultValue:"",onClick:n=>n.stopPropagation(),onChange:n=>{n.stopPropagation();const e=String(n.target.value||"").trim();n.target.value="",e&&Zn(t,e)},disabled:$||!!z||St===t.id,"aria-label":"\u0110\u1ED5i tr\u1EA1ng th\xE1i"},React.createElement("option",{value:""},"Status\u2026"),React.createElement("option",{value:"pending"},"Pending"),React.createElement("option",{value:"processing"},"Processing"),React.createElement("option",{value:"done"},"Done"),React.createElement("option",{value:"paid"},"Paid"),React.createElement("option",{value:"canceled"},"H\u1EE7y")))))))))),!te&&Et&&!kt&&React.createElement("div",{className:"d-flex justify-content-center mt-3"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:xr,disabled:Vt||Ct},Ct?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2","aria-hidden":"true"}),"\u0110ang t\u1EA3i th\xEAm..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-angle-down me-2"}),"T\u1EA3i th\xEAm \u0111\u01A1n"))))),React.createElement(AdminDrawer,{open:Se,title:(()=>{const t=xt,n=t!=null&&t.id?`#${t.id}`:"",e=t!=null&&t.status?`\u2022 ${$n(t.status)}`:"";return`\u0110\u01A1n h\xE0ng ${n} ${e}`.trim()})(),subtitle:(()=>{const t=xt,n=String((t==null?void 0:t.customer_name)||"").trim(),e=String((t==null?void 0:t.phone)||"").trim(),a=t!=null&&t.created_at?ca(t.created_at):"";return[n||e||null,a||null].filter(Boolean).join(" \u2022 ")})(),onClose:Rs,footer:React.createElement("div",{className:"d-flex flex-wrap gap-2 justify-content-between"},yn?React.createElement(React.Fragment,null,React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{vn(!1),nn(null),Hn(""),w(!1),Mt([])},disabled:$||ht},React.createElement("i",{className:"fas fa-xmark me-2"}),"H\u1EE7y s\u1EEDa"),!!be&&React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary fw-semibold",onClick:Ks,disabled:$||ht,title:"Ch\u1ECDn s\u1EA3n ph\u1EA9m giao \u0111\u1EE3t 1 v\xE0 t\xE1ch ph\u1EA7n c\xF2n l\u1EA1i sang \u0111\u01A1n ch\u1EDD h\xE0ng"},ht?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang t\xE1ch..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-random me-2"}),"T\xE1ch giao ngay"))),React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-warning fw-semibold",onClick:()=>Ba({mode:"close",origin:"drawer"}),disabled:$||ht||!Re.canSubmit,style:{boxShadow:"0 4px 12px rgba(255,193,7,0.25)"}},$?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u")))):React.createElement(React.Fragment,null,React.createElement("div",{className:"d-flex flex-wrap gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>xt&&Fa(xt),disabled:!xt||Je||$||!!z},React.createElement("i",{className:"fas fa-copy me-2"}),"Copy"),React.createElement("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>xt&&Za(xt),disabled:!xt||Je||$||!!z},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger",onClick:()=>xt&&qs(xt.id),disabled:!xt||Je||$||!!z},React.createElement("i",{className:"fas fa-trash me-2"}),"X\xF3a")),React.createElement("div",{className:"d-flex flex-wrap gap-2 align-items-center"},React.createElement("select",{className:"form-select form-select-sm",defaultValue:"",onChange:t=>{const n=String(t.target.value||"").trim();t.target.value="",n&&xt&&Zn(xt,n)},disabled:!xt||Je||$||!!z||St===(xt==null?void 0:xt.id),"aria-label":"\u0110\u1ED5i tr\u1EA1ng th\xE1i",style:{minWidth:140}},React.createElement("option",{value:""},"Status\u2026"),React.createElement("option",{value:"pending"},"Pending"),React.createElement("option",{value:"processing"},"Processing"),React.createElement("option",{value:"done"},"Done"),React.createElement("option",{value:"paid"},"Paid"),React.createElement("option",{value:"canceled"},"H\u1EE7y")))))},yn?React.createElement("form",{onSubmit:t=>{t.preventDefault(),Ba({mode:"close",origin:"drawer"})}},React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-pen me-2 text-warning"}),"Ch\u1EC9nh s\u1EEDa"),Ir())):Je?React.createElement("div",{className:"admin-drawer-section"},React.createElement("div",{className:"text-muted small mb-2"},"\u0110ang t\u1EA3i chi ti\u1EBFt\u2026"),React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("span",{className:"spinner-border spinner-border-sm text-warning","aria-hidden":"true"}),React.createElement("span",{className:"text-muted"},"Vui l\xF2ng ch\u1EDD"))):mn?React.createElement("div",{className:"alert alert-danger",role:"alert"},mn):xt?React.createElement(React.Fragment,null,React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-circle-info me-2 text-warning"}),"T\u1ED5ng quan"),React.createElement("div",{className:"d-flex flex-wrap gap-2 mb-2"},React.createElement("span",{className:`badge ${oa(xt.status)}`},$n(xt.status)),Ma(xt)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${On} ng\xE0y`},"\u26A0 Ch\u1EADm ",ha(xt),"d"),_a(xt)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 h\u1EE7y sau ${Jn} ng\xE0y`},"\u23F3 C\xF2n ",Ta(xt),"d")),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"T\u1ED5ng ti\u1EC1n"),React.createElement("div",{className:"v"},Fe(wa(xt))),React.createElement("div",{className:"k"},"S\u1ED1 l\u01B0\u1EE3ng"),React.createElement("div",{className:"v"},Ls(xt)),React.createElement("div",{className:"k"},"Th\u1EDDi gian"),React.createElement("div",{className:"v"},ca(xt.created_at)))),React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-user me-2 text-info"}),"Kh\xE1ch h\xE0ng"),React.createElement("div",{className:"admin-kv"},React.createElement("div",{className:"k"},"T\xEAn"),React.createElement("div",{className:"v"},xt.customer_name||"\u2014"),React.createElement("div",{className:"k"},"S\u0110T"),React.createElement("div",{className:"v",style:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}},React.createElement("span",{className:"font-monospace"},xt.phone||"\u2014"),!!String(xt.phone||"").trim()&&React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>window.KTM.clipboard.writeText(String(xt.phone||"").trim()),title:"Copy S\u0110T"},React.createElement("i",{className:"fas fa-copy"}))),React.createElement("div",{className:"k"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("div",{className:"v"},xt.address||"\u2014")),((xt==null?void 0:xt.note)||"").trim()&&React.createElement("div",{className:"mt-2 text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(xt.note||"").trim())),React.createElement("div",{className:"admin-drawer-section"},React.createElement("h6",null,React.createElement("i",{className:"fas fa-boxes-stacked me-2 text-primary"}),"S\u1EA3n ph\u1EA9m"),(()=>{const t=ja(xt);return t.length?React.createElement("div",{className:"d-grid gap-2"},t.map((n,e)=>React.createElement("div",{key:e,className:"d-flex justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted me-1"},e+1,"."),n.name),n.variant?React.createElement("div",{className:"text-muted small"},n.variant):null),React.createElement("div",{className:"text-muted small text-end text-nowrap",style:{flexShrink:0}},"x",n.qty,Number(n.unitPrice)>0?` \u2022 ${Fe(n.unitPrice)}`:"")))):React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},da(xt)||"\u2014")})(),(ya(xt)!==0||Qn(xt))&&React.createElement("div",{className:"mt-2",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh:")," ",React.createElement("span",{className:"fw-semibold"},Fe(ya(xt))),Qn(xt)?React.createElement("span",{className:"text-muted"}," ","(",Qn(xt),")"):null))):React.createElement("div",{className:"text-muted"},"Ch\u01B0a c\xF3 d\u1EEF li\u1EC7u")),Zt&&React.createElement("div",{className:"modal show d-block order-modal",style:{background:"rgba(0,0,0,0.6)"},role:"dialog","aria-modal":"true"},React.createElement("div",{className:"modal-dialog modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ffca2c)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark mb-0"},React.createElement("i",{className:"fas fa-receipt me-2"}),be?"S\u1EEDa \u0111\u01A1n h\xE0ng":"T\u1EA1o \u0111\u01A1n h\xE0ng"),React.createElement("button",{type:"button",className:"btn-close",onClick:ts})),React.createElement("form",{onSubmit:t=>{t.preventDefault(),Ba({mode:"close",origin:"modal"})}},React.createElement("div",{className:"modal-body",ref:tn},React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"T\xEAn kh\xE1ch h\xE0ng *"),React.createElement("input",{className:"form-control",value:y.customer_name,onChange:t=>gt({...y,customer_name:t.target.value}),placeholder:"Nh\u1EADp t\xEAn kh\xE1ch h\xE0ng",required:!0,style:{borderRadius:10,padding:12}}),!!Re.nameError&&React.createElement("div",{className:"form-text text-danger"},Re.nameError)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i *"),React.createElement("input",{className:"form-control",type:"tel",inputMode:"numeric",pattern:"[0-9+\\s-]*",id:"order-phone-input",value:y.phone,onChange:t=>Ms(t.target.value),onBlur:Ts,placeholder:"Nh\u1EADp s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",required:!0,style:{borderRadius:10,padding:12}}),!!Re.phoneError&&React.createElement("div",{className:"form-text text-danger"},Re.phoneError),!Re.phoneError&&kn.count>0&&React.createElement("div",{className:"form-text text-warning d-flex align-items-center justify-content-between gap-2"},React.createElement("span",null,"Kh\xE1ch n\xE0y \u0111\xE3 c\xF3 ",kn.count," \u0111\u01A1n trong th\xE1ng ",kn.monthKey,"."),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>w(t=>!t)},S?"\u1EA8n l\u1ECBch s\u1EED":"Xem l\u1ECBch s\u1EED")),S&&kn.orders.length>0&&React.createElement("div",{className:"mt-2 border rounded-3 p-2",style:{background:"#fff"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between gap-2 mb-2"},React.createElement("div",{className:"small fw-semibold"},"L\u1ECBch s\u1EED \u0111\u01A1n (c\xF9ng th\xE1ng)"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>w(!1)},"\u1EA8n")),React.createElement("div",{className:"d-grid gap-2"},kn.orders.slice(0,5).map(t=>React.createElement("div",{key:t.id,className:"d-flex align-items-start justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"small fw-semibold",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},"#",t.id," \u2022 ",React.createElement("span",{className:`badge ${oa(t.status)}`},$n(t.status))),React.createElement("div",{className:"text-muted small"},ca(t.created_at)," \u2022 ",Fe(wa(t))),React.createElement("div",{className:"text-muted small",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},da(t))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{confirm(`M\u1EDF \u0111\u01A1n #${t.id}? D\u1EEF li\u1EC7u \u0111ang nh\u1EADp s\u1EBD m\u1EA5t.`)&&Za(t)}},"M\u1EDF")))),kn.orders.length>5&&React.createElement("div",{className:"text-muted small mt-2"},"Ch\u1EC9 hi\u1EC3n th\u1ECB 5 \u0111\u01A1n g\u1EA7n nh\u1EA5t.")),(k==null?void 0:k.status)==="loading"&&React.createElement("div",{className:"form-text"},"\u0110ang t\xECm kh\xE1ch theo S\u0110T..."),(k==null?void 0:k.status)==="found"&&React.createElement("div",{className:"form-text text-success"},"\u0110\xE3 c\xF3 kh\xE1ch, t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n th\xF4ng tin."),(k==null?void 0:k.status)==="not-found"&&React.createElement("div",{className:"form-text text-muted"},"Ch\u01B0a c\xF3 kh\xE1ch, s\u1EBD t\u1EA1o m\u1EDBi khi l\u01B0u \u0111\u01A1n."),(k==null?void 0:k.status)==="error"&&React.createElement("div",{className:"form-text text-danger"},"Kh\xF4ng tra \u0111\u01B0\u1EE3c kh\xE1ch (l\u1ED7i m\u1EA1ng/server).")),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("select",{className:"form-select",value:y.status,onChange:t=>gt({...y,status:t.target.value}),style:{borderRadius:10,padding:12}},React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n"))),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("input",{className:"form-control",value:y.address,onChange:t=>gt({...y,address:t.target.value}),placeholder:"Nh\u1EADp \u0111\u1ECBa ch\u1EC9 (kh\xF4ng b\u1EAFt bu\u1ED9c)",style:{borderRadius:10,padding:12}}),!!Re.addressWarn&&React.createElement("div",{className:"form-text text-warning"},Re.addressWarn)),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111\u01A1n h\xE0ng"),React.createElement("textarea",{className:"form-control",value:y.note,onChange:t=>gt({...y,note:t.target.value}),placeholder:"V\xED d\u1EE5: Giao gi\u1EDD h\xE0nh ch\xEDnh / G\u1ECDi tr\u01B0\u1EDBc khi giao...",rows:2,style:{borderRadius:10,padding:12,resize:"vertical"}})),React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110i\u1EC1u ch\u1EC9nh gi\xE1 (th\xEAm/b\u1EDBt)"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{gt(t=>({...t,adjustment_items:[...Array.isArray(t.adjustment_items)?t.adjustment_items:[{amount:"",note:""}],{amount:"",note:""}]}))}},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm \u0111i\u1EC1u ch\u1EC9nh")),React.createElement("div",{className:"d-grid gap-2"},Pn(y.adjustment_items).map((t,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label small text-muted mb-1"},"S\u1ED1 ti\u1EC1n"),React.createElement("input",{type:"text",inputMode:"numeric",className:"form-control",value:t.amount,onChange:e=>{const a=e.target.value;gt(i=>{const o=Pn(i.adjustment_items);return o[n]={...o[n],amount:a},{...i,adjustment_items:o}})},placeholder:"+500000 ho\u1EB7c -200000",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("label",{className:"form-label small text-muted mb-1"},"Ghi ch\xFA"),React.createElement("input",{className:"form-control",value:t.note,onChange:e=>{const a=e.target.value;gt(i=>{const o=Pn(i.adjustment_items);return o[n]={...o[n],note:a},{...i,adjustment_items:o}})},placeholder:"V\xED d\u1EE5: th\xEAm van 1 tay / gi\u1EA3m gi\xE1...",style:{borderRadius:10,padding:12}})),React.createElement("div",{className:"col-12 col-md-1 d-flex"},React.createElement("button",{type:"button",className:"btn btn-outline-danger w-100",onClick:()=>{gt(e=>{const a=Pn(e.adjustment_items);return a.splice(n,1),{...e,adjustment_items:a.length?a:[{amount:"",note:""}]}})},disabled:$||Pn(y.adjustment_items).length<=1,title:"X\xF3a \u0111i\u1EC1u ch\u1EC9nh",style:{borderRadius:10,padding:12}},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement("div",{className:"form-text"},"\xC2m = gi\u1EA3m gi\xE1, d\u01B0\u01A1ng = c\u1ED9ng th\xEAm."),!!Re.adjustmentAbnormalWarn&&React.createElement("div",{className:"form-text text-warning"},Re.adjustmentAbnormalWarn),!!Re.adjustmentNoteWarn&&React.createElement("div",{className:"form-text text-warning"},Re.adjustmentNoteWarn)),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1EA3n ph\u1EA9m *"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{gt(t=>({...t,items:[...Array.isArray(t.items)?t.items:[],{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]})),oe(t=>[...Array.isArray(t)?t:[],""]),be&&Mt(t=>[...Array.isArray(t)?t:[],!0])},disabled:$},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(y.items)?y.items:[{product_id:"",quantity:1}]).map((t,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"dropdown w-100",ref:e=>{Ze.current[n]=e}},React.createElement("button",{type:"button",className:"form-control text-start d-flex align-items-center justify-content-between",style:{borderRadius:10,padding:12},onClick:()=>{Ae(e=>e===n?null:n),setTimeout(()=>{const e=document.getElementById(`order-product-search-${n}`);e&&e.focus()},0)}},React.createElement("span",{className:t.product_id?"":"text-muted",style:{minWidth:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},Os(t.product_id)),React.createElement("i",{className:"fas fa-chevron-down text-muted",style:{marginLeft:8,flexShrink:0}})),le===n&&React.createElement("div",{className:"dropdown-menu show w-100 p-2",style:{maxHeight:320,overflowY:"auto"}},React.createElement("input",{id:`order-product-search-${n}`,className:"form-control",value:ft[n]||"",onChange:e=>{const a=e.target.value;oe(i=>{const o=Array.isArray(i)?[...i]:[];return o[n]=a,o})},placeholder:"T\xECm theo t\xEAn / m\xE3...",style:{borderRadius:10,padding:10}}),React.createElement("div",{className:"mt-2"}),(()=>{const e=Es(n);return e.length===0?React.createElement("div",{className:"text-muted small px-2 py-1"},"Kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p"):e.map(a=>React.createElement("button",{key:a.id,type:"button",className:"dropdown-item",onClick:()=>{const i=String(a.id),o=Vn(a==null?void 0:a.variants),g={};for(const v of o){const u=String((v==null?void 0:v.name)||"").trim(),_=Array.isArray(v==null?void 0:v.options)?v.options[0]:null,N=String((_==null?void 0:_.label)||"").trim();u&&N&&(g[u]=N)}const m=La(g),I=la(a,g);gt(v=>{const u=Array.isArray(v.items)?[...v.items]:[];return u[n]={...u[n]||{quantity:1},product_id:i,variant_json:Object.keys(g).length?g:null,variant:m,unit_price:o.length?I:null},{...v,items:u}}),Ae(null)}},a.name,a.code?` (${a.code})`:""))})()),React.createElement("select",{className:"form-select",value:t.product_id,onChange:()=>{},required:!0,style:{position:"absolute",opacity:0,height:0,pointerEvents:"none"},tabIndex:-1,"aria-hidden":"true"},React.createElement("option",{value:""},"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"),qe.map(e=>React.createElement("option",{key:e.id,value:e.id},e.name)))),(()=>{var a;const e=(a=Re.items)==null?void 0:a[n];return e?React.createElement(React.Fragment,null,!!e.productError&&React.createElement("div",{className:"form-text text-danger"},e.productError),!!e.dupWarn&&React.createElement("div",{className:"form-text text-warning"},e.dupWarn)):null})(),(()=>{if(!(t!=null&&t.product_id))return null;const e=Tn(t.product_id),a=Vn(e==null?void 0:e.variants);if(!a.length)return null;const i=t!=null&&t.variant_json&&typeof t.variant_json=="object"?t.variant_json:{};return React.createElement("div",{className:"mt-2 d-grid gap-2"},a.map((o,g)=>{const m=String((o==null?void 0:o.name)||`Bi\u1EBFn th\u1EC3 ${g+1}`).trim(),I=String((i==null?void 0:i[m])||"").trim();return React.createElement("div",{key:m},React.createElement("label",{className:"form-label small text-muted mb-1"},m),React.createElement("select",{className:"form-select",value:I,onChange:v=>{const u=String(v.target.value||"").trim();gt(_=>{const N=Array.isArray(_.items)?[..._.items]:[],B={...N[n]||{}},T=Tn(B.product_id),yt=Vn(T==null?void 0:T.variants),ce=B!=null&&B.variant_json&&typeof B.variant_json=="object"?{...B.variant_json}:{};u?ce[m]=u:delete ce[m];const Ge=La(ce),we=la(T,ce);return N[n]={...B,variant_json:Object.keys(ce).length?ce:null,variant:Ge,unit_price:we},{..._,items:N}})},style:{borderRadius:10,padding:12}},React.createElement("option",{value:""},"-- ch\u1ECDn ",m," --"),(Array.isArray(o==null?void 0:o.options)?o.options:[]).map(v=>React.createElement("option",{key:v.label,value:v.label},v.label,Number.isFinite(Number(v==null?void 0:v.price))?` (${Fe(Number(v.price))})`:Number(v==null?void 0:v.price_delta)?` (${v.price_delta>0?"+":""}${v.price_delta})`:""))))}))})(),be&&React.createElement("div",{className:"form-check mt-1"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:`order-split-deliver-${n}`,checked:!!Ot[n],onChange:e=>{const a=!!e.target.checked;Mt(i=>{const o=Array.isArray(i)?[...i]:[],g=Array.isArray(y.items)?y.items.length:0;for(;o.length<g;)o.push(!0);return o[n]=a,o})},disabled:$||ht}),React.createElement("label",{className:"form-check-label small text-muted",htmlFor:`order-split-deliver-${n}`},"Giao \u0111\u1EE3t 1"))),React.createElement("div",{className:"col-8 col-md-3"},React.createElement("input",{type:"number",className:"form-control",value:t.quantity,onChange:e=>{const a=e.target.value;gt(i=>{const o=Array.isArray(i.items)?[...i.items]:[];return o[n]={...o[n]||{product_id:""},quantity:a},{...i,items:o}})},min:"1",style:{borderRadius:10,padding:12}}),(()=>{var a;const e=(a=Re.items)==null?void 0:a[n];return e&&e.qtyError?React.createElement("div",{className:"form-text text-danger"},e.qtyError):null})()),React.createElement("div",{className:"col-4 col-md-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>{gt(e=>{const a=Array.isArray(e.items)?[...e.items]:[];return a.splice(n,1),{...e,items:a.length?a:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]}}),oe(e=>{const a=Array.isArray(e)?[...e]:[];return a.splice(n,1),a.length?a:[""]}),Mt(e=>{const a=Array.isArray(e)?[...e]:[];return a.splice(n,1),a}),Ae(e=>e==null?e:e===n?null:e>n?e-1:e)},disabled:$||ht||(Array.isArray(y.items)?y.items.length:1)<=1,title:"X\xF3a s\u1EA3n ph\u1EA9m",style:{borderRadius:10,padding:10}},React.createElement("i",{className:"fas fa-trash"}))))))),(()=>{const n=(Array.isArray(y.items)?y.items:[]).filter(m=>m==null?void 0:m.product_id),e=Na(n),a=va(n),i=Ja(y),o=i.amount,g=e+(a.found?a.fee:0)+o;return React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-column gap-1 small bg-light rounded-3 p-3"},React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1EA1m t\xEDnh"),React.createElement("span",{className:"fw-semibold"},Fe(e))),a.found&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"Ship"),React.createElement("span",{className:"fw-semibold"},Fe(a.fee))),!!Re.shipAbnormalWarn&&React.createElement("div",{className:"text-warning"},Re.shipAbnormalWarn),o!==0&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh"),React.createElement("span",{className:"fw-semibold"},Fe(o))),(y.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111\u01A1n: ",(y.note||"").trim()),!!i.summaryText&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh: ",i.summaryText),React.createElement("div",{className:"d-flex justify-content-between pt-1 border-top"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng"),React.createElement("span",{className:"fw-bold"},Fe(g)))))})())),React.createElement("div",{className:"modal-footer",style:{border:"none"}},React.createElement("button",{type:"button",className:"btn btn-light",onClick:ts,disabled:$||ht,style:{borderRadius:10}},"H\u1EE7y"),!!be&&React.createElement("button",{type:"button",className:"btn btn-outline-primary fw-semibold",onClick:Ks,disabled:$||ht,style:{borderRadius:10},title:"Ch\u1ECDn s\u1EA3n ph\u1EA9m giao \u0111\u1EE3t 1 v\xE0 t\xE1ch ph\u1EA7n c\xF2n l\u1EA1i sang \u0111\u01A1n ch\u1EDD h\xE0ng"},ht?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang t\xE1ch..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-random me-2"}),"T\xE1ch \u0111\u01A1n giao ngay")),!be&&React.createElement("button",{type:"button",className:"btn btn-outline-warning fw-semibold",onClick:()=>Ba({mode:"new",origin:"modal"}),disabled:$||!Re.canSubmit,style:{borderRadius:10},title:"L\u01B0u xong gi\u1EEF form \u0111\u1EC3 t\u1EA1o \u0111\u01A1n m\u1EDBi"},React.createElement("i",{className:"fas fa-plus me-2"}),"L\u01B0u & t\u1EA1o \u0111\u01A1n m\u1EDBi"),React.createElement("button",{type:"submit",className:"btn btn-warning fw-semibold",disabled:$||ht||!Re.canSubmit,style:{borderRadius:10,boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},$?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u"))))))))}

