const{useState,useEffect,useRef}=React,CLOUDINARY_CLOUD_NAME="diwxfpt92",CLOUDINARY_UPLOAD_PRESET="ktm_unsigned",API_BASE="";function LoginPage({onLogin:A,error:w}){const[L,Y]=useState(""),[X,y]=useState(""),[K,se]=useState(!1),[oe,W]=useState(!1);return React.createElement("div",{className:"login-page"},React.createElement("div",{className:"login-box"},React.createElement("div",{className:"text-center mb-4"},React.createElement("i",{className:"fas fa-tractor fa-3x text-warning mb-3"}),React.createElement("h4",{className:"text-dark"},"KTM Admin"),React.createElement("p",{className:"text-muted small"},"\u0110\u0103ng nh\u1EADp \u0111\u1EC3 qu\u1EA3n l\xFD")),w&&React.createElement("div",{className:"alert alert-danger py-2 small"},React.createElement("i",{className:"fas fa-exclamation-circle me-2"}),w),React.createElement("form",{onSubmit:async Ne=>{Ne.preventDefault(),se(!0),await A(L,X),se(!1)}},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small"},"T\xEAn \u0111\u0103ng nh\u1EADp"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-user"})),React.createElement("input",{type:"text",className:"form-control",value:L,onChange:Ne=>Y(Ne.target.value),placeholder:"admin",required:!0,autoFocus:!0}))),React.createElement("div",{className:"mb-4"},React.createElement("label",{className:"form-label small"},"M\u1EADt kh\u1EA9u"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-lock"})),React.createElement("input",{type:oe?"text":"password",className:"form-control",value:X,onChange:Ne=>y(Ne.target.value),placeholder:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",required:!0}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>W(!oe)},React.createElement("i",{className:`fas fa-eye${oe?"-slash":""}`})))),React.createElement("button",{type:"submit",className:"btn btn-warning w-100",disabled:K},K?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang \u0111\u0103ng nh\u1EADp..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-sign-in-alt me-2"}),"\u0110\u0103ng nh\u1EADp"))),React.createElement("div",{className:"text-center mt-4"},React.createElement("a",{href:"/",className:"text-muted small text-decoration-none"},React.createElement("i",{className:"fas fa-arrow-left me-1"}),"V\u1EC1 trang ch\u1EE7"))))}function Toast({message:A,type:w,onClose:L}){return useEffect(()=>{const Y=setTimeout(L,3e3);return()=>clearTimeout(Y)},[]),React.createElement("div",{className:`toast show align-items-center text-white bg-${w} border-0`,role:"alert"},React.createElement("div",{className:"d-flex"},React.createElement("div",{className:"toast-body"},A),React.createElement("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto",onClick:L})))}function Loading({show:A}){return A?React.createElement("div",{className:"loading-overlay"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"3rem",height:"3rem"}},React.createElement("span",{className:"visually-hidden"},"\u0110ang t\u1EA3i..."))):null}function Sidebar({activeMenu:A,onMenuChange:w,onLogout:L,currentUser:Y}){return React.createElement("div",{className:"sidebar d-none d-md-block"},React.createElement("div",{className:"logo"},React.createElement("i",{className:"fas fa-tractor me-2"})," KTM Admin"),React.createElement("nav",{className:"nav flex-column mt-3"},[{id:"search",icon:"fa-search",label:"Tra c\u1EE9u nhanh",highlight:!0},{id:"albums",icon:"fa-images",label:"Qu\u1EA3n l\xFD Album"},{id:"videos",icon:"fa-video",label:"Qu\u1EA3n l\xFD Video"},{id:"products",icon:"fa-box",label:"S\u1EA3n ph\u1EA9m"},{id:"orders",icon:"fa-receipt",label:"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"},{id:"stats",icon:"fa-chart-column",label:"Th\u1ED1ng k\xEA"},{id:"settings",icon:"fa-cog",label:"C\xE0i \u0111\u1EB7t"}].map(y=>React.createElement("a",{key:y.id,href:"#",className:`nav-link ${A===y.id?"active":""} ${y.disabled?"opacity-50":""} ${y.highlight?"text-warning":""}`,onClick:K=>{K.preventDefault(),y.disabled||w(y.id)}},React.createElement("i",{className:`fas ${y.icon}`})," ",y.label,y.disabled&&React.createElement("span",{className:"badge bg-secondary ms-2"},"Soon"),y.highlight&&React.createElement("span",{className:"badge bg-warning text-dark ms-2"},"HOT")))),React.createElement("div",{className:"position-absolute bottom-0 w-100 p-3 border-top border-secondary"},React.createElement("div",{className:"d-flex justify-content-between align-items-center"},React.createElement("a",{href:"/",className:"text-white-50 text-decoration-none small"},React.createElement("i",{className:"fas fa-home me-1"})," Trang ch\u1EE7"),L&&React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:L,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"})))))}const ADMIN_SETTINGS_STORAGE_KEY="ktm_admin_settings_v1",DEFAULT_SHIP_PERCENT=1.64;function normalizeShipPercent(A){const w=typeof A=="number"?A:parseFloat(String(A!=null?A:"").trim());return Number.isFinite(w)?Math.max(0,Math.min(100,w)):DEFAULT_SHIP_PERCENT}function loadAdminSettings(){var A;try{const w=localStorage.getItem(ADMIN_SETTINGS_STORAGE_KEY);if(!w)return{ship_percent:DEFAULT_SHIP_PERCENT};const L=JSON.parse(w);return{ship_percent:normalizeShipPercent((A=L==null?void 0:L.ship_percent)!=null?A:L==null?void 0:L.shipPercent)}}catch(w){return{ship_percent:DEFAULT_SHIP_PERCENT}}}function saveAdminSettings(A){var w;try{const L={ship_percent:normalizeShipPercent((w=A==null?void 0:A.ship_percent)!=null?w:A==null?void 0:A.shipPercent)};return localStorage.setItem(ADMIN_SETTINGS_STORAGE_KEY,JSON.stringify(L)),L}catch(L){return{ship_percent:DEFAULT_SHIP_PERCENT}}}async function fetchAdminSettingsFromServer(){var w;const A=await window.KTM.api.getJSON(`${API_BASE}/api/settings`,"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t t\u1EEB DB");return{ship_percent:normalizeShipPercent((w=A==null?void 0:A.ship_percent)!=null?w:A==null?void 0:A.shipPercent)}}async function saveAdminSettingsToServer(A){var Y,X,y;const w={ship_percent:normalizeShipPercent((Y=A==null?void 0:A.ship_percent)!=null?Y:A==null?void 0:A.shipPercent)},L=await window.KTM.api.putJSON(`${API_BASE}/api/settings`,w,"Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t v\xE0o DB");return{ship_percent:normalizeShipPercent((y=(X=L==null?void 0:L.ship_percent)!=null?X:L==null?void 0:L.shipPercent)!=null?y:w.ship_percent)}}function AlbumList({albums:A,onSelect:w,onCreate:L,onEdit:Y,onDelete:X,loading:y,currentFolder:K,onBack:se,breadcrumb:oe}){return React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},K&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:se},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),K?K.title:"Th\u01B0 vi\u1EC7n \u1EA3nh")),React.createElement("button",{className:"btn btn-warning",onClick:L},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder")),oe&&oe.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:W=>{W.preventDefault(),se("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),oe.map((W,pe)=>React.createElement("li",{key:W.id,className:`breadcrumb-item ${pe===oe.length-1?"active":""}`},pe===oe.length-1?W.title:React.createElement("a",{href:"#",onClick:Ne=>{Ne.preventDefault(),se(W)},className:"text-warning"},W.title))))),y?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):A.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},K?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder n\xE0o. H\xE3y t\u1EA1o folder \u0111\u1EA7u ti\xEAn!")):React.createElement("div",{className:"row g-3"},A.map(W=>React.createElement("div",{key:W.uuid||W.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card album-card h-100",onClick:()=>w(W)},W.cover?React.createElement("img",{src:W.cover,className:"album-cover",alt:W.title}):React.createElement("div",{className:"card-body text-center py-4"},React.createElement("i",{className:"fas fa-folder fa-3x text-warning mb-2"})),React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"card-title mb-1"},W.title),React.createElement("small",{className:"text-muted"},W.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),W.subfolderCount),W.subfolderCount>0&&W.count>0&&" \u2022 ",W.count>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-image me-1"}),W.count),W.subfolderCount===0&&W.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-2",onClick:pe=>{pe.stopPropagation(),Y(W)},title:"S\u1EEDa album"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:pe=>{pe.stopPropagation(),X(W)},title:"X\xF3a album"},React.createElement("i",{className:"fas fa-trash"}))))))))}function AlbumModal({show:A,album:w,onClose:L,onSave:Y,parentId:X}){const[y,K]=useState({slug:"",title:"",description:"",cover_url:"",parent_id:null}),[se,oe]=useState(!1),[W,pe]=useState(!1),Ne=useRef(null);useEffect(()=>{K(w?{slug:w.id||"",title:w.title||"",description:w.description||"",cover_url:w.cover||"",parent_id:w.parentId||null}:{slug:"",title:"",description:"",cover_url:"",parent_id:X||null})},[w,A,X]);const re=async le=>{le.preventDefault(),oe(!0),await Y(y),oe(!1)},ce=le=>le.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),fe=async le=>{const be=le.type==="image/heic"||le.type==="image/heif"||/\.heic$/i.test(le.name);if(le.size<=2097152&&!be)return le;try{const Me=await createImageBitmap(le),Ce=document.createElement("canvas");let je=Me.width,he=Me.height;const ie=800;return(je>ie||he>ie)&&(je>he?(he=Math.round(he/je*ie),je=ie):(je=Math.round(je/he*ie),he=ie)),Ce.width=je,Ce.height=he,Ce.getContext("2d").drawImage(Me,0,0,je,he),Me.close(),new Promise((Te,_e)=>{Ce.toBlob(ke=>{ke?Te(new File([ke],le.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):_e(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(Me){throw console.error("Compress cover error:",Me),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},Ae=async le=>{var Me;const we=le.target.files[0];if(!we)return;if(!(we.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(we.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}pe(!0);try{const Ce=await fe(we),je=await window.KTM.cloudinary.uploadImage({file:Ce,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-albums/covers"});if(!je.secure_url)throw console.error("Cloudinary error:",je),new Error(((Me=je.error)==null?void 0:Me.message)||"Upload failed");K(he=>({...he,cover_url:je.secure_url}))}catch(Ce){console.error("Cover upload error:",Ce),alert("L\u1ED7i upload \u1EA3nh b\xECa: "+Ce.message)}pe(!1),le.target.value=""};return A?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},w?"S\u1EEDa":"T\u1EA1o"," Folder"),React.createElement("button",{type:"button",className:"btn-close",onClick:L})),React.createElement("form",{onSubmit:re},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:y.title,onChange:le=>K({...y,title:le.target.value,slug:y.slug||ce(le.target.value)}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Slug (URL) *"),React.createElement("input",{type:"text",className:"form-control",value:y.slug,onChange:le=>K({...y,slug:le.target.value}),required:!0,disabled:!!w}),React.createElement("small",{className:"text-muted"},"VD: may-cay-kubota-l1501")),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:y.description,onChange:le=>K({...y,description:le.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex gap-2 align-items-start"},y.cover_url&&React.createElement("div",{className:"position-relative",style:{width:80,height:80}},React.createElement("img",{src:y.cover_url,alt:"Cover",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:8}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute",style:{top:-8,right:-8,padding:"2px 6px",fontSize:10},onClick:()=>K(le=>({...le,cover_url:""}))},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{ref:Ne,type:"file",accept:"image/*",className:"d-none",onChange:Ae}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100 mb-2",onClick:()=>{var le;return(le=Ne.current)==null?void 0:le.click()},disabled:W},W?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh b\xECa")),React.createElement("input",{type:"url",className:"form-control form-control-sm",value:y.cover_url,onChange:le=>K({...y,cover_url:le.target.value}),placeholder:"Ho\u1EB7c d\xE1n URL \u1EA3nh..."}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:L},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:se||W},se?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function FolderTreeItem({folder:A,allAlbums:w,currentAlbumId:L,targetAlbum:Y,onSelect:X,level:y=0}){const[K,se]=useState(!0),oe=A.uuid||A.id,W=oe===L,pe=Y===oe,Ne=w.filter(ce=>ce.parentId===oe),re=Ne.length>0;return React.createElement("div",{style:{marginLeft:y*16+"px"}},React.createElement("div",{className:`d-flex align-items-center p-2 rounded mb-1 ${pe?"bg-info text-white":W?"bg-light text-muted":"hover-bg"}`,style:{cursor:W?"not-allowed":"pointer",opacity:W?.5:1,transition:"background 0.2s"},onClick:()=>!W&&X(oe)},re&&React.createElement("i",{className:`fas fa-chevron-${K?"down":"right"} me-2`,style:{fontSize:"10px",width:"12px",cursor:"pointer"},onClick:ce=>{ce.stopPropagation(),se(!K)}}),!re&&React.createElement("span",{style:{width:"20px"}}),React.createElement("i",{className:`fas fa-folder${pe?"-open":""} me-2 ${pe?"":"text-warning"}`}),React.createElement("span",{className:"small"},A.title),W&&React.createElement("span",{className:"ms-2 badge bg-secondary",style:{fontSize:"9px"}},"Hi\u1EC7n t\u1EA1i"),A.count>0&&!W&&React.createElement("span",{className:"ms-auto badge bg-light text-muted",style:{fontSize:"10px"}},A.count)),K&&re&&React.createElement("div",null,Ne.map(ce=>React.createElement(FolderTreeItem,{key:ce.uuid||ce.id,folder:ce,allAlbums:w,currentAlbumId:L,targetAlbum:Y,onSelect:X,level:y+1}))))}function AlbumDetail({album:A,onBack:w,onRefresh:L,showToast:Y,onNavigateToFolder:X,onEditSubfolder:y,parentAlbum:K}){const[se,oe]=useState([]),[W,pe]=useState([]),[Ne,re]=useState(!0),[ce,fe]=useState(!1),[Ae,le]=useState(""),[we,be]=useState([]),[Me,Ce]=useState([]),[je,he]=useState({}),[ie,$e]=useState(null),[Te,_e]=useState(!1),[ke,ze]=useState(""),[h,D]=useState(!1),i=useRef(null),b=useRef(null),[_,T]=useState(!1),[F,Q]=useState([]),[q,H]=useState([]),[de,Re]=useState(""),[d,g]=useState(!1),ve=async(f,I=2)=>{const M=I*1024*1024,Ee=f.type==="image/heic"||f.type==="image/heif"||/\.heic$/i.test(f.name);if(f.size<=M&&!Ee)return f;try{const Ue=await createImageBitmap(f),Ge=document.createElement("canvas");let et=Ue.width,it=Ue.height;const rt=1200;return(et>rt||it>rt)&&(et>it?(it=Math.round(it/et*rt),et=rt):(et=Math.round(et/it*rt),it=rt)),Ge.width=et,Ge.height=it,Ge.getContext("2d").drawImage(Ue,0,0,et,it),Ue.close(),new Promise((Mt,ft)=>{Ge.toBlob(Ct=>{Ct?Mt(new File([Ct],f.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):ft(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(Ue){throw console.error("Compress error:",Ue),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh")}};useEffect(()=>{x(),r()},[A.id,A.uuid]);const x=async()=>{re(!0);try{const f=await window.KTM.api.getJSON(`${API_BASE}/api/albums/${A.uuid||A.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");oe(f.images||[]);const I=await window.KTM.api.getJSON(`${API_BASE}/api/albums?parent_id=${A.uuid||A.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");pe(Array.isArray(I)?I:[])}catch(f){console.error(f),Y("L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u","danger")}re(!1)},r=async()=>{try{const f=await window.KTM.api.getJSON(`${API_BASE}/api/albums`,"L\u1ED7i t\u1EA3i album");H(Array.isArray(f)?f:[])}catch(f){console.error("Error loading albums:",f)}},z=f=>{Q(I=>I.includes(f)?I.filter(M=>M!==f):[...I,f])},Oe=async()=>{if(!de||F.length===0){Y("Vui l\xF2ng ch\u1ECDn folder \u0111\xEDch","warning");return}g(!0);let f=0;for(const I of F)try{await window.KTM.api.putJSON(`${API_BASE}/api/images/${I}`,{album_id:de},"L\u1ED7i di chuy\u1EC3n \u1EA3nh"),f++}catch(M){console.error("Move error:",M)}g(!1),T(!1),Q([]),Re(""),f>0?(Y("\u0110\xE3 di chuy\u1EC3n \u1EA3nh th\xE0nh c\xF4ng!","success"),x(),L()):Y("Di chuy\u1EC3n th\u1EA5t b\u1EA1i","danger")},[Je,qe]=useState(!1),Le=async()=>{if(F.length===0||!confirm(`X\xF3a ${F.length} \u1EA3nh \u0111\xE3 ch\u1ECDn? H\xE0nh \u0111\u1ED9ng n\xE0y kh\xF4ng th\u1EC3 ho\xE0n t\xE1c!`))return;qe(!0);let f=0;for(const I of F)try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${I}`,"L\u1ED7i x\xF3a \u1EA3nh"),f++}catch(M){console.error("Delete error:",M)}qe(!1),Q([]),f>0?(Y(`\u0110\xE3 x\xF3a ${f} \u1EA3nh!`,"success"),x(),L()):Y("X\xF3a th\u1EA5t b\u1EA1i","danger")},Qe=()=>{F.length===se.length?Q([]):Q(se.map(f=>f.id))},Ze=async()=>{if(ke.trim()){D(!0);try{const f=ke.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");await window.KTM.api.postJSON(`${API_BASE}/api/albums`,{slug:f+"-"+Date.now(),title:ke,parent_id:A.uuid||A.id},"L\u1ED7i t\u1EA1o folder"),Y("T\u1EA1o folder th\xE0nh c\xF4ng!","success"),ze(""),_e(!1),x(),L()}catch(f){Y(f.message,"danger")}D(!1)}},At=async f=>{if(confirm(`X\xF3a folder "${f.title}"? T\u1EA5t c\u1EA3 n\u1ED9i dung b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${f.uuid||f.id}`,"L\u1ED7i x\xF3a folder"),Y("\u0110\xE3 x\xF3a folder","success"),x(),L()}catch(I){Y("L\u1ED7i x\xF3a folder","danger")}},De=f=>{const I=Array.from(f).filter(M=>M.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(M.name));be(M=>[...M,...I]),I.forEach(M=>{const Ee=new FileReader;Ee.onload=Ue=>{Ce(Ge=>[...Ge,{file:M,preview:Ue.target.result}])},Ee.readAsDataURL(M)})},xt=f=>{be(I=>I.filter((M,Ee)=>Ee!==f)),Ce(I=>I.filter((M,Ee)=>Ee!==f))},Et=async f=>{var M;const I=await window.KTM.cloudinary.uploadImage({file:f,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:`ktm-albums/${A.id}`});if(!I.secure_url)throw console.error("Cloudinary error:",I),new Error(((M=I.error)==null?void 0:M.message)||"Upload failed");return I},dt=async()=>{if(we.length===0)return;fe(!0);let f=0;for(let I=0;I<we.length;I++)try{le(`\u0110ang x\u1EED l\xFD ${I+1}/${we.length}...`);const M=await ve(we[I],2);le(`\u0110ang upload ${I+1}/${we.length}...`);const Ee=await Et(M);await window.KTM.api.postJSON(`${API_BASE}/api/albums/${A.id}`,{url:Ee.secure_url,caption:je[I]||we[I].name.replace(/\.[^/.]+$/,""),sort_order:se.length+I},"L\u1ED7i l\u01B0u \u1EA3nh"),f++}catch(M){console.error("Upload error:",M)}fe(!1),le(""),be([]),Ce([]),he({}),f>0?(Y(`\u0110\xE3 upload ${f} \u1EA3nh th\xE0nh c\xF4ng!`,"success"),x(),L()):Y("Upload th\u1EA5t b\u1EA1i","danger")},ge=async(f,I)=>{if(confirm("X\xF3a \u1EA3nh n\xE0y?"))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${f}`,"L\u1ED7i x\xF3a \u1EA3nh"),Y("\u0110\xE3 x\xF3a \u1EA3nh","success"),x(),L()}catch(M){Y("L\u1ED7i x\xF3a \u1EA3nh","danger")}},Ve=f=>{var I;f.preventDefault(),(I=b.current)==null||I.classList.add("dragover")},st=()=>{var f;(f=b.current)==null||f.classList.remove("dragover")},St=f=>{var I;f.preventDefault(),(I=b.current)==null||I.classList.remove("dragover"),De(f.dataTransfer.files)};return React.createElement("div",null,React.createElement("div",{className:"d-flex align-items-center justify-content-between mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:w},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("h4",{className:"m-0"},A.title),React.createElement("small",{className:"text-muted"},W.length>0&&React.createElement("span",null,W.length," folder \u2022 "),se.length," \u1EA3nh"))),React.createElement("button",{className:"btn btn-outline-warning btn-sm",onClick:()=>_e(!0)},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder con")),Te&&React.createElement("div",{className:"card mb-4 border-warning"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder-plus me-2 text-warning"}),"T\u1EA1o folder con"),React.createElement("div",{className:"d-flex gap-2"},React.createElement("input",{type:"text",className:"form-control",placeholder:"T\xEAn folder...",value:ke,onChange:f=>ze(f.target.value),onKeyPress:f=>f.key==="Enter"&&Ze(),autoFocus:!0}),React.createElement("button",{className:"btn btn-warning",onClick:Ze,disabled:h||!ke.trim()},h?React.createElement("span",{className:"spinner-border spinner-border-sm"}):"T\u1EA1o"),React.createElement("button",{className:"btn btn-secondary",onClick:()=>{_e(!1),ze("")}},"H\u1EE7y")))),W.length>0&&React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),"Folder con"),React.createElement("div",{className:"row g-2"},W.map(f=>React.createElement("div",{key:f.uuid||f.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-item",style:{cursor:"pointer"},onClick:()=>X&&X(f)},React.createElement("div",{className:"card-body text-center py-3"},React.createElement("i",{className:"fas fa-folder fa-2x text-warning mb-2"}),React.createElement("div",{className:"small fw-bold text-truncate"},f.title),React.createElement("small",{className:"text-muted"},f.subfolderCount>0&&React.createElement("span",null,f.subfolderCount," folder"),f.subfolderCount>0&&f.count>0&&" \u2022 ",f.count>0&&React.createElement("span",null,f.count," \u1EA3nh"),f.subfolderCount===0&&f.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0 text-center"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-1",onClick:I=>{I.stopPropagation(),y&&y(f)},title:"S\u1EEDa folder"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:I=>{I.stopPropagation(),At(f)},title:"X\xF3a folder"},React.createElement("i",{className:"fas fa-trash"}))))))))),React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-cloud-upload-alt me-2"}),"Upload \u1EA3nh m\u1EDBi"),React.createElement("div",{ref:b,className:"upload-zone",onClick:()=>{var f;return(f=i.current)==null?void 0:f.click()},onDragOver:Ve,onDragLeave:st,onDrop:St},React.createElement("i",{className:"fas fa-images fa-2x text-muted mb-2"}),React.createElement("p",{className:"mb-0"},"K\xE9o th\u1EA3 \u1EA3nh v\xE0o \u0111\xE2y ho\u1EB7c click \u0111\u1EC3 ch\u1ECDn"),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3 JPG, PNG, WebP"),React.createElement("input",{ref:i,type:"file",multiple:!0,accept:"image/*",onChange:f=>De(f.target.files)})),Me.length>0&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"upload-preview"},Me.map((f,I)=>React.createElement("div",{key:I,className:"upload-preview-item"},React.createElement("img",{src:f.preview,alt:""}),React.createElement("button",{className:"remove",onClick:()=>xt(I)},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("div",{className:"mt-3"},React.createElement("button",{className:"btn btn-warning",onClick:dt,disabled:ce},ce?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),Ae||"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload ",we.length," \u1EA3nh")))))),React.createElement("div",{className:"card"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("h6",{className:"m-0"},React.createElement("i",{className:"fas fa-th me-2"}),"\u1EA2nh (",se.length,")"),se.length>0&&React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:Qe},F.length===se.length?"B\u1ECF ch\u1ECDn":"Ch\u1ECDn t\u1EA5t c\u1EA3")),F.length>0&&React.createElement("div",{className:"d-flex align-items-center gap-2 flex-wrap"},React.createElement("span",{className:"badge bg-primary"},F.length," \u0111\xE3 ch\u1ECDn"),React.createElement("button",{className:"btn btn-sm btn-info",onClick:()=>T(!0)},React.createElement("i",{className:"fas fa-folder-open me-1"}),"Di chuy\u1EC3n"),React.createElement("button",{className:"btn btn-sm btn-danger",onClick:Le,disabled:Je},Je?React.createElement("span",{className:"spinner-border spinner-border-sm"}):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-trash me-1"}),"X\xF3a")),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>Q([])},React.createElement("i",{className:"fas fa-times"})))),Ne?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):se.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},React.createElement("i",{className:"fas fa-image fa-2x mb-2"}),React.createElement("p",null,"Ch\u01B0a c\xF3 \u1EA3nh n\xE0o trong album n\xE0y")):React.createElement("div",{className:"image-grid"},se.map((f,I)=>React.createElement("div",{key:I,className:`image-item ${F.includes(f.id)?"selected":""}`,style:{position:"relative",cursor:"pointer"},onClick:()=>z(f.id)},React.createElement("div",{className:"select-checkbox",style:{position:"absolute",top:"6px",left:"6px",zIndex:10,width:"24px",height:"24px",borderRadius:"4px",background:F.includes(f.id)?"#0d6efd":"rgba(255,255,255,0.9)",border:F.includes(f.id)?"none":"2px solid #ccc",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"}},F.includes(f.id)&&React.createElement("i",{className:"fas fa-check",style:{color:"#fff",fontSize:"12px"}})),React.createElement("img",{src:f.src,alt:f.caption,style:{opacity:F.includes(f.id)?.7:1,border:F.includes(f.id)?"3px solid #0d6efd":"none",borderRadius:"8px"}}),React.createElement("div",{className:"actions"},React.createElement("button",{className:"btn btn-sm btn-danger",onClick:M=>{M.stopPropagation(),ge(f.id,I)},title:"X\xF3a \u1EA3nh"},React.createElement("i",{className:"fas fa-trash"}))),f.caption&&React.createElement("div",{className:"p-2 bg-light small text-truncate"},f.caption)))))),_&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header bg-info text-white"},React.createElement("h5",{className:"modal-title"},React.createElement("i",{className:"fas fa-folder-open me-2"}),"Di chuy\u1EC3n ",F.length," \u1EA3nh"),React.createElement("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>T(!1)})),React.createElement("div",{className:"modal-body",style:{maxHeight:"400px",overflowY:"auto"}},React.createElement("p",{className:"text-muted small mb-3"},"Ch\u1ECDn th\u01B0 m\u1EE5c \u0111\xEDch:"),React.createElement("div",{className:"folder-tree"},q.filter(f=>!f.parentId).map(f=>React.createElement(FolderTreeItem,{key:f.uuid||f.id,folder:f,allAlbums:q,currentAlbumId:A.uuid||A.id,targetAlbum:de,onSelect:Re})))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>T(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-info",onClick:Oe,disabled:!de||d},d?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang chuy\u1EC3n..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-1"}),"Di chuy\u1EC3n \u0111\u1EBFn \u0111\xE2y")))))),ie&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.9)"},onClick:()=>$e(null)},React.createElement("div",{className:"modal-dialog modal-fullscreen d-flex align-items-center justify-content-center"},React.createElement("div",{className:"position-relative",style:{maxWidth:"95vw",maxHeight:"95vh"}},React.createElement("button",{className:"btn btn-light position-absolute",style:{top:"-50px",right:"0",borderRadius:"50%",width:"40px",height:"40px"},onClick:()=>$e(null)},React.createElement("i",{className:"fas fa-times"})),React.createElement("img",{src:ie.src,alt:ie.caption,style:{maxWidth:"95vw",maxHeight:"90vh",objectFit:"contain"},onClick:f=>f.stopPropagation()}),ie.caption&&React.createElement("div",{className:"text-white text-center mt-2"},ie.caption)))))}function SearchCenter({showToast:A,onNavigate:w}){const[L,Y]=useState(""),[X,y]=useState([]),[K,se]=useState([]),[oe,W]=useState([]),[pe,Ne]=useState("all"),[re,ce]=useState(null),[fe,Ae]=useState("list"),[le,we]=useState(!0),[be,Me]=useState([]),[Ce,je]=useState([]),he=useRef(null),[ie,$e]=useState(!0),[Te,_e]=useState(!1),ke=useRef(null),[ze,h]=useState(!1),[D,i]=useState([{role:"assistant",content:`Xin ch\xE0o! H\xE3y h\u1ECFi t\xF4i v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3... V\xED d\u1EE5:
\u2022 "Gi\xE1 van 2 tay?"
\u2022 "Combo r\u1EBB nh\u1EA5t?"
\u2022 "Freeship?"`,attachments:[]}]),[b,_]=useState(""),[T,F]=useState(!1),Q=useRef(null),q=useRef(null),[H,de]=useState(null),[Re,d]=useState(!1),[g,ve]=useState(null),[x,r]=useState(!1),[z,Oe]=useState(!1),[Je,qe]=useState(null),[Le,Qe]=useState({name:"",code:"",price:"",image:"",category:"",note:"",commission_percent:""}),Ze=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"],At=t=>{var v,N;t._type==="product"&&(ve(t),Qe({name:t.name||"",code:t.code||"",price:t.price||"",image:t.image||"",category:t.category||"",note:t.note||"",commission_percent:(N=(v=t.commission_percent)!=null?v:t.commissionPercent)!=null?N:""}),d(!0))},De=async()=>{if(g)try{await window.KTM.api.putJSON(`${API_BASE}/api/products?id=${g.id}`,Le,"L\u1ED7i c\u1EADp nh\u1EADt"),A("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),d(!1),ve(null),Ve()}catch(t){A(t.message,"danger")}},xt=async t=>{const v=t._type==="product"?"s\u1EA3n ph\u1EA9m":t._type==="album"?"\u1EA3nh":"video";if(confirm(`X\xF3a ${v} "${t.name}"?`))try{let N="";t._type==="product"?N=`${API_BASE}/api/products?id=${t.id}`:t._type==="album"?N=`${API_BASE}/api/images/${t.id}`:t._type==="video"&&(N=`${API_BASE}/api/videos/${t.id}`),await window.KTM.api.deleteJSON(N,"L\u1ED7i x\xF3a"),A(`\u0110\xE3 x\xF3a ${v}`,"success"),Ve()}catch(N){A(N.message,"danger")}},Et=async t=>{try{const v=Je?`${API_BASE}/api/products?id=${Je.id}`:`${API_BASE}/api/products`;Je?await window.KTM.api.putJSON(v,t,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(v,t,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),A(Je?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Oe(!1),qe(null),Ve()}catch(v){A(v.message,"danger")}},dt="ktm_admin_data_cache_v1",ge=1e3*60*10,Ve=async()=>{let t=null,v=!1;const N=window.KTM.cache.read(dt,{ttlMs:ge,validate:Array.isArray});N.hit?(t=N.value,console.log("[CACHE] Using cache, items:",t.length),se(t),y(t),we(!1),v=!0):N.status==="miss"?console.log("[CACHE] No cache found"):N.status==="expired"||N.status==="invalid"?console.log("[CACHE] Cache expired or invalid"):N.status==="error"&&console.error("[CACHE] Error parsing cache"),v||we(!0);try{const B=async(Ie,ue)=>{try{const We=await window.KTM.api.getJSON(Ie,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");return We!=null?We:ue}catch(We){return ue}},[Z,$,m]=await Promise.all([B(`${API_BASE}/api/products`,[]),B(`${API_BASE}/api/albums`,[]),B(`${API_BASE}/api/video-folders?withVideos=true`,[])]),V=Array.isArray(Z)?Z.map(Ie=>({...Ie,_type:"product",_source:"database"})):[];Me($);let ne=[];Array.isArray($)&&$.length>0&&(await Promise.all($.map(ue=>B(`${API_BASE}/api/albums/${ue.id}`,{})))).forEach((ue,We)=>{const at=$[We];ue.images&&ue.images.length>0&&ue.images.forEach(ye=>{ne.push({id:ye.id,name:ye.caption||"\u1EA2nh t\u1EEB "+at.title,image:ye.src,folder:at.title,_type:"album",_source:"database"})})}),je(m);let te=[];Array.isArray(m)&&m.forEach(Ie=>{Ie.videos&&Ie.videos.forEach(ue=>{te.push({id:ue.id,name:ue.title,folder:Ie.name,image:ue.thumb,youtubeId:ue.youtubeId,url:ue.url,_type:"video",_source:"database"})})});const k=[...V,...ne,...te];(!t||JSON.stringify(k)!==JSON.stringify(t))&&(se(k),y(k),window.KTM.cache.write(dt,k))}catch(B){console.error("Song song fetch error:",B)}we(!1)};useEffect(()=>{Ve(),setTimeout(()=>{var t;return(t=he.current)==null?void 0:t.focus()},100)},[]);const st=t=>{try{return String(t!=null?t:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(v){return String(t!=null?t:"").toLowerCase()}},St=t=>{const N=st(t).trim().split(/\s+/).filter(Boolean),B=N.includes("anh"),Z=N.includes("video"),$=N.filter(ne=>ne!=="anh"&&ne!=="video"),m=$.join(" "),V=new Set(["product"]);return B&&V.add("album"),Z&&V.add("video"),{allowedTypes:V,includeAlbum:B,includeVideo:Z,contentTokens:$,cleanedQuery:m}},f=(t,v,N)=>{var Ie,ue,We,at,ye;const B=Array.isArray(v)?v:[],Z=st(N).trim();if(!B.length&&!Z)return 0;const $=st((Ie=t==null?void 0:t.name)!=null?Ie:""),m=st((ue=t==null?void 0:t.code)!=null?ue:""),V=st((We=t==null?void 0:t.category)!=null?We:""),ne=st((at=t==null?void 0:t.note)!=null?at:""),te=st((ye=t==null?void 0:t.folder)!=null?ye:"");if(!`${$} ${m} ${V} ${ne} ${te}`.trim())return 0;let J=0;Z&&($===Z&&(J+=220),$.includes(Z)&&(J+=140),$.startsWith(Z)&&(J+=160),m&&m===Z&&(J+=180),m&&m.includes(Z)&&(J+=90));for(const Ye of B){if(!Ye)continue;const pt=new RegExp(`(?:^|\\s)${Ye.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}`);$.includes(Ye)&&(J+=35),pt.test($)&&(J+=25),m&&m.includes(Ye)&&(J+=20),m&&pt.test(m)&&(J+=10),V&&V.includes(Ye)&&(J+=12),te&&te.includes(Ye)&&(J+=12),ne&&ne.includes(Ye)&&(J+=6)}return J>0&&$&&(J+=Math.max(0,10-Math.min(10,Math.floor($.length/10)))),J},I=(t,v,N)=>{const B=Array.isArray(t)?t:[];return B.length?B.map(($,m)=>({it:$,idx:m,score:f($,v,N)})).sort(($,m)=>m.score!==$.score?m.score-$.score:$.idx-m.idx).map($=>$.it):[]},M=async(t,v)=>{if(!(!ie||v.length===0)){_e(!0);try{const N=v.map(Z=>({id:Z.id,name:Z.name,price:Z.price,category:Z.category,note:Z.note,folder:Z.folder,_type:Z._type})),B=await window.KTM.api.postJSON(`${API_BASE}/api/ai-search`,{query:t,products:N},"AI Search error");if(B&&B.matchedIds&&B.matchedIds.length>0){const{contentTokens:Z,cleanedQuery:$}=St(t),m=new Set(B.matchedIds),V=v.filter(ne=>m.has(ne.id)).sort((ne,te)=>f(te,Z,$)-f(ne,Z,$));V.length>0&&y(V)}else B&&B.matchedIds&&B.matchedIds.length===0&&y([])}catch(N){console.error("AI Search error:",N)}_e(!1)}},Ee=t=>{if(Y(t),ke.current&&clearTimeout(ke.current),!t.trim()){Ue(pe);return}const{allowedTypes:v,contentTokens:N,cleanedQuery:B}=St(t),Z=K.filter(m=>{if(!v.has(m==null?void 0:m._type))return!1;if(N.length===0)return!0;const V=st(Object.entries(m).filter(([ne])=>!ne.startsWith("_")).map(([,ne])=>String(ne||"")).join(" "));return N.some(ne=>V.includes(ne))});let $=Z;pe!=="all"&&($=Z.filter(m=>(m.category||m._type)===pe)),y(I($,N,B)),ie&&B.length>=3&&(ke.current=setTimeout(()=>{M(B,$)},500))},Ue=t=>{Ne(t);const{allowedTypes:v,contentTokens:N}=St(L),{cleanedQuery:B}=St(L);let Z=K.filter($=>v.has($==null?void 0:$._type));t!=="all"&&(Z=Z.filter($=>($.category||$._type)===t)),L.trim()&&N.length>0&&(Z=Z.filter($=>{const m=st(Object.entries($).filter(([V])=>!V.startsWith("_")).map(([,V])=>String(V||"")).join(" "));return N.every(V=>m.includes(V))})),y(I(Z,N,B))},Ge=(t,v)=>{window.KTM.clipboard.writeText(t).then(()=>{ce(v),A("\u0110\xE3 copy!","success"),setTimeout(()=>ce(null),1500)})},et=async(t,v)=>{try{await window.KTM.clipboard.writeImageFromUrl(t),ce(v+"-img"),A("\u0110\xE3 copy \u1EA3nh!","success"),setTimeout(()=>ce(null),1500)}catch(N){Ge(t,v+"-img")}},it=t=>{let v=t.toLowerCase();const N=[],B=K.filter(m=>m._type==="product");if(v.includes("ty")||v.includes("xy lanh")){if(v.includes("gi\u1EEFa")||v.includes("giua")){const m=B.find(V=>{var ne;return(ne=V.name)==null?void 0:ne.toLowerCase().includes("xy lanh gi\u1EEFa")});m&&!N.find(V=>V.id===m.id)&&N.push(m)}if(v.includes("nghi\xEAng")||v.includes("nghieng")){const m=B.find(V=>{var ne;return(ne=V.name)==null?void 0:ne.toLowerCase().includes("xy lanh nghi\xEAng")});m&&!N.find(V=>V.id===m.id)&&N.push(m)}if(v.includes("\u1EE7i")||v.includes("ui")){const m=B.find(V=>{var ne;return(ne=V.name)==null?void 0:ne.toLowerCase().includes("xy lanh \u1EE7i")});m&&!N.find(V=>V.id===m.id)&&N.push(m)}}const Z=v.match(/van\s*(\d+)\s*tay.*?(\d+)\s*ty/);if(Z){const m=Z[1],V=Z[2],ne=B.find(te=>{var J;const k=((J=te.name)==null?void 0:J.toLowerCase())||"";return k.includes("combo")&&k.includes(`${m} tay`)&&(k.includes(`${V} xy`)||k.includes(`${V} xylanh`))});if(ne&&!N.find(te=>te.id===ne.id))N.push(ne);else{const te=B.find(k=>{var Ie;const J=((Ie=k.name)==null?void 0:Ie.toLowerCase())||"";return J.includes("combo")&&J.includes(`${m} tay`)});te&&!N.find(k=>k.id===te.id)&&N.push(te)}}if(v.includes("combo")&&!Z){const m=v.match(/combo.*?(\d+)\s*tay/);if(m){const V=m[1];B.filter(te=>{var J;const k=((J=te.name)==null?void 0:J.toLowerCase())||"";return k.includes("combo")&&k.includes(`${V} tay`)}).forEach(te=>{N.find(k=>k.id===te.id)||N.push(te)})}}const $=v.match(/van\s*(\d+)\s*tay/);if($&&!v.includes("ty")&&!v.includes("combo")){const m=$[1],V=B.find(ne=>{var k;const te=((k=ne.name)==null?void 0:k.toLowerCase())||"";return te.includes(`van ${m} tay`)&&!te.includes("combo")});V&&!N.find(ne=>ne.id===V.id)&&N.push(V)}return N.slice(0,4)},rt=async t=>{if(!t.trim())return;const v={role:"user",content:t,attachments:[]};i(B=>[...B,v]),_(""),F(!0);const N=it(t);setTimeout(()=>{var B;return(B=Q.current)==null?void 0:B.scrollIntoView({behavior:"smooth"})},100);try{const Z=K.filter(k=>k._type==="product").map(k=>{let J=`- ${k.name}`;return k.code&&(J+=` (M\xE3: ${k.code})`),k.price&&(J+=` - Gi\xE1: ${k.price.replace(/[đ\s]/g,"")}\u0111`),k.category&&(J+=` [${k.category}]`),k.note&&(J+=` (${k.note})`),J}).join(`
`),m=D.slice(-6).map(k=>`${k.role==="user"?"Kh\xE1ch":"AI"}: ${k.content}`).join(`
`),V=m?`L\u1ECACH S\u1EEC H\u1ED8I THO\u1EA0I:
${m}

DANH S\xC1CH S\u1EA2N PH\u1EA8M:
${Z}`:Z,te=(await window.KTM.api.postJSON(`${API_BASE}/api/ai-chat`,{message:t,context:V,audience:"admin"},"API error")).response||"Xin l\u1ED7i, t\xF4i kh\xF4ng th\u1EC3 tr\u1EA3 l\u1EDDi l\xFAc n\xE0y.";i(k=>[...k,{role:"assistant",content:te,attachments:N}])}catch(B){console.error("AI Error:",B);const Z=t.toLowerCase(),$=K.filter(V=>{const ne=Object.values(V).join(" ").toLowerCase();return Z.split(" ").some(te=>ne.includes(te))});let m="";$.length>0?(m=`T\xECm th\u1EA5y ${$.length} s\u1EA3n ph\u1EA9m li\xEAn quan:

`,$.slice(0,5).forEach(V=>{m+=`\u2022 ${V.name}`,V.price&&(m+=` - ${V.price.replace(/[đ\s]/g,"")}\u0111`),V.note&&(m+=` (${V.note})`),m+=`
`}),$.length>5&&(m+=`
...v\xE0 ${$.length-5} s\u1EA3n ph\u1EA9m kh\xE1c`)):m='Kh\xF4ng t\xECm th\u1EA5y s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p. H\xE3y th\u1EED t\u1EEB kh\xF3a kh\xE1c nh\u01B0 "van", "combo", "xy lanh"...',i(V=>[...V,{role:"assistant",content:m,attachments:$.slice(0,4)}])}F(!1),setTimeout(()=>{var B,Z;(B=Q.current)==null||B.scrollIntoView({behavior:"smooth"}),(Z=q.current)==null||Z.focus()},100)};function It({show:t,product:v,categories:N,onClose:B,onSave:Z}){const[$,m]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[V,ne]=useState(!1),[te,k]=useState(!1),J=useRef(null),Ie=O=>window.KTM.money.formatVNDInputDigits(O),ue=O=>{const C=window.KTM.money.getDigits(String(O!=null?O:"")),P=Number(C);return C&&Number.isFinite(P)?Math.trunc(P):0},We=(O,C)=>{if(O==null||O==="")return[];let P=O;if(typeof P=="string"){const ee=P.trim();if(!ee)return[];try{P=JSON.parse(ee)}catch(U){return[]}}if(!Array.isArray(P))return[];const G=ue(C);return P.map(ee=>{var xe;if(!ee||typeof ee!="object")return null;const U=String((xe=ee.name)!=null?xe:"").trim(),Se=(Array.isArray(ee.options)?ee.options:[]).map(Pe=>{var bt,yt,Nt,kt,Ot,Ht,Ut;if(!Pe||typeof Pe!="object")return null;const Be=String((bt=Pe.label)!=null?bt:"").trim();if(!Be)return null;const tt=(Ot=(kt=(Nt=(yt=Pe.price)!=null?yt:Pe.priceValue)!=null?Nt:Pe.unit_price)!=null?kt:Pe.unitPrice)!=null?Ot:null,ct=Number(tt);let vt=Number.isFinite(ct)?Math.trunc(ct):null;if(vt==null){const wt=(Ut=(Ht=Pe.price_delta)!=null?Ht:Pe.priceDelta)!=null?Ut:null,Gt=Number(wt);Number.isFinite(Gt)&&(vt=G+Math.trunc(Gt))}vt==null&&(vt=G);const ot=String(Math.max(0,Math.trunc(Number(vt)||0)));return{label:Be,price:Math.max(0,Math.trunc(Number(vt)||0)),priceDigits:ot}}).filter(Boolean);return{name:U||"Bi\u1EBFn th\u1EC3",options:Se}}).filter(Boolean)},at=O=>{if(O==null||O==="")return[];let C=O;if(typeof C=="string"){const P=C.trim();if(!P)return[];try{C=JSON.parse(P)}catch(G){return[]}}return C&&typeof C=="object"&&!Array.isArray(C)&&(C=Object.entries(C).map(([P,G])=>({key:P,value:G}))),Array.isArray(C)?C.map(P=>{var Se,xe,Pe,Be,tt;if(!P||typeof P!="object")return null;const G=String((Pe=(xe=(Se=P.key)!=null?Se:P.name)!=null?xe:P.label)!=null?Pe:"").trim(),ee=String((Be=P.value)!=null?Be:"").trim(),U=String((tt=P.unit)!=null?tt:"").trim();return G?{key:G,value:ee,unit:U}:null}).filter(Boolean):[]};useEffect(()=>{var O,C;if(v)if(m({name:v.name||"",code:v.code||"",price:v.price||"",image:v.image||"",category:v.category||"",note:v.note||"",sort_order:v.sort_order||0,commission_percent:(C=(O=v.commission_percent)!=null?O:v.commissionPercent)!=null?C:5,variants:We(v.variants,v.price),attributes:at(v.attributes)}),v.price){const P=window.KTM.money.getDigits(v.price);ht(P),m(G=>({...G,price:Ie(P)}))}else ht("");else m({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),ht("")},[v,t]);const ye=O=>{m(C=>{var Se;const P=ue(C.price),G=String(P),ee=Array.isArray(C.variants)?[...C.variants]:[],U={...ee[O]||{},options:Array.isArray((Se=ee[O])==null?void 0:Se.options)?[...ee[O].options]:[]};return U.options=U.options.map(xe=>({label:String((xe==null?void 0:xe.label)||""),price:P,priceDigits:G})),ee[O]=U,{...C,variants:ee}})},Ye=()=>{m(O=>{const C=ue(O.price),P=String(C),ee=(Array.isArray(O.variants)?[...O.variants]:[]).map(U=>{const Se=(Array.isArray(U==null?void 0:U.options)?U.options:[]).map(xe=>({label:String((xe==null?void 0:xe.label)||""),price:C,priceDigits:P}));return{name:String((U==null?void 0:U.name)||"Bi\u1EBFn th\u1EC3"),options:Se}});return{...O,variants:ee}})},[pt,Ft]=React.useState(""),[Lt,ht]=React.useState(""),qt=O=>{const C=window.KTM.money.nextPriceInputState(O.target.value,Lt);ht(C.digits),m({...$,price:C.price})},Pt=async(O,C=2)=>{const P=C*1024*1024;if(O.size<=P)return O;try{const G=await createImageBitmap(O),ee=document.createElement("canvas");let U=G.width,Se=G.height;const xe=1200;return(U>xe||Se>xe)&&(U>Se?(Se=Math.round(Se/U*xe),U=xe):(U=Math.round(U/Se*xe),Se=xe)),ee.width=U,ee.height=Se,ee.getContext("2d").drawImage(G,0,0,U,Se),G.close(),new Promise((Be,tt)=>{ee.toBlob(ct=>{ct?Be(new File([ct],O.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):tt(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(G){throw console.error("Compress error:",G),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},Bt=async O=>{var G;const C=O.target.files[0];if(!C)return;if(!(C.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp)$/i.test(C.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}k(!0);try{const ee=await Pt(C),U=await window.KTM.cloudinary.uploadImage({file:ee,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-products"});if(!U.secure_url)throw console.error("Cloudinary error:",U),new Error(((G=U.error)==null?void 0:G.message)||"Upload failed");m(Se=>({...Se,image:U.secure_url}))}catch(ee){console.error("Upload error:",ee),alert("L\u1ED7i upload \u1EA3nh: "+ee.message)}k(!1),O.target.value=""},Vt=async O=>{O.preventDefault(),ne(!0);const C={...$,variants:We($.variants,$.price),attributes:at($.attributes)};await Z(C),ne(!1)};return t?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-lg"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,border:"none",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark"},React.createElement("i",{className:"fas fa-box me-2"}),v?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:B})),React.createElement("form",{onSubmit:Vt},React.createElement("div",{className:"modal-body",style:{maxHeight:"70vh",overflowY:"auto"}},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-8"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-tag me-1"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:$.name,onChange:O=>m({...$,name:O.target.value}),placeholder:"V\xED d\u1EE5: Xy lanh nghi\xEAng KTM",required:!0,style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-hashtag me-1"}),"M\xE3 s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:$.code,onChange:O=>m({...$,code:O.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1"}),"Gi\xE1 b\xE1n"),React.createElement("input",{type:"text",className:"form-control",value:$.price,onChange:qt,placeholder:"1.950.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3 mt-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-percent me-1"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:$.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:O=>m({...$,commission_percent:O.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-list me-1"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:$.category,onChange:O=>m({...$,category:O.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),N.map(O=>React.createElement("option",{key:O,value:O},O)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1"}),"Ghi ch\xFA"),React.createElement("textarea",{className:"form-control",rows:"2",value:$.note,onChange:O=>m({...$,note:O.target.value}),placeholder:"V\xED d\u1EE5: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray($.attributes)?$.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray($.attributes)?$.attributes:[]).map((O,C)=>React.createElement("div",{key:C,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(O==null?void 0:O.key)||"",onChange:P=>{const G=P.target.value;m(ee=>{const U=Array.isArray(ee.attributes)?[...ee.attributes]:[];return U[C]={...U[C]||{},key:G},{...ee,attributes:U}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(O==null?void 0:O.value)||"",onChange:P=>{const G=P.target.value;m(ee=>{const U=Array.isArray(ee.attributes)?[...ee.attributes]:[];return U[C]={...U[C]||{},value:G},{...ee,attributes:U}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(O==null?void 0:O.unit)||"",onChange:P=>{const G=P.target.value;m(ee=>{const U=Array.isArray(ee.attributes)?[...ee.attributes]:[];return U[C]={...U[C]||{},unit:G},{...ee,attributes:U}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{m(P=>{const G=Array.isArray(P.attributes)?[...P.attributes]:[];return G.splice(C,1),{...P,attributes:G}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{m(O=>{const C=Array.isArray(O.attributes)?[...O.attributes]:[];return C.push({key:"",value:"",unit:""}),{...O,attributes:C}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray($.variants)?$.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3. C\xF3 th\u1EC3 th\xEAm (v\xED d\u1EE5 Size: S/M/L)."):null,(Array.isArray($.variants)?$.variants:[]).map((O,C)=>React.createElement("div",{key:C,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(O==null?void 0:O.name)||"",onChange:P=>{const G=P.target.value;m(ee=>{var Se;const U=Array.isArray(ee.variants)?[...ee.variants]:[];return U[C]={...U[C]||{},name:G,options:Array.isArray((Se=U[C])==null?void 0:Se.options)?U[C].options:[]},{...ee,variants:U}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>ye(C),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(O==null?void 0:O.options)||O.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{m(P=>{const G=Array.isArray(P.variants)?[...P.variants]:[];return G.splice(C,1),{...P,variants:G}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(O==null?void 0:O.options)?O.options:[]).map((P,G)=>{var ee,U;return React.createElement("div",{key:G,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(P==null?void 0:P.label)||"",onChange:Se=>{const xe=Se.target.value;m(Pe=>{var ot,bt,yt,Nt,kt;const Be=Array.isArray(Pe.variants)?[...Pe.variants]:[],tt={...Be[C]||{},options:Array.isArray((ot=Be[C])==null?void 0:ot.options)?[...Be[C].options]:[]},ct=Number((yt=(bt=tt.options[G])==null?void 0:bt.price)!=null?yt:0)||0,vt=String((kt=(Nt=tt.options[G])==null?void 0:Nt.priceDigits)!=null?kt:Math.max(0,Math.trunc(ct)));return tt.options[G]={...tt.options[G]||{},label:xe,price:Math.max(0,Math.trunc(ct)),priceDigits:vt},Be[C]=tt,{...Pe,variants:Be}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:Ie(String((U=P==null?void 0:P.priceDigits)!=null?U:window.KTM.money.getDigits(String((ee=P==null?void 0:P.price)!=null?ee:"")))),onChange:Se=>{m(xe=>{var yt,Nt,kt,Ot,Ht;const Pe=String((Nt=P==null?void 0:P.priceDigits)!=null?Nt:window.KTM.money.getDigits(String((yt=P==null?void 0:P.price)!=null?yt:""))),Be=window.KTM.money.nextPriceInputState(Se.target.value,Pe),tt=String((kt=Be.digits)!=null?kt:""),ct=Number(tt),vt=Number.isFinite(ct)?Math.max(0,Math.trunc(ct)):0,ot=Array.isArray(xe.variants)?[...xe.variants]:[],bt={...ot[C]||{},options:Array.isArray((Ot=ot[C])==null?void 0:Ot.options)?[...ot[C].options]:[]};return bt.options[G]={...bt.options[G]||{},label:String(((Ht=bt.options[G])==null?void 0:Ht.label)||""),price:vt,priceDigits:tt},ot[C]=bt,{...xe,variants:ot}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{m(Se=>{var Be;const xe=Array.isArray(Se.variants)?[...Se.variants]:[],Pe={...xe[C]||{},options:Array.isArray((Be=xe[C])==null?void 0:Be.options)?[...xe[C].options]:[]};return Pe.options.splice(G,1),xe[C]=Pe,{...Se,variants:xe}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{m(P=>{var Se;const G=Array.isArray(P.variants)?[...P.variants]:[],ee={...G[C]||{},options:Array.isArray((Se=G[C])==null?void 0:Se.options)?[...G[C].options]:[]},U=ue(P.price);return ee.options.push({label:"",price:U,priceDigits:String(U)}),G[C]=ee,{...P,variants:G}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{m(O=>{const C=ue(O.price),P=Array.isArray(O.variants)?[...O.variants]:[],G=String(C);return P.push({name:"Size",options:[{label:"S",price:C,priceDigits:G},{label:"M",price:C,priceDigits:G},{label:"L",price:C,priceDigits:G}]}),{...O,variants:P}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:Ye,disabled:!Array.isArray($.variants)||$.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111.")))),React.createElement("div",{className:"col-md-4"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-image me-1"}),"\u1EA2nh s\u1EA3n ph\u1EA9m"),React.createElement("div",{className:"mb-2"},$.image?React.createElement(React.Fragment,null,React.createElement("img",{src:$.image,alt:"Product",style:{width:"100%",height:150,objectFit:"cover",borderRadius:"12px",border:"2px solid #e9ecef"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger mt-2",onClick:()=>m({...$,image:""}),style:{borderRadius:"20px",fontSize:"0.75rem"}},React.createElement("i",{className:"fas fa-times me-1"}),"X\xF3a \u1EA3nh")):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:"100%",height:150,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd",cursor:"pointer"},onClick:()=>{var O;return(O=J.current)==null?void 0:O.click()}},React.createElement("div",{className:"text-center"},React.createElement("i",{className:"fas fa-cloud-upload-alt fa-2x text-muted mb-2"}),React.createElement("div",{className:"small text-muted"},"Click \u0111\u1EC3 upload")))),React.createElement("input",{ref:J,type:"file",accept:"image/*",className:"d-none",onChange:Bt}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100",onClick:()=>{var O;return(O=J.current)==null?void 0:O.click()},disabled:te,style:{borderRadius:"10px"}},te?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh")),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"Ho\u1EB7c URL \u1EA3nh"),React.createElement("input",{type:"url",className:"form-control",value:$.image,onChange:O=>m({...$,image:O.target.value}),placeholder:"https://...",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"8px",fontSize:"0.875rem"}}))))),React.createElement("div",{className:"modal-footer",style:{border:"none",padding:"20px"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:B,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:V,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},V?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}const Mt=t=>window.KTM.money.formatVND(t),ft=t=>{if(t==null||t==="")return[];let v=t;if(typeof v=="string"){const N=v.trim();if(!N)return[];try{v=JSON.parse(N)}catch(B){return[]}}return Array.isArray(v)?v:[]},Ct=t=>{if(t==null||t==="")return[];let v=t;if(typeof v=="string"){const N=v.trim();if(!N)return[];try{v=JSON.parse(N)}catch(B){return[]}}return v&&typeof v=="object"&&!Array.isArray(v)&&(v=Object.entries(v).map(([N,B])=>({key:N,value:B}))),Array.isArray(v)?v:[]},$t=(t,v={})=>{var $;const N=Ct(t).map(m=>{var V,ne,te,k,J;return{key:String((te=(ne=(V=m==null?void 0:m.key)!=null?V:m==null?void 0:m.name)!=null?ne:m==null?void 0:m.label)!=null?te:"").trim(),value:String((k=m==null?void 0:m.value)!=null?k:"").trim(),unit:String((J=m==null?void 0:m.unit)!=null?J:"").trim()}}).filter(m=>!!m.key);if(!N.length)return null;const B=!!v.compact,Z=String(($=v.className)!=null?$:"").trim();return React.createElement("div",{className:`ktm-variants-preview${B?" compact":""}${Z?" "+Z:""}`},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},N.map((m,V)=>{const ne=m.key,te=`${m.value||""}${m.unit?(m.value?" ":"")+m.unit:""}`.trim();return React.createElement("div",{key:`${ne}-${V}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},ne),te?React.createElement("span",{className:"ktm-chip ktm-chip-option"},te):null)})))},jt=(t,v={})=>{var ne;const N=ft(t).map(te=>{var k;return{name:String((k=te==null?void 0:te.name)!=null?k:"").trim(),options:Array.isArray(te==null?void 0:te.options)?te.options:[]}}).map(te=>({...te,options:te.options.map(k=>{var J;return{label:String((J=k==null?void 0:k.label)!=null?J:"").trim(),price:Number(k==null?void 0:k.price)}}).filter(k=>!!k.label)})).filter(te=>te.options.length>0);if(!N.length)return null;const B=Number.isFinite(v.maxGroups)?Math.max(1,Math.trunc(v.maxGroups)):N.length,Z=Number.isFinite(v.maxOptionsPerGroup)?Math.max(1,Math.trunc(v.maxOptionsPerGroup)):3,$=!!v.compact,m=String((ne=v.className)!=null?ne:"").trim(),V=N.slice(0,B);return React.createElement("div",{className:`ktm-variants-preview${$?" compact":""}${m?" "+m:""}`},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},V.map((te,k)=>{const J=te.name||"Bi\u1EBFn th\u1EC3",Ie=te.options.slice(0,Z),ue=te.options.length-Ie.length;return React.createElement("div",{key:`${J}-${k}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},J),Ie.map((We,at)=>{const ye=We.price,Ye=Number.isFinite(ye)&&ye>=0?Mt(Math.trunc(ye)):"",pt=Ye?`${We.label} \xB7 ${Ye}`:We.label;return React.createElement("span",{key:`${J}-${k}-${at}`,className:"ktm-chip ktm-chip-option"},pt)}),ue>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",ue))})))},Rt=(t,v)=>{const N=t._type==="product",B=t._type==="album",Z=t._type==="video",$=t.note&&(t.note.toLowerCase().includes("free")||t.note.toLowerCase().includes("gi\u1EA3m")||t.note.toLowerCase().includes("sale")),m=N?$t(t.attributes,{compact:fe==="grid",className:fe==="grid"?"meta text-muted":"text-muted"}):null,V=N?jt(t.variants,{compact:fe==="grid",maxOptionsPerGroup:999,className:fe==="grid"?"meta text-muted":"text-muted"}):null;return fe==="grid"?React.createElement("div",{key:t.id||v,className:"grid-card"},React.createElement("div",{className:"thumb-wrap",onClick:()=>de({url:t.image,name:t.name,price:t.price,note:t.note,item:t})},t.image?React.createElement("img",{src:t.image,alt:t.name,className:"thumb",loading:"lazy"}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${Z?"fa-video":"fa-image"} fa-2x text-muted`})),t.price&&React.createElement("div",{className:"price-overlay"},t.price.replace(/[đ\s]/g,""),"\u0111"),React.createElement("span",{className:`type-badge ${N?"product":B?"album":"video"}`},N?"SP":B?"\u1EA2nh":"Video"),$&&React.createElement("span",{className:"promo-badge"},"\u{1F525} \u01AFU \u0110\xC3I")),React.createElement("div",{className:"card-body"},React.createElement("div",{className:"name"},t.name),t.note&&React.createElement("div",{className:"meta text-info",style:{fontSize:10}},t.note),m&&React.createElement("div",{style:{marginTop:2}},m),V&&React.createElement("div",{style:{marginTop:2}},V),React.createElement("div",{className:"quick-copy"},React.createElement("button",{className:re===t.id+"-img"?"copied":"",onClick:()=>et(t.image,t.id)},React.createElement("i",{className:"fas fa-image"})),t.price&&React.createElement("button",{className:re===t.id+"-price"?"copied":"",onClick:()=>Ge(t.price.replace(/[đ\s]/g,""),t.id+"-price")},React.createElement("i",{className:"fas fa-tag"}))))):React.createElement("div",{key:t.id||v,className:"product-card-mobile"},React.createElement("span",{className:`type-badge ${N?"product":B?"album":"video"}`},N?"S\u1EA3n ph\u1EA9m":B?"\u1EA2nh":"Video"),React.createElement("div",{className:"card-inner"},t.image?React.createElement("img",{src:t.image,alt:t.name,className:"thumb",loading:"lazy",onClick:()=>de({url:t.image,name:t.name,price:t.price,note:t.note,item:t})}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${Z?"fa-video":"fa-image"} fa-2x text-muted`})),React.createElement("div",{className:"info"},React.createElement("div",null,React.createElement("div",{className:"name"},t.name),React.createElement("div",{className:"price-row"},t.price&&React.createElement("span",{className:"price"},t.price.replace(/[đ\s]/g,""),"\u0111"),$&&React.createElement("span",{className:"badge-promo"},"\u{1F525} \u01AFU \u0110\xC3I")),m&&React.createElement("div",{style:{marginTop:4}},m),V&&React.createElement("div",{style:{marginTop:4}},V)),React.createElement("div",{className:"meta"},t.code&&React.createElement("span",{className:"meta-tag"},"#",t.code),t.category&&React.createElement("span",{className:"meta-tag"},t.category),t.note&&React.createElement("span",{className:"meta-tag highlight"},t.note),t.folder&&React.createElement("span",{className:"meta-tag"},t.folder),Z&&React.createElement("span",{className:"meta-tag"},React.createElement("i",{className:"fab fa-youtube text-danger"})," Video")))),React.createElement("div",{className:"quick-actions"},N&&React.createElement("button",{onClick:()=>w&&w("orders","create",{productId:t.id})},React.createElement("i",{className:"fas fa-receipt"})," T\u1EA1o \u0111\u01A1n"),t.price&&React.createElement("button",{className:re===t.id+"-price"?"copied":"",onClick:()=>Ge(t.price.replace(/[đ\s]/g,""),t.id+"-price")},React.createElement("i",{className:"fas fa-tag"})," Gi\xE1"),React.createElement("button",{className:re===t.id+"-name"?"copied":"",onClick:()=>Ge(t.name,t.id+"-name")},React.createElement("i",{className:"fas fa-font"})," T\xEAn"),Z&&t.youtubeId&&React.createElement("button",{className:re===t.id+"-yt"?"copied":"",onClick:()=>Ge(`https://www.youtube.com/watch?v=${t.youtubeId}`,t.id+"-yt")},React.createElement("i",{className:"fab fa-youtube"})),N&&React.createElement("button",{className:"action-edit",onClick:()=>At(t)},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"action-delete",onClick:()=>xt(t)},React.createElement("i",{className:"fas fa-trash"}))))},[Tt,gt]=useState(!1);return React.createElement(React.Fragment,null,React.createElement("div",{className:"result-header"},React.createElement("span",null,React.createElement("strong",null,X.length)," k\u1EBFt qu\u1EA3",ie&&L.length>=3&&React.createElement("span",{className:"ai-badge ms-2"},React.createElement("i",{className:"fas fa-robot"})," AI"),pe!=="all"&&React.createElement("span",{className:"ms-2 badge bg-warning text-dark"},pe==="product"?"S\u1EA3n ph\u1EA9m":pe==="album"?"\u1EA2nh":"Video")),React.createElement("div",{className:"d-flex gap-1 align-items-center"},React.createElement("button",{className:`btn btn-sm ${fe==="list"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>Ae("list"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-list"})),React.createElement("button",{className:`btn btn-sm ${fe==="grid"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>Ae("grid"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-th"})))),React.createElement("div",{className:"search-results-area"},le?React.createElement("div",null,[...Array(8)].map((t,v)=>React.createElement("div",{key:v,className:"product-card-mobile mb-2",style:{opacity:.7}},React.createElement("div",{className:"card-inner"},React.createElement("div",{className:"thumb bg-light",style:{width:80,height:80,borderRadius:8}}),React.createElement("div",{className:"info",style:{flex:1,minWidth:0}},React.createElement("div",{className:"skeleton-box mb-2",style:{height:16,width:"60%",background:"#eee",borderRadius:4}}),React.createElement("div",{className:"skeleton-box mb-1",style:{height:12,width:"40%",background:"#f3f3f3",borderRadius:4}}),React.createElement("div",{className:"skeleton-box",style:{height:10,width:"30%",background:"#f3f3f3",borderRadius:4}})))))):X.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-search"}),React.createElement("p",null,'Kh\xF4ng t\xECm th\u1EA5y "',L,'"'),React.createElement("button",{className:"btn btn-warning",onClick:()=>{Y(""),Ee("")}},"Xem t\u1EA5t c\u1EA3")):fe==="grid"?React.createElement("div",{className:"product-grid-mobile"},X.map((t,v)=>Rt(t,v))):React.createElement("div",null,X.map((t,v)=>Rt(t,v)))),Tt&&React.createElement("div",{className:"filter-dropdown"},React.createElement("div",{className:"filter-header"},React.createElement("strong",null,"L\u1ECDc theo lo\u1EA1i"),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>gt(!1)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"filter-chips"},React.createElement("span",{className:`filter-chip ${pe==="all"?"active":""}`,onClick:()=>{Ue("all"),gt(!1)}},"T\u1EA5t c\u1EA3"),React.createElement("span",{className:`filter-chip ${pe==="product"?"active":""}`,onClick:()=>{Ue("product"),gt(!1)}},React.createElement("i",{className:"fas fa-box me-1"}),"S\u1EA3n ph\u1EA9m"),React.createElement("span",{className:`filter-chip ${pe==="album"?"active":""}`,onClick:()=>{Ue("album"),gt(!1)}},React.createElement("i",{className:"fas fa-images me-1"}),"\u1EA2nh"),React.createElement("span",{className:`filter-chip ${pe==="video"?"active":""}`,onClick:()=>{Ue("video"),gt(!1)}},React.createElement("i",{className:"fas fa-video me-1"}),"Video")),React.createElement("div",{className:"mt-3 pt-3 border-top d-flex align-items-center justify-content-between"},React.createElement("span",null,"AI Search th\xF4ng minh"),React.createElement("div",{className:"form-check form-switch m-0"},React.createElement("input",{type:"checkbox",className:"form-check-input",checked:ie,onChange:t=>$e(t.target.checked),style:{width:40,height:20}})))),React.createElement("div",{className:"search-bar-bottom"},React.createElement("div",{className:"search-input-wrap"},React.createElement("input",{ref:he,type:"text",className:"search-input",placeholder:"\u{1F50D} T\xECm: van 3 tay, xylanh...",value:L,onChange:t=>Ee(t.target.value)}),React.createElement("button",{className:`filter-btn ${Tt||pe!=="all"?"active":""}`,onClick:()=>gt(!Tt)},React.createElement("i",{className:"fas fa-filter"})))),React.createElement("button",{className:"btn btn-lg rounded-circle position-fixed shadow-lg",style:{bottom:x?320:130,right:16,width:56,height:56,zIndex:1050,transition:"bottom 0.2s ease",background:"linear-gradient(135deg, #667eea, #764ba2)",color:"#fff",border:"none",WebkitTapHighlightColor:"transparent",touchAction:"manipulation",cursor:"pointer",outline:"none"},onClick:()=>h(!0),onTouchStart:()=>h(!0)},React.createElement("i",{className:"fas fa-robot fa-lg"})),ze&&React.createElement("div",{className:"ai-chat-mobile"},React.createElement("div",{className:"chat-header"},React.createElement("button",{className:"back-btn",onClick:()=>h(!1)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("strong",null,"KTM AI Assistant"),React.createElement("div",{style:{fontSize:11,opacity:.8}},"H\u1ECFi v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3..."))),React.createElement("div",{className:"chat-messages"},D.map((t,v)=>React.createElement("div",{key:v,className:`mb-3 ${t.role==="user"?"d-flex justify-content-end":""}`},React.createElement("div",{className:`p-3 rounded-3 position-relative ${t.role==="user"?"text-white":"bg-white border"}`,style:{maxWidth:"85%",whiteSpace:"pre-wrap",background:t.role==="user"?"linear-gradient(135deg, #667eea, #764ba2)":void 0}},t.content,t.role==="assistant"&&React.createElement("button",{className:"btn btn-sm position-absolute",style:{top:4,right:4,padding:"2px 6px",fontSize:11,background:re===`chat-${v}`?"#28a745":"rgba(0,0,0,0.1)",border:"none",borderRadius:4,color:re===`chat-${v}`?"#fff":"#666"},onClick:()=>{window.KTM.clipboard.writeText(t.content),ce(`chat-${v}`),setTimeout(()=>ce(null),1500)}},React.createElement("i",{className:`fas ${re===`chat-${v}`?"fa-check":"fa-copy"}`})),t.attachments&&t.attachments.length>0&&React.createElement("div",{className:"mt-2 d-flex flex-wrap gap-2"},t.attachments.map((N,B)=>React.createElement("div",{key:B,style:{width:70},className:"text-center"},N.image&&React.createElement("img",{src:N.image,className:"rounded",style:{width:70,height:50,objectFit:"cover",cursor:"pointer"},onClick:()=>de({url:N.image,name:N.name,price:N.price})}),React.createElement("div",{style:{fontSize:9},className:"text-truncate"},N.name),N.price&&React.createElement("div",{style:{fontSize:10,color:"#dc3545",fontWeight:600}},N.price.replace(/[đ\s]/g,""),"\u0111"))))))),T&&React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"bg-white border p-3 rounded-3 d-inline-block"},React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang suy ngh\u0129...")),React.createElement("div",{ref:Q})),React.createElement("div",{className:"px-3 py-2 border-top d-flex gap-2 overflow-auto"},["Gi\xE1 van 2 tay?","Combo r\u1EBB nh\u1EA5t?","Freeship?","Van 3 tay?"].map(t=>React.createElement("button",{key:t,className:"btn btn-sm btn-outline-secondary flex-shrink-0",onClick:()=>rt(t),disabled:T,style:{whiteSpace:"nowrap"}},t))),React.createElement("div",{className:"chat-input-area"},React.createElement("form",{onSubmit:t=>{t.preventDefault(),rt(b)},className:"chat-input-wrap"},React.createElement("input",{ref:q,type:"text",className:"chat-input",placeholder:"Nh\u1EADp c\xE2u h\u1ECFi...",value:b,onChange:t=>_(t.target.value),disabled:T}),React.createElement("button",{type:"submit",className:"send-btn",disabled:T||!b.trim()},React.createElement("i",{className:"fas fa-paper-plane"}))))),H&&React.createElement("div",{className:"preview-modal",onClick:()=>de(null)},React.createElement("div",{className:"preview-header"},React.createElement("div",null),React.createElement("button",{className:"close-btn",onClick:()=>de(null)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"preview-body",onClick:t=>t.stopPropagation()},React.createElement("img",{src:H.url,alt:H.name})),React.createElement("div",{className:"preview-footer",onClick:t=>t.stopPropagation()},React.createElement("div",{className:"name"},H.name),H.price&&React.createElement("div",{className:"price"},H.price.replace(/[đ\s]/g,""),"\u0111"),H.note&&React.createElement("div",{className:"mb-2",style:{fontSize:14,color:"#17a2b8"}},H.note),React.createElement("div",{className:"action-btns"},React.createElement("button",{className:re==="preview-img"?"btn-success text-white":"btn-outline-light text-white",style:{background:re==="preview-img"?"#28a745":"rgba(255,255,255,0.2)"},onClick:()=>et(H.url,"preview")},React.createElement("i",{className:`fas ${re==="preview-img"?"fa-check":"fa-copy"}`}),"Copy \u1EA3nh"),H.price&&React.createElement("button",{className:re==="preview-price"?"btn-success text-white":"btn-warning",onClick:()=>Ge(H.price.replace(/[đ\s]/g,""),"preview-price")},React.createElement("i",{className:`fas ${re==="preview-price"?"fa-check":"fa-tag"}`}),"Copy gi\xE1")))),React.createElement(It,{show:z,product:Je,categories:oe,onClose:()=>{Oe(!1),qe(null)},onSave:Et}),React.createElement("div",{className:`fab-container mobile-only ${x?"open":""}`},React.createElement("div",{className:"fab-actions"},React.createElement("button",{className:"fab-action product",onClick:()=>{r(!1),Oe(!0),qe(null)}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",{className:"tooltip"},"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("button",{className:"fab-action product",onClick:()=>{r(!1),w&&w("orders","create")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",{className:"tooltip"},"T\u1EA1o order nhanh"))),React.createElement("button",{className:`fab-main ${x?"open":""}`,onClick:()=>r(!x)},React.createElement("i",{className:"fas fa-plus"}))),Re&&g&&React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,maxHeight:"90vh"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none"}},React.createElement("h6",{className:"modal-title fw-bold"},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa nhanh"),React.createElement("button",{type:"button",className:"btn-close",onClick:()=>d(!1)})),React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"T\xEAn s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:Le.name,onChange:t=>Qe({...Le,name:t.target.value})})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:Le.code,onChange:t=>Qe({...Le,code:t.target.value})})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:Le.price,onChange:t=>Qe({...Le,price:t.target.value})}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:Le.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:t=>Qe({...Le,commission_percent:t.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:Le.category,onChange:t=>Qe({...Le,category:t.target.value})},React.createElement("option",{value:""},"-- Ch\u1ECDn danh m\u1EE5c --"),Ze.map(t=>React.createElement("option",{key:t,value:t},t)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Ghi ch\xFA (\u01B0u \u0111\xE3i)"),React.createElement("input",{type:"text",className:"form-control",value:Le.note,placeholder:"VD: Free ship, Gi\u1EA3m 10%...",onChange:t=>Qe({...Le,note:t.target.value})}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>d(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-warning",onClick:De},React.createElement("i",{className:"fas fa-save me-1"}),"L\u01B0u"))))))}function VideoList({onRefresh:A,showToast:w}){const[L,Y]=useState([]),[X,y]=useState([]),[K,se]=useState(!0),[oe,W]=useState(null),[pe,Ne]=useState(!1),[re,ce]=useState(null),[fe,Ae]=useState(!1),[le,we]=useState(null),[be,Me]=useState(null),[Ce,je]=useState([]);useEffect(()=>{he()},[]);const he=async(d=null)=>{se(!0);try{const g=d?`${API_BASE}/api/video-folders?withVideos=true&parent_id=${d}`:`${API_BASE}/api/video-folders?withVideos=true&parent_id=root`,ve=await window.KTM.api.getJSON(g,"L\u1ED7i t\u1EA3i danh s\xE1ch folder");Y(Array.isArray(ve)?ve:[])}catch(g){console.error(g),w("L\u1ED7i t\u1EA3i danh s\xE1ch folder","danger")}se(!1)},ie=async d=>{try{const g=await window.KTM.api.getJSON(`${API_BASE}/api/videos?folderId=${d}`,"L\u1ED7i t\u1EA3i video");y(Array.isArray(g)?g:[])}catch(g){console.error(g)}},$e=async d=>{if(d===0)return;const g=[...L];[g[d-1],g[d]]=[g[d],g[d-1]],Y(g),await _e(g)},Te=async d=>{if(d===L.length-1)return;const g=[...L];[g[d],g[d+1]]=[g[d+1],g[d]],Y(g),await _e(g)},_e=async d=>{try{await Promise.all(d.map((g,ve)=>window.KTM.api.putJSON(`${API_BASE}/api/video-folders/${g.id}`,{sortOrder:ve},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),w("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(g){w("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),he(be==null?void 0:be.id)}},ke=async d=>{if(d===0)return;const g=[...X];[g[d-1],g[d]]=[g[d],g[d-1]],y(g),await h(g)},ze=async d=>{if(d===X.length-1)return;const g=[...X];[g[d],g[d+1]]=[g[d+1],g[d]],y(g),await h(g)},h=async d=>{try{await Promise.all(d.map((g,ve)=>window.KTM.api.putJSON(`${API_BASE}/api/videos/${g.id}`,{sort_order:ve},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),w("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(g){w("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),ie(oe.id)}},D=()=>{ce(null),Ne(!0)},i=d=>{ce(d),Ne(!0)},b=async d=>{try{!re&&be&&(d.parent_id=be.id);const g=re?`${API_BASE}/api/video-folders/${re.id}`:`${API_BASE}/api/video-folders`;re?await window.KTM.api.putJSON(g,d,"L\u1ED7i l\u01B0u folder"):await window.KTM.api.postJSON(g,d,"L\u1ED7i l\u01B0u folder"),w(re?"\u0110\xE3 c\u1EADp nh\u1EADt folder!":"\u0110\xE3 t\u1EA1o folder m\u1EDBi!","success"),Ne(!1),he(be==null?void 0:be.id)}catch(g){w(g.message,"danger")}},_=async d=>{const g=d.subfolderCount>0?`X\xF3a folder "${d.name}"? T\u1EA5t c\u1EA3 subfolder v\xE0 videos b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`:`X\xF3a folder "${d.name}"? Videos trong folder s\u1EBD kh\xF4ng b\u1ECB x\xF3a.`;if(confirm(g))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/video-folders/${d.id}`,"L\u1ED7i x\xF3a folder"),w("\u0110\xE3 x\xF3a folder","success"),W(null),he(be==null?void 0:be.id)}catch(ve){w("L\u1ED7i x\xF3a folder","danger")}},T=d=>{d.subfolderCount>0?(je(g=>[...g,d]),Me(d),he(d.id)):(W(d),y(d.videos||[]))},F=d=>{if(d==="root")je([]),Me(null),he(null);else if(d){const g=Ce.findIndex(ve=>ve.id===d.id);g>=0&&(je(Ce.slice(0,g+1)),Me(d),he(d.id))}else{const g=[...Ce];g.pop();const ve=g[g.length-1]||null;je(g),Me(ve),he(ve==null?void 0:ve.id)}},Q=()=>{we(null),Ae(!0)},q=d=>{we(d),Ae(!0)},H=async d=>{try{d.folder_id=oe==null?void 0:oe.id;const g=le?`${API_BASE}/api/videos/${le.id}`:`${API_BASE}/api/videos`;le?await window.KTM.api.putJSON(g,d,"L\u1ED7i l\u01B0u video"):await window.KTM.api.postJSON(g,d,"L\u1ED7i l\u01B0u video"),w(le?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm video th\xE0nh c\xF4ng!","success"),Ae(!1),he(),oe&&ie(oe.id)}catch(g){w(g.message,"danger")}},de=async d=>{if(confirm(`X\xF3a video "${d.title}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/videos/${d.id}`,"L\u1ED7i x\xF3a video"),w("\u0110\xE3 x\xF3a video","success"),he(),oe&&ie(oe.id)}catch(g){w("L\u1ED7i x\xF3a video","danger")}},Re=d=>{const g=`https://www.youtube.com/watch?v=${d.youtubeId}`;window.KTM.clipboard.writeText(g).then(()=>{w("\u0110\xE3 copy link!","success")}).catch(()=>{w("Kh\xF4ng th\u1EC3 copy link","danger")})};return oe?React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>W(null)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:`fas fa-folder-open me-2 ${oe.slug==="shorts"?"text-danger":"text-warning"}`}),oe.name)),React.createElement("button",{className:"btn btn-warning",onClick:Q},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm Video")),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1 videos"),X.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-video fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},"Ch\u01B0a c\xF3 video trong folder n\xE0y")):React.createElement("div",{className:"row g-4"},X.map((d,g)=>React.createElement("div",{key:d.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>ke(g),disabled:g===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},g+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>ze(g),disabled:g===X.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"position-relative"},React.createElement("img",{src:d.thumb,className:"card-img-top",alt:d.title,style:{height:"120px",objectFit:"cover"}}),React.createElement("a",{href:`https://www.youtube.com/watch?v=${d.youtubeId}`,target:"_blank",className:"position-absolute top-50 start-50 translate-middle"},React.createElement("i",{className:"fas fa-play-circle fa-3x text-white",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"}}))),React.createElement("div",{className:"card-body py-2"},React.createElement("h6",{className:"card-title small mb-1 text-truncate",title:d.title},d.title),React.createElement("small",{className:"text-muted"},d.youtubeId)),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-primary",onClick:()=>Re(d),title:"Copy link"},React.createElement("i",{className:"fas fa-link"})),React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>q(d),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-outline-danger",onClick:()=>de(d),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))))),React.createElement(VideoModal,{show:fe,video:le,onClose:()=>Ae(!1),onSave:H})):React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},be&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>F()},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-video me-2 text-warning"}),be?be.name:"Qu\u1EA3n l\xFD Video")),React.createElement("button",{className:"btn btn-warning",onClick:D},React.createElement("i",{className:"fas fa-folder-plus me-2"}),"T\u1EA1o Folder")),Ce.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:d=>{d.preventDefault(),F("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),Ce.map((d,g)=>React.createElement("li",{key:d.id,className:`breadcrumb-item ${g===Ce.length-1?"active":""}`},g===Ce.length-1?d.name:React.createElement("a",{href:"#",onClick:ve=>{ve.preventDefault(),F(d)},className:"text-warning"},d.name))))),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1. Click v\xE0o folder \u0111\u1EC3 v\xE0o b\xEAn trong."),K?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):L.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},be?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder video n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:D},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o folder",be?" con":" \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"row g-3"},L.map((d,g)=>{var ve,x,r,z;return React.createElement("div",{key:d.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-card"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Oe=>{Oe.stopPropagation(),$e(g)},disabled:g===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},g+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Oe=>{Oe.stopPropagation(),Te(g)},disabled:g===L.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"card-body text-center py-3",onClick:()=>T(d),style:{cursor:"pointer"}},React.createElement("i",{className:`fas fa-folder fa-3x mb-3 ${d.slug==="shorts"?"text-danger":"text-warning"}`}),React.createElement("h5",{className:"card-title"},d.name),React.createElement("p",{className:"text-muted mb-0"},d.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),d.subfolderCount," folder"),d.subfolderCount>0&&(d.videoCount>0||((ve=d.videos)==null?void 0:ve.length)>0)&&" \u2022 ",(d.videoCount>0||((x=d.videos)==null?void 0:x.length)>0)&&React.createElement("span",null,React.createElement("i",{className:"fas fa-video me-1"}),d.videoCount||((r=d.videos)==null?void 0:r.length)||0," videos"),d.subfolderCount===0&&!d.videoCount&&!((z=d.videos)!=null&&z.length)&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:Oe=>{Oe.stopPropagation(),i(d)}},React.createElement("i",{className:"fas fa-edit"})," S\u1EEDa"),React.createElement("button",{className:"btn btn-outline-danger",onClick:Oe=>{Oe.stopPropagation(),_(d)}},React.createElement("i",{className:"fas fa-trash"})," X\xF3a")))))})),React.createElement(VideoFolderModal,{show:pe,folder:re,onClose:()=>Ne(!1),onSave:b}))}function VideoFolderModal({show:A,folder:w,onClose:L,onSave:Y}){const[X,y]=useState({name:"",description:"",sortOrder:0,coverImage:""}),[K,se]=useState(!1),[oe,W]=useState(!1);useEffect(()=>{y(w?{name:w.name||"",description:w.description||"",sortOrder:w.sortOrder||0,coverImage:w.coverImage||""}:{name:"",description:"",sortOrder:0,coverImage:""})},[w,A]);const pe=async re=>{const ce=re.target.files[0];if(ce){W(!0);try{const fe=await window.KTM.cloudinary.uploadImage({file:ce,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});fe.secure_url&&y(Ae=>({...Ae,coverImage:fe.secure_url})),window.KTM.cache.remove(CACHE_KEY),showToast("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),setShowQuickEdit(!1),setEditingItem(null),loadAllData()}catch(fe){console.error("Cloudinary upload error:",fe),alert("L\u1ED7i upload \u1EA3nh: "+(fe.message||fe))}finally{W(!1)}}},Ne=async re=>{re.preventDefault(),se(!0);const ce={...X,variants:normalizeVariants(X.variants,X.price),attributes:normalizeAttributes(X.attributes)};await Y(ce),se(!1)};return A?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},w?"S\u1EEDa Folder":"T\u1EA1o Folder m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:L})),React.createElement("form",{onSubmit:Ne},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn folder *"),React.createElement("input",{type:"text",className:"form-control",value:X.name,onChange:re=>y({...X,name:re.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",value:X.description,onChange:re=>y({...X,description:re.target.value}),rows:"2"})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:X.sortOrder,onChange:re=>y({...X,sortOrder:parseInt(re.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex align-items-start gap-3"},X.coverImage?React.createElement("div",{className:"position-relative"},React.createElement("img",{src:X.coverImage,alt:"Cover",className:"rounded",style:{width:120,height:80,objectFit:"cover"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute top-0 end-0",onClick:()=>y({...X,coverImage:""}),style:{transform:"translate(30%, -30%)"}},React.createElement("i",{className:"fas fa-times"}))):React.createElement("div",{className:"bg-light rounded d-flex align-items-center justify-content-center text-muted",style:{width:120,height:80}},React.createElement("i",{className:"fas fa-image fa-2x"})),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{type:"file",className:"form-control form-control-sm",accept:"image/*,image/jpeg,image/png,image/gif,image/webp",onChange:pe,disabled:oe}),oe&&React.createElement("div",{className:"mt-1 text-muted small"},React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang upload..."),React.createElement("div",{className:"mt-1 text-muted small"},"Ho\u1EB7c d\xE1n URL:"),React.createElement("input",{type:"url",className:"form-control form-control-sm",placeholder:"https://...",value:X.coverImage,onChange:re=>y({...X,coverImage:re.target.value})}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:L},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:K},K?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function ProductManager({showToast:A,settings:w}){const[L,Y]=useState([]),[X,y]=useState(!0),[K,se]=useState(!1),[oe,W]=useState(null),[pe,Ne]=useState(""),[re,ce]=useState(""),fe=normalizeShipPercent(w==null?void 0:w.ship_percent),{parseMoney:Ae,formatVND:le}=window.KTM.money,we=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"];useEffect(()=>{be()},[]);const be=async()=>{y(!0);try{const i=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");Y(Array.isArray(i)?i:[])}catch(i){console.error(i),A("L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m","danger")}y(!1)},Me=()=>{W(null),se(!0)},Ce=i=>{W(i),se(!0)},je=async i=>{if(!(!i||!i.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:i},"L\u1ED7i x\xF3a \u1EA3nh"),window.KTM.cache.remove(CACHE_KEY),A(`\u0110\xE3 x\xF3a ${typeName}`,"success"),loadAllData(),be()}catch(b){A("L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m","danger")}},he=async i=>{try{const b=oe?`${API_BASE}/api/products?id=${oe.id}`:`${API_BASE}/api/products`;oe?await window.KTM.api.putJSON(b,i,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(b,i,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),A(oe?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),se(!1),be()}catch(b){A(b.message,"danger")}},ie=async i=>{if(confirm(`B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n x\xF3a s\u1EA3n ph\u1EA9m "${i.name}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/products?id=${i.id}`,"L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m"),A("X\xF3a s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),be()}catch(b){A(b.message,"danger")}},$e=L.filter(i=>{const b=!pe||i.name.toLowerCase().includes(pe.toLowerCase())||i.code&&i.code.toLowerCase().includes(pe.toLowerCase()),_=!re||i.category===re;return b&&_}),Te=i=>{var T;const b=(T=i==null?void 0:i.commission_percent)!=null?T:i==null?void 0:i.commissionPercent,_=b===""||b==null?NaN:Number(b);return Number.isFinite(_)?Math.max(0,Math.min(100,_)):5},_e=i=>{const b=Te(i),_=Number.isInteger(b)?String(b):String(Math.round(b*100)/100),T=Ae(i==null?void 0:i.price);if(!Number.isFinite(T)||T<=0)return`${_}%`;const F=(Number(b)||0)/100,q=window.KTM.money.parseShipFeeFromNote(i==null?void 0:i.note)!=null?0:fe>0?T*fe/100:0,H=T*F-q*F,de=Math.max(0,Math.round(H));return`${_}% - ${le(de)}`},ke=i=>{if(i==null||i==="")return[];let b=i;if(typeof b=="string"){const _=b.trim();if(!_)return[];try{b=JSON.parse(_)}catch(T){return[]}}return Array.isArray(b)?b:[]},ze=i=>{if(i==null||i==="")return[];let b=i;if(typeof b=="string"){const _=b.trim();if(!_)return[];try{b=JSON.parse(_)}catch(T){return[]}}return b&&typeof b=="object"&&!Array.isArray(b)&&(b=Object.entries(b).map(([_,T])=>({key:_,value:T}))),Array.isArray(b)?b:[]},h=i=>{const b=ze(i).map(_=>{var T,F,Q,q,H;return{key:String((Q=(F=(T=_==null?void 0:_.key)!=null?T:_==null?void 0:_.name)!=null?F:_==null?void 0:_.label)!=null?Q:"").trim(),value:String((q=_==null?void 0:_.value)!=null?q:"").trim(),unit:String((H=_==null?void 0:_.unit)!=null?H:"").trim()}}).filter(_=>!!_.key);return b.length?React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-sliders-h"}),React.createElement("div",{className:"ktm-variants-chips"},b.map((_,T)=>{const F=_.key,Q=`${_.value||""}${_.unit?(_.value?" ":"")+_.unit:""}`.trim();return React.createElement("div",{key:`${F}-${T}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},F),Q?React.createElement("span",{className:"ktm-chip ktm-chip-option"},Q):null)}))):null},D=(i,b={})=>{const _=ke(i).map(q=>{var H;return{name:String((H=q==null?void 0:q.name)!=null?H:"").trim(),options:Array.isArray(q==null?void 0:q.options)?q.options:[]}}).map(q=>({...q,options:q.options.map(H=>{var de;return{label:String((de=H==null?void 0:H.label)!=null?de:"").trim(),price:Number(H==null?void 0:H.price)}}).filter(H=>!!H.label)})).filter(q=>q.options.length>0);if(!_.length)return null;const T=Number.isFinite(b.maxGroups)?Math.max(1,Math.trunc(b.maxGroups)):_.length,F=Number.isFinite(b.maxOptionsPerGroup)?Math.max(1,Math.trunc(b.maxOptionsPerGroup)):4,Q=_.slice(0,T);return React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},Q.map((q,H)=>{const de=q.name||"Bi\u1EBFn th\u1EC3",Re=q.options.slice(0,F),d=q.options.length-Re.length;return React.createElement("div",{key:`${de}-${H}`,className:"ktm-variants-group"},React.createElement("span",{className:"ktm-chip ktm-chip-group"},de),Re.map((g,ve)=>{const x=g.price,r=Number.isFinite(x)&&x>=0?le(Math.trunc(x)):"",z=r?`${g.label} \xB7 ${r}`:g.label;return React.createElement("span",{key:`${de}-${H}-${ve}`,className:"ktm-chip ktm-chip-option"},z)}),d>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",d))})))};return React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",null,React.createElement("i",{className:"fas fa-box me-2"}),"S\u1EA3n ph\u1EA9m"),React.createElement("button",{className:"btn-add-product",onClick:Me},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"d-flex gap-2 mb-2"},React.createElement("div",{className:"flex-grow-1 position-relative"},React.createElement("input",{type:"text",className:"form-control",placeholder:"\u{1F50D} T\xECm s\u1EA3n ph\u1EA9m...",value:pe,onChange:i=>Ne(i.target.value)})),React.createElement("span",{className:"product-count"},$e.length)),React.createElement("select",{className:"form-select",value:re,onChange:i=>ce(i.target.value)},React.createElement("option",{value:""},"\u{1F4C1} T\u1EA5t c\u1EA3 danh m\u1EE5c"),we.map(i=>React.createElement("option",{key:i,value:i},i)))),X?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"2.5rem",height:"2.5rem"}}),React.createElement("p",{className:"text-muted mt-3 mb-0"},"\u0110ang t\u1EA3i...")):$e.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-box-open"}),React.createElement("p",null,"Ch\u01B0a c\xF3 s\u1EA3n ph\u1EA9m n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:Me},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"product-list"},$e.map(i=>React.createElement("div",{key:i.id,className:"product-item d-flex align-items-center gap-3"},i.image?React.createElement("img",{src:i.image,alt:"",className:"product-img"}):React.createElement("div",{className:"product-img-placeholder"},React.createElement("i",{className:"fas fa-image text-muted"})),React.createElement("div",{className:"flex-grow-1 min-width-0"},React.createElement("div",{className:"product-name"},i.name),React.createElement("div",{className:"d-flex flex-wrap gap-1 mb-1"},i.category&&React.createElement("span",{className:"product-badge bg-info bg-opacity-75"},i.category),i.code&&React.createElement("span",{className:"product-badge bg-secondary"},i.code),React.createElement("span",{className:"product-badge bg-warning text-dark",title:"Hoa h\u1ED3ng (%)"},React.createElement("i",{className:"fas fa-percent me-1"}),_e(i))),React.createElement("div",{className:"product-price"},i.price?i.price.replace(/[đ\s]/g,"")+"\u0111":"Li\xEAn h\u1EC7"),i.note&&React.createElement("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"}},i.note),h(i.attributes)&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},h(i.attributes)),D(i.variants,{maxOptionsPerGroup:4})&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},D(i.variants,{maxOptionsPerGroup:4}))),React.createElement("div",{className:"product-actions"},React.createElement("button",{className:"btn btn-edit",onClick:()=>Ce(i),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"btn btn-delete",onClick:()=>ie(i),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement(ProductModal,{show:K,product:oe,categories:we,onClose:()=>se(!1),onSave:he}))}function ProductModal({show:A,product:w,categories:L,onClose:Y,onSave:X}){const[y,K]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]}),[se,oe]=useState(!1),[W,pe]=useState(!1),Ne=h=>{const D=window.KTM.money.getDigits(String(h!=null?h:"")),i=Number(D);return D&&Number.isFinite(i)?Math.trunc(i):0},re=h=>{if(h==null||h==="")return[];let D=h;if(typeof D=="string"){const i=D.trim();if(!i)return[];try{D=JSON.parse(i)}catch(b){return[]}}return D&&typeof D=="object"&&!Array.isArray(D)&&(D=Object.entries(D).map(([i,b])=>({key:i,value:b}))),Array.isArray(D)?D.map(i=>{var F,Q,q,H,de;if(!i||typeof i!="object")return null;const b=String((q=(Q=(F=i.key)!=null?F:i.name)!=null?Q:i.label)!=null?q:"").trim(),_=String((H=i.value)!=null?H:"").trim(),T=String((de=i.unit)!=null?de:"").trim();return b?{key:b,value:_,unit:T}:null}).filter(Boolean):[]},ce=(h,D)=>{if(h==null||h==="")return[];let i=h;if(typeof i=="string"){const _=i.trim();if(!_)return[];try{i=JSON.parse(_)}catch(T){return[]}}if(!Array.isArray(i))return[];const b=Ne(D);return i.map(_=>{var Q;if(!_||typeof _!="object")return null;const T=String((Q=_.name)!=null?Q:"").trim(),F=(Array.isArray(_.options)?_.options:[]).map(q=>{var ve,x,r,z,Oe,Je,qe;if(!q||typeof q!="object")return null;const H=String((ve=q.label)!=null?ve:"").trim();if(!H)return null;const de=(Oe=(z=(r=(x=q.price)!=null?x:q.priceValue)!=null?r:q.unit_price)!=null?z:q.unitPrice)!=null?Oe:null,Re=Number(de);let d=Number.isFinite(Re)?Math.trunc(Re):null;if(d==null){const Le=(qe=(Je=q.price_delta)!=null?Je:q.priceDelta)!=null?qe:null,Qe=Number(Le);Number.isFinite(Qe)&&(d=b+Math.trunc(Qe))}d==null&&(d=b);const g=String(Math.max(0,Math.trunc(Number(d)||0)));return{label:H,price:Math.max(0,Math.trunc(Number(d)||0)),priceDigits:g}}).filter(Boolean);return{name:T||"Bi\u1EBFn th\u1EC3",options:F}}).filter(Boolean)};useEffect(()=>{var h,D;K(w?{name:w.name||"",code:w.code||"",price:w.price||"",image:w.image||"",category:w.category||"",note:w.note||"",sort_order:w.sort_order||0,commission_percent:(D=(h=w.commission_percent)!=null?h:w.commissionPercent)!=null?D:5,variants:ce(w.variants,w.price),attributes:re(w.attributes)}:{name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[],attributes:[]})},[w,A]);const fe=h=>{K(D=>{var F;const i=Ne(D.price),b=String(i),_=Array.isArray(D.variants)?[...D.variants]:[],T={..._[h]||{},options:Array.isArray((F=_[h])==null?void 0:F.options)?[..._[h].options]:[]};return T.options=T.options.map(Q=>({label:String((Q==null?void 0:Q.label)||""),price:i,priceDigits:b})),_[h]=T,{...D,variants:_}})},Ae=()=>{K(h=>{const D=Ne(h.price),i=String(D),_=(Array.isArray(h.variants)?[...h.variants]:[]).map(T=>{const F=(Array.isArray(T==null?void 0:T.options)?T.options:[]).map(Q=>({label:String((Q==null?void 0:Q.label)||""),price:D,priceDigits:i}));return{name:String((T==null?void 0:T.name)||"Bi\u1EBFn th\u1EC3"),options:F}});return{...h,variants:_}})},[le,we]=React.useState(""),be=h=>window.KTM.money.formatVNDInputDigits(h),[Me,Ce]=React.useState(""),je=h=>{const D=window.KTM.money.nextPriceInputState(h.target.value,Me);Ce(D.digits),K({...y,price:D.price})},[he,ie]=React.useState("");React.useEffect(()=>{w!=null&&w.image&&ie(w.image)},[w]);const $e=async h=>{if(!(!h||!h.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:h},"L\u1ED7i x\xF3a \u1EA3nh")}catch(D){console.error("Delete cloudinary image error:",D)}},Te=async(h,D=2,i)=>{const b=D*1024*1024,_=h.type==="image/heic"||h.type==="image/heif"||/\.heic$/i.test(h.name);if(h.size<=b&&!_)return h;i==null||i("\u0110ang x\u1EED l\xFD \u1EA3nh...");try{const T=await createImageBitmap(h);i==null||i("\u0110ang n\xE9n \u1EA3nh...");const F=document.createElement("canvas");let Q=T.width,q=T.height;const H=1200;return(Q>H||q>H)&&(Q>q?(q=Math.round(q/Q*H),Q=H):(Q=Math.round(Q/q*H),q=H)),F.width=Q,F.height=q,F.getContext("2d").drawImage(T,0,0,Q,q),T.close(),new Promise((Re,d)=>{F.toBlob(g=>{g?(i==null||i("Ho\xE0n t\u1EA5t!"),Re(new File([g],h.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"}))):d(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(T){throw console.error("createImageBitmap error:",T),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},_e=async h=>{var b,_;const D=(b=h.target.files)==null?void 0:b[0];if(!D)return;if(!(D.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(D.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}pe(!0),we("\u0110ang chu\u1EA9n b\u1ECB...");try{const T=(D.size/1024/1024).toFixed(1);we(`File ${T}MB - \u0110ang n\xE9n...`);const F=await Te(D,2,H=>{we(H)}),Q=(F.size/1024/1024).toFixed(1);we(`\u0110\xE3 n\xE9n: ${Q}MB - \u0110ang upload...`);const q=await window.KTM.cloudinary.uploadImage({file:F,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});q.secure_url?(y.image&&y.image!==he&&$e(y.image),K(H=>({...H,image:q.secure_url})),we("")):(console.error("Cloudinary error:",q),alert("Upload th\u1EA5t b\u1EA1i: "+(((_=q.error)==null?void 0:_.message)||"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh")),we(""))}catch(T){console.error("Upload error:",T),alert("L\u1ED7i: "+T.message),we("")}pe(!1),h.target.value=""},ke=()=>{y.image&&(y.image!==he&&$e(y.image),K(h=>({...h,image:""})))},ze=async h=>{h.preventDefault(),oe(!0),he&&y.image&&he!==y.image&&await $e(he),he&&!y.image&&await $e(he),await X(y),oe(!1)};return A?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down"},React.createElement("div",{className:"modal-content",style:{borderRadius:"16px",overflow:"hidden"}},React.createElement("div",{className:"modal-header border-0 py-3",style:{background:"linear-gradient(135deg, #ffc107 0%, #ffca2c 100%)"}},React.createElement("h6",{className:"modal-title fw-bold",style:{color:"#1a1a2e"}},React.createElement("i",{className:`fas ${w?"fa-edit":"fa-plus-circle"} me-2`}),w?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:Y})),React.createElement("form",{onSubmit:ze},React.createElement("div",{className:"modal-body py-4",style:{maxHeight:"65vh",overflowY:"auto",background:"#f8f9fa"}},React.createElement("div",{className:"text-center mb-4"},React.createElement("div",{className:"position-relative d-inline-block"},y.image?React.createElement(React.Fragment,null,React.createElement("img",{src:y.image,alt:"",style:{width:110,height:110,objectFit:"cover",borderRadius:"12px",boxShadow:"0 4px 15px rgba(0,0,0,0.15)"}}),React.createElement("button",{type:"button",className:"btn btn-danger position-absolute",onClick:ke,style:{top:-10,right:-10,width:28,height:28,padding:0,borderRadius:"50%",boxShadow:"0 2px 8px rgba(220,53,69,0.4)"}},React.createElement("i",{className:"fas fa-times",style:{fontSize:"0.75rem"}}))):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:110,height:110,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd"}},React.createElement("i",{className:"fas fa-image fa-2x text-muted"}))),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"btn btn-warning btn-sm px-3",style:{borderRadius:"20px"}},React.createElement("i",{className:`fas ${W?"fa-spinner fa-spin":"fa-camera"} me-1`}),W?le||"\u0110ang x\u1EED l\xFD...":"Ch\u1ECDn \u1EA3nh",React.createElement("input",{type:"file",accept:"image/*",onChange:_e,disabled:W,style:{position:"absolute",left:"-9999px",opacity:0,width:1,height:1}})),W&&le&&React.createElement("div",{className:"text-center mt-1",style:{fontSize:11,color:"#6c757d"}},le))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-tag me-1 text-warning"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:y.name,onChange:h=>K({...y,name:h.target.value}),required:!0,placeholder:"VD: Combo Van 3 tay + 2 xylanh",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-barcode me-1 text-info"}),"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:y.code,onChange:h=>K({...y,code:h.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1 text-success"}),"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:y.price,onChange:je,placeholder:"1.950.000\u0111",inputMode:"numeric",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-percent me-1 text-secondary"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:y.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:h=>K({...y,commission_percent:h.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-folder me-1 text-primary"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:y.category,onChange:h=>K({...y,category:h.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),L.map(h=>React.createElement("option",{key:h,value:h},h)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1 text-secondary"}),"Ghi ch\xFA"),React.createElement("input",{type:"text",className:"form-control",value:y.note,onChange:h=>K({...y,note:h.target.value}),placeholder:"VD: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sliders-h me-1 text-secondary"}),"Thu\u1ED9c t\xEDnh (c\xE2n n\u1EB7ng, chi\u1EC1u d\xE0i, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(y.attributes)?y.attributes:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 thu\u1ED9c t\xEDnh. V\xED d\u1EE5: C\xE2n n\u1EB7ng, Chi\u1EC1u d\xE0i, V\u1EADt li\u1EC7u..."):null,(Array.isArray(y.attributes)?y.attributes:[]).map((h,D)=>React.createElement("div",{key:D,className:"row g-2 align-items-center mb-2"},React.createElement("div",{className:"col-5"},React.createElement("input",{type:"text",className:"form-control",value:(h==null?void 0:h.key)||"",onChange:i=>{const b=i.target.value;K(_=>{const T=Array.isArray(_.attributes)?[..._.attributes]:[];return T[D]={...T[D]||{},key:b},{..._,attributes:T}})},placeholder:"T\xEAn (vd: C\xE2n n\u1EB7ng)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:(h==null?void 0:h.value)||"",onChange:i=>{const b=i.target.value;K(_=>{const T=Array.isArray(_.attributes)?[..._.attributes]:[];return T[D]={...T[D]||{},value:b},{..._,attributes:T}})},placeholder:"Gi\xE1 tr\u1ECB (vd: 10)",style:{borderRadius:10}})),React.createElement("div",{className:"col-2"},React.createElement("input",{type:"text",className:"form-control",value:(h==null?void 0:h.unit)||"",onChange:i=>{const b=i.target.value;K(_=>{const T=Array.isArray(_.attributes)?[..._.attributes]:[];return T[D]={...T[D]||{},unit:b},{..._,attributes:T}})},placeholder:"\u0110\u01A1n v\u1ECB",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{K(i=>{const b=Array.isArray(i.attributes)?[...i.attributes]:[];return b.splice(D,1),{...i,attributes:b}})},title:"X\xF3a thu\u1ED9c t\xEDnh"},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-1",onClick:()=>{K(h=>{const D=Array.isArray(h.attributes)?[...h.attributes]:[];return D.push({key:"",value:"",unit:""}),{...h,attributes:D}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm thu\u1ED9c t\xEDnh"))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1 text-secondary"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(y.variants)?y.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3."):null,(Array.isArray(y.variants)?y.variants:[]).map((h,D)=>React.createElement("div",{key:D,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(h==null?void 0:h.name)||"",onChange:i=>{const b=i.target.value;K(_=>{var F;const T=Array.isArray(_.variants)?[..._.variants]:[];return T[D]={...T[D]||{},name:b,options:Array.isArray((F=T[D])==null?void 0:F.options)?T[D].options:[]},{..._,variants:T}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>fe(D),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(h==null?void 0:h.options)||h.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{K(i=>{const b=Array.isArray(i.variants)?[...i.variants]:[];return b.splice(D,1),{...i,variants:b}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(h==null?void 0:h.options)?h.options:[]).map((i,b)=>{var _,T;return React.createElement("div",{key:b,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(i==null?void 0:i.label)||"",onChange:F=>{const Q=F.target.value;K(q=>{var g,ve,x,r,z;const H=Array.isArray(q.variants)?[...q.variants]:[],de={...H[D]||{},options:Array.isArray((g=H[D])==null?void 0:g.options)?[...H[D].options]:[]},Re=Number((x=(ve=de.options[b])==null?void 0:ve.price)!=null?x:0)||0,d=String((z=(r=de.options[b])==null?void 0:r.priceDigits)!=null?z:Math.max(0,Math.trunc(Re)));return de.options[b]={...de.options[b]||{},label:Q,price:Math.max(0,Math.trunc(Re)),priceDigits:d},H[D]=de,{...q,variants:H}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:be(String((T=i==null?void 0:i.priceDigits)!=null?T:window.KTM.money.getDigits(String((_=i==null?void 0:i.price)!=null?_:"")))),onChange:F=>{K(Q=>{var x,r,z,Oe,Je;const q=String((r=i==null?void 0:i.priceDigits)!=null?r:window.KTM.money.getDigits(String((x=i==null?void 0:i.price)!=null?x:""))),H=window.KTM.money.nextPriceInputState(F.target.value,q),de=String((z=H.digits)!=null?z:""),Re=Number(de),d=Number.isFinite(Re)?Math.max(0,Math.trunc(Re)):0,g=Array.isArray(Q.variants)?[...Q.variants]:[],ve={...g[D]||{},options:Array.isArray((Oe=g[D])==null?void 0:Oe.options)?[...g[D].options]:[]};return ve.options[b]={...ve.options[b]||{},label:String(((Je=ve.options[b])==null?void 0:Je.label)||""),price:d,priceDigits:de},g[D]=ve,{...Q,variants:g}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{K(F=>{var H;const Q=Array.isArray(F.variants)?[...F.variants]:[],q={...Q[D]||{},options:Array.isArray((H=Q[D])==null?void 0:H.options)?[...Q[D].options]:[]};return q.options.splice(b,1),Q[D]=q,{...F,variants:Q}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{K(i=>{var F;const b=Array.isArray(i.variants)?[...i.variants]:[],_={...b[D]||{},options:Array.isArray((F=b[D])==null?void 0:F.options)?[...b[D].options]:[]},T=Ne(i.price);return _.options.push({label:"",price:T,priceDigits:String(T)}),b[D]=_,{...i,variants:b}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{K(h=>{const D=Ne(h.price),i=Array.isArray(h.variants)?[...h.variants]:[],b=String(D);return i.push({name:"Size",options:[{label:"S",price:D,priceDigits:b},{label:"M",price:D,priceDigits:b},{label:"L",price:D,priceDigits:b}]}),{...h,variants:i}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:Ae,disabled:!Array.isArray(y.variants)||y.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111."))),React.createElement("div",{className:"mb-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"URL \u1EA3nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",placeholder:"https://...",value:y.image,onChange:h=>K({...y,image:h.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"10px",fontSize:"0.9rem"}}))),React.createElement("div",{className:"modal-footer border-0 py-3",style:{background:"#fff"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:Y,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:se,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},se?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}function VideoModal({show:A,video:w,onClose:L,onSave:Y}){const[X,y]=useState({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),[K,se]=useState(!1),[oe,W]=useState("");useEffect(()=>{w?(y({title:w.title||"",youtube_url:`https://www.youtube.com/watch?v=${w.youtubeId}`,thumbnail_url:w.thumb||"",sort_order:w.sortOrder||0}),W(w.thumb)):(y({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),W(""))},[w,A]);const pe=ce=>{const fe=ce.match(/(?:youtube\.com\/(?:embed\/|watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return fe?fe[1]:null},Ne=ce=>{y({...X,youtube_url:ce});const fe=pe(ce);fe&&W(`https://img.youtube.com/vi/${fe}/hqdefault.jpg`)},re=async ce=>{ce.preventDefault(),se(!0),await Y(X),se(!1)};return A?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},w?"S\u1EEDa Video":"Th\xEAm Video m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:L})),React.createElement("form",{onSubmit:re},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Link YouTube *"),React.createElement("input",{type:"url",className:"form-control",value:X.youtube_url,onChange:ce=>Ne(ce.target.value),placeholder:"https://www.youtube.com/watch?v=... ho\u1EB7c shorts/...",required:!0}),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3: youtube.com/watch, youtu.be, youtube.com/shorts")),oe&&React.createElement("div",{className:"mb-3 text-center"},React.createElement("img",{src:oe,alt:"Preview",className:"img-fluid rounded",style:{maxHeight:"150px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ti\xEAu \u0111\u1EC1 *"),React.createElement("input",{type:"text",className:"form-control",value:X.title,onChange:ce=>y({...X,title:ce.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:X.sort_order,onChange:ce=>y({...X,sort_order:parseInt(ce.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Thumbnail t\xF9y ch\u1EC9nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",value:X.thumbnail_url,onChange:ce=>y({...X,thumbnail_url:ce.target.value}),placeholder:"\u0110\u1EC3 tr\u1ED1ng s\u1EBD d\xF9ng thumbnail m\u1EB7c \u0111\u1ECBnh c\u1EE7a YouTube"}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:L},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:K},K?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function AdminApp(){const[A,w]=useState(!1),[L,Y]=useState(""),[X,y]=useState(null),[K,se]=useState("search"),[oe,W]=useState(null),[pe,Ne]=useState(""),[re,ce]=useState([]),[fe,Ae]=useState(null),[le,we]=useState(!1),[be,Me]=useState(null),[Ce,je]=useState(!0),[he,ie]=useState([]),[$e,Te]=useState(()=>loadAdminSettings()),[_e,ke]=useState(null),[ze,h]=useState([]);useEffect(()=>{const x=localStorage.getItem("ktm_admin_session");if(x)try{const r=JSON.parse(x);r.expiry>Date.now()?(w(!0),y(r.user)):localStorage.removeItem("ktm_admin_session")}catch(r){localStorage.removeItem("ktm_admin_session")}},[]),useEffect(()=>{A&&T()},[A]),useEffect(()=>{if(!A)return;let x=!1;return(async()=>{try{const r=await fetchAdminSettingsFromServer();if(x)return;Te(r),saveAdminSettings(r)}catch(r){}})(),()=>{x=!0}},[A]);const D=async(x,r)=>{Y("");try{const z=await window.KTM.api.postJSON(`${API_BASE}/api/auth/login`,{username:x,password:r},"\u0110\u0103ng nh\u1EADp th\u1EA5t b\u1EA1i"),Oe={user:z.user,token:z.token,expiry:Date.now()+100*365*24*60*60*1e3};localStorage.setItem("ktm_admin_session",JSON.stringify(Oe)),y(z.user),w(!0)}catch(z){Y(z.message)}},i=()=>{localStorage.removeItem("ktm_admin_session"),w(!1),y(null),ce([]),Ae(null)},b=(x,r="success")=>{const z=Date.now();ie(Oe=>[...Oe,{id:z,message:x,type:r}])},_=x=>{ie(r=>r.filter(z=>z.id!==x))},T=async(x=null)=>{je(!0);try{const r=x?`${API_BASE}/api/albums?parent_id=${x}`:`${API_BASE}/api/albums?parent_id=root`,z=await window.KTM.api.getJSON(r,"L\u1ED7i t\u1EA3i danh s\xE1ch album");ce(Array.isArray(z)?z:[])}catch(r){console.error(r),b("L\u1ED7i t\u1EA3i danh s\xE1ch album","danger")}je(!1)},F=()=>{Me(null),we(!0)},Q=x=>{Me(x),we(!0)},q=async x=>{try{const r=be&&be.uuid;!r&&_e&&(x.parent_id=_e.uuid);const z=r?`${API_BASE}/api/albums/${be.uuid||be.id}`:`${API_BASE}/api/albums`;r?await window.KTM.api.putJSON(z,x,"L\u1ED7i c\u1EADp nh\u1EADt"):await window.KTM.api.postJSON(z,x,"L\u1ED7i t\u1EA1o"),b(r?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"T\u1EA1o th\xE0nh c\xF4ng!","success"),we(!1),T(_e==null?void 0:_e.uuid)}catch(r){b(r.message,"danger")}},H=x=>{Ae(x)},de=x=>{if(x==="root")h([]),ke(null),T(null);else if(x){const r=ze.findIndex(z=>z.uuid===x.uuid);r>=0&&(h(ze.slice(0,r+1)),ke(x),T(x.uuid))}else{const r=[...ze];r.pop();const z=r[r.length-1]||null;h(r),ke(z),T(z==null?void 0:z.uuid)}},Re=async x=>{const r=`X\xF3a folder "${x.title}"? T\u1EA5t c\u1EA3 folder con v\xE0 \u1EA3nh b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`;if(confirm(r))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${x.uuid||x.id}`,"L\u1ED7i x\xF3a album"),b("\u0110\xE3 x\xF3a","success"),T(_e==null?void 0:_e.uuid)}catch(z){b("L\u1ED7i x\xF3a album","danger")}};if(!A)return React.createElement(LoginPage,{onLogin:D,error:L});const d=()=>{const x=new Date,r=x.getFullYear(),z=String(x.getMonth()+1).padStart(2,"0");return`${r}-${z}`};function g(){const[x,r]=useState(()=>{var qe;return String((qe=$e==null?void 0:$e.ship_percent)!=null?qe:DEFAULT_SHIP_PERCENT)}),[z,Oe]=useState(!1);return useEffect(()=>{var qe;r(String((qe=$e==null?void 0:$e.ship_percent)!=null?qe:DEFAULT_SHIP_PERCENT))},[$e==null?void 0:$e.ship_percent]),React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-cog me-2 text-warning"}),"C\xE0i \u0111\u1EB7t")),React.createElement("div",{className:"card p-3"},React.createElement("form",{onSubmit:async qe=>{qe.preventDefault(),Oe(!0);const Le=saveAdminSettings({ship_percent:x});try{const Qe=await saveAdminSettingsToServer(Le);Te(Qe),saveAdminSettings(Qe),b("\u0110\xE3 l\u01B0u c\xE0i \u0111\u1EB7t v\xE0o DB","success")}catch(Qe){Te(Le),b("Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c DB, \u0111\xE3 l\u01B0u t\u1EA1m tr\xEAn m\xE1y","warning")}finally{Oe(!1)}}},React.createElement("div",{className:"mb-2 text-muted small"},"\xC1p d\u1EE5ng cho th\u1ED1ng k\xEA hoa h\u1ED3ng khi \u0111\u01A1n h\xE0ng kh\xF4ng ghi ph\xED ship trong ghi ch\xFA s\u1EA3n ph\u1EA9m."),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ph\xED ship (%) khi kh\xF4ng c\xF3 ship"),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",value:x,min:"0",max:"100",step:"0.01",onChange:qe=>r(qe.target.value)}),React.createElement("span",{className:"input-group-text"},"%")),React.createElement("div",{className:"form-text"},"M\u1EB7c \u0111\u1ECBnh: ",DEFAULT_SHIP_PERCENT,"%")),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:z},z?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u c\xE0i \u0111\u1EB7t"))))}function ve(){const[x,r]=useState(d()),[z,Oe]=useState(!0),[Je,qe]=useState([]),[Le,Qe]=useState([]),Ze=useRef(!1),At=useRef(new Map),De=normalizeShipPercent($e==null?void 0:$e.ship_percent),{parseMoney:xt,parseShipFeeFromNote:Et,getShipFeeForItems:dt,formatNumber:ge,formatVND:Ve}=window.KTM.money,st=async()=>{if(!Ze.current)try{const M=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i danh s\xE1ch s\u1EA3n ph\u1EA9m");Qe(Array.isArray(M)?M:[]),Ze.current=!0}catch(M){console.error("Load products for stats error:",M),Qe([]),Ze.current=!0}},St=async M=>{var it,rt;const Ee=String(M||"").trim();if(!Ee)return[];const Ue=(it=At.current)==null?void 0:it.get(Ee);if(Ue&&Array.isArray(Ue))return Ue;const Ge=await window.KTM.api.getJSON(`${API_BASE}/api/orders?month=${encodeURIComponent(Ee)}`,"L\u1ED7i t\u1EA3i th\u1ED1ng k\xEA"),et=Array.isArray(Ge)?Ge:[];return(rt=At.current)==null||rt.set(Ee,et),et},f=async()=>{Oe(!0);try{await st();const M=await St(x);qe(Array.isArray(M)?M:[])}catch(M){console.error("Load stats error:",M),qe([])}finally{Oe(!1)}};useEffect(()=>{f()},[x]);const I=React.useMemo(()=>{var te;const M={draft:0,pending:0,processing:0,done:0,paid:0,canceled:0,other:0};let Ee=0,Ue=0,Ge=0,et=0,it=0,rt=0,It=0,Mt=0;const ft=k=>k.customer_id||k.phone||"unknown",Ct=k=>window.KTM.orders.getOrderItems(k),$t=new Map,jt=new Map,Rt=new Map,Tt=5,gt=new Map((Array.isArray(Le)?Le:[]).map(k=>{var We;const J=(We=k==null?void 0:k.commission_percent)!=null?We:k==null?void 0:k.commissionPercent,Ie=Number(J),ue=Number.isFinite(Ie)?Math.max(0,Math.min(100,Ie)):Tt;return[String(k==null?void 0:k.id),ue]})),t=k=>{const J=String(k!=null?k:"").trim().toLowerCase();return J==="cancelled"?"canceled":J};for(const k of Je){const J=t(k==null?void 0:k.status),We=J==="canceled"||J==="draft",at=Ct(k);let ye=0,Ye=0,pt=0;for(const C of at){const P=Number((C==null?void 0:C.quantity)||0)||0,G=xt(C==null?void 0:C.product_price),ee=P*G,U=String((C==null?void 0:C.product_id)||""),Se=gt.has(U)?gt.get(U):Tt,xe=(Number(Se)||0)/100;if(ye+=P,Ye+=ee,pt+=ee*xe,!We){const Pe=(C==null?void 0:C.product_id)||"unknown",Be=$t.get(U)||{product_id:Pe,product_name:(C==null?void 0:C.product_name)||"\u2014",product_code:(C==null?void 0:C.product_code)||"",orders:0,quantity:0,revenue:0};Be.orders+=1,Be.quantity+=P,Be.revenue+=ee,$t.set(Pe,Be)}}const Ft=dt(at),Lt=Number((te=k==null?void 0:k.adjustment_amount)!=null?te:0)||0,ht=Ye+(Ft.found?Ft.fee:0)+Lt,qt=Ye+Lt,Pt=!Ft.found&&De>0&&Ye>0?Ye*De/100:0,Bt=Ye>0?pt/Ye:Tt/100,Vt=pt+Lt*Bt-Pt*Bt,O=J==="done"||J==="paid";if(J==="draft"?M.draft+=1:J==="pending"?M.pending+=1:J==="processing"?M.processing+=1:J==="canceled"?M.canceled+=1:J==="paid"?(M.paid+=1,M.done+=1,et+=ht,rt+=qt,Mt+=Vt):J==="done"?(M.done+=1,et+=ht,rt+=qt,Mt+=Vt):M.other+=1,!We){Ee+=1,Ue+=ye,Ge+=ht,it+=qt,It+=Vt;const C=ft(k),P=jt.get(C)||{key:C,customer_name:k.customer_name||"",phone:k.phone||"",orders:0,quantity:0,revenue:0};P.orders+=1,P.quantity+=ye,P.revenue+=ht,!P.customer_name&&k.customer_name&&(P.customer_name=k.customer_name),!P.phone&&k.phone&&(P.phone=k.phone),jt.set(C,P);const G=k.created_at?new Date(k.created_at):null;if(G&&!Number.isNaN(G.getTime())){const ee=`${G.getFullYear()}-${String(G.getMonth()+1).padStart(2,"0")}-${String(G.getDate()).padStart(2,"0")}`,U=Rt.get(ee)||{day:ee,orders:0,quantity:0,revenue:0,doneOrders:0,doneRevenue:0};U.orders+=1,U.quantity+=ye,U.revenue+=ht,O&&(U.doneOrders+=1,U.doneRevenue+=ht),Rt.set(ee,U)}}}const v=Array.from($t.values()).sort((k,J)=>J.revenue-k.revenue),N=Array.from(jt.values()).sort((k,J)=>J.revenue-k.revenue),B=Array.from(Rt.values()).sort((k,J)=>k.day.localeCompare(J.day)),Z=jt.size,$=Ee?Math.round(Ge/Ee):0,m=Ee?Ue/Ee:0,V=Math.round(Mt),ne=Math.round(It);return{statusCounts:M,activeOrders:Ee,totalQty:Ue,totalRevenue:Ge,doneRevenue:et,tempCommission:V,tempCommissionAll:ne,products:v,customers:N,days:B,uniqueCustomers:Z,avgOrderValue:$,avgQtyPerOrder:m}},[Je,Le,x]);return React.createElement("div",{className:"product-manager pb-5 mb-4 stats-manager"},React.createElement(Loading,{show:z}),React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-chart-column me-2 text-warning"}),"Th\u1ED1ng k\xEA"),React.createElement("button",{className:"btn btn-outline-secondary btn-sm",onClick:f,disabled:z},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"Ch\u1ECDn th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:x,onChange:M=>r(M.target.value),"aria-label":"Ch\u1ECDn th\xE1ng"}))),React.createElement("div",{className:"col-12 col-md-7 d-flex gap-2 justify-content-md-end"},React.createElement("div",{className:"d-flex flex-wrap gap-2 align-self-center"},React.createElement("span",{className:"badge rounded-pill bg-secondary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-truck me-1"}),"Ship \u01B0\u1EDBc t\xEDnh: ",De,"%"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-receipt me-1"}),ge(I.activeOrders)," \u0111\u01A1n"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-user me-1"}),ge(I.uniqueCustomers)," kh\xE1ch"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-boxes-stacked me-1"}),ge(I.totalQty)," SL"),React.createElement("span",{className:"badge rounded-pill bg-primary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-hand-holding-dollar me-1"}),"\u0110\xE3 nh\u1EADn ti\u1EC1n: ",ge(I.statusCounts.paid),"/",ge(I.statusCounts.done)))))),React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng \u0111\u01A1n (kh\xF4ng t\xEDnh h\u1EE7y/nh\xE1p)"),React.createElement("i",{className:"fas fa-receipt text-dark"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},ge(I.activeOrders)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (t\u1EA1m t\xEDnh)"),React.createElement("i",{className:"fas fa-sack-dollar text-warning"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Ve(I.totalRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (Ho\xE0n th\xE0nh)"),React.createElement("i",{className:"fas fa-circle-check text-success"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Ve(I.doneRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-info bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng s\u1EBD nh\u1EADn (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-chart-line text-info"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Ve(I.tempCommission)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng t\u1ED5ng (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-coins text-primary"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Ve(I.tempCommissionAll))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-layer-group me-2 text-warning"}),"T\u1ED5ng quan tr\u1EA1ng th\xE1i"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},"SL TB/\u0111\u01A1n: ",I.avgQtyPerOrder?I.avgQtyPerOrder.toFixed(2):"0.00")),React.createElement("div",{className:"d-md-none mt-2"},React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-light bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Nh\xE1p"),React.createElement("div",{className:"fw-semibold"},ge(I.statusCounts.draft)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-secondary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("div",{className:"fw-semibold"},ge(I.statusCounts.pending)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("div",{className:"fw-semibold"},ge(I.statusCounts.processing)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-danger bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"H\u1EE7y \u0111\u01A1n"),React.createElement("div",{className:"fw-semibold"},ge(I.statusCounts.canceled)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh"),React.createElement("div",{className:"fw-semibold"},ge(I.statusCounts.done)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("div",{className:"fw-semibold"},ge(I.statusCounts.paid)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng SL"),React.createElement("div",{className:"fw-semibold"},ge(I.totalQty)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Nh\xE1p"),React.createElement("th",null,"Ch\u1EDD x\u1EED l\xFD"),React.createElement("th",null,"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("th",null,"H\u1EE7y \u0111\u01A1n"),React.createElement("th",null,"Ho\xE0n th\xE0nh"),React.createElement("th",null,"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("th",null,"Kh\xE1c"),React.createElement("th",null,"T\u1ED5ng SL"))),React.createElement("tbody",null,React.createElement("tr",null,React.createElement("td",null,ge(I.statusCounts.draft)),React.createElement("td",null,ge(I.statusCounts.pending)),React.createElement("td",null,ge(I.statusCounts.processing)),React.createElement("td",null,ge(I.statusCounts.canceled)),React.createElement("td",null,ge(I.statusCounts.done)),React.createElement("td",null,ge(I.statusCounts.paid)),React.createElement("td",null,ge(I.statusCounts.other)),React.createElement("td",null,ge(I.totalQty))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-box me-2 text-info"}),"Top s\u1EA3n ph\u1EA9m"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},I.products.slice(0,10).map(M=>React.createElement("div",{key:M.product_id,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-info"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},M.product_name),React.createElement("div",{className:"text-muted small text-truncate"},M.product_code?`#${M.product_code} \u2022 `:"",ge(M.orders)," \u0111\u01A1n \u2022 ",ge(M.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},Ve(M.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"M\xE3"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,I.products.slice(0,10).map(M=>React.createElement("tr",{key:M.product_id},React.createElement("td",null,M.product_name),React.createElement("td",null,M.product_code||"\u2014"),React.createElement("td",null,ge(M.orders)),React.createElement("td",null,ge(M.quantity)),React.createElement("td",{className:"fw-semibold"},Ve(M.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-user-group me-2 text-warning"}),"Top kh\xE1ch h\xE0ng"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},I.customers.slice(0,10).map(M=>React.createElement("div",{key:M.key,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-warning"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},M.customer_name||"\u2014"),React.createElement("div",{className:"text-muted small text-truncate"},M.phone||"\u2014"," \u2022 ",ge(M.orders)," \u0111\u01A1n \u2022 ",ge(M.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},Ve(M.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,I.customers.slice(0,10).map(M=>React.createElement("tr",{key:M.key},React.createElement("td",null,M.customer_name||"\u2014"),React.createElement("td",null,M.phone||"\u2014"),React.createElement("td",null,ge(M.orders)),React.createElement("td",null,ge(M.quantity)),React.createElement("td",{className:"fw-semibold"},Ve(M.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3 mb-4"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-calendar-day me-2 text-success"}),"Theo ng\xE0y"),React.createElement("span",{className:"badge rounded-pill bg-success bg-opacity-10 text-dark"},"DT (t\u1EA1m t\xEDnh) & ho\xE0n th\xE0nh")),React.createElement("div",{className:"d-md-none mt-2"},I.days.map(M=>React.createElement("div",{key:M.day,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-success"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"fw-semibold"},M.day),React.createElement("div",{className:"text-muted small"},ge(M.orders)," \u0111\u01A1n \u2022 ",ge(M.quantity)," SL"),React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh: ",ge(M.doneOrders)," \u2022 ",Ve(M.doneRevenue))),React.createElement("div",{className:"fw-semibold text-nowrap"},Ve(M.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Ng\xE0y"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"DT (t\u1EA1m t\xEDnh)"),React.createElement("th",null,"\u0110\u01A1n ho\xE0n th\xE0nh"),React.createElement("th",null,"DT ho\xE0n th\xE0nh"))),React.createElement("tbody",null,I.days.map(M=>React.createElement("tr",{key:M.day},React.createElement("td",null,M.day),React.createElement("td",null,ge(M.orders)),React.createElement("td",null,ge(M.quantity)),React.createElement("td",{className:"fw-semibold"},Ve(M.revenue)),React.createElement("td",null,ge(M.doneOrders)),React.createElement("td",{className:"fw-semibold"},Ve(M.doneRevenue)))))))))}return React.createElement("div",null,React.createElement(Sidebar,{activeMenu:K,onMenuChange:x=>{se(x),x==="albums"&&(ke(null),h([]),T(null))},onLogout:i,currentUser:X}),React.createElement("div",{className:"main-content"},K==="albums"&&!fe&&React.createElement(AlbumList,{albums:re,loading:Ce,currentFolder:_e,breadcrumb:ze,onSelect:H,onCreate:F,onEdit:Q,onDelete:Re,onBack:de}),K==="search"&&React.createElement(SearchCenter,{showToast:b,onNavigate:(x,r,z)=>{se(x),x==="orders"&&r==="create"&&(W(Date.now()),Ne((z==null?void 0:z.productId)||""))}}),K==="albums"&&fe&&React.createElement(AlbumDetail,{album:fe,parentAlbum:ze.length>0?ze[ze.length-1]:null,onBack:()=>{if(fe.parentId){const x=ze.findIndex(r=>r.uuid===fe.parentId);x>=0?Ae(ze[x]):Ae(null)}else Ae(null)},onRefresh:()=>T(_e==null?void 0:_e.uuid),showToast:b,onNavigateToFolder:x=>{h(r=>[...r,fe]),Ae(x)},onEditSubfolder:x=>{Me(x),we(!0)}}),K==="videos"&&React.createElement(VideoList,{showToast:b}),K==="products"&&React.createElement(ProductManager,{showToast:b,settings:$e}),K==="orders"&&React.createElement(OrderManager,{autoOpenCreateToken:oe,autoOpenCreateProductId:pe,showToast:b}),K==="stats"&&React.createElement(ve,null),K==="settings"&&React.createElement(g,null)),React.createElement("nav",{className:"mobile-bottom-nav"},React.createElement("div",{className:"nav-items"},React.createElement("a",{href:"#",className:`nav-item ${K==="search"?"active":""}`,onClick:x=>{x.preventDefault(),se("search")}},React.createElement("i",{className:"fas fa-search"}),React.createElement("span",null,"Tra c\u1EE9u")),React.createElement("a",{href:"#",className:`nav-item ${K==="albums"?"active":""}`,onClick:x=>{x.preventDefault(),se("albums"),Ae(null)}},React.createElement("i",{className:"fas fa-images"}),React.createElement("span",null,"Album")),React.createElement("a",{href:"#",className:`nav-item ${K==="videos"?"active":""}`,onClick:x=>{x.preventDefault(),se("videos")}},React.createElement("i",{className:"fas fa-video"}),React.createElement("span",null,"Video")),React.createElement("a",{href:"#",className:`nav-item ${K==="products"?"active":""}`,onClick:x=>{x.preventDefault(),se("products")}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",null,"S\u1EA3n ph\u1EA9m")),React.createElement("a",{href:"#",className:`nav-item ${K==="orders"?"active":""}`,onClick:x=>{x.preventDefault(),se("orders")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",null,"\u0110\u01A1n h\xE0ng")),React.createElement("a",{href:"#",className:`nav-item ${K==="stats"?"active":""}`,onClick:x=>{x.preventDefault(),se("stats")}},React.createElement("i",{className:"fas fa-chart-column"}),React.createElement("span",null,"Th\u1ED1ng k\xEA")))),React.createElement(AlbumModal,{show:le,album:be,parentId:_e==null?void 0:_e.uuid,onClose:()=>we(!1),onSave:q}),React.createElement("div",{className:"toast-container"},he.map(x=>React.createElement(Toast,{key:x.id,message:x.message,type:x.type,onClose:()=>_(x.id)}))))}ReactDOM.render(React.createElement(AdminApp,null),document.getElementById("root"));function OrderManager({autoOpenCreateToken:A,autoOpenCreateProductId:w,showToast:L}){const[Y,X]=useState([]),[y,K]=useState([]),[se,oe]=useState(!0),[W,pe]=useState(!1),[Ne,re]=useState([]),[ce,fe]=useState(!1),[Ae,le]=useState(""),[we,be]=useState([]),[Me,Ce]=useState(!1),[je,he]=useState(""),[ie,$e]=useState(!1),[Te,_e]=useState(null),[ke,ze]=useState(null),[h,D]=useState(!1),[i,b]=useState(()=>{const e=new Date,a=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0");return`${a}-${n}`}),[_,T]=useState(""),[F,Q]=useState(!1),[q,H]=useState(!1),[de,Re]=useState(null),[d,g]=useState(!1),[ve,x]=useState([]),[r,z]=useState({customer_name:"",phone:"",address:"",note:"",items:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_amount:0,adjustment_note:"",status:"pending"}),[Oe,Je]=useState([""]),[qe,Le]=useState(null),Qe=useRef({}),[Ze,At]=useState([]),[De,xt]=useState(null),Et=useRef(null),dt=useRef(null),ge=useRef(0),Ve=useRef(null),st=useRef(0),St=useRef(new Map),f=useRef(new Map),I=useRef(""),M=useRef(null),Ee=useRef(0),Ue=useRef(null),Ge=9,et=150,it=24*60*60*1e3,rt=5*60*1e3,It="ktm_customer_lookup_cache_v1",Mt=200,ft=3,Ct=3,$t=1,jt=24*60*60*1e3,Rt=120,Tt=5*60*1e3,gt=80,t=2,v=4,N=React.useMemo(()=>String(Ae||"").trim().length>0,[Ae]),B=e=>String(e||"").replace(/\s+/g," ").trim(),Z=e=>String(e||"").replace(/[^0-9]+/g,""),$=e=>{try{const a=new Date(e==null?void 0:e.created_at).getTime();if(!Number.isFinite(a))return 0;const n=Date.now()-a;return!Number.isFinite(n)||n<=0?0:Math.floor(n/jt)}catch(a){return 0}},m=e=>String((e==null?void 0:e.status)||"").trim()!=="pending"?!1:$(e)>=ft,V=e=>{const a=String(e!=null?e:"").trim().toLowerCase();return a==="cancelled"?"canceled":a},ne=e=>{if(V(e==null?void 0:e.status)!=="draft")return null;const n=Ct-$(e);return Number.isFinite(n)?n:null},te=e=>{const a=ne(e);return Number.isFinite(a)?a>0&&a<=$t:!1},k=e=>{z({customer_name:"",phone:"",address:"",note:"",items:[{product_id:e||"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_amount:0,adjustment_note:"",status:"pending"}),Je([""]),Re(null),Le(null)};useEffect(()=>{const e=a=>{var s;if(qe==null)return;const n=(s=Qe.current)==null?void 0:s[qe];n&&!n.contains(a.target)&&Le(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[qe]);const J=e=>window.KTM.money.parseMoney(e),Ie=e=>window.KTM.money.parseSignedMoney(e),ue=e=>window.KTM.money.formatVND(e),We=e=>window.KTM.money.parseShipFeeFromNote(e),at=e=>window.KTM.phone.isValid(e),ye=e=>window.KTM.phone.normalize(e),Ye=()=>{var e;try{const a=localStorage.getItem(It);if(!a)return;const n=JSON.parse(a);if(!n||typeof n!="object")return;const s=Object.entries(n);for(const[l,u]of s)!l||!u||typeof u!="object"||(e=f.current)==null||e.set(String(l),u)}catch(a){}},pt=()=>{try{const e=f.current;if(!e||typeof e.entries!="function")return;const a=Array.from(e.entries()).filter(([s,l])=>s&&l&&typeof l=="object"&&Number.isFinite(l.ts)).sort((s,l)=>(Number(l[1].ts)||0)-(Number(s[1].ts)||0)).slice(0,Mt),n={};for(const[s,l]of a)n[s]=l;localStorage.setItem(It,JSON.stringify(n))}catch(e){}};useEffect(()=>{Ye()},[]);const Ft=e=>{const a=ye(e);if(!a)return null;const n=Array.isArray(Y)?Y:[];let s=null,l=-1;for(const u of n){if(!u||ye(u.phone||"")!==a)continue;const R=new Date(u.created_at).getTime(),S=Number.isFinite(R)?R:0;S>=l&&(l=S,s=u)}return s?{name:String(s.customer_name||"").trim(),address:String(s.address||"").trim()}:null},Lt=(e,a)=>{e&&z(n=>a&&ye(n.phone)!==a?n:{...n,customer_name:e.name||n.customer_name,address:e.address||n.address})},ht=e=>{const a=Ft(e);if(!a)return;const n=ye(e);z(s=>{if(n&&ye(s.phone)!==n)return s;const l={...s};return!String(s.customer_name||"").trim()&&a.name&&(l.customer_name=a.name),!String(s.address||"").trim()&&a.address&&(l.address=a.address),l})},qt=(e,a,n)=>{var s;try{const l=ye(e);if(!l)return;const u=String(a||"").trim(),R=String(n||"").trim();if(!u&&!R)return;(s=f.current)==null||s.set(l,{ts:Date.now(),status:"found",customer:{phone:l,name:u||null,address:R||null}}),pt()}catch(l){}},Pt=async e=>{var l,u,R;const a=ye(e);if(!a)return;ht(a);const n=(l=f.current)==null?void 0:l.get(a);if(n&&Number.isFinite(n.ts)){const S=Date.now()-n.ts,c=n.status==="found"?it:rt;if(S>=0&&S<=c){Re({status:n.status,phone:a,customer:n.customer}),n.status==="found"&&n.customer&&Lt(n.customer,a);return}}const s=++ge.current;Re({status:"loading",phone:a});try{const S=await window.KTM.api.getJSON(`${API_BASE}/api/customers?phone=${encodeURIComponent(a)}`,"L\u1ED7i tra c\u1EE9u kh\xE1ch");if(ge.current!==s)return;if(S&&S.exists&&S.customer){(u=f.current)==null||u.set(a,{ts:Date.now(),status:"found",customer:S.customer}),pt(),Re({status:"found",phone:a,customer:S.customer}),Lt(S.customer,a);return}(R=f.current)==null||R.set(a,{ts:Date.now(),status:"not-found",customer:null}),pt(),Re({status:"not-found",phone:a})}catch(S){if(ge.current!==s)return;console.error("Customer lookup error:",S),Re({status:"error",phone:a})}},Bt=e=>{const a=ye(e),n=Ft(a);z(l=>{const u={...l,phone:a};return n&&(!String(l.customer_name||"").trim()&&n.name&&(u.customer_name=n.name),!String(l.address||"").trim()&&n.address&&(u.address=n.address)),u}),g(!1),dt.current&&(clearTimeout(dt.current),dt.current=null);const s=a;if(s.length<Ge){Re(null);return}if(at(s)&&s!==I.current){I.current=s,Pt(s);return}dt.current=setTimeout(()=>{const l=ye(a);at(l)&&l!==I.current&&(I.current=l,Pt(l))},et)},Vt=()=>{const e=ye(r.phone);e.length<Ge||at(e)&&e!==I.current&&(I.current=e,Pt(e))};useEffect(()=>(q?(document.body.classList.add("order-modal-open"),document.body.style.overflow="hidden"):(document.body.classList.remove("order-modal-open"),document.body.style.overflow=""),()=>{document.body.classList.remove("order-modal-open"),document.body.style.overflow=""}),[q]);const O=Array.isArray(r.items)?r.items.length:0;useEffect(()=>{if(!q){Ee.current=O;return}O>Ee.current&&setTimeout(()=>{const e=M.current;e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},0),Ee.current=O},[q,O]),useEffect(()=>()=>{dt.current&&(clearTimeout(dt.current),dt.current=null)},[]),useEffect(()=>{vt()},[]),useEffect(()=>{N||ot()},[i,N]),useEffect(()=>{yt()},[]),useEffect(()=>{A&&Et.current!==A&&(Et.current=A,kt(w))},[A]);const C=e=>e==="draft"?"\u0110\u01A1n nh\xE1p":e==="pending"?"Ch\u1EDD x\u1EED l\xFD":e==="processing"?"\u0110ang v\u1EADn chuy\u1EC3n":e==="done"?"Ho\xE0n th\xE0nh":e==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":e==="cancelled"||e==="canceled"?"H\u1EE7y \u0111\u01A1n":e||"",P=e=>e==="draft"?"bg-light text-dark":e==="pending"?"bg-secondary":e==="processing"?"bg-warning text-dark":e==="done"?"bg-success":e==="paid"?"bg-primary":e==="cancelled"||e==="canceled"?"bg-danger":"bg-light text-dark",G=React.useMemo(()=>window.KTM.orders.sortOrders(Y),[Y]),ee=React.useMemo(()=>window.KTM.orders.sortOrders(y),[y]),U=React.useMemo(()=>{const a=(Array.isArray(ee)?ee:[]).filter(n=>m(n));return a.sort((n,s)=>{const l=new Date(n==null?void 0:n.created_at).getTime(),u=new Date(s==null?void 0:s.created_at).getTime();return(Number.isFinite(l)?l:0)-(Number.isFinite(u)?u:0)}),a},[ee]),Se=React.useMemo(()=>{const a=(Array.isArray(Ne)?Ne:[]).filter(n=>te(n));return a.sort((n,s)=>{const l=new Date(n==null?void 0:n.created_at).getTime(),u=new Date(s==null?void 0:s.created_at).getTime();return(Number.isFinite(l)?l:0)-(Number.isFinite(u)?u:0)}),a},[Ne]),xe=React.useMemo(()=>F?U:G,[F,U,G]),Pe=React.useMemo(()=>{if(F)return xe;const e=String(_||"").trim();return e?(Array.isArray(xe)?xe:[]).filter(a=>String((a==null?void 0:a.status)||"").trim()===e):xe},[xe,_,F]),Be=React.useMemo(()=>window.KTM.orders.sortOrders(we),[we]),tt=React.useMemo(()=>N?Be:Pe,[Pe,N,Be]),ct=e=>window.KTM.date.formatDateTime(e),vt=async()=>{try{const e=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");At(Array.isArray(e)?e:[])}catch(e){console.error("Load products error:",e),At([])}},ot=async()=>{oe(!0);try{let e=`${API_BASE}/api/orders`;i&&(e+=`?month=${i}`);const a=await window.KTM.api.getJSON(e,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng");X(Array.isArray(a)?a:[]),yt()}catch(e){console.error("Load orders error:",e),X([])}finally{oe(!1)}},bt=async e=>{var l;const a=B(e);if(!a){be([]),he(""),Ce(!1);return}const n=Z(a);if(a.length<t&&n.length<v){be([]),he(`Nh\u1EADp \xEDt nh\u1EA5t ${t} k\xFD t\u1EF1 (ho\u1EB7c ${v} s\u1ED1) \u0111\u1EC3 search nhanh`),Ce(!1);return}try{const u=(l=St.current)==null?void 0:l.get(a);if(u&&Number.isFinite(u.ts)&&Date.now()-u.ts<=Tt){be(Array.isArray(u.results)?u.results:[]),he(""),Ce(!1);return}}catch(u){}const s=++st.current;Ce(!0),he("");try{const u=`${API_BASE}/api/orders?search=${encodeURIComponent(a)}`,R=await window.KTM.api.getJSON(u,"L\u1ED7i search \u0111\u01A1n h\xE0ng");if(st.current!==s)return;const S=Array.isArray(R)?R:[];be(S);try{const c=St.current;if(c&&typeof c.set=="function"&&(c.set(a,{ts:Date.now(),results:S}),c.size>gt)){const o=Array.from(c.entries()).sort((j,E)=>{var ae,me;return(Number((ae=j==null?void 0:j[1])==null?void 0:ae.ts)||0)-(Number((me=E==null?void 0:E[1])==null?void 0:me.ts)||0)}),p=Math.max(0,o.length-gt);for(let j=0;j<p;j++)c.delete(o[j][0])}}catch(c){}}catch(u){if(st.current!==s)return;console.error("Order search error:",u),be([]),he((u==null?void 0:u.message)||"Search l\u1ED7i")}finally{if(st.current!==s)return;Ce(!1)}};useEffect(()=>{Ve.current&&(clearTimeout(Ve.current),Ve.current=null);const e=B(Ae);if(!e){be([]),he(""),Ce(!1);return}return F&&Q(!1),Ve.current=setTimeout(()=>{bt(e)},Rt),()=>{Ve.current&&(clearTimeout(Ve.current),Ve.current=null)}},[Ae]);const yt=async()=>{pe(!0),fe(!0);try{const[e,a]=await Promise.all([window.KTM.api.getJSON(`${API_BASE}/api/orders?overdue=1&days=${encodeURIComponent(ft)}`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),window.KTM.api.getJSON(`${API_BASE}/api/orders?draftExpiring=1&remainingDays=${encodeURIComponent($t)}`,"L\u1ED7i t\u1EA3i \u0111\u01A1n nh\xE1p")]);K(Array.isArray(e)?e:[]),re(Array.isArray(a)?a:[])}catch(e){console.error("Load all orders error:",e),K([]),re([])}finally{pe(!1),fe(!1)}},Nt=e=>{var n;xt(e.id);const a=Array.isArray(e.items)&&e.items.length?e.items.map(s=>{var l,u,R,S;return{product_id:(s==null?void 0:s.product_id)||"",quantity:Number((l=s==null?void 0:s.quantity)!=null?l:1)||1,unit_price:(()=>{var p;const c=(p=s==null?void 0:s.unit_price)!=null?p:s==null?void 0:s.unitPrice,o=c==null||c===""?NaN:Number(c);return Number.isFinite(o)?Math.trunc(o):null})(),variant:String((u=s==null?void 0:s.variant)!=null?u:"").trim(),variant_json:(S=(R=s==null?void 0:s.variant_json)!=null?R:s==null?void 0:s.variantJson)!=null?S:null}}).filter(s=>s.product_id):[{product_id:e.product_id||"",quantity:Number(e.quantity||1)||1,unit_price:null,variant:"",variant_json:null}];z({customer_name:e.customer_name||"",phone:ye(e.phone||""),address:e.address||"",note:(e==null?void 0:e.note)||"",items:a.length?a:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_amount:Number((n=e==null?void 0:e.adjustment_amount)!=null?n:0)||0,adjustment_note:(e==null?void 0:e.adjustment_note)||"",status:e.status||"pending"}),Je(new Array(a.length?a.length:1).fill("")),x(new Array(a.length?a.length:1).fill(!0)),Re(null),H(!0),e.phone&&Pt(ye(e.phone))};function kt(e){xt(null),k(e||""),g(!1),x([]),H(!0)}const Ot=()=>{ie||h||(H(!1),xt(null),k(""),g(!1),x([]))},Ht=async()=>{var S,c,o;if(!De||h||ie)return;const e=(Array.isArray(Y)?Y:[]).find(p=>String(p==null?void 0:p.id)===String(De))||null,a=String((e==null?void 0:e.status)||(r==null?void 0:r.status)||"").trim();if(a==="done"||a==="paid"||a==="canceled"){const p="Kh\xF4ng th\u1EC3 t\xE1ch: \u0111\u01A1n \u0111\xE3 ho\xE0n th\xE0nh/\u0111\xE3 nh\u1EADn ti\u1EC1n/\u0111\xE3 h\u1EE7y.";typeof L=="function"?L(p,"warning"):alert(p);return}const n=ye(r.phone),l=(Array.isArray(r.items)?r.items:[]).map((p,j)=>{var E,ae;return{idx:j,product_id:String((p==null?void 0:p.product_id)||"").trim(),quantity:Number((E=p==null?void 0:p.quantity)!=null?E:0),variant:String((p==null?void 0:p.variant)||"").trim()||null,variant_json:(ae=p==null?void 0:p.variant_json)!=null?ae:null,unit_price:(()=>{const me=p==null?void 0:p.unit_price,He=me===""||me==null?NaN:Number(me);if(Number.isFinite(He))return Math.max(0,Math.trunc(He));const Ke=_t(p==null?void 0:p.product_id),nt=p!=null&&p.variant_json&&typeof p.variant_json=="object"?p.variant_json:null;return Xt(Ke,nt)})()}}).filter(p=>p.product_id&&Number.isFinite(p.quantity)&&p.quantity>0);if(l.length<2){const p="C\u1EA7n \xEDt nh\u1EA5t 2 s\u1EA3n ph\u1EA9m \u0111\u1EC3 t\xE1ch \u0111\u01A1n.";typeof L=="function"?L(p,"warning"):alert(p);return}const u=[],R=[];for(const p of l){const j=!!ve[p.idx],E={product_id:p.product_id,quantity:p.quantity,unit_price:p.unit_price,variant:p.variant,variant_json:p.variant_json};j?u.push(E):R.push(E)}if(!u.length||!R.length){const p="Ch\u1ECDn m\u1ED9t s\u1ED1 s\u1EA3n ph\u1EA9m \u201CGiao \u0111\u1EE3t 1\u201D, v\xE0 \u0111\u1EC3 l\u1EA1i \xEDt nh\u1EA5t 1 s\u1EA3n ph\u1EA9m \u201CCh\u1EDD h\xE0ng\u201D.";typeof L=="function"?L(p,"warning"):alert(p);return}D(!0);try{const p=Ie(r.adjustment_amount),j=(r.adjustment_note||"").trim(),E={customer_name:r.customer_name,phone:n,address:r.address,note:(r.note||"").trim(),adjustment_amount:p,adjustment_note:j,status:"processing",items:u,product_id:u[0].product_id,quantity:u[0].quantity,split_seq:1},ae=await window.KTM.api.postJSON(`${API_BASE}/api/orders`,E,"L\u1ED7i t\xE1ch \u0111\u01A1n (t\u1EA1o \u0111\u01A1n giao ngay)"),me=(o=(c=ae==null?void 0:ae.id)!=null?c:(S=ae==null?void 0:ae.order)==null?void 0:S.id)!=null?o:null;if(!me)throw new Error("T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i: kh\xF4ng nh\u1EADn \u0111\u01B0\u1EE3c ID \u0111\u01A1n giao ngay");const He={id:De,customer_name:r.customer_name,phone:n,address:r.address,note:(r.note||"").trim(),adjustment_amount:0,adjustment_note:"",status:"pending",items:R,product_id:R[0].product_id,quantity:R[0].quantity,parent_order_id:String(me),split_seq:2};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${De}`,He,"L\u1ED7i t\xE1ch \u0111\u01A1n (c\u1EADp nh\u1EADt ph\u1EA7n ch\u1EDD h\xE0ng)"),Ot(),ot();const Ke=me?`\u0110\xE3 t\xE1ch \u0111\u01A1n. \u0110\u01A1n giao ngay: #${me}`:"\u0110\xE3 t\xE1ch \u0111\u01A1n.";typeof L=="function"?L(Ke,"success"):alert(Ke)}catch(p){console.error(p);const j=(p==null?void 0:p.message)||"T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i";typeof L=="function"?L(j,"danger"):alert(j)}finally{D(!1)}},Ut=e=>{if(!e)return"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --";const a=String(e),n=Ze.find(s=>String(s==null?void 0:s.id)===a);return n?`${n.name}${n.code?` (${n.code})`:""}`:"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"},wt=e=>{try{return String(e!=null?e:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(a){return String(e!=null?e:"").toLowerCase()}},Gt=e=>{const n=wt(e).trim().split(/\s+/).filter(Boolean),s=n.join(" ");return{contentTokens:n,cleanedQuery:s}},da=React.useMemo(()=>(Array.isArray(Ze)?Ze:[]).map((e,a)=>{var o,p,j,E,ae,me;const n=wt((o=e==null?void 0:e.name)!=null?o:""),s=wt((p=e==null?void 0:e.code)!=null?p:""),l=wt((j=e==null?void 0:e.category)!=null?j:""),u=wt((E=e==null?void 0:e.note)!=null?E:""),R=wt((ae=e==null?void 0:e.id)!=null?ae:""),S=wt((me=e==null?void 0:e.stt)!=null?me:""),c=`${n} ${s} ${l} ${u} ${R} ${S}`.trim();return{p:e,originalIndex:a,name:n,code:s,category:l,note:u,haystackAll:c}}),[Ze]),ya=(e,a,n)=>{var j,E,ae,me,He;const s=Array.isArray(a)?a:[],l=wt(n).trim();if(!s.length&&!l)return 0;const u=(j=e==null?void 0:e.name)!=null?j:"",R=(E=e==null?void 0:e.code)!=null?E:"",S=(ae=e==null?void 0:e.category)!=null?ae:"",c=(me=e==null?void 0:e.note)!=null?me:"";if(!((He=e==null?void 0:e.haystackAll)!=null?He:""))return 0;let p=0;l&&(u===l&&(p+=220),u.includes(l)&&(p+=140),u.startsWith(l)&&(p+=160),R&&R===l&&(p+=180),R&&R.includes(l)&&(p+=90));for(const Ke of s){if(!Ke)continue;const nt=new RegExp(`(?:^|\\s)${Ke.replace(/[.*+?^${}()|[\[\]\\]/g,"\\$&")}`);u.includes(Ke)&&(p+=35),nt.test(u)&&(p+=25),R&&R.includes(Ke)&&(p+=20),R&&nt.test(R)&&(p+=10),S&&S.includes(Ke)&&(p+=12),c&&c.includes(Ke)&&(p+=6)}return p>0&&u&&(p+=Math.max(0,10-Math.min(10,Math.floor(u.length/10)))),p},aa=(e,a)=>{const n=String(e||""),s=String(a||"");if(n===s)return 0;if(!n)return s.length;if(!s)return n.length;const l=n.length,u=s.length;if(u>l)return aa(s,n);let R=new Array(u+1),S=new Array(u+1);for(let c=0;c<=u;c++)R[c]=c;for(let c=1;c<=l;c++){S[0]=c;const o=n.charCodeAt(c-1);for(let j=1;j<=u;j++){const E=o===s.charCodeAt(j-1)?0:1;S[j]=Math.min(R[j]+1,S[j-1]+1,R[j-1]+E)}const p=R;R=S,S=p}return R[u]},Na=(e,a)=>{const n=String(e||"").trim(),s=String(a||"");if(!n||!s)return!1;if(s.includes(n))return!0;const l=s.split(/\s+/).filter(Boolean);if(!l.length)return!1;const u=n.length<=4?1:2;for(const R of l)if(!(Math.abs(R.length-n.length)>u)&&aa(n,R)<=u)return!0;return!1},Wt=e=>{const a=wt(e).replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim();return a?a.split(" ").filter(Boolean):[]},wa=(e,a)=>{const n=Array.isArray(a)?a:[];if(!n.length)return 0;const s=Wt((e==null?void 0:e.name)||""),l=Wt((e==null?void 0:e.code)||""),u=Wt((e==null?void 0:e.category)||""),R=Wt((e==null?void 0:e.note)||""),S=(o,p,j)=>{const E=String(o||"").trim();if(!E||!p.length)return 0;const ae=E.length<=4?1:2;let me=1/0,He=-1;for(let Xe=0;Xe<p.length;Xe++){const mt=p[Xe];if(!mt||Math.abs(mt.length-E.length)>ae)continue;const ut=aa(E,mt);if(ut<me&&(me=ut,He=Xe,ut===0))break}if(me===1/0||me>ae)return 0;let nt=Math.round(j*(me===0?1:me===1?.65:.45));return He===0?nt+=Math.round(j*.25):He===1&&(nt+=Math.round(j*.12)),nt};let c=0;for(const o of n){if(!o)continue;const p=S(o,s,180),j=S(o,l,120),E=S(o,u,60),ae=S(o,R,30);c+=Math.max(p,j,E,ae)}if(c>0){const o=((e==null?void 0:e.name)||"").length;c+=Math.max(0,60-Math.min(60,Math.floor(o/2)))}return c},na=React.useRef(new Map);React.useEffect(()=>{na.current=new Map},[Ze]);const xa=e=>{var o,p;const a=String(Oe[e]||"").trim();if(!a)return Ze;const{contentTokens:n,cleanedQuery:s}=Gt(a);if(n.length===0)return Ze;const l=wt(a).trim(),u=na.current.get(l);if(u)return u;const R=[];for(const j of da){const E=j.haystackAll;E&&n.some(ae=>E.includes(ae))&&R.push(j)}let S=R;if(S.length<8&&n.length>0){const j=[],E=new Set(S.map(ae=>{var me,He;return String((He=(me=ae.p)==null?void 0:me.id)!=null?He:"")+":"+String(ae.originalIndex)}));for(const ae of da){const me=String((p=(o=ae.p)==null?void 0:o.id)!=null?p:"")+":"+String(ae.originalIndex);if(E.has(me))continue;const He=ae.haystackAll;He&&n.some(Ke=>Na(Ke,He))&&(j.push(ae),E.add(me))}j.length&&(S=S.concat(j))}const c=S.map(j=>({entry:j,score:ya(j,n,s)})).map(j=>{if(j.score>0)return j;const E=wa(j.entry,n);return E>0?{...j,score:E}:j}).filter(j=>j.score>0).sort((j,E)=>E.score!==j.score?E.score-j.score:j.entry.originalIndex-E.entry.originalIndex).slice(0,40).map(j=>j.entry.p);return na.current.set(l,c),c},_t=e=>{if(!e)return null;const a=String(e);return Ze.find(n=>String(n==null?void 0:n.id)===a)||null},Jt=e=>{if(e==null||e==="")return[];let a=e;if(typeof a=="string"){const n=a.trim();if(!n)return[];try{a=JSON.parse(n)}catch(s){return[]}}return Array.isArray(a)?a.map((n,s)=>{var R;if(!n||typeof n!="object")return null;const l=String((R=n.name)!=null?R:"").trim()||`Bi\u1EBFn th\u1EC3 ${s+1}`,u=(Array.isArray(n.options)?n.options:[]).map(S=>{var He,Ke,nt,Xe,mt,ut,Fe;if(!S||typeof S!="object")return null;const c=String((He=S.label)!=null?He:"").trim();if(!c)return null;const o=(mt=(Xe=(nt=(Ke=S.price)!=null?Ke:S.priceValue)!=null?nt:S.unit_price)!=null?Xe:S.unitPrice)!=null?mt:null,p=o==null||o===""?NaN:typeof o=="number"?o:typeof o=="string"?J(o):Number(o),j=Number.isFinite(p)?Math.trunc(p):null,E=(Fe=(ut=S.price_delta)!=null?ut:S.priceDelta)!=null?Fe:null,ae=Number(E),me=Number.isFinite(ae)?Math.trunc(ae):0;return{label:c,price:j,price_delta:me}}).filter(Boolean);return{name:l,options:u}}).filter(Boolean):[]},Ta=e=>{const a=_t(e);return Jt(a==null?void 0:a.variants)},ma=e=>{if(!e||typeof e!="object")return"";const a=[];for(const[n,s]of Object.entries(e)){const l=String(n||"").trim(),u=String(s||"").trim();!l||!u||a.push(`${l}: ${u}`)}return a.join(", ")},Xt=(e,a)=>{const n=J(e==null?void 0:e.price),s=Jt(e==null?void 0:e.variants);if(!s.length||!a||typeof a!="object")return n;let l=n,u=!1;for(const R of s){const S=String((R==null?void 0:R.name)||"").trim(),c=String((a==null?void 0:a[S])||"").trim();if(!S||!c)continue;const o=(Array.isArray(R.options)?R.options:[]).find(me=>String((me==null?void 0:me.label)||"").trim()===c);if(!o)continue;const p=o==null?void 0:o.price,j=p==null||p===""?NaN:Number(p);if(Number.isFinite(j)){l=Math.max(0,Math.trunc(j)),u=!0;continue}const E=o==null?void 0:o.price_delta,ae=E==null||E===""?NaN:Number(E);Number.isFinite(ae)&&(l+=Math.trunc(ae))}return l},sa=e=>window.KTM.orders.getOrderItems(e),Sa=e=>window.KTM.orders.getOrderTotalQty(e),Qt=e=>window.KTM.orders.getOrderProductSummary(e,_t),ia=e=>window.KTM.orders.getOrderItemRows(e,_t),ra=e=>window.KTM.orders.getOrderAdjustmentMoney(e),ka=e=>{const a=sa(e),n=ia(e),s=Zt(a),l=Yt(a),u=l.fee,R=ra(e),S=s+u+R,c=[];if(e!=null&&e.customer_name&&c.push(`KH\xC1CH: ${e.customer_name}`),e!=null&&e.phone&&c.push(`S\u0110T: ${e.phone}`),e!=null&&e.address&&c.push(`\u0110\u1ECAA CH\u1EC8: ${e.address}`),((e==null?void 0:e.note)||"").trim()&&c.push(`GHI CH\xDA: ${(e.note||"").trim()}`),c.push(""),c.push("S\u1EA2N PH\u1EA8M:"),n.length)for(const o of n)c.push(`- ${o.name} (SL: ${o.qty})`);else{const o=Qt(e);o&&o!=="\u2014"&&c.push(`- ${o}`)}c.push(""),c.push(`T\u1EA0M T\xCDNH: ${ue(s)}`),l.found&&u!==0&&c.push(`SHIP: ${ue(u)}`);{const o=String((e==null?void 0:e.adjustment_note)||"").trim();(R!==0||o)&&c.push(`\u0110I\u1EC0U CH\u1EC8NH: ${ue(R)}${o?` (${o})`:""}`)}return c.push(`T\u1ED4NG: ${ue(S)}`),c.filter(Boolean).join(`
`)},ua=async e=>{try{const a=ka(e);await window.KTM.clipboard.writeText(a),typeof L=="function"?L("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng","success"):alert("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng")}catch(a){console.error(a),typeof L=="function"?L("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)","danger"):alert("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)")}},Yt=e=>window.KTM.orders.getOrderShipInfo(e,_t),Zt=e=>window.KTM.orders.getItemsSubtotal(e,_t),oa=e=>{try{const a=e instanceof Date?e:new Date(e);if(!a||Number.isNaN(a.getTime()))return"";const n=a.getFullYear(),s=String(a.getMonth()+1).padStart(2,"0");return`${n}-${s}`}catch(a){return""}},la=()=>i?String(i):oa(new Date),pa=e=>{const a=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),n=ye((e==null?void 0:e.phone)||""),s=String((e==null?void 0:e.address)||"").trim().toLowerCase(),l=Ie(e==null?void 0:e.adjustment_amount),R=(Array.isArray(e==null?void 0:e.items)?e.items:[]).map(S=>{var c;return{product_id:String((S==null?void 0:S.product_id)||"").trim(),quantity:Number((c=S==null?void 0:S.quantity)!=null?c:0),variant:String((S==null?void 0:S.variant)||"").trim()}}).filter(S=>S.product_id&&Number.isFinite(S.quantity)&&S.quantity>0).sort((S,c)=>S.product_id<c.product_id?-1:S.product_id>c.product_id?1:S.variant<c.variant?-1:S.variant>c.variant?1:S.quantity-c.quantity);return JSON.stringify({name:a,phone:n,address:s,items:R,adj:l})},Dt=React.useMemo(()=>{const e=ye((r==null?void 0:r.phone)||"");if(!e)return{count:0,orders:[],monthKey:la()};const a=la(),n=(Array.isArray(Y)?Y:[]).filter(s=>{if(!s||De&&String(s.id)===String(De)||ye(s.phone||"")!==e)return!1;const l=oa(s.created_at);return l&&l===a}).sort((s,l)=>{const u=new Date(s.created_at).getTime(),R=new Date(l.created_at).getTime();return(Number.isFinite(R)?R:0)-(Number.isFinite(u)?u:0)});return{count:n.length,orders:n,monthKey:a}},[Y,r==null?void 0:r.phone,i,De]),Ca=e=>{var S;const a=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),n=ye((e==null?void 0:e.phone)||""),s=String((e==null?void 0:e.address)||"").trim().toLowerCase(),l=Ie((S=e==null?void 0:e.adjustment_amount)!=null?S:0),u=sa(e),R=(Array.isArray(u)?u:[]).map(c=>{var o;return{product_id:String((c==null?void 0:c.product_id)||"").trim(),quantity:Number((o=c==null?void 0:c.quantity)!=null?o:0),variant:String((c==null?void 0:c.variant)||"").trim()}}).filter(c=>c.product_id&&Number.isFinite(c.quantity)&&c.quantity>0).sort((c,o)=>c.product_id<o.product_id?-1:c.product_id>o.product_id?1:c.variant<o.variant?-1:c.variant>o.variant?1:c.quantity-o.quantity);return JSON.stringify({name:a,phone:n,address:s,items:R,adj:l})},ha=React.useMemo(()=>{if(De)return"";const e=ye((r==null?void 0:r.phone)||"");if(!e)return"";const a=la(),n=pa(r),s=Array.isArray(Y)?Y:[];for(const l of s){if(!l||De&&String(l.id)===String(De)||ye(l.phone||"")!==e)continue;const u=oa(l.created_at);if(!u||u!==a)continue;const R=Ca(l);if(R&&R===n)return`\u0110\u01A1n n\xE0y gi\u1ED1ng 100% m\u1ED9t \u0111\u01A1n trong th\xE1ng ${a}${l!=null&&l.id?` (#${l.id})`:""}`}return""},[Y,r,i,De]),ba=e=>{var nt;const a=[],n=[],s=String((e==null?void 0:e.customer_name)||"").trim(),l=ye((e==null?void 0:e.phone)||""),u=String((e==null?void 0:e.address)||"").trim();s||a.push("Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng"),l||a.push("Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i"),l&&!at(l)&&a.push("S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)"),u||n.push("Thi\u1EBFu \u0111\u1ECBa ch\u1EC9");const S=(Array.isArray(e==null?void 0:e.items)?e.items:[]).filter(Xe=>Xe&&Xe.product_id);S.length===0&&a.push("Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m"),S.some(Xe=>{var ut;const mt=Number((ut=Xe==null?void 0:Xe.quantity)!=null?ut:0);return!Number.isFinite(mt)||mt<=0})&&a.push("S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0");const o=new Set;let p=!1;for(const Xe of S){const mt=String(Xe.product_id||"").trim(),ut=String((Xe==null?void 0:Xe.variant)||"").trim();if(!mt)continue;const Fe=`${mt}||${ut}`;if(o.has(Fe)){p=!0;break}o.add(Fe)}p&&n.push("S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)");const j=Zt(S),E=Yt(S),ae=E!=null&&E.found?Number((nt=E==null?void 0:E.fee)!=null?nt:0):0,me=Ie(e==null?void 0:e.adjustment_amount),He=String((e==null?void 0:e.adjustment_note)||"").trim();E!=null&&E.found&&(ae>=2e5||j>0&&ae>j*.6)&&n.push(`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${ue(ae)}`),me!==0&&!He&&n.push("C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh");const Ke=Math.abs(me);return(Ke>=5e5||j>0&&Ke>j*.5)&&me!==0&&n.push(`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${ue(me)}`),{errors:a,warnings:n,canSubmit:a.length===0}},Oa=React.useMemo(()=>ba(r),[r,Ze]),lt=React.useMemo(()=>{var ut;const e=String((r==null?void 0:r.customer_name)||"").trim(),a=ye((r==null?void 0:r.phone)||""),n=String((r==null?void 0:r.address)||"").trim(),s=Array.isArray(r==null?void 0:r.items)?r.items:[],l=new Map;for(const Fe of s){const zt=String((Fe==null?void 0:Fe.product_id)||"").trim(),ea=String((Fe==null?void 0:Fe.variant)||"").trim();if(!zt)continue;const ta=`${zt}||${ea}`;l.set(ta,(l.get(ta)||0)+1)}const u=s.map(Fe=>{var va;const zt=String((Fe==null?void 0:Fe.product_id)||"").trim(),ea=Number((va=Fe==null?void 0:Fe.quantity)!=null?va:0),ta=zt?"":"Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m",_a=Number.isFinite(ea)&&ea>0?"":"S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0",Aa=String((Fe==null?void 0:Fe.variant)||"").trim(),Ma=`${zt}||${Aa}`,$a=zt&&(l.get(Ma)||0)>1?"S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)":"";return{productError:ta,qtyError:_a,dupWarn:$a}}),R=s.filter(Fe=>Fe&&Fe.product_id),S=Zt(R),c=Yt(R),o=c!=null&&c.found?Number((ut=c==null?void 0:c.fee)!=null?ut:0):0,p=Ie(r==null?void 0:r.adjustment_amount),j=String((r==null?void 0:r.adjustment_note)||"").trim(),E=Math.abs(p),ae=p!==0&&!j?"C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh":"",me=p!==0&&(E>=5e5||S>0&&E>S*.5)?`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${ue(p)}`:"",He=c!=null&&c.found&&(o>=2e5||S>0&&o>S*.6)?`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${ue(o)}`:"",Ke=e?"":"Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng",nt=a?at(a)?"":"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)":"Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",Xe=n?"":"Thi\u1EBFu \u0111\u1ECBa ch\u1EC9",mt=!Ke&&!nt&&u.every(Fe=>!Fe.productError&&!Fe.qtyError);return{nameError:Ke,phoneError:nt,addressWarn:Xe,items:u,shipAbnormalWarn:He,adjustmentNoteWarn:ae,adjustmentAbnormalWarn:me,canSubmit:mt}},[r,Ze]),fa=async e=>{var R,S,c;const a=(e==null?void 0:e.mode)||"close",n=ba(r);if(!n.canSubmit){const o=n.errors[0]||"Thi\u1EBFu d\u1EEF li\u1EC7u b\u1EAFt bu\u1ED9c";typeof L=="function"?L(o,"danger"):alert(o);return}if(!De&&ha){const o=`${ha}

B\u1EA1n c\xF3 mu\u1ED1n ti\u1EBFp t\u1EE5c l\u01B0u kh\xF4ng?`;if(!window.confirm(o)){(Dt==null?void 0:Dt.count)>0&&g(!0),setTimeout(()=>{var E;const j=document.getElementById("order-phone-input");j&&typeof j.scrollIntoView=="function"&&(j.scrollIntoView({block:"center",behavior:"smooth"}),(E=j.focus)==null||E.call(j))},0);return}}const s=ye(r.phone),u=(Array.isArray(r.items)?r.items:[]).map(o=>{var p,j;return{product_id:(o==null?void 0:o.product_id)||"",quantity:Number((p=o==null?void 0:o.quantity)!=null?p:1),variant:String((o==null?void 0:o.variant)||"").trim()||null,variant_json:(j=o==null?void 0:o.variant_json)!=null?j:null,unit_price:(()=>{const E=o==null?void 0:o.unit_price,ae=E===""||E==null?NaN:Number(E);if(Number.isFinite(ae))return Math.max(0,Math.trunc(ae));const me=_t(o==null?void 0:o.product_id),He=o!=null&&o.variant_json&&typeof o.variant_json=="object"?o.variant_json:null;return Xt(me,He)})()}}).filter(o=>o.product_id&&Number.isFinite(o.quantity)&&o.quantity>0);$e(!0);try{const o=De?`${API_BASE}/api/orders/${De}`:`${API_BASE}/api/orders`,p=u[0],j={customer_name:r.customer_name,phone:s,address:r.address,note:(r.note||"").trim(),adjustment_amount:Ie(r.adjustment_amount),adjustment_note:(r.adjustment_note||"").trim(),product_id:p.product_id,quantity:p.quantity,status:r.status,items:u,...De?{id:De}:{}};if(De)await window.KTM.api.putJSON(o,j,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");else{const E=await window.KTM.api.postJSON(o,j,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");Ue.current={id:(c=(S=E==null?void 0:E.id)!=null?S:(R=E==null?void 0:E.order)==null?void 0:R.id)!=null?c:null,fingerprint:pa(r),ts:Date.now()}}qt(s,r.customer_name,r.address),a==="new"&&!De?(k(""),xt(null),H(!0)):(k(""),xt(null),H(!1)),ot()}catch(o){console.error(o),typeof L=="function"?L(o.message,"danger"):alert(o.message);return}finally{$e(!1)}},ca=e=>window.KTM.orders.getOrderTotalMoney(e,_t),ga=async e=>{if(confirm("X\xF3a \u0111\u01A1n h\xE0ng n\xE0y?")){_e(e);try{await window.KTM.api.deleteJSON(`${API_BASE}/api/orders/${e}`,"L\u1ED7i x\xF3a \u0111\u01A1n h\xE0ng"),ot(),yt()}catch(a){console.error(a),typeof L=="function"?L(a.message,"danger"):alert(a.message)}finally{_e(null)}}},Kt=async(e,a)=>{var s;const n=e==null?void 0:e.id;if(!(!n||!a)){ze(n);try{const l=sa(e),u=(Array.isArray(l)?l:[]).map(c=>{var o,p;return{product_id:(c==null?void 0:c.product_id)||"",quantity:Number((o=c==null?void 0:c.quantity)!=null?o:1),variant:String((c==null?void 0:c.variant)||"").trim()||null,variant_json:(p=c==null?void 0:c.variant_json)!=null?p:null,unit_price:(()=>{var ae;const j=(ae=c==null?void 0:c.unit_price)!=null?ae:c==null?void 0:c.unitPrice,E=Number(j);return Number.isFinite(E)?Math.max(0,Math.trunc(E)):null})()}}).filter(c=>c.product_id&&Number.isFinite(c.quantity)&&c.quantity>0);if(!u.length)throw new Error("Kh\xF4ng th\u1EC3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i: \u0111\u01A1n kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m h\u1EE3p l\u1EC7");const R=u[0],S={id:n,customer_name:(e==null?void 0:e.customer_name)||"",phone:ye((e==null?void 0:e.phone)||""),address:(e==null?void 0:e.address)||"",note:((e==null?void 0:e.note)||"").trim(),adjustment_amount:Number((s=e==null?void 0:e.adjustment_amount)!=null?s:0)||0,adjustment_note:(e==null?void 0:e.adjustment_note)||"",product_id:R.product_id,quantity:R.quantity,status:a,items:u};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${n}`,S,"L\u1ED7i c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i"),X(c=>Array.isArray(c)?c.map(o=>(o==null?void 0:o.id)===n?{...o,status:a}:o):c),K(c=>Array.isArray(c)?c.map(o=>(o==null?void 0:o.id)===n?{...o,status:a}:o):c),typeof L=="function"&&L("\u0110\xE3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i","success")}catch(l){console.error(l),typeof L=="function"?L(l.message,"danger"):alert(l.message)}finally{ze(null)}}};return React.createElement("div",{className:"product-manager"},React.createElement(Loading,{show:se&&!q&&!N||ie||!!Te||!!ke}),React.createElement("div",{className:"product-header"},React.createElement("h5",null,"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"),React.createElement("button",{className:"btn btn-dark btn-sm",onClick:kt,disabled:ie||!!Te},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o \u0111\u01A1n")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-4"},React.createElement("label",{className:"form-label mb-1"},"L\u1ECDc theo th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:i,onChange:e=>b(e.target.value),"aria-label":"Ch\u1ECDn th\xE1ng",disabled:F||N}),i&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{b("")},title:"B\u1ECF l\u1ECDc","aria-label":"B\u1ECF l\u1ECDc",disabled:se||N},React.createElement("i",{className:"fas fa-times"})))),React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-filter"})),React.createElement("select",{className:"form-select",value:_,onChange:e=>T(e.target.value),"aria-label":"L\u1ECDc theo tr\u1EA1ng th\xE1i",disabled:F||N},React.createElement("option",{value:""},"T\u1EA5t c\u1EA3"),React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n")),_&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>T(""),title:"B\u1ECF l\u1ECDc tr\u1EA1ng th\xE1i","aria-label":"B\u1ECF l\u1ECDc tr\u1EA1ng th\xE1i",disabled:se||N},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"form-check mt-2"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"orders-overdue-only",checked:F,onChange:e=>{if(N)return;const a=!!e.target.checked;Q(a),a&&T("pending")},disabled:N}),React.createElement("label",{className:"form-check-label",htmlFor:"orders-overdue-only"},"Ch\u1EC9 hi\u1EC7n \u0111\u01A1n ch\u1EADm > ",ft," ng\xE0y (Ch\u1EDD x\u1EED l\xFD)"))),React.createElement("div",{className:"col-12 col-md-3"},React.createElement("label",{className:"form-label mb-1"},"Search (t\xEAn / S\u0110T)"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-search"})),React.createElement("input",{type:"text",className:"form-control",value:Ae,onChange:e=>le(e.target.value),placeholder:"Nh\u1EADp t\xEAn ho\u1EB7c S\u0110T...","aria-label":"Search \u0111\u01A1n h\xE0ng theo t\xEAn ho\u1EB7c S\u0110T"}),String(Ae||"").trim()&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>le(""),title:"X\xF3a search","aria-label":"X\xF3a search",disabled:Me},React.createElement("i",{className:"fas fa-times"})),Me&&React.createElement("span",{className:"input-group-text",title:"\u0110ang search...","aria-label":"\u0110ang search"},React.createElement("span",{className:"spinner-border spinner-border-sm text-warning",role:"status","aria-hidden":"true"}))),React.createElement("div",{className:"text-muted small mt-1"},"Search s\u1EBD ra to\xE0n b\u1ED9 data, b\u1ECF qua filter")),React.createElement("div",{className:"col-12 col-md-2 d-flex gap-2 justify-content-md-end"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>N?bt(Ae):ot(),disabled:se||Me},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")))),React.createElement("div",{className:"card p-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},"Danh s\xE1ch \u0111\u01A1n h\xE0ng"),React.createElement("span",{className:"text-muted small"},N?`${tt.length} k\u1EBFt qu\u1EA3`:_?`${Pe.length}/${Y.length} \u0111\u01A1n`:`${Y.length} \u0111\u01A1n`)),N&&je&&React.createElement("div",{className:"alert alert-danger mt-3 mb-0",role:"alert"},je),U.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"C\xF3 ",React.createElement("strong",null,U.length)," \u0111\u01A1n ",React.createElement("strong",null,"Ch\u1EDD x\u1EED l\xFD")," qu\xE1 ",ft," ng\xE0y.",W&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{Q(!0),T("pending")}},"Xem ngay")),Se.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-clock me-2"}),"C\xF3 ",React.createElement("strong",null,Se.length)," \u0111\u01A1n ",React.createElement("strong",null,"Nh\xE1p")," s\u1EAFp t\u1EF1 x\xF3a (c\xF2n \u2264 ",$t," ng\xE0y).",ce&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{Q(!1),T("draft"),b(""),ot()}},"Xem ngay")),(N?Me:se)?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):(N?tt.length===0:Y.length===0)?React.createElement("div",{className:"text-center py-4 text-muted"},N?"Kh\xF4ng c\xF3 k\u1EBFt qu\u1EA3":"Ch\u01B0a c\xF3 \u0111\u01A1n h\xE0ng"):!N&&Pe.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},"Kh\xF4ng c\xF3 \u0111\u01A1n ph\xF9 h\u1EE3p"):React.createElement(React.Fragment,null,React.createElement("div",{className:"d-md-none mt-3"},tt.map(e=>{var a;return React.createElement("div",{key:e.id,className:"card mb-2"},React.createElement("div",{className:"card-body p-3"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"flex-grow-1",style:{minWidth:0}},React.createElement("div",{className:"fw-semibold text-truncate"},e.customer_name),React.createElement("div",{className:"fw-bold font-monospace"},e.phone),Number((a=e==null?void 0:e.split_seq)!=null?a:0)>0&&React.createElement("div",{className:"text-muted small"},"\u0110\u1EE3t ",e.split_seq),e.address&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},e.address),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("div",{className:"d-flex align-items-start gap-1 flex-shrink-0"},React.createElement("span",{className:`badge ${P(e.status)}`},C(e.status)),m(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${ft} ng\xE0y`},"\u26A0 Ch\u1EADm ",$(e),"d"),te(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 x\xF3a sau ${Ct} ng\xE0y`},"\u23F3 C\xF2n ",ne(e),"d"))),React.createElement("div",{className:"mt-2 small"},React.createElement("div",null,React.createElement("div",{className:"text-muted"},"S\u1EA3n ph\u1EA9m:"),(()=>{const n=ia(e);return n.length?React.createElement("div",{className:"mt-1"},n.map((s,l)=>React.createElement("div",{key:l,className:"d-flex justify-content-between gap-2",style:{lineHeight:1.25}},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,whiteSpace:"normal",wordBreak:"break-word",flex:1}},React.createElement("span",{className:"text-muted me-1"},l+1,"."),s.name),React.createElement("div",{className:"text-muted small text-end text-nowrap",style:{flexShrink:0}},"x",s.qty,Number(s.unitPrice)>0?` \u2022 ${ue(s.unitPrice)}`:"")))):React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},Qt(e))})()),(ra(e)!==0||((e==null?void 0:e.adjustment_note)||"").trim())&&React.createElement("div",{style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh:")," ",React.createElement("span",{className:"fw-semibold"},ue(ra(e))),((e==null?void 0:e.adjustment_note)||"").trim()?React.createElement("span",{className:"text-muted"}," ","(",(e.adjustment_note||"").trim(),")"):null),React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng ti\u1EC1n"),React.createElement("span",{className:"fw-bold"},ue(ca(e)))),React.createElement("div",{className:"text-muted"},React.createElement("span",null,"Th\u1EDDi gian:")," ",ct(e.created_at))),React.createElement("div",{className:"mt-3 d-flex gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary flex-fill",onClick:()=>Nt(e),disabled:ie||!!Te||ke===e.id},"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary flex-fill",onClick:()=>ua(e),disabled:ie||!!Te||ke===e.id},React.createElement("i",{className:"fas fa-copy me-1"}),"Copy"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger flex-fill",onClick:()=>ga(e.id),disabled:ie||Te===e.id||ke===e.id},Te===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a")),React.createElement("div",{className:"mt-2 d-flex gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning flex-fill",onClick:()=>Kt(e,"processing"),disabled:ie||!!Te||ke===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success flex-fill",onClick:()=>Kt(e,"done"),disabled:ie||!!Te||ke===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary flex-fill",onClick:()=>Kt(e,"paid"),disabled:ie||!!Te||ke===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger flex-fill",onClick:()=>Kt(e,"canceled"),disabled:ie||!!Te||ke===e.id||e.status==="canceled",title:"H\u1EE7y \u0111\u01A1n"},"H\u1EE7y"))))})),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive orders-table-wrap mt-3"},React.createElement("table",{className:"table orders-table table-hover align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"SL"),React.createElement("th",null,"T\u1ED5ng ti\u1EC1n"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"),React.createElement("th",null,"Th\u1EDDi gian"),React.createElement("th",null))),React.createElement("tbody",null,tt.map(e=>React.createElement("tr",{key:e.id},React.createElement("td",null,React.createElement("div",{className:"fw-semibold"},e.customer_name),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("td",null,e.phone),React.createElement("td",null,(()=>{const a=ia(e);return a.length?React.createElement("div",{className:"d-grid gap-1"},a.map((n,s)=>React.createElement("div",{key:s,className:"small",style:{whiteSpace:"normal",wordBreak:"break-word",lineHeight:1.2}},React.createElement("span",{className:"text-muted me-1"},s+1,"."),React.createElement("span",{className:"fw-semibold"},n.name)," ",React.createElement("span",{className:"text-muted"},"x",n.qty),Number(n.unitPrice)>0&&React.createElement("span",{className:"text-muted"}," ","\u2022 ",ue(n.unitPrice))))):Qt(e)})()),React.createElement("td",null,Sa(e)),React.createElement("td",{className:"fw-semibold"},ue(ca(e))),React.createElement("td",null,React.createElement("div",{className:"d-flex align-items-center gap-1 flex-wrap"},React.createElement("span",{className:`badge ${P(e.status)}`},C(e.status)),m(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${ft} ng\xE0y`},"\u26A0 Ch\u1EADm ",$(e),"d"),te(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 x\xF3a sau ${Ct} ng\xE0y`},"\u23F3 C\xF2n ",ne(e),"d"))),React.createElement("td",null,ct(e.created_at)),React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-sm btn-primary me-1",onClick:()=>Nt(e),disabled:ie||!!Te||ke===e.id},"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary me-1",onClick:()=>ua(e),disabled:ie||!!Te||ke===e.id},React.createElement("i",{className:"fas fa-copy"})),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning me-1",onClick:()=>Kt(e,"processing"),disabled:ie||!!Te||ke===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success me-1",onClick:()=>Kt(e,"done"),disabled:ie||!!Te||ke===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary me-1",onClick:()=>Kt(e,"paid"),disabled:ie||!!Te||ke===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger me-1",onClick:()=>Kt(e,"canceled"),disabled:ie||!!Te||ke===e.id||e.status==="canceled",title:"H\u1EE7y \u0111\u01A1n"},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>ga(e.id),disabled:ie||Te===e.id},Te===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a")))))))))),q&&React.createElement("div",{className:"modal show d-block order-modal",style:{background:"rgba(0,0,0,0.6)"},role:"dialog","aria-modal":"true"},React.createElement("div",{className:"modal-dialog modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ffca2c)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark mb-0"},React.createElement("i",{className:"fas fa-receipt me-2"}),De?"S\u1EEDa \u0111\u01A1n h\xE0ng":"T\u1EA1o \u0111\u01A1n h\xE0ng"),React.createElement("button",{type:"button",className:"btn-close",onClick:Ot})),React.createElement("form",{onSubmit:e=>{e.preventDefault(),fa({mode:"close"})}},React.createElement("div",{className:"modal-body",ref:M},React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"T\xEAn kh\xE1ch h\xE0ng *"),React.createElement("input",{className:"form-control",value:r.customer_name,onChange:e=>z({...r,customer_name:e.target.value}),placeholder:"Nh\u1EADp t\xEAn kh\xE1ch h\xE0ng",required:!0,style:{borderRadius:10,padding:12}}),!!lt.nameError&&React.createElement("div",{className:"form-text text-danger"},lt.nameError)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i *"),React.createElement("input",{className:"form-control",type:"tel",inputMode:"numeric",pattern:"[0-9+\\s-]*",id:"order-phone-input",value:r.phone,onChange:e=>Bt(e.target.value),onBlur:Vt,placeholder:"Nh\u1EADp s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",required:!0,style:{borderRadius:10,padding:12}}),!!lt.phoneError&&React.createElement("div",{className:"form-text text-danger"},lt.phoneError),!lt.phoneError&&Dt.count>0&&React.createElement("div",{className:"form-text text-warning d-flex align-items-center justify-content-between gap-2"},React.createElement("span",null,"Kh\xE1ch n\xE0y \u0111\xE3 c\xF3 ",Dt.count," \u0111\u01A1n trong th\xE1ng ",Dt.monthKey,"."),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>g(e=>!e)},d?"\u1EA8n l\u1ECBch s\u1EED":"Xem l\u1ECBch s\u1EED")),d&&Dt.orders.length>0&&React.createElement("div",{className:"mt-2 border rounded-3 p-2",style:{background:"#fff"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between gap-2 mb-2"},React.createElement("div",{className:"small fw-semibold"},"L\u1ECBch s\u1EED \u0111\u01A1n (c\xF9ng th\xE1ng)"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>g(!1)},"\u1EA8n")),React.createElement("div",{className:"d-grid gap-2"},Dt.orders.slice(0,5).map(e=>React.createElement("div",{key:e.id,className:"d-flex align-items-start justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"small fw-semibold",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},"#",e.id," \u2022 ",React.createElement("span",{className:`badge ${P(e.status)}`},C(e.status))),React.createElement("div",{className:"text-muted small"},ct(e.created_at)," \u2022 ",ue(ca(e))),React.createElement("div",{className:"text-muted small",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},Qt(e))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{confirm(`M\u1EDF \u0111\u01A1n #${e.id}? D\u1EEF li\u1EC7u \u0111ang nh\u1EADp s\u1EBD m\u1EA5t.`)&&Nt(e)}},"M\u1EDF")))),Dt.orders.length>5&&React.createElement("div",{className:"text-muted small mt-2"},"Ch\u1EC9 hi\u1EC3n th\u1ECB 5 \u0111\u01A1n g\u1EA7n nh\u1EA5t.")),(de==null?void 0:de.status)==="loading"&&React.createElement("div",{className:"form-text"},"\u0110ang t\xECm kh\xE1ch theo S\u0110T..."),(de==null?void 0:de.status)==="found"&&React.createElement("div",{className:"form-text text-success"},"\u0110\xE3 c\xF3 kh\xE1ch, t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n th\xF4ng tin."),(de==null?void 0:de.status)==="not-found"&&React.createElement("div",{className:"form-text text-muted"},"Ch\u01B0a c\xF3 kh\xE1ch, s\u1EBD t\u1EA1o m\u1EDBi khi l\u01B0u \u0111\u01A1n."),(de==null?void 0:de.status)==="error"&&React.createElement("div",{className:"form-text text-danger"},"Kh\xF4ng tra \u0111\u01B0\u1EE3c kh\xE1ch (l\u1ED7i m\u1EA1ng/server).")),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("select",{className:"form-select",value:r.status,onChange:e=>z({...r,status:e.target.value}),style:{borderRadius:10,padding:12}},React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n"))),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("input",{className:"form-control",value:r.address,onChange:e=>z({...r,address:e.target.value}),placeholder:"Nh\u1EADp \u0111\u1ECBa ch\u1EC9 (kh\xF4ng b\u1EAFt bu\u1ED9c)",style:{borderRadius:10,padding:12}}),!!lt.addressWarn&&React.createElement("div",{className:"form-text text-warning"},lt.addressWarn)),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111\u01A1n h\xE0ng"),React.createElement("textarea",{className:"form-control",value:r.note,onChange:e=>z({...r,note:e.target.value}),placeholder:"V\xED d\u1EE5: Giao gi\u1EDD h\xE0nh ch\xEDnh / G\u1ECDi tr\u01B0\u1EDBc khi giao...",rows:2,style:{borderRadius:10,padding:12,resize:"vertical"}})),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110i\u1EC1u ch\u1EC9nh gi\xE1 (th\xEAm/b\u1EDBt)"),React.createElement("input",{type:"number",className:"form-control",value:r.adjustment_amount,onChange:e=>z({...r,adjustment_amount:e.target.value}),placeholder:"-20000 ho\u1EB7c 20000",step:"1000",style:{borderRadius:10,padding:12}}),React.createElement("div",{className:"form-text"},"\xC2m = gi\u1EA3m gi\xE1, d\u01B0\u01A1ng = c\u1ED9ng th\xEAm."),!!lt.adjustmentAbnormalWarn&&React.createElement("div",{className:"form-text text-warning"},lt.adjustmentAbnormalWarn)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh"),React.createElement("input",{className:"form-control",value:r.adjustment_note,onChange:e=>z({...r,adjustment_note:e.target.value}),placeholder:"V\xED d\u1EE5: Gi\u1EA3m gi\xE1 cho kh\xE1ch / B\xF9 ph\xED \u0111\xF3ng g\xF3i...",style:{borderRadius:10,padding:12}}),!!lt.adjustmentNoteWarn&&React.createElement("div",{className:"form-text text-warning"},lt.adjustmentNoteWarn)),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1EA3n ph\u1EA9m *"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{z(e=>({...e,items:[...Array.isArray(e.items)?e.items:[],{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]})),Je(e=>[...Array.isArray(e)?e:[],""]),De&&x(e=>[...Array.isArray(e)?e:[],!0])},disabled:ie},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(r.items)?r.items:[{product_id:"",quantity:1}]).map((e,a)=>React.createElement("div",{key:a,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"dropdown w-100",ref:n=>{Qe.current[a]=n}},React.createElement("button",{type:"button",className:"form-control text-start d-flex align-items-center justify-content-between",style:{borderRadius:10,padding:12},onClick:()=>{Le(n=>n===a?null:a),setTimeout(()=>{const n=document.getElementById(`order-product-search-${a}`);n&&n.focus()},0)}},React.createElement("span",{className:e.product_id?"":"text-muted",style:{minWidth:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},Ut(e.product_id)),React.createElement("i",{className:"fas fa-chevron-down text-muted",style:{marginLeft:8,flexShrink:0}})),qe===a&&React.createElement("div",{className:"dropdown-menu show w-100 p-2",style:{maxHeight:320,overflowY:"auto"}},React.createElement("input",{id:`order-product-search-${a}`,className:"form-control",value:Oe[a]||"",onChange:n=>{const s=n.target.value;Je(l=>{const u=Array.isArray(l)?[...l]:[];return u[a]=s,u})},placeholder:"T\xECm theo t\xEAn / m\xE3...",style:{borderRadius:10,padding:10}}),React.createElement("div",{className:"mt-2"}),(()=>{const n=xa(a);return n.length===0?React.createElement("div",{className:"text-muted small px-2 py-1"},"Kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p"):n.map(s=>React.createElement("button",{key:s.id,type:"button",className:"dropdown-item",onClick:()=>{const l=String(s.id),u=Jt(s==null?void 0:s.variants),R={};for(const o of u){const p=String((o==null?void 0:o.name)||"").trim(),j=Array.isArray(o==null?void 0:o.options)?o.options[0]:null,E=String((j==null?void 0:j.label)||"").trim();p&&E&&(R[p]=E)}const S=ma(R),c=Xt(s,R);z(o=>{const p=Array.isArray(o.items)?[...o.items]:[];return p[a]={...p[a]||{quantity:1},product_id:l,variant_json:Object.keys(R).length?R:null,variant:S,unit_price:u.length?c:null},{...o,items:p}}),Le(null)}},s.name,s.code?` (${s.code})`:""))})()),React.createElement("select",{className:"form-select",value:e.product_id,onChange:()=>{},required:!0,style:{position:"absolute",opacity:0,height:0,pointerEvents:"none"},tabIndex:-1,"aria-hidden":"true"},React.createElement("option",{value:""},"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"),Ze.map(n=>React.createElement("option",{key:n.id,value:n.id},n.name)))),(()=>{var s;const n=(s=lt.items)==null?void 0:s[a];return n?React.createElement(React.Fragment,null,!!n.productError&&React.createElement("div",{className:"form-text text-danger"},n.productError),!!n.dupWarn&&React.createElement("div",{className:"form-text text-warning"},n.dupWarn)):null})(),(()=>{if(!(e!=null&&e.product_id))return null;const n=_t(e.product_id),s=Jt(n==null?void 0:n.variants);if(!s.length)return null;const l=e!=null&&e.variant_json&&typeof e.variant_json=="object"?e.variant_json:{};return React.createElement("div",{className:"mt-2 d-grid gap-2"},s.map((u,R)=>{const S=String((u==null?void 0:u.name)||`Bi\u1EBFn th\u1EC3 ${R+1}`).trim(),c=String((l==null?void 0:l[S])||"").trim();return React.createElement("div",{key:S},React.createElement("label",{className:"form-label small text-muted mb-1"},S),React.createElement("select",{className:"form-select",value:c,onChange:o=>{const p=String(o.target.value||"").trim();z(j=>{const E=Array.isArray(j.items)?[...j.items]:[],ae={...E[a]||{}},me=_t(ae.product_id),He=Jt(me==null?void 0:me.variants),Ke=ae!=null&&ae.variant_json&&typeof ae.variant_json=="object"?{...ae.variant_json}:{};p?Ke[S]=p:delete Ke[S];const nt=ma(Ke),Xe=Xt(me,Ke);return E[a]={...ae,variant_json:Object.keys(Ke).length?Ke:null,variant:nt,unit_price:Xe},{...j,items:E}})},style:{borderRadius:10,padding:12}},React.createElement("option",{value:""},"-- ch\u1ECDn ",S," --"),(Array.isArray(u==null?void 0:u.options)?u.options:[]).map(o=>React.createElement("option",{key:o.label,value:o.label},o.label,Number.isFinite(Number(o==null?void 0:o.price))?` (${ue(Number(o.price))})`:Number(o==null?void 0:o.price_delta)?` (${o.price_delta>0?"+":""}${o.price_delta})`:""))))}))})(),De&&React.createElement("div",{className:"form-check mt-1"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:`order-split-deliver-${a}`,checked:!!ve[a],onChange:n=>{const s=!!n.target.checked;x(l=>{const u=Array.isArray(l)?[...l]:[],R=Array.isArray(r.items)?r.items.length:0;for(;u.length<R;)u.push(!0);return u[a]=s,u})},disabled:ie||h}),React.createElement("label",{className:"form-check-label small text-muted",htmlFor:`order-split-deliver-${a}`},"Giao \u0111\u1EE3t 1"))),React.createElement("div",{className:"col-8 col-md-3"},React.createElement("input",{type:"number",className:"form-control",value:e.quantity,onChange:n=>{const s=n.target.value;z(l=>{const u=Array.isArray(l.items)?[...l.items]:[];return u[a]={...u[a]||{product_id:""},quantity:s},{...l,items:u}})},min:"1",style:{borderRadius:10,padding:12}}),(()=>{var s;const n=(s=lt.items)==null?void 0:s[a];return n&&n.qtyError?React.createElement("div",{className:"form-text text-danger"},n.qtyError):null})()),React.createElement("div",{className:"col-4 col-md-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>{z(n=>{const s=Array.isArray(n.items)?[...n.items]:[];return s.splice(a,1),{...n,items:s.length?s:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]}}),Je(n=>{const s=Array.isArray(n)?[...n]:[];return s.splice(a,1),s.length?s:[""]}),x(n=>{const s=Array.isArray(n)?[...n]:[];return s.splice(a,1),s}),Le(n=>n==null?n:n===a?null:n>a?n-1:n)},disabled:ie||h||(Array.isArray(r.items)?r.items.length:1)<=1,title:"X\xF3a s\u1EA3n ph\u1EA9m",style:{borderRadius:10,padding:10}},React.createElement("i",{className:"fas fa-trash"}))))))),(()=>{const a=(Array.isArray(r.items)?r.items:[]).filter(R=>R==null?void 0:R.product_id),n=Zt(a),s=Yt(a),l=Ie(r.adjustment_amount),u=n+(s.found?s.fee:0)+l;return React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-column gap-1 small bg-light rounded-3 p-3"},React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1EA1m t\xEDnh"),React.createElement("span",{className:"fw-semibold"},ue(n))),s.found&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"Ship"),React.createElement("span",{className:"fw-semibold"},ue(s.fee))),!!lt.shipAbnormalWarn&&React.createElement("div",{className:"text-warning"},lt.shipAbnormalWarn),l!==0&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh"),React.createElement("span",{className:"fw-semibold"},ue(l))),(r.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111\u01A1n: ",(r.note||"").trim()),(r.adjustment_note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh: ",(r.adjustment_note||"").trim()),React.createElement("div",{className:"d-flex justify-content-between pt-1 border-top"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng"),React.createElement("span",{className:"fw-bold"},ue(u)))))})())),React.createElement("div",{className:"modal-footer",style:{border:"none"}},React.createElement("button",{type:"button",className:"btn btn-light",onClick:Ot,disabled:ie||h,style:{borderRadius:10}},"H\u1EE7y"),!!De&&React.createElement("button",{type:"button",className:"btn btn-outline-primary fw-semibold",onClick:Ht,disabled:ie||h,style:{borderRadius:10},title:"Ch\u1ECDn s\u1EA3n ph\u1EA9m giao \u0111\u1EE3t 1 v\xE0 t\xE1ch ph\u1EA7n c\xF2n l\u1EA1i sang \u0111\u01A1n ch\u1EDD h\xE0ng"},h?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang t\xE1ch..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-random me-2"}),"T\xE1ch \u0111\u01A1n giao ngay")),!De&&React.createElement("button",{type:"button",className:"btn btn-outline-warning fw-semibold",onClick:()=>fa({mode:"new"}),disabled:ie||!lt.canSubmit,style:{borderRadius:10},title:"L\u01B0u xong gi\u1EEF form \u0111\u1EC3 t\u1EA1o \u0111\u01A1n m\u1EDBi"},React.createElement("i",{className:"fas fa-plus me-2"}),"L\u01B0u & t\u1EA1o \u0111\u01A1n m\u1EDBi"),React.createElement("button",{type:"submit",className:"btn btn-warning fw-semibold",disabled:ie||h||!lt.canSubmit,style:{borderRadius:10,boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},ie?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u"))))))))}

