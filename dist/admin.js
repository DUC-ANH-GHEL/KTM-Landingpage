const{useState,useEffect,useRef}=React,CLOUDINARY_CLOUD_NAME="diwxfpt92",CLOUDINARY_UPLOAD_PRESET="ktm_unsigned",API_BASE="";function LoginPage({onLogin:N,error:f}){const[C,z]=useState(""),[U,v]=useState(""),[D,Z]=useState(!1),[re,V]=useState(!1);return React.createElement("div",{className:"login-page"},React.createElement("div",{className:"login-box"},React.createElement("div",{className:"text-center mb-4"},React.createElement("i",{className:"fas fa-tractor fa-3x text-warning mb-3"}),React.createElement("h4",{className:"text-dark"},"KTM Admin"),React.createElement("p",{className:"text-muted small"},"\u0110\u0103ng nh\u1EADp \u0111\u1EC3 qu\u1EA3n l\xFD")),f&&React.createElement("div",{className:"alert alert-danger py-2 small"},React.createElement("i",{className:"fas fa-exclamation-circle me-2"}),f),React.createElement("form",{onSubmit:async Se=>{Se.preventDefault(),Z(!0),await N(C,U),Z(!1)}},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small"},"T\xEAn \u0111\u0103ng nh\u1EADp"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-user"})),React.createElement("input",{type:"text",className:"form-control",value:C,onChange:Se=>z(Se.target.value),placeholder:"admin",required:!0,autoFocus:!0}))),React.createElement("div",{className:"mb-4"},React.createElement("label",{className:"form-label small"},"M\u1EADt kh\u1EA9u"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text"},React.createElement("i",{className:"fas fa-lock"})),React.createElement("input",{type:re?"text":"password",className:"form-control",value:U,onChange:Se=>v(Se.target.value),placeholder:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",required:!0}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>V(!re)},React.createElement("i",{className:`fas fa-eye${re?"-slash":""}`})))),React.createElement("button",{type:"submit",className:"btn btn-warning w-100",disabled:D},D?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang \u0111\u0103ng nh\u1EADp..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-sign-in-alt me-2"}),"\u0110\u0103ng nh\u1EADp"))),React.createElement("div",{className:"text-center mt-4"},React.createElement("a",{href:"/",className:"text-muted small text-decoration-none"},React.createElement("i",{className:"fas fa-arrow-left me-1"}),"V\u1EC1 trang ch\u1EE7"))))}function Toast({message:N,type:f,onClose:C}){return useEffect(()=>{const z=setTimeout(C,3e3);return()=>clearTimeout(z)},[]),React.createElement("div",{className:`toast show align-items-center text-white bg-${f} border-0`,role:"alert"},React.createElement("div",{className:"d-flex"},React.createElement("div",{className:"toast-body"},N),React.createElement("button",{type:"button",className:"btn-close btn-close-white me-2 m-auto",onClick:C})))}function Loading({show:N}){return N?React.createElement("div",{className:"loading-overlay"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"3rem",height:"3rem"}},React.createElement("span",{className:"visually-hidden"},"\u0110ang t\u1EA3i..."))):null}function Sidebar({activeMenu:N,onMenuChange:f,onLogout:C,currentUser:z}){return React.createElement("div",{className:"sidebar d-none d-md-block"},React.createElement("div",{className:"logo"},React.createElement("i",{className:"fas fa-tractor me-2"})," KTM Admin"),React.createElement("nav",{className:"nav flex-column mt-3"},[{id:"search",icon:"fa-search",label:"Tra c\u1EE9u nhanh",highlight:!0},{id:"albums",icon:"fa-images",label:"Qu\u1EA3n l\xFD Album"},{id:"videos",icon:"fa-video",label:"Qu\u1EA3n l\xFD Video"},{id:"products",icon:"fa-box",label:"S\u1EA3n ph\u1EA9m"},{id:"orders",icon:"fa-receipt",label:"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"},{id:"stats",icon:"fa-chart-column",label:"Th\u1ED1ng k\xEA"},{id:"settings",icon:"fa-cog",label:"C\xE0i \u0111\u1EB7t"}].map(v=>React.createElement("a",{key:v.id,href:"#",className:`nav-link ${N===v.id?"active":""} ${v.disabled?"opacity-50":""} ${v.highlight?"text-warning":""}`,onClick:D=>{D.preventDefault(),v.disabled||f(v.id)}},React.createElement("i",{className:`fas ${v.icon}`})," ",v.label,v.disabled&&React.createElement("span",{className:"badge bg-secondary ms-2"},"Soon"),v.highlight&&React.createElement("span",{className:"badge bg-warning text-dark ms-2"},"HOT")))),React.createElement("div",{className:"position-absolute bottom-0 w-100 p-3 border-top border-secondary"},React.createElement("div",{className:"d-flex justify-content-between align-items-center"},React.createElement("a",{href:"/",className:"text-white-50 text-decoration-none small"},React.createElement("i",{className:"fas fa-home me-1"})," Trang ch\u1EE7"),C&&React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:C,title:"\u0110\u0103ng xu\u1EA5t"},React.createElement("i",{className:"fas fa-sign-out-alt"})))))}const ADMIN_SETTINGS_STORAGE_KEY="ktm_admin_settings_v1",DEFAULT_SHIP_PERCENT=1.64;function normalizeShipPercent(N){const f=typeof N=="number"?N:parseFloat(String(N!=null?N:"").trim());return Number.isFinite(f)?Math.max(0,Math.min(100,f)):DEFAULT_SHIP_PERCENT}function loadAdminSettings(){var N;try{const f=localStorage.getItem(ADMIN_SETTINGS_STORAGE_KEY);if(!f)return{ship_percent:DEFAULT_SHIP_PERCENT};const C=JSON.parse(f);return{ship_percent:normalizeShipPercent((N=C==null?void 0:C.ship_percent)!=null?N:C==null?void 0:C.shipPercent)}}catch(f){return{ship_percent:DEFAULT_SHIP_PERCENT}}}function saveAdminSettings(N){var f;try{const C={ship_percent:normalizeShipPercent((f=N==null?void 0:N.ship_percent)!=null?f:N==null?void 0:N.shipPercent)};return localStorage.setItem(ADMIN_SETTINGS_STORAGE_KEY,JSON.stringify(C)),C}catch(C){return{ship_percent:DEFAULT_SHIP_PERCENT}}}async function fetchAdminSettingsFromServer(){var f;const N=await window.KTM.api.getJSON(`${API_BASE}/api/settings`,"Kh\xF4ng t\u1EA3i \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t t\u1EEB DB");return{ship_percent:normalizeShipPercent((f=N==null?void 0:N.ship_percent)!=null?f:N==null?void 0:N.shipPercent)}}async function saveAdminSettingsToServer(N){var z,U,v;const f={ship_percent:normalizeShipPercent((z=N==null?void 0:N.ship_percent)!=null?z:N==null?void 0:N.shipPercent)},C=await window.KTM.api.putJSON(`${API_BASE}/api/settings`,f,"Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c c\xE0i \u0111\u1EB7t v\xE0o DB");return{ship_percent:normalizeShipPercent((v=(U=C==null?void 0:C.ship_percent)!=null?U:C==null?void 0:C.shipPercent)!=null?v:f.ship_percent)}}function AlbumList({albums:N,onSelect:f,onCreate:C,onEdit:z,onDelete:U,loading:v,currentFolder:D,onBack:Z,breadcrumb:re}){return React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},D&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:Z},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),D?D.title:"Th\u01B0 vi\u1EC7n \u1EA3nh")),React.createElement("button",{className:"btn btn-warning",onClick:C},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder")),re&&re.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:V=>{V.preventDefault(),Z("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),re.map((V,ue)=>React.createElement("li",{key:V.id,className:`breadcrumb-item ${ue===re.length-1?"active":""}`},ue===re.length-1?V.title:React.createElement("a",{href:"#",onClick:Se=>{Se.preventDefault(),Z(V)},className:"text-warning"},V.title))))),v?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):N.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},D?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder n\xE0o. H\xE3y t\u1EA1o folder \u0111\u1EA7u ti\xEAn!")):React.createElement("div",{className:"row g-3"},N.map(V=>React.createElement("div",{key:V.uuid||V.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card album-card h-100",onClick:()=>f(V)},V.cover?React.createElement("img",{src:V.cover,className:"album-cover",alt:V.title}):React.createElement("div",{className:"card-body text-center py-4"},React.createElement("i",{className:"fas fa-folder fa-3x text-warning mb-2"})),React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"card-title mb-1"},V.title),React.createElement("small",{className:"text-muted"},V.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),V.subfolderCount),V.subfolderCount>0&&V.count>0&&" \u2022 ",V.count>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-image me-1"}),V.count),V.subfolderCount===0&&V.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-2",onClick:ue=>{ue.stopPropagation(),z(V)},title:"S\u1EEDa album"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:ue=>{ue.stopPropagation(),U(V)},title:"X\xF3a album"},React.createElement("i",{className:"fas fa-trash"}))))))))}function AlbumModal({show:N,album:f,onClose:C,onSave:z,parentId:U}){const[v,D]=useState({slug:"",title:"",description:"",cover_url:"",parent_id:null}),[Z,re]=useState(!1),[V,ue]=useState(!1),Se=useRef(null);useEffect(()=>{D(f?{slug:f.id||"",title:f.title||"",description:f.description||"",cover_url:f.cover||"",parent_id:f.parentId||null}:{slug:"",title:"",description:"",cover_url:"",parent_id:U||null})},[f,N,U]);const se=async ee=>{ee.preventDefault(),re(!0),await z(v),re(!1)},me=ee=>ee.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),fe=async ee=>{const ke=ee.type==="image/heic"||ee.type==="image/heif"||/\.heic$/i.test(ee.name);if(ee.size<=2097152&&!ke)return ee;try{const he=await createImageBitmap(ee),De=document.createElement("canvas");let be=he.width,Ae=he.height;const Ne=800;return(be>Ne||Ae>Ne)&&(be>Ae?(Ae=Math.round(Ae/be*Ne),be=Ne):(be=Math.round(be/Ae*Ne),Ae=Ne)),De.width=be,De.height=Ae,De.getContext("2d").drawImage(he,0,0,be,Ae),he.close(),new Promise((Ze,_e)=>{De.toBlob(Ie=>{Ie?Ze(new File([Ie],ee.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):_e(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(he){throw console.error("Compress cover error:",he),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},ie=async ee=>{var he;const de=ee.target.files[0];if(!de)return;if(!(de.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(de.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}ue(!0);try{const De=await fe(de),be=await window.KTM.cloudinary.uploadImage({file:De,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-albums/covers"});if(!be.secure_url)throw console.error("Cloudinary error:",be),new Error(((he=be.error)==null?void 0:he.message)||"Upload failed");D(Ae=>({...Ae,cover_url:be.secure_url}))}catch(De){console.error("Cover upload error:",De),alert("L\u1ED7i upload \u1EA3nh b\xECa: "+De.message)}ue(!1),ee.target.value=""};return N?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},f?"S\u1EEDa":"T\u1EA1o"," Folder"),React.createElement("button",{type:"button",className:"btn-close",onClick:C})),React.createElement("form",{onSubmit:se},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn Folder *"),React.createElement("input",{type:"text",className:"form-control",value:v.title,onChange:ee=>D({...v,title:ee.target.value,slug:v.slug||me(ee.target.value)}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Slug (URL) *"),React.createElement("input",{type:"text",className:"form-control",value:v.slug,onChange:ee=>D({...v,slug:ee.target.value}),required:!0,disabled:!!f}),React.createElement("small",{className:"text-muted"},"VD: may-cay-kubota-l1501")),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",rows:"2",value:v.description,onChange:ee=>D({...v,description:ee.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex gap-2 align-items-start"},v.cover_url&&React.createElement("div",{className:"position-relative",style:{width:80,height:80}},React.createElement("img",{src:v.cover_url,alt:"Cover",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:8}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute",style:{top:-8,right:-8,padding:"2px 6px",fontSize:10},onClick:()=>D(ee=>({...ee,cover_url:""}))},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{ref:Se,type:"file",accept:"image/*",className:"d-none",onChange:ie}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100 mb-2",onClick:()=>{var ee;return(ee=Se.current)==null?void 0:ee.click()},disabled:V},V?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh b\xECa")),React.createElement("input",{type:"url",className:"form-control form-control-sm",value:v.cover_url,onChange:ee=>D({...v,cover_url:ee.target.value}),placeholder:"Ho\u1EB7c d\xE1n URL \u1EA3nh..."}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:C},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:Z||V},Z?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function FolderTreeItem({folder:N,allAlbums:f,currentAlbumId:C,targetAlbum:z,onSelect:U,level:v=0}){const[D,Z]=useState(!0),re=N.uuid||N.id,V=re===C,ue=z===re,Se=f.filter(me=>me.parentId===re),se=Se.length>0;return React.createElement("div",{style:{marginLeft:v*16+"px"}},React.createElement("div",{className:`d-flex align-items-center p-2 rounded mb-1 ${ue?"bg-info text-white":V?"bg-light text-muted":"hover-bg"}`,style:{cursor:V?"not-allowed":"pointer",opacity:V?.5:1,transition:"background 0.2s"},onClick:()=>!V&&U(re)},se&&React.createElement("i",{className:`fas fa-chevron-${D?"down":"right"} me-2`,style:{fontSize:"10px",width:"12px",cursor:"pointer"},onClick:me=>{me.stopPropagation(),Z(!D)}}),!se&&React.createElement("span",{style:{width:"20px"}}),React.createElement("i",{className:`fas fa-folder${ue?"-open":""} me-2 ${ue?"":"text-warning"}`}),React.createElement("span",{className:"small"},N.title),V&&React.createElement("span",{className:"ms-2 badge bg-secondary",style:{fontSize:"9px"}},"Hi\u1EC7n t\u1EA1i"),N.count>0&&!V&&React.createElement("span",{className:"ms-auto badge bg-light text-muted",style:{fontSize:"10px"}},N.count)),D&&se&&React.createElement("div",null,Se.map(me=>React.createElement(FolderTreeItem,{key:me.uuid||me.id,folder:me,allAlbums:f,currentAlbumId:C,targetAlbum:z,onSelect:U,level:v+1}))))}function AlbumDetail({album:N,onBack:f,onRefresh:C,showToast:z,onNavigateToFolder:U,onEditSubfolder:v,parentAlbum:D}){const[Z,re]=useState([]),[V,ue]=useState([]),[Se,se]=useState(!0),[me,fe]=useState(!1),[ie,ee]=useState(""),[de,ke]=useState([]),[he,De]=useState([]),[be,Ae]=useState({}),[Ne,Oe]=useState(null),[Ze,_e]=useState(!1),[Ie,w]=useState(""),[i,x]=useState(!1),j=useRef(null),I=useRef(null),[ae,W]=useState(!1),[q,R]=useState([]),[r,oe]=useState([]),[Le,je]=useState(""),[l,b]=useState(!1),ge=async(u,_=2)=>{const y=_*1024*1024,Fe=u.type==="image/heic"||u.type==="image/heif"||/\.heic$/i.test(u.name);if(u.size<=y&&!Fe)return u;try{const qe=await createImageBitmap(u),ze=document.createElement("canvas");let et=qe.width,at=qe.height;const nt=1200;return(et>nt||at>nt)&&(et>at?(at=Math.round(at/et*nt),et=nt):(et=Math.round(et/at*nt),at=nt)),ze.width=et,ze.height=at,ze.getContext("2d").drawImage(qe,0,0,et,at),qe.close(),new Promise(($t,bt)=>{ze.toBlob(Ve=>{Ve?$t(new File([Ve],u.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):bt(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(qe){throw console.error("Compress error:",qe),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh")}};useEffect(()=>{h(),K()},[N.id,N.uuid]);const h=async()=>{se(!0);try{const u=await window.KTM.api.getJSON(`${API_BASE}/api/albums/${N.uuid||N.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");re(u.images||[]);const _=await window.KTM.api.getJSON(`${API_BASE}/api/albums?parent_id=${N.uuid||N.id}`,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");ue(Array.isArray(_)?_:[])}catch(u){console.error(u),z("L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u","danger")}se(!1)},K=async()=>{try{const u=await window.KTM.api.getJSON(`${API_BASE}/api/albums`,"L\u1ED7i t\u1EA3i album");oe(Array.isArray(u)?u:[])}catch(u){console.error("Error loading albums:",u)}},P=u=>{R(_=>_.includes(u)?_.filter(y=>y!==u):[..._,u])},Me=async()=>{if(!Le||q.length===0){z("Vui l\xF2ng ch\u1ECDn folder \u0111\xEDch","warning");return}b(!0);let u=0;for(const _ of q)try{await window.KTM.api.putJSON(`${API_BASE}/api/images/${_}`,{album_id:Le},"L\u1ED7i di chuy\u1EC3n \u1EA3nh"),u++}catch(y){console.error("Move error:",y)}b(!1),W(!1),R([]),je(""),u>0?(z("\u0110\xE3 di chuy\u1EC3n \u1EA3nh th\xE0nh c\xF4ng!","success"),h(),C()):z("Di chuy\u1EC3n th\u1EA5t b\u1EA1i","danger")},[it,Pe]=useState(!1),Ke=async()=>{if(q.length===0||!confirm(`X\xF3a ${q.length} \u1EA3nh \u0111\xE3 ch\u1ECDn? H\xE0nh \u0111\u1ED9ng n\xE0y kh\xF4ng th\u1EC3 ho\xE0n t\xE1c!`))return;Pe(!0);let u=0;for(const _ of q)try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${_}`,"L\u1ED7i x\xF3a \u1EA3nh"),u++}catch(y){console.error("Delete error:",y)}Pe(!1),R([]),u>0?(z(`\u0110\xE3 x\xF3a ${u} \u1EA3nh!`,"success"),h(),C()):z("X\xF3a th\u1EA5t b\u1EA1i","danger")},Ue=()=>{q.length===Z.length?R([]):R(Z.map(u=>u.id))},mt=async()=>{if(Ie.trim()){x(!0);try{const u=Ie.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");await window.KTM.api.postJSON(`${API_BASE}/api/albums`,{slug:u+"-"+Date.now(),title:Ie,parent_id:N.uuid||N.id},"L\u1ED7i t\u1EA1o folder"),z("T\u1EA1o folder th\xE0nh c\xF4ng!","success"),w(""),_e(!1),h(),C()}catch(u){z(u.message,"danger")}x(!1)}},Mt=async u=>{if(confirm(`X\xF3a folder "${u.title}"? T\u1EA5t c\u1EA3 n\u1ED9i dung b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${u.uuid||u.id}`,"L\u1ED7i x\xF3a folder"),z("\u0110\xE3 x\xF3a folder","success"),h(),C()}catch(_){z("L\u1ED7i x\xF3a folder","danger")}},yt=u=>{const _=Array.from(u).filter(y=>y.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(y.name));ke(y=>[...y,..._]),_.forEach(y=>{const Fe=new FileReader;Fe.onload=qe=>{De(ze=>[...ze,{file:y,preview:qe.target.result}])},Fe.readAsDataURL(y)})},Rt=u=>{ke(_=>_.filter((y,Fe)=>Fe!==u)),De(_=>_.filter((y,Fe)=>Fe!==u))},Pt=async u=>{var y;const _=await window.KTM.cloudinary.uploadImage({file:u,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:`ktm-albums/${N.id}`});if(!_.secure_url)throw console.error("Cloudinary error:",_),new Error(((y=_.error)==null?void 0:y.message)||"Upload failed");return _},It=async()=>{if(de.length===0)return;fe(!0);let u=0;for(let _=0;_<de.length;_++)try{ee(`\u0110ang x\u1EED l\xFD ${_+1}/${de.length}...`);const y=await ge(de[_],2);ee(`\u0110ang upload ${_+1}/${de.length}...`);const Fe=await Pt(y);await window.KTM.api.postJSON(`${API_BASE}/api/albums/${N.id}`,{url:Fe.secure_url,caption:be[_]||de[_].name.replace(/\.[^/.]+$/,""),sort_order:Z.length+_},"L\u1ED7i l\u01B0u \u1EA3nh"),u++}catch(y){console.error("Upload error:",y)}fe(!1),ee(""),ke([]),De([]),Ae({}),u>0?(z(`\u0110\xE3 upload ${u} \u1EA3nh th\xE0nh c\xF4ng!`,"success"),h(),C()):z("Upload th\u1EA5t b\u1EA1i","danger")},we=async(u,_)=>{if(confirm("X\xF3a \u1EA3nh n\xE0y?"))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/images/${u}`,"L\u1ED7i x\xF3a \u1EA3nh"),z("\u0110\xE3 x\xF3a \u1EA3nh","success"),h(),C()}catch(y){z("L\u1ED7i x\xF3a \u1EA3nh","danger")}},Ge=u=>{var _;u.preventDefault(),(_=I.current)==null||_.classList.add("dragover")},ct=()=>{var u;(u=I.current)==null||u.classList.remove("dragover")},kt=u=>{var _;u.preventDefault(),(_=I.current)==null||_.classList.remove("dragover"),yt(u.dataTransfer.files)};return React.createElement("div",null,React.createElement("div",{className:"d-flex align-items-center justify-content-between mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:f},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("h4",{className:"m-0"},N.title),React.createElement("small",{className:"text-muted"},V.length>0&&React.createElement("span",null,V.length," folder \u2022 "),Z.length," \u1EA3nh"))),React.createElement("button",{className:"btn btn-outline-warning btn-sm",onClick:()=>_e(!0)},React.createElement("i",{className:"fas fa-folder-plus me-1"}),"T\u1EA1o Folder con")),Ze&&React.createElement("div",{className:"card mb-4 border-warning"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder-plus me-2 text-warning"}),"T\u1EA1o folder con"),React.createElement("div",{className:"d-flex gap-2"},React.createElement("input",{type:"text",className:"form-control",placeholder:"T\xEAn folder...",value:Ie,onChange:u=>w(u.target.value),onKeyPress:u=>u.key==="Enter"&&mt(),autoFocus:!0}),React.createElement("button",{className:"btn btn-warning",onClick:mt,disabled:i||!Ie.trim()},i?React.createElement("span",{className:"spinner-border spinner-border-sm"}):"T\u1EA1o"),React.createElement("button",{className:"btn btn-secondary",onClick:()=>{_e(!1),w("")}},"H\u1EE7y")))),V.length>0&&React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-folder me-2 text-warning"}),"Folder con"),React.createElement("div",{className:"row g-2"},V.map(u=>React.createElement("div",{key:u.uuid||u.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-item",style:{cursor:"pointer"},onClick:()=>U&&U(u)},React.createElement("div",{className:"card-body text-center py-3"},React.createElement("i",{className:"fas fa-folder fa-2x text-warning mb-2"}),React.createElement("div",{className:"small fw-bold text-truncate"},u.title),React.createElement("small",{className:"text-muted"},u.subfolderCount>0&&React.createElement("span",null,u.subfolderCount," folder"),u.subfolderCount>0&&u.count>0&&" \u2022 ",u.count>0&&React.createElement("span",null,u.count," \u1EA3nh"),u.subfolderCount===0&&u.count===0&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0 text-center"},React.createElement("button",{className:"btn btn-sm btn-outline-primary me-1",onClick:_=>{_.stopPropagation(),v&&v(u)},title:"S\u1EEDa folder"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:_=>{_.stopPropagation(),Mt(u)},title:"X\xF3a folder"},React.createElement("i",{className:"fas fa-trash"}))))))))),React.createElement("div",{className:"card mb-4"},React.createElement("div",{className:"card-body"},React.createElement("h6",{className:"mb-3"},React.createElement("i",{className:"fas fa-cloud-upload-alt me-2"}),"Upload \u1EA3nh m\u1EDBi"),React.createElement("div",{ref:I,className:"upload-zone",onClick:()=>{var u;return(u=j.current)==null?void 0:u.click()},onDragOver:Ge,onDragLeave:ct,onDrop:kt},React.createElement("i",{className:"fas fa-images fa-2x text-muted mb-2"}),React.createElement("p",{className:"mb-0"},"K\xE9o th\u1EA3 \u1EA3nh v\xE0o \u0111\xE2y ho\u1EB7c click \u0111\u1EC3 ch\u1ECDn"),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3 JPG, PNG, WebP"),React.createElement("input",{ref:j,type:"file",multiple:!0,accept:"image/*",onChange:u=>yt(u.target.files)})),he.length>0&&React.createElement("div",{className:"mt-3"},React.createElement("div",{className:"upload-preview"},he.map((u,_)=>React.createElement("div",{key:_,className:"upload-preview-item"},React.createElement("img",{src:u.preview,alt:""}),React.createElement("button",{className:"remove",onClick:()=>Rt(_)},React.createElement("i",{className:"fas fa-times"}))))),React.createElement("div",{className:"mt-3"},React.createElement("button",{className:"btn btn-warning",onClick:It,disabled:me},me?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),ie||"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload ",de.length," \u1EA3nh")))))),React.createElement("div",{className:"card"},React.createElement("div",{className:"card-body"},React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("h6",{className:"m-0"},React.createElement("i",{className:"fas fa-th me-2"}),"\u1EA2nh (",Z.length,")"),Z.length>0&&React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:Ue},q.length===Z.length?"B\u1ECF ch\u1ECDn":"Ch\u1ECDn t\u1EA5t c\u1EA3")),q.length>0&&React.createElement("div",{className:"d-flex align-items-center gap-2 flex-wrap"},React.createElement("span",{className:"badge bg-primary"},q.length," \u0111\xE3 ch\u1ECDn"),React.createElement("button",{className:"btn btn-sm btn-info",onClick:()=>W(!0)},React.createElement("i",{className:"fas fa-folder-open me-1"}),"Di chuy\u1EC3n"),React.createElement("button",{className:"btn btn-sm btn-danger",onClick:Ke,disabled:it},it?React.createElement("span",{className:"spinner-border spinner-border-sm"}):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-trash me-1"}),"X\xF3a")),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>R([])},React.createElement("i",{className:"fas fa-times"})))),Se?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):Z.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},React.createElement("i",{className:"fas fa-image fa-2x mb-2"}),React.createElement("p",null,"Ch\u01B0a c\xF3 \u1EA3nh n\xE0o trong album n\xE0y")):React.createElement("div",{className:"image-grid"},Z.map((u,_)=>React.createElement("div",{key:_,className:`image-item ${q.includes(u.id)?"selected":""}`,style:{position:"relative",cursor:"pointer"},onClick:()=>P(u.id)},React.createElement("div",{className:"select-checkbox",style:{position:"absolute",top:"6px",left:"6px",zIndex:10,width:"24px",height:"24px",borderRadius:"4px",background:q.includes(u.id)?"#0d6efd":"rgba(255,255,255,0.9)",border:q.includes(u.id)?"none":"2px solid #ccc",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 1px 3px rgba(0,0,0,0.2)"}},q.includes(u.id)&&React.createElement("i",{className:"fas fa-check",style:{color:"#fff",fontSize:"12px"}})),React.createElement("img",{src:u.src,alt:u.caption,style:{opacity:q.includes(u.id)?.7:1,border:q.includes(u.id)?"3px solid #0d6efd":"none",borderRadius:"8px"}}),React.createElement("div",{className:"actions"},React.createElement("button",{className:"btn btn-sm btn-danger",onClick:y=>{y.stopPropagation(),we(u.id,_)},title:"X\xF3a \u1EA3nh"},React.createElement("i",{className:"fas fa-trash"}))),u.caption&&React.createElement("div",{className:"p-2 bg-light small text-truncate"},u.caption)))))),ae&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header bg-info text-white"},React.createElement("h5",{className:"modal-title"},React.createElement("i",{className:"fas fa-folder-open me-2"}),"Di chuy\u1EC3n ",q.length," \u1EA3nh"),React.createElement("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>W(!1)})),React.createElement("div",{className:"modal-body",style:{maxHeight:"400px",overflowY:"auto"}},React.createElement("p",{className:"text-muted small mb-3"},"Ch\u1ECDn th\u01B0 m\u1EE5c \u0111\xEDch:"),React.createElement("div",{className:"folder-tree"},r.filter(u=>!u.parentId).map(u=>React.createElement(FolderTreeItem,{key:u.uuid||u.id,folder:u,allAlbums:r,currentAlbumId:N.uuid||N.id,targetAlbum:Le,onSelect:je})))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>W(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-info",onClick:Me,disabled:!Le||l},l?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang chuy\u1EC3n..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-1"}),"Di chuy\u1EC3n \u0111\u1EBFn \u0111\xE2y")))))),Ne&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.9)"},onClick:()=>Oe(null)},React.createElement("div",{className:"modal-dialog modal-fullscreen d-flex align-items-center justify-content-center"},React.createElement("div",{className:"position-relative",style:{maxWidth:"95vw",maxHeight:"95vh"}},React.createElement("button",{className:"btn btn-light position-absolute",style:{top:"-50px",right:"0",borderRadius:"50%",width:"40px",height:"40px"},onClick:()=>Oe(null)},React.createElement("i",{className:"fas fa-times"})),React.createElement("img",{src:Ne.src,alt:Ne.caption,style:{maxWidth:"95vw",maxHeight:"90vh",objectFit:"contain"},onClick:u=>u.stopPropagation()}),Ne.caption&&React.createElement("div",{className:"text-white text-center mt-2"},Ne.caption)))))}function SearchCenter({showToast:N,onNavigate:f}){const[C,z]=useState(""),[U,v]=useState([]),[D,Z]=useState([]),[re,V]=useState([]),[ue,Se]=useState("all"),[se,me]=useState(null),[fe,ie]=useState("list"),[ee,de]=useState(!0),[ke,he]=useState([]),[De,be]=useState([]),Ae=useRef(null),[Ne,Oe]=useState(!0),[Ze,_e]=useState(!1),Ie=useRef(null),[w,i]=useState(!1),[x,j]=useState([{role:"assistant",content:`Xin ch\xE0o! H\xE3y h\u1ECFi t\xF4i v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3... V\xED d\u1EE5:
\u2022 "Gi\xE1 van 2 tay?"
\u2022 "Combo r\u1EBB nh\u1EA5t?"
\u2022 "Freeship?"`,attachments:[]}]),[I,ae]=useState(""),[W,q]=useState(!1),R=useRef(null),r=useRef(null),[oe,Le]=useState(null),[je,l]=useState(!1),[b,ge]=useState(null),[h,K]=useState(!1),[P,Me]=useState(!1),[it,Pe]=useState(null),[Ke,Ue]=useState({name:"",code:"",price:"",image:"",category:"",note:"",commission_percent:""}),mt=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"],Mt=t=>{var S,$;t._type==="product"&&(ge(t),Ue({name:t.name||"",code:t.code||"",price:t.price||"",image:t.image||"",category:t.category||"",note:t.note||"",commission_percent:($=(S=t.commission_percent)!=null?S:t.commissionPercent)!=null?$:""}),l(!0))},yt=async()=>{if(b)try{await window.KTM.api.putJSON(`${API_BASE}/api/products?id=${b.id}`,Ke,"L\u1ED7i c\u1EADp nh\u1EADt"),N("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),l(!1),ge(null),Ge()}catch(t){N(t.message,"danger")}},Rt=async t=>{const S=t._type==="product"?"s\u1EA3n ph\u1EA9m":t._type==="album"?"\u1EA3nh":"video";if(confirm(`X\xF3a ${S} "${t.name}"?`))try{let $="";t._type==="product"?$=`${API_BASE}/api/products?id=${t.id}`:t._type==="album"?$=`${API_BASE}/api/images/${t.id}`:t._type==="video"&&($=`${API_BASE}/api/videos/${t.id}`),await window.KTM.api.deleteJSON($,"L\u1ED7i x\xF3a"),N(`\u0110\xE3 x\xF3a ${S}`,"success"),Ge()}catch($){N($.message,"danger")}},Pt=async t=>{try{const S=it?`${API_BASE}/api/products?id=${it.id}`:`${API_BASE}/api/products`;it?await window.KTM.api.putJSON(S,t,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(S,t,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),N(it?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Me(!1),Pe(null),Ge()}catch(S){N(S.message,"danger")}},It="ktm_admin_data_cache_v1",we=1e3*60*10,Ge=async()=>{let t=null,S=!1;const $=window.KTM.cache.read(It,{ttlMs:we,validate:Array.isArray});$.hit?(t=$.value,console.log("[CACHE] Using cache, items:",t.length),Z(t),v(t),de(!1),S=!0):$.status==="miss"?console.log("[CACHE] No cache found"):$.status==="expired"||$.status==="invalid"?console.log("[CACHE] Cache expired or invalid"):$.status==="error"&&console.error("[CACHE] Error parsing cache"),S||de(!0);try{const H=async(E,ce)=>{try{const We=await window.KTM.api.getJSON(E,"L\u1ED7i t\u1EA3i d\u1EEF li\u1EC7u");return We!=null?We:ce}catch(We){return ce}},[Q,A,k]=await Promise.all([H(`${API_BASE}/api/products`,[]),H(`${API_BASE}/api/albums`,[]),H(`${API_BASE}/api/video-folders?withVideos=true`,[])]),J=Array.isArray(Q)?Q.map(E=>({...E,_type:"product",_source:"database"})):[];he(A);let le=[];Array.isArray(A)&&A.length>0&&(await Promise.all(A.map(ce=>H(`${API_BASE}/api/albums/${ce.id}`,{})))).forEach((ce,We)=>{const tt=A[We];ce.images&&ce.images.length>0&&ce.images.forEach(Qe=>{le.push({id:Qe.id,name:Qe.caption||"\u1EA2nh t\u1EEB "+tt.title,image:Qe.src,folder:tt.title,_type:"album",_source:"database"})})}),be(k);let Ce=[];Array.isArray(k)&&k.forEach(E=>{E.videos&&E.videos.forEach(ce=>{Ce.push({id:ce.id,name:ce.title,folder:E.name,image:ce.thumb,youtubeId:ce.youtubeId,url:ce.url,_type:"video",_source:"database"})})});const B=[...J,...le,...Ce];(!t||JSON.stringify(B)!==JSON.stringify(t))&&(Z(B),v(B),window.KTM.cache.write(It,B))}catch(H){console.error("Song song fetch error:",H)}de(!1)};useEffect(()=>{Ge(),setTimeout(()=>{var t;return(t=Ae.current)==null?void 0:t.focus()},100)},[]);const ct=t=>{try{return String(t!=null?t:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(S){return String(t!=null?t:"").toLowerCase()}},kt=t=>{const $=ct(t).trim().split(/\s+/).filter(Boolean),H=$.includes("anh"),Q=$.includes("video"),A=$.filter(le=>le!=="anh"&&le!=="video"),k=A.join(" "),J=new Set(["product"]);return H&&J.add("album"),Q&&J.add("video"),{allowedTypes:J,includeAlbum:H,includeVideo:Q,contentTokens:A,cleanedQuery:k}},u=(t,S,$)=>{var E,ce,We,tt,Qe;const H=Array.isArray(S)?S:[],Q=ct($).trim();if(!H.length&&!Q)return 0;const A=ct((E=t==null?void 0:t.name)!=null?E:""),k=ct((ce=t==null?void 0:t.code)!=null?ce:""),J=ct((We=t==null?void 0:t.category)!=null?We:""),le=ct((tt=t==null?void 0:t.note)!=null?tt:""),Ce=ct((Qe=t==null?void 0:t.folder)!=null?Qe:"");if(!`${A} ${k} ${J} ${le} ${Ce}`.trim())return 0;let te=0;Q&&(A===Q&&(te+=220),A.includes(Q)&&(te+=140),A.startsWith(Q)&&(te+=160),k&&k===Q&&(te+=180),k&&k.includes(Q)&&(te+=90));for(const st of H){if(!st)continue;const ft=new RegExp(`(?:^|\\s)${st.replace(/[.*+?^${}()|[\\]\\]/g,"\\$&")}`);A.includes(st)&&(te+=35),ft.test(A)&&(te+=25),k&&k.includes(st)&&(te+=20),k&&ft.test(k)&&(te+=10),J&&J.includes(st)&&(te+=12),Ce&&Ce.includes(st)&&(te+=12),le&&le.includes(st)&&(te+=6)}return te>0&&A&&(te+=Math.max(0,10-Math.min(10,Math.floor(A.length/10)))),te},_=(t,S,$)=>{const H=Array.isArray(t)?t:[];return H.length?H.map((A,k)=>({it:A,idx:k,score:u(A,S,$)})).sort((A,k)=>k.score!==A.score?k.score-A.score:A.idx-k.idx).map(A=>A.it):[]},y=async(t,S)=>{if(!(!Ne||S.length===0)){_e(!0);try{const $=S.map(Q=>({id:Q.id,name:Q.name,price:Q.price,category:Q.category,note:Q.note,folder:Q.folder,_type:Q._type})),H=await window.KTM.api.postJSON(`${API_BASE}/api/ai-search`,{query:t,products:$},"AI Search error");if(H&&H.matchedIds&&H.matchedIds.length>0){const{contentTokens:Q,cleanedQuery:A}=kt(t),k=new Set(H.matchedIds),J=S.filter(le=>k.has(le.id)).sort((le,Ce)=>u(Ce,Q,A)-u(le,Q,A));J.length>0&&v(J)}else H&&H.matchedIds&&H.matchedIds.length===0&&v([])}catch($){console.error("AI Search error:",$)}_e(!1)}},Fe=t=>{if(z(t),Ie.current&&clearTimeout(Ie.current),!t.trim()){qe(ue);return}const{allowedTypes:S,contentTokens:$,cleanedQuery:H}=kt(t),Q=D.filter(k=>{if(!S.has(k==null?void 0:k._type))return!1;if($.length===0)return!0;const J=ct(Object.entries(k).filter(([le])=>!le.startsWith("_")).map(([,le])=>String(le||"")).join(" "));return $.some(le=>J.includes(le))});let A=Q;ue!=="all"&&(A=Q.filter(k=>(k.category||k._type)===ue)),v(_(A,$,H)),Ne&&H.length>=3&&(Ie.current=setTimeout(()=>{y(H,A)},500))},qe=t=>{Se(t);const{allowedTypes:S,contentTokens:$}=kt(C),{cleanedQuery:H}=kt(C);let Q=D.filter(A=>S.has(A==null?void 0:A._type));t!=="all"&&(Q=Q.filter(A=>(A.category||A._type)===t)),C.trim()&&$.length>0&&(Q=Q.filter(A=>{const k=ct(Object.entries(A).filter(([J])=>!J.startsWith("_")).map(([,J])=>String(J||"")).join(" "));return $.every(J=>k.includes(J))})),v(_(Q,$,H))},ze=(t,S)=>{window.KTM.clipboard.writeText(t).then(()=>{me(S),N("\u0110\xE3 copy!","success"),setTimeout(()=>me(null),1500)})},et=async(t,S)=>{try{await window.KTM.clipboard.writeImageFromUrl(t),me(S+"-img"),N("\u0110\xE3 copy \u1EA3nh!","success"),setTimeout(()=>me(null),1500)}catch($){ze(t,S+"-img")}},at=t=>{let S=t.toLowerCase();const $=[],H=D.filter(k=>k._type==="product");if(S.includes("ty")||S.includes("xy lanh")){if(S.includes("gi\u1EEFa")||S.includes("giua")){const k=H.find(J=>{var le;return(le=J.name)==null?void 0:le.toLowerCase().includes("xy lanh gi\u1EEFa")});k&&!$.find(J=>J.id===k.id)&&$.push(k)}if(S.includes("nghi\xEAng")||S.includes("nghieng")){const k=H.find(J=>{var le;return(le=J.name)==null?void 0:le.toLowerCase().includes("xy lanh nghi\xEAng")});k&&!$.find(J=>J.id===k.id)&&$.push(k)}if(S.includes("\u1EE7i")||S.includes("ui")){const k=H.find(J=>{var le;return(le=J.name)==null?void 0:le.toLowerCase().includes("xy lanh \u1EE7i")});k&&!$.find(J=>J.id===k.id)&&$.push(k)}}const Q=S.match(/van\s*(\d+)\s*tay.*?(\d+)\s*ty/);if(Q){const k=Q[1],J=Q[2],le=H.find(Ce=>{var te;const B=((te=Ce.name)==null?void 0:te.toLowerCase())||"";return B.includes("combo")&&B.includes(`${k} tay`)&&(B.includes(`${J} xy`)||B.includes(`${J} xylanh`))});if(le&&!$.find(Ce=>Ce.id===le.id))$.push(le);else{const Ce=H.find(B=>{var E;const te=((E=B.name)==null?void 0:E.toLowerCase())||"";return te.includes("combo")&&te.includes(`${k} tay`)});Ce&&!$.find(B=>B.id===Ce.id)&&$.push(Ce)}}if(S.includes("combo")&&!Q){const k=S.match(/combo.*?(\d+)\s*tay/);if(k){const J=k[1];H.filter(Ce=>{var te;const B=((te=Ce.name)==null?void 0:te.toLowerCase())||"";return B.includes("combo")&&B.includes(`${J} tay`)}).forEach(Ce=>{$.find(B=>B.id===Ce.id)||$.push(Ce)})}}const A=S.match(/van\s*(\d+)\s*tay/);if(A&&!S.includes("ty")&&!S.includes("combo")){const k=A[1],J=H.find(le=>{var B;const Ce=((B=le.name)==null?void 0:B.toLowerCase())||"";return Ce.includes(`van ${k} tay`)&&!Ce.includes("combo")});J&&!$.find(le=>le.id===J.id)&&$.push(J)}return $.slice(0,4)},nt=async t=>{if(!t.trim())return;const S={role:"user",content:t,attachments:[]};j(H=>[...H,S]),ae(""),q(!0);const $=at(t);setTimeout(()=>{var H;return(H=R.current)==null?void 0:H.scrollIntoView({behavior:"smooth"})},100);try{const Q=D.filter(B=>B._type==="product").map(B=>{let te=`- ${B.name}`;return B.code&&(te+=` (M\xE3: ${B.code})`),B.price&&(te+=` - Gi\xE1: ${B.price.replace(/[đ\s]/g,"")}\u0111`),B.category&&(te+=` [${B.category}]`),B.note&&(te+=` (${B.note})`),te}).join(`
`),k=x.slice(-6).map(B=>`${B.role==="user"?"Kh\xE1ch":"AI"}: ${B.content}`).join(`
`),J=k?`L\u1ECACH S\u1EEC H\u1ED8I THO\u1EA0I:
${k}

DANH S\xC1CH S\u1EA2N PH\u1EA8M:
${Q}`:Q,Ce=(await window.KTM.api.postJSON(`${API_BASE}/api/ai-chat`,{message:t,context:J,audience:"admin"},"API error")).response||"Xin l\u1ED7i, t\xF4i kh\xF4ng th\u1EC3 tr\u1EA3 l\u1EDDi l\xFAc n\xE0y.";j(B=>[...B,{role:"assistant",content:Ce,attachments:$}])}catch(H){console.error("AI Error:",H);const Q=t.toLowerCase(),A=D.filter(J=>{const le=Object.values(J).join(" ").toLowerCase();return Q.split(" ").some(Ce=>le.includes(Ce))});let k="";A.length>0?(k=`T\xECm th\u1EA5y ${A.length} s\u1EA3n ph\u1EA9m li\xEAn quan:

`,A.slice(0,5).forEach(J=>{k+=`\u2022 ${J.name}`,J.price&&(k+=` - ${J.price.replace(/[đ\s]/g,"")}\u0111`),J.note&&(k+=` (${J.note})`),k+=`
`}),A.length>5&&(k+=`
...v\xE0 ${A.length-5} s\u1EA3n ph\u1EA9m kh\xE1c`)):k='Kh\xF4ng t\xECm th\u1EA5y s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p. H\xE3y th\u1EED t\u1EEB kh\xF3a kh\xE1c nh\u01B0 "van", "combo", "xy lanh"...',j(J=>[...J,{role:"assistant",content:k,attachments:A.slice(0,4)}])}q(!1),setTimeout(()=>{var H,Q;(H=R.current)==null||H.scrollIntoView({behavior:"smooth"}),(Q=r.current)==null||Q.focus()},100)};function Ct({show:t,product:S,categories:$,onClose:H,onSave:Q}){const[A,k]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[]}),[J,le]=useState(!1),[Ce,B]=useState(!1),te=useRef(null),E=O=>window.KTM.money.formatVNDInputDigits(O),ce=O=>{const F=window.KTM.money.getDigits(String(O!=null?O:"")),ne=Number(F);return F&&Number.isFinite(ne)?Math.trunc(ne):0},We=(O,F)=>{if(O==null||O==="")return[];let ne=O;if(typeof ne=="string"){const G=ne.trim();if(!G)return[];try{ne=JSON.parse(G)}catch(X){return[]}}if(!Array.isArray(ne))return[];const pe=ce(F);return ne.map(G=>{var ve;if(!G||typeof G!="object")return null;const X=String((ve=G.name)!=null?ve:"").trim(),xe=(Array.isArray(G.options)?G.options:[]).map(Te=>{var gt,vt,xt,_t,At,Dt,Ft;if(!Te||typeof Te!="object")return null;const Xe=String((gt=Te.label)!=null?gt:"").trim();if(!Xe)return null;const dt=(At=(_t=(xt=(vt=Te.price)!=null?vt:Te.priceValue)!=null?xt:Te.unit_price)!=null?_t:Te.unitPrice)!=null?At:null,Be=Number(dt);let Ye=Number.isFinite(Be)?Math.trunc(Be):null;if(Ye==null){const Ut=(Ft=(Dt=Te.price_delta)!=null?Dt:Te.priceDelta)!=null?Ft:null,Vt=Number(Ut);Number.isFinite(Vt)&&(Ye=pe+Math.trunc(Vt))}Ye==null&&(Ye=pe);const St=String(Math.max(0,Math.trunc(Number(Ye)||0)));return{label:Xe,price:Math.max(0,Math.trunc(Number(Ye)||0)),priceDigits:St}}).filter(Boolean);return{name:X||"Bi\u1EBFn th\u1EC3",options:xe}}).filter(Boolean)};useEffect(()=>{var O,F;if(S)if(k({name:S.name||"",code:S.code||"",price:S.price||"",image:S.image||"",category:S.category||"",note:S.note||"",sort_order:S.sort_order||0,commission_percent:(F=(O=S.commission_percent)!=null?O:S.commissionPercent)!=null?F:5,variants:We(S.variants,S.price)}),S.price){const ne=window.KTM.money.getDigits(S.price);Nt(ne),k(pe=>({...pe,price:E(ne)}))}else Nt("");else k({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[]}),Nt("")},[S,t]);const tt=O=>{k(F=>{var xe;const ne=ce(F.price),pe=String(ne),G=Array.isArray(F.variants)?[...F.variants]:[],X={...G[O]||{},options:Array.isArray((xe=G[O])==null?void 0:xe.options)?[...G[O].options]:[]};return X.options=X.options.map(ve=>({label:String((ve==null?void 0:ve.label)||""),price:ne,priceDigits:pe})),G[O]=X,{...F,variants:G}})},Qe=()=>{k(O=>{const F=ce(O.price),ne=String(F),G=(Array.isArray(O.variants)?[...O.variants]:[]).map(X=>{const xe=(Array.isArray(X==null?void 0:X.options)?X.options:[]).map(ve=>({label:String((ve==null?void 0:ve.label)||""),price:F,priceDigits:ne}));return{name:String((X==null?void 0:X.name)||"Bi\u1EBFn th\u1EC3"),options:xe}});return{...O,variants:G}})},[st,ft]=React.useState(""),[rt,Nt]=React.useState(""),Tt=O=>{const F=window.KTM.money.nextPriceInputState(O.target.value,rt);Nt(F.digits),k({...A,price:F.price})},Lt=async(O,F=2)=>{const ne=F*1024*1024;if(O.size<=ne)return O;try{const pe=await createImageBitmap(O),G=document.createElement("canvas");let X=pe.width,xe=pe.height;const ve=1200;return(X>ve||xe>ve)&&(X>xe?(xe=Math.round(xe/X*ve),X=ve):(X=Math.round(X/xe*ve),xe=ve)),G.width=X,G.height=xe,G.getContext("2d").drawImage(pe,0,0,X,xe),pe.close(),new Promise((Xe,dt)=>{G.toBlob(Be=>{Be?Xe(new File([Be],O.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"})):dt(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.8)})}catch(pe){throw console.error("Compress error:",pe),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},wt=async O=>{var pe;const F=O.target.files[0];if(!F)return;if(!(F.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp)$/i.test(F.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}B(!0);try{const G=await Lt(F),X=await window.KTM.cloudinary.uploadImage({file:G,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,folder:"ktm-products"});if(!X.secure_url)throw console.error("Cloudinary error:",X),new Error(((pe=X.error)==null?void 0:pe.message)||"Upload failed");k(xe=>({...xe,image:X.secure_url}))}catch(G){console.error("Upload error:",G),alert("L\u1ED7i upload \u1EA3nh: "+G.message)}B(!1),O.target.value=""},Et=async O=>{O.preventDefault(),le(!0),await Q(A),le(!1)};return t?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-lg"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,border:"none",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark"},React.createElement("i",{className:"fas fa-box me-2"}),S?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:H})),React.createElement("form",{onSubmit:Et},React.createElement("div",{className:"modal-body",style:{maxHeight:"70vh",overflowY:"auto"}},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-8"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-tag me-1"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:A.name,onChange:O=>k({...A,name:O.target.value}),placeholder:"V\xED d\u1EE5: Xy lanh nghi\xEAng KTM",required:!0,style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-hashtag me-1"}),"M\xE3 s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:A.code,onChange:O=>k({...A,code:O.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1"}),"Gi\xE1 b\xE1n"),React.createElement("input",{type:"text",className:"form-control",value:A.price,onChange:Tt,placeholder:"1.950.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3 mt-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-percent me-1"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:A.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:O=>k({...A,commission_percent:O.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-list me-1"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:A.category,onChange:O=>k({...A,category:O.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),$.map(O=>React.createElement("option",{key:O,value:O},O)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1"}),"Ghi ch\xFA"),React.createElement("textarea",{className:"form-control",rows:"2",value:A.note,onChange:O=>k({...A,note:O.target.value}),placeholder:"V\xED d\u1EE5: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(A.variants)?A.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3. C\xF3 th\u1EC3 th\xEAm (v\xED d\u1EE5 Size: S/M/L)."):null,(Array.isArray(A.variants)?A.variants:[]).map((O,F)=>React.createElement("div",{key:F,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(O==null?void 0:O.name)||"",onChange:ne=>{const pe=ne.target.value;k(G=>{var xe;const X=Array.isArray(G.variants)?[...G.variants]:[];return X[F]={...X[F]||{},name:pe,options:Array.isArray((xe=X[F])==null?void 0:xe.options)?X[F].options:[]},{...G,variants:X}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>tt(F),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(O==null?void 0:O.options)||O.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{k(ne=>{const pe=Array.isArray(ne.variants)?[...ne.variants]:[];return pe.splice(F,1),{...ne,variants:pe}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(O==null?void 0:O.options)?O.options:[]).map((ne,pe)=>{var G,X;return React.createElement("div",{key:pe,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(ne==null?void 0:ne.label)||"",onChange:xe=>{const ve=xe.target.value;k(Te=>{var St,gt,vt,xt,_t;const Xe=Array.isArray(Te.variants)?[...Te.variants]:[],dt={...Xe[F]||{},options:Array.isArray((St=Xe[F])==null?void 0:St.options)?[...Xe[F].options]:[]},Be=Number((vt=(gt=dt.options[pe])==null?void 0:gt.price)!=null?vt:0)||0,Ye=String((_t=(xt=dt.options[pe])==null?void 0:xt.priceDigits)!=null?_t:Math.max(0,Math.trunc(Be)));return dt.options[pe]={...dt.options[pe]||{},label:ve,price:Math.max(0,Math.trunc(Be)),priceDigits:Ye},Xe[F]=dt,{...Te,variants:Xe}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:E(String((X=ne==null?void 0:ne.priceDigits)!=null?X:window.KTM.money.getDigits(String((G=ne==null?void 0:ne.price)!=null?G:"")))),onChange:xe=>{k(ve=>{var vt,xt,_t,At,Dt;const Te=String((xt=ne==null?void 0:ne.priceDigits)!=null?xt:window.KTM.money.getDigits(String((vt=ne==null?void 0:ne.price)!=null?vt:""))),Xe=window.KTM.money.nextPriceInputState(xe.target.value,Te),dt=String((_t=Xe.digits)!=null?_t:""),Be=Number(dt),Ye=Number.isFinite(Be)?Math.max(0,Math.trunc(Be)):0,St=Array.isArray(ve.variants)?[...ve.variants]:[],gt={...St[F]||{},options:Array.isArray((At=St[F])==null?void 0:At.options)?[...St[F].options]:[]};return gt.options[pe]={...gt.options[pe]||{},label:String(((Dt=gt.options[pe])==null?void 0:Dt.label)||""),price:Ye,priceDigits:dt},St[F]=gt,{...ve,variants:St}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{k(xe=>{var Xe;const ve=Array.isArray(xe.variants)?[...xe.variants]:[],Te={...ve[F]||{},options:Array.isArray((Xe=ve[F])==null?void 0:Xe.options)?[...ve[F].options]:[]};return Te.options.splice(pe,1),ve[F]=Te,{...xe,variants:ve}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{k(ne=>{var xe;const pe=Array.isArray(ne.variants)?[...ne.variants]:[],G={...pe[F]||{},options:Array.isArray((xe=pe[F])==null?void 0:xe.options)?[...pe[F].options]:[]},X=ce(ne.price);return G.options.push({label:"",price:X,priceDigits:String(X)}),pe[F]=G,{...ne,variants:pe}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{k(O=>{const F=ce(O.price),ne=Array.isArray(O.variants)?[...O.variants]:[],pe=String(F);return ne.push({name:"Size",options:[{label:"S",price:F,priceDigits:pe},{label:"M",price:F,priceDigits:pe},{label:"L",price:F,priceDigits:pe}]}),{...O,variants:ne}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:Qe,disabled:!Array.isArray(A.variants)||A.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111.")))),React.createElement("div",{className:"col-md-4"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-image me-1"}),"\u1EA2nh s\u1EA3n ph\u1EA9m"),React.createElement("div",{className:"mb-2"},A.image?React.createElement(React.Fragment,null,React.createElement("img",{src:A.image,alt:"Product",style:{width:"100%",height:150,objectFit:"cover",borderRadius:"12px",border:"2px solid #e9ecef"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger mt-2",onClick:()=>k({...A,image:""}),style:{borderRadius:"20px",fontSize:"0.75rem"}},React.createElement("i",{className:"fas fa-times me-1"}),"X\xF3a \u1EA3nh")):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:"100%",height:150,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd",cursor:"pointer"},onClick:()=>{var O;return(O=te.current)==null?void 0:O.click()}},React.createElement("div",{className:"text-center"},React.createElement("i",{className:"fas fa-cloud-upload-alt fa-2x text-muted mb-2"}),React.createElement("div",{className:"small text-muted"},"Click \u0111\u1EC3 upload")))),React.createElement("input",{ref:te,type:"file",accept:"image/*",className:"d-none",onChange:wt}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary w-100",onClick:()=>{var O;return(O=te.current)==null?void 0:O.click()},disabled:Ce,style:{borderRadius:"10px"}},Ce?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang upload..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-upload me-2"}),"Upload \u1EA3nh")),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"Ho\u1EB7c URL \u1EA3nh"),React.createElement("input",{type:"url",className:"form-control",value:A.image,onChange:O=>k({...A,image:O.target.value}),placeholder:"https://...",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"8px",fontSize:"0.875rem"}}))))),React.createElement("div",{className:"modal-footer",style:{border:"none",padding:"20px"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:H,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:J,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},J?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}const $t=t=>window.KTM.money.formatVND(t),bt=t=>{if(t==null||t==="")return[];let S=t;if(typeof S=="string"){const $=S.trim();if(!$)return[];try{S=JSON.parse($)}catch(H){return[]}}return Array.isArray(S)?S:[]},Ve=(t,S={})=>{var Ce;const $=bt(t).map(B=>{var te;return{name:String((te=B==null?void 0:B.name)!=null?te:"").trim(),options:Array.isArray(B==null?void 0:B.options)?B.options:[]}}).map(B=>({...B,options:B.options.map(te=>{var E;return{label:String((E=te==null?void 0:te.label)!=null?E:"").trim(),price:Number(te==null?void 0:te.price)}}).filter(te=>!!te.label)})).filter(B=>B.options.length>0);if(!$.length)return null;const H=Number.isFinite(S.maxGroups)?Math.max(1,Math.trunc(S.maxGroups)):1,Q=Number.isFinite(S.maxOptionsPerGroup)?Math.max(1,Math.trunc(S.maxOptionsPerGroup)):3,A=!!S.compact,k=String((Ce=S.className)!=null?Ce:"").trim(),J=$.slice(0,H),le=$.length-J.length;return React.createElement("div",{className:`ktm-variants-preview${A?" compact":""}${k?" "+k:""}`},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},J.map((B,te)=>{const E=B.name||"Bi\u1EBFn th\u1EC3",ce=B.options.slice(0,Q),We=B.options.length-ce.length;return React.createElement(React.Fragment,{key:`${E}-${te}`},React.createElement("span",{className:"ktm-chip ktm-chip-group"},E),ce.map((tt,Qe)=>{const st=tt.price,ft=Number.isFinite(st)&&st>=0?$t(Math.trunc(st)):"",rt=ft?`${tt.label} \xB7 ${ft}`:tt.label;return React.createElement("span",{key:`${E}-${te}-${Qe}`,className:"ktm-chip ktm-chip-option"},rt)}),We>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",We))}),le>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",le," nh\xF3m")))},Kt=(t,S)=>{const $=t._type==="product",H=t._type==="album",Q=t._type==="video",A=t.note&&(t.note.toLowerCase().includes("free")||t.note.toLowerCase().includes("gi\u1EA3m")||t.note.toLowerCase().includes("sale")),k=$?Ve(t.variants,{compact:fe==="grid",maxGroups:1,maxOptionsPerGroup:fe==="grid"?2:3,className:fe==="grid"?"meta text-muted":"text-muted"}):null;return fe==="grid"?React.createElement("div",{key:t.id||S,className:"grid-card"},React.createElement("div",{className:"thumb-wrap",onClick:()=>Le({url:t.image,name:t.name,price:t.price,note:t.note,item:t})},t.image?React.createElement("img",{src:t.image,alt:t.name,className:"thumb",loading:"lazy"}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${Q?"fa-video":"fa-image"} fa-2x text-muted`})),t.price&&React.createElement("div",{className:"price-overlay"},t.price.replace(/[đ\s]/g,""),"\u0111"),React.createElement("span",{className:`type-badge ${$?"product":H?"album":"video"}`},$?"SP":H?"\u1EA2nh":"Video"),A&&React.createElement("span",{className:"promo-badge"},"\u{1F525} \u01AFU \u0110\xC3I")),React.createElement("div",{className:"card-body"},React.createElement("div",{className:"name"},t.name),t.note&&React.createElement("div",{className:"meta text-info",style:{fontSize:10}},t.note),k&&React.createElement("div",{style:{marginTop:2}},k),React.createElement("div",{className:"quick-copy"},React.createElement("button",{className:se===t.id+"-img"?"copied":"",onClick:()=>et(t.image,t.id)},React.createElement("i",{className:"fas fa-image"})),t.price&&React.createElement("button",{className:se===t.id+"-price"?"copied":"",onClick:()=>ze(t.price.replace(/[đ\s]/g,""),t.id+"-price")},React.createElement("i",{className:"fas fa-tag"}))))):React.createElement("div",{key:t.id||S,className:"product-card-mobile"},React.createElement("span",{className:`type-badge ${$?"product":H?"album":"video"}`},$?"S\u1EA3n ph\u1EA9m":H?"\u1EA2nh":"Video"),React.createElement("div",{className:"card-inner"},t.image?React.createElement("img",{src:t.image,alt:t.name,className:"thumb",loading:"lazy",onClick:()=>Le({url:t.image,name:t.name,price:t.price,note:t.note,item:t})}):React.createElement("div",{className:"thumb d-flex align-items-center justify-content-center bg-light"},React.createElement("i",{className:`fas ${Q?"fa-video":"fa-image"} fa-2x text-muted`})),React.createElement("div",{className:"info"},React.createElement("div",null,React.createElement("div",{className:"name"},t.name),React.createElement("div",{className:"price-row"},t.price&&React.createElement("span",{className:"price"},t.price.replace(/[đ\s]/g,""),"\u0111"),A&&React.createElement("span",{className:"badge-promo"},"\u{1F525} \u01AFU \u0110\xC3I")),k&&React.createElement("div",{style:{marginTop:4}},k)),React.createElement("div",{className:"meta"},t.code&&React.createElement("span",{className:"meta-tag"},"#",t.code),t.category&&React.createElement("span",{className:"meta-tag"},t.category),t.note&&React.createElement("span",{className:"meta-tag highlight"},t.note),t.folder&&React.createElement("span",{className:"meta-tag"},t.folder),Q&&React.createElement("span",{className:"meta-tag"},React.createElement("i",{className:"fab fa-youtube text-danger"})," Video")))),React.createElement("div",{className:"quick-actions"},$&&React.createElement("button",{onClick:()=>f&&f("orders","create",{productId:t.id})},React.createElement("i",{className:"fas fa-receipt"})," T\u1EA1o \u0111\u01A1n"),t.price&&React.createElement("button",{className:se===t.id+"-price"?"copied":"",onClick:()=>ze(t.price.replace(/[đ\s]/g,""),t.id+"-price")},React.createElement("i",{className:"fas fa-tag"})," Gi\xE1"),React.createElement("button",{className:se===t.id+"-name"?"copied":"",onClick:()=>ze(t.name,t.id+"-name")},React.createElement("i",{className:"fas fa-font"})," T\xEAn"),Q&&t.youtubeId&&React.createElement("button",{className:se===t.id+"-yt"?"copied":"",onClick:()=>ze(`https://www.youtube.com/watch?v=${t.youtubeId}`,t.id+"-yt")},React.createElement("i",{className:"fab fa-youtube"})),$&&React.createElement("button",{className:"action-edit",onClick:()=>Mt(t)},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"action-delete",onClick:()=>Rt(t)},React.createElement("i",{className:"fas fa-trash"}))))},[ut,$e]=useState(!1);return React.createElement(React.Fragment,null,React.createElement("div",{className:"result-header"},React.createElement("span",null,React.createElement("strong",null,U.length)," k\u1EBFt qu\u1EA3",Ne&&C.length>=3&&React.createElement("span",{className:"ai-badge ms-2"},React.createElement("i",{className:"fas fa-robot"})," AI"),ue!=="all"&&React.createElement("span",{className:"ms-2 badge bg-warning text-dark"},ue==="product"?"S\u1EA3n ph\u1EA9m":ue==="album"?"\u1EA2nh":"Video")),React.createElement("div",{className:"d-flex gap-1 align-items-center"},React.createElement("button",{className:`btn btn-sm ${fe==="list"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>ie("list"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-list"})),React.createElement("button",{className:`btn btn-sm ${fe==="grid"?"btn-dark":"btn-outline-secondary"}`,onClick:()=>ie("grid"),style:{padding:"4px 8px"}},React.createElement("i",{className:"fas fa-th"})))),React.createElement("div",{className:"search-results-area"},ee?React.createElement("div",null,[...Array(8)].map((t,S)=>React.createElement("div",{key:S,className:"product-card-mobile mb-2",style:{opacity:.7}},React.createElement("div",{className:"card-inner"},React.createElement("div",{className:"thumb bg-light",style:{width:80,height:80,borderRadius:8}}),React.createElement("div",{className:"info",style:{flex:1,minWidth:0}},React.createElement("div",{className:"skeleton-box mb-2",style:{height:16,width:"60%",background:"#eee",borderRadius:4}}),React.createElement("div",{className:"skeleton-box mb-1",style:{height:12,width:"40%",background:"#f3f3f3",borderRadius:4}}),React.createElement("div",{className:"skeleton-box",style:{height:10,width:"30%",background:"#f3f3f3",borderRadius:4}})))))):U.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-search"}),React.createElement("p",null,'Kh\xF4ng t\xECm th\u1EA5y "',C,'"'),React.createElement("button",{className:"btn btn-warning",onClick:()=>{z(""),Fe("")}},"Xem t\u1EA5t c\u1EA3")):fe==="grid"?React.createElement("div",{className:"product-grid-mobile"},U.map((t,S)=>Kt(t,S))):React.createElement("div",null,U.map((t,S)=>Kt(t,S)))),ut&&React.createElement("div",{className:"filter-dropdown"},React.createElement("div",{className:"filter-header"},React.createElement("strong",null,"L\u1ECDc theo lo\u1EA1i"),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>$e(!1)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"filter-chips"},React.createElement("span",{className:`filter-chip ${ue==="all"?"active":""}`,onClick:()=>{qe("all"),$e(!1)}},"T\u1EA5t c\u1EA3"),React.createElement("span",{className:`filter-chip ${ue==="product"?"active":""}`,onClick:()=>{qe("product"),$e(!1)}},React.createElement("i",{className:"fas fa-box me-1"}),"S\u1EA3n ph\u1EA9m"),React.createElement("span",{className:`filter-chip ${ue==="album"?"active":""}`,onClick:()=>{qe("album"),$e(!1)}},React.createElement("i",{className:"fas fa-images me-1"}),"\u1EA2nh"),React.createElement("span",{className:`filter-chip ${ue==="video"?"active":""}`,onClick:()=>{qe("video"),$e(!1)}},React.createElement("i",{className:"fas fa-video me-1"}),"Video")),React.createElement("div",{className:"mt-3 pt-3 border-top d-flex align-items-center justify-content-between"},React.createElement("span",null,"AI Search th\xF4ng minh"),React.createElement("div",{className:"form-check form-switch m-0"},React.createElement("input",{type:"checkbox",className:"form-check-input",checked:Ne,onChange:t=>Oe(t.target.checked),style:{width:40,height:20}})))),React.createElement("div",{className:"search-bar-bottom"},React.createElement("div",{className:"search-input-wrap"},React.createElement("input",{ref:Ae,type:"text",className:"search-input",placeholder:"\u{1F50D} T\xECm: van 3 tay, xylanh...",value:C,onChange:t=>Fe(t.target.value)}),React.createElement("button",{className:`filter-btn ${ut||ue!=="all"?"active":""}`,onClick:()=>$e(!ut)},React.createElement("i",{className:"fas fa-filter"})))),React.createElement("button",{className:"btn btn-lg rounded-circle position-fixed shadow-lg",style:{bottom:h?320:130,right:16,width:56,height:56,zIndex:1050,transition:"bottom 0.2s ease",background:"linear-gradient(135deg, #667eea, #764ba2)",color:"#fff",border:"none",WebkitTapHighlightColor:"transparent",touchAction:"manipulation",cursor:"pointer",outline:"none"},onClick:()=>i(!0),onTouchStart:()=>i(!0)},React.createElement("i",{className:"fas fa-robot fa-lg"})),w&&React.createElement("div",{className:"ai-chat-mobile"},React.createElement("div",{className:"chat-header"},React.createElement("button",{className:"back-btn",onClick:()=>i(!1)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("div",null,React.createElement("strong",null,"KTM AI Assistant"),React.createElement("div",{style:{fontSize:11,opacity:.8}},"H\u1ECFi v\u1EC1 s\u1EA3n ph\u1EA9m, gi\xE1 c\u1EA3..."))),React.createElement("div",{className:"chat-messages"},x.map((t,S)=>React.createElement("div",{key:S,className:`mb-3 ${t.role==="user"?"d-flex justify-content-end":""}`},React.createElement("div",{className:`p-3 rounded-3 position-relative ${t.role==="user"?"text-white":"bg-white border"}`,style:{maxWidth:"85%",whiteSpace:"pre-wrap",background:t.role==="user"?"linear-gradient(135deg, #667eea, #764ba2)":void 0}},t.content,t.role==="assistant"&&React.createElement("button",{className:"btn btn-sm position-absolute",style:{top:4,right:4,padding:"2px 6px",fontSize:11,background:se===`chat-${S}`?"#28a745":"rgba(0,0,0,0.1)",border:"none",borderRadius:4,color:se===`chat-${S}`?"#fff":"#666"},onClick:()=>{window.KTM.clipboard.writeText(t.content),me(`chat-${S}`),setTimeout(()=>me(null),1500)}},React.createElement("i",{className:`fas ${se===`chat-${S}`?"fa-check":"fa-copy"}`})),t.attachments&&t.attachments.length>0&&React.createElement("div",{className:"mt-2 d-flex flex-wrap gap-2"},t.attachments.map(($,H)=>React.createElement("div",{key:H,style:{width:70},className:"text-center"},$.image&&React.createElement("img",{src:$.image,className:"rounded",style:{width:70,height:50,objectFit:"cover",cursor:"pointer"},onClick:()=>Le({url:$.image,name:$.name,price:$.price})}),React.createElement("div",{style:{fontSize:9},className:"text-truncate"},$.name),$.price&&React.createElement("div",{style:{fontSize:10,color:"#dc3545",fontWeight:600}},$.price.replace(/[đ\s]/g,""),"\u0111"))))))),W&&React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"bg-white border p-3 rounded-3 d-inline-block"},React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang suy ngh\u0129...")),React.createElement("div",{ref:R})),React.createElement("div",{className:"px-3 py-2 border-top d-flex gap-2 overflow-auto"},["Gi\xE1 van 2 tay?","Combo r\u1EBB nh\u1EA5t?","Freeship?","Van 3 tay?"].map(t=>React.createElement("button",{key:t,className:"btn btn-sm btn-outline-secondary flex-shrink-0",onClick:()=>nt(t),disabled:W,style:{whiteSpace:"nowrap"}},t))),React.createElement("div",{className:"chat-input-area"},React.createElement("form",{onSubmit:t=>{t.preventDefault(),nt(I)},className:"chat-input-wrap"},React.createElement("input",{ref:r,type:"text",className:"chat-input",placeholder:"Nh\u1EADp c\xE2u h\u1ECFi...",value:I,onChange:t=>ae(t.target.value),disabled:W}),React.createElement("button",{type:"submit",className:"send-btn",disabled:W||!I.trim()},React.createElement("i",{className:"fas fa-paper-plane"}))))),oe&&React.createElement("div",{className:"preview-modal",onClick:()=>Le(null)},React.createElement("div",{className:"preview-header"},React.createElement("div",null),React.createElement("button",{className:"close-btn",onClick:()=>Le(null)},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"preview-body",onClick:t=>t.stopPropagation()},React.createElement("img",{src:oe.url,alt:oe.name})),React.createElement("div",{className:"preview-footer",onClick:t=>t.stopPropagation()},React.createElement("div",{className:"name"},oe.name),oe.price&&React.createElement("div",{className:"price"},oe.price.replace(/[đ\s]/g,""),"\u0111"),oe.note&&React.createElement("div",{className:"mb-2",style:{fontSize:14,color:"#17a2b8"}},oe.note),React.createElement("div",{className:"action-btns"},React.createElement("button",{className:se==="preview-img"?"btn-success text-white":"btn-outline-light text-white",style:{background:se==="preview-img"?"#28a745":"rgba(255,255,255,0.2)"},onClick:()=>et(oe.url,"preview")},React.createElement("i",{className:`fas ${se==="preview-img"?"fa-check":"fa-copy"}`}),"Copy \u1EA3nh"),oe.price&&React.createElement("button",{className:se==="preview-price"?"btn-success text-white":"btn-warning",onClick:()=>ze(oe.price.replace(/[đ\s]/g,""),"preview-price")},React.createElement("i",{className:`fas ${se==="preview-price"?"fa-check":"fa-tag"}`}),"Copy gi\xE1")))),React.createElement(Ct,{show:P,product:it,categories:re,onClose:()=>{Me(!1),Pe(null)},onSave:Pt}),React.createElement("div",{className:`fab-container mobile-only ${h?"open":""}`},React.createElement("div",{className:"fab-actions"},React.createElement("button",{className:"fab-action product",onClick:()=>{K(!1),Me(!0),Pe(null)}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",{className:"tooltip"},"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("button",{className:"fab-action product",onClick:()=>{K(!1),f&&f("orders","create")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",{className:"tooltip"},"T\u1EA1o order nhanh"))),React.createElement("button",{className:`fab-main ${h?"open":""}`,onClick:()=>K(!h)},React.createElement("i",{className:"fas fa-plus"}))),je&&b&&React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.6)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16,maxHeight:"90vh"}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ff9800)",border:"none"}},React.createElement("h6",{className:"modal-title fw-bold"},React.createElement("i",{className:"fas fa-pen me-2"}),"S\u1EEDa nhanh"),React.createElement("button",{type:"button",className:"btn-close",onClick:()=>l(!1)})),React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"T\xEAn s\u1EA3n ph\u1EA9m"),React.createElement("input",{type:"text",className:"form-control",value:Ke.name,onChange:t=>Ue({...Ke,name:t.target.value})})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:Ke.code,onChange:t=>Ue({...Ke,code:t.target.value})})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label small fw-semibold"},"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:Ke.price,onChange:t=>Ue({...Ke,price:t.target.value})}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:Ke.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:t=>Ue({...Ke,commission_percent:t.target.value})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:Ke.category,onChange:t=>Ue({...Ke,category:t.target.value})},React.createElement("option",{value:""},"-- Ch\u1ECDn danh m\u1EE5c --"),mt.map(t=>React.createElement("option",{key:t,value:t},t)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label small fw-semibold"},"Ghi ch\xFA (\u01B0u \u0111\xE3i)"),React.createElement("input",{type:"text",className:"form-control",value:Ke.note,placeholder:"VD: Free ship, Gi\u1EA3m 10%...",onChange:t=>Ue({...Ke,note:t.target.value})}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>l(!1)},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-warning",onClick:yt},React.createElement("i",{className:"fas fa-save me-1"}),"L\u01B0u"))))))}function VideoList({onRefresh:N,showToast:f}){const[C,z]=useState([]),[U,v]=useState([]),[D,Z]=useState(!0),[re,V]=useState(null),[ue,Se]=useState(!1),[se,me]=useState(null),[fe,ie]=useState(!1),[ee,de]=useState(null),[ke,he]=useState(null),[De,be]=useState([]);useEffect(()=>{Ae()},[]);const Ae=async(l=null)=>{Z(!0);try{const b=l?`${API_BASE}/api/video-folders?withVideos=true&parent_id=${l}`:`${API_BASE}/api/video-folders?withVideos=true&parent_id=root`,ge=await window.KTM.api.getJSON(b,"L\u1ED7i t\u1EA3i danh s\xE1ch folder");z(Array.isArray(ge)?ge:[])}catch(b){console.error(b),f("L\u1ED7i t\u1EA3i danh s\xE1ch folder","danger")}Z(!1)},Ne=async l=>{try{const b=await window.KTM.api.getJSON(`${API_BASE}/api/videos?folderId=${l}`,"L\u1ED7i t\u1EA3i video");v(Array.isArray(b)?b:[])}catch(b){console.error(b)}},Oe=async l=>{if(l===0)return;const b=[...C];[b[l-1],b[l]]=[b[l],b[l-1]],z(b),await _e(b)},Ze=async l=>{if(l===C.length-1)return;const b=[...C];[b[l],b[l+1]]=[b[l+1],b[l]],z(b),await _e(b)},_e=async l=>{try{await Promise.all(l.map((b,ge)=>window.KTM.api.putJSON(`${API_BASE}/api/video-folders/${b.id}`,{sortOrder:ge},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),f("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(b){f("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),Ae(ke==null?void 0:ke.id)}},Ie=async l=>{if(l===0)return;const b=[...U];[b[l-1],b[l]]=[b[l],b[l-1]],v(b),await i(b)},w=async l=>{if(l===U.length-1)return;const b=[...U];[b[l],b[l+1]]=[b[l+1],b[l]],v(b),await i(b)},i=async l=>{try{await Promise.all(l.map((b,ge)=>window.KTM.api.putJSON(`${API_BASE}/api/videos/${b.id}`,{sort_order:ge},"L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1"))),f("\u0110\xE3 c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1!","success")}catch(b){f("L\u1ED7i c\u1EADp nh\u1EADt th\u1EE9 t\u1EF1","danger"),Ne(re.id)}},x=()=>{me(null),Se(!0)},j=l=>{me(l),Se(!0)},I=async l=>{try{!se&&ke&&(l.parent_id=ke.id);const b=se?`${API_BASE}/api/video-folders/${se.id}`:`${API_BASE}/api/video-folders`;se?await window.KTM.api.putJSON(b,l,"L\u1ED7i l\u01B0u folder"):await window.KTM.api.postJSON(b,l,"L\u1ED7i l\u01B0u folder"),f(se?"\u0110\xE3 c\u1EADp nh\u1EADt folder!":"\u0110\xE3 t\u1EA1o folder m\u1EDBi!","success"),Se(!1),Ae(ke==null?void 0:ke.id)}catch(b){f(b.message,"danger")}},ae=async l=>{const b=l.subfolderCount>0?`X\xF3a folder "${l.name}"? T\u1EA5t c\u1EA3 subfolder v\xE0 videos b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`:`X\xF3a folder "${l.name}"? Videos trong folder s\u1EBD kh\xF4ng b\u1ECB x\xF3a.`;if(confirm(b))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/video-folders/${l.id}`,"L\u1ED7i x\xF3a folder"),f("\u0110\xE3 x\xF3a folder","success"),V(null),Ae(ke==null?void 0:ke.id)}catch(ge){f("L\u1ED7i x\xF3a folder","danger")}},W=l=>{l.subfolderCount>0?(be(b=>[...b,l]),he(l),Ae(l.id)):(V(l),v(l.videos||[]))},q=l=>{if(l==="root")be([]),he(null),Ae(null);else if(l){const b=De.findIndex(ge=>ge.id===l.id);b>=0&&(be(De.slice(0,b+1)),he(l),Ae(l.id))}else{const b=[...De];b.pop();const ge=b[b.length-1]||null;be(b),he(ge),Ae(ge==null?void 0:ge.id)}},R=()=>{de(null),ie(!0)},r=l=>{de(l),ie(!0)},oe=async l=>{try{l.folder_id=re==null?void 0:re.id;const b=ee?`${API_BASE}/api/videos/${ee.id}`:`${API_BASE}/api/videos`;ee?await window.KTM.api.putJSON(b,l,"L\u1ED7i l\u01B0u video"):await window.KTM.api.postJSON(b,l,"L\u1ED7i l\u01B0u video"),f(ee?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm video th\xE0nh c\xF4ng!","success"),ie(!1),Ae(),re&&Ne(re.id)}catch(b){f(b.message,"danger")}},Le=async l=>{if(confirm(`X\xF3a video "${l.title}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/videos/${l.id}`,"L\u1ED7i x\xF3a video"),f("\u0110\xE3 x\xF3a video","success"),Ae(),re&&Ne(re.id)}catch(b){f("L\u1ED7i x\xF3a video","danger")}},je=l=>{const b=`https://www.youtube.com/watch?v=${l.youtubeId}`;window.KTM.clipboard.writeText(b).then(()=>{f("\u0110\xE3 copy link!","success")}).catch(()=>{f("Kh\xF4ng th\u1EC3 copy link","danger")})};return re?React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-4"},React.createElement("div",{className:"d-flex align-items-center"},React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>V(null)},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:`fas fa-folder-open me-2 ${re.slug==="shorts"?"text-danger":"text-warning"}`}),re.name)),React.createElement("button",{className:"btn btn-warning",onClick:R},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm Video")),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1 videos"),U.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-video fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},"Ch\u01B0a c\xF3 video trong folder n\xE0y")):React.createElement("div",{className:"row g-4"},U.map((l,b)=>React.createElement("div",{key:l.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>Ie(b),disabled:b===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},b+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:()=>w(b),disabled:b===U.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"position-relative"},React.createElement("img",{src:l.thumb,className:"card-img-top",alt:l.title,style:{height:"120px",objectFit:"cover"}}),React.createElement("a",{href:`https://www.youtube.com/watch?v=${l.youtubeId}`,target:"_blank",className:"position-absolute top-50 start-50 translate-middle"},React.createElement("i",{className:"fas fa-play-circle fa-3x text-white",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"}}))),React.createElement("div",{className:"card-body py-2"},React.createElement("h6",{className:"card-title small mb-1 text-truncate",title:l.title},l.title),React.createElement("small",{className:"text-muted"},l.youtubeId)),React.createElement("div",{className:"card-footer bg-transparent border-0 pt-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-primary",onClick:()=>je(l),title:"Copy link"},React.createElement("i",{className:"fas fa-link"})),React.createElement("button",{className:"btn btn-outline-secondary",onClick:()=>r(l),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-edit"})),React.createElement("button",{className:"btn btn-outline-danger",onClick:()=>Le(l),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))))),React.createElement(VideoModal,{show:fe,video:ee,onClose:()=>ie(!1),onSave:oe})):React.createElement("div",null,React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("div",{className:"d-flex align-items-center"},ke&&React.createElement("button",{className:"btn btn-outline-secondary me-3",onClick:()=>q()},React.createElement("i",{className:"fas fa-arrow-left"})),React.createElement("h4",{className:"m-0"},React.createElement("i",{className:"fas fa-video me-2 text-warning"}),ke?ke.name:"Qu\u1EA3n l\xFD Video")),React.createElement("button",{className:"btn btn-warning",onClick:x},React.createElement("i",{className:"fas fa-folder-plus me-2"}),"T\u1EA1o Folder")),De.length>0&&React.createElement("nav",{"aria-label":"breadcrumb",className:"mb-3"},React.createElement("ol",{className:"breadcrumb mb-0"},React.createElement("li",{className:"breadcrumb-item"},React.createElement("a",{href:"#",onClick:l=>{l.preventDefault(),q("root")},className:"text-warning"},React.createElement("i",{className:"fas fa-home"}))),De.map((l,b)=>React.createElement("li",{key:l.id,className:`breadcrumb-item ${b===De.length-1?"active":""}`},b===De.length-1?l.name:React.createElement("a",{href:"#",onClick:ge=>{ge.preventDefault(),q(l)},className:"text-warning"},l.name))))),React.createElement("p",{className:"text-muted small mb-3"},React.createElement("i",{className:"fas fa-info-circle me-1"}),"D\xF9ng n\xFAt \u2191\u2193 \u0111\u1EC3 s\u1EAFp x\u1EBFp th\u1EE9 t\u1EF1. Click v\xE0o folder \u0111\u1EC3 v\xE0o b\xEAn trong."),D?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning"})):C.length===0?React.createElement("div",{className:"text-center py-5"},React.createElement("i",{className:"fas fa-folder-open fa-3x text-muted mb-3"}),React.createElement("p",{className:"text-muted"},ke?"Folder n\xE0y \u0111ang tr\u1ED1ng":"Ch\u01B0a c\xF3 folder video n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:x},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o folder",ke?" con":" \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"row g-3"},C.map((l,b)=>{var ge,h,K,P;return React.createElement("div",{key:l.id,className:"col-6 col-md-4 col-lg-3"},React.createElement("div",{className:"card h-100 folder-card"},React.createElement("div",{className:"card-header bg-transparent py-1 d-flex justify-content-center gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Me=>{Me.stopPropagation(),Oe(b)},disabled:b===0,title:"Di chuy\u1EC3n l\xEAn"},React.createElement("i",{className:"fas fa-chevron-up"})),React.createElement("span",{className:"text-muted small px-1"},b+1),React.createElement("button",{className:"btn btn-sm btn-outline-secondary px-2 py-0",onClick:Me=>{Me.stopPropagation(),Ze(b)},disabled:b===C.length-1,title:"Di chuy\u1EC3n xu\u1ED1ng"},React.createElement("i",{className:"fas fa-chevron-down"}))),React.createElement("div",{className:"card-body text-center py-3",onClick:()=>W(l),style:{cursor:"pointer"}},React.createElement("i",{className:`fas fa-folder fa-3x mb-3 ${l.slug==="shorts"?"text-danger":"text-warning"}`}),React.createElement("h5",{className:"card-title"},l.name),React.createElement("p",{className:"text-muted mb-0"},l.subfolderCount>0&&React.createElement("span",null,React.createElement("i",{className:"fas fa-folder me-1"}),l.subfolderCount," folder"),l.subfolderCount>0&&(l.videoCount>0||((ge=l.videos)==null?void 0:ge.length)>0)&&" \u2022 ",(l.videoCount>0||((h=l.videos)==null?void 0:h.length)>0)&&React.createElement("span",null,React.createElement("i",{className:"fas fa-video me-1"}),l.videoCount||((K=l.videos)==null?void 0:K.length)||0," videos"),l.subfolderCount===0&&!l.videoCount&&!((P=l.videos)!=null&&P.length)&&"Tr\u1ED1ng")),React.createElement("div",{className:"card-footer bg-transparent border-0"},React.createElement("div",{className:"btn-group btn-group-sm w-100"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:Me=>{Me.stopPropagation(),j(l)}},React.createElement("i",{className:"fas fa-edit"})," S\u1EEDa"),React.createElement("button",{className:"btn btn-outline-danger",onClick:Me=>{Me.stopPropagation(),ae(l)}},React.createElement("i",{className:"fas fa-trash"})," X\xF3a")))))})),React.createElement(VideoFolderModal,{show:ue,folder:se,onClose:()=>Se(!1),onSave:I}))}function VideoFolderModal({show:N,folder:f,onClose:C,onSave:z}){const[U,v]=useState({name:"",description:"",sortOrder:0,coverImage:""}),[D,Z]=useState(!1),[re,V]=useState(!1);useEffect(()=>{v(f?{name:f.name||"",description:f.description||"",sortOrder:f.sortOrder||0,coverImage:f.coverImage||""}:{name:"",description:"",sortOrder:0,coverImage:""})},[f,N]);const ue=async se=>{const me=se.target.files[0];if(me){V(!0);try{const fe=await window.KTM.cloudinary.uploadImage({file:me,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});fe.secure_url&&v(ie=>({...ie,coverImage:fe.secure_url})),window.KTM.cache.remove(CACHE_KEY),showToast("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!","success"),setShowQuickEdit(!1),setEditingItem(null),loadAllData()}catch(fe){console.error("Cloudinary upload error:",fe),alert("L\u1ED7i upload \u1EA3nh: "+(fe.message||fe))}finally{V(!1)}}},Se=async se=>{se.preventDefault(),Z(!0),await z(U),Z(!1)};return N?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},f?"S\u1EEDa Folder":"T\u1EA1o Folder m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:C})),React.createElement("form",{onSubmit:Se},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"T\xEAn folder *"),React.createElement("input",{type:"text",className:"form-control",value:U.name,onChange:se=>v({...U,name:se.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"M\xF4 t\u1EA3"),React.createElement("textarea",{className:"form-control",value:U.description,onChange:se=>v({...U,description:se.target.value}),rows:"2"})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:U.sortOrder,onChange:se=>v({...U,sortOrder:parseInt(se.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"\u1EA2nh b\xECa"),React.createElement("div",{className:"d-flex align-items-start gap-3"},U.coverImage?React.createElement("div",{className:"position-relative"},React.createElement("img",{src:U.coverImage,alt:"Cover",className:"rounded",style:{width:120,height:80,objectFit:"cover"}}),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger position-absolute top-0 end-0",onClick:()=>v({...U,coverImage:""}),style:{transform:"translate(30%, -30%)"}},React.createElement("i",{className:"fas fa-times"}))):React.createElement("div",{className:"bg-light rounded d-flex align-items-center justify-content-center text-muted",style:{width:120,height:80}},React.createElement("i",{className:"fas fa-image fa-2x"})),React.createElement("div",{className:"flex-grow-1"},React.createElement("input",{type:"file",className:"form-control form-control-sm",accept:"image/*,image/jpeg,image/png,image/gif,image/webp",onChange:ue,disabled:re}),re&&React.createElement("div",{className:"mt-1 text-muted small"},React.createElement("span",{className:"spinner-border spinner-border-sm me-1"}),"\u0110ang upload..."),React.createElement("div",{className:"mt-1 text-muted small"},"Ho\u1EB7c d\xE1n URL:"),React.createElement("input",{type:"url",className:"form-control form-control-sm",placeholder:"https://...",value:U.coverImage,onChange:se=>v({...U,coverImage:se.target.value})}))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:C},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:D},D?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function ProductManager({showToast:N,settings:f}){const[C,z]=useState([]),[U,v]=useState(!0),[D,Z]=useState(!1),[re,V]=useState(null),[ue,Se]=useState(""),[se,me]=useState(""),fe=normalizeShipPercent(f==null?void 0:f.ship_percent),{parseMoney:ie,formatVND:ee}=window.KTM.money,de=["Ty xy lanh","Combo Van 1 tay","Combo Van 2 tay","Combo Van 3 tay","Combo Van 4 tay","Combo Van 5 tay","Trang g\u1EA1t","Ph\u1EE5 ki\u1EC7n","Van \u0111i\u1EC1u khi\u1EC3n"];useEffect(()=>{ke()},[]);const ke=async()=>{v(!0);try{const i=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");z(Array.isArray(i)?i:[])}catch(i){console.error(i),N("L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m","danger")}v(!1)},he=()=>{V(null),Z(!0)},De=i=>{V(i),Z(!0)},be=async i=>{if(!(!i||!i.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:i},"L\u1ED7i x\xF3a \u1EA3nh"),window.KTM.cache.remove(CACHE_KEY),N(`\u0110\xE3 x\xF3a ${typeName}`,"success"),loadAllData(),ke()}catch(x){N("L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m","danger")}},Ae=async i=>{try{const x=re?`${API_BASE}/api/products?id=${re.id}`:`${API_BASE}/api/products`;re?await window.KTM.api.putJSON(x,i,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"):await window.KTM.api.postJSON(x,i,"L\u1ED7i l\u01B0u s\u1EA3n ph\u1EA9m"),N(re?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"Th\xEAm s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),Z(!1),ke()}catch(x){N(x.message,"danger")}},Ne=async i=>{if(confirm(`B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n x\xF3a s\u1EA3n ph\u1EA9m "${i.name}"?`))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/products?id=${i.id}`,"L\u1ED7i x\xF3a s\u1EA3n ph\u1EA9m"),N("X\xF3a s\u1EA3n ph\u1EA9m th\xE0nh c\xF4ng!","success"),ke()}catch(x){N(x.message,"danger")}},Oe=C.filter(i=>{const x=!ue||i.name.toLowerCase().includes(ue.toLowerCase())||i.code&&i.code.toLowerCase().includes(ue.toLowerCase()),j=!se||i.category===se;return x&&j}),Ze=i=>{var I;const x=(I=i==null?void 0:i.commission_percent)!=null?I:i==null?void 0:i.commissionPercent,j=x===""||x==null?NaN:Number(x);return Number.isFinite(j)?Math.max(0,Math.min(100,j)):5},_e=i=>{const x=Ze(i),j=Number.isInteger(x)?String(x):String(Math.round(x*100)/100),I=ie(i==null?void 0:i.price);if(!Number.isFinite(I)||I<=0)return`${j}%`;const ae=(Number(x)||0)/100,q=window.KTM.money.parseShipFeeFromNote(i==null?void 0:i.note)!=null?0:fe>0?I*fe/100:0,R=I*ae-q*ae,r=Math.max(0,Math.round(R));return`${j}% - ${ee(r)}`},Ie=i=>{if(i==null||i==="")return[];let x=i;if(typeof x=="string"){const j=x.trim();if(!j)return[];try{x=JSON.parse(j)}catch(I){return[]}}return Array.isArray(x)?x:[]},w=(i,x={})=>{const j=Ie(i).map(R=>{var r;return{name:String((r=R==null?void 0:R.name)!=null?r:"").trim(),options:Array.isArray(R==null?void 0:R.options)?R.options:[]}}).map(R=>({...R,options:R.options.map(r=>{var oe;return{label:String((oe=r==null?void 0:r.label)!=null?oe:"").trim(),price:Number(r==null?void 0:r.price)}}).filter(r=>!!r.label)})).filter(R=>R.options.length>0);if(!j.length)return null;const I=Number.isFinite(x.maxGroups)?Math.max(1,Math.trunc(x.maxGroups)):1,ae=Number.isFinite(x.maxOptionsPerGroup)?Math.max(1,Math.trunc(x.maxOptionsPerGroup)):4,W=j.slice(0,I),q=j.length-W.length;return React.createElement("div",{className:"ktm-variants-preview"},React.createElement("i",{className:"fas fa-layer-group"}),React.createElement("div",{className:"ktm-variants-chips"},W.map((R,r)=>{const oe=R.name||"Bi\u1EBFn th\u1EC3",Le=R.options.slice(0,ae),je=R.options.length-Le.length;return React.createElement(React.Fragment,{key:`${oe}-${r}`},React.createElement("span",{className:"ktm-chip ktm-chip-group"},oe),Le.map((l,b)=>{const ge=l.price,h=Number.isFinite(ge)&&ge>=0?ee(Math.trunc(ge)):"",K=h?`${l.label} \xB7 ${h}`:l.label;return React.createElement("span",{key:`${oe}-${r}-${b}`,className:"ktm-chip ktm-chip-option"},K)}),je>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",je))}),q>0&&React.createElement("span",{className:"ktm-chip ktm-chip-more"},"+",q," nh\xF3m")))};return React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",null,React.createElement("i",{className:"fas fa-box me-2"}),"S\u1EA3n ph\u1EA9m"),React.createElement("button",{className:"btn-add-product",onClick:he},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"d-flex gap-2 mb-2"},React.createElement("div",{className:"flex-grow-1 position-relative"},React.createElement("input",{type:"text",className:"form-control",placeholder:"\u{1F50D} T\xECm s\u1EA3n ph\u1EA9m...",value:ue,onChange:i=>Se(i.target.value)})),React.createElement("span",{className:"product-count"},Oe.length)),React.createElement("select",{className:"form-select",value:se,onChange:i=>me(i.target.value)},React.createElement("option",{value:""},"\u{1F4C1} T\u1EA5t c\u1EA3 danh m\u1EE5c"),de.map(i=>React.createElement("option",{key:i,value:i},i)))),U?React.createElement("div",{className:"text-center py-5"},React.createElement("div",{className:"spinner-border text-warning",style:{width:"2.5rem",height:"2.5rem"}}),React.createElement("p",{className:"text-muted mt-3 mb-0"},"\u0110ang t\u1EA3i...")):Oe.length===0?React.createElement("div",{className:"empty-state"},React.createElement("i",{className:"fas fa-box-open"}),React.createElement("p",null,"Ch\u01B0a c\xF3 s\u1EA3n ph\u1EA9m n\xE0o"),React.createElement("button",{className:"btn btn-warning",onClick:he},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m \u0111\u1EA7u ti\xEAn")):React.createElement("div",{className:"product-list"},Oe.map(i=>React.createElement("div",{key:i.id,className:"product-item d-flex align-items-center gap-3"},i.image?React.createElement("img",{src:i.image,alt:"",className:"product-img"}):React.createElement("div",{className:"product-img-placeholder"},React.createElement("i",{className:"fas fa-image text-muted"})),React.createElement("div",{className:"flex-grow-1 min-width-0"},React.createElement("div",{className:"product-name"},i.name),React.createElement("div",{className:"d-flex flex-wrap gap-1 mb-1"},i.category&&React.createElement("span",{className:"product-badge bg-info bg-opacity-75"},i.category),i.code&&React.createElement("span",{className:"product-badge bg-secondary"},i.code),React.createElement("span",{className:"product-badge bg-warning text-dark",title:"Hoa h\u1ED3ng (%)"},React.createElement("i",{className:"fas fa-percent me-1"}),_e(i))),React.createElement("div",{className:"product-price"},i.price?i.price.replace(/[đ\s]/g,"")+"\u0111":"Li\xEAn h\u1EC7"),i.note&&React.createElement("div",{className:"text-muted small mt-1",style:{fontSize:"0.75rem"}},i.note),w(i.variants,{maxGroups:1,maxOptionsPerGroup:4})&&React.createElement("div",{className:"mt-1",style:{fontSize:"0.75rem"}},w(i.variants,{maxGroups:1,maxOptionsPerGroup:4}))),React.createElement("div",{className:"product-actions"},React.createElement("button",{className:"btn btn-edit",onClick:()=>De(i),title:"S\u1EEDa"},React.createElement("i",{className:"fas fa-pen"})),React.createElement("button",{className:"btn btn-delete",onClick:()=>Ne(i),title:"X\xF3a"},React.createElement("i",{className:"fas fa-trash"})))))),React.createElement(ProductModal,{show:D,product:re,categories:de,onClose:()=>Z(!1),onSave:Ae}))}function ProductModal({show:N,product:f,categories:C,onClose:z,onSave:U}){const[v,D]=useState({name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[]}),[Z,re]=useState(!1),[V,ue]=useState(!1),Se=w=>{const i=window.KTM.money.getDigits(String(w!=null?w:"")),x=Number(i);return i&&Number.isFinite(x)?Math.trunc(x):0},se=(w,i)=>{if(w==null||w==="")return[];let x=w;if(typeof x=="string"){const I=x.trim();if(!I)return[];try{x=JSON.parse(I)}catch(ae){return[]}}if(!Array.isArray(x))return[];const j=Se(i);return x.map(I=>{var q;if(!I||typeof I!="object")return null;const ae=String((q=I.name)!=null?q:"").trim(),W=(Array.isArray(I.options)?I.options:[]).map(R=>{var b,ge,h,K,P,Me,it;if(!R||typeof R!="object")return null;const r=String((b=R.label)!=null?b:"").trim();if(!r)return null;const oe=(P=(K=(h=(ge=R.price)!=null?ge:R.priceValue)!=null?h:R.unit_price)!=null?K:R.unitPrice)!=null?P:null,Le=Number(oe);let je=Number.isFinite(Le)?Math.trunc(Le):null;if(je==null){const Pe=(it=(Me=R.price_delta)!=null?Me:R.priceDelta)!=null?it:null,Ke=Number(Pe);Number.isFinite(Ke)&&(je=j+Math.trunc(Ke))}je==null&&(je=j);const l=String(Math.max(0,Math.trunc(Number(je)||0)));return{label:r,price:Math.max(0,Math.trunc(Number(je)||0)),priceDigits:l}}).filter(Boolean);return{name:ae||"Bi\u1EBFn th\u1EC3",options:W}}).filter(Boolean)};useEffect(()=>{var w,i;D(f?{name:f.name||"",code:f.code||"",price:f.price||"",image:f.image||"",category:f.category||"",note:f.note||"",sort_order:f.sort_order||0,commission_percent:(i=(w=f.commission_percent)!=null?w:f.commissionPercent)!=null?i:5,variants:se(f.variants,f.price)}:{name:"",code:"",price:"",image:"",category:"",note:"",sort_order:0,commission_percent:5,variants:[]})},[f,N]);const me=w=>{D(i=>{var W;const x=Se(i.price),j=String(x),I=Array.isArray(i.variants)?[...i.variants]:[],ae={...I[w]||{},options:Array.isArray((W=I[w])==null?void 0:W.options)?[...I[w].options]:[]};return ae.options=ae.options.map(q=>({label:String((q==null?void 0:q.label)||""),price:x,priceDigits:j})),I[w]=ae,{...i,variants:I}})},fe=()=>{D(w=>{const i=Se(w.price),x=String(i),I=(Array.isArray(w.variants)?[...w.variants]:[]).map(ae=>{const W=(Array.isArray(ae==null?void 0:ae.options)?ae.options:[]).map(q=>({label:String((q==null?void 0:q.label)||""),price:i,priceDigits:x}));return{name:String((ae==null?void 0:ae.name)||"Bi\u1EBFn th\u1EC3"),options:W}});return{...w,variants:I}})},[ie,ee]=React.useState(""),de=w=>window.KTM.money.formatVNDInputDigits(w),[ke,he]=React.useState(""),De=w=>{const i=window.KTM.money.nextPriceInputState(w.target.value,ke);he(i.digits),D({...v,price:i.price})},[be,Ae]=React.useState("");React.useEffect(()=>{f!=null&&f.image&&Ae(f.image)},[f]);const Ne=async w=>{if(!(!w||!w.includes("cloudinary.com")))try{await window.KTM.api.postJSON(`${API_BASE}/api/products?action=delete-image`,{url:w},"L\u1ED7i x\xF3a \u1EA3nh")}catch(i){console.error("Delete cloudinary image error:",i)}},Oe=async(w,i=2,x)=>{const j=i*1024*1024,I=w.type==="image/heic"||w.type==="image/heif"||/\.heic$/i.test(w.name);if(w.size<=j&&!I)return w;x==null||x("\u0110ang x\u1EED l\xFD \u1EA3nh...");try{const ae=await createImageBitmap(w);x==null||x("\u0110ang n\xE9n \u1EA3nh...");const W=document.createElement("canvas");let q=ae.width,R=ae.height;const r=1200;return(q>r||R>r)&&(q>R?(R=Math.round(R/q*r),q=r):(q=Math.round(q/R*r),R=r)),W.width=q,W.height=R,W.getContext("2d").drawImage(ae,0,0,q,R),ae.close(),new Promise((Le,je)=>{W.toBlob(l=>{l?(x==null||x("Ho\xE0n t\u1EA5t!"),Le(new File([l],w.name.replace(/\.[^.]+$/,".jpg"),{type:"image/jpeg"}))):je(new Error("Kh\xF4ng n\xE9n \u0111\u01B0\u1EE3c \u1EA3nh"))},"image/jpeg",.7)})}catch(ae){throw console.error("createImageBitmap error:",ae),new Error("Kh\xF4ng th\u1EC3 x\u1EED l\xFD \u1EA3nh. Th\u1EED ch\u1ECDn \u1EA3nh kh\xE1c.")}},Ze=async w=>{var j,I;const i=(j=w.target.files)==null?void 0:j[0];if(!i)return;if(!(i.type.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(i.name))){alert("Vui l\xF2ng ch\u1ECDn file \u1EA3nh!");return}ue(!0),ee("\u0110ang chu\u1EA9n b\u1ECB...");try{const ae=(i.size/1024/1024).toFixed(1);ee(`File ${ae}MB - \u0110ang n\xE9n...`);const W=await Oe(i,2,r=>{ee(r)}),q=(W.size/1024/1024).toFixed(1);ee(`\u0110\xE3 n\xE9n: ${q}MB - \u0110ang upload...`);const R=await window.KTM.cloudinary.uploadImage({file:W,cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET});R.secure_url?(v.image&&v.image!==be&&Ne(v.image),D(r=>({...r,image:R.secure_url})),ee("")):(console.error("Cloudinary error:",R),alert("Upload th\u1EA5t b\u1EA1i: "+(((I=R.error)==null?void 0:I.message)||"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh")),ee(""))}catch(ae){console.error("Upload error:",ae),alert("L\u1ED7i: "+ae.message),ee("")}ue(!1),w.target.value=""},_e=()=>{v.image&&(v.image!==be&&Ne(v.image),D(w=>({...w,image:""})))},Ie=async w=>{w.preventDefault(),re(!0),be&&v.image&&be!==v.image&&await Ne(be),be&&!v.image&&await Ne(be),await U(v),re(!1)};return N?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down"},React.createElement("div",{className:"modal-content",style:{borderRadius:"16px",overflow:"hidden"}},React.createElement("div",{className:"modal-header border-0 py-3",style:{background:"linear-gradient(135deg, #ffc107 0%, #ffca2c 100%)"}},React.createElement("h6",{className:"modal-title fw-bold",style:{color:"#1a1a2e"}},React.createElement("i",{className:`fas ${f?"fa-edit":"fa-plus-circle"} me-2`}),f?"S\u1EEDa s\u1EA3n ph\u1EA9m":"Th\xEAm s\u1EA3n ph\u1EA9m m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:z})),React.createElement("form",{onSubmit:Ie},React.createElement("div",{className:"modal-body py-4",style:{maxHeight:"65vh",overflowY:"auto",background:"#f8f9fa"}},React.createElement("div",{className:"text-center mb-4"},React.createElement("div",{className:"position-relative d-inline-block"},v.image?React.createElement(React.Fragment,null,React.createElement("img",{src:v.image,alt:"",style:{width:110,height:110,objectFit:"cover",borderRadius:"12px",boxShadow:"0 4px 15px rgba(0,0,0,0.15)"}}),React.createElement("button",{type:"button",className:"btn btn-danger position-absolute",onClick:_e,style:{top:-10,right:-10,width:28,height:28,padding:0,borderRadius:"50%",boxShadow:"0 2px 8px rgba(220,53,69,0.4)"}},React.createElement("i",{className:"fas fa-times",style:{fontSize:"0.75rem"}}))):React.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{width:110,height:110,borderRadius:"12px",background:"linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)",border:"2px dashed #adb5bd"}},React.createElement("i",{className:"fas fa-image fa-2x text-muted"}))),React.createElement("div",{className:"mt-2"},React.createElement("label",{className:"btn btn-warning btn-sm px-3",style:{borderRadius:"20px"}},React.createElement("i",{className:`fas ${V?"fa-spinner fa-spin":"fa-camera"} me-1`}),V?ie||"\u0110ang x\u1EED l\xFD...":"Ch\u1ECDn \u1EA3nh",React.createElement("input",{type:"file",accept:"image/*",onChange:Ze,disabled:V,style:{position:"absolute",left:"-9999px",opacity:0,width:1,height:1}})),V&&ie&&React.createElement("div",{className:"text-center mt-1",style:{fontSize:11,color:"#6c757d"}},ie))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-tag me-1 text-warning"}),"T\xEAn s\u1EA3n ph\u1EA9m *"),React.createElement("input",{type:"text",className:"form-control",value:v.name,onChange:w=>D({...v,name:w.target.value}),required:!0,placeholder:"VD: Combo Van 3 tay + 2 xylanh",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"row g-2 mb-3"},React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-barcode me-1 text-info"}),"M\xE3 SP"),React.createElement("input",{type:"text",className:"form-control",value:v.code,onChange:w=>D({...v,code:w.target.value}),placeholder:"KTM-01",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"col-6"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-dollar-sign me-1 text-success"}),"Gi\xE1"),React.createElement("input",{type:"text",className:"form-control",value:v.price,onChange:De,placeholder:"1.950.000\u0111",inputMode:"numeric",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}}))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-percent me-1 text-secondary"}),"Hoa h\u1ED3ng (%)"),React.createElement("input",{type:"number",className:"form-control",value:v.commission_percent,min:0,max:100,step:.01,placeholder:"5",onChange:w=>D({...v,commission_percent:w.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-folder me-1 text-primary"}),"Danh m\u1EE5c"),React.createElement("select",{className:"form-select",value:v.category,onChange:w=>D({...v,category:w.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}},React.createElement("option",{value:""},"Ch\u1ECDn danh m\u1EE5c"),C.map(w=>React.createElement("option",{key:w,value:w},w)))),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-sticky-note me-1 text-secondary"}),"Ghi ch\xFA"),React.createElement("input",{type:"text",className:"form-control",value:v.note,onChange:w=>D({...v,note:w.target.value}),placeholder:"VD: Th\xEAm d\xE2y l\xE0 2.150.000\u0111",style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"12px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label fw-semibold small text-dark mb-1"},React.createElement("i",{className:"fas fa-layer-group me-1 text-secondary"}),"Bi\u1EBFn th\u1EC3 (size, ...)"),React.createElement("div",{className:"border rounded-3 p-2",style:{background:"#fff"}},(Array.isArray(v.variants)?v.variants:[]).length===0?React.createElement("div",{className:"text-muted small"},"Ch\u01B0a c\xF3 bi\u1EBFn th\u1EC3."):null,(Array.isArray(v.variants)?v.variants:[]).map((w,i)=>React.createElement("div",{key:i,className:"mb-3"},React.createElement("div",{className:"d-flex gap-2 align-items-center mb-2"},React.createElement("input",{type:"text",className:"form-control",value:(w==null?void 0:w.name)||"",onChange:x=>{const j=x.target.value;D(I=>{var W;const ae=Array.isArray(I.variants)?[...I.variants]:[];return ae[i]={...ae[i]||{},name:j,options:Array.isArray((W=ae[i])==null?void 0:W.options)?ae[i].options:[]},{...I,variants:ae}})},placeholder:"T\xEAn nh\xF3m (v\xED d\u1EE5: Size)",style:{borderRadius:10}}),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>me(i),title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn trong nh\xF3m",disabled:!Array.isArray(w==null?void 0:w.options)||w.options.length===0},"\u0110\u1ED3ng gi\xE1"),React.createElement("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>{D(x=>{const j=Array.isArray(x.variants)?[...x.variants]:[];return j.splice(i,1),{...x,variants:j}})},title:"X\xF3a nh\xF3m"},React.createElement("i",{className:"fas fa-trash"}))),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(w==null?void 0:w.options)?w.options:[]).map((x,j)=>{var I,ae;return React.createElement("div",{key:j,className:"row g-2 align-items-center"},React.createElement("div",{className:"col-7"},React.createElement("input",{type:"text",className:"form-control",value:(x==null?void 0:x.label)||"",onChange:W=>{const q=W.target.value;D(R=>{var l,b,ge,h,K;const r=Array.isArray(R.variants)?[...R.variants]:[],oe={...r[i]||{},options:Array.isArray((l=r[i])==null?void 0:l.options)?[...r[i].options]:[]},Le=Number((ge=(b=oe.options[j])==null?void 0:b.price)!=null?ge:0)||0,je=String((K=(h=oe.options[j])==null?void 0:h.priceDigits)!=null?K:Math.max(0,Math.trunc(Le)));return oe.options[j]={...oe.options[j]||{},label:q,price:Math.max(0,Math.trunc(Le)),priceDigits:je},r[i]=oe,{...R,variants:r}})},placeholder:"Gi\xE1 tr\u1ECB (v\xED d\u1EE5: M)",style:{borderRadius:10}})),React.createElement("div",{className:"col-4"},React.createElement("input",{type:"text",className:"form-control",value:de(String((ae=x==null?void 0:x.priceDigits)!=null?ae:window.KTM.money.getDigits(String((I=x==null?void 0:x.price)!=null?I:"")))),onChange:W=>{D(q=>{var ge,h,K,P,Me;const R=String((h=x==null?void 0:x.priceDigits)!=null?h:window.KTM.money.getDigits(String((ge=x==null?void 0:x.price)!=null?ge:""))),r=window.KTM.money.nextPriceInputState(W.target.value,R),oe=String((K=r.digits)!=null?K:""),Le=Number(oe),je=Number.isFinite(Le)?Math.max(0,Math.trunc(Le)):0,l=Array.isArray(q.variants)?[...q.variants]:[],b={...l[i]||{},options:Array.isArray((P=l[i])==null?void 0:P.options)?[...l[i].options]:[]};return b.options[j]={...b.options[j]||{},label:String(((Me=b.options[j])==null?void 0:Me.label)||""),price:je,priceDigits:oe},l[i]=b,{...q,variants:l}})},placeholder:"Gi\xE1 (\u0111)",style:{borderRadius:10}})),React.createElement("div",{className:"col-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{D(W=>{var r;const q=Array.isArray(W.variants)?[...W.variants]:[],R={...q[i]||{},options:Array.isArray((r=q[i])==null?void 0:r.options)?[...q[i].options]:[]};return R.options.splice(j,1),q[i]=R,{...W,variants:q}})},title:"X\xF3a l\u1EF1a ch\u1ECDn"},React.createElement("i",{className:"fas fa-times"}))))})),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm mt-2",onClick:()=>{D(x=>{var W;const j=Array.isArray(x.variants)?[...x.variants]:[],I={...j[i]||{},options:Array.isArray((W=j[i])==null?void 0:W.options)?[...j[i].options]:[]},ae=Se(x.price);return I.options.push({label:"",price:ae,priceDigits:String(ae)}),j[i]=I,{...x,variants:j}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm l\u1EF1a ch\u1ECDn"))),React.createElement("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>{D(w=>{const i=Se(w.price),x=Array.isArray(w.variants)?[...w.variants]:[],j=String(i);return x.push({name:"Size",options:[{label:"S",price:i,priceDigits:j},{label:"M",price:i,priceDigits:j},{label:"L",price:i,priceDigits:j}]}),{...w,variants:x}})},style:{borderRadius:10}},React.createElement("i",{className:"fas fa-plus me-1"}),"Th\xEAm nh\xF3m bi\u1EBFn th\u1EC3"),React.createElement("div",{className:"d-flex gap-2 align-items-center mt-2"},React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:fe,disabled:!Array.isArray(v.variants)||v.variants.length===0,style:{borderRadius:10},title:"\u0110\u1EB7t gi\xE1 gi\u1ED1ng gi\xE1 g\u1ED1c s\u1EA3n ph\u1EA9m cho t\u1EA5t c\u1EA3 l\u1EF1a ch\u1ECDn \u1EDF m\u1ECDi nh\xF3m"},"\u0110\u1ED3ng gi\xE1 (t\u1EA5t c\u1EA3)")),React.createElement("div",{className:"text-muted small mt-2"},"Gi\xE1 bi\u1EBFn th\u1EC3 l\xE0 gi\xE1 c\u1EE5 th\u1EC3 (\u0111). V\xED d\u1EE5 Size S: 15.000\u0111, Size M: 25.000\u0111."))),React.createElement("div",{className:"mb-2"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},React.createElement("i",{className:"fas fa-link me-1"}),"URL \u1EA3nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",placeholder:"https://...",value:v.image,onChange:w=>D({...v,image:w.target.value}),style:{borderRadius:"10px",border:"1px solid #dee2e6",padding:"10px",fontSize:"0.9rem"}}))),React.createElement("div",{className:"modal-footer border-0 py-3",style:{background:"#fff"}},React.createElement("button",{type:"button",className:"btn btn-light px-4",onClick:z,style:{borderRadius:"10px"}},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning px-4 fw-semibold",disabled:Z,style:{borderRadius:"10px",boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},Z?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u s\u1EA3n ph\u1EA9m"))))))):null}function VideoModal({show:N,video:f,onClose:C,onSave:z}){const[U,v]=useState({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),[D,Z]=useState(!1),[re,V]=useState("");useEffect(()=>{f?(v({title:f.title||"",youtube_url:`https://www.youtube.com/watch?v=${f.youtubeId}`,thumbnail_url:f.thumb||"",sort_order:f.sortOrder||0}),V(f.thumb)):(v({title:"",youtube_url:"",thumbnail_url:"",sort_order:0}),V(""))},[f,N]);const ue=me=>{const fe=me.match(/(?:youtube\.com\/(?:embed\/|watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return fe?fe[1]:null},Se=me=>{v({...U,youtube_url:me});const fe=ue(me);fe&&V(`https://img.youtube.com/vi/${fe}/hqdefault.jpg`)},se=async me=>{me.preventDefault(),Z(!0),await z(U),Z(!1)};return N?React.createElement("div",{className:"modal show d-block",style:{background:"rgba(0,0,0,0.5)"}},React.createElement("div",{className:"modal-dialog modal-dialog-centered"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},f?"S\u1EEDa Video":"Th\xEAm Video m\u1EDBi"),React.createElement("button",{type:"button",className:"btn-close",onClick:C})),React.createElement("form",{onSubmit:se},React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Link YouTube *"),React.createElement("input",{type:"url",className:"form-control",value:U.youtube_url,onChange:me=>Se(me.target.value),placeholder:"https://www.youtube.com/watch?v=... ho\u1EB7c shorts/...",required:!0}),React.createElement("small",{className:"text-muted"},"H\u1ED7 tr\u1EE3: youtube.com/watch, youtu.be, youtube.com/shorts")),re&&React.createElement("div",{className:"mb-3 text-center"},React.createElement("img",{src:re,alt:"Preview",className:"img-fluid rounded",style:{maxHeight:"150px"}})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ti\xEAu \u0111\u1EC1 *"),React.createElement("input",{type:"text",className:"form-control",value:U.title,onChange:me=>v({...U,title:me.target.value}),required:!0})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Th\u1EE9 t\u1EF1"),React.createElement("input",{type:"number",className:"form-control",value:U.sort_order,onChange:me=>v({...U,sort_order:parseInt(me.target.value)||0})})),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Thumbnail t\xF9y ch\u1EC9nh (t\xF9y ch\u1ECDn)"),React.createElement("input",{type:"url",className:"form-control",value:U.thumbnail_url,onChange:me=>v({...U,thumbnail_url:me.target.value}),placeholder:"\u0110\u1EC3 tr\u1ED1ng s\u1EBD d\xF9ng thumbnail m\u1EB7c \u0111\u1ECBnh c\u1EE7a YouTube"}))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:C},"H\u1EE7y"),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:D},D?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u")))))):null}function AdminApp(){const[N,f]=useState(!1),[C,z]=useState(""),[U,v]=useState(null),[D,Z]=useState("search"),[re,V]=useState(null),[ue,Se]=useState(""),[se,me]=useState([]),[fe,ie]=useState(null),[ee,de]=useState(!1),[ke,he]=useState(null),[De,be]=useState(!0),[Ae,Ne]=useState([]),[Oe,Ze]=useState(()=>loadAdminSettings()),[_e,Ie]=useState(null),[w,i]=useState([]);useEffect(()=>{const h=localStorage.getItem("ktm_admin_session");if(h)try{const K=JSON.parse(h);K.expiry>Date.now()?(f(!0),v(K.user)):localStorage.removeItem("ktm_admin_session")}catch(K){localStorage.removeItem("ktm_admin_session")}},[]),useEffect(()=>{N&&W()},[N]),useEffect(()=>{if(!N)return;let h=!1;return(async()=>{try{const K=await fetchAdminSettingsFromServer();if(h)return;Ze(K),saveAdminSettings(K)}catch(K){}})(),()=>{h=!0}},[N]);const x=async(h,K)=>{z("");try{const P=await window.KTM.api.postJSON(`${API_BASE}/api/auth/login`,{username:h,password:K},"\u0110\u0103ng nh\u1EADp th\u1EA5t b\u1EA1i"),Me={user:P.user,token:P.token,expiry:Date.now()+100*365*24*60*60*1e3};localStorage.setItem("ktm_admin_session",JSON.stringify(Me)),v(P.user),f(!0)}catch(P){z(P.message)}},j=()=>{localStorage.removeItem("ktm_admin_session"),f(!1),v(null),me([]),ie(null)},I=(h,K="success")=>{const P=Date.now();Ne(Me=>[...Me,{id:P,message:h,type:K}])},ae=h=>{Ne(K=>K.filter(P=>P.id!==h))},W=async(h=null)=>{be(!0);try{const K=h?`${API_BASE}/api/albums?parent_id=${h}`:`${API_BASE}/api/albums?parent_id=root`,P=await window.KTM.api.getJSON(K,"L\u1ED7i t\u1EA3i danh s\xE1ch album");me(Array.isArray(P)?P:[])}catch(K){console.error(K),I("L\u1ED7i t\u1EA3i danh s\xE1ch album","danger")}be(!1)},q=()=>{he(null),de(!0)},R=h=>{he(h),de(!0)},r=async h=>{try{const K=ke&&ke.uuid;!K&&_e&&(h.parent_id=_e.uuid);const P=K?`${API_BASE}/api/albums/${ke.uuid||ke.id}`:`${API_BASE}/api/albums`;K?await window.KTM.api.putJSON(P,h,"L\u1ED7i c\u1EADp nh\u1EADt"):await window.KTM.api.postJSON(P,h,"L\u1ED7i t\u1EA1o"),I(K?"C\u1EADp nh\u1EADt th\xE0nh c\xF4ng!":"T\u1EA1o th\xE0nh c\xF4ng!","success"),de(!1),W(_e==null?void 0:_e.uuid)}catch(K){I(K.message,"danger")}},oe=h=>{ie(h)},Le=h=>{if(h==="root")i([]),Ie(null),W(null);else if(h){const K=w.findIndex(P=>P.uuid===h.uuid);K>=0&&(i(w.slice(0,K+1)),Ie(h),W(h.uuid))}else{const K=[...w];K.pop();const P=K[K.length-1]||null;i(K),Ie(P),W(P==null?void 0:P.uuid)}},je=async h=>{const K=`X\xF3a folder "${h.title}"? T\u1EA5t c\u1EA3 folder con v\xE0 \u1EA3nh b\xEAn trong s\u1EBD b\u1ECB x\xF3a!`;if(confirm(K))try{await window.KTM.api.deleteJSON(`${API_BASE}/api/albums/${h.uuid||h.id}`,"L\u1ED7i x\xF3a album"),I("\u0110\xE3 x\xF3a","success"),W(_e==null?void 0:_e.uuid)}catch(P){I("L\u1ED7i x\xF3a album","danger")}};if(!N)return React.createElement(LoginPage,{onLogin:x,error:C});const l=()=>{const h=new Date,K=h.getFullYear(),P=String(h.getMonth()+1).padStart(2,"0");return`${K}-${P}`};function b(){const[h,K]=useState(()=>{var Pe;return String((Pe=Oe==null?void 0:Oe.ship_percent)!=null?Pe:DEFAULT_SHIP_PERCENT)}),[P,Me]=useState(!1);return useEffect(()=>{var Pe;K(String((Pe=Oe==null?void 0:Oe.ship_percent)!=null?Pe:DEFAULT_SHIP_PERCENT))},[Oe==null?void 0:Oe.ship_percent]),React.createElement("div",{className:"product-manager pb-5 mb-4"},React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-cog me-2 text-warning"}),"C\xE0i \u0111\u1EB7t")),React.createElement("div",{className:"card p-3"},React.createElement("form",{onSubmit:async Pe=>{Pe.preventDefault(),Me(!0);const Ke=saveAdminSettings({ship_percent:h});try{const Ue=await saveAdminSettingsToServer(Ke);Ze(Ue),saveAdminSettings(Ue),I("\u0110\xE3 l\u01B0u c\xE0i \u0111\u1EB7t v\xE0o DB","success")}catch(Ue){Ze(Ke),I("Kh\xF4ng l\u01B0u \u0111\u01B0\u1EE3c DB, \u0111\xE3 l\u01B0u t\u1EA1m tr\xEAn m\xE1y","warning")}finally{Me(!1)}}},React.createElement("div",{className:"mb-2 text-muted small"},"\xC1p d\u1EE5ng cho th\u1ED1ng k\xEA hoa h\u1ED3ng khi \u0111\u01A1n h\xE0ng kh\xF4ng ghi ph\xED ship trong ghi ch\xFA s\u1EA3n ph\u1EA9m."),React.createElement("div",{className:"mb-3"},React.createElement("label",{className:"form-label"},"Ph\xED ship (%) khi kh\xF4ng c\xF3 ship"),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",value:h,min:"0",max:"100",step:"0.01",onChange:Pe=>K(Pe.target.value)}),React.createElement("span",{className:"input-group-text"},"%")),React.createElement("div",{className:"form-text"},"M\u1EB7c \u0111\u1ECBnh: ",DEFAULT_SHIP_PERCENT,"%")),React.createElement("button",{type:"submit",className:"btn btn-warning",disabled:P},P?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):"L\u01B0u c\xE0i \u0111\u1EB7t"))))}function ge(){const[h,K]=useState(l()),[P,Me]=useState(!0),[it,Pe]=useState([]),[Ke,Ue]=useState([]),mt=useRef(!1),Mt=useRef(new Map),yt=normalizeShipPercent(Oe==null?void 0:Oe.ship_percent),{parseMoney:Rt,parseShipFeeFromNote:Pt,getShipFeeForItems:It,formatNumber:we,formatVND:Ge}=window.KTM.money,ct=async()=>{if(!mt.current)try{const y=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i danh s\xE1ch s\u1EA3n ph\u1EA9m");Ue(Array.isArray(y)?y:[]),mt.current=!0}catch(y){console.error("Load products for stats error:",y),Ue([]),mt.current=!0}},kt=async y=>{var at,nt;const Fe=String(y||"").trim();if(!Fe)return[];const qe=(at=Mt.current)==null?void 0:at.get(Fe);if(qe&&Array.isArray(qe))return qe;const ze=await window.KTM.api.getJSON(`${API_BASE}/api/orders?month=${encodeURIComponent(Fe)}`,"L\u1ED7i t\u1EA3i th\u1ED1ng k\xEA"),et=Array.isArray(ze)?ze:[];return(nt=Mt.current)==null||nt.set(Fe,et),et},u=async()=>{Me(!0);try{await ct();const y=await kt(h);Pe(Array.isArray(y)?y:[])}catch(y){console.error("Load stats error:",y),Pe([])}finally{Me(!1)}};useEffect(()=>{u()},[h]);const _=React.useMemo(()=>{var te;const y={draft:0,pending:0,processing:0,done:0,paid:0,canceled:0,other:0};let Fe=0,qe=0,ze=0,et=0,at=0,nt=0,Ct=0,$t=0;const bt=E=>E.customer_id||E.phone||"unknown",Ve=E=>window.KTM.orders.getOrderItems(E),Kt=new Map,ut=new Map,$e=new Map,t=5,S=new Map((Array.isArray(Ke)?Ke:[]).map(E=>{var Qe;const ce=(Qe=E==null?void 0:E.commission_percent)!=null?Qe:E==null?void 0:E.commissionPercent,We=Number(ce),tt=Number.isFinite(We)?Math.max(0,Math.min(100,We)):t;return[String(E==null?void 0:E.id),tt]})),$=E=>{const ce=String(E!=null?E:"").trim().toLowerCase();return ce==="cancelled"?"canceled":ce};for(const E of it){const ce=$(E==null?void 0:E.status),Qe=ce==="canceled"||ce==="draft",st=Ve(E);let ft=0,rt=0,Nt=0;for(const G of st){const X=Number((G==null?void 0:G.quantity)||0)||0,xe=Rt(G==null?void 0:G.product_price),ve=X*xe,Te=String((G==null?void 0:G.product_id)||""),Xe=S.has(Te)?S.get(Te):t,dt=(Number(Xe)||0)/100;if(ft+=X,rt+=ve,Nt+=ve*dt,!Qe){const Be=(G==null?void 0:G.product_id)||"unknown",Ye=Kt.get(Te)||{product_id:Be,product_name:(G==null?void 0:G.product_name)||"\u2014",product_code:(G==null?void 0:G.product_code)||"",orders:0,quantity:0,revenue:0};Ye.orders+=1,Ye.quantity+=X,Ye.revenue+=ve,Kt.set(Be,Ye)}}const Tt=It(st),Lt=Number((te=E==null?void 0:E.adjustment_amount)!=null?te:0)||0,wt=rt+(Tt.found?Tt.fee:0)+Lt,Et=rt+Lt,O=!Tt.found&&yt>0&&rt>0?rt*yt/100:0,F=rt>0?Nt/rt:t/100,ne=Nt+Lt*F-O*F,pe=ce==="done"||ce==="paid";if(ce==="draft"?y.draft+=1:ce==="pending"?y.pending+=1:ce==="processing"?y.processing+=1:ce==="canceled"?y.canceled+=1:ce==="paid"?(y.paid+=1,y.done+=1,et+=wt,nt+=Et,$t+=ne):ce==="done"?(y.done+=1,et+=wt,nt+=Et,$t+=ne):y.other+=1,!Qe){Fe+=1,qe+=ft,ze+=wt,at+=Et,Ct+=ne;const G=bt(E),X=ut.get(G)||{key:G,customer_name:E.customer_name||"",phone:E.phone||"",orders:0,quantity:0,revenue:0};X.orders+=1,X.quantity+=ft,X.revenue+=wt,!X.customer_name&&E.customer_name&&(X.customer_name=E.customer_name),!X.phone&&E.phone&&(X.phone=E.phone),ut.set(G,X);const xe=E.created_at?new Date(E.created_at):null;if(xe&&!Number.isNaN(xe.getTime())){const ve=`${xe.getFullYear()}-${String(xe.getMonth()+1).padStart(2,"0")}-${String(xe.getDate()).padStart(2,"0")}`,Te=$e.get(ve)||{day:ve,orders:0,quantity:0,revenue:0,doneOrders:0,doneRevenue:0};Te.orders+=1,Te.quantity+=ft,Te.revenue+=wt,pe&&(Te.doneOrders+=1,Te.doneRevenue+=wt),$e.set(ve,Te)}}}const H=Array.from(Kt.values()).sort((E,ce)=>ce.revenue-E.revenue),Q=Array.from(ut.values()).sort((E,ce)=>ce.revenue-E.revenue),A=Array.from($e.values()).sort((E,ce)=>E.day.localeCompare(ce.day)),k=ut.size,J=Fe?Math.round(ze/Fe):0,le=Fe?qe/Fe:0,Ce=Math.round($t),B=Math.round(Ct);return{statusCounts:y,activeOrders:Fe,totalQty:qe,totalRevenue:ze,doneRevenue:et,tempCommission:Ce,tempCommissionAll:B,products:H,customers:Q,days:A,uniqueCustomers:k,avgOrderValue:J,avgQtyPerOrder:le}},[it,Ke,h]);return React.createElement("div",{className:"product-manager pb-5 mb-4 stats-manager"},React.createElement(Loading,{show:P}),React.createElement("div",{className:"product-header"},React.createElement("h5",{className:"mb-0"},React.createElement("i",{className:"fas fa-chart-column me-2 text-warning"}),"Th\u1ED1ng k\xEA"),React.createElement("button",{className:"btn btn-outline-secondary btn-sm",onClick:u,disabled:P},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"Ch\u1ECDn th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:h,onChange:y=>K(y.target.value),"aria-label":"Ch\u1ECDn th\xE1ng"}))),React.createElement("div",{className:"col-12 col-md-7 d-flex gap-2 justify-content-md-end"},React.createElement("div",{className:"d-flex flex-wrap gap-2 align-self-center"},React.createElement("span",{className:"badge rounded-pill bg-secondary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-truck me-1"}),"Ship \u01B0\u1EDBc t\xEDnh: ",yt,"%"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-receipt me-1"}),we(_.activeOrders)," \u0111\u01A1n"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-user me-1"}),we(_.uniqueCustomers)," kh\xE1ch"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-boxes-stacked me-1"}),we(_.totalQty)," SL"),React.createElement("span",{className:"badge rounded-pill bg-primary bg-opacity-10 text-dark"},React.createElement("i",{className:"fas fa-hand-holding-dollar me-1"}),"\u0110\xE3 nh\u1EADn ti\u1EC1n: ",we(_.statusCounts.paid),"/",we(_.statusCounts.done)))))),React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng \u0111\u01A1n (kh\xF4ng t\xEDnh h\u1EE7y/nh\xE1p)"),React.createElement("i",{className:"fas fa-receipt text-dark"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},we(_.activeOrders)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (t\u1EA1m t\xEDnh)"),React.createElement("i",{className:"fas fa-sack-dollar text-warning"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Ge(_.totalRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Doanh thu (Ho\xE0n th\xE0nh)"),React.createElement("i",{className:"fas fa-circle-check text-success"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Ge(_.doneRevenue)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-info bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng s\u1EBD nh\u1EADn (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-chart-line text-info"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Ge(_.tempCommission)))),React.createElement("div",{className:"col-6 col-md-3"},React.createElement("div",{className:"card p-3 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"text-muted small"},"Hoa h\u1ED3ng t\u1ED5ng (theo % SP - tr\u1EEB ship \u01B0\u1EDBc t\xEDnh)"),React.createElement("i",{className:"fas fa-coins text-primary"})),React.createElement("div",{className:"fs-4 fw-semibold text-dark"},Ge(_.tempCommissionAll))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-layer-group me-2 text-warning"}),"T\u1ED5ng quan tr\u1EA1ng th\xE1i"),React.createElement("span",{className:"badge rounded-pill bg-dark bg-opacity-10 text-dark"},"SL TB/\u0111\u01A1n: ",_.avgQtyPerOrder?_.avgQtyPerOrder.toFixed(2):"0.00")),React.createElement("div",{className:"d-md-none mt-2"},React.createElement("div",{className:"row g-2"},React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-light bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Nh\xE1p"),React.createElement("div",{className:"fw-semibold"},we(_.statusCounts.draft)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-secondary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("div",{className:"fw-semibold"},we(_.statusCounts.pending)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-warning bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("div",{className:"fw-semibold"},we(_.statusCounts.processing)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-danger bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"H\u1EE7y \u0111\u01A1n"),React.createElement("div",{className:"fw-semibold"},we(_.statusCounts.canceled)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-success bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh"),React.createElement("div",{className:"fw-semibold"},we(_.statusCounts.done)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-primary bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("div",{className:"fw-semibold"},we(_.statusCounts.paid)))),React.createElement("div",{className:"col-6"},React.createElement("div",{className:"card p-2 border-0 shadow-sm bg-dark bg-opacity-10"},React.createElement("div",{className:"text-muted small"},"T\u1ED5ng SL"),React.createElement("div",{className:"fw-semibold"},we(_.totalQty)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Nh\xE1p"),React.createElement("th",null,"Ch\u1EDD x\u1EED l\xFD"),React.createElement("th",null,"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("th",null,"H\u1EE7y \u0111\u01A1n"),React.createElement("th",null,"Ho\xE0n th\xE0nh"),React.createElement("th",null,"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("th",null,"Kh\xE1c"),React.createElement("th",null,"T\u1ED5ng SL"))),React.createElement("tbody",null,React.createElement("tr",null,React.createElement("td",null,we(_.statusCounts.draft)),React.createElement("td",null,we(_.statusCounts.pending)),React.createElement("td",null,we(_.statusCounts.processing)),React.createElement("td",null,we(_.statusCounts.canceled)),React.createElement("td",null,we(_.statusCounts.done)),React.createElement("td",null,we(_.statusCounts.paid)),React.createElement("td",null,we(_.statusCounts.other)),React.createElement("td",null,we(_.totalQty))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-box me-2 text-info"}),"Top s\u1EA3n ph\u1EA9m"),React.createElement("span",{className:"badge rounded-pill bg-info bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},_.products.slice(0,10).map(y=>React.createElement("div",{key:y.product_id,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-info"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},y.product_name),React.createElement("div",{className:"text-muted small text-truncate"},y.product_code?`#${y.product_code} \u2022 `:"",we(y.orders)," \u0111\u01A1n \u2022 ",we(y.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},Ge(y.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"M\xE3"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,_.products.slice(0,10).map(y=>React.createElement("tr",{key:y.product_id},React.createElement("td",null,y.product_name),React.createElement("td",null,y.product_code||"\u2014"),React.createElement("td",null,we(y.orders)),React.createElement("td",null,we(y.quantity)),React.createElement("td",{className:"fw-semibold"},Ge(y.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-user-group me-2 text-warning"}),"Top kh\xE1ch h\xE0ng"),React.createElement("span",{className:"badge rounded-pill bg-warning bg-opacity-10 text-dark"},"Theo doanh thu \u2022 Top 10")),React.createElement("div",{className:"d-md-none mt-2"},_.customers.slice(0,10).map(y=>React.createElement("div",{key:y.key,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-warning"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,flex:1}},React.createElement("div",{className:"text-truncate"},y.customer_name||"\u2014"),React.createElement("div",{className:"text-muted small text-truncate"},y.phone||"\u2014"," \u2022 ",we(y.orders)," \u0111\u01A1n \u2022 ",we(y.quantity)," SL")),React.createElement("div",{className:"fw-semibold text-nowrap"},Ge(y.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"Doanh thu"))),React.createElement("tbody",null,_.customers.slice(0,10).map(y=>React.createElement("tr",{key:y.key},React.createElement("td",null,y.customer_name||"\u2014"),React.createElement("td",null,y.phone||"\u2014"),React.createElement("td",null,we(y.orders)),React.createElement("td",null,we(y.quantity)),React.createElement("td",{className:"fw-semibold"},Ge(y.revenue)))))))),React.createElement("div",{className:"card p-3 mt-3 mb-4"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},React.createElement("i",{className:"fas fa-calendar-day me-2 text-success"}),"Theo ng\xE0y"),React.createElement("span",{className:"badge rounded-pill bg-success bg-opacity-10 text-dark"},"DT (t\u1EA1m t\xEDnh) & ho\xE0n th\xE0nh")),React.createElement("div",{className:"d-md-none mt-2"},_.days.map(y=>React.createElement("div",{key:y.day,className:"card mb-2 p-2 border-0 shadow-sm border-start border-4 border-success"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"fw-semibold"},y.day),React.createElement("div",{className:"text-muted small"},we(y.orders)," \u0111\u01A1n \u2022 ",we(y.quantity)," SL"),React.createElement("div",{className:"text-muted small"},"Ho\xE0n th\xE0nh: ",we(y.doneOrders)," \u2022 ",Ge(y.doneRevenue))),React.createElement("div",{className:"fw-semibold text-nowrap"},Ge(y.revenue)))))),React.createElement("div",{className:"d-none d-md-block table-responsive mt-2"},React.createElement("table",{className:"table table-bordered mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Ng\xE0y"),React.createElement("th",null,"\u0110\u01A1n"),React.createElement("th",null,"SL"),React.createElement("th",null,"DT (t\u1EA1m t\xEDnh)"),React.createElement("th",null,"\u0110\u01A1n ho\xE0n th\xE0nh"),React.createElement("th",null,"DT ho\xE0n th\xE0nh"))),React.createElement("tbody",null,_.days.map(y=>React.createElement("tr",{key:y.day},React.createElement("td",null,y.day),React.createElement("td",null,we(y.orders)),React.createElement("td",null,we(y.quantity)),React.createElement("td",{className:"fw-semibold"},Ge(y.revenue)),React.createElement("td",null,we(y.doneOrders)),React.createElement("td",{className:"fw-semibold"},Ge(y.doneRevenue)))))))))}return React.createElement("div",null,React.createElement(Sidebar,{activeMenu:D,onMenuChange:h=>{Z(h),h==="albums"&&(Ie(null),i([]),W(null))},onLogout:j,currentUser:U}),React.createElement("div",{className:"main-content"},D==="albums"&&!fe&&React.createElement(AlbumList,{albums:se,loading:De,currentFolder:_e,breadcrumb:w,onSelect:oe,onCreate:q,onEdit:R,onDelete:je,onBack:Le}),D==="search"&&React.createElement(SearchCenter,{showToast:I,onNavigate:(h,K,P)=>{Z(h),h==="orders"&&K==="create"&&(V(Date.now()),Se((P==null?void 0:P.productId)||""))}}),D==="albums"&&fe&&React.createElement(AlbumDetail,{album:fe,parentAlbum:w.length>0?w[w.length-1]:null,onBack:()=>{if(fe.parentId){const h=w.findIndex(K=>K.uuid===fe.parentId);h>=0?ie(w[h]):ie(null)}else ie(null)},onRefresh:()=>W(_e==null?void 0:_e.uuid),showToast:I,onNavigateToFolder:h=>{i(K=>[...K,fe]),ie(h)},onEditSubfolder:h=>{he(h),de(!0)}}),D==="videos"&&React.createElement(VideoList,{showToast:I}),D==="products"&&React.createElement(ProductManager,{showToast:I,settings:Oe}),D==="orders"&&React.createElement(OrderManager,{autoOpenCreateToken:re,autoOpenCreateProductId:ue,showToast:I}),D==="stats"&&React.createElement(ge,null),D==="settings"&&React.createElement(b,null)),React.createElement("nav",{className:"mobile-bottom-nav"},React.createElement("div",{className:"nav-items"},React.createElement("a",{href:"#",className:`nav-item ${D==="search"?"active":""}`,onClick:h=>{h.preventDefault(),Z("search")}},React.createElement("i",{className:"fas fa-search"}),React.createElement("span",null,"Tra c\u1EE9u")),React.createElement("a",{href:"#",className:`nav-item ${D==="albums"?"active":""}`,onClick:h=>{h.preventDefault(),Z("albums"),ie(null)}},React.createElement("i",{className:"fas fa-images"}),React.createElement("span",null,"Album")),React.createElement("a",{href:"#",className:`nav-item ${D==="videos"?"active":""}`,onClick:h=>{h.preventDefault(),Z("videos")}},React.createElement("i",{className:"fas fa-video"}),React.createElement("span",null,"Video")),React.createElement("a",{href:"#",className:`nav-item ${D==="products"?"active":""}`,onClick:h=>{h.preventDefault(),Z("products")}},React.createElement("i",{className:"fas fa-box"}),React.createElement("span",null,"S\u1EA3n ph\u1EA9m")),React.createElement("a",{href:"#",className:`nav-item ${D==="orders"?"active":""}`,onClick:h=>{h.preventDefault(),Z("orders")}},React.createElement("i",{className:"fas fa-receipt"}),React.createElement("span",null,"\u0110\u01A1n h\xE0ng")),React.createElement("a",{href:"#",className:`nav-item ${D==="stats"?"active":""}`,onClick:h=>{h.preventDefault(),Z("stats")}},React.createElement("i",{className:"fas fa-chart-column"}),React.createElement("span",null,"Th\u1ED1ng k\xEA")))),React.createElement(AlbumModal,{show:ee,album:ke,parentId:_e==null?void 0:_e.uuid,onClose:()=>de(!1),onSave:r}),React.createElement("div",{className:"toast-container"},Ae.map(h=>React.createElement(Toast,{key:h.id,message:h.message,type:h.type,onClose:()=>ae(h.id)}))))}ReactDOM.render(React.createElement(AdminApp,null),document.getElementById("root"));function OrderManager({autoOpenCreateToken:N,autoOpenCreateProductId:f,showToast:C}){const[z,U]=useState([]),[v,D]=useState([]),[Z,re]=useState(!0),[V,ue]=useState(!1),[Se,se]=useState([]),[me,fe]=useState(!1),[ie,ee]=useState(!1),[de,ke]=useState(null),[he,De]=useState(null),[be,Ae]=useState(!1),[Ne,Oe]=useState(()=>{const e=new Date,n=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0");return`${n}-${a}`}),[Ze,_e]=useState(""),[Ie,w]=useState(!1),[i,x]=useState(!1),[j,I]=useState(null),[ae,W]=useState(!1),[q,R]=useState([]),[r,oe]=useState({customer_name:"",phone:"",address:"",note:"",items:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_amount:0,adjustment_note:"",status:"pending"}),[Le,je]=useState([""]),[l,b]=useState(null),ge=useRef({}),[h,K]=useState([]),[P,Me]=useState(null),it=useRef(null),Pe=useRef(null),Ke=useRef(0),Ue=useRef(new Map),mt=useRef(""),Mt=useRef(null),yt=useRef(0),Rt=useRef(null),Pt=9,It=150,we=24*60*60*1e3,Ge=5*60*1e3,ct="ktm_customer_lookup_cache_v1",kt=200,u=3,_=7,y=3,Fe=24*60*60*1e3,qe=e=>{try{const n=new Date(e==null?void 0:e.created_at).getTime();if(!Number.isFinite(n))return 0;const a=Date.now()-n;return!Number.isFinite(a)||a<=0?0:Math.floor(a/Fe)}catch(n){return 0}},ze=e=>String((e==null?void 0:e.status)||"").trim()!=="pending"?!1:qe(e)>=u,et=e=>{const n=String(e!=null?e:"").trim().toLowerCase();return n==="cancelled"?"canceled":n},at=e=>{if(et(e==null?void 0:e.status)!=="draft")return null;const a=_-qe(e);return Number.isFinite(a)?a:null},nt=e=>{const n=at(e);return Number.isFinite(n)?n>0&&n<=y:!1},Ct=e=>{oe({customer_name:"",phone:"",address:"",note:"",items:[{product_id:e||"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_amount:0,adjustment_note:"",status:"pending"}),je([""]),I(null),b(null)};useEffect(()=>{const e=n=>{var s;if(l==null)return;const a=(s=ge.current)==null?void 0:s[l];a&&!a.contains(n.target)&&b(null)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[l]);const $t=e=>window.KTM.money.parseMoney(e),bt=e=>window.KTM.money.parseSignedMoney(e),Ve=e=>window.KTM.money.formatVND(e),Kt=e=>window.KTM.money.parseShipFeeFromNote(e),ut=e=>window.KTM.phone.isValid(e),$e=e=>window.KTM.phone.normalize(e),t=()=>{var e;try{const n=localStorage.getItem(ct);if(!n)return;const a=JSON.parse(n);if(!a||typeof a!="object")return;const s=Object.entries(a);for(const[c,p]of s)!c||!p||typeof p!="object"||(e=Ue.current)==null||e.set(String(c),p)}catch(n){}},S=()=>{try{const e=Ue.current;if(!e||typeof e.entries!="function")return;const n=Array.from(e.entries()).filter(([s,c])=>s&&c&&typeof c=="object"&&Number.isFinite(c.ts)).sort((s,c)=>(Number(c[1].ts)||0)-(Number(s[1].ts)||0)).slice(0,kt),a={};for(const[s,c]of n)a[s]=c;localStorage.setItem(ct,JSON.stringify(a))}catch(e){}};useEffect(()=>{t()},[]);const $=e=>{const n=$e(e);if(!n)return null;const a=Array.isArray(z)?z:[];let s=null,c=-1;for(const p of a){if(!p||$e(p.phone||"")!==n)continue;const T=new Date(p.created_at).getTime(),g=Number.isFinite(T)?T:0;g>=c&&(c=g,s=p)}return s?{name:String(s.customer_name||"").trim(),address:String(s.address||"").trim()}:null},H=(e,n)=>{e&&oe(a=>n&&$e(a.phone)!==n?a:{...a,customer_name:e.name||a.customer_name,address:e.address||a.address})},Q=e=>{const n=$(e);if(!n)return;const a=$e(e);oe(s=>{if(a&&$e(s.phone)!==a)return s;const c={...s};return!String(s.customer_name||"").trim()&&n.name&&(c.customer_name=n.name),!String(s.address||"").trim()&&n.address&&(c.address=n.address),c})},A=async e=>{var c,p,T;const n=$e(e);if(!n)return;Q(n);const a=(c=Ue.current)==null?void 0:c.get(n);if(a&&Number.isFinite(a.ts)){const g=Date.now()-a.ts,d=a.status==="found"?we:Ge;if(g>=0&&g<=d){I({status:a.status,phone:n,customer:a.customer}),a.status==="found"&&a.customer&&H(a.customer,n);return}}const s=++Ke.current;I({status:"loading",phone:n});try{const g=await window.KTM.api.getJSON(`${API_BASE}/api/customers?phone=${encodeURIComponent(n)}`,"L\u1ED7i tra c\u1EE9u kh\xE1ch");if(Ke.current!==s)return;if(g&&g.exists&&g.customer){(p=Ue.current)==null||p.set(n,{ts:Date.now(),status:"found",customer:g.customer}),S(),I({status:"found",phone:n,customer:g.customer}),H(g.customer,n);return}(T=Ue.current)==null||T.set(n,{ts:Date.now(),status:"not-found",customer:null}),S(),I({status:"not-found",phone:n})}catch(g){if(Ke.current!==s)return;console.error("Customer lookup error:",g),I({status:"error",phone:n})}},k=e=>{const n=$e(e),a=$(n);oe(c=>{const p={...c,phone:n};return a&&(!String(c.customer_name||"").trim()&&a.name&&(p.customer_name=a.name),!String(c.address||"").trim()&&a.address&&(p.address=a.address)),p}),W(!1),Pe.current&&(clearTimeout(Pe.current),Pe.current=null);const s=n;if(s.length<Pt){I(null);return}if(ut(s)&&s!==mt.current){mt.current=s,A(s);return}Pe.current=setTimeout(()=>{const c=$e(n);ut(c)&&c!==mt.current&&(mt.current=c,A(c))},It)},J=()=>{const e=$e(r.phone);e.length<Pt||ut(e)&&e!==mt.current&&(mt.current=e,A(e))};useEffect(()=>(i?(document.body.classList.add("order-modal-open"),document.body.style.overflow="hidden"):(document.body.classList.remove("order-modal-open"),document.body.style.overflow=""),()=>{document.body.classList.remove("order-modal-open"),document.body.style.overflow=""}),[i]);const le=Array.isArray(r.items)?r.items.length:0;useEffect(()=>{if(!i){yt.current=le;return}le>yt.current&&setTimeout(()=>{const e=Mt.current;e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},0),yt.current=le},[i,le]),useEffect(()=>()=>{Pe.current&&(clearTimeout(Pe.current),Pe.current=null)},[]),useEffect(()=>{ft()},[]),useEffect(()=>{rt()},[Ne]),useEffect(()=>{Nt()},[]),useEffect(()=>{N&&it.current!==N&&(it.current=N,Lt(f))},[N]);const Ce=e=>e==="draft"?"\u0110\u01A1n nh\xE1p":e==="pending"?"Ch\u1EDD x\u1EED l\xFD":e==="processing"?"\u0110ang v\u1EADn chuy\u1EC3n":e==="done"?"Ho\xE0n th\xE0nh":e==="paid"?"\u0110\xE3 nh\u1EADn ti\u1EC1n":e==="cancelled"||e==="canceled"?"H\u1EE7y \u0111\u01A1n":e||"",B=e=>e==="draft"?"bg-light text-dark":e==="pending"?"bg-secondary":e==="processing"?"bg-warning text-dark":e==="done"?"bg-success":e==="paid"?"bg-primary":e==="cancelled"||e==="canceled"?"bg-danger":"bg-light text-dark",te=React.useMemo(()=>window.KTM.orders.sortOrders(z),[z]),E=React.useMemo(()=>window.KTM.orders.sortOrders(v),[v]),ce=React.useMemo(()=>{const n=(Array.isArray(E)?E:[]).filter(a=>ze(a));return n.sort((a,s)=>{const c=new Date(a==null?void 0:a.created_at).getTime(),p=new Date(s==null?void 0:s.created_at).getTime();return(Number.isFinite(c)?c:0)-(Number.isFinite(p)?p:0)}),n},[E]),We=React.useMemo(()=>{const n=(Array.isArray(Se)?Se:[]).filter(a=>nt(a));return n.sort((a,s)=>{const c=new Date(a==null?void 0:a.created_at).getTime(),p=new Date(s==null?void 0:s.created_at).getTime();return(Number.isFinite(c)?c:0)-(Number.isFinite(p)?p:0)}),n},[Se]),tt=React.useMemo(()=>Ie?ce:te,[Ie,ce,te]),Qe=React.useMemo(()=>{if(Ie)return tt;const e=String(Ze||"").trim();return e?(Array.isArray(tt)?tt:[]).filter(n=>String((n==null?void 0:n.status)||"").trim()===e):tt},[tt,Ze,Ie]),st=e=>window.KTM.date.formatDateTime(e),ft=async()=>{try{const e=await window.KTM.api.getJSON(`${API_BASE}/api/products`,"L\u1ED7i t\u1EA3i s\u1EA3n ph\u1EA9m");K(Array.isArray(e)?e:[])}catch(e){console.error("Load products error:",e),K([])}},rt=async()=>{re(!0);try{let e=`${API_BASE}/api/orders`;Ne&&(e+=`?month=${Ne}`);const n=await window.KTM.api.getJSON(e,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng");U(Array.isArray(n)?n:[]),Nt()}catch(e){console.error("Load orders error:",e),U([])}finally{re(!1)}},Nt=async()=>{ue(!0),fe(!0);try{const[e,n]=await Promise.all([window.KTM.api.getJSON(`${API_BASE}/api/orders?overdue=1&days=${encodeURIComponent(u)}`,"L\u1ED7i t\u1EA3i \u0111\u01A1n h\xE0ng"),window.KTM.api.getJSON(`${API_BASE}/api/orders?draftExpiring=1&remainingDays=${encodeURIComponent(y)}`,"L\u1ED7i t\u1EA3i \u0111\u01A1n nh\xE1p")]);D(Array.isArray(e)?e:[]),se(Array.isArray(n)?n:[])}catch(e){console.error("Load all orders error:",e),D([]),se([])}finally{ue(!1),fe(!1)}},Tt=e=>{var a;Me(e.id);const n=Array.isArray(e.items)&&e.items.length?e.items.map(s=>{var c,p,T,g;return{product_id:(s==null?void 0:s.product_id)||"",quantity:Number((c=s==null?void 0:s.quantity)!=null?c:1)||1,unit_price:(()=>{var m;const d=(m=s==null?void 0:s.unit_price)!=null?m:s==null?void 0:s.unitPrice,o=Number(d);return Number.isFinite(o)?Math.trunc(o):null})(),variant:String((p=s==null?void 0:s.variant)!=null?p:"").trim(),variant_json:(g=(T=s==null?void 0:s.variant_json)!=null?T:s==null?void 0:s.variantJson)!=null?g:null}}).filter(s=>s.product_id):[{product_id:e.product_id||"",quantity:Number(e.quantity||1)||1,unit_price:null,variant:"",variant_json:null}];oe({customer_name:e.customer_name||"",phone:$e(e.phone||""),address:e.address||"",note:(e==null?void 0:e.note)||"",items:n.length?n:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}],adjustment_amount:Number((a=e==null?void 0:e.adjustment_amount)!=null?a:0)||0,adjustment_note:(e==null?void 0:e.adjustment_note)||"",status:e.status||"pending"}),je(new Array(n.length?n.length:1).fill("")),R(new Array(n.length?n.length:1).fill(!0)),I(null),x(!0),e.phone&&A($e(e.phone))};function Lt(e){Me(null),Ct(e||""),W(!1),R([]),x(!0)}const wt=()=>{ie||be||(x(!1),Me(null),Ct(""),W(!1),R([]))},Et=async()=>{var g,d,o;if(!P||be||ie)return;const e=(Array.isArray(z)?z:[]).find(m=>String(m==null?void 0:m.id)===String(P))||null,n=String((e==null?void 0:e.status)||(r==null?void 0:r.status)||"").trim();if(n==="done"||n==="paid"||n==="canceled"){const m="Kh\xF4ng th\u1EC3 t\xE1ch: \u0111\u01A1n \u0111\xE3 ho\xE0n th\xE0nh/\u0111\xE3 nh\u1EADn ti\u1EC1n/\u0111\xE3 h\u1EE7y.";typeof C=="function"?C(m,"warning"):alert(m);return}const a=$e(r.phone),c=(Array.isArray(r.items)?r.items:[]).map((m,M)=>{var L,Y;return{idx:M,product_id:String((m==null?void 0:m.product_id)||"").trim(),quantity:Number((L=m==null?void 0:m.quantity)!=null?L:0),variant:String((m==null?void 0:m.variant)||"").trim()||null,variant_json:(Y=m==null?void 0:m.variant_json)!=null?Y:null,unit_price:(()=>{const ye=Number(m==null?void 0:m.unit_price);if(Number.isFinite(ye))return Math.max(0,Math.trunc(ye));const He=Be(m==null?void 0:m.product_id),Re=m!=null&&m.variant_json&&typeof m.variant_json=="object"?m.variant_json:null;return vt(He,Re)})()}}).filter(m=>m.product_id&&Number.isFinite(m.quantity)&&m.quantity>0);if(c.length<2){const m="C\u1EA7n \xEDt nh\u1EA5t 2 s\u1EA3n ph\u1EA9m \u0111\u1EC3 t\xE1ch \u0111\u01A1n.";typeof C=="function"?C(m,"warning"):alert(m);return}const p=[],T=[];for(const m of c){const M=!!q[m.idx],L={product_id:m.product_id,quantity:m.quantity,unit_price:m.unit_price,variant:m.variant,variant_json:m.variant_json};M?p.push(L):T.push(L)}if(!p.length||!T.length){const m="Ch\u1ECDn m\u1ED9t s\u1ED1 s\u1EA3n ph\u1EA9m \u201CGiao \u0111\u1EE3t 1\u201D, v\xE0 \u0111\u1EC3 l\u1EA1i \xEDt nh\u1EA5t 1 s\u1EA3n ph\u1EA9m \u201CCh\u1EDD h\xE0ng\u201D.";typeof C=="function"?C(m,"warning"):alert(m);return}Ae(!0);try{const m=bt(r.adjustment_amount),M=(r.adjustment_note||"").trim(),L={customer_name:r.customer_name,phone:a,address:r.address,note:(r.note||"").trim(),adjustment_amount:m,adjustment_note:M,status:"processing",items:p,product_id:p[0].product_id,quantity:p[0].quantity,split_seq:1},Y=await window.KTM.api.postJSON(`${API_BASE}/api/orders`,L,"L\u1ED7i t\xE1ch \u0111\u01A1n (t\u1EA1o \u0111\u01A1n giao ngay)"),ye=(o=(d=Y==null?void 0:Y.id)!=null?d:(g=Y==null?void 0:Y.order)==null?void 0:g.id)!=null?o:null;if(!ye)throw new Error("T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i: kh\xF4ng nh\u1EADn \u0111\u01B0\u1EE3c ID \u0111\u01A1n giao ngay");const He={id:P,customer_name:r.customer_name,phone:a,address:r.address,note:(r.note||"").trim(),adjustment_amount:0,adjustment_note:"",status:"pending",items:T,product_id:T[0].product_id,quantity:T[0].quantity,parent_order_id:String(ye),split_seq:2};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${P}`,He,"L\u1ED7i t\xE1ch \u0111\u01A1n (c\u1EADp nh\u1EADt ph\u1EA7n ch\u1EDD h\xE0ng)"),wt(),rt();const Re=ye?`\u0110\xE3 t\xE1ch \u0111\u01A1n. \u0110\u01A1n giao ngay: #${ye}`:"\u0110\xE3 t\xE1ch \u0111\u01A1n.";typeof C=="function"?C(Re,"success"):alert(Re)}catch(m){console.error(m);const M=(m==null?void 0:m.message)||"T\xE1ch \u0111\u01A1n th\u1EA5t b\u1EA1i";typeof C=="function"?C(M,"danger"):alert(M)}finally{Ae(!1)}},O=e=>{if(!e)return"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --";const n=String(e),a=h.find(s=>String(s==null?void 0:s.id)===n);return a?`${a.name}${a.code?` (${a.code})`:""}`:"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"},F=e=>{try{return String(e!=null?e:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d")}catch(n){return String(e!=null?e:"").toLowerCase()}},ne=e=>{const a=F(e).trim().split(/\s+/).filter(Boolean),s=a.join(" ");return{contentTokens:a,cleanedQuery:s}},pe=React.useMemo(()=>(Array.isArray(h)?h:[]).map((e,n)=>{var o,m,M,L,Y,ye;const a=F((o=e==null?void 0:e.name)!=null?o:""),s=F((m=e==null?void 0:e.code)!=null?m:""),c=F((M=e==null?void 0:e.category)!=null?M:""),p=F((L=e==null?void 0:e.note)!=null?L:""),T=F((Y=e==null?void 0:e.id)!=null?Y:""),g=F((ye=e==null?void 0:e.stt)!=null?ye:""),d=`${a} ${s} ${c} ${p} ${T} ${g}`.trim();return{p:e,originalIndex:n,name:a,code:s,category:c,note:p,haystackAll:d}}),[h]),G=(e,n,a)=>{var M,L,Y,ye,He;const s=Array.isArray(n)?n:[],c=F(a).trim();if(!s.length&&!c)return 0;const p=(M=e==null?void 0:e.name)!=null?M:"",T=(L=e==null?void 0:e.code)!=null?L:"",g=(Y=e==null?void 0:e.category)!=null?Y:"",d=(ye=e==null?void 0:e.note)!=null?ye:"";if(!((He=e==null?void 0:e.haystackAll)!=null?He:""))return 0;let m=0;c&&(p===c&&(m+=220),p.includes(c)&&(m+=140),p.startsWith(c)&&(m+=160),T&&T===c&&(m+=180),T&&T.includes(c)&&(m+=90));for(const Re of s){if(!Re)continue;const lt=new RegExp(`(?:^|\\s)${Re.replace(/[.*+?^${}()|[\[\]\\]/g,"\\$&")}`);p.includes(Re)&&(m+=35),lt.test(p)&&(m+=25),T&&T.includes(Re)&&(m+=20),T&&lt.test(T)&&(m+=10),g&&g.includes(Re)&&(m+=12),d&&d.includes(Re)&&(m+=6)}return m>0&&p&&(m+=Math.max(0,10-Math.min(10,Math.floor(p.length/10)))),m},X=(e,n)=>{const a=String(e||""),s=String(n||"");if(a===s)return 0;if(!a)return s.length;if(!s)return a.length;const c=a.length,p=s.length;if(p>c)return X(s,a);let T=new Array(p+1),g=new Array(p+1);for(let d=0;d<=p;d++)T[d]=d;for(let d=1;d<=c;d++){g[0]=d;const o=a.charCodeAt(d-1);for(let M=1;M<=p;M++){const L=o===s.charCodeAt(M-1)?0:1;g[M]=Math.min(T[M]+1,g[M-1]+1,T[M-1]+L)}const m=T;T=g,g=m}return T[p]},xe=(e,n)=>{const a=String(e||"").trim(),s=String(n||"");if(!a||!s)return!1;if(s.includes(a))return!0;const c=s.split(/\s+/).filter(Boolean);if(!c.length)return!1;const p=a.length<=4?1:2;for(const T of c)if(!(Math.abs(T.length-a.length)>p)&&X(a,T)<=p)return!0;return!1},ve=e=>{const n=F(e).replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim();return n?n.split(" ").filter(Boolean):[]},Te=(e,n)=>{const a=Array.isArray(n)?n:[];if(!a.length)return 0;const s=ve((e==null?void 0:e.name)||""),c=ve((e==null?void 0:e.code)||""),p=ve((e==null?void 0:e.category)||""),T=ve((e==null?void 0:e.note)||""),g=(o,m,M)=>{const L=String(o||"").trim();if(!L||!m.length)return 0;const Y=L.length<=4?1:2;let ye=1/0,He=-1;for(let Je=0;Je<m.length;Je++){const pt=m[Je];if(!pt||Math.abs(pt.length-L.length)>Y)continue;const ht=X(L,pt);if(ht<ye&&(ye=ht,He=Je,ht===0))break}if(ye===1/0||ye>Y)return 0;let lt=Math.round(M*(ye===0?1:ye===1?.65:.45));return He===0?lt+=Math.round(M*.25):He===1&&(lt+=Math.round(M*.12)),lt};let d=0;for(const o of a){if(!o)continue;const m=g(o,s,180),M=g(o,c,120),L=g(o,p,60),Y=g(o,T,30);d+=Math.max(m,M,L,Y)}if(d>0){const o=((e==null?void 0:e.name)||"").length;d+=Math.max(0,60-Math.min(60,Math.floor(o/2)))}return d},Xe=React.useRef(new Map);React.useEffect(()=>{Xe.current=new Map},[h]);const dt=e=>{var o,m;const n=String(Le[e]||"").trim();if(!n)return h;const{contentTokens:a,cleanedQuery:s}=ne(n);if(a.length===0)return h;const c=F(n).trim(),p=Xe.current.get(c);if(p)return p;const T=[];for(const M of pe){const L=M.haystackAll;L&&a.some(Y=>L.includes(Y))&&T.push(M)}let g=T;if(g.length<8&&a.length>0){const M=[],L=new Set(g.map(Y=>{var ye,He;return String((He=(ye=Y.p)==null?void 0:ye.id)!=null?He:"")+":"+String(Y.originalIndex)}));for(const Y of pe){const ye=String((m=(o=Y.p)==null?void 0:o.id)!=null?m:"")+":"+String(Y.originalIndex);if(L.has(ye))continue;const He=Y.haystackAll;He&&a.some(Re=>xe(Re,He))&&(M.push(Y),L.add(ye))}M.length&&(g=g.concat(M))}const d=g.map(M=>({entry:M,score:G(M,a,s)})).map(M=>{if(M.score>0)return M;const L=Te(M.entry,a);return L>0?{...M,score:L}:M}).filter(M=>M.score>0).sort((M,L)=>L.score!==M.score?L.score-M.score:M.entry.originalIndex-L.entry.originalIndex).slice(0,40).map(M=>M.entry.p);return Xe.current.set(c,d),d},Be=e=>{if(!e)return null;const n=String(e);return h.find(a=>String(a==null?void 0:a.id)===n)||null},Ye=e=>{if(e==null||e==="")return[];let n=e;if(typeof n=="string"){const a=n.trim();if(!a)return[];try{n=JSON.parse(a)}catch(s){return[]}}return Array.isArray(n)?n.map((a,s)=>{var T;if(!a||typeof a!="object")return null;const c=String((T=a.name)!=null?T:"").trim()||`Bi\u1EBFn th\u1EC3 ${s+1}`,p=(Array.isArray(a.options)?a.options:[]).map(g=>{var He,Re,lt,Je,pt,ht,Ee;if(!g||typeof g!="object")return null;const d=String((He=g.label)!=null?He:"").trim();if(!d)return null;const o=(pt=(Je=(lt=(Re=g.price)!=null?Re:g.priceValue)!=null?lt:g.unit_price)!=null?Je:g.unitPrice)!=null?pt:null,m=Number(o),M=Number.isFinite(m)?Math.trunc(m):null,L=(Ee=(ht=g.price_delta)!=null?ht:g.priceDelta)!=null?Ee:null,Y=Number(L),ye=Number.isFinite(Y)?Math.trunc(Y):0;return{label:d,price:M,price_delta:ye}}).filter(Boolean);return{name:c,options:p}}).filter(Boolean):[]},St=e=>{const n=Be(e);return Ye(n==null?void 0:n.variants)},gt=e=>{if(!e||typeof e!="object")return"";const n=[];for(const[a,s]of Object.entries(e)){const c=String(a||"").trim(),p=String(s||"").trim();!c||!p||n.push(`${c}: ${p}`)}return n.join(", ")},vt=(e,n)=>{var T;const a=$t(e==null?void 0:e.price),s=Ye(e==null?void 0:e.variants);if(!s.length||!n||typeof n!="object")return a;let c=a,p=!1;for(const g of s){const d=String((g==null?void 0:g.name)||"").trim(),o=String((n==null?void 0:n[d])||"").trim();if(!d||!o)continue;const m=(Array.isArray(g.options)?g.options:[]).find(Y=>String((Y==null?void 0:Y.label)||"").trim()===o);if(!m)continue;const M=Number(m==null?void 0:m.price);if(Number.isFinite(M)){c=Math.max(0,Math.trunc(M)),p=!0;continue}const L=Number((T=m==null?void 0:m.price_delta)!=null?T:0);Number.isFinite(L)&&(c+=Math.trunc(L))}return c},xt=e=>window.KTM.orders.getOrderItems(e),_t=e=>window.KTM.orders.getOrderTotalQty(e),At=e=>window.KTM.orders.getOrderProductSummary(e,Be),Dt=e=>window.KTM.orders.getOrderItemRows(e,Be),Ft=e=>window.KTM.orders.getOrderAdjustmentMoney(e),Ut=e=>{const n=xt(e),a=Dt(e),s=Bt(n),c=Ht(n),p=c.fee,T=Ft(e),g=s+p+T,d=[];if(e!=null&&e.customer_name&&d.push(`KH\xC1CH: ${e.customer_name}`),e!=null&&e.phone&&d.push(`S\u0110T: ${e.phone}`),e!=null&&e.address&&d.push(`\u0110\u1ECAA CH\u1EC8: ${e.address}`),((e==null?void 0:e.note)||"").trim()&&d.push(`GHI CH\xDA: ${(e.note||"").trim()}`),d.push(""),d.push("S\u1EA2N PH\u1EA8M:"),a.length)for(const o of a)d.push(`- ${o.name} (SL: ${o.qty})`);else{const o=At(e);o&&o!=="\u2014"&&d.push(`- ${o}`)}d.push(""),d.push(`T\u1EA0M T\xCDNH: ${Ve(s)}`),c.found&&p!==0&&d.push(`SHIP: ${Ve(p)}`);{const o=String((e==null?void 0:e.adjustment_note)||"").trim();(T!==0||o)&&d.push(`\u0110I\u1EC0U CH\u1EC8NH: ${Ve(T)}${o?` (${o})`:""}`)}return d.push(`T\u1ED4NG: ${Ve(g)}`),d.filter(Boolean).join(`
`)},Vt=async e=>{try{const n=Ut(e);await window.KTM.clipboard.writeText(n),typeof C=="function"?C("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng","success"):alert("\u0110\xE3 copy th\xF4ng tin \u0111\u01A1n h\xE0ng")}catch(n){console.error(n),typeof C=="function"?C("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)","danger"):alert("Copy th\u1EA5t b\u1EA1i (tr\xECnh duy\u1EC7t ch\u1EB7n clipboard)")}},Ht=e=>window.KTM.orders.getOrderShipInfo(e,Be),Bt=e=>window.KTM.orders.getItemsSubtotal(e,Be),Gt=e=>{try{const n=e instanceof Date?e:new Date(e);if(!n||Number.isNaN(n.getTime()))return"";const a=n.getFullYear(),s=String(n.getMonth()+1).padStart(2,"0");return`${a}-${s}`}catch(n){return""}},Wt=()=>Ne?String(Ne):Gt(new Date),Xt=e=>{const n=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),a=$e((e==null?void 0:e.phone)||""),s=String((e==null?void 0:e.address)||"").trim().toLowerCase(),c=bt(e==null?void 0:e.adjustment_amount),T=(Array.isArray(e==null?void 0:e.items)?e.items:[]).map(g=>{var d;return{product_id:String((g==null?void 0:g.product_id)||"").trim(),quantity:Number((d=g==null?void 0:g.quantity)!=null?d:0),variant:String((g==null?void 0:g.variant)||"").trim()}}).filter(g=>g.product_id&&Number.isFinite(g.quantity)&&g.quantity>0).sort((g,d)=>g.product_id<d.product_id?-1:g.product_id>d.product_id?1:g.variant<d.variant?-1:g.variant>d.variant?1:g.quantity-d.quantity);return JSON.stringify({name:n,phone:a,address:s,items:T,adj:c})},Ot=React.useMemo(()=>{const e=$e((r==null?void 0:r.phone)||"");if(!e)return{count:0,orders:[],monthKey:Wt()};const n=Wt(),a=(Array.isArray(z)?z:[]).filter(s=>{if(!s||P&&String(s.id)===String(P)||$e(s.phone||"")!==e)return!1;const c=Gt(s.created_at);return c&&c===n}).sort((s,c)=>{const p=new Date(s.created_at).getTime(),T=new Date(c.created_at).getTime();return(Number.isFinite(T)?T:0)-(Number.isFinite(p)?p:0)});return{count:a.length,orders:a,monthKey:n}},[z,r==null?void 0:r.phone,Ne,P]),na=e=>{var g;const n=String((e==null?void 0:e.customer_name)||"").trim().toLowerCase(),a=$e((e==null?void 0:e.phone)||""),s=String((e==null?void 0:e.address)||"").trim().toLowerCase(),c=bt((g=e==null?void 0:e.adjustment_amount)!=null?g:0),p=xt(e),T=(Array.isArray(p)?p:[]).map(d=>{var o;return{product_id:String((d==null?void 0:d.product_id)||"").trim(),quantity:Number((o=d==null?void 0:d.quantity)!=null?o:0),variant:String((d==null?void 0:d.variant)||"").trim()}}).filter(d=>d.product_id&&Number.isFinite(d.quantity)&&d.quantity>0).sort((d,o)=>d.product_id<o.product_id?-1:d.product_id>o.product_id?1:d.variant<o.variant?-1:d.variant>o.variant?1:d.quantity-o.quantity);return JSON.stringify({name:n,phone:a,address:s,items:T,adj:c})},Yt=React.useMemo(()=>{if(P)return"";const e=$e((r==null?void 0:r.phone)||"");if(!e)return"";const n=Wt(),a=Xt(r),s=Array.isArray(z)?z:[];for(const c of s){if(!c||P&&String(c.id)===String(P)||$e(c.phone||"")!==e)continue;const p=Gt(c.created_at);if(!p||p!==n)continue;const T=na(c);if(T&&T===a)return`\u0110\u01A1n n\xE0y gi\u1ED1ng 100% m\u1ED9t \u0111\u01A1n trong th\xE1ng ${n}${c!=null&&c.id?` (#${c.id})`:""}`}return""},[z,r,Ne,P]),Zt=e=>{var lt;const n=[],a=[],s=String((e==null?void 0:e.customer_name)||"").trim(),c=$e((e==null?void 0:e.phone)||""),p=String((e==null?void 0:e.address)||"").trim();s||n.push("Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng"),c||n.push("Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i"),c&&!ut(c)&&n.push("S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)"),p||a.push("Thi\u1EBFu \u0111\u1ECBa ch\u1EC9");const g=(Array.isArray(e==null?void 0:e.items)?e.items:[]).filter(Je=>Je&&Je.product_id);g.length===0&&n.push("Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m"),g.some(Je=>{var ht;const pt=Number((ht=Je==null?void 0:Je.quantity)!=null?ht:0);return!Number.isFinite(pt)||pt<=0})&&n.push("S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0");const o=new Set;let m=!1;for(const Je of g){const pt=String(Je.product_id||"").trim(),ht=String((Je==null?void 0:Je.variant)||"").trim();if(!pt)continue;const Ee=`${pt}||${ht}`;if(o.has(Ee)){m=!0;break}o.add(Ee)}m&&a.push("S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)");const M=Bt(g),L=Ht(g),Y=L!=null&&L.found?Number((lt=L==null?void 0:L.fee)!=null?lt:0):0,ye=bt(e==null?void 0:e.adjustment_amount),He=String((e==null?void 0:e.adjustment_note)||"").trim();L!=null&&L.found&&(Y>=2e5||M>0&&Y>M*.6)&&a.push(`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${Ve(Y)}`),ye!==0&&!He&&a.push("C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh");const Re=Math.abs(ye);return(Re>=5e5||M>0&&Re>M*.5)&&ye!==0&&a.push(`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${Ve(ye)}`),{errors:n,warnings:a,canSubmit:n.length===0}},la=React.useMemo(()=>Zt(r),[r,h]),ot=React.useMemo(()=>{var ht;const e=String((r==null?void 0:r.customer_name)||"").trim(),n=$e((r==null?void 0:r.phone)||""),a=String((r==null?void 0:r.address)||"").trim(),s=Array.isArray(r==null?void 0:r.items)?r.items:[],c=new Map;for(const Ee of s){const qt=String((Ee==null?void 0:Ee.product_id)||"").trim(),zt=String((Ee==null?void 0:Ee.variant)||"").trim();if(!qt)continue;const Jt=`${qt}||${zt}`;c.set(Jt,(c.get(Jt)||0)+1)}const p=s.map(Ee=>{var aa;const qt=String((Ee==null?void 0:Ee.product_id)||"").trim(),zt=Number((aa=Ee==null?void 0:Ee.quantity)!=null?aa:0),Jt=qt?"":"Ch\u01B0a ch\u1ECDn s\u1EA3n ph\u1EA9m",sa=Number.isFinite(zt)&&zt>0?"":"S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i > 0",ia=String((Ee==null?void 0:Ee.variant)||"").trim(),ra=`${qt}||${ia}`,oa=qt&&(c.get(ra)||0)>1?"S\u1EA3n ph\u1EA9m b\u1ECB tr\xF9ng d\xF2ng (n\xEAn g\u1ED9p s\u1ED1 l\u01B0\u1EE3ng)":"";return{productError:Jt,qtyError:sa,dupWarn:oa}}),T=s.filter(Ee=>Ee&&Ee.product_id),g=Bt(T),d=Ht(T),o=d!=null&&d.found?Number((ht=d==null?void 0:d.fee)!=null?ht:0):0,m=bt(r==null?void 0:r.adjustment_amount),M=String((r==null?void 0:r.adjustment_note)||"").trim(),L=Math.abs(m),Y=m!==0&&!M?"C\xF3 \u0111i\u1EC1u ch\u1EC9nh nh\u01B0ng thi\u1EBFu ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh":"",ye=m!==0&&(L>=5e5||g>0&&L>g*.5)?`\u0110i\u1EC1u ch\u1EC9nh c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${Ve(m)}`:"",He=d!=null&&d.found&&(o>=2e5||g>0&&o>g*.6)?`Ship c\xF3 v\u1EBB b\u1EA5t th\u01B0\u1EDDng: ${Ve(o)}`:"",Re=e?"":"Thi\u1EBFu t\xEAn kh\xE1ch h\xE0ng",lt=n?ut(n)?"":"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i kh\xF4ng h\u1EE3p l\u1EC7 (c\u1EA7n 9-12 ch\u1EEF s\u1ED1)":"Thi\u1EBFu s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",Je=a?"":"Thi\u1EBFu \u0111\u1ECBa ch\u1EC9",pt=!Re&&!lt&&p.every(Ee=>!Ee.productError&&!Ee.qtyError);return{nameError:Re,phoneError:lt,addressWarn:Je,items:p,shipAbnormalWarn:He,adjustmentNoteWarn:Y,adjustmentAbnormalWarn:ye,canSubmit:pt}},[r,h]),ea=async e=>{var T,g,d;const n=(e==null?void 0:e.mode)||"close",a=Zt(r);if(!a.canSubmit){const o=a.errors[0]||"Thi\u1EBFu d\u1EEF li\u1EC7u b\u1EAFt bu\u1ED9c";typeof C=="function"?C(o,"danger"):alert(o);return}if(!P&&Yt){const o=`${Yt}

B\u1EA1n c\xF3 mu\u1ED1n ti\u1EBFp t\u1EE5c l\u01B0u kh\xF4ng?`;if(!window.confirm(o)){(Ot==null?void 0:Ot.count)>0&&W(!0),setTimeout(()=>{var L;const M=document.getElementById("order-phone-input");M&&typeof M.scrollIntoView=="function"&&(M.scrollIntoView({block:"center",behavior:"smooth"}),(L=M.focus)==null||L.call(M))},0);return}}const s=$e(r.phone),p=(Array.isArray(r.items)?r.items:[]).map(o=>{var m,M;return{product_id:(o==null?void 0:o.product_id)||"",quantity:Number((m=o==null?void 0:o.quantity)!=null?m:1),variant:String((o==null?void 0:o.variant)||"").trim()||null,variant_json:(M=o==null?void 0:o.variant_json)!=null?M:null,unit_price:(()=>{const L=o==null?void 0:o.unit_price,Y=Number(L);if(Number.isFinite(Y))return Math.max(0,Math.trunc(Y));const ye=Be(o==null?void 0:o.product_id),He=o!=null&&o.variant_json&&typeof o.variant_json=="object"?o.variant_json:null;return vt(ye,He)})()}}).filter(o=>o.product_id&&Number.isFinite(o.quantity)&&o.quantity>0);ee(!0);try{const o=P?`${API_BASE}/api/orders/${P}`:`${API_BASE}/api/orders`,m=p[0],M={customer_name:r.customer_name,phone:s,address:r.address,note:(r.note||"").trim(),adjustment_amount:bt(r.adjustment_amount),adjustment_note:(r.adjustment_note||"").trim(),product_id:m.product_id,quantity:m.quantity,status:r.status,items:p,...P?{id:P}:{}};if(P)await window.KTM.api.putJSON(o,M,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");else{const L=await window.KTM.api.postJSON(o,M,"L\u1ED7i l\u01B0u \u0111\u01A1n h\xE0ng");Rt.current={id:(d=(g=L==null?void 0:L.id)!=null?g:(T=L==null?void 0:L.order)==null?void 0:T.id)!=null?d:null,fingerprint:Xt(r),ts:Date.now()}}n==="new"&&!P?(Ct(""),Me(null),x(!0)):(Ct(""),Me(null),x(!1)),rt()}catch(o){console.error(o),typeof C=="function"?C(o.message,"danger"):alert(o.message);return}finally{ee(!1)}},Qt=e=>window.KTM.orders.getOrderTotalMoney(e,Be),ta=async e=>{if(confirm("X\xF3a \u0111\u01A1n h\xE0ng n\xE0y?")){ke(e);try{await window.KTM.api.deleteJSON(`${API_BASE}/api/orders/${e}`,"L\u1ED7i x\xF3a \u0111\u01A1n h\xE0ng"),rt(),Nt()}catch(n){console.error(n),typeof C=="function"?C(n.message,"danger"):alert(n.message)}finally{ke(null)}}},jt=async(e,n)=>{var s;const a=e==null?void 0:e.id;if(!(!a||!n)){De(a);try{const c=xt(e),p=(Array.isArray(c)?c:[]).map(d=>{var o,m;return{product_id:(d==null?void 0:d.product_id)||"",quantity:Number((o=d==null?void 0:d.quantity)!=null?o:1),variant:String((d==null?void 0:d.variant)||"").trim()||null,variant_json:(m=d==null?void 0:d.variant_json)!=null?m:null,unit_price:(()=>{var Y;const M=(Y=d==null?void 0:d.unit_price)!=null?Y:d==null?void 0:d.unitPrice,L=Number(M);return Number.isFinite(L)?Math.max(0,Math.trunc(L)):null})()}}).filter(d=>d.product_id&&Number.isFinite(d.quantity)&&d.quantity>0);if(!p.length)throw new Error("Kh\xF4ng th\u1EC3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i: \u0111\u01A1n kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m h\u1EE3p l\u1EC7");const T=p[0],g={id:a,customer_name:(e==null?void 0:e.customer_name)||"",phone:$e((e==null?void 0:e.phone)||""),address:(e==null?void 0:e.address)||"",note:((e==null?void 0:e.note)||"").trim(),adjustment_amount:Number((s=e==null?void 0:e.adjustment_amount)!=null?s:0)||0,adjustment_note:(e==null?void 0:e.adjustment_note)||"",product_id:T.product_id,quantity:T.quantity,status:n,items:p};await window.KTM.api.putJSON(`${API_BASE}/api/orders/${a}`,g,"L\u1ED7i c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i"),U(d=>Array.isArray(d)?d.map(o=>(o==null?void 0:o.id)===a?{...o,status:n}:o):d),D(d=>Array.isArray(d)?d.map(o=>(o==null?void 0:o.id)===a?{...o,status:n}:o):d),typeof C=="function"&&C("\u0110\xE3 c\u1EADp nh\u1EADt tr\u1EA1ng th\xE1i","success")}catch(c){console.error(c),typeof C=="function"?C(c.message,"danger"):alert(c.message)}finally{De(null)}}};return React.createElement("div",{className:"product-manager"},React.createElement(Loading,{show:Z&&!i||ie||!!de||!!he}),React.createElement("div",{className:"product-header"},React.createElement("h5",null,"Qu\u1EA3n l\xFD \u0111\u01A1n h\xE0ng"),React.createElement("button",{className:"btn btn-dark btn-sm",onClick:Lt,disabled:ie||!!de},React.createElement("i",{className:"fas fa-plus me-2"}),"T\u1EA1o \u0111\u01A1n")),React.createElement("div",{className:"product-search"},React.createElement("div",{className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-5"},React.createElement("label",{className:"form-label mb-1"},"L\u1ECDc theo th\xE1ng"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-calendar-alt"})),React.createElement("input",{type:"month",className:"form-control",value:Ne,onChange:e=>Oe(e.target.value),"aria-label":"Ch\u1ECDn th\xE1ng",disabled:Ie}),Ne&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{Oe("")},title:"B\u1ECF l\u1ECDc","aria-label":"B\u1ECF l\u1ECDc",disabled:Z},React.createElement("i",{className:"fas fa-times"})))),React.createElement("div",{className:"col-12 col-md-4"},React.createElement("label",{className:"form-label mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text","aria-hidden":"true"},React.createElement("i",{className:"fas fa-filter"})),React.createElement("select",{className:"form-select",value:Ze,onChange:e=>_e(e.target.value),"aria-label":"L\u1ECDc theo tr\u1EA1ng th\xE1i",disabled:Ie},React.createElement("option",{value:""},"T\u1EA5t c\u1EA3"),React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n")),Ze&&React.createElement("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>_e(""),title:"B\u1ECF l\u1ECDc tr\u1EA1ng th\xE1i","aria-label":"B\u1ECF l\u1ECDc tr\u1EA1ng th\xE1i",disabled:Z},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"form-check mt-2"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:"orders-overdue-only",checked:Ie,onChange:e=>{const n=!!e.target.checked;w(n),n&&_e("pending")}}),React.createElement("label",{className:"form-check-label",htmlFor:"orders-overdue-only"},"Ch\u1EC9 hi\u1EC7n \u0111\u01A1n ch\u1EADm > ",u," ng\xE0y (Ch\u1EDD x\u1EED l\xFD)"))),React.createElement("div",{className:"col-12 col-md-3 d-flex gap-2 justify-content-md-end"},React.createElement("button",{className:"btn btn-outline-secondary",onClick:rt,disabled:Z},React.createElement("i",{className:"fas fa-rotate me-2"}),"L\xE0m m\u1EDBi")))),React.createElement("div",{className:"card p-3"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("h6",{className:"mb-0"},"Danh s\xE1ch \u0111\u01A1n h\xE0ng"),React.createElement("span",{className:"text-muted small"},Ze?`${Qe.length}/${z.length} \u0111\u01A1n`:`${z.length} \u0111\u01A1n`)),ce.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-triangle-exclamation me-2"}),"C\xF3 ",React.createElement("strong",null,ce.length)," \u0111\u01A1n ",React.createElement("strong",null,"Ch\u1EDD x\u1EED l\xFD")," qu\xE1 ",u," ng\xE0y.",V&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{w(!0),_e("pending")}},"Xem ngay")),We.length>0&&React.createElement("div",{className:"alert alert-warning d-flex align-items-center justify-content-between gap-2 mt-3 mb-0",role:"alert"},React.createElement("div",{style:{minWidth:0}},React.createElement("i",{className:"fas fa-clock me-2"}),"C\xF3 ",React.createElement("strong",null,We.length)," \u0111\u01A1n ",React.createElement("strong",null,"Nh\xE1p")," s\u1EAFp t\u1EF1 x\xF3a (c\xF2n \u2264 ",y," ng\xE0y).",me&&React.createElement("span",{className:"ms-2 text-muted small"},"(\u0111ang c\u1EADp nh\u1EADt...)")),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-dark",onClick:()=>{w(!1),_e("draft"),Oe(""),rt()}},"Xem ngay")),Z?React.createElement("div",{className:"text-center py-4"},React.createElement("div",{className:"spinner-border text-warning"})):z.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},"Ch\u01B0a c\xF3 \u0111\u01A1n h\xE0ng"):Qe.length===0?React.createElement("div",{className:"text-center py-4 text-muted"},"Kh\xF4ng c\xF3 \u0111\u01A1n ph\xF9 h\u1EE3p"):React.createElement(React.Fragment,null,React.createElement("div",{className:"d-md-none mt-3"},Qe.map(e=>{var n;return React.createElement("div",{key:e.id,className:"card mb-2"},React.createElement("div",{className:"card-body p-3"},React.createElement("div",{className:"d-flex justify-content-between align-items-start gap-2"},React.createElement("div",{className:"flex-grow-1",style:{minWidth:0}},React.createElement("div",{className:"fw-semibold text-truncate"},e.customer_name),React.createElement("div",{className:"fw-bold font-monospace"},e.phone),Number((n=e==null?void 0:e.split_seq)!=null?n:0)>0&&React.createElement("div",{className:"text-muted small"},"\u0110\u1EE3t ",e.split_seq),e.address&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},e.address),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("div",{className:"d-flex align-items-start gap-1 flex-shrink-0"},React.createElement("span",{className:`badge ${B(e.status)}`},Ce(e.status)),ze(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${u} ng\xE0y`},"\u26A0 Ch\u1EADm ",qe(e),"d"),nt(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 x\xF3a sau ${_} ng\xE0y`},"\u23F3 C\xF2n ",at(e),"d"))),React.createElement("div",{className:"mt-2 small"},React.createElement("div",null,React.createElement("div",{className:"text-muted"},"S\u1EA3n ph\u1EA9m:"),(()=>{const a=Dt(e);return a.length?React.createElement("div",{className:"mt-1"},a.map((s,c)=>React.createElement("div",{key:c,className:"d-flex justify-content-between gap-2",style:{lineHeight:1.25}},React.createElement("div",{className:"fw-semibold",style:{minWidth:0,whiteSpace:"normal",wordBreak:"break-word",flex:1}},React.createElement("span",{className:"text-muted me-1"},c+1,"."),s.name),React.createElement("div",{className:"text-muted small text-end text-nowrap",style:{flexShrink:0}},"x",s.qty,Number(s.unitPrice)>0?` \u2022 ${Ve(s.unitPrice)}`:"")))):React.createElement("div",{className:"fw-semibold",style:{whiteSpace:"normal",wordBreak:"break-word"}},At(e))})()),(Ft(e)!==0||((e==null?void 0:e.adjustment_note)||"").trim())&&React.createElement("div",{style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh:")," ",React.createElement("span",{className:"fw-semibold"},Ve(Ft(e))),((e==null?void 0:e.adjustment_note)||"").trim()?React.createElement("span",{className:"text-muted"}," ","(",(e.adjustment_note||"").trim(),")"):null),React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng ti\u1EC1n"),React.createElement("span",{className:"fw-bold"},Ve(Qt(e)))),React.createElement("div",{className:"text-muted"},React.createElement("span",null,"Th\u1EDDi gian:")," ",st(e.created_at))),React.createElement("div",{className:"mt-3 d-flex gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-primary flex-fill",onClick:()=>Tt(e),disabled:ie||!!de||he===e.id},"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary flex-fill",onClick:()=>Vt(e),disabled:ie||!!de||he===e.id},React.createElement("i",{className:"fas fa-copy me-1"}),"Copy"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger flex-fill",onClick:()=>ta(e.id),disabled:ie||de===e.id||he===e.id},de===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a")),React.createElement("div",{className:"mt-2 d-flex gap-2"},React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning flex-fill",onClick:()=>jt(e,"processing"),disabled:ie||!!de||he===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success flex-fill",onClick:()=>jt(e,"done"),disabled:ie||!!de||he===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary flex-fill",onClick:()=>jt(e,"paid"),disabled:ie||!!de||he===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger flex-fill",onClick:()=>jt(e,"canceled"),disabled:ie||!!de||he===e.id||e.status==="canceled",title:"H\u1EE7y \u0111\u01A1n"},"H\u1EE7y"))))})),React.createElement("div",{className:"d-none d-md-block"},React.createElement("div",{className:"table-responsive orders-table-wrap mt-3"},React.createElement("table",{className:"table orders-table table-hover align-middle mb-0"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Kh\xE1ch h\xE0ng"),React.createElement("th",null,"S\u0110T"),React.createElement("th",null,"S\u1EA3n ph\u1EA9m"),React.createElement("th",null,"SL"),React.createElement("th",null,"T\u1ED5ng ti\u1EC1n"),React.createElement("th",null,"Tr\u1EA1ng th\xE1i"),React.createElement("th",null,"Th\u1EDDi gian"),React.createElement("th",null))),React.createElement("tbody",null,Qe.map(e=>React.createElement("tr",{key:e.id},React.createElement("td",null,React.createElement("div",{className:"fw-semibold"},e.customer_name),((e==null?void 0:e.note)||"").trim()&&React.createElement("div",{className:"text-muted small",style:{whiteSpace:"normal",wordBreak:"break-word"}},React.createElement("span",{className:"fw-semibold"},"Ghi ch\xFA:")," ",(e.note||"").trim())),React.createElement("td",null,e.phone),React.createElement("td",null,(()=>{const n=Dt(e);return n.length?React.createElement("div",{className:"d-grid gap-1"},n.map((a,s)=>React.createElement("div",{key:s,className:"small",style:{whiteSpace:"normal",wordBreak:"break-word",lineHeight:1.2}},React.createElement("span",{className:"text-muted me-1"},s+1,"."),React.createElement("span",{className:"fw-semibold"},a.name)," ",React.createElement("span",{className:"text-muted"},"x",a.qty),Number(a.unitPrice)>0&&React.createElement("span",{className:"text-muted"}," ","\u2022 ",Ve(a.unitPrice))))):At(e)})()),React.createElement("td",null,_t(e)),React.createElement("td",{className:"fw-semibold"},Ve(Qt(e))),React.createElement("td",null,React.createElement("div",{className:"d-flex align-items-center gap-1 flex-wrap"},React.createElement("span",{className:`badge ${B(e.status)}`},Ce(e.status)),ze(e)&&React.createElement("span",{className:"badge bg-danger",title:`Ch\u1EDD x\u1EED l\xFD qu\xE1 ${u} ng\xE0y`},"\u26A0 Ch\u1EADm ",qe(e),"d"),nt(e)&&React.createElement("span",{className:"badge bg-warning text-dark",title:`\u0110\u01A1n nh\xE1p s\u1EBD t\u1EF1 x\xF3a sau ${_} ng\xE0y`},"\u23F3 C\xF2n ",at(e),"d"))),React.createElement("td",null,st(e.created_at)),React.createElement("td",null,React.createElement("button",{type:"button",className:"btn btn-sm btn-primary me-1",onClick:()=>Tt(e),disabled:ie||!!de||he===e.id},"S\u1EEDa"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary me-1",onClick:()=>Vt(e),disabled:ie||!!de||he===e.id},React.createElement("i",{className:"fas fa-copy"})),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning me-1",onClick:()=>jt(e,"processing"),disabled:ie||!!de||he===e.id||e.status==="processing",title:"\u0110ang v\u1EADn chuy\u1EC3n"},"Processing"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-success me-1",onClick:()=>jt(e,"done"),disabled:ie||!!de||he===e.id||e.status==="done",title:"Ho\xE0n th\xE0nh"},"Done"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-primary me-1",onClick:()=>jt(e,"paid"),disabled:ie||!!de||he===e.id||e.status==="paid",title:"\u0110\xE3 nh\u1EADn ti\u1EC1n"},"Paid"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-danger me-1",onClick:()=>jt(e,"canceled"),disabled:ie||!!de||he===e.id||e.status==="canceled",title:"H\u1EE7y \u0111\u01A1n"},"H\u1EE7y"),React.createElement("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>ta(e.id),disabled:ie||de===e.id},de===e.id?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang x\xF3a"):"X\xF3a")))))))))),i&&React.createElement("div",{className:"modal show d-block order-modal",style:{background:"rgba(0,0,0,0.6)"},role:"dialog","aria-modal":"true"},React.createElement("div",{className:"modal-dialog modal-dialog-scrollable"},React.createElement("div",{className:"modal-content",style:{borderRadius:16}},React.createElement("div",{className:"modal-header",style:{background:"linear-gradient(135deg, #ffc107, #ffca2c)",border:"none",borderRadius:"16px 16px 0 0"}},React.createElement("h5",{className:"modal-title fw-bold text-dark mb-0"},React.createElement("i",{className:"fas fa-receipt me-2"}),P?"S\u1EEDa \u0111\u01A1n h\xE0ng":"T\u1EA1o \u0111\u01A1n h\xE0ng"),React.createElement("button",{type:"button",className:"btn-close",onClick:wt})),React.createElement("form",{onSubmit:e=>{e.preventDefault(),ea({mode:"close"})}},React.createElement("div",{className:"modal-body",ref:Mt},React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"T\xEAn kh\xE1ch h\xE0ng *"),React.createElement("input",{className:"form-control",value:r.customer_name,onChange:e=>oe({...r,customer_name:e.target.value}),placeholder:"Nh\u1EADp t\xEAn kh\xE1ch h\xE0ng",required:!0,style:{borderRadius:10,padding:12}}),!!ot.nameError&&React.createElement("div",{className:"form-text text-danger"},ot.nameError)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1ED1 \u0111i\u1EC7n tho\u1EA1i *"),React.createElement("input",{className:"form-control",type:"tel",inputMode:"numeric",pattern:"[0-9+\\s-]*",id:"order-phone-input",value:r.phone,onChange:e=>k(e.target.value),onBlur:J,placeholder:"Nh\u1EADp s\u1ED1 \u0111i\u1EC7n tho\u1EA1i",required:!0,style:{borderRadius:10,padding:12}}),!!ot.phoneError&&React.createElement("div",{className:"form-text text-danger"},ot.phoneError),!ot.phoneError&&Ot.count>0&&React.createElement("div",{className:"form-text text-warning d-flex align-items-center justify-content-between gap-2"},React.createElement("span",null,"Kh\xE1ch n\xE0y \u0111\xE3 c\xF3 ",Ot.count," \u0111\u01A1n trong th\xE1ng ",Ot.monthKey,"."),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-warning",onClick:()=>W(e=>!e)},ae?"\u1EA8n l\u1ECBch s\u1EED":"Xem l\u1ECBch s\u1EED")),ae&&Ot.orders.length>0&&React.createElement("div",{className:"mt-2 border rounded-3 p-2",style:{background:"#fff"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between gap-2 mb-2"},React.createElement("div",{className:"small fw-semibold"},"L\u1ECBch s\u1EED \u0111\u01A1n (c\xF9ng th\xE1ng)"),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>W(!1)},"\u1EA8n")),React.createElement("div",{className:"d-grid gap-2"},Ot.orders.slice(0,5).map(e=>React.createElement("div",{key:e.id,className:"d-flex align-items-start justify-content-between gap-2"},React.createElement("div",{style:{minWidth:0,flex:1}},React.createElement("div",{className:"small fw-semibold",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},"#",e.id," \u2022 ",React.createElement("span",{className:`badge ${B(e.status)}`},Ce(e.status))),React.createElement("div",{className:"text-muted small"},st(e.created_at)," \u2022 ",Ve(Qt(e))),React.createElement("div",{className:"text-muted small",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},At(e))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{confirm(`M\u1EDF \u0111\u01A1n #${e.id}? D\u1EEF li\u1EC7u \u0111ang nh\u1EADp s\u1EBD m\u1EA5t.`)&&Tt(e)}},"M\u1EDF")))),Ot.orders.length>5&&React.createElement("div",{className:"text-muted small mt-2"},"Ch\u1EC9 hi\u1EC3n th\u1ECB 5 \u0111\u01A1n g\u1EA7n nh\u1EA5t.")),(j==null?void 0:j.status)==="loading"&&React.createElement("div",{className:"form-text"},"\u0110ang t\xECm kh\xE1ch theo S\u0110T..."),(j==null?void 0:j.status)==="found"&&React.createElement("div",{className:"form-text text-success"},"\u0110\xE3 c\xF3 kh\xE1ch, t\u1EF1 \u0111\u1ED9ng \u0111i\u1EC1n th\xF4ng tin."),(j==null?void 0:j.status)==="not-found"&&React.createElement("div",{className:"form-text text-muted"},"Ch\u01B0a c\xF3 kh\xE1ch, s\u1EBD t\u1EA1o m\u1EDBi khi l\u01B0u \u0111\u01A1n."),(j==null?void 0:j.status)==="error"&&React.createElement("div",{className:"form-text text-danger"},"Kh\xF4ng tra \u0111\u01B0\u1EE3c kh\xE1ch (l\u1ED7i m\u1EA1ng/server).")),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Tr\u1EA1ng th\xE1i"),React.createElement("select",{className:"form-select",value:r.status,onChange:e=>oe({...r,status:e.target.value}),style:{borderRadius:10,padding:12}},React.createElement("option",{value:"draft"},"\u0110\u01A1n nh\xE1p"),React.createElement("option",{value:"pending"},"Ch\u1EDD x\u1EED l\xFD"),React.createElement("option",{value:"processing"},"\u0110ang v\u1EADn chuy\u1EC3n"),React.createElement("option",{value:"done"},"Ho\xE0n th\xE0nh"),React.createElement("option",{value:"paid"},"\u0110\xE3 nh\u1EADn ti\u1EC1n"),React.createElement("option",{value:"canceled"},"H\u1EE7y \u0111\u01A1n"))),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110\u1ECBa ch\u1EC9"),React.createElement("input",{className:"form-control",value:r.address,onChange:e=>oe({...r,address:e.target.value}),placeholder:"Nh\u1EADp \u0111\u1ECBa ch\u1EC9 (kh\xF4ng b\u1EAFt bu\u1ED9c)",style:{borderRadius:10,padding:12}}),!!ot.addressWarn&&React.createElement("div",{className:"form-text text-warning"},ot.addressWarn)),React.createElement("div",{className:"col-12"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111\u01A1n h\xE0ng"),React.createElement("textarea",{className:"form-control",value:r.note,onChange:e=>oe({...r,note:e.target.value}),placeholder:"V\xED d\u1EE5: Giao gi\u1EDD h\xE0nh ch\xEDnh / G\u1ECDi tr\u01B0\u1EDBc khi giao...",rows:2,style:{borderRadius:10,padding:12,resize:"vertical"}})),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"\u0110i\u1EC1u ch\u1EC9nh gi\xE1 (th\xEAm/b\u1EDBt)"),React.createElement("input",{type:"number",className:"form-control",value:r.adjustment_amount,onChange:e=>oe({...r,adjustment_amount:e.target.value}),placeholder:"-20000 ho\u1EB7c 20000",step:"1000",style:{borderRadius:10,padding:12}}),React.createElement("div",{className:"form-text"},"\xC2m = gi\u1EA3m gi\xE1, d\u01B0\u01A1ng = c\u1ED9ng th\xEAm."),!!ot.adjustmentAbnormalWarn&&React.createElement("div",{className:"form-text text-warning"},ot.adjustmentAbnormalWarn)),React.createElement("div",{className:"col-12 col-md-6"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh"),React.createElement("input",{className:"form-control",value:r.adjustment_note,onChange:e=>oe({...r,adjustment_note:e.target.value}),placeholder:"V\xED d\u1EE5: Gi\u1EA3m gi\xE1 cho kh\xE1ch / B\xF9 ph\xED \u0111\xF3ng g\xF3i...",style:{borderRadius:10,padding:12}}),!!ot.adjustmentNoteWarn&&React.createElement("div",{className:"form-text text-warning"},ot.adjustmentNoteWarn)),React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("label",{className:"form-label fw-semibold small text-muted mb-1"},"S\u1EA3n ph\u1EA9m *"),React.createElement("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>{oe(e=>({...e,items:[...Array.isArray(e.items)?e.items:[],{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]})),je(e=>[...Array.isArray(e)?e:[],""]),P&&R(e=>[...Array.isArray(e)?e:[],!0])},disabled:ie},React.createElement("i",{className:"fas fa-plus me-2"}),"Th\xEAm s\u1EA3n ph\u1EA9m")),React.createElement("div",{className:"d-grid gap-2"},(Array.isArray(r.items)?r.items:[{product_id:"",quantity:1}]).map((e,n)=>React.createElement("div",{key:n,className:"row g-2 align-items-end"},React.createElement("div",{className:"col-12 col-md-8"},React.createElement("div",{className:"dropdown w-100",ref:a=>{ge.current[n]=a}},React.createElement("button",{type:"button",className:"form-control text-start d-flex align-items-center justify-content-between",style:{borderRadius:10,padding:12},onClick:()=>{b(a=>a===n?null:n),setTimeout(()=>{const a=document.getElementById(`order-product-search-${n}`);a&&a.focus()},0)}},React.createElement("span",{className:e.product_id?"":"text-muted",style:{minWidth:0,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}},O(e.product_id)),React.createElement("i",{className:"fas fa-chevron-down text-muted",style:{marginLeft:8,flexShrink:0}})),l===n&&React.createElement("div",{className:"dropdown-menu show w-100 p-2",style:{maxHeight:320,overflowY:"auto"}},React.createElement("input",{id:`order-product-search-${n}`,className:"form-control",value:Le[n]||"",onChange:a=>{const s=a.target.value;je(c=>{const p=Array.isArray(c)?[...c]:[];return p[n]=s,p})},placeholder:"T\xECm theo t\xEAn / m\xE3...",style:{borderRadius:10,padding:10}}),React.createElement("div",{className:"mt-2"}),(()=>{const a=dt(n);return a.length===0?React.createElement("div",{className:"text-muted small px-2 py-1"},"Kh\xF4ng c\xF3 s\u1EA3n ph\u1EA9m ph\xF9 h\u1EE3p"):a.map(s=>React.createElement("button",{key:s.id,type:"button",className:"dropdown-item",onClick:()=>{const c=String(s.id),p=Ye(s==null?void 0:s.variants),T={};for(const o of p){const m=String((o==null?void 0:o.name)||"").trim(),M=Array.isArray(o==null?void 0:o.options)?o.options[0]:null,L=String((M==null?void 0:M.label)||"").trim();m&&L&&(T[m]=L)}const g=gt(T),d=vt(s,T);oe(o=>{const m=Array.isArray(o.items)?[...o.items]:[];return m[n]={...m[n]||{quantity:1},product_id:c,variant_json:Object.keys(T).length?T:null,variant:g,unit_price:p.length?d:null},{...o,items:m}}),b(null)}},s.name,s.code?` (${s.code})`:""))})()),React.createElement("select",{className:"form-select",value:e.product_id,onChange:()=>{},required:!0,style:{position:"absolute",opacity:0,height:0,pointerEvents:"none"},tabIndex:-1,"aria-hidden":"true"},React.createElement("option",{value:""},"-- ch\u1ECDn s\u1EA3n ph\u1EA9m --"),h.map(a=>React.createElement("option",{key:a.id,value:a.id},a.name)))),(()=>{var s;const a=(s=ot.items)==null?void 0:s[n];return a?React.createElement(React.Fragment,null,!!a.productError&&React.createElement("div",{className:"form-text text-danger"},a.productError),!!a.dupWarn&&React.createElement("div",{className:"form-text text-warning"},a.dupWarn)):null})(),(()=>{if(!(e!=null&&e.product_id))return null;const a=Be(e.product_id),s=Ye(a==null?void 0:a.variants);if(!s.length)return null;const c=e!=null&&e.variant_json&&typeof e.variant_json=="object"?e.variant_json:{};return React.createElement("div",{className:"mt-2 d-grid gap-2"},s.map((p,T)=>{const g=String((p==null?void 0:p.name)||`Bi\u1EBFn th\u1EC3 ${T+1}`).trim(),d=String((c==null?void 0:c[g])||"").trim();return React.createElement("div",{key:g},React.createElement("label",{className:"form-label small text-muted mb-1"},g),React.createElement("select",{className:"form-select",value:d,onChange:o=>{const m=String(o.target.value||"").trim();oe(M=>{const L=Array.isArray(M.items)?[...M.items]:[],Y={...L[n]||{}},ye=Be(Y.product_id),He=Ye(ye==null?void 0:ye.variants),Re=Y!=null&&Y.variant_json&&typeof Y.variant_json=="object"?{...Y.variant_json}:{};m?Re[g]=m:delete Re[g];const lt=gt(Re),Je=vt(ye,Re);return L[n]={...Y,variant_json:Object.keys(Re).length?Re:null,variant:lt,unit_price:Je},{...M,items:L}})},style:{borderRadius:10,padding:12}},React.createElement("option",{value:""},"-- ch\u1ECDn ",g," --"),(Array.isArray(p==null?void 0:p.options)?p.options:[]).map(o=>React.createElement("option",{key:o.label,value:o.label},o.label,Number.isFinite(Number(o==null?void 0:o.price))?` (${Ve(Number(o.price))})`:Number(o==null?void 0:o.price_delta)?` (${o.price_delta>0?"+":""}${o.price_delta})`:""))))}))})(),P&&React.createElement("div",{className:"form-check mt-1"},React.createElement("input",{className:"form-check-input",type:"checkbox",id:`order-split-deliver-${n}`,checked:!!q[n],onChange:a=>{const s=!!a.target.checked;R(c=>{const p=Array.isArray(c)?[...c]:[],T=Array.isArray(r.items)?r.items.length:0;for(;p.length<T;)p.push(!0);return p[n]=s,p})},disabled:ie||be}),React.createElement("label",{className:"form-check-label small text-muted",htmlFor:`order-split-deliver-${n}`},"Giao \u0111\u1EE3t 1"))),React.createElement("div",{className:"col-8 col-md-3"},React.createElement("input",{type:"number",className:"form-control",value:e.quantity,onChange:a=>{const s=a.target.value;oe(c=>{const p=Array.isArray(c.items)?[...c.items]:[];return p[n]={...p[n]||{product_id:""},quantity:s},{...c,items:p}})},min:"1",style:{borderRadius:10,padding:12}}),(()=>{var s;const a=(s=ot.items)==null?void 0:s[n];return a&&a.qtyError?React.createElement("div",{className:"form-text text-danger"},a.qtyError):null})()),React.createElement("div",{className:"col-4 col-md-1 d-flex justify-content-end"},React.createElement("button",{type:"button",className:"btn btn-outline-danger",onClick:()=>{oe(a=>{const s=Array.isArray(a.items)?[...a.items]:[];return s.splice(n,1),{...a,items:s.length?s:[{product_id:"",quantity:1,unit_price:null,variant:"",variant_json:null}]}}),je(a=>{const s=Array.isArray(a)?[...a]:[];return s.splice(n,1),s.length?s:[""]}),R(a=>{const s=Array.isArray(a)?[...a]:[];return s.splice(n,1),s}),b(a=>a==null?a:a===n?null:a>n?a-1:a)},disabled:ie||be||(Array.isArray(r.items)?r.items.length:1)<=1,title:"X\xF3a s\u1EA3n ph\u1EA9m",style:{borderRadius:10,padding:10}},React.createElement("i",{className:"fas fa-trash"}))))))),(()=>{const n=(Array.isArray(r.items)?r.items:[]).filter(T=>T==null?void 0:T.product_id),a=Bt(n),s=Ht(n),c=bt(r.adjustment_amount),p=a+(s.found?s.fee:0)+c;return React.createElement("div",{className:"col-12"},React.createElement("div",{className:"d-flex flex-column gap-1 small bg-light rounded-3 p-3"},React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"T\u1EA1m t\xEDnh"),React.createElement("span",{className:"fw-semibold"},Ve(a))),s.found&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"Ship"),React.createElement("span",{className:"fw-semibold"},Ve(s.fee))),!!ot.shipAbnormalWarn&&React.createElement("div",{className:"text-warning"},ot.shipAbnormalWarn),c!==0&&React.createElement("div",{className:"d-flex justify-content-between"},React.createElement("span",{className:"text-muted"},"\u0110i\u1EC1u ch\u1EC9nh"),React.createElement("span",{className:"fw-semibold"},Ve(c))),(r.note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111\u01A1n: ",(r.note||"").trim()),(r.adjustment_note||"").trim()&&React.createElement("div",{className:"text-muted",style:{whiteSpace:"normal",wordBreak:"break-word"}},"Ghi ch\xFA \u0111i\u1EC1u ch\u1EC9nh: ",(r.adjustment_note||"").trim()),React.createElement("div",{className:"d-flex justify-content-between pt-1 border-top"},React.createElement("span",{className:"text-muted"},"T\u1ED5ng"),React.createElement("span",{className:"fw-bold"},Ve(p)))))})())),React.createElement("div",{className:"modal-footer",style:{border:"none"}},React.createElement("button",{type:"button",className:"btn btn-light",onClick:wt,disabled:ie||be,style:{borderRadius:10}},"H\u1EE7y"),!!P&&React.createElement("button",{type:"button",className:"btn btn-outline-primary fw-semibold",onClick:Et,disabled:ie||be,style:{borderRadius:10},title:"Ch\u1ECDn s\u1EA3n ph\u1EA9m giao \u0111\u1EE3t 1 v\xE0 t\xE1ch ph\u1EA7n c\xF2n l\u1EA1i sang \u0111\u01A1n ch\u1EDD h\xE0ng"},be?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang t\xE1ch..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-random me-2"}),"T\xE1ch \u0111\u01A1n giao ngay")),!P&&React.createElement("button",{type:"button",className:"btn btn-outline-warning fw-semibold",onClick:()=>ea({mode:"new"}),disabled:ie||!ot.canSubmit,style:{borderRadius:10},title:"L\u01B0u xong gi\u1EEF form \u0111\u1EC3 t\u1EA1o \u0111\u01A1n m\u1EDBi"},React.createElement("i",{className:"fas fa-plus me-2"}),"L\u01B0u & t\u1EA1o \u0111\u01A1n m\u1EDBi"),React.createElement("button",{type:"submit",className:"btn btn-warning fw-semibold",disabled:ie||be||!ot.canSubmit,style:{borderRadius:10,boxShadow:"0 4px 12px rgba(255,193,7,0.3)"}},ie?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2"}),"\u0110ang l\u01B0u..."):React.createElement(React.Fragment,null,React.createElement("i",{className:"fas fa-check me-2"}),"L\u01B0u"))))))))}

