let _cachedProducts=null;async function loadProductsForAI(){if(_cachedProducts)return _cachedProducts;try{const o=await fetch("/api/products?fields=ai");if(o.ok)return _cachedProducts=(await o.json()).map(n=>({id:n.id,name:n.name,code:n.code||"",price:n.price||"",image:n.image||"",category:n.category||"",note:n.note||""})),_cachedProducts}catch(o){console.error("Error loading products:",o)}return[]}async function callGeminiWithProducts(o,l=[]){const n="/api/ai-chat",h=(await loadProductsForAI()).map(t=>{let e=`- ${t.name}`;return t.code&&(e+=` (M\xE3: ${t.code})`),t.price&&(e+=` - Gi\xE1: ${t.price}`),t.category&&(e+=` [${t.category}]`),t.note&&(e+=` (${t.note})`),t.image&&(e+=` [IMG:${t.image}]`),e}).join(`
`),r={message:o,context:h,audience:"customer"};console.log("\u{1F680} Sending AI Chat payload:",JSON.stringify(r).slice(0,200));const a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok){const t=await a.text();throw console.error("Backend /api/ai-chat error:",t),new Error("Backend API error")}return(await a.json()).response||"Kh\xF4ng nh\u1EADn \u0111\u01B0\u1EE3c ph\u1EA3n h\u1ED3i t\u1EEB AI."}function MessageContent({text:o}){var{useState:l}=React;const[n,d]=l(null),r=(a=>{const i=[],t=/\[IMG:(https?:\/\/[^\]]+)\]/g;let e=0,c;for(;(c=t.exec(a))!==null;){if(c.index>e){const m=a.slice(e,c.index);i.push({type:"text",content:m})}i.push({type:"image",url:c[1]}),e=c.index+c[0].length}return e<a.length&&i.push({type:"text",content:a.slice(e)}),i})(o);return React.createElement(React.Fragment,null,r.map((a,i)=>a.type==="image"?React.createElement("div",{key:i,className:"ai-chat-image-container my-2"},React.createElement("img",{src:a.url,alt:"H\xECnh s\u1EA3n ph\u1EA9m",className:"ai-chat-image",onClick:()=>d(a.url),style:{maxWidth:"100%",maxHeight:"200px",borderRadius:"8px",cursor:"pointer",objectFit:"cover",border:"1px solid #ddd"}})):a.content.split(`
`).map((t,e)=>React.createElement("p",{key:`${i}-${e}`,className:"mb-1"},t))),n&&ReactDOM.createPortal(React.createElement("div",{className:"ai-chat-lightbox",onClick:()=>d(null),style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.95)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:2147483647,cursor:"zoom-out"}},React.createElement("img",{src:n,alt:"Xem h\xECnh l\u1EDBn",style:{maxWidth:"90%",maxHeight:"90%",objectFit:"contain",borderRadius:"8px"}}),React.createElement("button",{onClick:()=>d(null),style:{position:"absolute",top:"20px",right:"20px",background:"rgba(255,255,255,0.2)",border:"none",color:"#fff",fontSize:"24px",width:"40px",height:"40px",borderRadius:"50%",cursor:"pointer"}},"\xD7")),document.body))}function AiChatWidget({onClose:o}){var{useState:l,useEffect:n,useRef:d}=React;const[h,r]=l([{role:"assistant",text:`Ch\xE0o b\u1EA1n, m\xECnh l\xE0 tr\u1EE3 l\xFD KTM AI \u{1F916}

B\u1EA1n c\xF3 th\u1EC3 h\u1ECFi:
\u2022 Gi\xE1 s\u1EA3n ph\u1EA9m: 'van 1 tay gi\xE1 bao nhi\xEAu'
\u2022 T\xEDnh t\u1ED5ng: 't\u1ED5ng 3 combo n\xE0y h\u1EBFt bao nhi\xEAu'
\u2022 So s\xE1nh: 'so s\xE1nh combo van 2 tay v\xE0 3 tay'
\u2022 Xem h\xECnh: 'cho xem h\xECnh van 1 tay'`}]),[a,i]=l(""),[t,e]=l(!1),c=d(null);n(()=>{c.current&&c.current.scrollIntoView({behavior:"smooth"})},[h,t]);const m=async()=>{const s=a.trim();if(!s)return;const u=[...h,{role:"user",text:s}];r(u),i(""),e(!0);try{const p=u.slice(1).map(g=>({role:g.role==="assistant"?"model":"user",text:g.text})),f=await callGeminiWithProducts(s,p);r(g=>[...g,{role:"assistant",text:f}])}catch(p){console.error(p),r(f=>[...f,{role:"assistant",text:"Xin l\u1ED7i, h\u1EC7 th\u1ED1ng AI \u0111ang g\u1EB7p l\u1ED7i ho\u1EB7c ch\u01B0a c\u1EA5u h\xECnh API key Gemini. Vui l\xF2ng ki\u1EC3m tra l\u1EA1i."}])}finally{e(!1)}},y=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),m())};return React.createElement("div",{className:"ai-chat-widget shadow-lg"},React.createElement("div",{className:"ai-chat-header d-flex justify-content-between align-items-center px-3 py-2"},React.createElement("div",{className:"d-flex align-items-center gap-2"},React.createElement("span",{className:"ai-chat-avatar"},React.createElement("i",{className:"fas fa-robot"})),React.createElement("div",{className:"d-flex flex-column"},React.createElement("span",{className:"fw-semibold"},"B\xE1 \u0110\u1EE9c AI"),React.createElement("small",{className:"text-light"},"H\u1ECFi g\xEC v\u1EC1 gi\xE1 KTM c\u0169ng \u0111\u01B0\u1EE3c"))),React.createElement("button",{type:"button",className:"btn btn-sm btn-outline-light px-2 py-0",onClick:o},React.createElement("i",{className:"fas fa-times"}))),React.createElement("div",{className:"ai-chat-body px-3 py-2"},h.map((s,u)=>React.createElement("div",{key:u,className:`ai-chat-message ${s.role==="assistant"?"ai-chat-message-assistant":"ai-chat-message-user"}`},React.createElement("div",{className:"ai-chat-bubble"},React.createElement(MessageContent,{text:s.text})))),t&&React.createElement("div",{className:"ai-chat-message ai-chat-message-assistant"},React.createElement("div",{className:"ai-chat-bubble"},React.createElement("span",null,"AI \u0111ang tr\u1EA3 l\u1EDDi..."))),React.createElement("div",{ref:c})),React.createElement("div",{className:"ai-chat-input px-2 py-2 border-top"},React.createElement("div",{className:"input-group input-group-sm"},React.createElement("textarea",{rows:2,className:"form-control",placeholder:"Nh\u1EADp c\xE2u h\u1ECFi (vd: t\u1ED5ng 3 combo n\xE0y bao nhi\xEAu ti\u1EC1n?)",value:a,onChange:s=>i(s.target.value),onKeyDown:y}),React.createElement("button",{className:"btn btn-primary",type:"button",disabled:t,onClick:m},React.createElement("i",{className:"fas fa-paper-plane"})))))}

