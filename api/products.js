import{neon as F}from"@neondatabase/serverless";import k from"crypto";let L=null;function N(){return process.env.DATABASE_URL?(L||(L=F(process.env.DATABASE_URL)),L):null}let R=!1,O=null,x=!1,w=null;const I=1.64;function j(t){const e=typeof t=="number"?t:parseFloat(String(t??"").trim());return Number.isFinite(e)?Math.max(0,Math.min(100,e)):I}function M(t){if(t==null||t==="")return null;const e=Number(t);return Number.isFinite(e)?Math.max(0,Math.min(100,e)):null}function V(t){if(t==null||t==="")return null;let e=t;if(typeof e=="string"){const a=e.trim();if(!a)return null;try{e=JSON.parse(a)}catch{return null}}if(e&&typeof e=="object"&&!Array.isArray(e)&&(e=Object.entries(e).map(([a,i])=>({key:a,value:i}))),!Array.isArray(e))return null;const o=e.map(a=>{if(!a||typeof a!="object")return null;const i=String(a.key??a.name??a.label??"").trim(),r=a.value??a.val??a.text??"",p=String(r??"").trim(),g=String(a.unit??"").trim();return i?!p&&!g?{key:i}:g?{key:i,value:p,unit:g}:{key:i,value:p}:null}).filter(Boolean);return o.length?o:null}function X(t){const e=String(t??"").replace(/[^0-9]/g,"");if(!e)return null;const o=Number(e);return Number.isFinite(o)?Math.trunc(o):null}function B(t,e){if(t==null||t==="")return null;let o=t;if(typeof o=="string"){const r=o.trim();if(!r)return null;try{o=JSON.parse(r)}catch{return null}}if(!Array.isArray(o))return null;const a=X(e),i=o.map(r=>{if(!r||typeof r!="object")return null;const p=String(r.name??"").trim(),h=(Array.isArray(r.options)?r.options:[]).map(c=>{if(!c||typeof c!="object")return null;const n=String(c.label??"").trim();if(!n)return null;const s=c.price??c.priceValue??c.unit_price??c.unitPrice??null,_=Number(s),m=Number.isFinite(_)?Math.max(0,Math.trunc(_)):null,f=c.price_delta??c.priceDelta??null,y=Number(f),u=Number.isFinite(y)?Math.trunc(y):0;return m!=null?{label:n,price:m}:a!=null?{label:n,price:Math.max(0,Math.trunc(a+u))}:{label:n,price_delta:u}}).filter(Boolean);return!p&&h.length===0?null:{name:p||"Bi\u1EBFn th\u1EC3",options:h}}).filter(Boolean);return i.length?i:null}async function U(){const t=N();if(!t)throw new Error("DATABASE_URL not configured");await t`
    CREATE TABLE IF NOT EXISTS products (
      id VARCHAR(100) PRIMARY KEY,
      name VARCHAR(500) NOT NULL,
      code VARCHAR(50),
      price VARCHAR(50),
      image TEXT,
      category VARCHAR(100),
      note TEXT,
      sort_order INTEGER DEFAULT 0,
      commission_percent NUMERIC(6,2) DEFAULT 5,
      variants JSONB,
      attributes JSONB,
      created_at TIMESTAMP DEFAULT NOW(),
      updated_at TIMESTAMP DEFAULT NOW()
    )
  `,await t`ALTER TABLE products ADD COLUMN IF NOT EXISTS commission_percent NUMERIC(6,2) DEFAULT 5`,await t`ALTER TABLE products ADD COLUMN IF NOT EXISTS variants JSONB`,await t`ALTER TABLE products ADD COLUMN IF NOT EXISTS attributes JSONB`,await t`CREATE INDEX IF NOT EXISTS products_sort_order_created_at_idx ON products(sort_order ASC, created_at DESC)`,await t`CREATE INDEX IF NOT EXISTS products_category_sort_order_created_at_idx ON products(category, sort_order ASC, created_at DESC)`}async function H(){if(!R)return O||(O=U().then(()=>{R=!0}).catch(t=>{throw O=null,t})),O}async function Y(){const t=N();if(!t)throw new Error("DATABASE_URL not configured");await t`
    CREATE TABLE IF NOT EXISTS settings (
      key TEXT PRIMARY KEY,
      value TEXT,
      updated_at TIMESTAMP DEFAULT NOW()
    )
  `}async function K(){if(!x)return w||(w=Y().then(()=>{x=!0}).catch(t=>{throw w=null,t})),w}const P=[{id:"xylanh-giua",name:"Xy lanh gi\u1EEFa",price:"1.950.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/f_auto,q_auto/v1747538306/2_sxq2wa.jpg",category:"Ty xy lanh",note:"Th\xEAm d\xE2y l\xE0 2.150.000\u0111"},{id:"xylanh-nghieng",name:"Xy lanh nghi\xEAng",price:"1.950.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/f_auto,q_auto/v1747538307/3_nxbqyo.jpg",category:"Ty xy lanh",note:"Th\xEAm d\xE2y l\xE0 2.150.000\u0111"},{id:"xylanh-ui",name:"Xy lanh \u1EE7i",price:"2.200.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/f_auto,q_auto/v1747538307/4_rj8cv2.jpg",category:"Ty xy lanh"},{id:"combo-van1-2",name:"Combo Van 1 tay + 1 xylanh nghi\xEAng/gi\u1EEFa",price:"4.750.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1751807509/74.1_Combo_1_tay_xylanh_nghi%C3%AAng_thbmua.jpg",category:"Combo Van 1 tay"},{id:"combo-van1-3",name:"Combo Van 1 tay + 1 xylanh nghi\xEAng/gi\u1EEFa",price:"4.750.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1760762522/COMBO_VAN_1_TAY_1_TY_GI%E1%BB%AEA_KTM_ulsy1c.jpg",category:"Combo Van 1 tay"},{id:"combo-van1-1",name:"Combo Van 1 tay + 1 xylanh \u1EE7i",price:"5.000.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1751807509/74_combo_van_1_tay_1_xylanh_%E1%BB%A7i_gvf1t1.jpg",category:"Combo Van 1 tay"},{id:"combo-van2-3",name:"Combo van 2 tay 2 ty nghi\xEAng gi\u1EEFa KTM",price:"7.300.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1760762120/combo_van_2_tay_2_ty_nghi%C3%AAng_gi%E1%BB%AFa_KTM_bwpf3o.jpg",category:"Combo Van 2 tay"},{id:"combo-van2-1",name:"Combo van 2 tay 1 ty nghi\xEAng ktm",price:"5.080.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1760762121/combo_van_2_tay_1_ty_nghi%C3%AAng_ktm_eumive.jpg",category:"Combo Van 2 tay"},{id:"combo-van2-2",name:"Combo van 2 tay 1 ty gi\u1EEFa ktm",price:"5.080.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1760762402/combo_van_2_tay_1_ty_gi%E1%BB%AFa_KTM_e6ssao.jpg",category:"Combo Van 2 tay"},{id:"combo-van3-1",name:"Combo Van 3 tay + 1 xylanh gi\u1EEFa",price:"5.550.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1749300157/Combo_van_3_tay_xylanh_gi%E1%BB%AFa_mxdsth.jpg",category:"Combo Van 3 tay"},{id:"combo-van3-2",name:"Combo Van 3 tay + 3 xylanh",price:"10.250.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1749300461/combo_van_3_tay_3_xylanh_nghi%C3%AAng_gi%E1%BB%AFa_%E1%BB%A7i_mgppxh.jpg",category:"Combo Van 3 tay"},{id:"combo-van3-3",name:"Combo Van 3 tay + 2 xylanh",price:"7.800.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1749300324/Combo_Van_3_tay_2_xylanh_nghi%C3%AAng_gi%E1%BB%AFa_evihrt.jpg",category:"Combo Van 3 tay"},{id:"combo-van4-1",name:"Combo Van 4 tay + 2 xylanh",price:"8.300.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1749135217/Combo_van_4_tay_1_xylanh_nghi%C3%AAng_1_xylanh_gi%E1%BB%AFa_nh6gjh.jpg",category:"Combo Van 4 tay"},{id:"combo-van4-2",name:"Combo van 4 tay 1 ty gi\u1EEFa ktm",price:"6.050.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1760762675/combo_van_4_tay_1_ty_gi%E1%BB%AFa_ktm_auo6xo.jpg",category:"Combo Van 4 tay"},{id:"combo-van4-3",name:"Combo van 4 tay 1 ty nghi\xEAng ktm",price:"6.050.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1760762677/combo_van_4_tay_1_ty_nghi%C3%AAng_ktm_eyk6fr.jpg",category:"Combo Van 4 tay"},{id:"combo-van5-1",name:"Combo Van 5 tay + 2 xylanh",price:"8.800.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/f_auto,q_auto/v1747537715/Combo_van_5_tay_2_xylanh_1_nghi%C3%AAng_1_gi%E1%BB%AFa_KTM_htd1au.jpg",category:"Combo Van 5 tay"},{id:"combo-van5-2",name:"Combo Van 5 tay + 1 xylanh",price:"6.550.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/f_auto,q_auto/v1747539250/Combo_van_5_tay_1_xylanh_nghi%C3%AAng_KTM_kv6irg.jpg",category:"Combo Van 5 tay"},{id:"combo-van5-3",name:"Combo Van 5 tay + 1 xylanh",price:"6.550.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1760762831/combo_van_5_tay_1_ty_gi%E1%BB%AFa_KTM_l74ame.jpg",category:"Combo Van 5 tay"},{id:"trang-62",name:"Trang Tr\u01B0\u1EE3t van 4 tay KTM 4 xylanh L\u1EAFp tr\xEAn x\u1EDBi",code:"KTM-62",price:"21.200.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1749135668/trang_g%E1%BA%A1t_wleewb.jpg",category:"Trang g\u1EA1t"},{id:"trang-63",name:"Trang G\u1EADp Van tay KTM 4 xylanh L\u1EAFp tr\xEAn x\u1EDBi",code:"KTM-63",price:"23.200.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1749135668/trang_g%E1%BA%A1t_wleewb.jpg",category:"Trang g\u1EA1t"},{id:"spare-1",name:"B\u1ED9 n\u1ED1i nhanh",code:"SP-01",price:"400.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1760870151/9-1_n%E1%BB%91i_nhanh_KTM_gsouip.jpg",category:"Ph\u1EE5 ki\u1EC7n"},{id:"spare-2",name:"Van ch\u1ED1ng t\u1EE5t h\xECnh vu\xF4ng",code:"SP-02",price:"630.000\u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/v1760870364/24_Van_ch%E1%BB%91ng_t%E1%BB%A5t_lo%E1%BA%A1i_vu%C3%B4ng_KTM_sdnjcd.jpg",category:"Ph\u1EE5 ki\u1EC7n"},{id:"mat-bich",name:"M\u1EB7t b\xEDch",price:"550.000 \u0111",category:"Ph\u1EE5 ki\u1EC7n",note:"c\xF3 freeship"},{id:"nhot-5l",name:"Nh\u1EDBt \u0111\u1ED9ng c\u01A1 5L",price:"590.000 \u0111",category:"Ph\u1EE5 ki\u1EC7n",note:"c\xF3 freeship"},{id:"nhot-20l",name:"Nh\u1EDBt \u0111\u1ED9ng c\u01A1 20L",price:"2.140.000 \u0111",category:"Ph\u1EE5 ki\u1EC7n",note:"c\xF3 freeship"},{id:"van-1",name:"Van 1 tay",code:"V-01",price:"1.900.000 \u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/f_auto,q_auto/v1747538310/van1_sjzm7p.png",category:"Van \u0111i\u1EC1u khi\u1EC3n"},{id:"van-2",name:"Van 2 tay",code:"V-02",price:"2.200.000 \u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/f_auto,q_auto/v1747538310/van2_hogp0r.png",category:"Van \u0111i\u1EC1u khi\u1EC3n"},{id:"van-3",name:"Van 3 tay",code:"V-03",price:"2.700.000 \u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/f_auto,q_auto/v1747538312/van3_qettd5.png",category:"Van \u0111i\u1EC1u khi\u1EC3n"},{id:"van-4",name:"Van 4 tay",code:"V-04",price:"3.200.000 \u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/f_auto,q_auto/v1747538311/van4_bxu8ry.png",category:"Van \u0111i\u1EC1u khi\u1EC3n"},{id:"van-5",name:"Van 5 tay",code:"V-05",price:"3.600.000 \u0111",image:"https://res.cloudinary.com/diwxfpt92/image/upload/f_auto,q_auto/v1747538312/van5_pjllmw.png",category:"Van \u0111i\u1EC1u khi\u1EC3n"},{id:"van-6",name:"Van 6 tay",code:"V-06",price:"4.100.000 \u0111",image:"https://img.icons8.com/color/48/settings.png",category:"Van \u0111i\u1EC1u khi\u1EC3n"}];async function J(t,e){if(e.setHeader("Access-Control-Allow-Origin","*"),e.setHeader("Access-Control-Allow-Methods","GET, POST, PUT, DELETE, OPTIONS"),e.setHeader("Access-Control-Allow-Headers","Content-Type"),t.method==="OPTIONS")return e.status(200).end();const o=N();if(!o)return e.status(500).json({error:"DATABASE_URL not configured"});try{const a=String(t.query?.debug??"")==="1",i=String(t.query?.meta??"")==="1",r=a?Date.now():0;t.method==="GET"&&(String(t.query?.nocache??t.query?.noCache??"").trim()==="1"||String(t.query?.debug??"").trim()==="1"||String(t.query?.__settings??"").trim()==="1"?e.setHeader("Cache-Control","no-store"):e.setHeader("Cache-Control","public, max-age=0, s-maxage=60, stale-while-revalidate=86400"));const g=String(t.query?.fields??t.query?.select??"").trim().toLowerCase()||(String(t.query?.lite??"")==="1"?"lite":""),h=n=>n==="min"?"id, name, code, price":n==="ai"?"id, name, code, price, image, category, note":n==="search"?"id, name, code, price, image, category, note, sort_order":n==="order"||n==="lite"?"id, name, code, price, image, category, note, sort_order, commission_percent, variants":"*";if(t.query&&String(t.query.__settings??"")==="1"){if(await K(),t.method==="GET"){const n=await o`SELECT value FROM settings WHERE key = ${"ship_percent"} LIMIT 1`,s=n.length?j(n[0]?.value):I;return i?e.status(200).json({ship_percent:s,meta:a?{timingsMs:{total:Date.now()-r}}:void 0}):e.status(200).json({ship_percent:s})}if(t.method==="PUT"){const n=j(t.body?.ship_percent??t.body?.shipPercent);return await o`
          INSERT INTO settings (key, value, updated_at)
          VALUES (${"ship_percent"}, ${String(n)}, NOW())
          ON CONFLICT (key) DO UPDATE SET
            value = EXCLUDED.value,
            updated_at = NOW()
        `,i?e.status(200).json({ship_percent:n,meta:a?{timingsMs:{total:Date.now()-r}}:void 0}):e.status(200).json({ship_percent:n})}return e.status(405).json({error:"Method not allowed"})}await H();const c=a?Date.now():0;if(t.method==="POST"&&t.query.action==="delete-image"){const{url:n}=t.body;if(!n)return e.status(400).json({error:"URL is required"});const s=await W(n);return e.status(200).json(s)}if(t.method==="GET"){const{id:n,category:s,action:_}=t.query;if(_==="init"){await U();let u=0;for(let d=0;d<P.length;d++){const l=P[d];try{await o`
              INSERT INTO products (id, name, code, price, image, category, note, sort_order, commission_percent, attributes)
              VALUES (${l.id}, ${l.name}, ${l.code||null}, ${l.price||null}, ${l.image||null}, ${l.category||null}, ${l.note||null}, ${d}, ${5}, ${null}::jsonb)
              ON CONFLICT (id) DO UPDATE SET
                name = EXCLUDED.name, code = EXCLUDED.code, price = EXCLUDED.price,
                image = EXCLUDED.image, category = EXCLUDED.category, note = EXCLUDED.note,
                sort_order = EXCLUDED.sort_order,
                commission_percent = COALESCE(products.commission_percent, EXCLUDED.commission_percent),
                updated_at = NOW()
            `,u++}catch(A){console.error(A)}}const E=await o`SELECT COUNT(*) as total FROM products`;return e.status(200).json({success:!0,inserted:u,total:E[0].total})}if(_==="migrate-nested-folders")try{return await o`
            ALTER TABLE albums ADD COLUMN IF NOT EXISTS parent_id UUID REFERENCES albums(id) ON DELETE CASCADE
          `,await o`
            ALTER TABLE video_folders ADD COLUMN IF NOT EXISTS parent_id UUID REFERENCES video_folders(id) ON DELETE CASCADE
          `,e.status(200).json({success:!0,message:"Added parent_id column to albums and video_folders tables"})}catch(u){return console.error("Migration error:",u),e.status(500).json({error:u.message})}if(n){const u=h(g),E=u==="*"?"SELECT * FROM products WHERE id = $1":`SELECT ${u} FROM products WHERE id = $1`,d=await o(E,[n]);return d.length===0?e.status(404).json({error:"Product not found"}):i?e.status(200).json({data:d[0],meta:a?{timingsMs:{schema:c-r,total:Date.now()-r}}:void 0}):e.status(200).json(d[0])}if(s){const u=h(g),E=u==="*"?"SELECT * FROM products WHERE category = $1 ORDER BY sort_order ASC, created_at DESC":`SELECT ${u} FROM products WHERE category = $1 ORDER BY sort_order ASC, created_at DESC`,d=await o(E,[s]);return i?e.status(200).json({data:d,meta:a?{timingsMs:{schema:c-r,total:Date.now()-r}}:void 0}):e.status(200).json(d)}const m=h(g),f=m==="*"?"SELECT * FROM products ORDER BY sort_order ASC, created_at DESC":`SELECT ${m} FROM products ORDER BY sort_order ASC, created_at DESC`,y=await o(f);return i?e.status(200).json({data:y,meta:a?{timingsMs:{schema:c-r,total:Date.now()-r}}:void 0}):e.status(200).json(y)}if(t.method==="POST"){const{id:n,name:s,code:_,price:m,image:f,category:y,note:u,sort_order:E,commission_percent:d,variants:l,attributes:A}=t.body;if(!s)return e.status(400).json({error:"Name is required"});const D=n||`prod-${Date.now()}`,C=M(d),T=B(l,m),S=T!=null?JSON.stringify(T):null,b=V(A),v=b!=null?JSON.stringify(b):null,$=await o`
        INSERT INTO products (id, name, code, price, image, category, note, sort_order, commission_percent, variants, attributes)
        VALUES (
          ${D},
          ${s},
          ${_||null},
          ${m||null},
          ${f||null},
          ${y||null},
          ${u||null},
          ${E||0},
          COALESCE(${C}, 5),
          ${S}::jsonb,
          ${v}::jsonb
        )
        RETURNING *
      `;return e.status(201).json($[0])}if(t.method==="PUT"){const{id:n}=t.query,{name:s,code:_,price:m,image:f,category:y,note:u,sort_order:E,commission_percent:d,variants:l,attributes:A}=t.body;if(!n)return e.status(400).json({error:"Product ID is required"});const D=M(d),C=B(l,m),T=C!=null?JSON.stringify(C):null,S=V(A),b=S!=null?JSON.stringify(S):null,v=await o`
        UPDATE products 
        SET 
          name = COALESCE(${s}, name),
          code = COALESCE(${_}, code),
          price = COALESCE(${m}, price),
          image = COALESCE(${f}, image),
          category = COALESCE(${y}, category),
          note = COALESCE(${u}, note),
          sort_order = COALESCE(${E}, sort_order),
          commission_percent = COALESCE(${D}, commission_percent),
          variants = COALESCE(${T}::jsonb, variants),
          attributes = COALESCE(${b}::jsonb, attributes),
          updated_at = NOW()
        WHERE id = ${n}
        RETURNING *
      `;return v.length===0?e.status(404).json({error:"Product not found"}):e.status(200).json(v[0])}if(t.method==="DELETE"){const{id:n}=t.query;if(!n)return e.status(400).json({error:"Product ID is required"});const s=await o`DELETE FROM products WHERE id = ${n} RETURNING *`;return s.length===0?e.status(404).json({error:"Product not found"}):e.status(200).json({message:"Product deleted",product:s[0]})}return e.status(405).json({error:"Method not allowed"})}catch(a){return console.error("Products API error:",a),e.status(500).json({error:a.message})}}async function W(t){if(!t||!t.includes("cloudinary.com"))return{success:!1};const e=process.env.CLOUDINARY_CLOUD_NAME||"diwxfpt92",o=process.env.CLOUDINARY_API_KEY,a=process.env.CLOUDINARY_API_SECRET;if(!o||!a)return{success:!1,error:"Cloudinary credentials not configured"};try{const i=t.match(/\/upload\/(?:v\d+\/)?(.+)\.[a-z]+$/i);if(!i)return{success:!1,error:"Invalid URL"};const r=i[1],p=Math.round(Date.now()/1e3),g=`public_id=${r}&timestamp=${p}${a}`,h=k.createHash("sha1").update(g).digest("hex"),c=new URLSearchParams;c.append("public_id",r),c.append("timestamp",p),c.append("api_key",o),c.append("signature",h);const s=await(await fetch(`https://api.cloudinary.com/v1_1/${e}/image/destroy`,{method:"POST",body:c})).json();return{success:s.result==="ok"||s.result==="not found"}}catch(i){return{success:!1,error:i.message}}}export{J as default};

