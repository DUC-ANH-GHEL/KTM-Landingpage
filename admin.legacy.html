<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Admin - Quản lý Album | KTM</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <style>
    :root {
      --primary: #ffc107;
      --dark: #1a1a2e;
      --success: #28a745;
      --danger: #dc3545;
      --info: #17a2b8;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      overflow-x: hidden;
      max-width: 100vw;
      width: 100%;
    }
    
    /* Fix mobile horizontal scroll */
    #root, .app-container, main, section, div {
      max-width: 100%;
    }
    
    body {
      background: #f0f2f5;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Prevent iOS zoom on input focus */
    input, select, textarea {
      font-size: 16px !important;
    }
    
    /* ========== MOBILE FIRST ========== */
    
    /* Bottom Navigation for Mobile */
    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--dark);
      padding: 6px 0;
      padding-bottom: max(6px, env(safe-area-inset-bottom));
      z-index: 1050;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
    }
    
    .mobile-bottom-nav .nav-items {
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0 8px;
    }
    
    .mobile-bottom-nav .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      color: rgba(255,255,255,0.6);
      text-decoration: none;
      font-size: 11px;
      transition: all 0.2s;
      border-radius: 8px;
      min-width: 56px;
    }
    
    .mobile-bottom-nav .nav-item i {
      font-size: 18px;
    }
    
    .mobile-bottom-nav .nav-item.active {
      color: var(--primary);
      background: rgba(255,193,7,0.1);
    }
    
    .mobile-bottom-nav .nav-item:hover {
      color: var(--primary);
      background: rgba(255,193,7,0.1);
    }
    
    .product-card-mobile {
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      position: relative;
    }
    
    .product-card-mobile .card-inner {
      display: flex;
      gap: 12px;
    }
    
    .product-card-mobile .thumb {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      flex-shrink: 0;
    }
    
    .product-card-mobile .info {
      flex: 1;
      min-width: 0;
    }
    
    .product-card-mobile .name {
      font-weight: 600;
      font-size: 14px;
      line-height: 1.3;
      color: #333;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 4px;
    }
    
    .product-card-mobile .price-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    
    .product-card-mobile .price {
      font-size: 16px;
      font-weight: 700;
      color: var(--danger);
    }
    
    .product-card-mobile .badge-promo {
      background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
      color: #fff;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      animation: pulse-promo 2s infinite;
    }
    
    @keyframes pulse-promo {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .product-card-mobile .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 11px;
    }
    
    .product-card-mobile .meta-tag {
      background: #f0f2f5;
      color: #666;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .product-card-mobile .meta-tag.highlight {
      background: #fff3cd;
      color: #856404;
    }
    
    .product-card-mobile .type-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .product-card-mobile .type-badge.product { background: #e3f2fd; color: #1565c0; }
    .product-card-mobile .type-badge.album { background: #e8f5e9; color: #2e7d32; }
    .product-card-mobile .type-badge.video { background: #ffebee; color: #c62828; }
    
    /* Quick Actions Bar */
    .product-card-mobile .quick-actions {
      display: flex;
      border-top: 1px solid #f0f2f5;
      background: #fafafa;
    }
    
    .product-card-mobile .quick-actions button {
      flex: 1;
      border: none;
      background: transparent;
      padding: 10px;
      color: #666;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.2s;
    }
    
    .product-card-mobile .quick-actions button:active {
      background: #e0e0e0;
    }
    
    .product-card-mobile .quick-actions button.copied {
      color: var(--success);
      background: #e8f5e9;
    }
    
    .product-card-mobile .quick-actions button:not(:last-child) {
      border-right: 1px solid #e0e0e0;
    }
    
    /* ========== SEARCH BAR - FIXED BOTTOM ========== */
    
    .search-bar-bottom {
      position: fixed;
      bottom: 60px;
      left: 0;
      right: 0;
      background: #fff;
      z-index: 101;
      padding: 10px 12px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      padding-bottom: max(10px, env(safe-area-inset-bottom));
    }
    
    @media (min-width: 769px) {
      .search-bar-bottom {
        left: 250px;
        bottom: 0;
      }
    }
    
    .search-bar-bottom .search-input-wrap {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .search-bar-bottom .search-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      font-size: 16px;
      transition: all 0.2s;
      background: #f8f9fa;
    }
    
    .search-bar-bottom .search-input:focus {
      border-color: var(--primary);
      background: #fff;
      outline: none;
    }
    
    .search-bar-bottom .filter-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 2px solid #e0e0e0;
      background: #fff;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    
    .search-bar-bottom .filter-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: #000;
    }
    
    /* Filter dropdown */
    .filter-dropdown {
      position: fixed;
      bottom: 120px;
      left: 12px;
      right: 12px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
      padding: 16px;
      z-index: 102;
    }
    
    @media (min-width: 769px) {
      .filter-dropdown {
        left: 262px;
        bottom: 70px;
        right: auto;
        width: 300px;
      }
    }
    
    .filter-dropdown .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .filter-dropdown .filter-chip {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 14px;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .filter-dropdown .filter-chip.active {
      background: var(--primary);
      border-color: var(--primary);
      color: #000;
      font-weight: 600;
    }
    
    .filter-dropdown .filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #eee;
    }
    
    /* Results area - add padding for bottom bar */
    .search-results-area {
      padding: 12px;
      padding-bottom: 140px;
    }
    
    @media (min-width: 769px) {
      .search-results-area {
        padding-bottom: 80px;
      }
    }
    
    /* Result count header */
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 13px;
    }
    
    .result-header .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
    }

    /* OLD - Keep for compatibility but hidden */
    .search-header-mobile {
      display: none;
    }
    
    .search-header-mobile .search-input-wrap {
      position: relative;
    }
    
    .search-header-mobile .search-input {
      width: 100%;
      padding: 14px 16px 14px 45px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.2s;
      background: #f8f9fa;
    }
    
    .search-header-mobile .search-input:focus {
      border-color: var(--primary);
      background: #fff;
      outline: none;
      box-shadow: 0 0 0 3px rgba(255,193,7,0.2);
    }
    
    .search-header-mobile .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      font-size: 18px;
    }
    
    .search-header-mobile .clear-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: #e0e0e0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .search-header-mobile .filter-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      overflow-x: auto;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
    }
    
    .search-header-mobile .filter-row::-webkit-scrollbar {
      display: none;
    }
    
    .search-header-mobile .filter-chip {
      flex-shrink: 0;
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 13px;
      color: #666;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .search-header-mobile .filter-chip.active {
      background: var(--primary);
      border-color: var(--primary);
      color: #000;
      font-weight: 600;
    }
    
    .search-header-mobile .result-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      font-size: 12px;
      color: #666;
    }
    
    .search-header-mobile .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
    }
    
    /* ========== GRID VIEW FOR MOBILE ========== */
    
    .product-grid-mobile {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 12px;
    }
    
    .product-grid-mobile .grid-card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .product-grid-mobile .grid-card .thumb-wrap {
      position: relative;
      aspect-ratio: 1;
    }
    
    .product-grid-mobile .grid-card .thumb {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .product-grid-mobile .grid-card .price-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      color: #fff;
      padding: 20px 8px 8px;
      font-weight: 700;
      font-size: 14px;
    }
    
    .product-grid-mobile .grid-card .type-badge {
      position: absolute;
      top: 6px;
      left: 6px;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 8px;
      font-weight: 600;
    }
    
    .product-grid-mobile .grid-card .promo-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      background: var(--danger);
      color: #fff;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 8px;
      font-weight: 600;
    }
    
    .product-grid-mobile .grid-card .card-body {
      padding: 8px;
    }
    
    .product-grid-mobile .grid-card .name {
      font-size: 12px;
      font-weight: 600;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 4px;
      color: #333;
    }
    
    .product-grid-mobile .grid-card .meta {
      font-size: 10px;
      color: #888;
    }
    
    .product-grid-mobile .grid-card .quick-copy {
      display: flex;
      margin-top: 6px;
      gap: 4px;
    }
    
    .product-grid-mobile .grid-card .quick-copy button {
      flex: 1;
      border: 1px solid #e0e0e0;
      background: #fff;
      padding: 6px;
      border-radius: 6px;
      font-size: 11px;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2px;
    }
    
    .product-grid-mobile .grid-card .quick-copy button.copied {
      background: var(--success);
      color: #fff;
      border-color: var(--success);
    }
    
    /* ========== LOADING & EMPTY STATES ========== */
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
    }
    
    .empty-state i {
      font-size: 48px;
      color: #ddd;
      margin-bottom: 16px;
    }
    
    .empty-state p {
      color: #888;
      margin-bottom: 16px;
    }
    
    /* ========== RESPONSIVE ========== */
    
    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      
      .main-content {
        margin-left: 0;
        padding: 0;
        /* Extra space so fixed bottom nav never overlaps content */
        padding-bottom: calc(140px + env(safe-area-inset-bottom));
      }

      /* Ensure content isn't covered by bottom nav on mobile */
      .product-manager {
        padding-bottom: calc(160px + env(safe-area-inset-bottom));
      }
      
      /* Full width content sections - except product-manager which has its own padding */
      .main-content > div:not(.product-manager) {
        padding: 12px;
      }
      
      .mobile-bottom-nav {
        display: block;
      }
      
      /* Hide desktop components */
      .desktop-only {
        display: none !important;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-only {
        display: none !important;
      }
    }
    
    /* ========== PREVIEW MODAL ========== */
    
    .preview-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      z-index: 2000;
      display: flex;
      flex-direction: column;
    }
    
    .preview-modal .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      color: #fff;
    }
    
    .preview-modal .preview-header .close-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: #fff;
      font-size: 20px;
    }
    
    .preview-modal .preview-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    
    .preview-modal .preview-body img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
    }
    
    .preview-modal .preview-footer {
      background: rgba(0,0,0,0.5);
      padding: 16px;
      color: #fff;
    }
    
    .preview-modal .preview-footer .name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .preview-modal .preview-footer .price {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 12px;
    }
    
    .preview-modal .preview-footer .action-btns {
      display: flex;
      gap: 10px;
    }
    
    .preview-modal .preview-footer .action-btns button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    /* ========== ORDER MODAL (MOBILE FRIENDLY) ========== */

    /* Make sure order modal always sits above bottom nav */
    .order-modal {
      z-index: 3000;
    }

    /* When order modal is open, hide bottom nav on mobile */
    @media (max-width: 768px) {
      body.order-modal-open .mobile-bottom-nav {
        display: none !important;
      }

      /* Bottom-sheet style for better iPhone usability */
      .order-modal .modal-dialog {
        margin: 0;
        width: 100%;
        max-width: 100%;
        height: 100dvh;
        display: flex;
        align-items: flex-end;
      }

      .order-modal .modal-content {
        width: 100%;
        border-radius: 16px 16px 0 0 !important;
        max-height: calc(100dvh - 12px);
        overflow: hidden;
      }

      .order-modal .modal-body {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
      }

      .order-modal .modal-footer {
        position: sticky;
        bottom: 0;
        background: #fff;
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
      }
    }
    
    /* ========== FLOATING ACTION BUTTON (FAB) ========== */
    
    .fab-container {
      position: fixed;
      bottom: 80px;
      right: 16px;
      z-index: 1040;
      display: flex;
      flex-direction: column-reverse;
      align-items: center;
      gap: 12px;
    }
    
    .fab-main {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
      border: none;
      color: #1a1a2e;
      font-size: 24px;
      box-shadow: 0 4px 16px rgba(255,193,7,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .fab-main:active {
      transform: scale(0.95);
    }
    
    .fab-main.open {
      transform: rotate(45deg);
      background: #dc3545;
    }
    
    .fab-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      opacity: 0;
      transform: translateY(20px) scale(0.8);
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .fab-container.open .fab-actions {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }
    
    .fab-action {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      color: #fff;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      position: relative;
    }
    
    .fab-action.product { background: linear-gradient(135deg, #667eea, #764ba2); }
    .fab-action.album { background: linear-gradient(135deg, #2e7d32, #4caf50); }
    .fab-action.video { background: linear-gradient(135deg, #c62828, #e53935); }
    
    .fab-action .tooltip {
      position: absolute;
      right: 58px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .fab-container.open .fab-action .tooltip {
      opacity: 1;
    }
    
    /* ========== SWIPE ACTIONS ========== */
    
    .swipe-container {
      position: relative;
      overflow: hidden;
    }
    
    .swipe-content {
      transition: transform 0.2s ease-out;
      background: #fff;
    }
    
    .swipe-actions-left, .swipe-actions-right {
      position: absolute;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: stretch;
    }
    
    .swipe-actions-left {
      left: 0;
      transform: translateX(-100%);
    }
    
    .swipe-actions-right {
      right: 0;
      transform: translateX(100%);
    }
    
    .swipe-btn {
      width: 70px;
      border: none;
      color: #fff;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    
    .swipe-btn.edit { background: #0984e3; }
    .swipe-btn.delete { background: #e17055; }
    .swipe-btn.move { background: #6c5ce7; }
    
    /* ========== QUICK INLINE EDIT ========== */
    
    .product-card-mobile .quick-actions .action-edit {
      color: #0984e3;
    }
    
    .product-card-mobile .quick-actions .action-delete {
      color: #e17055;
    }
    
    /* ========== BULK SELECTION BAR ========== */
    
    .bulk-selection-bar {
      position: fixed;
      bottom: 60px;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #1a1a2e, #2d3436);
      color: #fff;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1045;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.2);
      padding-bottom: max(12px, env(safe-area-inset-bottom));
    }
    
    .bulk-selection-bar .selection-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .bulk-selection-bar .selection-count {
      background: var(--primary);
      color: #1a1a2e;
      padding: 4px 12px;
      border-radius: 16px;
      font-weight: 600;
      font-size: 14px;
    }
    
    .bulk-selection-bar .bulk-actions {
      display: flex;
      gap: 8px;
    }
    
    .bulk-selection-bar .bulk-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .bulk-selection-bar .bulk-btn.move {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }
    
    .bulk-selection-bar .bulk-btn.delete {
      background: linear-gradient(135deg, #e17055, #d63031);
      color: #fff;
    }
    
    .bulk-selection-bar .bulk-btn.cancel {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    @media (min-width: 769px) {
      .fab-container {
        bottom: 30px;
        right: 30px;
      }
      
      .bulk-selection-bar {
        left: 250px;
        bottom: 0;
      }
    }
    
    /* ========== AI CHAT - MOBILE ========== */
    
    .ai-chat-mobile {
      position: fixed;
      inset: 0;
      background: #fff;
      z-index: 1100;
      display: flex;
      flex-direction: column;
    }
    
    .ai-chat-mobile .chat-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .ai-chat-mobile .chat-header .back-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      color: #fff;
      font-size: 16px;
    }
    
    .ai-chat-mobile .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #f0f2f5;
    }
    
    .ai-chat-mobile .chat-input-area {
      padding: 12px;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
    }
    
    .ai-chat-mobile .chat-input-wrap {
      display: flex;
      gap: 8px;
    }
    
    .ai-chat-mobile .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 24px;
      font-size: 16px;
    }
    
    .ai-chat-mobile .chat-input:focus {
      border-color: #667eea;
      outline: none;
    }
    
    .ai-chat-mobile .send-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      font-size: 18px;
    }
    
    /* ========== OLD STYLES KEPT FOR COMPATIBILITY ========== */
    
    .card {
      border: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .album-card {
      transition: transform 0.2s;
      cursor: pointer;
    }
    
    .album-card:hover {
      transform: translateY(-5px);
    }
    
    .album-cover {
      height: 150px;
      object-fit: cover;
      width: 100%;
    }
    
    .image-grid {
      display: grid;
      /* grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); */
           grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 15px;
    }
    
    .image-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.2s;
    }
    
    .image-item.selected {
      transform: scale(0.98);
      box-shadow: 0 0 0 3px #0d6efd;
    }
    
    .image-item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      transition: all 0.2s;
    }
    
    .image-item .actions {
      position: absolute;
      top: 5px;
      right: 5px;
      opacity: 0;
      transition: opacity 0.2s;
      display: flex;
      gap: 4px;
    }
    
    .image-item:hover .actions {
      opacity: 1;
    }
    
    .image-item .actions .btn-info {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      border: none;
    }
    
    /* Folder tree hover */
    .hover-bg:hover {
      background: #f8f9fa;
    }
    
    .folder-tree {
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 8px;
      background: #fafafa;
    }
    
    .upload-zone {
      border: 2px dashed #ddd;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: var(--primary);
      background: #fffbeb;
    }
    
    .upload-zone input {
      display: none;
    }
    
    .upload-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .upload-preview-item {
      position: relative;
      width: 100px;
      height: 100px;
    }
    
    .upload-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .upload-preview-item .remove {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 10px;
      cursor: pointer;
    }
    
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    /* ========== SIDEBAR & MAIN CONTENT ========== */
    
    .sidebar {
      background: var(--dark);
      min-height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      width: 250px;
      padding-top: 20px;
      z-index: 1040;
    }
    
    .sidebar .logo {
      color: var(--primary);
      font-weight: bold;
      font-size: 1.5rem;
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .sidebar .nav-link {
      color: rgba(255,255,255,0.7);
      padding: 12px 20px;
      border-left: 3px solid transparent;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      color: #fff;
      background: rgba(255,255,255,0.05);
      border-left-color: var(--primary);
    }
    
    .sidebar .nav-link i {
      width: 25px;
    }
    
    .main-content {
      margin-left: 250px;
      padding: 20px;
      padding-bottom: 20px;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      .main-content {
        margin-left: 0;
      }
    }

    /* Mobile: keep enough bottom space for fixed bottom navigation */
    @media (max-width: 768px) {
      .main-content {
        padding: 0 !important;
        padding-bottom: calc(140px + env(safe-area-inset-bottom)) !important;
      }

      /* Full width content sections - except product-manager which has its own padding */
      .main-content > div:not(.product-manager) {
        padding: 12px;
      }
    }

    /* Login Page Styles */
    .login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      padding: 20px;
    }

    .login-box {
      background: #fff;
      border-radius: 15px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .login-box .input-group-text {
      background: #f8f9fa;
      border-right: none;
    }

    .login-box .form-control {
      border-left: none;
    }

    .login-box .form-control:focus {
      box-shadow: none;
      border-color: #ced4da;
    }

    .login-box .input-group:focus-within .input-group-text,
    .login-box .input-group:focus-within .form-control {
      border-color: var(--primary);
    }

    /* --- PRODUCT LIST STYLES - BEAUTIFUL & SOFT DESIGN (ADMIN) --- */
    .product-manager {
      background: #f5f7fa;
      border-radius: 0;
      padding: 12px;
      margin: 0;
      min-height: calc(100vh - 140px);
    }

    /* Mobile: reserve space for fixed bottom navigation (override must be AFTER base .product-manager rule) */
    @media (max-width: 768px) {
      .product-manager {
        padding-bottom: calc(240px + env(safe-area-inset-bottom)) !important;
      }
    }
    .product-header {
      background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
      border-radius: 16px;
      padding: 14px 18px;
      margin-bottom: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 6px 20px rgba(255,193,7,0.25);
    }
    .product-header h5 {
      color: #1a1a2e;
      font-weight: 700;
      margin: 0;
      font-size: 1.1rem;
    }
    .product-search {
      background: #fff;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }
    .product-search input,
    .product-search select {
      background: #fff !important;
      border: 1.5px solid #e9ecef !important;
      border-radius: 10px !important;
      color: #333 !important;
      padding: 10px 14px !important;
    }
    .product-search input:focus,
    .product-search select:focus {
      border-color: #ffc107 !important;
      box-shadow: 0 0 0 4px rgba(255,193,7,0.15) !important;
    }
    .product-search input::placeholder {
      color: #aaa !important;
    }

    /* Orders filter + rounded buttons (Orders screen) */
    .product-manager .btn {
      border-radius: 12px !important;
    }
    .product-search .input-group-text {
      background: #fff;
      border: 1.5px solid #e9ecef;
      border-right: none;
      border-radius: 10px 0 0 10px;
      color: #6c757d;
    }
    .product-search .input-group .form-control {
      border-left: none !important;
      border-radius: 0 !important;
    }
    .product-search .input-group .btn {
      border-radius: 0 10px 10px 0 !important;
      border: 1.5px solid #e9ecef;
      border-left: none;
    }
    .product-search .input-group:focus-within .input-group-text,
    .product-search .input-group:focus-within .form-control,
    .product-search .input-group:focus-within .btn {
      border-color: #ffc107 !important;
    }
    .product-item {
      background: #fff;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 10px;
      border: none;
      transition: all 0.25s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .product-item:hover {
      background: linear-gradient(135deg, #fffdf5 0%, #fff9e6 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255,193,7,0.12);
    }
    .product-item:active {
      transform: scale(0.985);
    }
    .product-img {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      object-fit: cover;
      box-shadow: 0 3px 12px rgba(0,0,0,0.1);
    }
    .product-img-placeholder {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .product-name {
      font-weight: 600;
      color: #2d3436;
      font-size: 0.9rem;
      line-height: 1.35;
      margin-bottom: 5px;
    }
    .product-price {
      color: #e17055;
      font-weight: 700;
      font-size: 0.95rem;
    }
    .product-badge {
      font-size: 0.65rem;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 500;
    }
    .product-badge.bg-info {
      background: linear-gradient(135deg, #e8f4fd 0%, #d6ebfa 100%) !important;
      color: #0984e3 !important;
    }
    .product-badge.bg-secondary {
      background: #f1f2f6 !important;
      color: #636e72 !important;
    }
    .product-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .product-actions .btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 0.85rem;
    }
    .product-actions .btn-edit {
      background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
      border: none;
      color: #fff;
    }
    .product-actions .btn-edit:hover, .product-actions .btn-edit:active {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(9,132,227,0.35);
    }
    .product-actions .btn-delete {
      background: linear-gradient(135deg, #fab1a0 0%, #e17055 100%);
      border: none;
      color: #fff;
    }
    .product-actions .btn-delete:hover, .product-actions .btn-delete:active {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(225,112,85,0.35);
    }
    .product-count {
      background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
      color: #fff;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      box-shadow: 0 3px 10px rgba(108,92,231,0.25);
    }
    .btn-add-product {
      background: #2d3436;
      color: #ffeaa7;
      border: none;
      padding: 10px 18px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s;
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    }
    .btn-add-product:hover, .btn-add-product:active {
      background: #1a1a2e;
      color: #ffeaa7;
      transform: scale(1.03);
    }
    .min-width-0 {
      min-width: 0;
    }
    .empty-state {
      text-align: center;
      padding: 50px 20px;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
    }
    .empty-state i {
      font-size: 3.5rem;
      color: #ffc107;
      margin-bottom: 16px;
      display: block;
    }
    .empty-state p {
      color: #636e72;
      margin-bottom: 20px;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React + Babel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.10/babel.min.js"></script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Cloudinary config - Cần tạo unsigned upload preset tên "ktm_unsigned" trên Cloudinary Dashboard
    // Settings -> Upload -> Upload presets -> Add upload preset -> Signing Mode: Unsigned
    const CLOUDINARY_CLOUD_NAME = 'diwxfpt92';
    const CLOUDINARY_UPLOAD_PRESET = 'ktm_unsigned'; 

    // API Base - Vercel dev chạy ở port 3000, dùng chung domain
    const API_BASE = '';

    // ==================== LOGIN COMPONENT ====================
    function LoginPage({ onLogin, error }) {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [showPassword, setShowPassword] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        await onLogin(username, password);
        setLoading(false);
      };

      return (
        <div className="login-page">
          <div className="login-box">
            <div className="text-center mb-4">
              <i className="fas fa-tractor fa-3x text-warning mb-3"></i>
              <h4 className="text-dark">KTM Admin</h4>
              <p className="text-muted small">Đăng nhập để quản lý</p>
            </div>

            {error && (
              <div className="alert alert-danger py-2 small">
                <i className="fas fa-exclamation-circle me-2"></i>{error}
              </div>
            )}

            <form onSubmit={handleSubmit}>
              <div className="mb-3">
                <label className="form-label small">Tên đăng nhập</label>
                <div className="input-group">
                  <span className="input-group-text"><i className="fas fa-user"></i></span>
                  <input
                    type="text"
                    className="form-control"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    placeholder="admin"
                    required
                    autoFocus
                  />
                </div>
              </div>

              <div className="mb-4">
                <label className="form-label small">Mật khẩu</label>
                <div className="input-group">
                  <span className="input-group-text"><i className="fas fa-lock"></i></span>
                  <input
                    type={showPassword ? 'text' : 'password'}
                    className="form-control"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="••••••••"
                    required
                  />
                  <button 
                    type="button" 
                    className="btn btn-outline-secondary"
                    onClick={() => setShowPassword(!showPassword)}
                  >
                    <i className={`fas fa-eye${showPassword ? '-slash' : ''}`}></i>
                  </button>
                </div>
              </div>

              <button 
                type="submit" 
                className="btn btn-warning w-100"
                disabled={loading}
              >
                {loading ? (
                  <><span className="spinner-border spinner-border-sm me-2"></span>Đang đăng nhập...</>
                ) : (
                  <><i className="fas fa-sign-in-alt me-2"></i>Đăng nhập</>
                )}
              </button>
            </form>

            <div className="text-center mt-4">
              <a href="/" className="text-muted small text-decoration-none">
                <i className="fas fa-arrow-left me-1"></i>Về trang chủ
              </a>
            </div>
          </div>
        </div>
      );
    }

    // ==================== COMPONENTS ====================

    // Toast notification
    function Toast({ message, type, onClose }) {
      useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
      }, []);

      return (
        <div className={`toast show align-items-center text-white bg-${type} border-0`} role="alert">
          <div className="d-flex">
            <div className="toast-body">{message}</div>
            <button type="button" className="btn-close btn-close-white me-2 m-auto" onClick={onClose}></button>
          </div>
        </div>
      );
    }

    // Loading overlay
    function Loading({ show }) {
      if (!show) return null;
      return (
        <div className="loading-overlay">
          <div className="spinner-border text-warning" style={{ width: '3rem', height: '3rem' }}>
            <span className="visually-hidden">Đang tải...</span>
          </div>
        </div>
      );
    }

    // Sidebar
    function Sidebar({ activeMenu, onMenuChange, onLogout, currentUser }) {
      const menus = [
        { id: 'search', icon: 'fa-search', label: 'Tra cứu nhanh', highlight: true },
        { id: 'albums', icon: 'fa-images', label: 'Quản lý Album' },
        { id: 'videos', icon: 'fa-video', label: 'Quản lý Video' },
        { id: 'products', icon: 'fa-box', label: 'Sản phẩm' },
        { id: 'orders', icon: 'fa-receipt', label: 'Quản lý đơn hàng' },
        { id: 'settings', icon: 'fa-cog', label: 'Cài đặt', disabled: true },
      ];

      return (
        <div className="sidebar d-none d-md-block">
          <div className="logo">
            <i className="fas fa-tractor me-2"></i> KTM Admin
          </div>
          <nav className="nav flex-column mt-3">
            {menus.map(menu => (
              <a
                key={menu.id}
                href="#"
                className={`nav-link ${activeMenu === menu.id ? 'active' : ''} ${menu.disabled ? 'opacity-50' : ''} ${menu.highlight ? 'text-warning' : ''}`}
                onClick={(e) => { e.preventDefault(); if (!menu.disabled) onMenuChange(menu.id); }}
              >
                <i className={`fas ${menu.icon}`}></i> {menu.label}
                {menu.disabled && <span className="badge bg-secondary ms-2">Soon</span>}
                {menu.highlight && <span className="badge bg-warning text-dark ms-2">HOT</span>}
              </a>
            ))}
          </nav>
          <div className="position-absolute bottom-0 w-100 p-3 border-top border-secondary">
            <div className="d-flex justify-content-between align-items-center">
              <a href="/" className="text-white-50 text-decoration-none small">
                <i className="fas fa-home me-1"></i> Trang chủ
              </a>
              {onLogout && (
                <button 
                  className="btn btn-sm btn-outline-danger"
                  onClick={onLogout}
                  title="Đăng xuất"
                >
                  <i className="fas fa-sign-out-alt"></i>
                </button>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Album List View - Support nested folders (folder = album, có thể chứa cả ảnh lẫn subfolder)
    function AlbumList({ albums, onSelect, onCreate, onEdit, onDelete, loading, currentFolder, onBack, breadcrumb }) {
      return (
        <div>
          <div className="d-flex justify-content-between align-items-center mb-3">
            <div className="d-flex align-items-center">
              {currentFolder && (
                <button className="btn btn-outline-secondary me-3" onClick={onBack}>
                  <i className="fas fa-arrow-left"></i>
                </button>
              )}
              <h4 className="m-0">
                <i className="fas fa-folder me-2 text-warning"></i>
                {currentFolder ? currentFolder.title : 'Thư viện ảnh'}
              </h4>
            </div>
            <button className="btn btn-warning" onClick={onCreate}>
              <i className="fas fa-folder-plus me-1"></i>Tạo Folder
            </button>
          </div>

          {/* Breadcrumb */}
          {breadcrumb && breadcrumb.length > 0 && (
            <nav aria-label="breadcrumb" className="mb-3">
              <ol className="breadcrumb mb-0">
                <li className="breadcrumb-item">
                  <a href="#" onClick={(e) => { e.preventDefault(); onBack('root'); }} className="text-warning">
                    <i className="fas fa-home"></i>
                  </a>
                </li>
                {breadcrumb.map((item, idx) => (
                  <li key={item.id} className={`breadcrumb-item ${idx === breadcrumb.length - 1 ? 'active' : ''}`}>
                    {idx === breadcrumb.length - 1 ? (
                      item.title
                    ) : (
                      <a href="#" onClick={(e) => { e.preventDefault(); onBack(item); }} className="text-warning">
                        {item.title}
                      </a>
                    )}
                  </li>
                ))}
              </ol>
            </nav>
          )}

          {loading ? (
            <div className="text-center py-5">
              <div className="spinner-border text-warning"></div>
            </div>
          ) : albums.length === 0 ? (
            <div className="text-center py-5">
              <i className="fas fa-folder-open fa-3x text-muted mb-3"></i>
              <p className="text-muted">
                {currentFolder ? 'Folder này đang trống' : 'Chưa có folder nào. Hãy tạo folder đầu tiên!'}
              </p>
            </div>
          ) : (
            <div className="row g-3">
              {albums.map(album => (
                <div key={album.uuid || album.id} className="col-6 col-md-4 col-lg-3">
                  <div className="card album-card h-100" onClick={() => onSelect(album)}>
                    {album.cover ? (
                      <img 
                        src={album.cover} 
                        className="album-cover" 
                        alt={album.title}
                      />
                    ) : (
                      <div className="card-body text-center py-4">
                        <i className="fas fa-folder fa-3x text-warning mb-2"></i>
                      </div>
                    )}
                    <div className="card-body">
                      <h6 className="card-title mb-1">{album.title}</h6>
                      <small className="text-muted">
                        {album.subfolderCount > 0 && <span><i className="fas fa-folder me-1"></i>{album.subfolderCount}</span>}
                        {album.subfolderCount > 0 && album.count > 0 && ' • '}
                        {album.count > 0 && <span><i className="fas fa-image me-1"></i>{album.count}</span>}
                        {album.subfolderCount === 0 && album.count === 0 && 'Trống'}
                      </small>
                    </div>
                    <div className="card-footer bg-transparent border-0 pt-0">
                      <button 
                        className="btn btn-sm btn-outline-primary me-2"
                        onClick={(e) => { e.stopPropagation(); onEdit(album); }}
                        title="Sửa album"
                      >
                        <i className="fas fa-edit"></i>
                      </button>
                      <button 
                        className="btn btn-sm btn-outline-danger"
                        onClick={(e) => { e.stopPropagation(); onDelete(album); }}
                        title="Xóa album"
                      >
                        <i className="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // Create/Edit Album Modal
    function AlbumModal({ show, album, onClose, onSave, parentId }) {
      const [formData, setFormData] = useState({ slug: '', title: '', description: '', cover_url: '', parent_id: null });
      const [saving, setSaving] = useState(false);
      const [uploadingCover, setUploadingCover] = useState(false);
      const coverInputRef = useRef(null);

      useEffect(() => {
        if (album) {
          setFormData({
            slug: album.id || '',
            title: album.title || '',
            description: album.description || '',
            cover_url: album.cover || '',
            parent_id: album.parentId || null
          });
        } else {
          setFormData({ slug: '', title: '', description: '', cover_url: '', parent_id: parentId || null });
        }
      }, [album, show, parentId]);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setSaving(true);
        await onSave(formData);
        setSaving(false);
      };

      const generateSlug = (title) => {
        return title
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[đĐ]/g, 'd')
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
      };

      // Nén ảnh bìa (hỗ trợ iPhone HEIC)
      const compressCoverImage = async (file) => {
        const maxSize = 2 * 1024 * 1024; // 2MB
        const isHeic = file.type === 'image/heic' || file.type === 'image/heif' || /\.heic$/i.test(file.name);
        
        // Nếu file nhỏ và không phải HEIC, không cần nén
        if (file.size <= maxSize && !isHeic) {
          return file;
        }
        
        try {
          const bitmap = await createImageBitmap(file);
          const canvas = document.createElement('canvas');
          
          // Resize max 800px cho cover
          let width = bitmap.width;
          let height = bitmap.height;
          const maxDimension = 800;
          
          if (width > maxDimension || height > maxDimension) {
            if (width > height) {
              height = Math.round((height / width) * maxDimension);
              width = maxDimension;
            } else {
              width = Math.round((width / height) * maxDimension);
              height = maxDimension;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(bitmap, 0, 0, width, height);
          bitmap.close();
          
          return new Promise((resolve, reject) => {
            canvas.toBlob((blob) => {
              if (blob) {
                resolve(new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' }));
              } else {
                reject(new Error('Không nén được ảnh'));
              }
            }, 'image/jpeg', 0.8);
          });
        } catch (err) {
          console.error('Compress cover error:', err);
          throw new Error('Không thể xử lý ảnh. Thử chọn ảnh khác.');
        }
      };

      // Upload cover image to Cloudinary
      const handleCoverUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file type (hỗ trợ Safari iOS - type có thể rỗng)
        const isImage = file.type.startsWith('image/') || /\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(file.name);
        if (!isImage) {
          alert('Vui lòng chọn file ảnh!');
          return;
        }
        
        setUploadingCover(true);
        try {
          // Nén ảnh trước khi upload (convert HEIC -> JPEG)
          const compressedFile = await compressCoverImage(file);
          
          const fd = new FormData();
          fd.append('file', compressedFile);
          fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
          fd.append('folder', 'ktm-albums/covers');
          
          const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
            method: 'POST',
            body: fd
          });
          
          const data = await res.json();
          
          if (!res.ok) {
            console.error('Cloudinary error:', data);
            throw new Error(data.error?.message || 'Upload failed');
          }
          
          setFormData(prev => ({ ...prev, cover_url: data.secure_url }));
        } catch (err) {
          console.error('Cover upload error:', err);
          alert('Lỗi upload ảnh bìa: ' + err.message);
        }
        setUploadingCover(false);
        // Reset input để có thể chọn lại cùng file
        e.target.value = '';
      };

      if (!show) return null;

      return (
        <div className="modal show d-block" style={{ background: 'rgba(0,0,0,0.5)' }}>
          <div className="modal-dialog modal-dialog-centered">
            <div className="modal-content">
              <div className="modal-header">
                <h5 className="modal-title">
                  {album ? 'Sửa' : 'Tạo'} Folder
                </h5>
                <button type="button" className="btn-close" onClick={onClose}></button>
              </div>
              <form onSubmit={handleSubmit}>
                <div className="modal-body">
                  <div className="mb-3">
                    <label className="form-label">Tên Folder *</label>
                    <input
                      type="text"
                      className="form-control"
                      value={formData.title}
                      onChange={(e) => setFormData({ 
                        ...formData, 
                        title: e.target.value,
                        slug: formData.slug || generateSlug(e.target.value)
                      })}
                      required
                    />
                  </div>
                  <div className="mb-3">
                    <label className="form-label">Slug (URL) *</label>
                    <input
                      type="text"
                      className="form-control"
                      value={formData.slug}
                      onChange={(e) => setFormData({ ...formData, slug: e.target.value })}
                      required
                      disabled={!!album}
                    />
                    <small className="text-muted">VD: may-cay-kubota-l1501</small>
                  </div>
                  <div className="mb-3">
                    <label className="form-label">Mô tả</label>
                    <textarea
                      className="form-control"
                      rows="2"
                      value={formData.description}
                      onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                    ></textarea>
                  </div>
                  <div className="mb-3">
                    <label className="form-label">Ảnh bìa</label>
                    <div className="d-flex gap-2 align-items-start">
                      {formData.cover_url && (
                        <div className="position-relative" style={{width: 80, height: 80}}>
                          <img 
                            src={formData.cover_url} 
                            alt="Cover" 
                            style={{width: '100%', height: '100%', objectFit: 'cover', borderRadius: 8}}
                          />
                          <button 
                            type="button"
                            className="btn btn-sm btn-danger position-absolute"
                            style={{top: -8, right: -8, padding: '2px 6px', fontSize: 10}}
                            onClick={() => setFormData(prev => ({ ...prev, cover_url: '' }))}
                          >
                            <i className="fas fa-times"></i>
                          </button>
                        </div>
                      )}
                      <div className="flex-grow-1">
                        <input
                          ref={coverInputRef}
                          type="file"
                          accept="image/*"
                          className="d-none"
                          onChange={handleCoverUpload}
                        />
                        <button 
                          type="button"
                          className="btn btn-outline-secondary w-100 mb-2"
                          onClick={() => coverInputRef.current?.click()}
                          disabled={uploadingCover}
                        >
                          {uploadingCover ? (
                            <><span className="spinner-border spinner-border-sm me-2"></span>Đang upload...</>
                          ) : (
                            <><i className="fas fa-upload me-2"></i>Upload ảnh bìa</>
                          )}
                        </button>
                        <input
                          type="url"
                          className="form-control form-control-sm"
                          value={formData.cover_url}
                          onChange={(e) => setFormData({ ...formData, cover_url: e.target.value })}
                          placeholder="Hoặc dán URL ảnh..."
                        />
                      </div>
                    </div>
                  </div>
                </div>
                <div className="modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={onClose}>Hủy</button>
                  <button type="submit" className="btn btn-warning" disabled={saving || uploadingCover}>
                    {saving ? <><span className="spinner-border spinner-border-sm me-2"></span>Đang lưu...</> : 'Lưu'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      );
    }

    // Folder Tree Item Component - Hiển thị dạng cây thư mục
    function FolderTreeItem({ folder, allAlbums, currentAlbumId, targetAlbum, onSelect, level = 0 }) {
      const [expanded, setExpanded] = useState(true);
      const folderId = folder.uuid || folder.id;
      const isCurrentFolder = folderId === currentAlbumId;
      const isSelected = targetAlbum === folderId;
      const children = allAlbums.filter(a => a.parentId === folderId);
      const hasChildren = children.length > 0;

      return (
        <div style={{marginLeft: level * 16 + 'px'}}>
          <div 
            className={`d-flex align-items-center p-2 rounded mb-1 ${isSelected ? 'bg-info text-white' : isCurrentFolder ? 'bg-light text-muted' : 'hover-bg'}`}
            style={{
              cursor: isCurrentFolder ? 'not-allowed' : 'pointer',
              opacity: isCurrentFolder ? 0.5 : 1,
              transition: 'background 0.2s'
            }}
            onClick={() => !isCurrentFolder && onSelect(folderId)}
          >
            {hasChildren && (
              <i 
                className={`fas fa-chevron-${expanded ? 'down' : 'right'} me-2`}
                style={{fontSize: '10px', width: '12px', cursor: 'pointer'}}
                onClick={(e) => { e.stopPropagation(); setExpanded(!expanded); }}
              ></i>
            )}
            {!hasChildren && <span style={{width: '20px'}}></span>}
            <i className={`fas fa-folder${isSelected ? '-open' : ''} me-2 ${isSelected ? '' : 'text-warning'}`}></i>
            <span className="small">{folder.title}</span>
            {isCurrentFolder && <span className="ms-2 badge bg-secondary" style={{fontSize: '9px'}}>Hiện tại</span>}
            {folder.count > 0 && !isCurrentFolder && (
              <span className="ms-auto badge bg-light text-muted" style={{fontSize: '10px'}}>{folder.count}</span>
            )}
          </div>
          
          {expanded && hasChildren && (
            <div>
              {children.map(child => (
                <FolderTreeItem
                  key={child.uuid || child.id}
                  folder={child}
                  allAlbums={allAlbums}
                  currentAlbumId={currentAlbumId}
                  targetAlbum={targetAlbum}
                  onSelect={onSelect}
                  level={level + 1}
                />
              ))}
            </div>
          )}
        </div>
      );
    }

    // Album Detail View (manage images)
    function AlbumDetail({ album, onBack, onRefresh, showToast, onNavigateToFolder, onEditSubfolder, parentAlbum }) {
      const [images, setImages] = useState([]);
      const [subfolders, setSubfolders] = useState([]);
      const [loading, setLoading] = useState(true);
      const [uploading, setUploading] = useState(false);
      const [uploadProgress, setUploadProgress] = useState('');
      const [uploadFiles, setUploadFiles] = useState([]);
      const [uploadPreviews, setUploadPreviews] = useState([]);
      const [captions, setCaptions] = useState({});
      const [previewImage, setPreviewImage] = useState(null);
      const [showCreateFolder, setShowCreateFolder] = useState(false);
      const [newFolderName, setNewFolderName] = useState('');
      const [creatingFolder, setCreatingFolder] = useState(false);
      const fileInputRef = useRef(null);
      const dropZoneRef = useRef(null);
      
      // Move image states
      const [showMoveModal, setShowMoveModal] = useState(false);
      const [selectedImages, setSelectedImages] = useState([]);
      const [allAlbums, setAllAlbums] = useState([]);
      const [targetAlbum, setTargetAlbum] = useState('');
      const [moving, setMoving] = useState(false);

      // Nén ảnh cho iPhone (HEIC, file lớn)
      const compressImage = async (file, maxSizeMB = 2) => {
        const maxSize = maxSizeMB * 1024 * 1024;
        const isHeic = file.type === 'image/heic' || file.type === 'image/heif' || /\.heic$/i.test(file.name);
        
        if (file.size <= maxSize && !isHeic) {
          return file;
        }
        
        try {
          const bitmap = await createImageBitmap(file);
          const canvas = document.createElement('canvas');
          
          let width = bitmap.width;
          let height = bitmap.height;
          const maxDimension = 1200;
          
          if (width > maxDimension || height > maxDimension) {
            if (width > height) {
              height = Math.round((height / width) * maxDimension);
              width = maxDimension;
            } else {
              width = Math.round((width / height) * maxDimension);
              height = maxDimension;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(bitmap, 0, 0, width, height);
          bitmap.close();
          
          return new Promise((resolve, reject) => {
            canvas.toBlob((blob) => {
              if (blob) {
                resolve(new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' }));
              } else {
                reject(new Error('Không nén được ảnh'));
              }
            }, 'image/jpeg', 0.7);
          });
        } catch (err) {
          console.error('Compress error:', err);
          throw new Error('Không thể xử lý ảnh');
        }
      };

      useEffect(() => {
        loadData();
        loadAllAlbums();
      }, [album.id, album.uuid]);

      const loadData = async () => {
        setLoading(true);
        try {
          // Load images
          const res = await fetch(`${API_BASE}/api/albums/${album.uuid || album.id}`);
          const data = await res.json();
          setImages(data.images || []);
          
          // Load subfolders
          const subRes = await fetch(`${API_BASE}/api/albums?parent_id=${album.uuid || album.id}`);
          const subData = await subRes.json();
          setSubfolders(Array.isArray(subData) ? subData : []);
        } catch (err) {
          console.error(err);
          showToast('Lỗi tải dữ liệu', 'danger');
        }
        setLoading(false);
      };

      // Load all albums for move dropdown
      const loadAllAlbums = async () => {
        try {
          const res = await fetch(`${API_BASE}/api/albums`);
          const data = await res.json();
          setAllAlbums(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error('Error loading albums:', err);
        }
      };

      // Toggle chọn/bỏ chọn ảnh
      const toggleSelectImage = (imgId) => {
        setSelectedImages(prev => 
          prev.includes(imgId) 
            ? prev.filter(id => id !== imgId)
            : [...prev, imgId]
        );
      };

      // Move selected images to target album
      const moveImages = async () => {
        if (!targetAlbum || selectedImages.length === 0) {
          showToast('Vui lòng chọn folder đích', 'warning');
          return;
        }

        setMoving(true);
        let successCount = 0;

        for (const imageId of selectedImages) {
          try {
            const res = await fetch(`${API_BASE}/api/images/${imageId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ album_id: targetAlbum })
            });
            if (res.ok) successCount++;
          } catch (err) {
            console.error('Move error:', err);
          }
        }

        setMoving(false);
        setShowMoveModal(false);
        setSelectedImages([]);
        setTargetAlbum('');

        if (successCount > 0) {
          showToast(`Đã di chuyển ảnh thành công!`, 'success');
          loadData();
          onRefresh();
        } else {
          showToast('Di chuyển thất bại', 'danger');
        }
      };

      // Bulk delete selected images
      const [deleting, setDeleting] = useState(false);
      
      const bulkDeleteImages = async () => {
        if (selectedImages.length === 0) return;
        
        if (!confirm(`Xóa ${selectedImages.length} ảnh đã chọn? Hành động này không thể hoàn tác!`)) return;
        
        setDeleting(true);
        let successCount = 0;
        
        for (const imageId of selectedImages) {
          try {
            const res = await fetch(`${API_BASE}/api/images/${imageId}`, { method: 'DELETE' });
            if (res.ok) successCount++;
          } catch (err) {
            console.error('Delete error:', err);
          }
        }
        
        setDeleting(false);
        setSelectedImages([]);
        
        if (successCount > 0) {
          showToast(`Đã xóa ${successCount} ảnh!`, 'success');
          loadData();
          onRefresh();
        } else {
          showToast('Xóa thất bại', 'danger');
        }
      };
      
      // Select all images
      const selectAllImages = () => {
        if (selectedImages.length === images.length) {
          setSelectedImages([]);
        } else {
          setSelectedImages(images.map(img => img.id));
        }
      };

      const createSubfolder = async () => {
        if (!newFolderName.trim()) return;
        
        setCreatingFolder(true);
        try {
          const slug = newFolderName
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/[đĐ]/g, 'd')
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/(^-|-$)/g, '');
          
          const res = await fetch(`${API_BASE}/api/albums`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              slug: slug + '-' + Date.now(),
              title: newFolderName,
              parent_id: album.uuid || album.id
            })
          });
          
          if (!res.ok) throw new Error('Lỗi tạo folder');
          
          showToast('Tạo folder thành công!', 'success');
          setNewFolderName('');
          setShowCreateFolder(false);
          loadData();
          onRefresh();
        } catch (err) {
          showToast(err.message, 'danger');
        }
        setCreatingFolder(false);
      };

      const deleteSubfolder = async (folder) => {
        if (!confirm(`Xóa folder "${folder.title}"? Tất cả nội dung bên trong sẽ bị xóa!`)) return;
        
        try {
          await fetch(`${API_BASE}/api/albums/${folder.uuid || folder.id}`, { method: 'DELETE' });
          showToast('Đã xóa folder', 'success');
          loadData();
          onRefresh();
        } catch (err) {
          showToast('Lỗi xóa folder', 'danger');
        }
      };

      const handleFileSelect = (files) => {
        // Validate cho iOS - check cả name nếu type rỗng
        const newFiles = Array.from(files).filter(f => 
          f.type.startsWith('image/') || /\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(f.name)
        );
        setUploadFiles(prev => [...prev, ...newFiles]);
        
        // Create previews
        newFiles.forEach(file => {
          const reader = new FileReader();
          reader.onload = (e) => {
            setUploadPreviews(prev => [...prev, { file, preview: e.target.result }]);
          };
          reader.readAsDataURL(file);
        });
      };

      const removeUploadFile = (index) => {
        setUploadFiles(prev => prev.filter((_, i) => i !== index));
        setUploadPreviews(prev => prev.filter((_, i) => i !== index));
      };

      const uploadToCloudinary = async (file) => {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        formData.append('folder', `ktm-albums/${album.id}`);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: formData
        });

        if (!res.ok) {
          const err = await res.json();
          console.error('Cloudinary error:', err);
          throw new Error(err.error?.message || 'Upload failed');
        }
        return await res.json();
      };

      const handleUpload = async () => {
        if (uploadFiles.length === 0) return;

        setUploading(true);
        let successCount = 0;

        for (let i = 0; i < uploadFiles.length; i++) {
          try {
            setUploadProgress(`Đang xử lý ${i + 1}/${uploadFiles.length}...`);
            
            // Nén ảnh trước khi upload (hỗ trợ iPhone HEIC)
            const compressedFile = await compressImage(uploadFiles[i], 2);
            
            setUploadProgress(`Đang upload ${i + 1}/${uploadFiles.length}...`);
            
            // Upload to Cloudinary
            const cloudinaryRes = await uploadToCloudinary(compressedFile);
            
            // Save to DB
            await fetch(`${API_BASE}/api/albums/${album.id}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                url: cloudinaryRes.secure_url,
                caption: captions[i] || uploadFiles[i].name.replace(/\.[^/.]+$/, ''),
                sort_order: images.length + i
              })
            });
            
            successCount++;
          } catch (err) {
            console.error('Upload error:', err);
          }
        }

        setUploading(false);
        setUploadProgress('');
        setUploadFiles([]);
        setUploadPreviews([]);
        setCaptions({});
        
        if (successCount > 0) {
          showToast(`Đã upload ${successCount} ảnh thành công!`, 'success');
          loadData();
          onRefresh();
        } else {
          showToast('Upload thất bại', 'danger');
        }
      };

      const deleteImage = async (imageId, index) => {
        if (!confirm('Xóa ảnh này?')) return;
        
        try {
          // Note: Cần API delete image - tạm thời chỉ reload
          await fetch(`${API_BASE}/api/images/${imageId}`, { method: 'DELETE' });
          showToast('Đã xóa ảnh', 'success');
          loadData();
          onRefresh();
        } catch (err) {
          showToast('Lỗi xóa ảnh', 'danger');
        }
      };

      // Drag & Drop handlers
      const handleDragOver = (e) => {
        e.preventDefault();
        dropZoneRef.current?.classList.add('dragover');
      };

      const handleDragLeave = () => {
        dropZoneRef.current?.classList.remove('dragover');
      };

      const handleDrop = (e) => {
        e.preventDefault();
        dropZoneRef.current?.classList.remove('dragover');
        handleFileSelect(e.dataTransfer.files);
      };

      return (
        <div>
          <div className="d-flex align-items-center justify-content-between mb-4">
            <div className="d-flex align-items-center">
              <button className="btn btn-outline-secondary me-3" onClick={onBack}>
                <i className="fas fa-arrow-left"></i>
              </button>
              <div>
                <h4 className="m-0">{album.title}</h4>
                <small className="text-muted">
                  {subfolders.length > 0 && <span>{subfolders.length} folder • </span>}
                  {images.length} ảnh
                </small>
              </div>
            </div>
            <button 
              className="btn btn-outline-warning btn-sm"
              onClick={() => setShowCreateFolder(true)}
            >
              <i className="fas fa-folder-plus me-1"></i>Tạo Folder con
            </button>
          </div>

          {/* Create Subfolder Modal */}
          {showCreateFolder && (
            <div className="card mb-4 border-warning">
              <div className="card-body">
                <h6 className="mb-3"><i className="fas fa-folder-plus me-2 text-warning"></i>Tạo folder con</h6>
                <div className="d-flex gap-2">
                  <input
                    type="text"
                    className="form-control"
                    placeholder="Tên folder..."
                    value={newFolderName}
                    onChange={(e) => setNewFolderName(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && createSubfolder()}
                    autoFocus
                  />
                  <button 
                    className="btn btn-warning"
                    onClick={createSubfolder}
                    disabled={creatingFolder || !newFolderName.trim()}
                  >
                    {creatingFolder ? <span className="spinner-border spinner-border-sm"></span> : 'Tạo'}
                  </button>
                  <button 
                    className="btn btn-secondary"
                    onClick={() => { setShowCreateFolder(false); setNewFolderName(''); }}
                  >
                    Hủy
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Subfolders */}
          {subfolders.length > 0 && (
            <div className="card mb-4">
              <div className="card-body">
                <h6 className="mb-3"><i className="fas fa-folder me-2 text-warning"></i>Folder con</h6>
                <div className="row g-2">
                  {subfolders.map(folder => (
                    <div key={folder.uuid || folder.id} className="col-6 col-md-4 col-lg-3">
                      <div 
                        className="card h-100 folder-item" 
                        style={{cursor: 'pointer'}}
                        onClick={() => onNavigateToFolder && onNavigateToFolder(folder)}
                      >
                        <div className="card-body text-center py-3">
                          <i className="fas fa-folder fa-2x text-warning mb-2"></i>
                          <div className="small fw-bold text-truncate">{folder.title}</div>
                          <small className="text-muted">
                            {folder.subfolderCount > 0 && <span>{folder.subfolderCount} folder</span>}
                            {folder.subfolderCount > 0 && folder.count > 0 && ' • '}
                            {folder.count > 0 && <span>{folder.count} ảnh</span>}
                            {folder.subfolderCount === 0 && folder.count === 0 && 'Trống'}
                          </small>
                        </div>
                        <div className="card-footer bg-transparent border-0 pt-0 text-center">
                          <button 
                            className="btn btn-sm btn-outline-primary me-1"
                            onClick={(e) => { e.stopPropagation(); onEditSubfolder && onEditSubfolder(folder); }}
                            title="Sửa folder"
                          >
                            <i className="fas fa-edit"></i>
                          </button>
                          <button 
                            className="btn btn-sm btn-outline-danger"
                            onClick={(e) => { e.stopPropagation(); deleteSubfolder(folder); }}
                            title="Xóa folder"
                          >
                            <i className="fas fa-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Upload Zone */}
          <div className="card mb-4">
            <div className="card-body">
              <h6 className="mb-3"><i className="fas fa-cloud-upload-alt me-2"></i>Upload ảnh mới</h6>
              
              <div 
                ref={dropZoneRef}
                className="upload-zone"
                onClick={() => fileInputRef.current?.click()}
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
              >
                <i className="fas fa-images fa-2x text-muted mb-2"></i>
                <p className="mb-0">Kéo thả ảnh vào đây hoặc click để chọn</p>
                <small className="text-muted">Hỗ trợ JPG, PNG, WebP</small>
                <input
                  ref={fileInputRef}
                  type="file"
                  multiple
                  accept="image/*"
                  onChange={(e) => handleFileSelect(e.target.files)}
                />
              </div>

              {uploadPreviews.length > 0 && (
                <div className="mt-3">
                  <div className="upload-preview">
                    {uploadPreviews.map((item, index) => (
                      <div key={index} className="upload-preview-item">
                        <img src={item.preview} alt="" />
                        <button className="remove" onClick={() => removeUploadFile(index)}>
                          <i className="fas fa-times"></i>
                        </button>
                      </div>
                    ))}
                  </div>
                  <div className="mt-3">
                    <button 
                      className="btn btn-warning"
                      onClick={handleUpload}
                      disabled={uploading}
                    >
                      {uploading ? (
                        <><span className="spinner-border spinner-border-sm me-2"></span>{uploadProgress || 'Đang upload...'}</>
                      ) : (
                        <><i className="fas fa-upload me-2"></i>Upload {uploadFiles.length} ảnh</>
                      )}
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Image Grid */}
          <div className="card">
            <div className="card-body">
              {/* Header với toolbar khi có ảnh được chọn */}
              <div className="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div className="d-flex align-items-center gap-2">
                  <h6 className="m-0"><i className="fas fa-th me-2"></i>Ảnh ({images.length})</h6>
                  {images.length > 0 && (
                    <button 
                      className="btn btn-sm btn-outline-secondary"
                      onClick={selectAllImages}
                    >
                      {selectedImages.length === images.length ? 'Bỏ chọn' : 'Chọn tất cả'}
                    </button>
                  )}
                </div>
                
                {/* Toolbar hiện khi có ảnh được chọn */}
                {selectedImages.length > 0 && (
                  <div className="d-flex align-items-center gap-2 flex-wrap">
                    <span className="badge bg-primary">{selectedImages.length} đã chọn</span>
                    <button 
                      className="btn btn-sm btn-info"
                      onClick={() => setShowMoveModal(true)}
                    >
                      <i className="fas fa-folder-open me-1"></i>Di chuyển
                    </button>
                    <button 
                      className="btn btn-sm btn-danger"
                      onClick={bulkDeleteImages}
                      disabled={deleting}
                    >
                      {deleting ? (
                        <span className="spinner-border spinner-border-sm"></span>
                      ) : (
                        <><i className="fas fa-trash me-1"></i>Xóa</>
                      )}
                    </button>
                    <button 
                      className="btn btn-sm btn-outline-secondary"
                      onClick={() => setSelectedImages([])}
                    >
                      <i className="fas fa-times"></i>
                    </button>
                  </div>
                )}
              </div>
              
              {loading ? (
                <div className="text-center py-4">
                  <div className="spinner-border text-warning"></div>
                </div>
              ) : images.length === 0 ? (
                <div className="text-center py-4 text-muted">
                  <i className="fas fa-image fa-2x mb-2"></i>
                  <p>Chưa có ảnh nào trong album này</p>
                </div>
              ) : (
                <div className="image-grid">
                  {images.map((img, index) => (
                    <div 
                      key={index} 
                      className={`image-item ${selectedImages.includes(img.id) ? 'selected' : ''}`}
                      style={{position: 'relative', cursor: 'pointer'}}
                      onClick={() => toggleSelectImage(img.id)}
                    >
                      {/* Checkbox góc trái */}
                      <div 
                        className="select-checkbox"
                        style={{
                          position: 'absolute',
                          top: '6px',
                          left: '6px',
                          zIndex: 10,
                          width: '24px',
                          height: '24px',
                          borderRadius: '4px',
                          background: selectedImages.includes(img.id) ? '#0d6efd' : 'rgba(255,255,255,0.9)',
                          border: selectedImages.includes(img.id) ? 'none' : '2px solid #ccc',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          boxShadow: '0 1px 3px rgba(0,0,0,0.2)'
                        }}
                      >
                        {selectedImages.includes(img.id) && (
                          <i className="fas fa-check" style={{color: '#fff', fontSize: '12px'}}></i>
                        )}
                      </div>
                      
                      <img 
                        src={img.src} 
                        alt={img.caption} 
                        style={{
                          opacity: selectedImages.includes(img.id) ? 0.7 : 1,
                          border: selectedImages.includes(img.id) ? '3px solid #0d6efd' : 'none',
                          borderRadius: '8px'
                        }}
                      />
                      
                      {/* Actions - chỉ hiện nút xóa khi hover */}
                      <div className="actions">
                        <button 
                          className="btn btn-sm btn-danger"
                          onClick={(e) => { e.stopPropagation(); deleteImage(img.id, index); }}
                          title="Xóa ảnh"
                        >
                          <i className="fas fa-trash"></i>
                        </button>
                      </div>
                      
                      {img.caption && (
                        <div className="p-2 bg-light small text-truncate">{img.caption}</div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Move Image Modal - Dạng cây thư mục */}
          {showMoveModal && (
            <div className="modal show d-block" style={{backgroundColor: 'rgba(0,0,0,0.5)'}}>
              <div className="modal-dialog modal-dialog-centered">
                <div className="modal-content">
                  <div className="modal-header bg-info text-white">
                    <h5 className="modal-title">
                      <i className="fas fa-folder-open me-2"></i>
                      Di chuyển {selectedImages.length} ảnh
                    </h5>
                    <button type="button" className="btn-close btn-close-white" onClick={() => setShowMoveModal(false)}></button>
                  </div>
                  <div className="modal-body" style={{maxHeight: '400px', overflowY: 'auto'}}>
                    <p className="text-muted small mb-3">Chọn thư mục đích:</p>
                    
                    {/* Folder Tree */}
                    <div className="folder-tree">
                      {allAlbums.filter(a => !a.parentId).map(folder => (
                        <FolderTreeItem 
                          key={folder.uuid || folder.id}
                          folder={folder}
                          allAlbums={allAlbums}
                          currentAlbumId={album.uuid || album.id}
                          targetAlbum={targetAlbum}
                          onSelect={setTargetAlbum}
                        />
                      ))}
                    </div>
                  </div>
                  <div className="modal-footer">
                    <button 
                      type="button" 
                      className="btn btn-secondary" 
                      onClick={() => setShowMoveModal(false)}
                    >
                      Hủy
                    </button>
                    <button 
                      type="button" 
                      className="btn btn-info"
                      onClick={moveImages}
                      disabled={!targetAlbum || moving}
                    >
                      {moving ? (
                        <><span className="spinner-border spinner-border-sm me-1"></span>Đang chuyển...</>
                      ) : (
                        <><i className="fas fa-check me-1"></i>Di chuyển đến đây</>
                      )}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Image Preview Modal */}
          {previewImage && (
            <div 
              className="modal show d-block" 
              style={{backgroundColor: 'rgba(0,0,0,0.9)'}}
              onClick={() => setPreviewImage(null)}
            >
              <div className="modal-dialog modal-fullscreen d-flex align-items-center justify-content-center">
                <div className="position-relative" style={{maxWidth: '95vw', maxHeight: '95vh'}}>
                  <button 
                    className="btn btn-light position-absolute"
                    style={{top: '-50px', right: '0', borderRadius: '50%', width: '40px', height: '40px'}}
                    onClick={() => setPreviewImage(null)}
                  >
                    <i className="fas fa-times"></i>
                  </button>
                  <img 
                    src={previewImage.src} 
                    alt={previewImage.caption}
                    style={{maxWidth: '95vw', maxHeight: '90vh', objectFit: 'contain'}}
                    onClick={(e) => e.stopPropagation()}
                  />
                  {previewImage.caption && (
                    <div className="text-white text-center mt-2">{previewImage.caption}</div>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ==================== SEARCH CENTER - TRA CỨU NHANH ====================
    
    function SearchCenter({ showToast, onNavigate }) {
      const [searchQuery, setSearchQuery] = useState('');
      const [searchResults, setSearchResults] = useState([]);
      const [allData, setAllData] = useState([]);
      const [categories, setCategories] = useState([]);
      const [selectedCategory, setSelectedCategory] = useState('all');
      const [copiedId, setCopiedId] = useState(null);
      const [viewMode, setViewMode] = useState('list'); // list | grid
      const [loading, setLoading] = useState(true);
      const [albums, setAlbums] = useState([]);
      const [videoFolders, setVideoFolders] = useState([]);
      const searchInputRef = useRef(null);
      
      // AI Search states
      const [aiSearchEnabled, setAiSearchEnabled] = useState(true);
      const [aiSearching, setAiSearching] = useState(false);
      const aiSearchTimeoutRef = useRef(null);
      
      // AI Chat states
      const [showAIChat, setShowAIChat] = useState(false);
      const [aiMessages, setAiMessages] = useState([
        { role: 'assistant', content: 'Xin chào! Hãy hỏi tôi về sản phẩm, giá cả... Ví dụ:\n• "Giá van 2 tay?"\n• "Combo rẻ nhất?"\n• "Freeship?"', attachments: [] }
      ]);
      const [aiInput, setAiInput] = useState('');
      const [aiLoading, setAiLoading] = useState(false);
      const chatEndRef = useRef(null);
      const aiInputRef = useRef(null);
      
      // Modal state for image preview
      const [previewImage, setPreviewImage] = useState(null);
      
      // Quick Edit/Delete states
      const [showQuickEdit, setShowQuickEdit] = useState(false);
      const [editingItem, setEditingItem] = useState(null);
      const [fabOpen, setFabOpen] = useState(false);
      
      // Product Modal states
      const [showProductModal, setShowProductModal] = useState(false);
      const [editingProduct, setEditingProduct] = useState(null);
      
      // Product edit form
      const [productForm, setProductForm] = useState({
        name: '', code: '', price: '', image: '', category: '', note: ''
      });
      const productCategories = ['Ty xy lanh', 'Combo Van 1 tay', 'Combo Van 2 tay', 'Combo Van 3 tay', 'Combo Van 4 tay', 'Combo Van 5 tay', 'Trang gạt', 'Phụ kiện', 'Van điều khiển'];
      
      // Quick Edit Product
      const handleQuickEdit = (item) => {
        if (item._type === 'product') {
          setEditingItem(item);
          setProductForm({
            name: item.name || '',
            code: item.code || '',
            price: item.price || '',
            image: item.image || '',
            category: item.category || '',
            note: item.note || ''
          });
          setShowQuickEdit(true);
        }
      };
      
      // Save Quick Edit
      const handleSaveQuickEdit = async () => {
        if (!editingItem) return;
        
        try {
          const res = await fetch(`${API_BASE}/api/products?id=${editingItem.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(productForm)
          });
          
          if (!res.ok) throw new Error('Lỗi cập nhật');
          
          showToast('Cập nhật thành công!', 'success');
          setShowQuickEdit(false);
          setEditingItem(null);
          
          // Reload data
          loadAllData();
        } catch (err) {
          showToast(err.message, 'danger');
        }
      };
      
      // Quick Delete
      const handleQuickDelete = async (item) => {
        const typeName = item._type === 'product' ? 'sản phẩm' : item._type === 'album' ? 'ảnh' : 'video';
        if (!confirm(`Xóa ${typeName} "${item.name}"?`)) return;
        
        try {
          let url = '';
          if (item._type === 'product') {
            url = `${API_BASE}/api/products?id=${item.id}`;
          } else if (item._type === 'album') {
            url = `${API_BASE}/api/images/${item.id}`;
          } else if (item._type === 'video') {
            url = `${API_BASE}/api/videos/${item.id}`;
          }
          
          const res = await fetch(url, { method: 'DELETE' });
          if (!res.ok) throw new Error('Lỗi xóa');
          
          showToast(`Đã xóa ${typeName}`, 'success');
          loadAllData();
        } catch (err) {
          showToast(err.message, 'danger');
        }
      };
      
      // Handle save product from FAB modal
      const handleSaveProduct = async (formData) => {
        try {
          const url = editingProduct 
            ? `${API_BASE}/api/products?id=${editingProduct.id}`
            : `${API_BASE}/api/products`;
          const res = await fetch(url, {
            method: editingProduct ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          if (!res.ok) throw new Error('Lỗi lưu sản phẩm');
          showToast(editingProduct ? 'Cập nhật thành công!' : 'Thêm sản phẩm thành công!', 'success');
          setShowProductModal(false);
          setEditingProduct(null);
          loadAllData(); // Refresh search results
        } catch (err) {
          showToast(err.message, 'danger');
        }
      };
      
      // Load data function (song song hóa fetch)

      // Hàm cache helper
      const CACHE_KEY = 'ktm_admin_data_cache_v1';
      const CACHE_TTL = 1000 * 60 * 10; // 10 phút

      const loadAllData = async () => {
        // 1. Thử lấy cache

        let cache = null;
        let usedCache = false;
        try {
          const raw = localStorage.getItem(CACHE_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && parsed.timestamp && Date.now() - parsed.timestamp < CACHE_TTL && Array.isArray(parsed.data)) {
              cache = parsed.data;
              console.log('[CACHE] Using cache, items:', cache.length);
              setAllData(cache);
              setSearchResults(cache);
              setLoading(false); // Dừng loading ngay khi có cache
              usedCache = true;
            } else {
              console.log('[CACHE] Cache expired or invalid');
            }
          } else {
            console.log('[CACHE] No cache found');
          }
        } catch (e) {
          console.error('[CACHE] Error parsing cache:', e);
        }

        // Nếu có cache thì không loading, chỉ loading khi fetch mới
        if (!usedCache) setLoading(true);

        // Luôn fetch API để cập nhật cache, nhưng không block UI
        try {
          // Song song hóa 3 API
          const [productsRes, albumsRes, videosRes] = await Promise.all([
            fetch(`${API_BASE}/api/products`),
            fetch(`${API_BASE}/api/albums`),
            fetch(`${API_BASE}/api/video-folders?withVideos=true`)
          ]);

          // Parse JSON song song
          const [productsData, albumsList, videosList] = await Promise.all([
            productsRes.ok ? productsRes.json() : [],
            albumsRes.ok ? albumsRes.json() : [],
            videosRes.ok ? videosRes.json() : []
          ]);

          // Products
          const products = Array.isArray(productsData)
            ? productsData.map(p => ({ ...p, _type: 'product', _source: 'database' }))
            : [];

          // Albums & images (song song fetch images từng album)
          setAlbums(albumsList);
          let albumImagesData = [];
          if (Array.isArray(albumsList) && albumsList.length > 0) {
            // Fetch tất cả album images song song
            const albumImageFetches = albumsList.map(album =>
              fetch(`${API_BASE}/api/albums/${album.id}`)
            );
            const albumImageResArr = await Promise.all(albumImageFetches);
            const albumImageJsonArr = await Promise.all(albumImageResArr.map(r => r.ok ? r.json() : {}));
            albumImageJsonArr.forEach((albumDetail, idx) => {
              const album = albumsList[idx];
              if (albumDetail.images && albumDetail.images.length > 0) {
                albumDetail.images.forEach(img => {
                  albumImagesData.push({
                    id: img.id,
                    name: img.caption || 'Ảnh từ ' + album.title,
                    image: img.src,
                    folder: album.title,
                    _type: 'album',
                    _source: 'database'
                  });
                });
              }
            });
          }

          // Videos
          setVideoFolders(videosList);
          let videosData = [];
          if (Array.isArray(videosList)) {
            videosList.forEach(folder => {
              if (folder.videos) {
                folder.videos.forEach(v => {
                  videosData.push({
                    id: v.id,
                    name: v.title,
                    folder: folder.name,
                    image: v.thumb,
                    youtubeId: v.youtubeId,
                    url: v.url,
                    _type: 'video',
                    _source: 'database'
                  });
                });
              }
            });
          }

          const combined = [...products, ...albumImagesData, ...videosData];
          // So sánh với cache, nếu khác thì update UI và cache
          const isDifferent = !cache || JSON.stringify(combined) !== JSON.stringify(cache);
          if (isDifferent) {
            setAllData(combined);
            setSearchResults(combined);
            try {
              localStorage.setItem(CACHE_KEY, JSON.stringify({ data: combined, timestamp: Date.now() }));
            } catch (e) { /* ignore */ }
          }
        } catch (err) {
          console.error('Song song fetch error:', err);
        }
        setLoading(false);
      };

      // Load data từ nhiều nguồn
      useEffect(() => {
        loadAllData();
        
        // Focus search input
        setTimeout(() => searchInputRef.current?.focus(), 100);
      }, []);

      // AI-powered search function
      const performAISearch = async (query, basicResults) => {
        if (!aiSearchEnabled || basicResults.length === 0) return;
        
        setAiSearching(true);
        try {
          // Prepare product list for AI
          const productList = basicResults.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            category: item.category,
            note: item.note,
            folder: item.folder,
            _type: item._type
          }));

          const response = await fetch(`${API_BASE}/api/ai-search`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              query: query,
              products: productList
            })
          });

          if (response.ok) {
            const data = await response.json();
            if (data.matchedIds && data.matchedIds.length > 0) {
              // Filter results to only include AI-matched items
              const aiFiltered = basicResults.filter(item => 
                data.matchedIds.includes(item.id)
              );
              if (aiFiltered.length > 0) {
                setSearchResults(aiFiltered);
              }
            } else if (data.matchedIds && data.matchedIds.length === 0) {
              // AI found no matches - show empty
              setSearchResults([]);
            }
          }
        } catch (err) {
          console.error('AI Search error:', err);
          // Keep basic results on error
        }
        setAiSearching(false);
      };

      // Search function - flexible matching with AI enhancement
      const handleSearch = (query) => {
        setSearchQuery(query);
        
        // Clear previous AI search timeout
        if (aiSearchTimeoutRef.current) {
          clearTimeout(aiSearchTimeoutRef.current);
        }
        
        if (!query.trim()) {
          filterByCategory(selectedCategory);
          return;
        }

        const lowerQuery = query.toLowerCase();
        const words = lowerQuery.split(/\s+/).filter(w => w.length > 0);

        const results = allData.filter(item => {
          // Search through ALL fields
          const searchableText = Object.entries(item)
            .filter(([key]) => !key.startsWith('_'))
            .map(([, value]) => String(value || '').toLowerCase())
            .join(' ');

          // All words must match somewhere (OR logic for basic, AI will refine)
          return words.some(word => searchableText.includes(word));
        });

        // Apply category filter
        let finalResults = results;
        if (selectedCategory !== 'all') {
          finalResults = results.filter(item => 
            (item.category || item._type) === selectedCategory
          );
        }
        
        setSearchResults(finalResults);

        // Trigger AI search after debounce (500ms)
        if (aiSearchEnabled && query.length >= 3) {
          aiSearchTimeoutRef.current = setTimeout(() => {
            performAISearch(query, finalResults);
          }, 500);
        }
      };

      // Filter by category
      const filterByCategory = (cat) => {
        setSelectedCategory(cat);
        
        let filtered = allData;
        if (cat !== 'all') {
          filtered = allData.filter(item => 
            (item.category || item._type) === cat
          );
        }

        if (searchQuery.trim()) {
          const lowerQuery = searchQuery.toLowerCase();
          const words = lowerQuery.split(/\s+/).filter(w => w.length > 0);
          filtered = filtered.filter(item => {
            const searchableText = Object.entries(item)
              .filter(([key]) => !key.startsWith('_'))
              .map(([, value]) => String(value || '').toLowerCase())
              .join(' ');
            return words.every(word => searchableText.includes(word));
          });
        }

        setSearchResults(filtered);
      };

      // Copy helpers
      const copyText = (text, id) => {
        navigator.clipboard.writeText(text).then(() => {
          setCopiedId(id);
          showToast('Đã copy!', 'success');
          setTimeout(() => setCopiedId(null), 1500);
        });
      };

      const copyImage = async (url, id) => {
        try {
          const response = await fetch(url);
          const blob = await response.blob();
          await navigator.clipboard.write([
            new ClipboardItem({ [blob.type]: blob })
          ]);
          setCopiedId(id + '-img');
          showToast('Đã copy ảnh!', 'success');
          setTimeout(() => setCopiedId(null), 1500);
        } catch (err) {
          // Fallback: copy URL
          copyText(url, id + '-img');
        }
      };

      // Find matching items from message - hiện ảnh đúng TẤT CẢ sản phẩm được hỏi
      const findMatchingItems = (message) => {
        let lowerMsg = message.toLowerCase();
        const results = [];
        
        // Chỉ filter products (không lấy albums, videos)
        const products = allData.filter(item => item._type === 'product');
        
        // 1. Tìm xy lanh được đề cập
        if (lowerMsg.includes('ty') || lowerMsg.includes('xy lanh')) {
          if (lowerMsg.includes('giữa') || lowerMsg.includes('giua')) {
            const match = products.find(p => p.name?.toLowerCase().includes('xy lanh giữa'));
            if (match && !results.find(r => r.id === match.id)) results.push(match);
          }
          if (lowerMsg.includes('nghiêng') || lowerMsg.includes('nghieng')) {
            const match = products.find(p => p.name?.toLowerCase().includes('xy lanh nghiêng'));
            if (match && !results.find(r => r.id === match.id)) results.push(match);
          }
          if (lowerMsg.includes('ủi') || lowerMsg.includes('ui')) {
            const match = products.find(p => p.name?.toLowerCase().includes('xy lanh ủi'));
            if (match && !results.find(r => r.id === match.id)) results.push(match);
          }
        }
        
        // 2. Tìm combo "van X tay Y ty"
        const vanTyMatch = lowerMsg.match(/van\s*(\d+)\s*tay.*?(\d+)\s*ty/);
        if (vanTyMatch) {
          const tayNum = vanTyMatch[1];
          const tyNum = vanTyMatch[2];
          // Tìm combo van X tay + Y xylanh
          const comboMatch = products.find(p => {
            const name = p.name?.toLowerCase() || '';
            return name.includes('combo') && 
                   name.includes(`${tayNum} tay`) && 
                   (name.includes(`${tyNum} xy`) || name.includes(`${tyNum} xylanh`));
          });
          if (comboMatch && !results.find(r => r.id === comboMatch.id)) {
            results.push(comboMatch);
          } else {
            // Fallback: combo van X tay bất kỳ
            const fallback = products.find(p => {
              const name = p.name?.toLowerCase() || '';
              return name.includes('combo') && name.includes(`${tayNum} tay`);
            });
            if (fallback && !results.find(r => r.id === fallback.id)) results.push(fallback);
          }
        }
        
        // 3. Tìm combo nếu có từ "combo"
        if (lowerMsg.includes('combo') && !vanTyMatch) {
          const comboTayMatch = lowerMsg.match(/combo.*?(\d+)\s*tay/);
          if (comboTayMatch) {
            const tayNum = comboTayMatch[1];
            const matches = products.filter(p => {
              const name = p.name?.toLowerCase() || '';
              return name.includes('combo') && name.includes(`${tayNum} tay`);
            });
            matches.forEach(m => {
              if (!results.find(r => r.id === m.id)) results.push(m);
            });
          }
        }
        
        // 4. Tìm van đơn lẻ (nếu không có ty đi kèm)
        const vanOnlyMatch = lowerMsg.match(/van\s*(\d+)\s*tay/);
        if (vanOnlyMatch && !lowerMsg.includes('ty') && !lowerMsg.includes('combo')) {
          const vanNum = vanOnlyMatch[1];
          const match = products.find(p => {
            const name = p.name?.toLowerCase() || '';
            return name.includes(`van ${vanNum} tay`) && !name.includes('combo');
          });
          if (match && !results.find(r => r.id === match.id)) results.push(match);
        }
        
        return results.slice(0, 4);
      };

      // AI Chat function - Local AI using data context
      const handleAIChat = async (message) => {
        if (!message.trim()) return;
        
        // Add user message
        const userMsg = { role: 'user', content: message, attachments: [] };
        setAiMessages(prev => [...prev, userMsg]);
        setAiInput('');
        setAiLoading(true);

        // Find matching items to attach
        const matchedItems = findMatchingItems(message);

        // Scroll to bottom
        setTimeout(() => chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);

        try {
          // Chỉ lấy products (không lấy albums, videos)
          const productsOnly = allData.filter(item => item._type === 'product');
          
          // Build context chỉ từ products
          const dataContext = productsOnly.map(item => {
            let info = `- ${item.name}`;
            if (item.code) info += ` (Mã: ${item.code})`;
            if (item.price) info += ` - Giá: ${item.price.replace(/[đ\s]/g, '')}đ`;
            if (item.category) info += ` [${item.category}]`;
            if (item.note) info += ` (${item.note})`;
            return info;
          }).join('\n');

          // Build chat history để AI hiểu ngữ cảnh (lấy 6 tin nhắn gần nhất)
          const recentMessages = aiMessages.slice(-6);
          const historyText = recentMessages.map(m => 
            `${m.role === 'user' ? 'Khách' : 'AI'}: ${m.content}`
          ).join('\n');
          
          // Gộp context = products + history
          const fullContext = historyText 
            ? `LỊCH SỬ HỘI THOẠI:\n${historyText}\n\nDANH SÁCH SẢN PHẨM:\n${dataContext}`
            : dataContext;

          // Call backend API cho Admin
          const response = await fetch(`${API_BASE}/api/ai-chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: message,
              context: fullContext,
              audience: 'admin'
            })
          });

          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || 'API error');
          }
          
          const aiResponse = data.response || 'Xin lỗi, tôi không thể trả lời lúc này.';
          
          // Attach matching items with images/videos
          setAiMessages(prev => [...prev, { 
            role: 'assistant', 
            content: aiResponse,
            attachments: matchedItems
          }]);
        } catch (err) {
          console.error('AI Error:', err);
          
          // Fallback: Simple local search
          const lowerMsg = message.toLowerCase();
          const matches = allData.filter(item => {
            const text = Object.values(item).join(' ').toLowerCase();
            return lowerMsg.split(' ').some(word => text.includes(word));
          });

          let fallbackResponse = '';
          if (matches.length > 0) {
            fallbackResponse = `Tìm thấy ${matches.length} sản phẩm liên quan:\n\n`;
            matches.slice(0, 5).forEach(item => {
              fallbackResponse += `• ${item.name}`;
              if (item.price) fallbackResponse += ` - ${item.price.replace(/[đ\s]/g, '')}đ`;
              if (item.note) fallbackResponse += ` (${item.note})`;
              fallbackResponse += '\n';
            });
            if (matches.length > 5) fallbackResponse += `\n...và ${matches.length - 5} sản phẩm khác`;
          } else {
            fallbackResponse = 'Không tìm thấy sản phẩm phù hợp. Hãy thử từ khóa khác như "van", "combo", "xy lanh"...';
          }
          
          setAiMessages(prev => [...prev, { 
            role: 'assistant', 
            content: fallbackResponse,
            attachments: matches.slice(0, 4)
          }]);
        }

        setAiLoading(false);
        setTimeout(() => {
          chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          aiInputRef.current?.focus();
        }, 100);
      };

      // Product Modal for FAB
      function ProductModal({ show, product, categories, onClose, onSave }) {
        const [formData, setFormData] = useState({ name: '', code: '', price: '', image: '', category: '', note: '', sort_order: 0 });
        const [saving, setSaving] = useState(false);
        const [uploading, setUploading] = useState(false);
        const imageInputRef = useRef(null);

        // Hàm format tiền VNĐ
        const formatVND = (value) => {
          // Lấy chỉ số từ input
          const numbers = value.replace(/[^\d]/g, '');
          if (!numbers) return '';
          // Format với dấu chấm ngăn cách hàng nghìn
          return numbers.replace(/\B(?=(\d{3})+(?!\d))/g, '.') + 'đ';
        };

        useEffect(() => {
          if (product) {
            setFormData({
              name: product.name || '',
              code: product.code || '',
              price: product.price || '',
              image: product.image || '',
              category: product.category || '',
              note: product.note || '',
              sort_order: product.sort_order || 0
            });
            // Set price numbers từ product.price
            if (product.price) {
              const numbers = product.price.replace(/[^\d]/g, '');
              setPriceNumbers(numbers);
              setFormData(prev => ({...prev, price: formatVND(numbers)}));
            } else {
              setPriceNumbers('');
            }
          } else {
            setFormData({ name: '', code: '', price: '', image: '', category: '', note: '', sort_order: 0 });
            setPriceNumbers('');
          }
        }, [product, show]);

        // State để hiển thị tiến trình
        const [uploadStatus, setUploadStatus] = React.useState('');
        
        // Lưu giá trị số thuần để so sánh
        const [priceNumbers, setPriceNumbers] = React.useState('');
        
        // Xử lý khi nhập giá
        const handlePriceChange = (e) => {
          const value = e.target.value;
          // Lấy chỉ số thuần
          const numbers = value.replace(/[^\d]/g, '');
          
          // Nếu xóa hết thì để trống
          if (!numbers) {
            setFormData({...formData, price: ''});
            setPriceNumbers('');
            return;
          }
          
          // Nếu số không thay đổi (user chỉ xóa đ hoặc dấu chấm) thì xóa 1 số cuối
          if (numbers === priceNumbers && numbers.length > 0) {
            const newNumbers = numbers.slice(0, -1);
            if (!newNumbers) {
              setFormData({...formData, price: ''});
              setPriceNumbers('');
            } else {
              setFormData({...formData, price: formatVND(newNumbers)});
              setPriceNumbers(newNumbers);
            }
            return;
          }
          
          setPriceNumbers(numbers);
          setFormData({...formData, price: formatVND(numbers)});
        };

        const compressImage = async (file, maxSizeMB = 2) => {
          const maxSize = maxSizeMB * 1024 * 1024;
          if (file.size <= maxSize) return file;

          try {
            const bitmap = await createImageBitmap(file);
            const canvas = document.createElement('canvas');
            
            let width = bitmap.width;
            let height = bitmap.height;
            const maxDimension = 1200;
            
            if (width > maxDimension || height > maxDimension) {
              if (width > height) {
                height = Math.round((height / width) * maxDimension);
                width = maxDimension;
              } else {
                width = Math.round((width / height) * maxDimension);
                height = maxDimension;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(bitmap, 0, 0, width, height);
            bitmap.close();
            
            return new Promise((resolve, reject) => {
              canvas.toBlob((blob) => {
                if (blob) {
                  resolve(new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' }));
                } else {
                  reject(new Error('Không nén được ảnh'));
                }
              }, 'image/jpeg', 0.8);
            });
          } catch (err) {
            console.error('Compress error:', err);
            throw new Error('Không thể xử lý ảnh. Thử chọn ảnh khác.');
          }
        };

        const handleImageUpload = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const isImage = file.type.startsWith('image/') || /\.(jpg|jpeg|png|gif|webp)$/i.test(file.name);
          if (!isImage) {
            alert('Vui lòng chọn file ảnh!');
            return;
          }
          
          setUploading(true);
          try {
            const compressedFile = await compressImage(file);
            const fd = new FormData();
            fd.append('file', compressedFile);
            fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            fd.append('folder', 'ktm-products');
            
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
              method: 'POST',
              body: fd
            });
            
            const data = await res.json();
            
            if (!res.ok) {
              console.error('Cloudinary error:', data);
              throw new Error(data.error?.message || 'Upload failed');
            }
            
            setFormData(prev => ({ ...prev, image: data.secure_url }));
          } catch (err) {
            console.error('Upload error:', err);
            alert('Lỗi upload ảnh: ' + err.message);
          }
          setUploading(false);
          e.target.value = '';
        };

        const handleSubmit = async (e) => {
          e.preventDefault();
          setSaving(true);
          await onSave(formData);
          setSaving(false);
        };

        if (!show) return null;

        return (
          <div className="modal show d-block" style={{ background: 'rgba(0,0,0,0.6)' }}>
            <div className="modal-dialog modal-dialog-centered modal-lg">
              <div className="modal-content" style={{ borderRadius: 16, border: 'none', boxShadow: '0 20px 60px rgba(0,0,0,0.3)' }}>
                <div className="modal-header" style={{ background: 'linear-gradient(135deg, #ffc107, #ff9800)', border: 'none', borderRadius: '16px 16px 0 0' }}>
                  <h5 className="modal-title fw-bold text-dark">
                    <i className="fas fa-box me-2"></i>{product ? 'Sửa sản phẩm' : 'Thêm sản phẩm mới'}
                  </h5>
                  <button type="button" className="btn-close" onClick={onClose}></button>
                </div>
                <form onSubmit={handleSubmit}>
                  <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    <div className="row">
                      <div className="col-md-8">
                        <div className="mb-3">
                          <label className="form-label fw-semibold small text-muted mb-1">
                            <i className="fas fa-tag me-1"></i>Tên sản phẩm *
                          </label>
                          <input 
                            type="text" 
                            className="form-control" 
                            value={formData.name} 
                            onChange={(e) => setFormData({...formData, name: e.target.value})} 
                            placeholder="Ví dụ: Xy lanh nghiêng KTM"
                            required
                            style={{borderRadius: '10px', border: '1px solid #dee2e6', padding: '12px'}}
                          />
                        </div>
                        <div className="row">
                          <div className="col-6">
                            <label className="form-label fw-semibold small text-muted mb-1">
                              <i className="fas fa-hashtag me-1"></i>Mã sản phẩm
                            </label>
                            <input 
                              type="text" 
                              className="form-control" 
                              value={formData.code} 
                              onChange={(e) => setFormData({...formData, code: e.target.value})} 
                              placeholder="KTM-01"
                              style={{borderRadius: '10px', border: '1px solid #dee2e6', padding: '12px'}}
                            />
                          </div>
                          <div className="col-6">
                            <label className="form-label fw-semibold small text-muted mb-1">
                              <i className="fas fa-dollar-sign me-1"></i>Giá bán
                            </label>
                            <input 
                              type="text" 
                              className="form-control" 
                              value={formData.price} 
                              onChange={handlePriceChange} 
                              placeholder="1.950.000đ"
                              style={{borderRadius: '10px', border: '1px solid #dee2e6', padding: '12px'}}
                            />
                          </div>
                        </div>
                        <div className="mb-3">
                          <label className="form-label fw-semibold small text-muted mb-1">
                            <i className="fas fa-list me-1"></i>Danh mục
                          </label>
                          <select 
                            className="form-select" 
                            value={formData.category} 
                            onChange={(e) => setFormData({...formData, category: e.target.value})}
                            style={{borderRadius: '10px', border: '1px solid #dee2e6', padding: '12px'}}
                          >
                            <option value="">Chọn danh mục</option>
                            {categories.map(cat => (
                              <option key={cat} value={cat}>{cat}</option>
                            ))}
                          </select>
                        </div>
                        <div className="mb-3">
                          <label className="form-label fw-semibold small text-muted mb-1">
                            <i className="fas fa-sticky-note me-1"></i>Ghi chú
                          </label>
                          <textarea 
                            className="form-control" 
                            rows="2" 
                            value={formData.note} 
                            onChange={(e) => setFormData({...formData, note: e.target.value})} 
                            placeholder="Ví dụ: Thêm dây là 2.150.000đ"
                            style={{borderRadius: '10px', border: '1px solid #dee2e6', padding: '12px'}}
                          />
                        </div>
                      </div>
                      <div className="col-md-4">
                        <label className="form-label fw-semibold small text-muted mb-1">
                          <i className="fas fa-image me-1"></i>Ảnh sản phẩm
                        </label>
                        <div className="mb-2">
                          {formData.image ? (
                            <>
                              <img 
                                src={formData.image} 
                                alt="Product" 
                                style={{width: '100%', height: 150, objectFit: 'cover', borderRadius: '12px', border: '2px solid #e9ecef'}}
                              />
                              <button 
                                type="button"
                                className="btn btn-sm btn-danger mt-2"
                                onClick={() => setFormData({...formData, image: ''})}
                                style={{borderRadius: '20px', fontSize: '0.75rem'}}
                              >
                                <i className="fas fa-times me-1"></i>Xóa ảnh
                              </button>
                            </>
                          ) : (
                            <div 
                              className="d-flex align-items-center justify-content-center" 
                              style={{width: '100%', height: 150, borderRadius: '12px', background: 'linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)', border: '2px dashed #adb5bd', cursor: 'pointer'}}
                              onClick={() => imageInputRef.current?.click()}
                            >
                              <div className="text-center">
                                <i className="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                <div className="small text-muted">Click để upload</div>
                              </div>
                            </div>
                          )}
                        </div>
                        <input
                          ref={imageInputRef}
                          type="file"
                          accept="image/*"
                          className="d-none"
                          onChange={handleImageUpload}
                        />
                        <button 
                          type="button"
                          className="btn btn-outline-secondary w-100"
                          onClick={() => imageInputRef.current?.click()}
                          disabled={uploading}
                          style={{borderRadius: '10px'}}
                        >
                          {uploading ? (
                            <><span className="spinner-border spinner-border-sm me-2"></span>Đang upload...</>
                          ) : (
                            <><i className="fas fa-upload me-2"></i>Upload ảnh</>
                          )}
                        </button>
                        <div className="mt-2">
                          <label className="form-label fw-semibold small text-muted mb-1">
                            <i className="fas fa-link me-1"></i>Hoặc URL ảnh
                          </label>
                          <input 
                            type="url" 
                            className="form-control" 
                            value={formData.image} 
                            onChange={(e) => setFormData({...formData, image: e.target.value})} 
                            placeholder="https://..."
                            style={{borderRadius: '10px', border: '1px solid #dee2e6', padding: '8px', fontSize: '0.875rem'}}
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                  <div className="modal-footer" style={{border: 'none', padding: '20px'}}>
                    <button type="button" className="btn btn-light px-4" onClick={onClose} style={{borderRadius: '10px'}}>
                      Hủy
                    </button>
                    <button type="submit" className="btn btn-warning px-4 fw-semibold" disabled={saving} style={{borderRadius: '10px', boxShadow: '0 4px 12px rgba(255,193,7,0.3)'}}>
                      {saving ? (
                        <><span className="spinner-border spinner-border-sm me-2"></span>Đang lưu...</>
                      ) : (
                        <><i className="fas fa-check me-2"></i>Lưu sản phẩm</>
                      )}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        );
      }

      // ========== MOBILE CARD COMPONENT ==========
      const renderMobileCard = (item, index) => {
        const isProduct = item._type === 'product';
        const isAlbum = item._type === 'album';
        const isVideo = item._type === 'video';
        const hasPromo = item.note && (item.note.toLowerCase().includes('free') || item.note.toLowerCase().includes('giảm') || item.note.toLowerCase().includes('sale'));

        if (viewMode === 'grid') {
          // Grid view - compact cards
          return (
            <div key={item.id || index} className="grid-card">
              <div className="thumb-wrap" onClick={() => setPreviewImage({ url: item.image, name: item.name, price: item.price, note: item.note, item })}>
                {item.image ? (
                  <img src={item.image} alt={item.name} className="thumb" loading="lazy" />
                ) : (
                  <div className="thumb d-flex align-items-center justify-content-center bg-light">
                    <i className={`fas ${isVideo ? 'fa-video' : 'fa-image'} fa-2x text-muted`}></i>
                  </div>
                )}
                {/* Price overlay */}
                {item.price && (
                  <div className="price-overlay">{item.price.replace(/[đ\s]/g, '')}đ</div>
                )}
                {/* Type badge */}
                <span className={`type-badge ${isProduct ? 'product' : isAlbum ? 'album' : 'video'}`}>
                  {isProduct ? 'SP' : isAlbum ? 'Ảnh' : 'Video'}
                </span>
                {/* Promo badge */}
                {hasPromo && <span className="promo-badge">🔥 ƯU ĐÃI</span>}
              </div>
              <div className="card-body">
                <div className="name">{item.name}</div>
                {item.note && <div className="meta text-info" style={{fontSize: 10}}>{item.note}</div>}
                <div className="quick-copy">
                  <button 
                    className={copiedId === item.id + '-img' ? 'copied' : ''}
                    onClick={() => copyImage(item.image, item.id)}
                  >
                    <i className="fas fa-image"></i>
                  </button>
                  {item.price && (
                    <button 
                      className={copiedId === item.id + '-price' ? 'copied' : ''}
                      onClick={() => copyText(item.price.replace(/[đ\s]/g, ''), item.id + '-price')}
                    >
                      <i className="fas fa-tag"></i>
                    </button>
                  )}
                </div>
              </div>
            </div>
          );
        }

        // List view - detailed cards
        return (
          <div key={item.id || index} className="product-card-mobile">
            {/* Type badge */}
            <span className={`type-badge ${isProduct ? 'product' : isAlbum ? 'album' : 'video'}`}>
              {isProduct ? 'Sản phẩm' : isAlbum ? 'Ảnh' : 'Video'}
            </span>
            
            <div className="card-inner">
              {/* Thumbnail */}
              {item.image ? (
                <img 
                  src={item.image} 
                  alt={item.name} 
                  className="thumb"
                  loading="lazy"
                  onClick={() => setPreviewImage({ url: item.image, name: item.name, price: item.price, note: item.note, item })}
                />
              ) : (
                <div className="thumb d-flex align-items-center justify-content-center bg-light">
                  <i className={`fas ${isVideo ? 'fa-video' : 'fa-image'} fa-2x text-muted`}></i>
                </div>
              )}
              
              {/* Info */}
              <div className="info">
                <div>
                  <div className="name">{item.name}</div>
                  <div className="price-row">
                    {item.price && <span className="price">{item.price.replace(/[đ\s]/g, '')}đ</span>}
                    {hasPromo && <span className="badge-promo">🔥 ƯU ĐÃI</span>}
                  </div>
                </div>
                <div className="meta">
                  {item.code && <span className="meta-tag">#{item.code}</span>}
                  {item.category && <span className="meta-tag">{item.category}</span>}
                  {item.note && <span className="meta-tag highlight">{item.note}</span>}
                  {item.folder && <span className="meta-tag">{item.folder}</span>}
                  {isVideo && <span className="meta-tag"><i className="fab fa-youtube text-danger"></i> Video</span>}
                </div>
              </div>
            </div>
            
            {/* Quick Actions */}
            <div className="quick-actions">
              <button 
                className={copiedId === item.id + '-img' ? 'copied' : ''}
                onClick={() => copyImage(item.image, item.id)}
              >
                <i className="fas fa-image"></i> Ảnh
              </button>
              {item.price && (
                <button 
                  className={copiedId === item.id + '-price' ? 'copied' : ''}
                  onClick={() => copyText(item.price.replace(/[đ\s]/g, ''), item.id + '-price')}
                >
                  <i className="fas fa-tag"></i> Giá
                </button>
              )}
              <button 
                className={copiedId === item.id + '-name' ? 'copied' : ''}
                onClick={() => copyText(item.name, item.id + '-name')}
              >
                <i className="fas fa-font"></i> Tên
              </button>
              {isVideo && item.youtubeId && (
                <button 
                  className={copiedId === item.id + '-yt' ? 'copied' : ''}
                  onClick={() => copyText(`https://www.youtube.com/watch?v=${item.youtubeId}`, item.id + '-yt')}
                >
                  <i className="fab fa-youtube"></i>
                </button>
              )}
              {/* Edit button - chỉ cho sản phẩm */}
              {isProduct && (
                <button 
                  className="action-edit"
                  onClick={() => handleQuickEdit(item)}
                >
                  <i className="fas fa-pen"></i>
                </button>
              )}
              {/* Delete button */}
              <button 
                className="action-delete"
                onClick={() => handleQuickDelete(item)}
              >
                <i className="fas fa-trash"></i>
              </button>
            </div>
          </div>
        );
      };

      // State for filter dropdown
      const [showFilter, setShowFilter] = useState(false);

      return (
        <>
          {/* ========== RESULT HEADER ========== */}
          <div className="result-header">
            <span>
              <strong>{searchResults.length}</strong> kết quả
              {aiSearchEnabled && searchQuery.length >= 3 && (
                <span className="ai-badge ms-2">
                  <i className="fas fa-robot"></i> AI
                </span>
              )}
              {selectedCategory !== 'all' && (
                <span className="ms-2 badge bg-warning text-dark">
                  {selectedCategory === 'product' ? 'Sản phẩm' : selectedCategory === 'album' ? 'Ảnh' : 'Video'}
                </span>
              )}
            </span>
            <div className="d-flex gap-1 align-items-center">
              {/* View mode */}
              <button 
                className={`btn btn-sm ${viewMode === 'list' ? 'btn-dark' : 'btn-outline-secondary'}`}
                onClick={() => setViewMode('list')}
                style={{padding: '4px 8px'}}
              >
                <i className="fas fa-list"></i>
              </button>
              <button 
                className={`btn btn-sm ${viewMode === 'grid' ? 'btn-dark' : 'btn-outline-secondary'}`}
                onClick={() => setViewMode('grid')}
                style={{padding: '4px 8px'}}
              >
                <i className="fas fa-th"></i>
              </button>
            </div>
          </div>

          {/* ========== RESULTS ========== */}
          <div className="search-results-area">
            {loading ? (
              <div>
                {/* Skeleton list */}
                {[...Array(8)].map((_, i) => (
                  <div key={i} className="product-card-mobile mb-2" style={{opacity:0.7}}>
                    <div className="card-inner">
                      <div className="thumb bg-light" style={{width:80,height:80,borderRadius:8}}></div>
                      <div className="info" style={{flex:1,minWidth:0}}>
                        <div className="skeleton-box mb-2" style={{height:16,width:'60%',background:'#eee',borderRadius:4}}></div>
                        <div className="skeleton-box mb-1" style={{height:12,width:'40%',background:'#f3f3f3',borderRadius:4}}></div>
                        <div className="skeleton-box" style={{height:10,width:'30%',background:'#f3f3f3',borderRadius:4}}></div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : searchResults.length === 0 ? (
              <div className="empty-state">
                <i className="fas fa-search"></i>
                <p>Không tìm thấy "{searchQuery}"</p>
                <button className="btn btn-warning" onClick={() => { setSearchQuery(''); handleSearch(''); }}>
                  Xem tất cả
                </button>
              </div>
            ) : viewMode === 'grid' ? (
              <div className="product-grid-mobile">
                {searchResults.map((item, index) => renderMobileCard(item, index))}
              </div>
            ) : (
              <div>
                {searchResults.map((item, index) => renderMobileCard(item, index))}
              </div>
            )}
          </div>

          {/* ========== FILTER DROPDOWN ========== */}
          {showFilter && (
            <div className="filter-dropdown">
              <div className="filter-header">
                <strong>Lọc theo loại</strong>
                <button 
                  className="btn btn-sm btn-outline-secondary"
                  onClick={() => setShowFilter(false)}
                >
                  <i className="fas fa-times"></i>
                </button>
              </div>
              <div className="filter-chips">
                <span 
                  className={`filter-chip ${selectedCategory === 'all' ? 'active' : ''}`}
                  onClick={() => { filterByCategory('all'); setShowFilter(false); }}
                >
                  Tất cả
                </span>
                <span 
                  className={`filter-chip ${selectedCategory === 'product' ? 'active' : ''}`}
                  onClick={() => { filterByCategory('product'); setShowFilter(false); }}
                >
                  <i className="fas fa-box me-1"></i>Sản phẩm
                </span>
                <span 
                  className={`filter-chip ${selectedCategory === 'album' ? 'active' : ''}`}
                  onClick={() => { filterByCategory('album'); setShowFilter(false); }}
                >
                  <i className="fas fa-images me-1"></i>Ảnh
                </span>
                <span 
                  className={`filter-chip ${selectedCategory === 'video' ? 'active' : ''}`}
                  onClick={() => { filterByCategory('video'); setShowFilter(false); }}
                >
                  <i className="fas fa-video me-1"></i>Video
                </span>
              </div>
              {/* AI Toggle */}
              <div className="mt-3 pt-3 border-top d-flex align-items-center justify-content-between">
                <span>AI Search thông minh</span>
                <div className="form-check form-switch m-0">
                  <input 
                    type="checkbox" 
                    className="form-check-input"
                    checked={aiSearchEnabled} 
                    onChange={(e) => setAiSearchEnabled(e.target.checked)}
                    style={{width: 40, height: 20}}
                  />
                </div>
              </div>
            </div>
          )}

          {/* ========== SEARCH BAR BOTTOM ========== */}
          <div className="search-bar-bottom">
            <div className="search-input-wrap">
              <input
                ref={searchInputRef}
                type="text"
                className="search-input"
                placeholder="🔍 Tìm: van 3 tay, xylanh..."
                value={searchQuery}
                onChange={(e) => handleSearch(e.target.value)}
              />
              <button 
                className={`filter-btn ${showFilter || selectedCategory !== 'all' ? 'active' : ''}`}
                onClick={() => setShowFilter(!showFilter)}
              >
                <i className="fas fa-filter"></i>
              </button>
            </div>
          </div>

          {/* ========== AI CHAT BUTTON ========== */}
          <button
            className="btn btn-lg rounded-circle position-fixed shadow-lg"
            style={{ 
              bottom: 130, 
              right: 16, 
              width: 56, 
              height: 56, 
              zIndex: 1050,
              background: 'linear-gradient(135deg, #667eea, #764ba2)',
              color: '#fff',
              border: 'none',
              WebkitTapHighlightColor: 'transparent',
              touchAction: 'manipulation',
              cursor: 'pointer',
              outline: 'none'
            }}
            onClick={() => setShowAIChat(true)}
            onTouchStart={() => setShowAIChat(true)}
          >
            <i className="fas fa-robot fa-lg"></i>
          </button>

          {/* ========== AI CHAT FULLSCREEN (MOBILE) ========== */}
          {showAIChat && (
            <div className="ai-chat-mobile">
              <div className="chat-header">
                <button className="back-btn" onClick={() => setShowAIChat(false)}>
                  <i className="fas fa-arrow-left"></i>
                </button>
                <div>
                  <strong>KTM AI Assistant</strong>
                  <div style={{fontSize: 11, opacity: 0.8}}>Hỏi về sản phẩm, giá cả...</div>
                </div>
              </div>
              
              <div className="chat-messages">
                {aiMessages.map((msg, i) => (
                  <div key={i} className={`mb-3 ${msg.role === 'user' ? 'd-flex justify-content-end' : ''}`}>
                    <div 
                      className={`p-3 rounded-3 position-relative ${msg.role === 'user' ? 'text-white' : 'bg-white border'}`}
                      style={{ 
                        maxWidth: '85%', 
                        whiteSpace: 'pre-wrap',
                        background: msg.role === 'user' ? 'linear-gradient(135deg, #667eea, #764ba2)' : undefined
                      }}
                    >
                      {msg.content}
                      
                      {/* Copy button for bot messages */}
                      {msg.role === 'assistant' && (
                        <button
                          className="btn btn-sm position-absolute"
                          style={{
                            top: 4,
                            right: 4,
                            padding: '2px 6px',
                            fontSize: 11,
                            background: copiedId === `chat-${i}` ? '#28a745' : 'rgba(0,0,0,0.1)',
                            border: 'none',
                            borderRadius: 4,
                            color: copiedId === `chat-${i}` ? '#fff' : '#666'
                          }}
                          onClick={() => {
                            navigator.clipboard.writeText(msg.content);
                            setCopiedId(`chat-${i}`);
                            setTimeout(() => setCopiedId(null), 1500);
                          }}
                        >
                          <i className={`fas ${copiedId === `chat-${i}` ? 'fa-check' : 'fa-copy'}`}></i>
                        </button>
                      )}
                      
                      {/* Attachments */}
                      {msg.attachments && msg.attachments.length > 0 && (
                        <div className="mt-2 d-flex flex-wrap gap-2">
                          {msg.attachments.map((att, idx) => (
                            <div key={idx} style={{width: 70}} className="text-center">
                              {att.image && (
                                <img 
                                  src={att.image} 
                                  className="rounded"
                                  style={{width: 70, height: 50, objectFit: 'cover', cursor: 'pointer'}}
                                  onClick={() => setPreviewImage({ url: att.image, name: att.name, price: att.price })}
                                />
                              )}
                              <div style={{fontSize: 9}} className="text-truncate">{att.name}</div>
                              {att.price && <div style={{fontSize: 10, color: '#dc3545', fontWeight: 600}}>{att.price.replace(/[đ\s]/g, '')}đ</div>}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
                {aiLoading && (
                  <div className="mb-3">
                    <div className="bg-white border p-3 rounded-3 d-inline-block">
                      <span className="spinner-border spinner-border-sm me-2"></span>
                      Đang suy nghĩ...
                    </div>
                  </div>
                )}
                <div ref={chatEndRef}></div>
              </div>
              
              {/* Quick suggestions */}
              <div className="px-3 py-2 border-top d-flex gap-2 overflow-auto">
                {['Giá van 2 tay?', 'Combo rẻ nhất?', 'Freeship?', 'Van 3 tay?'].map(q => (
                  <button
                    key={q}
                    className="btn btn-sm btn-outline-secondary flex-shrink-0"
                    onClick={() => handleAIChat(q)}
                    disabled={aiLoading}
                    style={{whiteSpace: 'nowrap'}}
                  >
                    {q}
                  </button>
                ))}
              </div>
              
              <div className="chat-input-area">
                <form onSubmit={(e) => { e.preventDefault(); handleAIChat(aiInput); }} className="chat-input-wrap">
                  <input
                    ref={aiInputRef}
                    type="text"
                    className="chat-input"
                    placeholder="Nhập câu hỏi..."
                    value={aiInput}
                    onChange={(e) => setAiInput(e.target.value)}
                    disabled={aiLoading}
                  />
                  <button type="submit" className="send-btn" disabled={aiLoading || !aiInput.trim()}>
                    <i className="fas fa-paper-plane"></i>
                  </button>
                </form>
              </div>
            </div>
          )}

          {/* ========== IMAGE PREVIEW MODAL ========== */}
          {previewImage && (
            <div className="preview-modal" onClick={() => setPreviewImage(null)}>
              <div className="preview-header">
                <div></div>
                <button className="close-btn" onClick={() => setPreviewImage(null)}>
                  <i className="fas fa-times"></i>
                </button>
              </div>
              
              <div className="preview-body" onClick={(e) => e.stopPropagation()}>
                <img src={previewImage.url} alt={previewImage.name} />
              </div>
              
              <div className="preview-footer" onClick={(e) => e.stopPropagation()}>
                <div className="name">{previewImage.name}</div>
                {previewImage.price && <div className="price">{previewImage.price.replace(/[đ\s]/g, '')}đ</div>}
                {previewImage.note && <div className="mb-2" style={{fontSize: 14, color: '#17a2b8'}}>{previewImage.note}</div>}
                
                <div className="action-btns">
                  <button 
                    className={copiedId === 'preview-img' ? 'btn-success text-white' : 'btn-outline-light text-white'}
                    style={{background: copiedId === 'preview-img' ? '#28a745' : 'rgba(255,255,255,0.2)'}}
                    onClick={() => copyImage(previewImage.url, 'preview')}
                  >
                    <i className={`fas ${copiedId === 'preview-img' ? 'fa-check' : 'fa-copy'}`}></i>
                    Copy ảnh
                  </button>
                  {previewImage.price && (
                    <button 
                      className={copiedId === 'preview-price' ? 'btn-success text-white' : 'btn-warning'}
                      onClick={() => copyText(previewImage.price.replace(/[đ\s]/g, ''), 'preview-price')}
                    >
                      <i className={`fas ${copiedId === 'preview-price' ? 'fa-check' : 'fa-tag'}`}></i>
                      Copy giá
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Product Modal for FAB */}
          <ProductModal
            show={showProductModal}
            product={editingProduct}
            categories={categories}
            onClose={() => { setShowProductModal(false); setEditingProduct(null); }}
            onSave={handleSaveProduct}
          />

      {/* ========== FAB - FLOATING ACTION BUTTON ========== */}
          <div className={`fab-container mobile-only ${fabOpen ? 'open' : ''}`}>
            <div className="fab-actions">
              <button 
                className="fab-action product"
                onClick={() => { setFabOpen(false); setShowProductModal(true); setEditingProduct(null); }}
              >
                <i className="fas fa-box"></i>
                <span className="tooltip">Thêm sản phẩm</span>
              </button>
              <button 
                className="fab-action album"
                onClick={() => { setFabOpen(false); onNavigate && onNavigate('albums', 'create'); }}
              >
                <i className="fas fa-images"></i>
                <span className="tooltip">Thêm ảnh/album</span>
              </button>
              <button 
                className="fab-action video"
                onClick={() => { setFabOpen(false); onNavigate && onNavigate('videos', 'create'); }}
              >
                <i className="fas fa-video"></i>
                <span className="tooltip">Thêm video</span>
              </button>
            </div>
            <button 
              className={`fab-main ${fabOpen ? 'open' : ''}`}
              onClick={() => setFabOpen(!fabOpen)}
            >
              <i className="fas fa-plus"></i>
            </button>
          </div>

          {/* ========== QUICK EDIT MODAL ========== */}
          {showQuickEdit && editingItem && (
            <div className="modal show d-block" style={{background: 'rgba(0,0,0,0.6)'}}>
              <div className="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div className="modal-content" style={{borderRadius: 16, maxHeight: '90vh'}}>
                  <div className="modal-header" style={{background: 'linear-gradient(135deg, #ffc107, #ff9800)', border: 'none'}}>
                    <h6 className="modal-title fw-bold">
                      <i className="fas fa-pen me-2"></i>Sửa nhanh
                    </h6>
                    <button type="button" className="btn-close" onClick={() => setShowQuickEdit(false)}></button>
                  </div>
                  <div className="modal-body">
                    <div className="mb-3">
                      <label className="form-label small fw-semibold">Tên sản phẩm</label>
                      <input
                        type="text"
                        className="form-control"
                        value={productForm.name}
                        onChange={(e) => setProductForm({...productForm, name: e.target.value})}
                      />
                    </div>
                    <div className="row g-2 mb-3">
                      <div className="col-6">
                        <label className="form-label small fw-semibold">Mã SP</label>
                        <input
                          type="text"
                          className="form-control"
                          value={productForm.code}
                          onChange={(e) => setProductForm({...productForm, code: e.target.value})}
                        />
                      </div>
                      <div className="col-6">
                        <label className="form-label small fw-semibold">Giá</label>
                        <input
                          type="text"
                          className="form-control"
                          value={productForm.price}
                          onChange={(e) => setProductForm({...productForm, price: e.target.value})}
                        />
                      </div>
                    </div>
                    <div className="mb-3">
                      <label className="form-label small fw-semibold">Danh mục</label>
                      <select
                        className="form-select"
                        value={productForm.category}
                        onChange={(e) => setProductForm({...productForm, category: e.target.value})}
                      >
                        <option value="">-- Chọn danh mục --</option>
                        {productCategories.map(c => <option key={c} value={c}>{c}</option>)}
                      </select>
                    </div>
                    <div className="mb-3">
                      <label className="form-label small fw-semibold">Ghi chú (ưu đãi)</label>
                      <input
                        type="text"
                        className="form-control"
                        value={productForm.note}
                        placeholder="VD: Free ship, Giảm 10%..."
                        onChange={(e) => setProductForm({...productForm, note: e.target.value})}
                      />
                    </div>
                  </div>
                  <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={() => setShowQuickEdit(false)}>
                      Hủy
                    </button>
                    <button type="button" className="btn btn-warning" onClick={handleSaveQuickEdit}>
                      <i className="fas fa-save me-1"></i>Lưu
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </>
      );
    }

    // ==================== VIDEO MANAGEMENT ====================
    
    // Video List View - với nút sắp xếp mobile-friendly
    function VideoList({ onRefresh, showToast }) {
      const [folders, setFolders] = useState([]);
      const [videos, setVideos] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedFolder, setSelectedFolder] = useState(null);
      const [showFolderModal, setShowFolderModal] = useState(false);
      const [editingFolder, setEditingFolder] = useState(null);
      const [showVideoModal, setShowVideoModal] = useState(false);
      const [editingVideo, setEditingVideo] = useState(null);
      
      // Nested folder navigation
      const [currentParentFolder, setCurrentParentFolder] = useState(null);
      const [folderBreadcrumb, setFolderBreadcrumb] = useState([]);

      useEffect(() => {
        loadFolders();
      }, []);

      const loadFolders = async (parentId = null) => {
        setLoading(true);
        try {
          const url = parentId
            ? `${API_BASE}/api/video-folders?withVideos=true&parent_id=${parentId}`
            : `${API_BASE}/api/video-folders?withVideos=true&parent_id=root`;
          const res = await fetch(url);
          const data = await res.json();
          setFolders(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error(err);
          showToast('Lỗi tải danh sách folder', 'danger');
        }
        setLoading(false);
      };

      const loadVideosInFolder = async (folderId) => {
        try {
          const res = await fetch(`${API_BASE}/api/videos?folderId=${folderId}`);
          const data = await res.json();
          setVideos(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error(err);
        }
      };

      // Move folder up/down (mobile-friendly reordering)
      const moveFolderUp = async (index) => {
        if (index === 0) return;
        const newFolders = [...folders];
        [newFolders[index - 1], newFolders[index]] = [newFolders[index], newFolders[index - 1]];
        setFolders(newFolders);
        await saveFolderOrder(newFolders);
      };

      const moveFolderDown = async (index) => {
        if (index === folders.length - 1) return;
        const newFolders = [...folders];
        [newFolders[index], newFolders[index + 1]] = [newFolders[index + 1], newFolders[index]];
        setFolders(newFolders);
        await saveFolderOrder(newFolders);
      };

      const saveFolderOrder = async (orderedFolders) => {
        try {
          await Promise.all(orderedFolders.map((folder, idx) => 
            fetch(`${API_BASE}/api/video-folders/${folder.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sortOrder: idx })
            })
          ));
          showToast('Đã cập nhật thứ tự!', 'success');
        } catch (err) {
          showToast('Lỗi cập nhật thứ tự', 'danger');
          loadFolders(currentParentFolder?.id);
        }
      };

      // Move video up/down (mobile-friendly reordering)
      const moveVideoUp = async (index) => {
        if (index === 0) return;
        const newVideos = [...videos];
        [newVideos[index - 1], newVideos[index]] = [newVideos[index], newVideos[index - 1]];
        setVideos(newVideos);
        await saveVideoOrder(newVideos);
      };

      const moveVideoDown = async (index) => {
        if (index === videos.length - 1) return;
        const newVideos = [...videos];
        [newVideos[index], newVideos[index + 1]] = [newVideos[index + 1], newVideos[index]];
        setVideos(newVideos);
        await saveVideoOrder(newVideos);
      };

      const saveVideoOrder = async (orderedVideos) => {
        try {
          await Promise.all(orderedVideos.map((video, idx) => 
            fetch(`${API_BASE}/api/videos/${video.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sort_order: idx })
            })
          ));
          showToast('Đã cập nhật thứ tự!', 'success');
        } catch (err) {
          showToast('Lỗi cập nhật thứ tự', 'danger');
          loadVideosInFolder(selectedFolder.id);
        }
      };

      // Folder handlers
      const handleCreateFolder = () => {
        setEditingFolder(null);
        setShowFolderModal(true);
      };

      const handleEditFolder = (folder) => {
        setEditingFolder(folder);
        setShowFolderModal(true);
      };

      const handleSaveFolder = async (formData) => {
        try {
          // Add parent_id if we're in a subfolder
          if (!editingFolder && currentParentFolder) {
            formData.parent_id = currentParentFolder.id;
          }
          
          const url = editingFolder 
            ? `${API_BASE}/api/video-folders/${editingFolder.id}`
            : `${API_BASE}/api/video-folders`;
          
          const res = await fetch(url, {
            method: editingFolder ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });

          if (!res.ok) throw new Error('Lỗi lưu folder');

          showToast(editingFolder ? 'Đã cập nhật folder!' : 'Đã tạo folder mới!', 'success');
          setShowFolderModal(false);
          loadFolders(currentParentFolder?.id);
        } catch (err) {
          showToast(err.message, 'danger');
        }
      };

      const handleDeleteFolder = async (folder) => {
        const msg = folder.subfolderCount > 0
          ? `Xóa folder "${folder.name}"? Tất cả subfolder và videos bên trong sẽ bị xóa!`
          : `Xóa folder "${folder.name}"? Videos trong folder sẽ không bị xóa.`;
        if (!confirm(msg)) return;

        try {
          await fetch(`${API_BASE}/api/video-folders/${folder.id}`, { method: 'DELETE' });
          showToast('Đã xóa folder', 'success');
          setSelectedFolder(null);
          loadFolders(currentParentFolder?.id);
        } catch (err) {
          showToast('Lỗi xóa folder', 'danger');
        }
      };

      const handleSelectFolder = (folder) => {
        // If folder has subfolders, navigate into it
        if (folder.subfolderCount > 0) {
          setFolderBreadcrumb(prev => [...prev, folder]);
          setCurrentParentFolder(folder);
          loadFolders(folder.id);
        } else {
          // Show videos in folder
          setSelectedFolder(folder);
          setVideos(folder.videos || []);
        }
      };

      const handleFolderBack = (target) => {
        if (target === 'root') {
          setFolderBreadcrumb([]);
          setCurrentParentFolder(null);
          loadFolders(null);
        } else if (target) {
          const idx = folderBreadcrumb.findIndex(b => b.id === target.id);
          if (idx >= 0) {
            setFolderBreadcrumb(folderBreadcrumb.slice(0, idx + 1));
            setCurrentParentFolder(target);
            loadFolders(target.id);
          }
        } else {
          const newBreadcrumb = [...folderBreadcrumb];
          newBreadcrumb.pop();
          const parentFolder = newBreadcrumb[newBreadcrumb.length - 1] || null;
          setFolderBreadcrumb(newBreadcrumb);
          setCurrentParentFolder(parentFolder);
          loadFolders(parentFolder?.id);
        }
      };

      // Video handlers
      const handleCreateVideo = () => {
        setEditingVideo(null);
        setShowVideoModal(true);
      };

      const handleEditVideo = (video) => {
        setEditingVideo(video);
        setShowVideoModal(true);
      };

      const handleSaveVideo = async (formData) => {
        try {
          // Add folder_id
          formData.folder_id = selectedFolder?.id;
          
          const url = editingVideo 
            ? `${API_BASE}/api/videos/${editingVideo.id}`
            : `${API_BASE}/api/videos`;
          
          const res = await fetch(url, {
            method: editingVideo ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Lỗi lưu video');
          }

          showToast(editingVideo ? 'Cập nhật thành công!' : 'Thêm video thành công!', 'success');
          setShowVideoModal(false);
          loadFolders();
          if (selectedFolder) {
            loadVideosInFolder(selectedFolder.id);
          }
        } catch (err) {
          showToast(err.message, 'danger');
        }
      };

      const handleDeleteVideo = async (video) => {
        if (!confirm(`Xóa video "${video.title}"?`)) return;

        try {
          await fetch(`${API_BASE}/api/videos/${video.id}`, { method: 'DELETE' });
          showToast('Đã xóa video', 'success');
          loadFolders();
          if (selectedFolder) {
            loadVideosInFolder(selectedFolder.id);
          }
        } catch (err) {
          showToast('Lỗi xóa video', 'danger');
        }
      };

      const copyLink = (video) => {
        const url = `https://www.youtube.com/watch?v=${video.youtubeId}`;
        navigator.clipboard.writeText(url).then(() => {
          showToast('Đã copy link!', 'success');
        }).catch(() => {
          showToast('Không thể copy link', 'danger');
        });
      };

      // Folder List View
      if (!selectedFolder) {
        return (
          <div>
            <div className="d-flex justify-content-between align-items-center mb-3">
              <div className="d-flex align-items-center">
                {currentParentFolder && (
                  <button className="btn btn-outline-secondary me-3" onClick={() => handleFolderBack()}>
                    <i className="fas fa-arrow-left"></i>
                  </button>
                )}
                <h4 className="m-0">
                  <i className="fas fa-video me-2 text-warning"></i>
                  {currentParentFolder ? currentParentFolder.name : 'Quản lý Video'}
                </h4>
              </div>
              <button className="btn btn-warning" onClick={handleCreateFolder}>
                <i className="fas fa-folder-plus me-2"></i>Tạo Folder
              </button>
            </div>

            {/* Breadcrumb */}
            {folderBreadcrumb.length > 0 && (
              <nav aria-label="breadcrumb" className="mb-3">
                <ol className="breadcrumb mb-0">
                  <li className="breadcrumb-item">
                    <a href="#" onClick={(e) => { e.preventDefault(); handleFolderBack('root'); }} className="text-warning">
                      <i className="fas fa-home"></i>
                    </a>
                  </li>
                  {folderBreadcrumb.map((item, idx) => (
                    <li key={item.id} className={`breadcrumb-item ${idx === folderBreadcrumb.length - 1 ? 'active' : ''}`}>
                      {idx === folderBreadcrumb.length - 1 ? (
                        item.name
                      ) : (
                        <a href="#" onClick={(e) => { e.preventDefault(); handleFolderBack(item); }} className="text-warning">
                          {item.name}
                        </a>
                      )}
                    </li>
                  ))}
                </ol>
              </nav>
            )}

            <p className="text-muted small mb-3">
              <i className="fas fa-info-circle me-1"></i>
              Dùng nút ↑↓ để sắp xếp thứ tự. Click vào folder để vào bên trong.
            </p>

            {loading ? (
              <div className="text-center py-5">
                <div className="spinner-border text-warning"></div>
              </div>
            ) : folders.length === 0 ? (
              <div className="text-center py-5">
                <i className="fas fa-folder-open fa-3x text-muted mb-3"></i>
                <p className="text-muted">{currentParentFolder ? 'Folder này đang trống' : 'Chưa có folder video nào'}</p>
                <button className="btn btn-warning" onClick={handleCreateFolder}>
                  <i className="fas fa-plus me-2"></i>Tạo folder{currentParentFolder ? ' con' : ' đầu tiên'}
                </button>
              </div>
            ) : (
              <div className="row g-3">
                {folders.map((folder, index) => (
                  <div key={folder.id} className="col-6 col-md-4 col-lg-3">
                    <div className="card h-100 folder-card">
                      <div className="card-header bg-transparent py-1 d-flex justify-content-center gap-1">
                        <button 
                          className="btn btn-sm btn-outline-secondary px-2 py-0" 
                          onClick={(e) => { e.stopPropagation(); moveFolderUp(index); }}
                          disabled={index === 0}
                          title="Di chuyển lên"
                        >
                          <i className="fas fa-chevron-up"></i>
                        </button>
                        <span className="text-muted small px-1">{index + 1}</span>
                        <button 
                          className="btn btn-sm btn-outline-secondary px-2 py-0" 
                          onClick={(e) => { e.stopPropagation(); moveFolderDown(index); }}
                          disabled={index === folders.length - 1}
                          title="Di chuyển xuống"
                        >
                          <i className="fas fa-chevron-down"></i>
                        </button>
                      </div>
                      <div 
                        className="card-body text-center py-3"
                        onClick={() => handleSelectFolder(folder)}
                        style={{ cursor: 'pointer' }}
                      >
                        <i className={`fas fa-folder fa-3x mb-3 ${folder.slug === 'shorts' ? 'text-danger' : 'text-warning'}`}></i>
                        <h5 className="card-title">{folder.name}</h5>
                        <p className="text-muted mb-0">
                          {folder.subfolderCount > 0 && (
                            <span><i className="fas fa-folder me-1"></i>{folder.subfolderCount} folder</span>
                          )}
                          {folder.subfolderCount > 0 && (folder.videoCount > 0 || folder.videos?.length > 0) && ' • '}
                          {(folder.videoCount > 0 || folder.videos?.length > 0) && (
                            <span><i className="fas fa-video me-1"></i>{folder.videoCount || folder.videos?.length || 0} videos</span>
                          )}
                          {folder.subfolderCount === 0 && !folder.videoCount && !folder.videos?.length && 'Trống'}
                        </p>
                      </div>
                      <div className="card-footer bg-transparent border-0">
                        <div className="btn-group btn-group-sm w-100">
                          <button className="btn btn-outline-secondary" onClick={(e) => { e.stopPropagation(); handleEditFolder(folder); }}>
                            <i className="fas fa-edit"></i> Sửa
                          </button>
                          <button className="btn btn-outline-danger" onClick={(e) => { e.stopPropagation(); handleDeleteFolder(folder); }}>
                            <i className="fas fa-trash"></i> Xóa
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            <VideoFolderModal
              show={showFolderModal}
              folder={editingFolder}
              onClose={() => setShowFolderModal(false)}
              onSave={handleSaveFolder}
            />
          </div>
        );
      }

      // Video List in Folder
      return (
        <div>
          <div className="d-flex justify-content-between align-items-center mb-4">
            <div className="d-flex align-items-center">
              <button className="btn btn-outline-secondary me-3" onClick={() => setSelectedFolder(null)}>
                <i className="fas fa-arrow-left"></i>
              </button>
              <h4 className="m-0">
                <i className={`fas fa-folder-open me-2 ${selectedFolder.slug === 'shorts' ? 'text-danger' : 'text-warning'}`}></i>
                {selectedFolder.name}
              </h4>
            </div>
            <button className="btn btn-warning" onClick={handleCreateVideo}>
              <i className="fas fa-plus me-2"></i>Thêm Video
            </button>
          </div>

          <p className="text-muted small mb-3">
            <i className="fas fa-info-circle me-1"></i>
            Dùng nút ↑↓ để sắp xếp thứ tự videos
          </p>

          {videos.length === 0 ? (
            <div className="text-center py-5">
              <i className="fas fa-video fa-3x text-muted mb-3"></i>
              <p className="text-muted">Chưa có video trong folder này</p>
            </div>
          ) : (
            <div className="row g-4">
              {videos.map((video, index) => (
                <div key={video.id} className="col-6 col-md-4 col-lg-3">
                  <div className="card h-100">
                    <div className="card-header bg-transparent py-1 d-flex justify-content-center gap-1">
                      <button 
                        className="btn btn-sm btn-outline-secondary px-2 py-0" 
                        onClick={() => moveVideoUp(index)}
                        disabled={index === 0}
                        title="Di chuyển lên"
                      >
                        <i className="fas fa-chevron-up"></i>
                      </button>
                      <span className="text-muted small px-1">{index + 1}</span>
                      <button 
                        className="btn btn-sm btn-outline-secondary px-2 py-0" 
                        onClick={() => moveVideoDown(index)}
                        disabled={index === videos.length - 1}
                        title="Di chuyển xuống"
                      >
                        <i className="fas fa-chevron-down"></i>
                      </button>
                    </div>
                    <div className="position-relative">
                      <img 
                        src={video.thumb} 
                        className="card-img-top" 
                        alt={video.title}
                        style={{ height: '120px', objectFit: 'cover' }}
                      />
                      <a 
                        href={`https://www.youtube.com/watch?v=${video.youtubeId}`}
                        target="_blank"
                        className="position-absolute top-50 start-50 translate-middle"
                      >
                        <i className="fas fa-play-circle fa-3x text-white" style={{ textShadow: '0 2px 10px rgba(0,0,0,0.5)' }}></i>
                      </a>
                    </div>
                    <div className="card-body py-2">
                      <h6 className="card-title small mb-1 text-truncate" title={video.title}>{video.title}</h6>
                      <small className="text-muted">{video.youtubeId}</small>
                    </div>
                    <div className="card-footer bg-transparent border-0 pt-0">
                      <div className="btn-group btn-group-sm w-100">
                        <button className="btn btn-outline-primary" onClick={() => copyLink(video)} title="Copy link">
                          <i className="fas fa-link"></i>
                        </button>
                        <button className="btn btn-outline-secondary" onClick={() => handleEditVideo(video)} title="Sửa">
                          <i className="fas fa-edit"></i>
                        </button>
                        <button className="btn btn-outline-danger" onClick={() => handleDeleteVideo(video)} title="Xóa">
                          <i className="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}

          <VideoModal
            show={showVideoModal}
            video={editingVideo}
            onClose={() => setShowVideoModal(false)}
            onSave={handleSaveVideo}
          />
        </div>
      );
    }

    // Video Folder Modal
    function VideoFolderModal({ show, folder, onClose, onSave }) {
      const [formData, setFormData] = useState({ name: '', description: '', sortOrder: 0, coverImage: '' });
      const [saving, setSaving] = useState(false);
      const [uploading, setUploading] = useState(false);

      useEffect(() => {
        if (folder) {
          setFormData({
            name: folder.name || '',
            description: folder.description || '',
            sortOrder: folder.sortOrder || 0,
            coverImage: folder.coverImage || ''
          });
        } else {
          setFormData({ name: '', description: '', sortOrder: 0, coverImage: '' });
        }
      }, [folder, show]);

      const handleImageUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setUploading(true);
        const form = new FormData();
        form.append('file', file);
        form.append('upload_preset', 'ktm_unsigned');

        try {
          const res = await fetch('https://api.cloudinary.com/v1_1/diwxfpt92/image/upload', {
            method: 'POST',
            body: form
          });
          const data = await res.json();
          if (data.secure_url) {
            setFormData(prev => ({ ...prev, coverImage: data.secure_url }));
          }
          // Xóa cache khi cập nhật
          localStorage.removeItem(CACHE_KEY);
          showToast('Cập nhật thành công!', 'success');
          setShowQuickEdit(false);
          setEditingItem(null);
          // Reload data
          loadAllData();
        } catch (err) {
          console.error('Cloudinary upload error:', err);
          alert('Lỗi upload ảnh: ' + (err.message || err));
        } finally {
          setUploading(false);
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setSaving(true);
        await onSave(formData);
        setSaving(false);
      };

      if (!show) return null;

      return (
        <div className="modal show d-block" style={{ background: 'rgba(0,0,0,0.5)' }}>
          <div className="modal-dialog modal-dialog-centered">
            <div className="modal-content">
              <div className="modal-header">
                <h5 className="modal-title">{folder ? 'Sửa Folder' : 'Tạo Folder mới'}</h5>
                <button type="button" className="btn-close" onClick={onClose}></button>
              </div>
              <form onSubmit={handleSubmit}>
                <div className="modal-body">
                  <div className="mb-3">
                    <label className="form-label">Tên folder *</label>
                    <input
                      type="text"
                      className="form-control"
                      value={formData.name}
                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                      required
                    />
                  </div>
                  <div className="mb-3">
                    <label className="form-label">Mô tả</label>
                    <textarea
                      className="form-control"
                      value={formData.description}
                      onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                      rows="2"
                    ></textarea>
                  </div>
                  <div className="mb-3">
                    <label className="form-label">Thứ tự</label>
                    <input
                      type="number"
                      className="form-control"
                      value={formData.sortOrder}
                      onChange={(e) => setFormData({ ...formData, sortOrder: parseInt(e.target.value) || 0 })}
                    />
                  </div>
                  <div className="mb-3">
                    <label className="form-label">Ảnh bìa</label>
                    <div className="d-flex align-items-start gap-3">
                      {formData.coverImage ? (
                        <div className="position-relative">
                          <img 
                            src={formData.coverImage} 
                            alt="Cover" 
                            className="rounded"
                            style={{ width: 120, height: 80, objectFit: 'cover' }}
                          />
                          <button 
                            type="button"
                            className="btn btn-sm btn-danger position-absolute top-0 end-0"
                            onClick={() => setFormData({ ...formData, coverImage: '' })}
                            style={{ transform: 'translate(30%, -30%)' }}
                          >
                            <i className="fas fa-times"></i>
                          </button>
                        </div>
                      ) : (
                        <div 
                          className="bg-light rounded d-flex align-items-center justify-content-center text-muted"
                          style={{ width: 120, height: 80 }}
                        >
                          <i className="fas fa-image fa-2x"></i>
                        </div>
                      )}
                      <div className="flex-grow-1">
                        <input
                          type="file"
                          className="form-control form-control-sm"
                          accept="image/*,image/jpeg,image/png,image/gif,image/webp"
                          onChange={handleImageUpload}
                          disabled={uploading}
                        />
                        {uploading && (
                          <div className="mt-1 text-muted small">
                            <span className="spinner-border spinner-border-sm me-1"></span>
                            Đang upload...
                          </div>
                        )}
                        <div className="mt-1 text-muted small">Hoặc dán URL:</div>
                        <input
                          type="url"
                          className="form-control form-control-sm"
                          placeholder="https://..."
                          value={formData.coverImage}
                          onChange={(e) => setFormData({ ...formData, coverImage: e.target.value })}
                        />
                      </div>
                    </div>
                  </div>
                </div>
                <div className="modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={onClose}>Hủy</button>
                  <button type="submit" className="btn btn-warning" disabled={saving}>
                    {saving ? <><span className="spinner-border spinner-border-sm me-2"></span>Đang lưu...</> : 'Lưu'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      );
    }

    // ==================== PRODUCT MANAGER ====================
    function ProductManager({ showToast }) {
      const [products, setProducts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showModal, setShowModal] = useState(false);
      const [editingProduct, setEditingProduct] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [filterCategory, setFilterCategory] = useState('');

      const categories = ['Ty xy lanh', 'Combo Van 1 tay', 'Combo Van 2 tay', 'Combo Van 3 tay', 'Combo Van 4 tay', 'Combo Van 5 tay', 'Trang gạt', 'Phụ kiện', 'Van điều khiển'];

      useEffect(() => { loadProducts(); }, []);

      const loadProducts = async () => {
        setLoading(true);
        try {
          const res = await fetch(`${API_BASE}/api/products`);
          const data = await res.json();
          setProducts(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error(err);
          showToast('Lỗi tải sản phẩm', 'danger');
        }
        setLoading(false);
      };

      const handleCreate = () => { setEditingProduct(null); setShowModal(true); };

      const handleEdit = (product) => { setEditingProduct(product); setShowModal(true); };
      
      // Hàm xóa ảnh trên Cloudinary (dùng chung)
      const deleteCloudinaryImageGlobal = async (imageUrl) => {
        if (!imageUrl || !imageUrl.includes('cloudinary.com')) return;

        try {
          await fetch(`${API_BASE}/api/products?action=delete-image`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: imageUrl })
          });
          // Xóa cache khi xóa
          localStorage.removeItem(CACHE_KEY);
          showToast(`Đã xóa ${typeName}`, 'success');
          loadAllData();
          loadProducts();
        } catch (err) {
          showToast('Lỗi xóa sản phẩm', 'danger');
        }
      };

      const handleSave = async (formData) => {
        try {
          const url = editingProduct 
            ? `${API_BASE}/api/products?id=${editingProduct.id}`
            : `${API_BASE}/api/products`;
          const res = await fetch(url, {
            method: editingProduct ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          if (!res.ok) throw new Error('Lỗi lưu sản phẩm');
          showToast(editingProduct ? 'Cập nhật thành công!' : 'Thêm sản phẩm thành công!', 'success');
          setShowModal(false);
          loadProducts();
        } catch (err) {
          showToast(err.message, 'danger');
        }
      };

      const handleDelete = async (product) => {
        if (!confirm(`Bạn có chắc muốn xóa sản phẩm "${product.name}"?`)) return;
        
        try {
          const res = await fetch(`${API_BASE}/api/products?id=${product.id}`, {
            method: 'DELETE'
          });
          if (!res.ok) throw new Error('Lỗi xóa sản phẩm');
          
          showToast('Xóa sản phẩm thành công!', 'success');
          loadProducts();
        } catch (err) {
          showToast(err.message, 'danger');
        }
      };

      const filteredProducts = products.filter(p => {
        const matchSearch = !searchTerm || p.name.toLowerCase().includes(searchTerm.toLowerCase()) || (p.code && p.code.toLowerCase().includes(searchTerm.toLowerCase()));
        const matchCategory = !filterCategory || p.category === filterCategory;
        return matchSearch && matchCategory;
      });

      return (
        <div className="product-manager pb-5 mb-4">
          {/* Header */}
          <div className="product-header">
            <h5><i className="fas fa-box me-2"></i>Sản phẩm</h5>
            <button className="btn-add-product" onClick={handleCreate}>
              <i className="fas fa-plus me-1"></i>Thêm mới
            </button>
          </div>

          {/* Search & Filter */}
          <div className="product-search">
            <div className="d-flex gap-2 mb-2">
              <div className="flex-grow-1 position-relative">
                <input
                  type="text"
                  className="form-control"
                  placeholder="🔍 Tìm sản phẩm..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
              </div>
              <span className="product-count">{filteredProducts.length}</span>
            </div>
            <select className="form-select" value={filterCategory} onChange={(e) => setFilterCategory(e.target.value)}>
              <option value="">📁 Tất cả danh mục</option>
              {categories.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>

          {/* Product List */}
          {loading ? (
            <div className="text-center py-5">
              <div className="spinner-border text-warning" style={{width: '2.5rem', height: '2.5rem'}}></div>
              <p className="text-muted mt-3 mb-0">Đang tải...</p>
            </div>
          ) : filteredProducts.length === 0 ? (
            <div className="empty-state">
              <i className="fas fa-box-open"></i>
              <p>Chưa có sản phẩm nào</p>
              <button className="btn btn-warning" onClick={handleCreate}>
                <i className="fas fa-plus me-2"></i>Thêm sản phẩm đầu tiên
              </button>
            </div>
          ) : (
            <div className="product-list">
              {filteredProducts.map(product => (
                <div key={product.id} className="product-item d-flex align-items-center gap-3">
                  {/* Image */}
                  {product.image ? (
                    <img src={product.image} alt="" className="product-img" />
                  ) : (
                    <div className="product-img-placeholder">
                      <i className="fas fa-image text-muted"></i>
                    </div>
                  )}
                  
                  {/* Info */}
                  <div className="flex-grow-1 min-width-0">
                    <div className="product-name">{product.name}</div>
                    <div className="d-flex flex-wrap gap-1 mb-1">
                      {product.category && (
                        <span className="product-badge bg-info bg-opacity-75">{product.category}</span>
                      )}
                      {product.code && (
                        <span className="product-badge bg-secondary">{product.code}</span>
                      )}
                    </div>
                    <div className="product-price">{product.price ? product.price.replace(/[đ\s]/g, '') + 'đ' : 'Liên hệ'}</div>
                    {product.note && (
                      <div className="text-muted small mt-1" style={{fontSize: '0.75rem'}}>{product.note}</div>
                    )}
                  </div>
                  
                  {/* Actions */}
                  <div className="product-actions">
                    <button className="btn btn-edit" onClick={() => handleEdit(product)} title="Sửa">
                      <i className="fas fa-pen"></i>
                    </button>
                    <button className="btn btn-delete" onClick={() => handleDelete(product)} title="Xóa">
                      <i className="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}

          <ProductModal
            show={showModal}
            product={editingProduct}
            categories={categories}
            onClose={() => setShowModal(false)}
            onSave={handleSave}
          />
        </div>
      );
    }

    // Product Modal (Create/Edit) - Light Theme
    function ProductModal({ show, product, categories, onClose, onSave }) {
      const [formData, setFormData] = useState({ name: '', code: '', price: '', image: '', category: '', note: '', sort_order: 0 });
      const [saving, setSaving] = useState(false);
      const [uploading, setUploading] = useState(false);

      useEffect(() => {
        if (product) {
          setFormData({
            name: product.name || '',
            code: product.code || '',
            price: product.price || '',
            image: product.image || '',
            category: product.category || '',
            note: product.note || '',
            sort_order: product.sort_order || 0
          });
        } else {
          setFormData({ name: '', code: '', price: '', image: '', category: '', note: '', sort_order: 0 });
        }
      }, [product, show]);

      // State để hiển thị tiến trình
      const [uploadStatus, setUploadStatus] = React.useState('');
      
      // Hàm format tiền VNĐ
      const formatVND = (value) => {
        // Lấy chỉ số từ input
        const numbers = value.replace(/[^\d]/g, '');
        if (!numbers) return '';
        // Format với dấu chấm ngăn cách hàng nghìn
        return numbers.replace(/\B(?=(\d{3})+(?!\d))/g, '.') + 'đ';
      };
      
      // Lưu giá trị số thuần để so sánh
      const [priceNumbers, setPriceNumbers] = React.useState('');
      
      // Xử lý khi nhập giá
      const handlePriceChange = (e) => {
        const value = e.target.value;
        // Lấy chỉ số thuần
        const numbers = value.replace(/[^\d]/g, '');
        
        // Nếu xóa hết thì để trống
        if (!numbers) {
          setFormData({...formData, price: ''});
          setPriceNumbers('');
          return;
        }
        
        // Nếu số không thay đổi (user chỉ xóa đ hoặc dấu chấm) thì xóa 1 số cuối
        if (numbers === priceNumbers && numbers.length > 0) {
          const newNumbers = numbers.slice(0, -1);
          if (!newNumbers) {
            setFormData({...formData, price: ''});
            setPriceNumbers('');
          } else {
            setFormData({...formData, price: formatVND(newNumbers)});
            setPriceNumbers(newNumbers);
          }
          return;
        }
        
        setPriceNumbers(numbers);
        setFormData({...formData, price: formatVND(numbers)});
      };
      
      // Lưu ảnh cũ để xóa khi thay ảnh mới
      const [oldImage, setOldImage] = React.useState('');
      
      React.useEffect(() => {
        if (product?.image) {
          setOldImage(product.image);
        }
      }, [product]);

      // Hàm xóa ảnh trên Cloudinary
      const deleteCloudinaryImage = async (imageUrl) => {
        if (!imageUrl || !imageUrl.includes('cloudinary.com')) return;
        try {
          await fetch(`${API_BASE}/api/products?action=delete-image`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: imageUrl })
          });
        } catch (err) {
          console.error('Delete cloudinary image error:', err);
        }
      };

      // Nén ảnh trước khi upload (cho file lớn từ iPhone)
      const compressImage = async (file, maxSizeMB = 2, onProgress) => {
        const maxSize = maxSizeMB * 1024 * 1024;
        
        // Nếu file đã nhỏ và không phải HEIC, không cần nén
        const isHeic = file.type === 'image/heic' || file.type === 'image/heif' || /\.heic$/i.test(file.name);
        if (file.size <= maxSize && !isHeic) {
          return file;
        }
        
        onProgress?.('Đang xử lý ảnh...');
        
        try {
          // Dùng createImageBitmap - hỗ trợ HEIC trên Safari iOS
          const bitmap = await createImageBitmap(file);
          
          onProgress?.('Đang nén ảnh...');
          
          const canvas = document.createElement('canvas');
          
          // Resize (max 1200px)
          let width = bitmap.width;
          let height = bitmap.height;
          const maxDimension = 1200;
          
          if (width > maxDimension || height > maxDimension) {
            if (width > height) {
              height = Math.round((height / width) * maxDimension);
              width = maxDimension;
            } else {
              width = Math.round((width / height) * maxDimension);
              height = maxDimension;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(bitmap, 0, 0, width, height);
          bitmap.close(); // Giải phóng memory
          
          // Convert to blob
          return new Promise((resolve, reject) => {
            canvas.toBlob((blob) => {
              if (blob) {
                onProgress?.('Hoàn tất!');
                resolve(new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' }));
              } else {
                reject(new Error('Không nén được ảnh'));
              }
            }, 'image/jpeg', 0.7);
          });
        } catch (err) {
          console.error('createImageBitmap error:', err);
          throw new Error('Không thể xử lý ảnh. Thử chọn ảnh khác.');
        }
      };

      const handleImageUpload = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        
        // Validate file type for Safari iOS - check cả name nếu type rỗng
        const isImage = file.type.startsWith('image/') || /\.(jpg|jpeg|png|gif|webp|heic|heif)$/i.test(file.name);
        if (!isImage) {
          alert('Vui lòng chọn file ảnh!');
          return;
        }
        
        setUploading(true);
        setUploadStatus('Đang chuẩn bị...');
        
        try {
          const fileSizeMB = (file.size / 1024 / 1024).toFixed(1);
          setUploadStatus(`File ${fileSizeMB}MB - Đang nén...`);
          
          // Nén ảnh nếu file quá lớn (>2MB)
          const compressedFile = await compressImage(file, 2, (status) => {
            setUploadStatus(status);
          });
          
          const compressedSizeMB = (compressedFile.size / 1024 / 1024).toFixed(1);
          setUploadStatus(`Đã nén: ${compressedSizeMB}MB - Đang upload...`);
          
          const fd = new FormData();
          fd.append('file', compressedFile);
          fd.append('upload_preset', 'ktm_unsigned');
          
          const res = await fetch('https://api.cloudinary.com/v1_1/diwxfpt92/image/upload', { 
            method: 'POST', 
            body: fd 
          });
          
          const data = await res.json();
          
          if (data.secure_url) {
            // Xóa ảnh cũ trên Cloudinary khi upload ảnh mới thành công
            if (formData.image && formData.image !== oldImage) {
              deleteCloudinaryImage(formData.image);
            }
            setFormData(prev => ({ ...prev, image: data.secure_url }));
            setUploadStatus('');
          } else {
            console.error('Cloudinary error:', data);
            alert('Upload thất bại: ' + (data.error?.message || 'Lỗi không xác định'));
            setUploadStatus('');
          }
        } catch (err) {
          console.error('Upload error:', err);
          alert('Lỗi: ' + err.message);
          setUploadStatus('');
        }
        setUploading(false);
        e.target.value = '';
      };
      
      // Xóa ảnh hiện tại
      const handleRemoveImage = () => {
        if (formData.image) {
          // Chỉ xóa ngay nếu đây là ảnh mới upload (không phải ảnh gốc của sản phẩm)
          if (formData.image !== oldImage) {
            deleteCloudinaryImage(formData.image);
          }
          setFormData(prev => ({ ...prev, image: '' }));
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setSaving(true);
        
        // Xóa ảnh cũ nếu đã thay bằng ảnh mới
        if (oldImage && formData.image && oldImage !== formData.image) {
          await deleteCloudinaryImage(oldImage);
        }
        // Xóa ảnh cũ nếu đã xóa ảnh
        if (oldImage && !formData.image) {
          await deleteCloudinaryImage(oldImage);
        }
        
        await onSave(formData);
        setSaving(false);
      };

      if (!show) return null;

      return (
        <div className="modal show d-block" style={{ background: 'rgba(0,0,0,0.5)' }}>
          <div className="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down">
            <div className="modal-content" style={{borderRadius: '16px', overflow: 'hidden'}}>
              {/* Header gradient */}
              <div className="modal-header border-0 py-3" style={{background: 'linear-gradient(135deg, #ffc107 0%, #ffca2c 100%)'}}>
                <h6 className="modal-title fw-bold" style={{color: '#1a1a2e'}}>
                  <i className={`fas ${product ? 'fa-edit' : 'fa-plus-circle'} me-2`}></i>
                  {product ? 'Sửa sản phẩm' : 'Thêm sản phẩm mới'}
                </h6>
                <button type="button" className="btn-close" onClick={onClose}></button>
              </div>
              <form onSubmit={handleSubmit}>
                <div className="modal-body py-4" style={{maxHeight: '65vh', overflowY: 'auto', background: '#f8f9fa'}}>
                  {/* Image Upload */}
                  <div className="text-center mb-4">
                    <div className="position-relative d-inline-block">
                      {formData.image ? (
                        <>
                          <img src={formData.image} alt="" style={{width: 110, height: 110, objectFit: 'cover', borderRadius: '12px', boxShadow: '0 4px 15px rgba(0,0,0,0.15)'}} />
                          <button 
                            type="button" 
                            className="btn btn-danger position-absolute" 
                            onClick={handleRemoveImage} 
                            style={{top: -10, right: -10, width: 28, height: 28, padding: 0, borderRadius: '50%', boxShadow: '0 2px 8px rgba(220,53,69,0.4)'}}
                          >
                            <i className="fas fa-times" style={{fontSize: '0.75rem'}}></i>
                          </button>
                        </>
                      ) : (
                        <div className="d-flex align-items-center justify-content-center" style={{width: 110, height: 110, borderRadius: '12px', background: 'linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)', border: '2px dashed #adb5bd'}}>
                          <i className="fas fa-image fa-2x text-muted"></i>
                        </div>
                      )}
                    </div>
                    <div className="mt-2">
                      <label className="btn btn-warning btn-sm px-3" style={{borderRadius: '20px'}}>
                        <i className={`fas ${uploading ? 'fa-spinner fa-spin' : 'fa-camera'} me-1`}></i>
                        {uploading ? (uploadStatus || 'Đang xử lý...') : 'Chọn ảnh'}
                        <input 
                          type="file" 
                          accept="image/*" 
                          onChange={handleImageUpload} 
                          disabled={uploading}
                          style={{position: 'absolute', left: '-9999px', opacity: 0, width: 1, height: 1}}
                        />
                      </label>
                      {uploading && uploadStatus && (
                        <div className="text-center mt-1" style={{fontSize: 11, color: '#6c757d'}}>
                          {uploadStatus}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Form Fields */}
                  <div className="mb-3">
                    <label className="form-label fw-semibold small text-dark mb-1">
                      <i className="fas fa-tag me-1 text-warning"></i>Tên sản phẩm *
                    </label>
                    <input 
                      type="text" 
                      className="form-control" 
                      value={formData.name} 
                      onChange={(e) => setFormData({...formData, name: e.target.value})} 
                      required 
                      placeholder="VD: Combo Van 3 tay + 2 xylanh"
                      style={{borderRadius: '10px', border: '1px solid #dee2e6', padding: '12px'}}
                    />
                  </div>

                  <div className="row g-2 mb-3">
                    <div className="col-6">
                      <label className="form-label fw-semibold small text-dark mb-1">
                        <i className="fas fa-barcode me-1 text-info"></i>Mã SP
                      </label>
                      <input 
                        type="text" 
                        className="form-control" 
                        value={formData.code} 
                        onChange={(e) => setFormData({...formData, code: e.target.value})} 
                        placeholder="KTM-01"
                        style={{borderRadius: '10px', border: '1px solid #dee2e6', padding: '12px'}}
                      />
                    </div>
                    <div className="col-6">
                      <label className="form-label fw-semibold small text-dark mb-1">
                        <i className="fas fa-dollar-sign me-1 text-success"></i>Giá
                      </label>
                      <input 
                        type="text" 
                        className="form-control" 
                        value={formData.price} 
                        onChange={handlePriceChange} 
                        placeholder="1.950.000đ"
                        inputMode="numeric"
                        style={{borderRadius: '10px', border: '1px solid #dee2e6', padding: '12px'}}
                      />
                    </div>
                  </div>

                  <div className="mb-3">
                    <label className="form-label fw-semibold small text-dark mb-1">
                      <i className="fas fa-folder me-1 text-primary"></i>Danh mục
                    </label>
                    <select 
                      className="form-select" 
                      value={formData.category} 
                      onChange={(e) => setFormData({...formData, category: e.target.value})}
                      style={{borderRadius: '10px', border: '1px solid #dee2e6', padding: '12px'}}
                    >
                      <option value="">Chọn danh mục</option>
                      {categories.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                  </div>

                  <div className="mb-3">
                    <label className="form-label fw-semibold small text-dark mb-1">
                      <i className="fas fa-sticky-note me-1 text-secondary"></i>Ghi chú
                    </label>
                    <input 
                      type="text" 
                      className="form-control" 
                      value={formData.note} 
                      onChange={(e) => setFormData({...formData, note: e.target.value})} 
                      placeholder="VD: Thêm dây là 2.150.000đ"
                      style={{borderRadius: '10px', border: '1px solid #dee2e6', padding: '12px'}}
                    />
                  </div>

                  <div className="mb-2">
                    <label className="form-label fw-semibold small text-muted mb-1">
                      <i className="fas fa-link me-1"></i>URL ảnh (tùy chọn)
                    </label>
                    <input 
                      type="url" 
                      className="form-control" 
                      placeholder="https://..." 
                      value={formData.image} 
                      onChange={(e) => setFormData({...formData, image: e.target.value})}
                      style={{borderRadius: '10px', border: '1px solid #dee2e6', padding: '10px', fontSize: '0.9rem'}}
                    />
                  </div>
                </div>

                <div className="modal-footer border-0 py-3" style={{background: '#fff'}}>
                  <button type="button" className="btn btn-light px-4" onClick={onClose} style={{borderRadius: '10px'}}>
                    Hủy
                  </button>
                  <button type="submit" className="btn btn-warning px-4 fw-semibold" disabled={saving} style={{borderRadius: '10px', boxShadow: '0 4px 12px rgba(255,193,7,0.3)'}}>
                    {saving ? (
                      <><span className="spinner-border spinner-border-sm me-2"></span>Đang lưu...</>
                    ) : (
                      <><i className="fas fa-check me-2"></i>Lưu sản phẩm</>
                    )}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      );
    }

    // Video Modal (Create/Edit)
    function VideoModal({ show, video, onClose, onSave }) {
      const [formData, setFormData] = useState({
        title: '',
        youtube_url: '',
        thumbnail_url: '',
        sort_order: 0
      });
      const [saving, setSaving] = useState(false);
      const [previewThumb, setPreviewThumb] = useState('');

      useEffect(() => {
        if (video) {
          setFormData({
            title: video.title || '',
            youtube_url: `https://www.youtube.com/watch?v=${video.youtubeId}`,
            thumbnail_url: video.thumb || '',
            sort_order: video.sortOrder || 0,
          });
          setPreviewThumb(video.thumb);
        } else {
          setFormData({
            title: '',
            youtube_url: '',
            thumbnail_url: '',
            sort_order: 0
          });
          setPreviewThumb('');
        }
      }, [video, show]);

      const extractYoutubeId = (url) => {
        const match = url.match(/(?:youtube\.com\/(?:embed\/|watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        return match ? match[1] : null;
      };

      const handleUrlChange = (url) => {
        setFormData({ ...formData, youtube_url: url });
        const videoId = extractYoutubeId(url);
        if (videoId) {
          setPreviewThumb(`https://img.youtube.com/vi/${videoId}/hqdefault.jpg`);
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setSaving(true);
        await onSave(formData);
        setSaving(false);
      };

      if (!show) return null;

      return (
        <div className="modal show d-block" style={{ background: 'rgba(0,0,0,0.5)' }}>
          <div className="modal-dialog modal-dialog-centered">
            <div className="modal-content">
              <div className="modal-header">
                <h5 className="modal-title">{video ? 'Sửa Video' : 'Thêm Video mới'}</h5>
                <button type="button" className="btn-close" onClick={onClose}></button>
              </div>
              <form onSubmit={handleSubmit}>
                <div className="modal-body">
                  <div className="mb-3">
                    <label className="form-label">Link YouTube *</label>
                    <input
                      type="url"
                      className="form-control"
                      value={formData.youtube_url}
                      onChange={(e) => handleUrlChange(e.target.value)}
                      placeholder="https://www.youtube.com/watch?v=... hoặc shorts/..."
                      required
                    />
                    <small className="text-muted">Hỗ trợ: youtube.com/watch, youtu.be, youtube.com/shorts</small>
                  </div>

                  {previewThumb && (
                    <div className="mb-3 text-center">
                      <img src={previewThumb} alt="Preview" className="img-fluid rounded" style={{ maxHeight: '150px' }} />
                    </div>
                  )}

                  <div className="mb-3">
                    <label className="form-label">Tiêu đề *</label>
                    <input
                      type="text"
                      className="form-control"
                      value={formData.title}
                      onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                      required
                    />
                  </div>

                  <div className="mb-3">
                    <label className="form-label">Thứ tự</label>
                    <input
                      type="number"
                      className="form-control"
                      value={formData.sort_order}
                      onChange={(e) => setFormData({ ...formData, sort_order: parseInt(e.target.value) || 0 })}
                    />
                  </div>

                  <div className="mb-3">
                    <label className="form-label">Thumbnail tùy chỉnh (tùy chọn)</label>
                    <input
                      type="url"
                      className="form-control"
                      value={formData.thumbnail_url}
                      onChange={(e) => setFormData({ ...formData, thumbnail_url: e.target.value })}
                      placeholder="Để trống sẽ dùng thumbnail mặc định của YouTube"
                    />
                  </div>
                </div>
                <div className="modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={onClose}>Hủy</button>
                  <button type="submit" className="btn btn-warning" disabled={saving}>
                    {saving ? <><span className="spinner-border spinner-border-sm me-2"></span>Đang lưu...</> : 'Lưu'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      );
    }

    // ==================== MAIN APP ====================
    function AdminApp() {
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [loginError, setLoginError] = useState('');
      const [currentUser, setCurrentUser] = useState(null);
      const [activeMenu, setActiveMenu] = useState('search');
      const [albums, setAlbums] = useState([]);
      const [selectedAlbum, setSelectedAlbum] = useState(null);
      const [showAlbumModal, setShowAlbumModal] = useState(false);
      const [editingAlbum, setEditingAlbum] = useState(null);
      const [loading, setLoading] = useState(true);
      const [toasts, setToasts] = useState([]);
      
      // Nested folder navigation
      const [currentAlbumFolder, setCurrentAlbumFolder] = useState(null);
      const [albumBreadcrumb, setAlbumBreadcrumb] = useState([]);

      // Check session on mount
      useEffect(() => {
        const session = localStorage.getItem('ktm_admin_session');
        if (session) {
          try {
            const data = JSON.parse(session);
            // Check if session expired (permanent - 100 years)
            if (data.expiry > Date.now()) {
              setIsLoggedIn(true);
              setCurrentUser(data.user);
            } else {
              localStorage.removeItem('ktm_admin_session');
            }
          } catch (e) {
            localStorage.removeItem('ktm_admin_session');
          }
        }
      }, []);

      useEffect(() => {
        if (isLoggedIn) {
          loadAlbums();
        }
      }, [isLoggedIn]);

      const handleLogin = async (username, password) => {
        setLoginError('');
        
        try {
          const res = await fetch(`${API_BASE}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.error || 'Đăng nhập thất bại');
          }

          // Save session (permanent)
          const session = {
            user: data.user,
            token: data.token,
            expiry: Date.now() + 100 * 365 * 24 * 60 * 60 * 1000 // 100 years (permanent)
          };
          localStorage.setItem('ktm_admin_session', JSON.stringify(session));
          
          setCurrentUser(data.user);
          setIsLoggedIn(true);
        } catch (err) {
          setLoginError(err.message);
        }
      };

      const handleLogout = () => {
        localStorage.removeItem('ktm_admin_session');
        setIsLoggedIn(false);
        setCurrentUser(null);
        setAlbums([]);
        setSelectedAlbum(null);
      };

      const showToast = (message, type = 'success') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type }]);
      };

      const removeToast = (id) => {
        setToasts(prev => prev.filter(t => t.id !== id));
      };

      const loadAlbums = async (parentId = null) => {
        setLoading(true);
        try {
          const url = parentId 
            ? `${API_BASE}/api/albums?parent_id=${parentId}`
            : `${API_BASE}/api/albums?parent_id=root`;
          const res = await fetch(url);
          const data = await res.json();
          setAlbums(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error(err);
          showToast('Lỗi tải danh sách album', 'danger');
        }
        setLoading(false);
      };

      const handleCreateAlbum = () => {
        setEditingAlbum(null);
        setShowAlbumModal(true);
      };

      const handleEditAlbum = (album) => {
        setEditingAlbum(album);
        setShowAlbumModal(true);
      };

      const handleSaveAlbum = async (formData) => {
        try {
          const isEditing = editingAlbum && editingAlbum.uuid;
          // Add parent_id if we're in a subfolder
          if (!isEditing && currentAlbumFolder) {
            formData.parent_id = currentAlbumFolder.uuid;
          }
          
          const url = isEditing 
            ? `${API_BASE}/api/albums/${editingAlbum.uuid || editingAlbum.id}` 
            : `${API_BASE}/api/albums`;
          
          const res = await fetch(url, {
            method: isEditing ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || (isEditing ? 'Lỗi cập nhật' : 'Lỗi tạo'));
          }

          showToast(isEditing ? 'Cập nhật thành công!' : 'Tạo thành công!', 'success');
          setShowAlbumModal(false);
          loadAlbums(currentAlbumFolder?.uuid);
        } catch (err) {
          showToast(err.message, 'danger');
        }
      };

      const handleSelectAlbum = (album) => {
        // Luôn vào bên trong folder (folder = album, có thể chứa cả ảnh lẫn subfolder)
        setSelectedAlbum(album);
      };

      const handleAlbumBack = (target) => {
        if (target === 'root') {
          setAlbumBreadcrumb([]);
          setCurrentAlbumFolder(null);
          loadAlbums(null);
        } else if (target) {
          // Navigate to specific folder in breadcrumb
          const idx = albumBreadcrumb.findIndex(b => b.uuid === target.uuid);
          if (idx >= 0) {
            setAlbumBreadcrumb(albumBreadcrumb.slice(0, idx + 1));
            setCurrentAlbumFolder(target);
            loadAlbums(target.uuid);
          }
        } else {
          // Go up one level
          const newBreadcrumb = [...albumBreadcrumb];
          newBreadcrumb.pop();
          const parentFolder = newBreadcrumb[newBreadcrumb.length - 1] || null;
          setAlbumBreadcrumb(newBreadcrumb);
          setCurrentAlbumFolder(parentFolder);
          loadAlbums(parentFolder?.uuid);
        }
      };

      const handleDeleteAlbum = async (album) => {
        const msg = `Xóa folder "${album.title}"? Tất cả folder con và ảnh bên trong sẽ bị xóa!`;
        if (!confirm(msg)) return;

        try {
          await fetch(`${API_BASE}/api/albums/${album.uuid || album.id}`, { method: 'DELETE' });
          showToast('Đã xóa', 'success');
          loadAlbums(currentAlbumFolder?.uuid);
        } catch (err) {
          showToast('Lỗi xóa album', 'danger');
        }
      };

      // Show login page if not logged in
      if (!isLoggedIn) {
        return <LoginPage onLogin={handleLogin} error={loginError} />;
      }

      return (
        <div>
          <Sidebar 
            activeMenu={activeMenu} 
            onMenuChange={(menu) => {
              setActiveMenu(menu);
              if (menu === 'albums') {
                setCurrentAlbumFolder(null);
                setAlbumBreadcrumb([]);
                loadAlbums(null);
              }
            }} 
            onLogout={handleLogout}
            currentUser={currentUser}
          />
          
          <div className="main-content">
            {activeMenu === 'albums' && !selectedAlbum && (
              <AlbumList
                albums={albums}
                loading={loading}
                currentFolder={currentAlbumFolder}
                breadcrumb={albumBreadcrumb}
                onSelect={handleSelectAlbum}
                onCreate={handleCreateAlbum}
                onEdit={handleEditAlbum}
                onDelete={handleDeleteAlbum}
                onBack={handleAlbumBack}
              />
            )}

            {activeMenu === 'search' && (
              <SearchCenter 
                showToast={showToast} 
                onNavigate={(menu, action) => {
                  setActiveMenu(menu);
                  // Có thể mở rộng để tự động mở modal tạo mới
                }}
              />
            )}

            {activeMenu === 'albums' && selectedAlbum && (
              <AlbumDetail
                album={selectedAlbum}
                parentAlbum={albumBreadcrumb.length > 0 ? albumBreadcrumb[albumBreadcrumb.length - 1] : null}
                onBack={() => {
                  // Go back to parent folder or album list
                  if (selectedAlbum.parentId) {
                    // Find parent in breadcrumb or go to list
                    const parentIdx = albumBreadcrumb.findIndex(b => b.uuid === selectedAlbum.parentId);
                    if (parentIdx >= 0) {
                      setSelectedAlbum(albumBreadcrumb[parentIdx]);
                    } else {
                      setSelectedAlbum(null);
                    }
                  } else {
                    setSelectedAlbum(null);
                  }
                }}
                onRefresh={() => loadAlbums(currentAlbumFolder?.uuid)}
                showToast={showToast}
                onNavigateToFolder={(folder) => {
                  // Navigate into subfolder - track breadcrumb
                  setAlbumBreadcrumb(prev => [...prev, selectedAlbum]);
                  setSelectedAlbum(folder);
                }}
                onEditSubfolder={(folder) => {
                  setEditingAlbum(folder);
                  setShowAlbumModal(true);
                }}
              />
            )}

            {activeMenu === 'videos' && (
              <VideoList
                showToast={showToast}
              />
            )}

            {activeMenu === 'products' && (
              <ProductManager showToast={showToast} />
            )}
            {activeMenu === 'orders' && (
              <OrderManager />
            )}
          </div>

          {/* ========== MOBILE BOTTOM NAVIGATION ========== */}
          <nav className="mobile-bottom-nav">
            <div className="nav-items">
              <a 
                href="#" 
                className={`nav-item ${activeMenu === 'search' ? 'active' : ''}`}
                onClick={(e) => { e.preventDefault(); setActiveMenu('search'); }}
              >
                <i className="fas fa-search"></i>
                <span>Tra cứu</span>
              </a>
              <a 
                href="#" 
                className={`nav-item ${activeMenu === 'albums' ? 'active' : ''}`}
                onClick={(e) => { e.preventDefault(); setActiveMenu('albums'); setSelectedAlbum(null); }}
              >
                <i className="fas fa-images"></i>
                <span>Album</span>
              </a>
              <a 
                href="#" 
                className={`nav-item ${activeMenu === 'videos' ? 'active' : ''}`}
                onClick={(e) => { e.preventDefault(); setActiveMenu('videos'); }}
              >
                <i className="fas fa-video"></i>
                <span>Video</span>
              </a>
              <a 
                href="#" 
                className={`nav-item ${activeMenu === 'products' ? 'active' : ''}`}
                onClick={(e) => { e.preventDefault(); setActiveMenu('products'); }}
              >
                <i className="fas fa-box"></i>
                <span>Sản phẩm</span>
              </a>
              <a 
                href="#" 
                className={`nav-item ${activeMenu === 'orders' ? 'active' : ''}`}
                onClick={(e) => { e.preventDefault(); setActiveMenu('orders'); }}
              >
                <i className="fas fa-receipt"></i>
                <span>Đơn hàng</span>
              </a>
              <a 
                href="#" 
                className="nav-item"
                onClick={(e) => { e.preventDefault(); handleLogout(); }}
              >
                <i className="fas fa-sign-out-alt"></i>
                <span>Thoát</span>
              </a>
            </div>
          </nav>

          <AlbumModal
            show={showAlbumModal}
            album={editingAlbum}
            parentId={currentAlbumFolder?.uuid}
            onClose={() => setShowAlbumModal(false)}
            onSave={handleSaveAlbum}
          />

          {/* Toast container */}
          <div className="toast-container">
            {toasts.map(toast => (
              <Toast
                key={toast.id}
                message={toast.message}
                type={toast.type}
                onClose={() => removeToast(toast.id)}
              />
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.render(<AdminApp />, document.getElementById('root'));
    // OrderManager component
    function OrderManager() {
      const [orders, setOrders] = useState([]);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [deletingId, setDeletingId] = useState(null);
      const [filterMonth, setFilterMonth] = useState('');
      const [showModal, setShowModal] = useState(false);
      const [form, setForm] = useState({
        customer_name: "",
        phone: "",
        address: "",
        product_id: "",
        quantity: 1,
        status: "pending"
      });
      const [products, setProducts] = useState([]);
      const [editingId, setEditingId] = useState(null);

      // Lock background scroll + hide bottom nav when modal open (especially on iOS)
      useEffect(() => {
        if (showModal) {
          document.body.classList.add('order-modal-open');
          document.body.style.overflow = 'hidden';
        } else {
          document.body.classList.remove('order-modal-open');
          document.body.style.overflow = '';
        }
        return () => {
          document.body.classList.remove('order-modal-open');
          document.body.style.overflow = '';
        };
      }, [showModal]);

      useEffect(() => {
        loadProducts();
      }, []);

      useEffect(() => {
        loadOrders();
      }, [filterMonth]);

      const getStatusLabel = (status) => {
        if (status === 'pending') return 'Chờ xử lý';
        if (status === 'processing') return 'Đang xử lý';
        if (status === 'done') return 'Hoàn thành';
        return status || '';
      };

      const getStatusBadgeClass = (status) => {
        if (status === 'pending') return 'bg-secondary';
        if (status === 'processing') return 'bg-warning text-dark';
        if (status === 'done') return 'bg-success';
        return 'bg-light text-dark';
      };

      const formatDateTime = (value) => {
        if (!value) return '';
        const d = new Date(value);
        if (Number.isNaN(d.getTime())) return String(value);
        try {
          return d.toLocaleString('vi-VN');
        } catch {
          return d.toISOString();
        }
      };

      const loadProducts = async () => {
        try {
          const res = await fetch(`${API_BASE}/api/products`);
          const data = await res.json();
          setProducts(Array.isArray(data) ? data : []);
        } catch (e) {
          console.error('Load products error:', e);
          setProducts([]);
        }
      };

      const loadOrders = async () => {
        setLoading(true);
        try {
          let url = `${API_BASE}/api/orders`;
          if (filterMonth) url += `?month=${filterMonth}`;
          const res = await fetch(url);
          const data = await res.json();
          setOrders(Array.isArray(data) ? data : []);
        } catch (e) {
          console.error('Load orders error:', e);
          setOrders([]);
        } finally {
          setLoading(false);
        }
      };

      const saveOrder = async () => {
        if (!form.customer_name || !form.phone || !form.product_id) {
          alert("Thiếu dữ liệu bắt buộc");
          return;
        }
        setSaving(true);
        try {
          const method = editingId ? "PUT" : "POST";
          const url = editingId 
            ? `${API_BASE}/api/orders/${editingId}` 
            : `${API_BASE}/api/orders`;
          await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              customer_name: form.customer_name,
              phone: form.phone,
              address: form.address,
              product_id: form.product_id,
              quantity: Number(form.quantity || 1),
              status: form.status,
              ...(editingId ? { id: editingId } : {}),
            })
          });
          setForm({ customer_name: "", phone: "", address: "", product_id: "", quantity: 1, status: "pending" });
          setEditingId(null);
          setShowModal(false);
          loadOrders();
        } finally {
          setSaving(false);
        }
      };

      const editOrder = (order) => {
        setEditingId(order.id);
        setForm({
          customer_name: order.customer_name || "",
          phone: order.phone || "",
          address: order.address || "",
          product_id: order.product_id || "",
          quantity: Number(order.quantity || 1),
          status: order.status || "pending",
        });
        setShowModal(true);
      };

      const openCreateModal = () => {
        setEditingId(null);
        setForm({ customer_name: "", phone: "", address: "", product_id: "", quantity: 1, status: "pending" });
        setShowModal(true);
      };

      const closeModal = () => {
        if (saving) return;
        setShowModal(false);
        setEditingId(null);
        setForm({ customer_name: "", phone: "", address: "", product_id: "", quantity: 1, status: "pending" });
      };

      const deleteOrder = async (id) => {
        if (!confirm("Xóa đơn hàng này?")) return;
        setDeletingId(id);
        try {
          await fetch(`${API_BASE}/api/orders/${id}`, { method: "DELETE" });
          loadOrders();
        } finally {
          setDeletingId(null);
        }
      };

      return (
        <div className="product-manager">
          <Loading show={loading || saving || !!deletingId} />
          <div className="product-header">
            <h5>Quản lý đơn hàng</h5>
            <button className="btn btn-dark btn-sm" onClick={openCreateModal} disabled={saving || !!deletingId}>
              <i className="fas fa-plus me-2"></i>Tạo đơn
            </button>
          </div>

          <div className="product-search">
            <div className="row g-2 align-items-end">
              <div className="col-12 col-md-5">
                <label className="form-label mb-1">Lọc theo tháng</label>
                <div className="input-group">
                  <span className="input-group-text" aria-hidden="true">
                    <i className="fas fa-calendar-alt"></i>
                  </span>
                  <input
                    type="month"
                    className="form-control"
                    value={filterMonth}
                    onChange={e => setFilterMonth(e.target.value)}
                    aria-label="Chọn tháng"
                  />
                  {filterMonth && (
                    <button
                      type="button"
                      className="btn btn-outline-secondary"
                      onClick={() => {
                        setFilterMonth('');
                      }}
                      title="Bỏ lọc"
                      aria-label="Bỏ lọc"
                      disabled={loading}
                    >
                      <i className="fas fa-times"></i>
                    </button>
                  )}
                </div>
              </div>
              <div className="col-12 col-md-7 d-flex gap-2 justify-content-md-end">
                <button className="btn btn-outline-secondary" onClick={loadOrders} disabled={loading}>
                  <i className="fas fa-rotate me-2"></i>Làm mới
                </button>
              </div>
            </div>
          </div>

          <div className="card p-3">
            <div className="d-flex align-items-center justify-content-between">
              <h6 className="mb-0">Danh sách đơn hàng</h6>
              <span className="text-muted small">{orders.length} đơn</span>
            </div>

            {loading ? (
              <div className="text-center py-4">
                <div className="spinner-border text-warning"></div>
              </div>
            ) : orders.length === 0 ? (
              <div className="text-center py-4 text-muted">Chưa có đơn hàng</div>
            ) : (
              <>
                {/* Mobile cards */}
                <div className="d-md-none mt-3">
                  {orders.map(order => (
                    <div key={order.id} className="card mb-2">
                      <div className="card-body p-3">
                        <div className="d-flex justify-content-between align-items-start gap-2">
                          <div className="flex-grow-1" style={{ minWidth: 0 }}>
                            <div className="fw-semibold text-truncate">{order.customer_name}</div>
                            <div className="text-muted small text-truncate">
                              {order.phone}{order.address ? ` • ${order.address}` : ''}
                            </div>
                          </div>
                          <span className={`badge ${getStatusBadgeClass(order.status)}`}>{getStatusLabel(order.status)}</span>
                        </div>

                        <div className="mt-2 small">
                          <div><span className="text-muted">Sản phẩm:</span> <span className="fw-semibold">{order.product_name || '—'}</span></div>
                          <div><span className="text-muted">Số lượng:</span> <span className="fw-semibold">{order.quantity}</span></div>
                          <div><span className="text-muted">Thời gian:</span> {formatDateTime(order.created_at)}</div>
                        </div>

                        <div className="mt-3 d-flex gap-2">
                          <button className="btn btn-sm btn-primary flex-fill" onClick={() => editOrder(order)} disabled={saving || !!deletingId}>
                            Sửa
                          </button>
                          <button
                            className="btn btn-sm btn-danger flex-fill"
                            onClick={() => deleteOrder(order.id)}
                            disabled={saving || deletingId === order.id}
                          >
                            {deletingId === order.id ? (
                              <><span className="spinner-border spinner-border-sm me-2"></span>Đang xóa</>
                            ) : (
                              'Xóa'
                            )}
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                {/* Desktop table */}
                <div className="d-none d-md-block">
                  <table className="table table-bordered mt-3">
                    <thead>
                      <tr>
                        <th>Khách hàng</th>
                        <th>SĐT</th>
                        <th>Sản phẩm</th>
                        <th>SL</th>
                        <th>Trạng thái</th>
                        <th>Thời gian</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      {orders.map(order => (
                        <tr key={order.id}>
                          <td>{order.customer_name}</td>
                          <td>{order.phone}</td>
                          <td>{order.product_name}</td>
                          <td>{order.quantity}</td>
                          <td><span className={`badge ${getStatusBadgeClass(order.status)}`}>{getStatusLabel(order.status)}</span></td>
                          <td>{formatDateTime(order.created_at)}</td>
                          <td>
                            <button className="btn btn-sm btn-primary me-1" onClick={() => editOrder(order)} disabled={saving || !!deletingId}>Sửa</button>
                            <button className="btn btn-sm btn-danger" onClick={() => deleteOrder(order.id)} disabled={saving || deletingId === order.id}>
                              {deletingId === order.id ? (
                                <><span className="spinner-border spinner-border-sm me-2"></span>Đang xóa</>
                              ) : (
                                'Xóa'
                              )}
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </>
            )}
          </div>

          {/* Order create/edit modal */}
          {showModal && (
            <div className="modal show d-block order-modal" style={{ background: 'rgba(0,0,0,0.6)' }} role="dialog" aria-modal="true">
              <div className="modal-dialog modal-dialog-centered">
                <div className="modal-content" style={{ borderRadius: 16 }}>
                  <div className="modal-header" style={{ background: 'linear-gradient(135deg, #ffc107, #ffca2c)', border: 'none', borderRadius: '16px 16px 0 0' }}>
                    <h5 className="modal-title fw-bold text-dark mb-0">
                      <i className="fas fa-receipt me-2"></i>
                      {editingId ? 'Sửa đơn hàng' : 'Tạo đơn hàng'}
                    </h5>
                    <button type="button" className="btn-close" onClick={closeModal}></button>
                  </div>
                  <form
                    onSubmit={(e) => {
                      e.preventDefault();
                      saveOrder();
                    }}
                  >
                    <div className="modal-body">
                      <div className="row g-3">
                        <div className="col-12">
                          <label className="form-label fw-semibold small text-muted mb-1">Tên khách hàng *</label>
                          <input
                            className="form-control"
                            value={form.customer_name}
                            onChange={e => setForm({ ...form, customer_name: e.target.value })}
                            placeholder="Nhập tên khách hàng"
                            required
                            style={{ borderRadius: 10, padding: 12 }}
                          />
                        </div>
                        <div className="col-12 col-md-6">
                          <label className="form-label fw-semibold small text-muted mb-1">Số điện thoại *</label>
                          <input
                            className="form-control"
                            value={form.phone}
                            onChange={e => setForm({ ...form, phone: e.target.value })}
                            placeholder="Nhập số điện thoại"
                            required
                            style={{ borderRadius: 10, padding: 12 }}
                          />
                        </div>
                        <div className="col-12 col-md-6">
                          <label className="form-label fw-semibold small text-muted mb-1">Trạng thái</label>
                          <select
                            className="form-select"
                            value={form.status}
                            onChange={e => setForm({ ...form, status: e.target.value })}
                            style={{ borderRadius: 10, padding: 12 }}
                          >
                            <option value="pending">Chờ xử lý</option>
                            <option value="processing">Đang xử lý</option>
                            <option value="done">Hoàn thành</option>
                          </select>
                        </div>
                        <div className="col-12">
                          <label className="form-label fw-semibold small text-muted mb-1">Địa chỉ</label>
                          <input
                            className="form-control"
                            value={form.address}
                            onChange={e => setForm({ ...form, address: e.target.value })}
                            placeholder="Nhập địa chỉ (không bắt buộc)"
                            style={{ borderRadius: 10, padding: 12 }}
                          />
                        </div>
                        <div className="col-12 col-md-8">
                          <label className="form-label fw-semibold small text-muted mb-1">Sản phẩm *</label>
                          <select
                            className="form-select"
                            value={form.product_id}
                            onChange={e => setForm({ ...form, product_id: e.target.value })}
                            required
                            style={{ borderRadius: 10, padding: 12 }}
                          >
                            <option value="">-- chọn sản phẩm --</option>
                            {products.map(p => (
                              <option key={p.id} value={p.id}>{p.name}</option>
                            ))}
                          </select>
                        </div>
                        <div className="col-12 col-md-4">
                          <label className="form-label fw-semibold small text-muted mb-1">Số lượng</label>
                          <input
                            type="number"
                            className="form-control"
                            value={form.quantity}
                            onChange={e => setForm({ ...form, quantity: e.target.value })}
                            min="1"
                            style={{ borderRadius: 10, padding: 12 }}
                          />
                        </div>
                      </div>
                    </div>
                    <div className="modal-footer" style={{ border: 'none' }}>
                      <button type="button" className="btn btn-light" onClick={closeModal} disabled={saving} style={{ borderRadius: 10 }}>
                        Hủy
                      </button>
                      <button type="submit" className="btn btn-warning fw-semibold" disabled={saving} style={{ borderRadius: 10, boxShadow: '0 4px 12px rgba(255,193,7,0.3)' }}>
                        {saving ? (
                          <><span className="spinner-border spinner-border-sm me-2"></span>Đang lưu...</>
                        ) : (
                          <><i className="fas fa-check me-2"></i>Lưu</>
                        )}
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }
  </script>
</body>
</html>
