<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Quản lý Album | KTM</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <style>
    :root {
      --primary: #ffc107;
      --dark: #1a1a2e;
    }
    
    body {
      background: #f5f5f5;
      min-height: 100vh;
    }
    
    .sidebar {
      background: var(--dark);
      min-height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      width: 250px;
      padding-top: 20px;
    }
    
    .sidebar .logo {
      color: var(--primary);
      font-weight: bold;
      font-size: 1.5rem;
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .sidebar .nav-link {
      color: rgba(255,255,255,0.7);
      padding: 12px 20px;
      border-left: 3px solid transparent;
    }
    
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      color: #fff;
      background: rgba(255,255,255,0.05);
      border-left-color: var(--primary);
    }
    
    .sidebar .nav-link i {
      width: 25px;
    }
    
    .main-content {
      margin-left: 250px;
      padding: 20px;
    }
    
    .card {
      border: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .album-card {
      transition: transform 0.2s;
      cursor: pointer;
    }
    
    .album-card:hover {
      transform: translateY(-5px);
    }
    
    .album-cover {
      height: 150px;
      object-fit: cover;
      width: 100%;
    }
    
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .image-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .image-item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }
    
    .image-item .actions {
      position: absolute;
      top: 5px;
      right: 5px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .image-item:hover .actions {
      opacity: 1;
    }
    
    .upload-zone {
      border: 2px dashed #ddd;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: var(--primary);
      background: #fffbeb;
    }
    
    .upload-zone input {
      display: none;
    }
    
    .upload-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .upload-preview-item {
      position: relative;
      width: 100px;
      height: 100px;
    }
    
    .upload-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .upload-preview-item .remove {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 10px;
      cursor: pointer;
    }
    
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      .main-content {
        margin-left: 0;
      }
    }

    /* Login Page Styles */
    .login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      padding: 20px;
    }

    .login-box {
      background: #fff;
      border-radius: 15px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .login-box .input-group-text {
      background: #f8f9fa;
      border-right: none;
    }

    .login-box .form-control {
      border-left: none;
    }

    .login-box .form-control:focus {
      box-shadow: none;
      border-color: #ced4da;
    }

    .login-box .input-group:focus-within .input-group-text,
    .login-box .input-group:focus-within .form-control {
      border-color: var(--primary);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React + Babel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.10/babel.min.js"></script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

  <!-- Search Data -->
  <script src="searchData.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Cloudinary config - Cần tạo unsigned upload preset tên "ktm_unsigned" trên Cloudinary Dashboard
    // Settings -> Upload -> Upload presets -> Add upload preset -> Signing Mode: Unsigned
    const CLOUDINARY_CLOUD_NAME = 'diwxfpt92';
    const CLOUDINARY_UPLOAD_PRESET = 'ktm_unsigned'; 

    // API Base
    const API_BASE = '';

    // ==================== LOGIN COMPONENT ====================
    function LoginPage({ onLogin, error }) {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [showPassword, setShowPassword] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        await onLogin(username, password);
        setLoading(false);
      };

      return (
        <div className="login-page">
          <div className="login-box">
            <div className="text-center mb-4">
              <i className="fas fa-tractor fa-3x text-warning mb-3"></i>
              <h4 className="text-dark">KTM Admin</h4>
              <p className="text-muted small">Đăng nhập để quản lý</p>
            </div>

            {error && (
              <div className="alert alert-danger py-2 small">
                <i className="fas fa-exclamation-circle me-2"></i>{error}
              </div>
            )}

            <form onSubmit={handleSubmit}>
              <div className="mb-3">
                <label className="form-label small">Tên đăng nhập</label>
                <div className="input-group">
                  <span className="input-group-text"><i className="fas fa-user"></i></span>
                  <input
                    type="text"
                    className="form-control"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    placeholder="admin"
                    required
                    autoFocus
                  />
                </div>
              </div>

              <div className="mb-4">
                <label className="form-label small">Mật khẩu</label>
                <div className="input-group">
                  <span className="input-group-text"><i className="fas fa-lock"></i></span>
                  <input
                    type={showPassword ? 'text' : 'password'}
                    className="form-control"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="••••••••"
                    required
                  />
                  <button 
                    type="button" 
                    className="btn btn-outline-secondary"
                    onClick={() => setShowPassword(!showPassword)}
                  >
                    <i className={`fas fa-eye${showPassword ? '-slash' : ''}`}></i>
                  </button>
                </div>
              </div>

              <button 
                type="submit" 
                className="btn btn-warning w-100"
                disabled={loading}
              >
                {loading ? (
                  <><span className="spinner-border spinner-border-sm me-2"></span>Đang đăng nhập...</>
                ) : (
                  <><i className="fas fa-sign-in-alt me-2"></i>Đăng nhập</>
                )}
              </button>
            </form>

            <div className="text-center mt-4">
              <a href="/" className="text-muted small text-decoration-none">
                <i className="fas fa-arrow-left me-1"></i>Về trang chủ
              </a>
            </div>
          </div>
        </div>
      );
    }

    // ==================== COMPONENTS ====================

    // Toast notification
    function Toast({ message, type, onClose }) {
      useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
      }, []);

      return (
        <div className={`toast show align-items-center text-white bg-${type} border-0`} role="alert">
          <div className="d-flex">
            <div className="toast-body">{message}</div>
            <button type="button" className="btn-close btn-close-white me-2 m-auto" onClick={onClose}></button>
          </div>
        </div>
      );
    }

    // Loading overlay
    function Loading({ show }) {
      if (!show) return null;
      return (
        <div className="loading-overlay">
          <div className="spinner-border text-warning" style={{ width: '3rem', height: '3rem' }}>
            <span className="visually-hidden">Đang tải...</span>
          </div>
        </div>
      );
    }

    // Sidebar
    function Sidebar({ activeMenu, onMenuChange, onLogout, currentUser }) {
      const menus = [
        { id: 'search', icon: 'fa-search', label: 'Tra cứu nhanh', highlight: true },
        { id: 'albums', icon: 'fa-images', label: 'Quản lý Album' },
        { id: 'videos', icon: 'fa-video', label: 'Quản lý Video' },
        { id: 'products', icon: 'fa-box', label: 'Sản phẩm', disabled: true },
        { id: 'orders', icon: 'fa-shopping-cart', label: 'Đơn hàng', disabled: true },
        { id: 'settings', icon: 'fa-cog', label: 'Cài đặt', disabled: true },
      ];

      return (
        <div className="sidebar d-none d-md-block">
          <div className="logo">
            <i className="fas fa-tractor me-2"></i> KTM Admin
          </div>
          <nav className="nav flex-column mt-3">
            {menus.map(menu => (
              <a
                key={menu.id}
                href="#"
                className={`nav-link ${activeMenu === menu.id ? 'active' : ''} ${menu.disabled ? 'opacity-50' : ''} ${menu.highlight ? 'text-warning' : ''}`}
                onClick={(e) => { e.preventDefault(); if (!menu.disabled) onMenuChange(menu.id); }}
              >
                <i className={`fas ${menu.icon}`}></i> {menu.label}
                {menu.disabled && <span className="badge bg-secondary ms-2">Soon</span>}
                {menu.highlight && <span className="badge bg-warning text-dark ms-2">HOT</span>}
              </a>
            ))}
          </nav>
          <div className="position-absolute bottom-0 w-100 p-3 border-top border-secondary">
            <div className="d-flex justify-content-between align-items-center">
              <a href="/" className="text-white-50 text-decoration-none small">
                <i className="fas fa-home me-1"></i> Trang chủ
              </a>
              {onLogout && (
                <button 
                  className="btn btn-sm btn-outline-danger"
                  onClick={onLogout}
                  title="Đăng xuất"
                >
                  <i className="fas fa-sign-out-alt"></i>
                </button>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Album List View
    function AlbumList({ albums, onSelect, onCreate, onDelete, loading }) {
      return (
        <div>
          <div className="d-flex justify-content-between align-items-center mb-4">
            <h4 className="m-0"><i className="fas fa-images me-2 text-warning"></i>Danh sách Album</h4>
            <button className="btn btn-warning" onClick={onCreate}>
              <i className="fas fa-plus me-2"></i>Tạo Album mới
            </button>
          </div>

          {loading ? (
            <div className="text-center py-5">
              <div className="spinner-border text-warning"></div>
            </div>
          ) : albums.length === 0 ? (
            <div className="text-center py-5">
              <i className="fas fa-folder-open fa-3x text-muted mb-3"></i>
              <p className="text-muted">Chưa có album nào. Hãy tạo album đầu tiên!</p>
            </div>
          ) : (
            <div className="row g-4">
              {albums.map(album => (
                <div key={album.id} className="col-md-4 col-lg-3">
                  <div className="card album-card h-100" onClick={() => onSelect(album)}>
                    <img 
                      src={album.cover || 'https://via.placeholder.com/300x150?text=No+Cover'} 
                      className="album-cover" 
                      alt={album.title}
                    />
                    <div className="card-body">
                      <h6 className="card-title mb-1">{album.title}</h6>
                      <small className="text-muted">{album.count || 0} ảnh</small>
                    </div>
                    <div className="card-footer bg-transparent border-0 pt-0">
                      <button 
                        className="btn btn-sm btn-outline-danger"
                        onClick={(e) => { e.stopPropagation(); onDelete(album); }}
                      >
                        <i className="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // Create/Edit Album Modal
    function AlbumModal({ show, album, onClose, onSave }) {
      const [formData, setFormData] = useState({ slug: '', title: '', description: '', cover_url: '' });
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        if (album) {
          setFormData({
            slug: album.id || '',
            title: album.title || '',
            description: album.description || '',
            cover_url: album.cover || ''
          });
        } else {
          setFormData({ slug: '', title: '', description: '', cover_url: '' });
        }
      }, [album, show]);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setSaving(true);
        await onSave(formData);
        setSaving(false);
      };

      const generateSlug = (title) => {
        return title
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[đĐ]/g, 'd')
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
      };

      if (!show) return null;

      return (
        <div className="modal show d-block" style={{ background: 'rgba(0,0,0,0.5)' }}>
          <div className="modal-dialog modal-dialog-centered">
            <div className="modal-content">
              <div className="modal-header">
                <h5 className="modal-title">{album ? 'Sửa Album' : 'Tạo Album mới'}</h5>
                <button type="button" className="btn-close" onClick={onClose}></button>
              </div>
              <form onSubmit={handleSubmit}>
                <div className="modal-body">
                  <div className="mb-3">
                    <label className="form-label">Tên Album *</label>
                    <input
                      type="text"
                      className="form-control"
                      value={formData.title}
                      onChange={(e) => setFormData({ 
                        ...formData, 
                        title: e.target.value,
                        slug: formData.slug || generateSlug(e.target.value)
                      })}
                      required
                    />
                  </div>
                  <div className="mb-3">
                    <label className="form-label">Slug (URL) *</label>
                    <input
                      type="text"
                      className="form-control"
                      value={formData.slug}
                      onChange={(e) => setFormData({ ...formData, slug: e.target.value })}
                      required
                      disabled={!!album}
                    />
                    <small className="text-muted">VD: may-cay-kubota-l1501</small>
                  </div>
                  <div className="mb-3">
                    <label className="form-label">Mô tả</label>
                    <textarea
                      className="form-control"
                      rows="2"
                      value={formData.description}
                      onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                    ></textarea>
                  </div>
                  <div className="mb-3">
                    <label className="form-label">URL ảnh bìa</label>
                    <input
                      type="url"
                      className="form-control"
                      value={formData.cover_url}
                      onChange={(e) => setFormData({ ...formData, cover_url: e.target.value })}
                      placeholder="https://..."
                    />
                  </div>
                </div>
                <div className="modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={onClose}>Hủy</button>
                  <button type="submit" className="btn btn-warning" disabled={saving}>
                    {saving ? <><span className="spinner-border spinner-border-sm me-2"></span>Đang lưu...</> : 'Lưu'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      );
    }

    // Album Detail View (manage images)
    function AlbumDetail({ album, onBack, onRefresh, showToast }) {
      const [images, setImages] = useState([]);
      const [loading, setLoading] = useState(true);
      const [uploading, setUploading] = useState(false);
      const [uploadFiles, setUploadFiles] = useState([]);
      const [uploadPreviews, setUploadPreviews] = useState([]);
      const [captions, setCaptions] = useState({});
      const fileInputRef = useRef(null);
      const dropZoneRef = useRef(null);

      useEffect(() => {
        loadImages();
      }, [album.id]);

      const loadImages = async () => {
        setLoading(true);
        try {
          const res = await fetch(`${API_BASE}/api/albums/${album.id}`);
          const data = await res.json();
          console.log('Album data:', data);
          console.log('Images:', data.images);
          setImages(data.images || []);
        } catch (err) {
          console.error(err);
          showToast('Lỗi tải ảnh', 'danger');
        }
        setLoading(false);
      };

      const handleFileSelect = (files) => {
        const newFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
        setUploadFiles(prev => [...prev, ...newFiles]);
        
        // Create previews
        newFiles.forEach(file => {
          const reader = new FileReader();
          reader.onload = (e) => {
            setUploadPreviews(prev => [...prev, { file, preview: e.target.result }]);
          };
          reader.readAsDataURL(file);
        });
      };

      const removeUploadFile = (index) => {
        setUploadFiles(prev => prev.filter((_, i) => i !== index));
        setUploadPreviews(prev => prev.filter((_, i) => i !== index));
      };

      const uploadToCloudinary = async (file) => {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        formData.append('folder', `ktm-albums/${album.id}`);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: formData
        });

        if (!res.ok) {
          const err = await res.json();
          console.error('Cloudinary error:', err);
          throw new Error(err.error?.message || 'Upload failed');
        }
        return await res.json();
      };

      const handleUpload = async () => {
        if (uploadFiles.length === 0) return;

        setUploading(true);
        let successCount = 0;

        for (let i = 0; i < uploadFiles.length; i++) {
          try {
            // Upload to Cloudinary
            const cloudinaryRes = await uploadToCloudinary(uploadFiles[i]);
            
            // Save to DB
            await fetch(`${API_BASE}/api/albums/${album.id}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                url: cloudinaryRes.secure_url,
                caption: captions[i] || uploadFiles[i].name.replace(/\.[^/.]+$/, ''),
                sort_order: images.length + i
              })
            });
            
            successCount++;
          } catch (err) {
            console.error('Upload error:', err);
          }
        }

        setUploading(false);
        setUploadFiles([]);
        setUploadPreviews([]);
        setCaptions({});
        
        if (successCount > 0) {
          showToast(`Đã upload ${successCount} ảnh thành công!`, 'success');
          loadImages();
          onRefresh();
        } else {
          showToast('Upload thất bại', 'danger');
        }
      };

      const deleteImage = async (imageId, index) => {
        if (!confirm('Xóa ảnh này?')) return;
        
        try {
          // Note: Cần API delete image - tạm thời chỉ reload
          await fetch(`${API_BASE}/api/images/${imageId}`, { method: 'DELETE' });
          showToast('Đã xóa ảnh', 'success');
          loadImages();
          onRefresh();
        } catch (err) {
          showToast('Lỗi xóa ảnh', 'danger');
        }
      };

      // Drag & Drop handlers
      const handleDragOver = (e) => {
        e.preventDefault();
        dropZoneRef.current?.classList.add('dragover');
      };

      const handleDragLeave = () => {
        dropZoneRef.current?.classList.remove('dragover');
      };

      const handleDrop = (e) => {
        e.preventDefault();
        dropZoneRef.current?.classList.remove('dragover');
        handleFileSelect(e.dataTransfer.files);
      };

      return (
        <div>
          <div className="d-flex align-items-center mb-4">
            <button className="btn btn-outline-secondary me-3" onClick={onBack}>
              <i className="fas fa-arrow-left"></i>
            </button>
            <div>
              <h4 className="m-0">{album.title}</h4>
              <small className="text-muted">{images.length} ảnh</small>
            </div>
          </div>

          {/* Upload Zone */}
          <div className="card mb-4">
            <div className="card-body">
              <h6 className="mb-3"><i className="fas fa-cloud-upload-alt me-2"></i>Upload ảnh mới</h6>
              
              <div 
                ref={dropZoneRef}
                className="upload-zone"
                onClick={() => fileInputRef.current?.click()}
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
              >
                <i className="fas fa-images fa-2x text-muted mb-2"></i>
                <p className="mb-0">Kéo thả ảnh vào đây hoặc click để chọn</p>
                <small className="text-muted">Hỗ trợ JPG, PNG, WebP</small>
                <input
                  ref={fileInputRef}
                  type="file"
                  multiple
                  accept="image/*"
                  onChange={(e) => handleFileSelect(e.target.files)}
                />
              </div>

              {uploadPreviews.length > 0 && (
                <div className="mt-3">
                  <div className="upload-preview">
                    {uploadPreviews.map((item, index) => (
                      <div key={index} className="upload-preview-item">
                        <img src={item.preview} alt="" />
                        <button className="remove" onClick={() => removeUploadFile(index)}>
                          <i className="fas fa-times"></i>
                        </button>
                      </div>
                    ))}
                  </div>
                  <div className="mt-3">
                    <button 
                      className="btn btn-warning"
                      onClick={handleUpload}
                      disabled={uploading}
                    >
                      {uploading ? (
                        <><span className="spinner-border spinner-border-sm me-2"></span>Đang upload...</>
                      ) : (
                        <><i className="fas fa-upload me-2"></i>Upload {uploadFiles.length} ảnh</>
                      )}
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Image Grid */}
          <div className="card">
            <div className="card-body">
              <h6 className="mb-3"><i className="fas fa-th me-2"></i>Ảnh trong album</h6>
              
              {loading ? (
                <div className="text-center py-4">
                  <div className="spinner-border text-warning"></div>
                </div>
              ) : images.length === 0 ? (
                <div className="text-center py-4 text-muted">
                  <i className="fas fa-image fa-2x mb-2"></i>
                  <p>Chưa có ảnh nào trong album này</p>
                </div>
              ) : (
                <div className="image-grid">
                  {images.map((img, index) => (
                    <div key={index} className="image-item">
                      <img src={img.src} alt={img.caption} />
                      <div className="actions">
                        <button 
                          className="btn btn-sm btn-danger"
                          onClick={() => deleteImage(img.id, index)}
                        >
                          <i className="fas fa-trash"></i>
                        </button>
                      </div>
                      {img.caption && (
                        <div className="p-2 bg-light small text-truncate">{img.caption}</div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ==================== SEARCH CENTER - TRA CỨU NHANH ====================
    
    function SearchCenter({ showToast }) {
      const [searchQuery, setSearchQuery] = useState('');
      const [searchResults, setSearchResults] = useState([]);
      const [allData, setAllData] = useState([]);
      const [categories, setCategories] = useState([]);
      const [selectedCategory, setSelectedCategory] = useState('all');
      const [allFields, setAllFields] = useState([]);
      const [copiedId, setCopiedId] = useState(null);
      const [viewMode, setViewMode] = useState('grid'); // grid | list
      const [loading, setLoading] = useState(true);
      const [albums, setAlbums] = useState([]);
      const [videoFolders, setVideoFolders] = useState([]);
      const searchInputRef = useRef(null);
      
      // AI Chat states
      const [showAIChat, setShowAIChat] = useState(false);
      const [aiMessages, setAiMessages] = useState([
        { role: 'assistant', content: 'Xin chào! Tôi là trợ lý AI của KTM. Hãy hỏi tôi về sản phẩm, giá cả, combo... Ví dụ:\n- "Giá van 2 tay bao nhiêu?"\n- "Combo nào rẻ nhất?"\n- "Sản phẩm nào có freeship?"', attachments: [] }
      ]);
      const [aiInput, setAiInput] = useState('');
      const [aiLoading, setAiLoading] = useState(false);
      const chatEndRef = useRef(null);
      
      // Modal state for image preview
      const [previewImage, setPreviewImage] = useState(null);

      // Load data từ nhiều nguồn
      useEffect(() => {
        const loadAllData = async () => {
          setLoading(true);
          
          // 1. Load products từ searchData.js (đã có sẵn global SEARCH_PRODUCTS)
          let products = [];
          if (typeof SEARCH_PRODUCTS !== 'undefined') {
            products = SEARCH_PRODUCTS.map(p => ({
              ...p,
              _type: 'product',
              _source: 'searchData'
            }));
          }

          // 2. Load albums từ API
          let albumsData = [];
          try {
            const res = await fetch(`${API_BASE}/api/albums`);
            if (res.ok) {
              const data = await res.json();
              albumsData = data.map(a => ({
                id: a.id,
                name: a.name,
                description: a.description,
                image: a.coverUrl,
                photoCount: a.photoCount,
                _type: 'album',
                _source: 'database'
              }));
              setAlbums(data);
            }
          } catch (err) {
            console.error('Error loading albums:', err);
          }

          // 3. Load video folders từ API
          let videosData = [];
          try {
            const res = await fetch(`${API_BASE}/api/video-folders?withVideos=true`);
            if (res.ok) {
              const data = await res.json();
              setVideoFolders(data);
              
              // Flatten videos
              data.forEach(folder => {
                if (folder.videos) {
                  folder.videos.forEach(v => {
                    videosData.push({
                      id: v.id,
                      name: v.title,
                      folder: folder.name,
                      image: v.thumb,
                      youtubeId: v.youtubeId,
                      url: v.url,
                      _type: 'video',
                      _source: 'database'
                    });
                  });
                }
              });
            }
          } catch (err) {
            console.error('Error loading videos:', err);
          }

          // Combine all data
          const combined = [...products, ...albumsData, ...videosData];
          setAllData(combined);
          setSearchResults(combined);

          // Extract unique categories
          const cats = [...new Set(combined.map(item => item.category || item._type))];
          setCategories(cats);

          // Extract all unique fields (for dynamic display)
          const fields = new Set();
          combined.forEach(item => {
            Object.keys(item).forEach(key => {
              if (!key.startsWith('_')) fields.add(key);
            });
          });
          setAllFields([...fields]);

          setLoading(false);
        };

        loadAllData();
        
        // Focus search input
        setTimeout(() => searchInputRef.current?.focus(), 100);
      }, []);

      // Search function - flexible matching
      const handleSearch = (query) => {
        setSearchQuery(query);
        
        if (!query.trim()) {
          filterByCategory(selectedCategory);
          return;
        }

        const lowerQuery = query.toLowerCase();
        const words = lowerQuery.split(/\s+/).filter(w => w.length > 0);

        const results = allData.filter(item => {
          // Search through ALL fields
          const searchableText = Object.entries(item)
            .filter(([key]) => !key.startsWith('_'))
            .map(([, value]) => String(value || '').toLowerCase())
            .join(' ');

          // All words must match somewhere
          return words.every(word => searchableText.includes(word));
        });

        // Apply category filter
        if (selectedCategory !== 'all') {
          const filtered = results.filter(item => 
            (item.category || item._type) === selectedCategory
          );
          setSearchResults(filtered);
        } else {
          setSearchResults(results);
        }
      };

      // Filter by category
      const filterByCategory = (cat) => {
        setSelectedCategory(cat);
        
        let filtered = allData;
        if (cat !== 'all') {
          filtered = allData.filter(item => 
            (item.category || item._type) === cat
          );
        }

        if (searchQuery.trim()) {
          const lowerQuery = searchQuery.toLowerCase();
          const words = lowerQuery.split(/\s+/).filter(w => w.length > 0);
          filtered = filtered.filter(item => {
            const searchableText = Object.entries(item)
              .filter(([key]) => !key.startsWith('_'))
              .map(([, value]) => String(value || '').toLowerCase())
              .join(' ');
            return words.every(word => searchableText.includes(word));
          });
        }

        setSearchResults(filtered);
      };

      // Copy helpers
      const copyText = (text, id) => {
        navigator.clipboard.writeText(text).then(() => {
          setCopiedId(id);
          showToast('Đã copy!', 'success');
          setTimeout(() => setCopiedId(null), 1500);
        });
      };

      const copyImage = async (url, id) => {
        try {
          const response = await fetch(url);
          const blob = await response.blob();
          await navigator.clipboard.write([
            new ClipboardItem({ [blob.type]: blob })
          ]);
          setCopiedId(id + '-img');
          showToast('Đã copy ảnh!', 'success');
          setTimeout(() => setCopiedId(null), 1500);
        } catch (err) {
          // Fallback: copy URL
          copyText(url, id + '-img');
        }
      };

      // Find matching items from message
      const findMatchingItems = (message) => {
        const lowerMsg = message.toLowerCase();
        const words = lowerMsg.split(/\s+/).filter(w => w.length > 1);
        
        return allData.filter(item => {
          const text = Object.values(item)
            .filter(v => typeof v === 'string')
            .join(' ')
            .toLowerCase();
          return words.some(word => text.includes(word));
        }).slice(0, 4); // Max 4 items
      };

      // AI Chat function - Local AI using data context
      const handleAIChat = async (message) => {
        if (!message.trim()) return;
        
        // Add user message
        const userMsg = { role: 'user', content: message, attachments: [] };
        setAiMessages(prev => [...prev, userMsg]);
        setAiInput('');
        setAiLoading(true);

        // Find matching items to attach
        const matchedItems = findMatchingItems(message);

        // Scroll to bottom
        setTimeout(() => chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);

        try {
          // Build context from allData
          const dataContext = allData.map(item => {
            const fields = Object.entries(item)
              .filter(([k]) => !k.startsWith('_'))
              .map(([k, v]) => `${k}: ${v}`)
              .join(', ');
            return fields;
          }).join('\n');

          // Call backend API
          const response = await fetch(`${API_BASE}/api/ai-chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: message,
              context: dataContext
            })
          });

          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || 'API error');
          }
          
          const aiResponse = data.response || 'Xin lỗi, tôi không thể trả lời lúc này.';
          
          // Attach matching items with images/videos
          setAiMessages(prev => [...prev, { 
            role: 'assistant', 
            content: aiResponse,
            attachments: matchedItems
          }]);
        } catch (err) {
          console.error('AI Error:', err);
          
          // Fallback: Simple local search
          const lowerMsg = message.toLowerCase();
          const matches = allData.filter(item => {
            const text = Object.values(item).join(' ').toLowerCase();
            return lowerMsg.split(' ').some(word => text.includes(word));
          });

          let fallbackResponse = '';
          if (matches.length > 0) {
            fallbackResponse = `Tìm thấy ${matches.length} sản phẩm liên quan:\n\n`;
            matches.slice(0, 5).forEach(item => {
              fallbackResponse += `• ${item.name}`;
              if (item.price) fallbackResponse += ` - ${item.price}`;
              if (item.note) fallbackResponse += ` (${item.note})`;
              fallbackResponse += '\n';
            });
            if (matches.length > 5) fallbackResponse += `\n...và ${matches.length - 5} sản phẩm khác`;
          } else {
            fallbackResponse = 'Không tìm thấy sản phẩm phù hợp. Hãy thử từ khóa khác như "van", "combo", "xy lanh"...';
          }
          
          setAiMessages(prev => [...prev, { 
            role: 'assistant', 
            content: fallbackResponse,
            attachments: matches.slice(0, 4)
          }]);
        }

        setAiLoading(false);
        setTimeout(() => chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
      };

      // Render item card
      const renderItemCard = (item, index) => {
        const isProduct = item._type === 'product';
        const isAlbum = item._type === 'album';
        const isVideo = item._type === 'video';

        return (
          <div key={item.id || index} className={viewMode === 'grid' ? 'col-6 col-md-4 col-lg-3' : 'col-12'}>
            <div className={`card h-100 shadow-sm ${viewMode === 'list' ? 'd-flex flex-row' : ''}`}>
              {/* Image */}
              {item.image && (
                <div className={`position-relative ${viewMode === 'list' ? '' : ''}`} style={viewMode === 'list' ? { width: 120 } : {}}>
                  <img 
                    src={item.image} 
                    alt={item.name}
                    className={`${viewMode === 'grid' ? 'card-img-top' : 'rounded-start'}`}
                    style={{ 
                      height: viewMode === 'grid' ? 150 : 100,
                      width: viewMode === 'list' ? 120 : '100%',
                      objectFit: 'cover',
                      cursor: 'pointer'
                    }}
                    onClick={() => setPreviewImage({ url: item.image, name: item.name, price: item.price })}
                  />
                  <button
                    className={`btn btn-sm position-absolute ${copiedId === item.id + '-img' ? 'btn-success' : 'btn-light'}`}
                    style={{ top: 5, right: 5, opacity: 0.9 }}
                    onClick={() => copyImage(item.image, item.id)}
                    title="Copy ảnh"
                  >
                    <i className={`fas ${copiedId === item.id + '-img' ? 'fa-check' : 'fa-copy'}`}></i>
                  </button>
                  {/* Type badge */}
                  <span className={`badge position-absolute ${isProduct ? 'bg-primary' : isAlbum ? 'bg-success' : 'bg-danger'}`} style={{ top: 5, left: 5 }}>
                    {isProduct ? 'Sản phẩm' : isAlbum ? 'Album' : 'Video'}
                  </span>
                </div>
              )}
              
              {/* Content */}
              <div className={`card-body ${viewMode === 'list' ? 'flex-grow-1' : ''} p-2`}>
                <h6 className="card-title mb-1 small fw-bold">{item.name}</h6>
                
                {/* Dynamic fields display */}
                <div className="small text-muted">
                  {item.price && (
                    <div className="d-flex justify-content-between align-items-center">
                      <span className="text-danger fw-bold">{item.price}</span>
                      <button
                        className={`btn btn-sm p-0 ${copiedId === item.id + '-price' ? 'text-success' : 'text-muted'}`}
                        onClick={() => copyText(item.price, item.id + '-price')}
                        title="Copy giá"
                      >
                        <i className={`fas ${copiedId === item.id + '-price' ? 'fa-check' : 'fa-copy'}`}></i>
                      </button>
                    </div>
                  )}
                  {item.code && <div><small className="text-muted">Mã: {item.code}</small></div>}
                  {item.category && <div><small className="badge bg-light text-dark">{item.category}</small></div>}
                  {item.note && <div><small className="text-info"><i className="fas fa-info-circle me-1"></i>{item.note}</small></div>}
                  {item.folder && <div><small className="text-muted">Folder: {item.folder}</small></div>}
                  {item.photoCount && <div><small className="text-muted">{item.photoCount} ảnh</small></div>}
                  
                  {/* Show any extra fields dynamically */}
                  {Object.entries(item).map(([key, value]) => {
                    if (['id', 'name', 'price', 'image', 'code', 'category', 'note', 'folder', 'photoCount', 'description', 'youtubeId', 'url'].includes(key)) return null;
                    if (key.startsWith('_')) return null;
                    if (!value) return null;
                    return (
                      <div key={key}>
                        <small className="text-muted">{key}: {String(value)}</small>
                      </div>
                    );
                  })}
                </div>

                {/* Quick actions */}
                <div className="mt-2 d-flex gap-1 flex-wrap">
                  <button
                    className={`btn btn-sm ${copiedId === item.id + '-name' ? 'btn-success' : 'btn-outline-secondary'}`}
                    onClick={() => copyText(item.name, item.id + '-name')}
                    title="Copy tên"
                  >
                    <i className="fas fa-font"></i>
                  </button>
                  {item.price && (
                    <button
                      className={`btn btn-sm ${copiedId === item.id + '-price2' ? 'btn-success' : 'btn-outline-danger'}`}
                      onClick={() => copyText(item.price, item.id + '-price2')}
                      title="Copy giá"
                    >
                      <i className="fas fa-tag"></i>
                    </button>
                  )}
                  {item.image && (
                    <button
                      className={`btn btn-sm ${copiedId === item.id + '-url' ? 'btn-success' : 'btn-outline-primary'}`}
                      onClick={() => copyText(item.image, item.id + '-url')}
                      title="Copy link ảnh"
                    >
                      <i className="fas fa-link"></i>
                    </button>
                  )}
                  {isVideo && item.youtubeId && (
                    <button
                      className={`btn btn-sm ${copiedId === item.id + '-yt' ? 'btn-success' : 'btn-outline-danger'}`}
                      onClick={() => copyText(`https://www.youtube.com/watch?v=${item.youtubeId}`, item.id + '-yt')}
                      title="Copy link YouTube"
                    >
                      <i className="fab fa-youtube"></i>
                    </button>
                  )}
                  {/* Copy all info */}
                  <button
                    className={`btn btn-sm ${copiedId === item.id + '-all' ? 'btn-success' : 'btn-outline-warning'}`}
                    onClick={() => {
                      const info = Object.entries(item)
                        .filter(([k]) => !k.startsWith('_') && item[k])
                        .map(([k, v]) => `${k}: ${v}`)
                        .join('\n');
                      copyText(info, item.id + '-all');
                    }}
                    title="Copy tất cả thông tin"
                  >
                    <i className="fas fa-clipboard-list"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div>
          {/* Search Header */}
          <div className="sticky-top bg-white shadow-sm p-3 mb-3 rounded" style={{ zIndex: 100 }}>
            <h4 className="m-0 text-warning mb-3">
              <i className="fas fa-search me-2"></i>Tra cứu nhanh
            </h4>

            {/* Main search input */}
            <div className="input-group input-group-lg">
              <span className="input-group-text bg-warning border-warning">
                <i className="fas fa-search text-dark"></i>
              </span>
              <input
                ref={searchInputRef}
                type="text"
                className="form-control border-warning"
                placeholder="Gõ tên sản phẩm, mã, giá, ghi chú... (VD: van 2 tay, combo, freeship)"
                value={searchQuery}
                onChange={(e) => handleSearch(e.target.value)}
                autoFocus
              />
              {searchQuery && (
<button
                  className="btn btn-outline-secondary"
                  onClick={() => { setSearchQuery(''); handleSearch(''); }}
                >
                  <i className="fas fa-times"></i>
                </button>
              )}
            </div>

            {/* View mode toggle */}
            <div className="d-flex justify-content-between align-items-center">
              <small className="text-muted">{searchResults.length} kết quả</small>
              <div className="btn-group btn-group-sm">
                <button 
                  className={`btn ${viewMode === 'grid' ? 'btn-warning' : 'btn-outline-secondary'}`}
                  onClick={() => setViewMode('grid')}
                >
                  <i className="fas fa-th-large"></i>
                </button>
                <button 
                  className={`btn ${viewMode === 'list' ? 'btn-warning' : 'btn-outline-secondary'}`}
                  onClick={() => setViewMode('list')}
                >
                  <i className="fas fa-list"></i>
                </button>
              </div>
            </div>
          </div>

          {/* Results */}
          {loading ? (
            <div className="text-center py-5">
              <div className="spinner-border text-warning"></div>
              <p className="mt-2 text-muted">Đang tải dữ liệu...</p>
            </div>
          ) : searchResults.length === 0 ? (
            <div className="text-center py-5">
              <i className="fas fa-search fa-3x text-muted mb-3"></i>
              <p className="text-muted">Không tìm thấy kết quả cho "{searchQuery}"</p>
              <button className="btn btn-outline-warning" onClick={() => { setSearchQuery(''); handleSearch(''); }}>
                Xem tất cả
              </button>
            </div>
          ) : (
            <div className="row g-3">
              {searchResults.map((item, index) => renderItemCard(item, index))}
            </div>
          )}

          {/* Keyboard shortcuts hint */}
          <div className="fixed-bottom bg-dark text-white p-2 d-none d-md-block" style={{ left: 250 }}>
            <small>
              <i className="fas fa-keyboard me-2"></i>
              Bấm vào ô tìm kiếm để bắt đầu | Copy nhanh: click các nút bên cạnh thông tin
            </small>
          </div>

          {/* AI Chat Button */}
          <button
            className="btn btn-warning btn-lg rounded-circle position-fixed shadow-lg"
            style={{ bottom: 60, right: 30, width: 60, height: 60, zIndex: 1000 }}
            onClick={() => setShowAIChat(!showAIChat)}
            title="Hỏi AI"
          >
            <i className={`fas ${showAIChat ? 'fa-times' : 'fa-robot'} fa-lg`}></i>
          </button>

          {/* AI Chat Panel */}
          {showAIChat && (
            <div 
              className="position-fixed bg-white rounded-3 shadow-lg d-flex flex-column"
              style={{ 
                bottom: 130, 
                right: 30, 
                width: 380, 
                height: 500, 
                zIndex: 1001,
                maxWidth: 'calc(100vw - 60px)',
                maxHeight: 'calc(100vh - 200px)'
              }}
            >
              {/* Chat Header */}
              <div className="bg-warning text-dark p-3 rounded-top-3 d-flex justify-content-between align-items-center">
                <div>
                  <i className="fas fa-robot me-2"></i>
                  <strong>KTM AI Assistant</strong>
                </div>
                <button className="btn btn-sm btn-outline-dark" onClick={() => setShowAIChat(false)}>
                  <i className="fas fa-times"></i>
                </button>
              </div>

              {/* Chat Messages */}
              <div className="flex-grow-1 overflow-auto p-3" style={{ background: '#f8f9fa' }}>
                {aiMessages.map((msg, i) => (
                  <div key={i} className={`mb-3 ${msg.role === 'user' ? 'd-flex justify-content-end' : ''}`}>
                    <div 
                      className={`p-2 px-3 rounded-3 ${msg.role === 'user' ? 'bg-warning text-dark' : 'bg-white border'}`}
                      style={{ maxWidth: '85%', whiteSpace: 'pre-wrap', display: 'inline-block' }}
                    >
                      {msg.role === 'assistant' && <i className="fas fa-robot me-1 text-muted"></i>}
                      {msg.content}
                      
                      {/* Attachments - Images/Videos */}
                      {msg.attachments && msg.attachments.length > 0 && (
                        <div className="mt-2 d-flex flex-wrap gap-2">
                          {msg.attachments.map((item, idx) => (
                            <div key={idx} className="position-relative" style={{ width: 80 }}>
                              {/* Image */}
                              {item.image && (
                                <img 
                                  src={item.image} 
                                  alt={item.name}
                                  className="rounded border"
                                  style={{ width: 80, height: 60, objectFit: 'cover', cursor: 'pointer' }}
                                  onClick={() => setPreviewImage({ url: item.image, name: item.name, price: item.price })}
                                />
                              )}
                              {/* Video indicator */}
                              {item._type === 'video' && (
                                <div className="position-absolute top-0 end-0">
                                  <span className="badge bg-danger" style={{ fontSize: 8 }}>
                                    <i className="fab fa-youtube"></i>
                                  </span>
                                </div>
                              )}
                              {/* Name */}
                              <div className="small text-truncate" style={{ fontSize: 10 }} title={item.name}>
                                {item.name}
                              </div>
                              {/* Quick actions */}
                              <div className="d-flex gap-1 mt-1">
                                {item.image && (
                                  <button
                                    className="btn btn-outline-secondary p-0"
                                    style={{ width: 20, height: 20, fontSize: 9 }}
                                    onClick={() => copyText(item.image, `ai-${item.id}-img`)}
                                    title="Copy link ảnh"
                                  >
                                    <i className={`fas ${copiedId === `ai-${item.id}-img` ? 'fa-check text-success' : 'fa-link'}`}></i>
                                  </button>
                                )}
                                {item._type === 'video' && item.youtubeId && (
                                  <button
                                    className="btn btn-outline-danger p-0"
                                    style={{ width: 20, height: 20, fontSize: 9 }}
                                    onClick={() => copyText(`https://www.youtube.com/watch?v=${item.youtubeId}`, `ai-${item.id}-yt`)}
                                    title="Copy link YouTube"
                                  >
                                    <i className={`fab ${copiedId === `ai-${item.id}-yt` ? 'fa-check text-success' : 'fa-youtube'}`}></i>
                                  </button>
                                )}
                                {item.price && (
                                  <button
                                    className="btn btn-outline-warning p-0"
                                    style={{ width: 20, height: 20, fontSize: 9 }}
                                    onClick={() => copyText(item.price, `ai-${item.id}-price`)}
                                    title="Copy giá"
                                  >
                                    <i className={`fas ${copiedId === `ai-${item.id}-price` ? 'fa-check text-success' : 'fa-tag'}`}></i>
                                  </button>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
                {aiLoading && (
                  <div className="d-flex justify-content-start mb-3">
                    <div className="bg-white border p-2 px-3 rounded-3">
                      <i className="fas fa-robot me-1 text-muted"></i>
                      <span className="spinner-border spinner-border-sm me-2"></span>
                      Đang suy nghĩ...
                    </div>
                  </div>
                )}
                <div ref={chatEndRef}></div>
              </div>

              {/* Quick suggestions */}
              <div className="px-3 py-2 border-top d-flex gap-1 flex-wrap">
                {['Giá van 2 tay?', 'Combo rẻ nhất?', 'Sản phẩm freeship?'].map(q => (
                  <button
                    key={q}
                    className="btn btn-sm btn-outline-secondary"
                    onClick={() => handleAIChat(q)}
                    disabled={aiLoading}
                  >
                    {q}
                  </button>
                ))}
              </div>

              {/* Chat Input */}
              <div className="p-3 border-top">
                <form onSubmit={(e) => { e.preventDefault(); handleAIChat(aiInput); }}>
                  <div className="input-group">
                    <input
                      type="text"
                      className="form-control"
                      placeholder="Hỏi về sản phẩm, giá cả..."
                      value={aiInput}
                      onChange={(e) => setAiInput(e.target.value)}
                      disabled={aiLoading}
                    />
                    <button 
                      className="btn btn-warning" 
                      type="submit"
                      disabled={aiLoading || !aiInput.trim()}
                    >
                      <i className="fas fa-paper-plane"></i>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {/* Image Preview Modal */}
          {previewImage && (
            <div 
              className="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
              style={{ background: 'rgba(0,0,0,0.9)', zIndex: 2000 }}
              onClick={() => setPreviewImage(null)}
            >
              <div className="text-center" onClick={(e) => e.stopPropagation()}>
                <img 
                  src={previewImage.url} 
                  alt={previewImage.name}
                  style={{ maxWidth: '90vw', maxHeight: '80vh', objectFit: 'contain' }}
                  className="rounded shadow"
                />
                <div className="mt-3 text-white">
                  <h5>{previewImage.name}</h5>
                  {previewImage.price && <p className="text-warning fs-4">{previewImage.price}</p>}
                  <div className="d-flex justify-content-center gap-2 mt-2">
                    <button 
                      className={`btn ${copiedId === 'preview-img' ? 'btn-success' : 'btn-outline-light'}`}
                      onClick={() => copyText(previewImage.url, 'preview-img')}
                    >
                      <i className={`fas ${copiedId === 'preview-img' ? 'fa-check' : 'fa-link'} me-1`}></i>
                      Copy link ảnh
                    </button>
                    <button 
                      className="btn btn-outline-light"
                      onClick={() => {
                        const a = document.createElement('a');
                        a.href = previewImage.url;
                        a.download = previewImage.name || 'image';
                        a.target = '_blank';
                        a.click();
                      }}
                    >
                      <i className="fas fa-download me-1"></i>
                      Tải xuống
                    </button>
                    <button 
                      className="btn btn-light"
                      onClick={() => setPreviewImage(null)}
                    >
                      <i className="fas fa-times me-1"></i>
                      Đóng
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ==================== VIDEO MANAGEMENT ====================
    
    // Video List View - Tổ chức theo Folder với Drag & Drop
    function VideoList({ onRefresh, showToast }) {
      const [folders, setFolders] = useState([]);
      const [videos, setVideos] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedFolder, setSelectedFolder] = useState(null);
      const [showFolderModal, setShowFolderModal] = useState(false);
      const [editingFolder, setEditingFolder] = useState(null);
      const [showVideoModal, setShowVideoModal] = useState(false);
      const [editingVideo, setEditingVideo] = useState(null);
      const [draggedItem, setDraggedItem] = useState(null);
      const [dragOverItem, setDragOverItem] = useState(null);

      useEffect(() => {
        loadFolders();
      }, []);

      const loadFolders = async () => {
        setLoading(true);
        try {
          const res = await fetch(`${API_BASE}/api/video-folders?withVideos=true`);
          const data = await res.json();
          setFolders(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error(err);
          showToast('Lỗi tải danh sách folder', 'danger');
        }
        setLoading(false);
      };

      const loadVideosInFolder = async (folderId) => {
        try {
          const res = await fetch(`${API_BASE}/api/videos?folderId=${folderId}`);
          const data = await res.json();
          setVideos(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error(err);
        }
      };

      // Drag & Drop for Folders
      const handleFolderDragStart = (e, folder, index) => {
        setDraggedItem({ type: 'folder', item: folder, index });
        e.dataTransfer.effectAllowed = 'move';
        e.target.style.opacity = '0.5';
      };

      const handleFolderDragEnd = (e) => {
        e.target.style.opacity = '1';
        setDraggedItem(null);
        setDragOverItem(null);
      };

      const handleFolderDragOver = (e, index) => {
        e.preventDefault();
        if (draggedItem?.type === 'folder' && draggedItem.index !== index) {
          setDragOverItem(index);
        }
      };

      const handleFolderDrop = async (e, targetIndex) => {
        e.preventDefault();
        if (!draggedItem || draggedItem.type !== 'folder') return;

        const sourceIndex = draggedItem.index;
        if (sourceIndex === targetIndex) return;

        // Reorder folders locally
        const newFolders = [...folders];
        const [removed] = newFolders.splice(sourceIndex, 1);
        newFolders.splice(targetIndex, 0, removed);
        setFolders(newFolders);

        // Update sort_order in DB
        try {
          await Promise.all(newFolders.map((folder, idx) => 
            fetch(`${API_BASE}/api/video-folders/${folder.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sortOrder: idx })
            })
          ));
          showToast('Đã cập nhật thứ tự!', 'success');
        } catch (err) {
          showToast('Lỗi cập nhật thứ tự', 'danger');
          loadFolders(); // Reload on error
        }

        setDraggedItem(null);
        setDragOverItem(null);
      };

      // Drag & Drop for Videos
      const handleVideoDragStart = (e, video, index) => {
        setDraggedItem({ type: 'video', item: video, index });
        e.dataTransfer.effectAllowed = 'move';
        e.target.style.opacity = '0.5';
      };

      const handleVideoDragEnd = (e) => {
        e.target.style.opacity = '1';
        setDraggedItem(null);
        setDragOverItem(null);
      };

      const handleVideoDragOver = (e, index) => {
        e.preventDefault();
        if (draggedItem?.type === 'video' && draggedItem.index !== index) {
          setDragOverItem(index);
        }
      };

      const handleVideoDrop = async (e, targetIndex) => {
        e.preventDefault();
        if (!draggedItem || draggedItem.type !== 'video') return;

        const sourceIndex = draggedItem.index;
        if (sourceIndex === targetIndex) return;

        // Reorder videos locally
        const newVideos = [...videos];
        const [removed] = newVideos.splice(sourceIndex, 1);
        newVideos.splice(targetIndex, 0, removed);
        setVideos(newVideos);

        // Update sort_order in DB
        try {
          await Promise.all(newVideos.map((video, idx) => 
            fetch(`${API_BASE}/api/videos/${video.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sort_order: idx })
            })
          ));
          showToast('Đã cập nhật thứ tự!', 'success');
        } catch (err) {
          showToast('Lỗi cập nhật thứ tự', 'danger');
          loadVideosInFolder(selectedFolder.id);
        }

        setDraggedItem(null);
        setDragOverItem(null);
      };

      // Folder handlers
      const handleCreateFolder = () => {
        setEditingFolder(null);
        setShowFolderModal(true);
      };

      const handleEditFolder = (folder) => {
        setEditingFolder(folder);
        setShowFolderModal(true);
      };

      const handleSaveFolder = async (formData) => {
        try {
          const url = editingFolder 
            ? `${API_BASE}/api/video-folders/${editingFolder.id}`
            : `${API_BASE}/api/video-folders`;
          
          const res = await fetch(url, {
            method: editingFolder ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });

          if (!res.ok) throw new Error('Lỗi lưu folder');

          showToast(editingFolder ? 'Đã cập nhật folder!' : 'Đã tạo folder mới!', 'success');
          setShowFolderModal(false);
          loadFolders();
        } catch (err) {
          showToast(err.message, 'danger');
        }
      };

      const handleDeleteFolder = async (folder) => {
        if (!confirm(`Xóa folder "${folder.name}"? Videos trong folder sẽ không bị xóa.`)) return;

        try {
          await fetch(`${API_BASE}/api/video-folders/${folder.id}`, { method: 'DELETE' });
          showToast('Đã xóa folder', 'success');
          setSelectedFolder(null);
          loadFolders();
        } catch (err) {
          showToast('Lỗi xóa folder', 'danger');
        }
      };

      const handleSelectFolder = (folder) => {
        setSelectedFolder(folder);
        setVideos(folder.videos || []);
      };

      // Video handlers
      const handleCreateVideo = () => {
        setEditingVideo(null);
        setShowVideoModal(true);
      };

      const handleEditVideo = (video) => {
        setEditingVideo(video);
        setShowVideoModal(true);
      };

      const handleSaveVideo = async (formData) => {
        try {
          // Add folder_id
          formData.folder_id = selectedFolder?.id;
          
          const url = editingVideo 
            ? `${API_BASE}/api/videos/${editingVideo.id}`
            : `${API_BASE}/api/videos`;
          
          const res = await fetch(url, {
            method: editingVideo ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Lỗi lưu video');
          }

          showToast(editingVideo ? 'Cập nhật thành công!' : 'Thêm video thành công!', 'success');
          setShowVideoModal(false);
          loadFolders();
          if (selectedFolder) {
            loadVideosInFolder(selectedFolder.id);
          }
        } catch (err) {
          showToast(err.message, 'danger');
        }
      };

      const handleDeleteVideo = async (video) => {
        if (!confirm(`Xóa video "${video.title}"?`)) return;

        try {
          await fetch(`${API_BASE}/api/videos/${video.id}`, { method: 'DELETE' });
          showToast('Đã xóa video', 'success');
          loadFolders();
          if (selectedFolder) {
            loadVideosInFolder(selectedFolder.id);
          }
        } catch (err) {
          showToast('Lỗi xóa video', 'danger');
        }
      };

      const copyLink = (video) => {
        const url = `https://www.youtube.com/watch?v=${video.youtubeId}`;
        navigator.clipboard.writeText(url).then(() => {
          showToast('Đã copy link!', 'success');
        }).catch(() => {
          showToast('Không thể copy link', 'danger');
        });
      };

      // Folder List View
      if (!selectedFolder) {
        return (
          <div>
            <div className="d-flex justify-content-between align-items-center mb-4">
              <h4 className="m-0"><i className="fas fa-video me-2 text-warning"></i>Quản lý Video</h4>
              <button className="btn btn-warning" onClick={handleCreateFolder}>
                <i className="fas fa-folder-plus me-2"></i>Tạo Folder
              </button>
            </div>

            <p className="text-muted small mb-3">
              <i className="fas fa-info-circle me-1"></i>
              Kéo thả để sắp xếp thứ tự folders
            </p>

            {loading ? (
              <div className="text-center py-5">
                <div className="spinner-border text-warning"></div>
              </div>
            ) : folders.length === 0 ? (
              <div className="text-center py-5">
                <i className="fas fa-folder-open fa-3x text-muted mb-3"></i>
                <p className="text-muted">Chưa có folder video nào</p>
                <button className="btn btn-warning" onClick={handleCreateFolder}>
                  <i className="fas fa-plus me-2"></i>Tạo folder đầu tiên
                </button>
              </div>
            ) : (
              <div className="row g-4">
                {folders.map((folder, index) => (
                  <div 
                    key={folder.id} 
                    className="col-md-4 col-lg-3"
                    draggable
                    onDragStart={(e) => handleFolderDragStart(e, folder, index)}
                    onDragEnd={handleFolderDragEnd}
                    onDragOver={(e) => handleFolderDragOver(e, index)}
                    onDrop={(e) => handleFolderDrop(e, index)}
                  >
                    <div 
                      className={`card h-100 folder-card ${dragOverItem === index ? 'border-warning border-2' : ''}`} 
                      style={{ cursor: 'grab' }}
                    >
                      <div className="card-header bg-transparent py-1 text-center">
                        <i className="fas fa-grip-lines text-muted"></i>
                      </div>
                      <div 
                        className="card-body text-center py-3"
                        onClick={() => handleSelectFolder(folder)}
                        style={{ cursor: 'pointer' }}
                      >
                        <i className={`fas fa-folder fa-3x mb-3 ${folder.slug === 'shorts' ? 'text-danger' : 'text-warning'}`}></i>
                        <h5 className="card-title">{folder.name}</h5>
                        <p className="text-muted mb-0">
                          <i className="fas fa-video me-1"></i>
                          {folder.videoCount || folder.videos?.length || 0} videos
                        </p>
                      </div>
                      <div className="card-footer bg-transparent border-0">
                        <div className="btn-group btn-group-sm w-100">
                          <button className="btn btn-outline-secondary" onClick={(e) => { e.stopPropagation(); handleEditFolder(folder); }}>
                            <i className="fas fa-edit"></i> Sửa
                          </button>
                          <button className="btn btn-outline-danger" onClick={(e) => { e.stopPropagation(); handleDeleteFolder(folder); }}>
                            <i className="fas fa-trash"></i> Xóa
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            <VideoFolderModal
              show={showFolderModal}
              folder={editingFolder}
              onClose={() => setShowFolderModal(false)}
              onSave={handleSaveFolder}
            />
          </div>
        );
      }

      // Video List in Folder
      return (
        <div>
          <div className="d-flex justify-content-between align-items-center mb-4">
            <div className="d-flex align-items-center">
              <button className="btn btn-outline-secondary me-3" onClick={() => setSelectedFolder(null)}>
                <i className="fas fa-arrow-left"></i>
              </button>
              <h4 className="m-0">
                <i className={`fas fa-folder-open me-2 ${selectedFolder.slug === 'shorts' ? 'text-danger' : 'text-warning'}`}></i>
                {selectedFolder.name}
              </h4>
            </div>
            <button className="btn btn-warning" onClick={handleCreateVideo}>
              <i className="fas fa-plus me-2"></i>Thêm Video
            </button>
          </div>

          <p className="text-muted small mb-3">
            <i className="fas fa-info-circle me-1"></i>
            Kéo thả để sắp xếp thứ tự videos
          </p>

          {videos.length === 0 ? (
            <div className="text-center py-5">
              <i className="fas fa-video fa-3x text-muted mb-3"></i>
              <p className="text-muted">Chưa có video trong folder này</p>
            </div>
          ) : (
            <div className="row g-4">
              {videos.map((video, index) => (
                <div 
                  key={video.id} 
                  className="col-md-4 col-lg-3"
                  draggable
                  onDragStart={(e) => handleVideoDragStart(e, video, index)}
                  onDragEnd={handleVideoDragEnd}
                  onDragOver={(e) => handleVideoDragOver(e, index)}
                  onDrop={(e) => handleVideoDrop(e, index)}
                >
                  <div className={`card h-100 ${dragOverItem === index ? 'border-warning border-2' : ''}`} style={{ cursor: 'grab' }}>
                    <div className="card-header bg-transparent py-1 text-center">
                      <i className="fas fa-grip-lines text-muted"></i>
                    </div>
                    <div className="position-relative">
                      <img 
                        src={video.thumb} 
                        className="card-img-top" 
                        alt={video.title}
                        style={{ height: '150px', objectFit: 'cover' }}
                      />
                      <a 
                        href={`https://www.youtube.com/watch?v=${video.youtubeId}`}
                        target="_blank"
                        className="position-absolute top-50 start-50 translate-middle"
                      >
                        <i className="fas fa-play-circle fa-3x text-white" style={{ textShadow: '0 2px 10px rgba(0,0,0,0.5)' }}></i>
                      </a>
                    </div>
                    <div className="card-body py-2">
                      <h6 className="card-title small mb-1 text-truncate" title={video.title}>{video.title}</h6>
                      <small className="text-muted">{video.youtubeId}</small>
                    </div>
                    <div className="card-footer bg-transparent border-0 pt-0">
                      <div className="btn-group btn-group-sm w-100">
                        <button className="btn btn-outline-primary" onClick={() => copyLink(video)} title="Copy link">
                          <i className="fas fa-link"></i>
                        </button>
                        <button className="btn btn-outline-secondary" onClick={() => handleEditVideo(video)} title="Sửa">
                          <i className="fas fa-edit"></i>
                        </button>
                        <button className="btn btn-outline-danger" onClick={() => handleDeleteVideo(video)} title="Xóa">
                          <i className="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}

          <VideoModal
            show={showVideoModal}
            video={editingVideo}
            onClose={() => setShowVideoModal(false)}
            onSave={handleSaveVideo}
          />
        </div>
      );
    }

    // Video Folder Modal
    function VideoFolderModal({ show, folder, onClose, onSave }) {
      const [formData, setFormData] = useState({ name: '', description: '', sortOrder: 0, coverImage: '' });
      const [saving, setSaving] = useState(false);
      const [uploading, setUploading] = useState(false);

      useEffect(() => {
        if (folder) {
          setFormData({
            name: folder.name || '',
            description: folder.description || '',
            sortOrder: folder.sortOrder || 0,
            coverImage: folder.coverImage || ''
          });
        } else {
          setFormData({ name: '', description: '', sortOrder: 0, coverImage: '' });
        }
      }, [folder, show]);

      const handleImageUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setUploading(true);
        const form = new FormData();
        form.append('file', file);
        form.append('upload_preset', 'ktm_unsigned');

        try {
          const res = await fetch('https://api.cloudinary.com/v1_1/diwxfpt92/image/upload', {
            method: 'POST',
            body: form
          });
          const data = await res.json();
          if (data.secure_url) {
            setFormData(prev => ({ ...prev, coverImage: data.secure_url }));
          }
        } catch (err) {
          alert('Lỗi upload ảnh');
        }
        setUploading(false);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setSaving(true);
        await onSave(formData);
        setSaving(false);
      };

      if (!show) return null;

      return (
        <div className="modal show d-block" style={{ background: 'rgba(0,0,0,0.5)' }}>
          <div className="modal-dialog modal-dialog-centered">
            <div className="modal-content">
              <div className="modal-header">
                <h5 className="modal-title">{folder ? 'Sửa Folder' : 'Tạo Folder mới'}</h5>
                <button type="button" className="btn-close" onClick={onClose}></button>
              </div>
              <form onSubmit={handleSubmit}>
                <div className="modal-body">
                  <div className="mb-3">
                    <label className="form-label">Tên folder *</label>
                    <input
                      type="text"
                      className="form-control"
                      value={formData.name}
                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                      required
                    />
                  </div>
                  <div className="mb-3">
                    <label className="form-label">Mô tả</label>
                    <textarea
                      className="form-control"
                      value={formData.description}
                      onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                      rows="2"
                    ></textarea>
                  </div>
                  <div className="mb-3">
                    <label className="form-label">Thứ tự</label>
                    <input
                      type="number"
                      className="form-control"
                      value={formData.sortOrder}
                      onChange={(e) => setFormData({ ...formData, sortOrder: parseInt(e.target.value) || 0 })}
                    />
                  </div>
                  <div className="mb-3">
                    <label className="form-label">Ảnh bìa</label>
                    <div className="d-flex align-items-start gap-3">
                      {formData.coverImage ? (
                        <div className="position-relative">
                          <img 
                            src={formData.coverImage} 
                            alt="Cover" 
                            className="rounded"
                            style={{ width: 120, height: 80, objectFit: 'cover' }}
                          />
                          <button 
                            type="button"
                            className="btn btn-sm btn-danger position-absolute top-0 end-0"
                            onClick={() => setFormData({ ...formData, coverImage: '' })}
                            style={{ transform: 'translate(30%, -30%)' }}
                          >
                            <i className="fas fa-times"></i>
                          </button>
                        </div>
                      ) : (
                        <div 
                          className="bg-light rounded d-flex align-items-center justify-content-center text-muted"
                          style={{ width: 120, height: 80 }}
                        >
                          <i className="fas fa-image fa-2x"></i>
                        </div>
                      )}
                      <div className="flex-grow-1">
                        <input
                          type="file"
                          className="form-control form-control-sm"
                          accept="image/*"
                          onChange={handleImageUpload}
                          disabled={uploading}
                        />
                        {uploading && (
                          <div className="mt-1 text-muted small">
                            <span className="spinner-border spinner-border-sm me-1"></span>
                            Đang upload...
                          </div>
                        )}
                        <div className="mt-1 text-muted small">Hoặc dán URL:</div>
                        <input
                          type="url"
                          className="form-control form-control-sm"
                          placeholder="https://..."
                          value={formData.coverImage}
                          onChange={(e) => setFormData({ ...formData, coverImage: e.target.value })}
                        />
                      </div>
                    </div>
                  </div>
                </div>
                <div className="modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={onClose}>Hủy</button>
                  <button type="submit" className="btn btn-warning" disabled={saving}>
                    {saving ? <><span className="spinner-border spinner-border-sm me-2"></span>Đang lưu...</> : 'Lưu'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      );
    }

    // Video Modal (Create/Edit)
    function VideoModal({ show, video, onClose, onSave }) {
      const [formData, setFormData] = useState({
        title: '',
        youtube_url: '',
        thumbnail_url: '',
        sort_order: 0
      });
      const [saving, setSaving] = useState(false);
      const [previewThumb, setPreviewThumb] = useState('');

      useEffect(() => {
        if (video) {
          setFormData({
            title: video.title || '',
            youtube_url: `https://www.youtube.com/watch?v=${video.youtubeId}`,
            thumbnail_url: video.thumb || '',
            sort_order: video.sortOrder || 0
          });
          setPreviewThumb(video.thumb);
        } else {
          setFormData({
            title: '',
            youtube_url: '',
            thumbnail_url: '',
            sort_order: 0
          });
          setPreviewThumb('');
        }
      }, [video, show]);

      const extractYoutubeId = (url) => {
        const match = url.match(/(?:youtube\.com\/(?:embed\/|watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        return match ? match[1] : null;
      };

      const handleUrlChange = (url) => {
        setFormData({ ...formData, youtube_url: url });
        const videoId = extractYoutubeId(url);
        if (videoId) {
          setPreviewThumb(`https://img.youtube.com/vi/${videoId}/hqdefault.jpg`);
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setSaving(true);
        await onSave(formData);
        setSaving(false);
      };

      if (!show) return null;

      return (
        <div className="modal show d-block" style={{ background: 'rgba(0,0,0,0.5)' }}>
          <div className="modal-dialog modal-dialog-centered">
            <div className="modal-content">
              <div className="modal-header">
                <h5 className="modal-title">{video ? 'Sửa Video' : 'Thêm Video mới'}</h5>
                <button type="button" className="btn-close" onClick={onClose}></button>
              </div>
              <form onSubmit={handleSubmit}>
                <div className="modal-body">
                  <div className="mb-3">
                    <label className="form-label">Link YouTube *</label>
                    <input
                      type="url"
                      className="form-control"
                      value={formData.youtube_url}
                      onChange={(e) => handleUrlChange(e.target.value)}
                      placeholder="https://www.youtube.com/watch?v=... hoặc shorts/..."
                      required
                    />
                    <small className="text-muted">Hỗ trợ: youtube.com/watch, youtu.be, youtube.com/shorts</small>
                  </div>

                  {previewThumb && (
                    <div className="mb-3 text-center">
                      <img src={previewThumb} alt="Preview" className="img-fluid rounded" style={{ maxHeight: '150px' }} />
                    </div>
                  )}

                  <div className="mb-3">
                    <label className="form-label">Tiêu đề *</label>
                    <input
                      type="text"
                      className="form-control"
                      value={formData.title}
                      onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                      required
                    />
                  </div>

                  <div className="mb-3">
                    <label className="form-label">Thứ tự</label>
                    <input
                      type="number"
                      className="form-control"
                      value={formData.sort_order}
                      onChange={(e) => setFormData({ ...formData, sort_order: parseInt(e.target.value) || 0 })}
                    />
                  </div>

                  <div className="mb-3">
                    <label className="form-label">Thumbnail tùy chỉnh (tùy chọn)</label>
                    <input
                      type="url"
                      className="form-control"
                      value={formData.thumbnail_url}
                      onChange={(e) => setFormData({ ...formData, thumbnail_url: e.target.value })}
                      placeholder="Để trống sẽ dùng thumbnail mặc định của YouTube"
                    />
                  </div>
                </div>
                <div className="modal-footer">
                  <button type="button" className="btn btn-secondary" onClick={onClose}>Hủy</button>
                  <button type="submit" className="btn btn-warning" disabled={saving}>
                    {saving ? <><span className="spinner-border spinner-border-sm me-2"></span>Đang lưu...</> : 'Lưu'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      );
    }

    // ==================== MAIN APP ====================
    function AdminApp() {
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [loginError, setLoginError] = useState('');
      const [currentUser, setCurrentUser] = useState(null);
      const [activeMenu, setActiveMenu] = useState('search');
      const [albums, setAlbums] = useState([]);
      const [selectedAlbum, setSelectedAlbum] = useState(null);
      const [showAlbumModal, setShowAlbumModal] = useState(false);
      const [editingAlbum, setEditingAlbum] = useState(null);
      const [loading, setLoading] = useState(true);
      const [toasts, setToasts] = useState([]);

      // Check session on mount
      useEffect(() => {
        const session = localStorage.getItem('ktm_admin_session');
        if (session) {
          try {
            const data = JSON.parse(session);
            // Check if session expired (24 hours)
            if (data.expiry > Date.now()) {
              setIsLoggedIn(true);
              setCurrentUser(data.user);
            } else {
              localStorage.removeItem('ktm_admin_session');
            }
          } catch (e) {
            localStorage.removeItem('ktm_admin_session');
          }
        }
      }, []);

      useEffect(() => {
        if (isLoggedIn) {
          loadAlbums();
        }
      }, [isLoggedIn]);

      const handleLogin = async (username, password) => {
        setLoginError('');
        
        try {
          const res = await fetch(`${API_BASE}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.error || 'Đăng nhập thất bại');
          }

          // Save session
          const session = {
            user: data.user,
            token: data.token,
            expiry: Date.now() + 24 * 60 * 60 * 1000 // 24 hours
          };
          localStorage.setItem('ktm_admin_session', JSON.stringify(session));
          
          setCurrentUser(data.user);
          setIsLoggedIn(true);
        } catch (err) {
          setLoginError(err.message);
        }
      };

      const handleLogout = () => {
        localStorage.removeItem('ktm_admin_session');
        setIsLoggedIn(false);
        setCurrentUser(null);
        setAlbums([]);
        setSelectedAlbum(null);
      };

      const showToast = (message, type = 'success') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type }]);
      };

      const removeToast = (id) => {
        setToasts(prev => prev.filter(t => t.id !== id));
      };

      const loadAlbums = async () => {
        setLoading(true);
        try {
          const res = await fetch(`${API_BASE}/api/albums`);
          const data = await res.json();
          setAlbums(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error(err);
          showToast('Lỗi tải danh sách album', 'danger');
        }
        setLoading(false);
      };

      const handleCreateAlbum = () => {
        setEditingAlbum(null);
        setShowAlbumModal(true);
      };

      const handleSaveAlbum = async (formData) => {
        try {
          const res = await fetch(`${API_BASE}/api/albums`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Lỗi tạo album');
          }

          showToast('Tạo album thành công!', 'success');
          setShowAlbumModal(false);
          loadAlbums();
        } catch (err) {
          showToast(err.message, 'danger');
        }
      };

      const handleDeleteAlbum = async (album) => {
        if (!confirm(`Xóa album "${album.title}"? Tất cả ảnh trong album sẽ bị xóa!`)) return;

        try {
          await fetch(`${API_BASE}/api/albums/${album.id}`, { method: 'DELETE' });
          showToast('Đã xóa album', 'success');
          loadAlbums();
        } catch (err) {
          showToast('Lỗi xóa album', 'danger');
        }
      };

      // Show login page if not logged in
      if (!isLoggedIn) {
        return <LoginPage onLogin={handleLogin} error={loginError} />;
      }

      return (
        <div>
          <Sidebar 
            activeMenu={activeMenu} 
            onMenuChange={setActiveMenu} 
            onLogout={handleLogout}
            currentUser={currentUser}
          />
          
          <div className="main-content">
            {/* Mobile header */}
            <div className="d-md-none bg-dark text-white p-3 mb-3 rounded">
              <div className="d-flex justify-content-between align-items-center">
                <span className="text-warning fw-bold"><i className="fas fa-tractor me-2"></i>KTM Admin</span>
                <div>
                  <a href="/" className="text-white-50 me-3"><i className="fas fa-home"></i></a>
                  <button className="btn btn-sm btn-outline-danger" onClick={handleLogout}>
                    <i className="fas fa-sign-out-alt"></i>
                  </button>
                </div>
              </div>
              {/* Mobile menu */}
              <div className="d-flex gap-2 mt-3 overflow-auto pb-1">
                <button 
                  className={`btn btn-sm ${activeMenu === 'search' ? 'btn-warning' : 'btn-outline-warning'}`}
                  onClick={() => setActiveMenu('search')}
                >
                  <i className="fas fa-search me-1"></i> Tra cứu
                </button>
                <button 
                  className={`btn btn-sm ${activeMenu === 'albums' ? 'btn-warning' : 'btn-outline-light'}`}
                  onClick={() => setActiveMenu('albums')}
                >
                  <i className="fas fa-images me-1"></i> Album
                </button>
                <button 
                  className={`btn btn-sm ${activeMenu === 'videos' ? 'btn-warning' : 'btn-outline-light'}`}
                  onClick={() => setActiveMenu('videos')}
                >
                  <i className="fas fa-video me-1"></i> Video
                </button>
                <button className="btn btn-sm btn-outline-secondary" disabled>
                  <i className="fas fa-box me-1"></i> Sản phẩm
                </button>
              </div>
            </div>

            {activeMenu === 'albums' && !selectedAlbum && (
              <AlbumList
                albums={albums}
                loading={loading}
                onSelect={setSelectedAlbum}
                onCreate={handleCreateAlbum}
                onDelete={handleDeleteAlbum}
              />
            )}

            {activeMenu === 'search' && (
              <SearchCenter showToast={showToast} />
            )}

            {activeMenu === 'albums' && selectedAlbum && (
              <AlbumDetail
                album={selectedAlbum}
                onBack={() => setSelectedAlbum(null)}
                onRefresh={loadAlbums}
                showToast={showToast}
              />
            )}

            {activeMenu === 'videos' && (
              <VideoList
                showToast={showToast}
              />
            )}
          </div>

          <AlbumModal
            show={showAlbumModal}
            album={editingAlbum}
            onClose={() => setShowAlbumModal(false)}
            onSave={handleSaveAlbum}
          />

          {/* Toast container */}
          <div className="toast-container">
            {toasts.map(toast => (
              <Toast
                key={toast.id}
                message={toast.message}
                type={toast.type}
                onClose={() => removeToast(toast.id)}
              />
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.render(<AdminApp />, document.getElementById('root'));
  </script>
</body>
</html>
